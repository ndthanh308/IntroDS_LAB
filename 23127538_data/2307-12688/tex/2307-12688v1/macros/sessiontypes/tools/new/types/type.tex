
% ~ message type
\NewDocumentCommand{\IMsgType}{s o d<> t' e_}{%
    \IfBooleanT{#1}{$}% mm wrap
    \IfValueTF{#2}{% * label provided
        {#2\IfBooleanT{#4}{'}\IfValueT{#5}{_{#5}}}%
    }{% * use default label
        {\MsgLabel\IfBooleanT{#4}{'}\IfValueT{#5}{_{#5}}}%
    }%
    \left\langle%
    \IfValueTF{#3}{% * data type provided
        {#3\IfBooleanT{#4}{'}\IfValueT{#5}{_{#5}}}%
    }{% * use default data type
        {\DataType\IfBooleanT{#4}{'}\IfValueT{#5}{_{#5}}}%
    }%
    \right\rangle%
    \IfBooleanT{#1}{$}% mm wrap
}

% ~ delegation type
\NewDocumentCommand{\DelType}{s o t' e_}{%
    \IfBooleanT{#1}{$}% mm wrap
    \IfValueTF{#2}{% * value provided
        \Tup(#2)%
    }{% * use default delegation
        \Tup({{\Const\IfBooleanT{#3}{'}}\IfValueT{#4}{_{#4}}},{{\TypeS\IfBooleanT{#3}{'}}\IfValueT{#4}{_{#4}}})%
    }%
    \IfBooleanT{#1}{$}% mm wrap
}

% ~ creates type actions
% #1 : s* : math mode wrap
% #2 : t! : token !
% #3 : t? : token ? 
% #4 : t! : token !
% #5 : t| : don't tt the message (or square)
% #6 : O  : message shared
% #7 : e_ : subscript
% ~ token given in #2 and #3 determines action.
% ~ together they yield comm square. #4 allows reordering.
\NewDocumentCommand{\ITypeAct}{s t! t? t! t| O{\MsgType} e_}{%
    \IfBooleanT{#1}{$}% mm wrap
    \begin{array}[t]{>{\hfill$}p{1ex}<{$\hfill} c}%
        % ~ handling action !?!
        \IfBooleanTF{#2}{% * !
            \IfBooleanTF{#3}{% * both !?
                \mathllap{\TypComm\IfValueT{#7}{_{#7}}}%
            }{% * no ? only !
                \mathllap{\TypSend\IfValueT{#7}{_{#7}}}%
            }%
        }{% * no !
            \IfBooleanTF{#3}{% * ?
                \IfBooleanTF{#4}{% * both ?!
                    \mathllap{\TypComm\IfValueT{#7}{_{#7}}}%
                }{% * only ?
                    \mathllap{\TypRecv\IfValueT{#7}{_{#7}}}%
                }%
            }{% * no !?
                \mathllap{\TypComm\IfValueT{#7}{_{#7}}}%
            }%
        } & %
        % ~ message
        % \begin{array}[t]{l}%
            {#6}\IfValueT{#7}{_{#7}}%
        % \end{array}%
    \end{array}%
    \IfBooleanT{#1}{$}% mm wrap
}

% ~ creates type conditions
% #1 : s* : math mode wrap
% #2 : O  : constraint (default: true)
% #3 : t| : reset indicator
% #4 : o  : resets
% #5 : e_ : subscript
% ~ reset indicator only has effect when #4 not provided.
% ~ instead true is used for constraint and #2 used for resets.
\NewDocumentCommand{\ITypeCond}{s O{\mathtt{true}} t| o e_}{%
    \IfBooleanT{#1}{$}% mm wrap
    \IfBooleanTF{#3}{% * if t|
        \IfNoValueTF{#4}{% * and #4 is null, use #2 as #4
            \Tup({\mathtt{true}\IfValueT{#5}{_{#5}}},{{#2}\IfValueT{#5}{_{#5}}})|%
        }{% * if #4 value, proceed as normal
            \Tup({{#2}\IfValueT{#5}{_{#5}}},{{#4}\IfValueT{#5}{_{#5}}})|%
        }%
    }{% * no t|, proceed as normal
        \IfNoValueTF{#4}{% * omit from type
            \Tup({{#2}\IfValueT{#5}{_{#5}}})|%
        }{% * reset given, proceed as normal
            \Tup({{#2}\IfValueT{#5}{_{#5}}},{{#4}\IfValueT{#5}{_{#5}}})|%
        }%
    }%
    \IfBooleanT{#1}{$}% mm wrap
}

% ~ creates types automatically
% #1 : s* : math mode wrap
% #2 : e! : send action 
% #3 : e? : recv action  
% #4 : O  : type condition 
% #5 : t| : use #4 for resets, and true for #4
% #6 : o  : resets if no #5 
% #7 : e. : proceeding type (if false, default: end)
% #8 : e_ : subscript
% ~ #4 indicates if only a "." should be returned, else assumes ".end".
\NewDocumentCommand{\IType}{s e! e? O{\TypeTrue} t| o e. e_}{%
    \IfBooleanT{#1}{$}% mm wrap
    \!\rule{0pt}{1.5ex}%
    % ~ type action
    \IfValueTF{#2}{% * if !
        \IfValueTF{#8}{\ITypeAct![#2]_{#8}}{\ITypeAct![#2]}%
    }{% * no !
        \IfValueTF{#3}{% * if ?
            \IfValueTF{#8}{\ITypeAct?[#3]_{#8}}{\ITypeAct?[#3]}%
        }{% * no !?, syntax mode
            \!\hspace{1ex}%
            \IfValueTF{#8}{\ITypeAct|[\MsgType]_{#8}}{\ITypeAct|[\MsgType]}%
        }%
    }%
    % ~ type condition
    \IfValueTF{#6}{% * if resets
        \IfBooleanTF{#5}{% * if t|
            \IfValueTF{#8}{\ITypeCond[#4]|[#6]_{#8}}{\ITypeCond[#4]|[#6]}%
        }{% * no t|
            \IfValueTF{#8}{\ITypeCond[#4][#6]_{#8}}{\ITypeCond[#4][#6]}%
        }%
    }{% * no resets
        \IfBooleanTF{#5}{% * if t|
            \IfValueTF{#8}{\ITypeCond[#4]|_{#8}}{\ITypeCond[#4]|}%
        }{% * no t|
            \IfValueTF{#8}{\ITypeCond[#4]_{#8}}{\ITypeCond[#4]}%
        }%
    }%
    % ~ proceeding type
    \IfValueTF{#7}{.\,{#7}\IfValueT{#8}{_{#8}}}{.\TypeEnd\IfValueT{#8}{_{#8}}}%
    \IfBooleanT{#1}{$}% mm wrap
}
