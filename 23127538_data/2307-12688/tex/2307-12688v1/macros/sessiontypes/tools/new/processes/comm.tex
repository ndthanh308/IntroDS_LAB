
% ~ 
% #1 : s* : math mode wrap
% #2 : E_ : session role
% #3 : t| : do not format message?
% #4 : Om : message
% #5 : t/ : put proceeding on new line
% #6 : e. : proceeding process
\NewDocumentCommand{\PSend}{s E_{\PrcP} t| O{\PrcMsg} t/ e.}{%
    \IfBooleanT{#1}{$}%
    \rule{0pt}{1.5ex}%
    % \IfValueTF{#5}{% * proceeding process
    %     \IPrcFmt{%
        \begin{array}[t]{l l}%
            %
            \mathtt{on}\;{#2}\;%
            \bm{\mathtt{send}}\;%
            \IfBooleanTF{#3}{#4}{\Rounded{#4}}%
            %
            % & .%
        % }[%
            \IfBooleanTF{#5}{% * put proceeding on new line?
                \;\!\,. \\ \mbox{ }%
                \begin{array}[t]{l}%
                    \IfValueTF{#6}{#6}{\PrcEnd}%
                \end{array}%
            }{% * same line
                & .\!\,%
                \begin{array}[t]{l}%
                    \IfValueTF{#6}{#6}{\PrcEnd}%
                \end{array}%
            }
        % ]%
    % }{% * no proceeding process
    %     \IPrcFmt{%
    %     % \begin{array}[t]{r c l}%
    %         %
    %         \mathtt{on}\;{#2}\;%
    %         \bm{\mathtt{send}}\;%
    %         \IfBooleanTF{#3}{#4}{\rectround{$\mathtt{#4}$}}%
    %         %
    %         % & .%
    %         % & \!%
    %     }%
    % }%
    \end{array}%
    \IfBooleanT{#1}{$}%
}

% ~ 
% #1 : s* : math mode wrap
% #2 : E_ : session role
% #3 : t| : do not format message?
% #4 : Om : message
% #5 : t/ : put proceeding on new line
% #6 : E. : reception continuation
% #7 : e< : receive within
% #8 : E> : timeout branch
\NewDocumentCommand{\PRecv}{s E_{\PrcP} t| O{\PrcMsg} t/ E.{\PrcEnd} e< E>{\PrcFail}}{%
    \IfBooleanT{#1}{$}%
    \IfBooleanTF{#3}{% * part of branch
        \begin{array}[t]{>{\hfill$}p{3ex}<{ $} c l}%
            \rule{0pt}{1.5ex}\Rounded{#4}%
            & :%
            & \!\begin{array}[t]{l}{#5}\end{array}%
        \end{array}%
    }{% * single receive
        \begin{array}[t]{r l}%
            %
            % ~ receive
            \IfValueT{#7}{\mathllap{{\tikzmark{RecvNode}}}}%
            \mathtt{on}\;{#2}\;%
            \IfValueTF{#7}{% * within timeout
                \bm{\mathtt{recv}}^{#7}%
            }{% * forever
                \bm{\mathtt{recv}}^{\infty}%
            }%
            %
            \IfBooleanTF{#5}{% * put proceeding on new line?
                \begin{array}[t]{r c l}%
                    %
                    % ~ message
                    \rule{0pt}{1.5ex}\Rounded{#4}%
                    & \;\!\,: \\ &%
                    & \hspace{-8ex}\begin{array}[t]{l}{#6}\end{array}%
                    %
                    % ~ timeout
                    \IfValueT{#7}{% * timeout
                        \\ \mathllap{\tikzmark{AfterNode}{\mathtt{after}^{#7}}}%
                        & :%
                        & \!\begin{array}[t]{l}{#8}\end{array}%
                        \\[0.75ex]%
                    }%
                \end{array}%
            }{% * same line
                \begin{array}[t]{r c l}%
                    %
                    % ~ message
                    \rule{0pt}{1.5ex}\Rounded{#4}%
                    & :%
                    & \!\begin{array}[t]{l}{#6}\end{array}%
                    %
                    % ~ timeout
                    \IfValueT{#7}{% * timeout
                        \\ \mathllap{\tikzmark{AfterNode}{\mathtt{after}^{#7}}}%
                        & :%
                        & \!\begin{array}[t]{l}{#8}\end{array}%
                        \\[0.75ex]%
                    }%
                \end{array}%
            }%
            %
        \end{array}%
    }%
    %
    \IfValueT{#7}{%
        % \tikz[overlay,remember picture,use tikzmark]{%
        %     \draw[->,opacity=1,red,thick](pic cs:RecvNode) to (pic cs:AfterNode);%
        %     \filldraw[green] (pic cs:RecvNode) circle (2pt) node[anchor=west]{recv};%
        %     \filldraw[blue] (pic cs:AfterNode) circle (2pt) node[anchor=west]{after};%
        % }%
    }%
    \IfBooleanT{#1}{$}%
}
