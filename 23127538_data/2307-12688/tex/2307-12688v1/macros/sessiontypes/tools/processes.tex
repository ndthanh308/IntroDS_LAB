
\NewDocumentCommand{\PrcCalcErase}{O{\Prc}}{\mathtt{erase}(#1)}
\NewDocumentCommand{\PrcCalcOn}{m}{\lowercase{#1}}
\NewDocumentCommand{\PrcCalcSend}{m o E.{\Prc}}{%
% \mathtt{send\ }%
~\PrcSend~%
\begin{array}[t]{l}
{#1}{\IfValueT{#2}{%
   {#2}%\mathtt{#2}% \left\langle{#2}\right\rangle%
}}.{#3}%
\end{array}
}
% t| => uses option list
\NewDocumentCommand{\PrcCalcRecv}{s e< t| m o E:{\Prc} e_ o}{%
% \mathtt{recv}%
\IfValueT{#2}{% * recv supscript?
   ^{#2}
}~\PrcRecv~
{\IfBooleanTF{#1}{% * no set notation?
   \begin{array}[t]{ll}%
      \IfBooleanTF{#3}{% * option list?
      \ListToArray{#4}%
      }{% * no option list
      \IfValueTF{#7}{% * subscript?
      {{#4}_{\lowercase{#7}}}%
      \IfValueT{#5}{({#5}_{\lowercase{#7}})}:%
      {{#6}_{\lowercase{#7}}}%
      }{% * no subscript
      {#4}\IfValueT{#5}{({#5})}:{#6}%
      }%
      }%
   \end{array}
}{% * set notation
   \begin{array}[t]\{{ll}\}%
      \IfBooleanTF{#3}{% * option list?
      \ListToArray{#4}%
      }{% * no option list
      \IfValueTF{#7}{% * subscript?
      {{#4}_{\lowercase{#7}}}%
      \IfValueT{#5}{({#5}_{\lowercase{#7}})}:%
      {{#6}_{\lowercase{#7}}}%
      }{% * no subscript
      {#4}\IfValueT{#5}{({#5})}:{#6}%
      }%
      }%
   \end{array}
}}%
\IfValueT{#8}{% * subscript?
   _{\lowercase{#7}\in\uppercase{#8}}%
}\!
}
% t| is broken
\NewDocumentCommand{\PrcCalcOption}{m o E:{\Prc} e_}{%
\IfValueTF{#4}{%
{{{#1}_{#4}}~{\IfValueT{#2}{({{#2}}_{#4})}}:{{#3}_{#4}}}%
%
}{%
{{{#1}}~{\IfValueT{#2}{({#2})}}:{{#3}}}%
%
}%
}
\NewDocumentCommand{\PrcCalcAfter}{E<{n} E:{\Qrc}}{%
\mathtt{after\ }{#1}:{#2}
}

\NewDocumentCommand{\PrcCalcIf}{s m}{{\mathtt{if\ }\IfBooleanTF{#1}{#2}{(#2)}}}
\NewDocumentCommand{\PrcCalcThen}{m}{{\mathtt{then}:{#1}}}
\NewDocumentCommand{\PrcCalcElse}{m}{{\mathtt{else}:{#1}}}

\NewDocumentCommand{\PrcCalcTimePass}{E_{\ValTime} m}{{{\Phi_{#1}}\begin{array}[t]({l}){#2}\end{array}}}

\ProvideDocumentCommand{\Erase}{}{}
\ProvideDocumentCommand{\On}{}{}
\ProvideDocumentCommand{\Send}{}{}
\ProvideDocumentCommand{\Recv}{}{}
\ProvideDocumentCommand{\Option}{}{}
\ProvideDocumentCommand{\After}{}{}
\ProvideDocumentCommand{\TimePass}{}{}
\ProvideDocumentCommand{\If}{}{}
\ProvideDocumentCommand{\Then}{}{}
\ProvideDocumentCommand{\Else}{}{}

\NewDocumentCommand{\PCalc}{s m}{%
   %
   \let\TempErase\Erase
   \let\TempOn\On
   \let\TempSend\Send
   \let\TempRecv\Recv
   \let\TempOption\Option
   \let\TempAfter\After
   \let\TempTimePass\TimePass
   \let\TempIf\If
   \let\TempThen\Then
   \let\TempElse\Else
   %
   \let\Erase\PrcCalcErase
   \let\On\PrcCalcOn
   \let\Send\PrcCalcSend
   \let\Recv\PrcCalcRecv
   \let\Option\PrcCalcOption
   \let\After\PrcCalcAfter
   \let\TimePass\PrcCalcTimePass
   \let\If\PrcCalcIf
   \let\Then\PrcCalcThen
   \let\Else\PrcCalcElse
   %
   \IfBooleanTF{#1}{${#2}$}{{#2}}
   %
   \let\Erase\TempErase
   \let\On\TempOn
   \let\Send\TempSend
   \let\Recv\TempRecv
   \let\Option\TempOption
   \let\After\TempAfter
   \let\TimePass\TempTimePass
   \let\If\TempIF
   \let\Then\TempThen
   \let\Else\TempElse
}

\NewDocumentEnvironment{processcalculus}{s}{% * begdef
%
\let\TempErase\Erase
\let\TempOn\On
\let\TempSend\Send
\let\TempRecv\Recv
\let\TempOption\Option
\let\TempAfter\After
\let\TempTimePass\TimePass
\let\TempIf\If
\let\TempThen\Then
\let\TempElse\Else
%
\let\Erase\PrcCalcErase
\let\On\PrcCalcOn
\let\Send\PrcCalcSend
\let\Recv\PrcCalcRecv
\let\Option\PrcCalcOption
\let\After\PrcCalcAfter
\let\TimePass\PrcCalcTimePass
\let\If\PrcCalcIf
\let\Then\PrcCalcThen
\let\Else\PrcCalcElse
%
\IfBooleanTF{#1}{\begin{minieq}*}{\begin{minieq}}%
      }{% * enddef
   \end{minieq}
   %
   \let\Erase\TempErase
   \let\On\TempOn
   \let\Send\TempSend
   \let\Recv\TempRecv
   \let\Option\TempOption
   \let\After\TempAfter
   \let\TimePass\TempTimePass
   \let\If\TempIF
   \let\Then\TempThen
   \let\Else\TempElse
}

% ~ time func
\NewDocumentCommand{\PFuncTime}{s E_{\ValTime} O{\Prc}}{%
   \IfBooleanT{#1}{$}% mm wrap
   \PrcTime_{#2}\left({#3}\right)\,%
   \IfBooleanT{#1}{$\!}% mm wrap
}

% ~ wait func
\NewDocumentCommand{\PFuncWait}{s O{\Prc}}{%
   \IfBooleanT{#1}{$}% mm wrap
   \FuncWait({#2})%
   \IfBooleanT{#1}{$\!}% mm wrap
}

% ~ wait func
\NewDocumentCommand{\PFuncFQ}{s O{\SesEnv}}{%
   \IfBooleanT{#1}{$}% mm wrap
   \mathtt{fq}({#2})%
   \IfBooleanT{#1}{$\!}% mm wrap
}

% ~ nequeue func
\NewDocumentCommand{\PFuncNEQ}{s O{\Prc}}{%
   \IfBooleanT{#1}{$}% mm wrap
   \FuncNEQ({#2})%
   \IfBooleanT{#1}{$\!}% mm wrap
}

% ~ delay func
\NewDocumentCommand{\PFuncDelay}{s O{\Const} t. O{\Prc}}{%
   \IfBooleanT{#1}{$}% mm wrap
   \FuncDelay({#2})%
   \IfBooleanTF{#3}{.}{.#4}% proceeding
   \IfBooleanT{#1}{$\!}% mm wrap
}

% ~ well-formed func
\NewDocumentCommand{\PFuncWF}{s O{\Prc}}{%
   \IfBooleanT{#1}{$}% mm wrap
   \mathtt{wf}\left({#2}\right)\,%
   \IfBooleanT{#1}{$\!}% mm wrap
}

% ~ judgement
\NewDocumentCommand{\TmpPrcJudge}{s E1{{\VarEnv}} E2{{\Prc}} t| E3{{1{\SesEnv}2{1{\SesP}}}}}{%
\IfBooleanT{#1}{$}% mm wrap
{#2}\;\Entails\,%
{#3}\;\PrcTyped\;%
\IfBooleanTF{#4}{#5}{\PSesEnvTypeSession#5}%
\IfBooleanT{#1}{$\!}% mm wrap
}

% ~ session environment session
\NewDocumentCommand{\PSesEnvTypeSession}{s E1{{\SesEnv}} E2{{1{\SesP}}}}{%
   \IfBooleanT{#1}{$}% mm wrap
   {#2},\,{\PSesRole#3}%
   \IfBooleanT{#1}{$\!}% mm wrap
}

% ~ session role
\NewDocumentCommand{\PSesRole}{s E1{{\SesP}} E2{{1{\ValClocks}2{\TypeS}}}}{%
\IfBooleanT{#1}{$}% mm wrap
{#2}:{\CfgIso#3}\,%
\IfBooleanT{#1}{$\!}% mm wrap
}

% ~ not t reading
\NewDocumentCommand{\PSesEnvTRead}{s t| O{\SesEnv}}{%
\IfBooleanT{#1}{$}% mm wrap
{#3}+{\ValTime'}%<\ValTime
\IfBooleanTF{#2}{\Act|[\TypRecv\Msg]}{\Act[\TypRecv\Msg]}%
\IfBooleanT{#1}{$\!}% mm wrap
}

% ~ send
% #1 : mm wrap
\NewDocumentCommand{\PCalcSend}{s E1{{\SesP}} E2{{\PrcVal}} t. O{\Prc}}{%
   \IfBooleanT{#1}{$}% mm wrap
   {#2}\,\PrcSend\,{\PrcLabel}{#3}%
   \IfBooleanTF{#4}{.}{.#5}% proceeding
   \IfBooleanT{#1}{$\!}% mm wrap
}

% ~ recv
% #1 : mm wrap
\NewDocumentCommand{\PCalcRecv}{s E1{{\SesP}} E2{{\PrcAfter}} E3{{\PrcMsg}} E4{{\Prc}} O{i} O{I} t| O{\Qrc}}{%
\IfBooleanT{#1}{$}% mm wrap
{#2}^{#3}\PrcRecv\,\InSet[{\PrcLabel}_{#6}{#4}_{#6}:{#5}_{#6}][#6][#7]%
\IfBooleanF{#8}{\;\TTPrcAft\,{#9}}
\IfBooleanT{#1}{$\!}% mm wrap
}

% ~ recv
% #1 : mm wrap
\NewDocumentCommand{\PCalcRecvSingle}{s E1{{\SesP}} E2{{\PrcAfter}} E3{{\PrcMsg}} E4{{\Prc}} e_}{%
\IfBooleanT{#1}{$}% mm wrap
{#2}^{#3}\PrcRecv\,{\PrcLabel}\IfValueT{#6}{_{#6}}{#4}\IfValueT{#6}{_{#6}}:{#5}\IfValueT{#6}{_{#6}}%
\IfBooleanT{#1}{$\!}% mm wrap
}

% ~ endpoints
\NewDocumentCommand{\PCalcEndPoints}{s E1{{\PrcP}} E2{{\PrcQ}}}{%
   \IfBooleanT{#1}{$}% mm wrap
   {#2}{#3}%
   \IfBooleanT{#1}{$\!}% mm wrap
}

% ~ scope
\NewDocumentCommand{\PCalcScope}{s E1{{1{\PrcP}2{\PrcQ}}} t| O{\Prc}}{%
\IfBooleanT{#1}{$}% mm wrap
\left({\PrcScope}\PCalcEndPoints#2\right)%
\IfBooleanF{#3}{#4}% proceeding
\IfBooleanT{#1}{$\!}% mm wrap
}

% ~ queue
\NewDocumentCommand{\PCfgQueue}{s E1{{1{\PrcP}2{\PrcQ}}} E2{{\QHead}} o}{%
\IfBooleanT{#1}{$}% mm wrap
{\PCalcEndPoints#2}:{#3}%
\IfNoValueF{#4}{; #4}\,% queue contents
\IfBooleanT{#1}{$\!}% mm wrap
}

% ~ buffer
\NewDocumentCommand{\PCalcBuffer}{s E1{{1{\PrcP}2{\PrcQ}}} E2{{\QHead}} o}{%
\IfBooleanT{#1}{$}% mm wrap
{\PCalcEndPoints#2}:{#3}%
\IfNoValueF{#4}{\cdot #4}\,% queue contents
\IfBooleanT{#1}{$\!}% mm wrap
}

% ~ set timer
\NewDocumentCommand{\PCalcSetTimer}{s E1{\Tix} t. O{\Prc}}{%
   \IfBooleanT{#1}{$}% mm wrap
   \TTPrcSet\left({#2}\right)%
   \IfBooleanTF{#3}{.}{.#4}% proceeding
   \IfBooleanT{#1}{$\!}% mm wrap
}

% ~ if then else
\NewDocumentCommand{\PCalcIf}{s O{\Const} E2{{\Prc}} E3{{\Qrc}}}{%
\IfBooleanT{#1}{$}% mm wrap
\TTPrcIf\;{#2}\;\TTPrcThen\;{#3}\;\TTPrcElse\;{#4}\;%
\IfBooleanT{#1}{$\!}% mm wrap
}

% ~ session environment channel buffer
\NewDocumentCommand{\PSesEnvTypeBuffer}{s E1{{\SesEnv}} E2{{2{\Queue}}}}{%
   \IfBooleanT{#1}{$}% mm wrap
   {#2},\,{\PCalcBuffer#3}%
   \IfBooleanT{#1}{$\!}% mm wrap
}

% ~ session environment cfg queue
\NewDocumentCommand{\PSesEnvTypeQueue}{s E1{{\SesEnv}} E2{{2{\Queue}}}}{%
   \IfBooleanT{#1}{$}% mm wrap
   {#2},\,{\PCfgQueue#3}%
   \IfBooleanT{#1}{$\!}% mm wrap
}

% ~ session message
\NewDocumentCommand{\PSesMsg}{s E1{{\PrcMsg}} E2{{\MsgType}}}{%
\IfBooleanT{#1}{$}% mm wrap
{#2}:{#3}\,%
\IfBooleanT{#1}{$\!}% mm wrap
}

% ~ session message
\NewDocumentCommand{\PSesTimer}{s E1{{\Tix}} E2{{\Const}}}{%
\IfBooleanT{#1}{$}% mm wrap
{#2}:{#3}\,%
\IfBooleanT{#1}{$\!}% mm wrap
}

% ~ var environment message data-types
\NewDocumentCommand{\PVarEnvTypeTimerVal}{s E1{{\VarEnv}} E2{{1{\Tix}2{\Const}}}}{%
\IfBooleanT{#1}{$}% mm wrap
{#2},\,\PSesTimer#3%
\IfBooleanT{#1}{$\!}% mm wrap
}

% ~ session set domains
\NewDocumentCommand{\PSesSetTypeEnvs}{s O{\SesEnv} O{\SesSet}}{%
   \IfBooleanT{#1}{$}% mm wrap
   {#3}\cup\mkSet[#2]\,%
   \IfBooleanT{#1}{$\!}% mm wrap
}

% ~ recursion configurations
\NewDocumentCommand{\PSesSetCfgs}{s E1{\ValClocks} E2{\TypeS}}{%
   \IfBooleanT{#1}{$}% mm wrap
   \mkTup[\boldsymbol{#2}][\boldsymbol{#3}]\,%
   \IfBooleanT{#1}{$\!}% mm wrap
}

% ~ typing messages
\NewDocumentCommand{\PVarTypeJudge}{s E1{\VarEnv} E2{\PrcMsg} E3{\DataType}}{%
\IfBooleanT{#1}{$}% mm wrap
{#2}\;\Entails\,{#3}:{#4}%
\IfBooleanT{#1}{$\!}% mm wrap
}

% ~ 
\NewDocumentCommand{\SesDomain}{s O{\SesEnv}}{%
   \IfBooleanT{#1}{$}% mm wrap
   \SesDom\left({#2}\right)%
   \IfBooleanT{#1}{$\!}% mm wrap
}
