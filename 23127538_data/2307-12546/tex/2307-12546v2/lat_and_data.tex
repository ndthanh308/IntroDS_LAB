\section{Instrument \& Background}
\label{lat_and_background}

\subsection{The LAT Data}
\label{LATData}

The data for the 4FGL DR4 catalog were taken during the period 4 August 2008 (15:43 UTC) to 2 August 2022 (21:53 UTC) covering 14 years.
During most of this time, \Fermi was operated in sky-scanning survey mode, with the viewing direction rocking north and south of the zenith on alternate orbits such that the entire sky is observed every $\sim$3 hours.
Since 8 April 2018 it is operated in partial sky-scanning mode\footnote{See \url{https://fermi.gsfc.nasa.gov/ssc/observations/types/post_anomaly/}.}. This has little impact on the integrated sky coverage relevant to the source catalog.

As in 4FGL, intervals around solar flares and bright $\gamma$-ray bursts (GRB) were excised. During the last two years, 54 ks were cut due to bright solar flares between July 2021 and January 2022, and 1 ks around 3 new bright GRBs.
The current version of the LAT data and Instrument Response Functions remains P8R3\_V3 \citep{LAT13_P8, LAT18_P305}.
The energy range remains 50~MeV to 1~TeV, and the data are split over the same 19 components with the same zenith angle selections as in DR3.

\subsection{Model for the Diffuse Gamma-Ray Background}
\label{DiffuseModel}

We used the same model for the interstellar emission (gll\_iem\_v07) and the same isotropic spectrum (iso\_P8R3\_SOURCE\_V3\_v1) as in DR3.
We realized however that we could improve on the procedure used up to DR3.
In order to avoid the sharp jumps between neighboring Regions of Interest (RoIs) with independent normalizing parameters, we rescaled the full model smoothly from the parameter mapping obtained at RoI level.
To that end we adopted the following procedure:
\begin{enumerate}
\item We chose to fix the normalization of the isotropic component to 1 meaning that this component is truly isotropic for this analysis. We instead modulated the Galactic component only. In order to leave the same level of freedom we applied a LogParabola\footnote{See \url{https://fermi.gsfc.nasa.gov/ssc/data/analysis/scitools/source_models.html\#LogParabola}. The normalization is called $N_0$ there.} (LP) modulation to each RoI (setting the reference energy $E_0$ to 1~GeV). After refitting all sources and iterating we obtained a set of ($K_i$, $\alpha_i$, $\beta_i$) triplets covering the entire sky, where $K_i$, $\alpha_i$ and $\beta_i$ are the normalization, index and curvature parameters of the LP model in RoI $i$. Their distributions are summarized in Table~\ref{tbl:LPMod}.
\item To go from RoIs to a full mapping of each point ($l$, $b$) in the sky, we defined weights of the surrounding RoIs $w_i = \max(D_i,R_i,2\degr)^{-2} \sigma_i^{-2}$, where $D_i$ is the distance between ($l$, $b$) and the center of RoI $i$, $R_i$ is the RoI core radius \citep[see item 5 in \S 3.2 of][]{LAT20_4FGL} and $\sigma_i$ is the precision on the normalization estimate in the RoI. The $\sigma_i^{-2}$ term is the usual statistical weighting. The reasoning behind the first term is to set a weight that decreases with distance from the RoI (the $D_i$ term), but remains constant while inside the RoI core (the $R_i$ term) and does not increase too much near small RoIs (the $2\degr$ term).
\item The neighboring RoIs were ranked by increasing distance to the current point. We derived a smooth map of the normalization parameter $K(l,b) = \Sigma_i w_i(l,b) K_i$. The sum was truncated when the precision on $K(l,b)$ reached the target value of $10^{-3}$ (a little below the best precision on individual RoIs, reached in the Galactic Ridge) or the number of RoIs reached 15 (so that the smoothing remained reasonably local). The result is shown in Fig.~\ref{fig:galnorm_interp}.
\item We obtained the smooth maps of $\alpha$ and $\beta$ using the same weights (and capping the sum at the same number of RoIs) as for the normalization, at each position in the sky.
\item We modulated the original Galactic model by $A(l,b,E) = K(l,b) \left (\frac{E}{E_0}\right )^{-\alpha(l,b) - \beta(l,b) \ln(E/E_0)}$ over the sky and at all energies $E$.
\end{enumerate}

\input{LP_modulation.tex}

% Figure environment removed

This rescaled model was derived from the DR3 data set, list of seeds and RoIs before we started working on DR4. Since there is no reason why it should change with time we applied it directly to the DR4 data set, list of seeds (\S~\ref{catalog_detection}) and reoptimized RoIs (\S~\ref{catalog_significance}). In the maximum likelihood fitting the isotropic component was fixed, but we kept the same power-law modulation of the rescaled Galactic model as before, with the same prior widths (0.03 and 0.02) but prior means set to 1 and 0 for the normalization and the index, respectively. We quantified the effect by comparing the DR4 results with the results obtained starting from the same data set and list of seeds, but fitting the Galactic and isotropic diffuse components as in DR3. The resulting parameter distributions are much narrower than before (scatters of 0.015 and 0.008 instead of 0.051 and 0.020 on the normalization and the index, respectively) but they remain broader than expected from pure statistical fluctuations (0.004). We also checked that the log(Likelihood) improved on average.

The effect on sources was measurable, and mostly due to the LP modulation of the Galactic diffuse and fixing the isotropic component, rather than to the smoothing. The source significance increased by $0.02 \sigma$ on average, leading to 71 more sources above threshold. The number of curved spectra decreased by 245. The energy flux increased by about 2\%, with a scatter around 10\% ($0.5 \sigma$).

The LP modulation of the original diffuse model is anchored in the 0.1 to 10~GeV range, where most of the events are. This implies that its behavior above 10~GeV is largely an extrapolation of the low-energy range and does not accurately reflect the high-energy range. This has no impact on point sources, which depend little on the diffuse model above 10~GeV because the radius of the Point Spread Function (PSF) is narrower than $0.15\degr$ (68\% containment). But it impacts extended sources. The largest effect is observed in FGES J1036.3$-$5833 in Carina, which is a large ($4.9\degr$ diameter) and hard (\texttt{LP\_EPeak} = 25~GeV) extended source on top of a +50\% modulation of the Galactic diffuse at 100~GeV. Its energy flux decreased by nearly 10\% between DR3 and DR4.

The model for the emission of the Sun and the Moon was kept the same, neglecting the modulation of the emission along the solar cycle. It was only updated to account for the additional two years of data.
