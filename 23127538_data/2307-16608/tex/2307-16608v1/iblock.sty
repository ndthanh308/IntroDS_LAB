\RequirePackage{hang}

\ExplSyntaxOn

\newlength{\iblockleftmargin}

\cs_new:Npn \iblock_init_local_state: {
  \cs_set_eq:NN \row \iblock_row:
  \cs_set_eq:NN \mrow \iblock_math_row:n
  \cs_set_eq:NN \mhang \iblock_math_hang:nn
  \bool_set:Nn \l_iblock_inside \c_true_bool
}

\bool_new:N \l_iblock_inside

\cs_new:Npn \iblock_container:n #1 {
  \group_begin:
  \raggedright
  \setlength \hangingleftmargin {
    \bool_if:NTF \l_iblock_inside {0em} {\iblockleftmargin}
  }
  \compacthang
  \iblock_init_local_state:
  #1
  \endcompacthang
  \group_end:
}

\cs_new:Npn \iblock_row: { \item }

\cs_new:Npn \iblock_math_row:n #1 {
  \iblock_row: \ensuremath{#1}
}

\cs_new:Npn \iblock_math_hang:nn #1 #2 {
  \iblock_math_row:n {#1}
  \iblock_container:n {#2}
}

\cs_new:Npn \iblock_nested_container:nn #1 #2 {
  \group_begin:
  \int_set:Nn \l_tmpa_int {#1}
  \dim_set:Nn \l_tmpa_dim {\fp_to_dim:n {\parindent + \l_tmpa_int * 1em}}
  \setlength\iblockleftmargin{\l_tmpa_dim}
  \iblock_container:n { #2 }
  \group_end:
}


\NewDocumentCommand\iblock{O{0} +m}{
  \iblock_nested_container:nn {#1} { #2 }
}

\ExplSyntaxOff
