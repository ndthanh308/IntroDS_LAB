%Adapted from https://tex.stackexchange.com/questions/356636/restate-a-theorem-before-stating-it
\ProvidesPackage{restate-private}
\RequirePackage{thmtools}
\RequirePackage{environ}
\RequirePackage{etoolbox}
\RequirePackage{pgfkeys}
\RequirePackage{xstring}
\makeatletter
\long\def\@secondofthree#1#2#3{#2}
\long\def\@thirdoffour#1#2#3#4{#3}
\newcounter{restating}

\pgfkeysdef{/handlers/.altForm}
{%
  \global\providetoggle{\pgfkeyscurrentpath}%
  \global\toggletrue{\pgfkeyscurrentpath}%
}
\pgfkeysdef{/handlers/.defForm}
{%
  \global\providetoggle{\pgfkeyscurrentpath}%
  \global\togglefalse{\pgfkeyscurrentpath}
}
\newcommand{\restateAlt}[3]{%
  \providetoggle{/RestateAlt/#1}%
  \iftoggle{/RestateAlt/#1}{#3}{#2}%
}
\NewEnviron{restatethis}[2]{%
  \begin{#1}%
  \label{#2}
  \BODY
  \protected@write\@auxout{}{%
    \string\@restatetheorem{#1}{#2}{\csname the#1\endcsname}{\detokenize\expandafter{\BODY}}%
  }%
  \end{#1}%
}
\@ifpackageloaded{thmtools}{%
  \def\restatethm@getthmcountercsname#1{\def\thethmcsname{#1}}%
}{%
  \@ifpackageloaded{ntheorem}{%
    \def\restatethm@getthmcountercsname#1{%
      \def\thethmcsname{\expandafter\expandafter\expandafter\restatethm@ntheorem@getthmcountercsname@helper\csname mkheader@#1\endcsname}}%
    \def\restatethm@ntheorem@getthmcountercsname@helper#1\@thm#2#3#4{#3}
  }{%
    \@ifpackageloaded{amsthm}{%
      \def\restatethm@getthmcountercsname#1{\edef\thethmcsname{\expandafter\expandafter\expandafter\@thirdoffour\csname#1\endcsname}}%
    }{%
      \def\restatethm@getthmcountercsname#1{\edef\thethmcsname{\expandafter\expandafter\expandafter\@secondofthree\csname#1\endcsname}}%
    }%
  }%
}
\newcommand{\@restatetheorem}[4]{%
  \expandafter\gdef\csname restatethis@#2\endcsname{%
    \begingroup
    \restatethm@getthmcountercsname{#1}
    \expandafter\def\csname the\thethmcsname\endcsname{#3}%
    \addtocounter{restating}{1}
    \expandafter\def\csname theH\thethmcsname\endcsname{restated.\arabic{restating}.#3}%
    \begin{#1}#4\end{#1}%
    \expandafter\addtocounter\expandafter{\thethmcsname}{-1}
    \endgroup
  }%
  \expandafter\gdef\csname restatethisbody@#2\endcsname{%
    \begingroup
    #4
    \endgroup
  }%
}
\newcommand{\restate}[2][]{%
  \StrSubstitute{#1}{,}{/.altForm,/RestateAlt/}[\commaReplace]%
  \IfEq{#1}{}{\edef\x{}}{%
    \edef\x{/RestateAlt/\commaReplace/.altForm}%
  }%
  \pgfkeysalsofrom{\x}%
  \csname restatethis@#2\endcsname%
  \StrSubstitute{#1}{,}{/.defForm,/RestateAlt/}[\commaReplace]%
  \IfEq{#1}{}{\edef\x{}}{%
    \edef\x{/RestateAlt/\commaReplace/.defForm}%
  }  \pgfkeysalsofrom{\x}%
}
\newcommand{\restateBody}[2][]{%
  \StrSubstitute{#1}{,}{/.altForm,/RestateAlt/}[\commaReplace]%
  \IfEq{#1}{}{\edef\x{}}{%
    \edef\x{/RestateAlt/\commaReplace/.altForm}%
  }%
  \pgfkeysalsofrom{\x}%
  \csname restatethisbody@#2\endcsname%
  \StrSubstitute{#1}{,}{/.defForm,/RestateAlt/}[\commaReplace]%
  \IfEq{#1}{}{\edef\x{}}{%
    \edef\x{/RestateAlt/\commaReplace/.defForm}%
  }%
  \pgfkeysalsofrom{\x}%
}
\makeatother
