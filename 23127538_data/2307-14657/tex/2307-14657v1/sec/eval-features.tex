\input{tbl/tbl_binary_and_multiclass_featImportance} 
%\input{tbl/tbl_binary_featImportance} \input{tbl/tbl_multiclass_featImportance}

\subsection{Feature Class Importance}
\label{sec:eval-features} 

This section examines the importance of the 
static and dynamic features for binary and family classification
using a Random Forest classifier.
%
We measure feature importance 
% in both binary and family classification tasks 
using the average Mean Decrease Impurity (MDI) score. 
In a tree-based classifier, 
the MDI score of a feature captures how often the feature was used 
in the tree.
The more a feature is used, 
the more important it is to distinguish different classes. 
For feature classes,
we average the MDI Score across all the features belonging 
to the same feature class and over all the trees in the Random Forest model. 

\paragraph{Feature classes.}
Table~\ref{tbl:binary_and_multiclass_FeatImportance} 
summarizes the feature class importance.
% for both classification tasks.
%The feature importance evaluation results are reported in
%Table~\ref{tbl:binary_FeatImportance} and
%Table~\ref{tbl:multiclass_featImportance}. 
Overall, static features are ranked higher than dynamic features, 
especially for family classification.
This matches results in Section~\ref{sec:classification-results} 
where dynamic features provide marginal improvements over static features.
This observation is in line with recent findings that
although humans prefer dynamic features, 
% achieving high accuracy even when some are missing, 
ML algorithms rely more on the \emph{always present} 
static features~\cite{AonzoUsenix2022}. 

The most contributing static feature classes for both classification tasks 
are \emph{s-bytegrams}, \emph{s-opcodegrams}, and \emph{s-strings}. 
This confirms what was previously observed in the literature, 
with raw and opcode ngrams dominating over other 
static features~\cite{aghakhani2020malware}. 
On the other hand, the most contributing dynamic feature classes for both classification tasks are \emph{d-file} and \emph{d-process}. 
It is interesting to note that even expert human analysts used widely file and process operations to identify malicious behaviours~\cite{AonzoUsenix2022}.
 
% On the other side of the spectrum, \emph{d-network}, \emph{d-mutex}, and \emph{d-service} (dynamic) as well as \emph{s-dll} and \emph{s-file} (static), are the least important.
In our dataset, over 50\% of the malware samples contain missing features 
values in the \emph{d-network} and \emph{d-service} feature classes, 
thus missing feature values is likely the reason for their low importance.
We evaluate this in Section~\ref{sec:eval-missing}.
%
%The feature dimension of network, service and mutex-based features are lower than the file and process-based behavior features. 
%Theoretically, lower feature dimensions usually provide less rich information to differentiate different classes. 
%Augmenting the feature dimensions helps improve the classification accuracy in general, as suggested and confirmed by the kernelization techniques used in Support Vector Machine. 
%Therefore, the missing feature values (e.g., \emph{d-network} and \emph{d-service}), low dimensions (e.g., \emph{s-file}), or both (e.g., \emph{d-mutex}) cause such low feature importance.
%
It is interesting that \emph{d-registry} ranks second 
for binary classification, but only 10th for family classification.
This means that registry operations are useful to differentiate 
malware from goodware, but they do not provide enough diversity to 
separate different malware families. 
This likely happens because multiple malware families operate on the same 
registry keys such as those related to achieving persistence (e.g., auto-start) 
and those that disable OS security features. 
In contrast, goodware does not need to operate on those keys.
%
% The opposite is observed for \emph{d-mutex} whose importance is higher 
% on family clasification compared to binary classification, 
% likely because different malware families use different mutex values. 

\paragraph{Individual features.}
\revision{
The most contributing static feature classes are
\emph{s-bytegrams} and \emph{s-opcodegrams}, 
but their individual features are hard to interpret. 
% because they correspond to sequences of bytes and 
% opcodes for which we lack the context of from where they were extracted.
For binary classification, 
the top 10 \emph{s-strings} features capture 5 API names 
(\emph{exit}, \emph{CreateThread}, \emph{cexit}, \emph{CopyFileA}, \emph{WinExec}), 
one section name (\emph{.idata}), 
one module name (\emph{MSVCRT.dll}), 
a string possibly related to the .NET runtime 
(\emph{<assemblyIdentity}), and 
two short strings with unclear meaning 
(\emph{:0806}, \emph{L\$ H}).
% (mainly strings, imports, dlls, sections -mainly entropy)
%
The top \emph{s-sections} features capture section entropy and 
bit 31 in the section characteristics field,
which states if the section can be written to. % IMAGE_SCN_MEM_WRITE 
These features are likely related to packing. 
We further examine which static features allow to detect packed malware
in Section~\ref{sec:eval-packing}.
%
The top \emph{s-imports} features have some overlap with the
top strings (e.g., \emph{exit}, \emph{cexit}), 
but also contain APIs possibly used for evasion
(e.g., \emph{queryperformancecounter}, \emph{getsystemtimeasfiletime}) and 
popular C runtime functions
(e.g., \emph{free}, \emph{calloc}, \emph{malloc}, \emph{fprintf}).
%
For family classification, the top static individual features differ 
from those for binary classification with no intersection 
between the top 10 \emph{s-strings} and \emph{s-imports} 
for binary and family classification.
For example, the top strings contain 6 API names 
(\emph{WNetOpenEnumA}, \emph{WNetEnumResourceA}, \emph{WNetCloseEnum},
\emph{RegisterServiceProcess}, 
\emph{PathFileExistsA}, \emph{UpdateResourceA}), 
a third-party library name (\emph{StringX}), and 
some short strings 
(\emph{QQQQS3}, \emph{lllll}, \emph{3.91}).
These strings are not highly ranked for binary classification and are possibly 
associated with specific families.
% We also observe some packing-related strings such as 
% \emph{.aspack} and short strings such as 
}

% Top 10 static, binary sections:
% pesectionProcessed_sectionsMaxEntropy
% pesectionProcessed_entrypointSection_characteristics_bit31
% pesection_1_characteristics_bit31
% pesectionProcessed_sectionsMeanVirtualSize
% pesectionProcessed_entrypointSection_entropy
% pesectionProcessed_sectionsMaxVirtualSize
% pesection_1_entropy
% pesectionProcessed_sectionsMinVirtualSize
% pesection_2_entropy
% pesectionProcessed_sectionsMeanSize

% Top 10 static,binary imports:
% imp_exit, imp__cexit, imp_free, imp_calloc, imp_malloc, imp_getenv, 
% imp_fprintf, imp__except_handler4_common
% imp_queryperformancecounter, imp_getsystemtimeasfiletime

% Top 10 static, family strings:
% str_WNetOpenEnumA
% str_This program must be run under Win32
% str_StringX
% str_3.91
% str_RegisterServiceProcess
% str_WNetEnumResourceA
% str_WNetCloseEnum
% str_!This program cannot be run in DOS mode.
% str_PathFileExistsA
% str_UpdateResourceA

% Top 10 static,family imports:
% imp_wnetopenenuma
% imp_setsuspendstate
% imp_internetsetoptionexa
% imp_cryptverifysignaturew
% imp_urlopenblockingstreama
% imp_raise
% imp_ntdelayexecution
% imp_strtointexa
% imp___vbagetfxstr3
% imp_wvnsprintfa

\revision{
Among the dynamic features, the most contributing classes are
\emph{d-file} and \emph{d-process}.
In contrast to the static features, 
the top contributing dynamic features largely overlap 
between binary and family classification.
The top process features are 
the number of processes invoking shell commands, and
the number of terminated, opened, and created processes.
% Similarly, the number of terminated, resumed, opened and the number of
% asynchronous procedure calls (APC) queued to a thread are also ranked as
% the most important individual dynamic features for binary classification.
% Besides, the directories / the extensions (.dll and .exe) / 
The top file features capture the entropy of the files accessed, 
as well as the name of some specific files, such as
\emph{appdata{\textbackslash}local{\textbackslash}temp{\textbackslash} 7zipsfx.000}, 
which likely indicates the executable is an SFX installer.
%
One difference between binary and family classification is that 
for family classification the number of mutexes created is a top contributor. 
Mutexes are often used by malware creators to avoid re-infecting the same 
host and their number and values are intuitively family-specific.
}

\revision{Overall, the interpretability of individual features can be hard, 
especially for n-grams.
In fact, we argue that one benefit of ML classifiers is that they can select 
the features they consider most useful, which a human may not be able to 
identify based on domain knowledge.
Our data release~\cite{anon_repo} includes the top 
individual features for the different models.}

\summary{5}{
Static features are more important than dynamic features for 
both classification tasks, but especially for family classification. 
Raw and opcode n-grams are the most important feature classes in 
both classification tasks. 
The importance of a feature class may depend on the classification task.
For example, \textit{d-registry} is important to distinguish malware from 
goodware, but is not relevant for family classification. 
}
