\section{System model and problem statement}  
\subsection{System model}
Let $\mathbb{S} =\{\mathcal{C}, \mathcal{U}\}$ be the cloud storage system with a smart contract $\mathcal{B}_{DEDU}$ running on a public Blockchain network $\mathcal{BC}$ where $\mathcal{C} = \{c_{1}, c_{2},...,c_{C}\}$ is the set of CSPs, and $\mathcal{U} = \{u_{1}, u_{2},... ,u_{U}\}$ is the set of cloud users.
\par CSPs provide data storage service to cloud users. If a CSP receives a data storage request from a cloud user, it will check whether any cloud user has previously stored the data in its storage. If the check is negative, then it will ask the user to encrypt and upload the data. Otherwise, it will (1) verify the proof-of-ownership of the data and (2) issues a file link to the user to access the pre-stored data. 
\par Many cloud users may exist in the system, and some of them may request to store the same data. If they all accept the deduplication, then only one copy of that data is stored in the cloud. Let $\mathcal{D}=\{d_{1}, d_{2},..., d_{D}\}$ be the set of data that the users may wish to store in the cloud. Each $d \in \mathcal{D}$ belongs to at least one user. Let $N_{d}^{c}(t)$ represent the number of users having the same data $d$ at time $t$ therefore $N_{d}^{c}(t) \ge 1$ and $\Sigma_{d \in D} N_{d} = \mathcal{U}$.
\par  A smart contract facilitates fair payments. $\mathcal{B}_{DEDU}$ assures the users for a fair dedup rate (based on which the fee is computed) and assures the CSPs for a fair payment.
\par A public Blockchain network $\mathcal{BC}$ is maintained by a set of peers known as miners who will execute the $\mathcal{B}_{DEDU}$ according to an underlying consensus algorithm.

 As shown in Figure \ref{fig:BDEDUarchitecture}, the interactions between the entities in $\mathbb{S}$ are as follows\footnote{For the sake of simplicity, we assume single CSP and a single user in the overview. An inter CSP model is discussed later.}: 1) A CSP design and deploys a $\mathcal{B}_{DEDU}$ on $\mathcal{BC}$. 2) CSP retrieves $\mathcal{B}_{DEDU}$ address from $\mathcal{BC}$. 3) CSP announces $\mathcal{B}_{DEDU}$ address and ABI on a public platform. 4) A user sends a storage request to $\mathcal{B}_{DEDU}$. 5) $\mathcal{B}_{DEDU}$ computes and returns storage fee to be paid by the user. 6) The user sends the storage fee to $\mathcal{B}_{DEDU}$. 7) Depending upon the response from $\mathcal{B}_{DEDU}$ user sends (data or (tag and PoP)) to CSP. 8) CSP requests $\mathcal{B}_{DEDU}$ for storage fee information. 9) $\mathcal{B}_{DEDU}$ sends the storage fee information to CSP.  10) If the user sent the tag and PoP, then CSP verifies the PoP, and if it is correct, it will send a confirmation to $\mathcal{B}_{DEDU}$. If the user sends encrypted data, it will simply send a confirmation to $\mathcal{B}_{DEDU}$.  11) CSP sends the stored file link to the user. 12) The user sends the confirmation of receipt of file link to $\mathcal{B}_{DEDU}$. 13) $\mathcal{B}_{DEDU}$ sends the storage fee to CSP.
% Figure environment removed
\subsection{Economic model}
The pricing model is pay-per-use, as often used in practice. Every party is rational and tries to maximize its utility, and the utility is based on their interactions with the proposed system.
\subsubsection{Utility of Cloud user}
Let a cloud user $u\in\mathcal{U}$ stores data $d\in\mathcal{D}$ at a cloud managed by a CSP $c\in\mathcal{C}$. Let $U_{u}^{0}(t)$ and $U_{u}^{1}(t)$ be the utilities of $u$ when he do not adopt dedup and adopt dedup with $\mathcal{B}_{DEDU}$ respectively.
\begin{equation}
U_{u}^{0}(t) = P_{u}(t) - SF_{u}^{c}(t).
\end{equation}
Where $P_{u}(t)$ is the profit earned by storing data in cloud, $SF_{u}^{c}(t)$ is the storage fee $u$ has to pay to $c$.

Now let us define the utility of a user when dedup with $\mathcal{B}_{DEDU}$ is adopted.
\begin{equation}\label{eq:Uu1}
U_{u}^{1}(t) = P_{u}(t) - \frac{SF_{u}^{c}(t)}{n^{c}_{d}(t)} - EF_{u}^{c}(t) - I_{u}(t)
\end{equation}
Where $n_{d}^{c}(t)$ is the data dedup rate at $c$, i.e., the number of users having data $d$ opted for dedup before $c$ receive $u$'s request. In our model, the fee depends on two parameters (1) Storage fee ($SF_{u}^{c}(t)$) - computed according to the current dedup rate and (2) Extra fee ($EF_{u}^{c}(t)$) - a cost paid by the user apart from storage fee to make the cloud provider incentive compatible. The cost of interacting with the smart contract is represented with $I_{u}(t)$.
\subsubsection{Utility of CSP}
Let $U_{c}^{0}(t)$ be the utility of a CSP when dedup is not applied.
\begin{equation}
U_{c}^{0}(t) = \sum_{d\in \mathcal{D}} N_{d}^{c}(t) * (SF_{u}^{c}(t)-SC_{c}^{u}(t))
\end{equation}
where $N_{d}^{c}(t)$ is the number users having data $d\in\mathcal{D}$. $SF_{u}^{c}(t)$ is the storage fee received by $c$ and $SC_{c}^{u}(t)$ is the cost incurred to $c$ for storing data.

Let $U_{c}^{1}(t)$ be the utility of CSP when dedup with $\mathcal{B}_{DEDU}$ is adopted.
\begin{multline}
U_{c}^{1}(t) = \sum_{d\in \mathcal{D}} (N^{c}_{d}(t) - n^{c}_{d}(t) + 1) * (SF_{u}^{c}(t) - SC_{c}^{u}(t))  \\ 
 + \sum_{d\in \mathcal{D}} n^{c}_{d}(t) * EF_{u}^{c}(t) 
  - \sum_{d\in \mathcal{D}} N^{c}_{d}(t) * I_{c}(t) - I_{deploy}(t) \\
\end{multline}
where $I_{c}^{deploy}(t)$ is the cost of deploying smart contract and $I_{c}(t)$ is the cost of interacting with smart contract. 

The summary of utilities of cloud user and CSP are given in Table \ref{tab:Utilitiessummary}.

\begin{table}
	\centering
	\begin{tabular}{|p{0.04\textwidth}|p{0.27\textwidth}|p{0.6\textwidth}|}
		\hline
		 & \textbf{without dedup} & \textbf{dedup with $\mathcal{B}_{DEDU}$} \\ \hline
		\textbf{User} & $U_{u}^{0}(t) = P_{u}(t) - SF_{u}^{c}(t)$ & $U_{u}^{1}(t) = P_{u}(t) -  \frac{SF_{u}^{c}(t)}{n^{c}_{d}(t)} - EF_{u}^{c}(t) - I_{u}(t)$\\ \hline
		\textbf{CSP} & $U_{c}^{0}(t) = \sum_{d\in \mathcal{D}} N_{d}^{c}(t) * (SF_{u}^{c}(t)-SC_{c}^{u}(t))$& $
		 U_{c}^{1}(t) =  \sum_{d\in \mathcal{D}} (N^{c}_{d}(t) - n^{c}_{d}(t) + 1) * (SF_{u}^{c}(t) - SC_{c}^{u}(t)) $  
		  $+ \sum_{d\in \mathcal{D}} n^{c}_{d}(t) * EF_{u}^{c}(t) $
		 $ - \sum_{d\in \mathcal{D}} N^{c}_{d}(t) * I_{c}(t) - I_{deploy}$ \\
		\hline
	\end{tabular}
\caption{Utilities of cloud user and CSP}
\label{tab:Utilitiessummary}
\end{table} 

\subsection{Problem statement}\label{def:pb}
\begin{enumerate}
	\item The first problem is to incentivize the cloud user for choosing deduplication. CSP offers this incentivization in the form of discounts on storage fee. These discounts will help to motivate the cloud user for choosing dedup with $\mathcal{B}_{DEDU}$.
	\item The second problem is to find the bounds on discount a CSP can offer so that a CSP/user earns more profits when compared to storing data without dedup.
	\item  The third problem is to compute the correct deduplication rate based on which the storage fee is computed.
	\item The fourth problem is to distribute the storage fee equally among all the users who store data $d$ at $c$ irrespective of when their request arrives.
	\item Furthermore, the last problem is to facilitate fair payments between cloud users and CSP.
\end{enumerate}
Our objective is to design a fair deduplication scheme with the following design goals.
\begin{itemize}[leftmargin=*,align=left]
\item[\textbf{Individually rational} (IR-constraint):] An incentive mechanism is said to be individually rational, if a rational user/CSP choosing deduplication with $\mathcal{B}_{DEDU}$ obtains a non-negative utility. That is $\forall u \in \mathcal{U}$ with $\mathcal{B}_{DEDU}$ $U_{u}^{1}(t) \ge 0$ and $\forall c \in \mathcal{C}$  $U_{c}^{1}(t) \ge 0$.
\item[\textbf{Incentive compatibility} (IC-constraint):] \label{def:IC-constraint}  An incentive mechanism is said to be incentive compatible, if the CSP or cloud users cannot gain more profits from not adopting dedup. The best strategy for a cloud user is to opt deduplication with $\mathcal{B}_{DEDU}$. That is $\forall u \in \mathcal{U}$ $U_{u}^{1}(t)-U_{u}^{0}(t) \ge 0$. The CSP obtains more profits by choosing deduplication with $\mathcal{B}_{DEDU}$. That is $\forall c \in \mathcal{C}$ $U_{c}^{1}(t)-U_{c}^{0}(t) \ge 0$.
\item [\textbf{Correctness}:] A dedup scheme is said to be correct if the storage fee for any user is defined by the following three factors: (1) size of the data to be stored (2) dedup rate and (3) auxiliary pricing function $p(|d|)$ at time $t$ previously set by CSP. In other words, no party (CSP/cloud users/miners) should influence the storage fee to be paid by the user except the above three factors.
\item[\textbf{Uniform payments}:] A dedup scheme is said to be uniform if every user holding data $d$ at $c$ pays the same fee irrespective of when their request arrives.
\item[\textbf{Fair payments}:] A dedup scheme is said to be fair if an honest CSP receives storage fee if and only if an honest user receives the file link of the data stored in the cloud managed by CSP.
\end{itemize}
\subsection{Threat model}
\begin{itemize}
\item \textbf{Threats to dedup rate}: Both the cloud provider and the user are greedy to increase their utility as much as possible. A malicious cloud provider or user may try to influence some of the miners of the Blockchain network to include fraudulent transactions (containing incorrect dedup rate) to increase their utility. 
\item \textbf{Threats to fairness}: Both the cloud provider and the user are allowed to abort the protocol abruptly. However, no party can gain financial advantage by aborting the protocol.
\item \textbf{Standard Blockchain model}: We assume a standard Blockchain threat model from \cite{kosba2016hawk,juels2015ring} such that the Blockchain is trusted for immutability and availability but not for privacy. We also do not consider future software updates and potential bugs of the current version of Ethereum. 
\end{itemize}
\subsection{Notations}
The notations used in this paper are presented in Table \ref{tab:notations}.
\begin{table}[!h]
	\centering
	\begin{tabular}{p{2.2cm}|p{0.85\textwidth}}
		\hline
		Symbol & Meaning  \\ \hline
		$c$ , $\mathcal{C}$ &  Cloud storage provider $c \in \mathcal{C}$, set of cloud storage providers \\
		$u$, $\mathcal{U}$ & Cloud user $u \in \mathcal{U}$, set of users  \\
		$d$, $\mathcal{D}$ & Data file $d \in \mathcal{D}$, set of data \\
		$U_{u}^{0}(t)$,  $U_{u}^{1}(t)$ & Utility of $u$ without dedup and dedup with $\mathcal{B}_{DEDU}$ at time $t$ \\
		$U_{c}^{0}(t)$, $U_{c}^{1}(t)$ & Utility of a $c$ without dedup and dedup with $\mathcal{B}_{DEDU}$ at time $t$ \\
		$p_{u}(t)$ & Profits earned by $u$ for storing data in cloud at time $t$\\
		$SF_{u}^{c}(t)$ & Storage fee paid by $u$ to $c$ at time $t$ \\
		$EF_{u}^{c}(t)$ & Extra fee paid by $u$ to $c$ apart form storage fee at time $t$\\
		$SC_{c}^{u}(t)$ & Storage cost incurred by $c$ for storing $u$'s data at time $t$\\
		$N_{d}^{c}(t)$ & Number of users having the data $d$ at $c$ at time $t$\\
		$n_{d}^{c}(t)$ & Deduplication rate of a data $d$ at cloud $c$ at time $t$\\
		$I_{deploy}(t)$ & Cost of deploying $\mathcal{B}_{DEDU}$ incurred to CSP at time $t$\\
		$I_{u}(t), I_{c}(t)$ & Cost of interacting with $\mathcal{B}_{DEDU}$ incurred to $u$ and $c$ at time $t$\\
		$\tau_{sub}$,$\tau_{p}$,$\tau_{c1}$,$\tau_{c2}$ & Timing parameters \\
		$\$d$, $\$paid$ & Monetary parameters representing deposit and fee paid by $u$ \\
		$numReq$ & Number of requests received by $\mathcal{B}_{DEDU}$  for storing file $d$\\
		$cPay$ & Current fee a user has to pay to store a file $d$\\
		$rState$ & Storage request state\\
		$ID$ & Public identity of a user which is unique across $\mathcal{BC}$\\
		$pay$ & The fee computed by $\mathcal{B}_{DEDU}$ to store a file $d$\\
		$k$ & Value on which timing parameters are computed \\
		$reqNum$ & Id of a request \\
		$uTAB$ & Special data structure maintained in the $\mathcal{B}_{DEDU}$ contract storage. $uTAB$ is of the form $uTAB($ $tag$, $numReq$, $cPay$, $requests ($ 	$ID$, $\tau_{sub}$, $\tau_{p}$, $\tau_{c1}$, $\tau_{c2}$, $rState$, $pay$, $\$paid$$))$. $uTAB$ is indexed by $tag$ and $requests$ is indexed by $reqNum$. \\
		\hline
	\end{tabular}
	\caption{Notations.}
	\label{tab:notations}
\end{table}

