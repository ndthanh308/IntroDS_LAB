
\iffalse
% Figure environment removed

% Figure environment removed

% Overview: two verifications
We conduct two experiments to verify \sysname{}: market replay and case study.
In the market replay, 
we verify \sysname{} by comparing order-flow reconstruction and temporal consistency of behavior variables with search-based calibration approaches. 
In the case study,
we investigate the correlations between behavior variables and market states and discuss their meanings from the perspective of real markets. 

% Dataset description
We experiment with orderbook-level data of a stock~(WindCode: 000001) from A-share market in the whole year of 2020.  
The first nine-month data are for training and the left for testing.
To guarantee diversity in market states, 
we use five monthly-updated to jointly indicate market state in the experiments:
consumer price index~(CPI), producer price index~(PPI), purchasing manager's index~(PMI), market trend, and market noise. 
Their historical records are publicly available from~\cite{AKShareZhaiQuanShuJuAKShare}. 

% Comparison scheme
In market replay, we compare \sysname{} with the following schemes:
\begin{itemize}
    \item \emph{RandSearch}~\cite{cao2022dslob} samples behaviors in the variable space and selects the best behavior set that reconstructs the target order stream.  
    In the implementation, we try ten combinations for each trading day;
    \item \emph{BayesianOPT}~\cite{bai2022efficient} is a heuristic approach, where the chosen behavior variables are based on historical steps. 
    In the implementation, we conduct Bayesian optimization based on the Gaussian process and search in ten steps for each trading day.
\end{itemize}
Note that, 
each simulation takes around 12min on a PC with Intel i7 CPU.
Thus, 
one search process of the comparison schemes takes around 120min in calibration,
while \sysname{} takes less than 1s due to its search-free characteristic.

% Evaluation method
We use the following evaluation metrics to verify \sysname{} in the market replay:
\begin{itemize}
    \item \emph{Order-flow reconstruction:} 
        % We measure the discrepancy between the two order streams by reconstruction error.
        % Specifically,
        % we compare those representative features mentioned in the Section on the calibration loss function. 
        % Formally,
        % the reconstruction loss is
        % \begin{equation}
        %     \mathcal{E}(s,\hat{s})=\sum_{m\in M} \beta_m\left\lVert m_s-m_{\hat{s}} \right\rVert_2^2,
        %     \label{eq: reconstruct_error}
        % \end{equation}
        This is shown in Equation~\ref{eq: reconstruction_fidelity}. In the experiment, we extract features~(the $f(\cdot)$) in terms of order-price spread, volatility clustering, order-size distribution, and order-price drifts from order flow (more details are in~\cite{vyetrenko2020get})
        \begin{equation}
             V(x,\hat{x})=\sum_{j\in J} \beta_j\left\lVert f_j(x)-f_j(\hat{x}) \right\rVert_2^2,
             \label{eq: reconstruct_error}
         \end{equation}
        where $J$ is the set of the features and $\beta_j$ is a normalization parameter based on z-score~\cite{curtis2016mystery};
    \item \emph{Behavior variation: } 
        To evaluate temporal consistency, 
        we evaluate the variation of behavior variables in consecutive trading days.
        Formally, we denote the behavior variation as
        \begin{equation}
            U\left(\hat{x}^{(t)}, \hat{x}^{(t+1)}\right)=\sum_{j\in J} \beta_j\left\lVert f_j\left(\hat{x}^{(t)}\right)-f_j\left(\hat{x}^{(t+1)}\right) \right\rVert_2^2,
            \label{eq: behavior_variation}
        \end{equation}
        where the notations are following Equation~\ref{eq: reconstruct_error}.
\end{itemize}
To further show that \sysname{} can capture market-state consistency,
we investigate the correlation between behavior variables and market states in the case study.

% Hyperparameters / extracted features
In this experiment, 
we calibrate these behavior variables: 
the ratio of institutional investors, fundamentalists~$\rho_f$, chartists~$\rho_c$, noise traders~$\rho_n$, and investment horizons~$\tau$. 
In model building, 
we use LSTM with two hidden layers and the market state adaptor of two fully connected (FC) layers with neurons of 200 and 100, respectively.
For the behavior estimator, we use one FC layer of 100 neurons.
The surrogate model is of three FC layers with 50, 100, and 50 neurons. 
We use ReLU as the activation function and employ Adam optimizer for training.
We set $\eta=0.1$ in Equation~\ref{eq: all_loss}.




\begin{table}
    \centering
        \caption{Correlation coefficients between market states and behavior variables }
    \begin{tabular}{cccc}
        \hline
        % ~ & \makebox[0.080\textwidth][c]{RandSearch} & \makebox[0.1\textwidth][c]{BayesianOPT} & \makebox[0.11\textwidth][c]{CONCAT-MAS} & 

         ~     & RandSearch   & BayesianOPT & \textbf{\sysname{}} \\
         \hline
        CPI           &0.0764   & 0.0447    & 0.2555\\
        % \hline
        PPI           & 0.0790  & 0.0513    & 0.2595\\
        % \hline
        PMI           & 0.0494  & 0.0549   & 0.2634 \\
        % \hline
        Market Trend  & 0.0466  & 0.0921  &  0.3266 \\
        % \hline
        Market Noise  &  0.0122 &  0.0601  &  0.3102\\
        \hline
\end{tabular}
    \label{tab: correlation}
\end{table}
\input{Sections/exp_set}




















\emph{Behavior parameters in out experiment:} We sample $g_f$, $g_c$, and $g_n$ from Laplacian distribution, parameterized by $\delta_f$, $\delta_c$ and $\delta_n$.
In the experiments,

To facilitate model learning, we extract some features, like the label of the surrogate model, from the order stream of each trading day as the input of the meta-market. 

We sum the MSE of all behaviors over two consecutive trading days
    and refer it as behavior variation. 
    We also use the z-score to balance the different behavior parameters.

we evaluate \sysname{} by order stream reproduction, measured by the \emph{reconstruction error}, 
and compare \emph{behavior variation} to show that \sysname{} observe the temporal consistency rule.  
%we demonstrate \sysname{} that analyzes the simulated order stream and produce behavior parameters for the multi-agent simulation system~(in Section~\ref{sec: exp_ham}) to reproduce the order stream.
% Figure environment removed

% Figure environment removed

% Figure environment removed 

% Figure environment removed 

\begin{table}
    \centering
        \caption{Correlation analysis between market state indicators and behavior variables }
    \begin{tabular}{cccc}
        \hline
        % ~ & \makebox[0.080\textwidth][c]{RandSearch} & \makebox[0.1\textwidth][c]{BayesianOPT} & \makebox[0.11\textwidth][c]{CONCAT-MAS} & 

         ~     & RandSearch   & BayesianOPT & \textbf{\sysname{}} \\
         \hline
        CPI           &0.0764   & 0.0447    & 0.2555\\
        % \hline
        PPI           & 0.0790  & 0.0513    & 0.2595\\
        % \hline
        PMI           & 0.0494  & 0.0549   & 0.2634 \\
        % \hline
        Market Trend  & 0.0466  & 0.0921  &  0.3266 \\
        % \hline
        Market Noise  &  0.0122 &  0.0601  &  0.3102\\
        \hline
\end{tabular}
    \label{tab: correlation}
\end{table}
\fi