\section{Introduction}\label{sec: intro}

% Background 
Multi-agent market model is a stock trading simulation system comprising multiple trading agents and an order book. 
In each step of the simulation, individual agents make ordering decisions (bid, ask, or skip) according to 
the agent state (e.g., trading account), order book information (e.g., current stock price), and certain randomness/irrationality factors. 
Typically, a trading simulation involves multiple simulation steps, resulting in a time series of orders known as the {\em order flow}. 

Prior to conducting one trading simulation, the market model requires calibration of the agent variable, 
i.e. the set of parameters that regulates the agents' ordering decisions. 
The model calibration and trading simulation are illustrated in Figure~\ref{fig: agent}. 
Note that this paper exclusively considers rule-based agents for their important explainability.  
Readers interested in data-driven trading may refer to~\cite{coletta2021towards, han2023machine, xiao2023stock} and the references therein. 

% Research problem
We study calibrating the agent variable of the multi-agent market model to simulate the order flow of any real-world historical trading day. 
This is fundamental to many Fintech applications in risk management and quantitative trading~\cite{harvey2015backtesting, reinders2023finance}.
In particular, many Fintech applications need to hypothesize the reaction of a historical market under an external intervention, 
such as an impactful order or the introduction of a new trader. 

% Figure environment removed 

% Gap
Traditionally, the calibration of multi-agent market model relies on iterative search algorithms~\cite{cao2022dslob, salhi2017heuristic, bai2022efficient}.    
The agent variable of each trading day is searched and simulated through multiple iterations 
until the market model generates a similar order flow to the target day. 
However, this is inefficient and unscalable because the trading simulation is time-consuming,  
where hundreds of agents interact with the order book only to simulate the real-world trading of a millisecond (one simulation step). 
As a result, the traditional calibration for one trading day usually takes hours on a regular computer such as a PC. 

% Problem
For the first time, we consider the deep learning approach to calibrate multi-agent market model. 
Instead of searching, 
we directly estimate the agent variables based on the deep features extracted from the target order flow. 
With this overarching goal, we study the two challenging research problems: 
1) Given that the multi-agent market model is not differentiable, how to learn the calibration using deep learning model end-to-end? 
2) How to correlate the agent variable with market-condition indexes (e.g. PPI and PMI) in calibration so as to enhance the explainability of the simulation? 

% System overview
We propose \sysname{}, the first deep learning approach to calibrate multi-agent market model for trading simulation. 
% The system diagram of \sysname{} is illustrated in Figure~\ref{fig: system_diagram}. 
As shown in Figure~\ref{fig: system_diagram}, 
\sysname{} calibrates the multi-agent model using the following novel modules: 
\begin{itemize}% [leftmargin=*]
    \item \emph{Surrogate-trading loss function to learn model calibration end-to-end: }
        \sysname{} directly estimates agent variable from the deep feature of target order flow. 
        To get over the non-differentiable issue induced by multi-agent model, 
        we propose a surrogate-trading loss function, 
        which supervises the model training through a re-parameterization approach upon the multi-agent model. 
    
    \item \emph{Condition-aware variable estimator to correlate agent variable with market condition: }
        Observing that real traders tend to behave similarly under similar market conditions, 
        we propose a condition-aware variable estimator, 
        which clusters the deep features of order flows according to their market conditions. 
        This is learned from a novel market-condition loss function.      
                    
\end{itemize}

% Figure environment removed 

We have implemented \sysname{} and conducted extensive experiments on orderbook-level data over a whole trading year.
\sysname{} has demonstrated comparable simulation accuracy to previous search-based approach without the need for variable search, 
achieving less than 0.36 in terms of Kolmogorovâ€“Smirnov statistic. 
Through a case study, 
\sysname{} has been verified to effectively capture the correlation between agent variable with multiple indexes of market conditions, 
including the PPI, PMI, CPI, market trend and market noise.     

The reminder of the paper is organized as follows: 
Section~\ref{sec: preliminary} introduces preliminaries, 
Section~\ref{sec: method} delves into the technical designs of DeepCal, 
Section~\ref{sec: exp} showcases illustrative experimental results, 
Section~\ref{sec: related_work} provides an overview of related work, 
and Section~\ref{sec: conclude} concludes the paper.



\iffalse

% Gap 2
Furthermore, previous calibration did not consider the simulation's explainability to external interventions. 
Since most simulation systems have considered trader irrationality~\cite{iori2012agent}, 
generating an order flow in calibration could have multiple sets of agent variables as candidates~\cite{bai2022efficient, gould2013limit}.  
However, these candidates do not necessarily lead to a similar reaction to external interventions. 
Leaning no preference over the candidates, 
the calibration from traditional approaches purely depends on the randomness of the search algorithms, 
which leads to inconsistent simulation results that are hard to interpret. 

% Application
Market simulation hypothesizes the reaction of historical stock markets to various external interventions, such as an impactful order or the emergence of a new trader.   
This helps financial practitioners understand the potential risk of their decisions in risk management and quantitative stock trading~\cite{harvey2015backtesting, reinders2023finance}. 
The overarching goal of market simulation is creating a game of trading with high fidelity to the realistic historical market. 

Among existing simulation models~\cite{coletta2021towards, li2020generating, coletta2022learning}, 
multi-agent market model mirrors the realistic market by involving multiple trading agents in a game. 
As shown in Figure~\ref{fig: agent}, given the agent variable of the model, 
the agents make (buy and sell) orders to an order book, generating order flows over time. 
Usually, the difference in order flows (i.e.~the time series of orders over a trading day) of the target and the simulation system is evaluated as fidelity. 

Since the state of the order book is determined by the orders as shown in Figure~\ref{fig: agent}, 
{\em agent variable}, which dominates each agent's order-making behavior, decides the generation of the simulated order flow. 
Therefore, for the simulation fidelity, 
the system requires calibration, 
that is, configuring a set of agent variables such that the simulated order flow, without external interventions, 
is as similar to the target order flow as possible. 
Note that this paper only considers handcrafted agents due to the importance of explainability of market simulation. 
Readers interested in data-driven trading may refer to~\cite{coletta2021towards, han2023machine, xiao2023stock} and the references therein. 

% Figure environment removed 

% Gap 1
Traditionally, the calibration relies on search algorithms,   
where agent variables are searched and simulated in multiple iterations~\cite{cao2022dslob, salhi2017heuristic, bai2022efficient}.  
However, this is inefficient and unscalable due to the inefficient nature of the simulation system. 
Specifically, in the simulation of each trading day, 
the system has to empower hundreds of agents to interact with the order book, only to simulate the realistic trading of a millisecond. 
Consequently, the previous calibration approach for each trading day may take hours on a regular computer (e.g., a PC). 

% Gap 2
Furthermore, previous calibration did not consider the simulation's explainability to external interventions. 
Since most simulation systems have considered trader irrationality~\cite{iori2012agent}, 
generating an order flow in calibration could have multiple sets of agent variables as candidates~\cite{bai2022efficient, gould2013limit}.  
However, these candidates do not necessarily lead to a similar reaction to external interventions. 
Leaning no preference over the candidates, 
the calibration from traditional approaches purely depends on the randomness of the search algorithms, 
which leads to inconsistent simulation results that are hard to interpret. 

% Problem
For the first time, we consider the learning-based approach to calibrate multi-agent market simulation, 
where agent variables are estimated directly from the deep features of realistic order flows. 
To make the calibration more explainable, 
we aim to annotate the agent variables in the candidate set with the indexes of market conditions, e.g., PPI and PMI, 
%we consider the consistency of agent variables with the indexes of market conditions, e.g., PPI and PMI, 
%which mirrors the reality of similar behaviors of real traders under similar market conditions. 
which benefits system explainability in two aspects:
\begin{itemize}[leftmargin=*]
    \item \emph{Consistency in interactive simulation: } 
        By labeling agent variables with market conditions,  
        the calibration reduces the randomness of selecting the agent variables from the candidate set. 
        This enables the consistency of interactive simulations and to interpreting the simulation results using market conditions;
        
    \item \emph{Data augmentation in hypothesized market scenarios: }
        Upon labeling and capturing the correlation between market conditions and agent variables, 
        the calibration is able to hypothesize more market scenarios by changing (either interpolating or extrapolating) market conditions. 
        
\end{itemize}

% Figure environment removed 

% System overview
We propose \sysname{}, the first {\bf ca}libration {\bf l}earning approach for {\bf m}ulti-{\bf a}gent market {\bf s}imulation. 
As shown in Figure~\ref{fig: system_diagram}, 
\sysname{} extracts deep features from realistic order flow using an order-flow embedding module 
and fine-tunes the deep feature to estimate agent variables based on a condition-aware variable estimator. 
The whole system learns from a novel surrogate-trading loss function in the training stage. 

The novelties of this paper are as follows: 
\begin{itemize}% [leftmargin=*]
    \item \emph{Surrogate-trading loss function to reduce training requirement of calibration learning: }
            % Problem
        The learning approach is search-free in calibration, though, 
        the training data are nontrivial to obtain. 
            % Challenge
        One intuitive method is learning from search results of traditional approaches, 
        which however can be very inefficient. 
            % Approach
        To tackle this, we propose a surrogate-trading loss function. 
        which reparameterizes the simulation system as a surrogate and 
        supervises the calibration learning with high data efficiency. 
    
    \item \emph{Condition-aware variable estimator to annotate agent variables based on market-condition consistency: }
            % Problem
        To make simulation results more interpretable, 
        we maintain variable consistency under similar market conditions, 
        which mirrors the reality of similar behaviors of real traders under similar market conditions.  
            % Challenge
        This is challenging because the variable consistency may trade off accuracy in reproducing order flows. 
            % Approach
        To address this, we propose a condition-aware variable estimator that regards market condition as the prior knowledge of agent variable, 
        which only fine-tunes the variables without compromising reproducing accuracy.         
        
    \item \emph{Large-scale experiments to validate \sysname{}: } 
        We have validated \sysname{} based on orderbook-level data on a stock over a year 
        and compared it with previous search-based calibration approaches. 
        \sysname{} has achieved satisfied reproducing accuracy (less than 0.36 in KS statistics) without variable searching. 
        Additionally, it calibrates the agent variables by capturing a reasonable correlation with multiple indexes of market conditions, 
        specifically the PPI, PMI, CPI, market trend, and noise.         
\end{itemize}

The remainder of the paper is organized as follows. 
We first introduce the preliminaries of multi-agent market simulation in Section~\ref{sec: preliminary}. 
Then, we discuss the technical designs of \sysname{} in Section~\ref{sec: method}. 
We represent illustrative experimental results in Section~\ref{sec: exp} and overview related work in Section~\ref{sec: related_work}. 
Finally, we conclude in Section~\ref{sec: conclude}.

\fi