\section{Experiments}\label{sec: exp}

% Figure environment removed

In this section, we discuss the experimental evaluation of \sysname{}.  
We introduce the experimental setting in Section~\ref{subsec: exp_set} , 
the verification of simulation accuracy in Section~\ref{subsec: exp_result}
and the case studies on market condition in Section~\ref{subsec: exp_case}.

\subsection{Experimental Setting}\label{subsec: exp_set}

We implemented \sysname{} based on the multi-agent market model introduced in Section~\ref{sec: preliminary}. 
The experiments are conducted on real trading data at the orderbook-level from the A-share market over the whole year of 2020 (254 days in total),  
using five-fold cross-validation. 
To verify the simulation accuracy, 
we measure the discrepancy between the target order book and the generated order book, denoted as $x$ and $\hat{x}$ respectively, using the following metrics: 
\begin{itemize}%[leftmargin=*]
    \item \emph{Mid-price deviation} measures the mean difference of mid-price between the generated order flows and the target flows over a trading day, which is calculated as
    \begin{equation}
        D_P=\frac{1}{T}\sum_{t=1}^T \frac{\left|P_t-\hat{P}_t\right|}{P_t}.  
    \end{equation}
    In the experiment, we discretize a trading day by milliseconds of $T$ steps. 
    
    \item \emph{Discrepancy of order-book shape} quantifies the difference between the predicted and target order books over a trading day. 
    We measures the discrepancy by Kolmogorov-Smirnov (KS) statistic~\cite{bai2022efficient}, which is calculated as
    \begin{equation}
        D_Q=\frac{1}{T}\sum_{t=1}^T \sup_p |\operatorname{CDF}_{Q_t}(p)-\operatorname{CDF}_{\hat{Q}_t}(p)|,
    \end{equation}
    where $\operatorname{CDF}(\cdot)$ calculates the cumulative density function of the volume of orders over the prices at each time step. 
    In the experiment, we set the significant level of KS statistic as $\alpha=0.1$, which leads to the critical value to be $0.36$. 
    In other words, $D_Q<0.36$ would be regarded as an insignificant difference between generated and target order books. 
\end{itemize}

We compare \sysname{} with the following search-based calibration approaches:
\begin{itemize}[leftmargin=*]
    \item \emph{Random search (Rand)~\cite{cao2022dslob}} is widely adopted for calibrating multi-agent market model due to its simplicity. 
    It randomly samples the variable space, 
    and the variables with the least simulation error would be selected.  
    \item \emph{Heuristic search (Bayesian)~\cite{bai2022efficient}} 
    considers searching efficiency by applying Bayesian optimization to search for the agent variable. 
    The searched variable of each iteration is based on the previous search results of the trading day, 
    and the variable of the last searching will be selected. 
\end{itemize}

To validate the condition-aware variable estimator, 
we fine-tune the calibration model based on the data from real trading day to correlate the agent variable with multiple indexes of market conditions. 
To verify the estimator, 
we measure the Pearson correlation coefficient between each element of the agent variable, denoted as $a_m$, and the index of market condition, which is given as \begin{equation}
    \rho_{(a_m,s)}=\frac{\mathbb{E}\left[(a_m-\mu_{a_m})(s-\mu_s)\right]}{\sigma_{a_m} \sigma_s}. 
\end{equation} 
We verify the estimator by conducting several case studies on PPI, PMI, CPI, market trend and market noise. 
These indexes are publicly available~\cite{AKShareZhaiQuanShuJuAKShare}. 

In the experiment, we learn the surrogate model from simulation data uniformly sampled from the variable spaces and evaluate it on the real trading data.  
Unless particularly specified, we employ three fully-connected layers for the modules mentioned in Section~\ref{sec: method}. 
The whole system is optimized by Adam optimizer, and we empirically set $\alpha=0.1$ in Equation~(\ref{eq: all_loss}). 
To reduce randomness, we estimate the agent variables using the expectation of the variable distribution and 
repeat each experiment five times to report the average result. 

\input{Sections/exp_result.tex}


 % Figure environment removed

  % Figure environment removed

 \begin{table}
    \centering
        \caption{Correlation coefficients between market-condition indexes and the elements of the agent variable. }
    \begin{tabular}{c|ccccc}
        \hline
         ~     & $a_w$   & $a_c$ & $a_n$ & $a_\beta$ & $a_\tau$  \\
         \hline
        CPI      & {\bf 0.17}    & 0.13   & -0.12    & {\bf 0.15} & 0.14 \\
        % \hline
        PPI       &    {\bf -0.12}    & 0.14   & 0.11     &  {\bf -0.13} & 0.16 \\
        % \hline
        PMI        &  -0.12    &  {\bf 0.16}   &  -0.15    & -0.15 & {\bf 0.15}  \\
        % \hline
        Market Trend & {\bf -0.15}    & {\bf 0.17}   & {\bf -0.14}    & {\bf -0.19}  & 0.14 \\
        % \hline
        Market Noise  & {\bf 0.13}    & {\bf -0.13}   & {\bf 0.12}    & {\bf 0.17}  & 0.12 \\
        \hline
\end{tabular}
    \label{tab: correlation}
\end{table}

% \subsection{Illustrative Results}\label{subsec: result}
\subsection{Verification of simulation accuracy}\label{subsec: exp_result}

% \noindent
% {\bf : }
% What is this?
Figure~\ref{fig: exp_result} demonstrates an example of market simulation by showing the simulated mid-price of the half of a trading day. 
% Facts
From the figure, the simulated mid-price fluctuates over the fundamental value, 
which is updated every ten minutes. 
% Opinion
The mid-price tracks the fundamental value due to the proportions of fundamentalist of the agents.  
The mid-price deviation from the fundamental value is caused by the components of chartist and irrational trader in the simulation system.
This has successfully simulated the price fluctuation as in the realistic stock markets. 

% 
To learn the surrogate model of \sysname{}, 
we conduct 150 simulations with random sampled agent variables in total. 
Figure~\ref{fig: exp_num_ks} shows how the number of simulations averagely varies with the simulation accuracy (in terms of KS statistic). 
% 
From the figure, the KS statistic knee down and goes below the critical value after around 130 simulations, 
which is the minimal number of simulations required. 
%
This has validated the effectiveness of the surrogate-trading loss function in learning calibration with high data efficiency. 

% 
Figure~\ref{fig: exp_comp_price} compares \sysname{} with the other schemes, showing their simulation accuracy with different numbers of iterations. 
% 
From the figure, \sysname{} has a constant accuracy as it does not require any searching process. 
Bayesian optimization shows a faster convergence than random search, as it is heuristic.  
\sysname{} performs comparably with the Bayesian optimization of ten iterations of search, without the variable searching process. 
% 
This has demonstrated the feasibility of the search-free calibration using \sysname{}. 

% 
Figure~\ref{fig: exp_comp_order} compares with the schemes in terms of the shape of order book in KS statistic. 
%
The figure shows a similar result with the price deviation. 
From the figure, random search reaches to the critical value in ten iterations of search;
and, Bayesian optimization averagely achieves KS statistics lower than the critical value with six iterations. 
\sysname{} shows similar performance to the Bayesian optimization (at ten iterations) without any searching process, 
%
which has validated that \sysname{} can achieve satisfied reproducing accuracy without variable searching. 

% 
Figure~\ref{fig: exp_cdf_book} shows the KS statistic distribution of the trading days over a year. 
% 
From the figure, \sysname{} can successfully calibrate for most trading days (over 90\%) lower than the critical value of 0.36. 
% 
This has validated the generality of the calibration on the variety of trading days. 

% \noindent
% {\bf Correlation with market conditions: }
\subsection{Case studies on market condition}\label{subsec: exp_case}
% 
Figure~\ref{fig: exp_k_ks} shows how the simulation accuracy in KS statistic varies with the parameter $k$ as in Equation~\ref{eq: convolution},
where $k$ determines the range of the uniform distribution. 
In other words, a large $k$ indicates higher correlation. 
% 
The figure shows a trade-off in simulation accuracy ranging out of $k\leq1.2$,  
where the simulation accuracy of the agent variable might be unsatisfactory (when the KS statistic are larger than the critical value). 
% 
Despite so, the large safety range of $k$ indicates a large set of agent variables as candidates, 
which enables fine-tuning the variables without compromising simulation accuracy. 

% 
Figure~\ref{fig: exp_k_coef} shows the influence of $k$ on the correlation coefficient, 
using the variable of chartist component and market trend as an example. 
% 
From the figure, the correlation increases with the weight $k$ 
since the agent variables are clustered in the fine-tuning process.  
% 
This has validated that the market-condition loss function can capture their correlation and make the simulation results more explainable (the explainability will be discussed later). 
To optimize the correlation without compromising the simulation accuracy, we set $k=0.8$ in the experiment. 

% 
Figure~\ref{fig: exp_scheme_coef} compares \sysname{} with the comparison schemes 
regarding the correlation coefficients between the calibrated chartist component and market trend on trading data over the year. 
% 
From the figure, the calibrated chartist components from both comparison schemes are closely independent of the market trend, 
while the coefficient of \sysname{} shows a significant correlation because of the market-condition loss function. 
% 
Specifically, the loss function is designed to cluster the agent variables based on the market conditions, 
thus ensuring consistency and correlation between the two factors. 

% 
As an example of interpreting the calibration,  
we experiment \sysname{} with multiple indexes of market conditions.
The correlation coefficients are shown in Table~\ref{tab: correlation}. 
With a higher CPI, the calibration will increase the number of fundamentalists and the risk aversion of the whole market. 
This mirrors the reality that a high CPI indicates a high uncertainty in the market. 
Also, a high PMI indicates an optimistic and promising market, which is reflected by the increasing chartist and the longer investor horizon. 
Similarly, 
a clear market trend leads to more chartists and less irrational traders due to the consistent opinions in the market, 
and the market noise conversely. 

% 
Finally, we discuss a failure case of the calibration based on PPI, whose high value is supposed to indicate the high uncertainty in a real market, 
while \sysname{} negatively correlates it with the component of fundamentalist and risk aversion. 
This is because the correlation is formed in the direction of reproducing order flows easily.
In other words, \sysname{} does not assume the direction of the correlation, 
rather, it depends on the hyper-parameter of the simulation system,  
i.e. the types of agents, their variables, the characteristics of the asset, etc. 
Therefore, such a failure case may imply a misfit of the chosen indexes, 
which makes the simulation results more explainable. 
