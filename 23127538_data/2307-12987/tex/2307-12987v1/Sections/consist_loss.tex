\subsection{Consistency Loss}\label{sec: consist_loss}

% Why consistency loss: reproduction loss is not sufficient
As mentioned in Section~\ref{sec: intro}, 
due to the randomness and dynamics of the multi-agent simulation system, 
more than one set of behavior parameters can contribute to similar order streams.
which means reproduction is not enough to indicate high fidelity.
% As identified in~\cite{bai2022efficient},
% due to the system dynamics and randomness of the multi-agent systems,
% it is possible that more than one set of behavior parameters can generate similar order streams. 
In order words, Equation~\ref{eq: s_obj2} is not sufficient to indicate Equation~\ref{eq: s_obj1}.
% In other words,
% An optimality can lead to similar order streams;
% but generating similar order streams to target does not have to indicate high fidelity.

% What is better
We select the candidates by introducing some patterns in the real market, 
which potentially pushes the simulation one step further toward high fidelity.
Specifically, 
we observe that the behaviors are usually dependent over time:
\begin{itemize}
    \item 
    Without a striking intervention, 
    the overall behaviors of the market usually vary smoothly and continuously,
    which we call \emph{temporal consistency};
    % Participants in the market usually do not drastically change their behaviors. 
    % Thus, we hope the behaviors over time units vary minimum and smoothly, which we call \emph{temporal consistency};
    \item 
    Similar market states usually indicate similar trading environments. Thus, the overall behaviors
    of the market participants should be similar under close
    market states, which we called \emph{market state consistency}.
\end{itemize}
% These two observations reflect patterns in real markets. Thus,
% calibration complying with these two observations  can push the multi-agent simulation system 
% one step further toward high fidelity.

% what temporal loss
The end-to-end structure of the meta-market makes it easy to enforce temporal consistency:
over a period of $T$ time units, 
the meta-market should find behavior vectors so that
\begin{equation}
\min_{\theta_1, \omega}\ \sum_{t=1}^{T-1} \left\lVert \hat{b_t}-\hat{b}_{t+1} \right\rVert_n,
\label{eq: temp_obj}
\end{equation}
where the estimation is produced by the meta-market $\hat{b_t}=K(u_t, x_t)$, parameterized by $\theta_1$ and $\omega$.
This leads to our proposed temporal consistency loss 
\begin{equation}
L_{temp}= \sum_{t=1}^{T-1} \left\lVert K(u_t, x_t)-K(u_{t+1},x_{t+1}) \right\rVert_n.
\label{eq: temp_loss}
\end{equation}

% market state loss
The market state consistency is more tricky to consider 
because it requires other factors to remain unchanged,
which is hard to determine and find such perfect matches.
We consider this issue by a contrastive hypothesis scheme --
for each time unit, 
we fabricate its market states by hypothesis 
and permute the resultant behaviors over the hypothesized data.
This leads to our objective function on the market state consistency over the $t^{th} unit$, i.e.,
\begin{equation}
\min_{\omega}\ sim\left(u_t^{(\alpha)}, u_t^{(\beta)} \right)\left\lVert K\left(u_t^{(\alpha)}, x_t\right)-K\left(u_t^{(\beta)}, x_t\right) \right\rVert_n,
\label{eq: state_obj}
\end{equation}
where the $u_t^{(\alpha)}$ and $u_t^{(\beta)}$ are two fabricated market states on the $t^{th}$ time unit 
and the $sim(\cdot)$ denotes the similarity of two market states.
Note that we should only optimize the market state analyzer~(as shown in Figure~\ref{fig: meta_design}) using the objective 
because this helps with the generalization upon the model level.

We enforce the objective in Equation~\ref{eq: state_obj} by a market state consistency loss function based on triplet loss
\begin{equation}
L_{stat} =  \max
\left\{
\left\lVert \hat{b}_t-\hat{b}_t^{(\alpha)} \right\rVert_n - \left\lVert \hat{b}_t-\hat{b}_t^{(\beta)} \right\rVert_n + \sigma 
, 0\right\},
\label{eq: state_loss}
\end{equation}
where $sim\left(u_t, u_t^{(\alpha)}\right) > sim\left(u_t, u_t^{(\beta)}\right)$ and the $\sigma$ denotes a contrastive margin.
In this way, the market state consistency loss function encourages the 
behavior estimations to be similar under similar market states with other factors unchanged.

Besides, such a hypothesis scheme not only calibrates but also enables us to conduct a market hypothesis -- 
the market state consistency loss function interpolates market states of the model inputs, 
which allows us to modify the market states on real trading days to see how the order streams change accordingly. 

Overall, the meta-market is trained by a composite loss function
\begin{equation}
L=L_{repr} + w_{t}L_{temp} + w_{s}L_{stat},
\label{eq: loss_overall}
\end{equation}
where the two coefficients $w_{t}$ and $w_{s}$ weigh the two consistency loss.

\iffalse 
$sgn\left( \frac{sim\left(u_t, u_t^{(\alpha)}\right)}{sim\left(u_t, u_t^{(\beta)}\right)}<1 \right)$
\fi