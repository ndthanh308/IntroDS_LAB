\documentclass[journal=jctc,manuscript=article,layout=twocolumn]{achemso}
\usepackage{amsmath}
\usepackage{graphicx}
\usepackage{tikz,multirow,tabularx}
\usetikzlibrary{arrows.meta}
\usepackage{footmisc}
\usepackage{booktabs, afterpage}
\usepackage{algorithm}
\usepackage{algorithmic}
\newcommand{\ccaddition}{\Huge{\textbf{+}}}
\newcommand{\Nwalkers}{N_{\mathrm{repl}}} % number of replicas
\newcommand{\Nopt}{N_{\mathrm{opt}}} % number of molecules undergoing stochastic minimization
\newcommand{\Cinf}{C^{\infty}} % the ``infinitely convex function''
\newcommand{\Vb}{V_{\mathrm{bias}}} % biasing potential used for ``real temperature'' replicas
\newcommand{\biasprop}{\alpha_{b}} % proportionality coefficient for the biasing potential
\newcommand{\JAN}[1]{\textrm{\textcolor{blue}{JAN: #1}}}
\newcommand{\GUIDO}[1]{\textrm{\textcolor{green}{Guido: #1}}}
\newcommand{\KONSTANTIN}[1]{\textcolor{red}{KONSTANTIN: #1}}
\newcommand{\Nmorfconf}{N_{\mathrm{conf}}}
\newcommand{\Nrepeat}{N_{\mathrm{repeat}}}
\newcommand{\rcut}{\rho_{\mathrm{cut}}}
\newcommand{\wb}{w_{B}} % Boltzmann weights generated by MMFF94.
\newcommand{\wbc}{\tilde{w}_{B}} % cut Boltzmann weights used in the averaging.
\usepackage{dcolumn}
\newcommand{\alignedmultrow}[3]{\multirow{#1}{*}{
\begin{tabular}{D{,}{}{#2}}
    #3
\end{tabular}}}
\newcommand{\resstructarr}[2]{\draw [stealth-stealth, line width=0.6mm] (#1) -- (#2)}
\newcommand{\resstructarroneway}[2]{\draw [-stealth, line width=0.6mm] (#1) -- (#2)}
\newcommand{\mutarrend}{Triangle[blue,fill=blue,scale=.5]}
\newcommand{\mutrevarr}[2]{\draw [blue, arrows={\mutarrend-\mutarrend}, line width=1.5mm] (#1) -- (#2)}
\newcommand{\mutarr}[2]{\draw [blue, arrows={-\mutarrend}, line width=1.5mm] (#1) -- (#2)}
\usepackage{enumitem}
\newcommand{\mutationlabel}[1]{M#1}
% For minimized quantities.
\newcommand{\dipole}{D}
\newcommand{\dEsolv}{\Delta G_{\mathrm{solv}}}
\newcommand{\gap}{\Delta \epsilon}
\newcommand{\Pacc}{P_{\mathrm{acc}}}
\newcommand{\Pprop}{P_{\mathrm{prop}}}
 \usepackage{hyperref}
% Make a two-row cell.
% Command introduced because I kept forgetting the syntax
\newcommand{\tworowcell}[2]{\begin{tabular}{@{}c@{}}#1 \\ #2\end{tabular}}


% Notation used in the tables.
\newcommand{\tpreq}{N^{\mathrm{comp}}_{\mathrm{req}}} % number of chemical graphs considered until best compound is found
\newcommand{\tottp}{N^{\mathrm{comp}}_{\mathrm{tot}}} % number of chemical graphs considered during a simulation in total 
\newcommand{\beststepfound}{N^{\mathrm{step}}_{\mathrm{req}}} % number of Monte Carlo steps done before the best candidate is found
\newcommand{\cheapquantnoise}{\Delta_{\mathrm{cheap}}^{\mathrm{converged}}}

\newcommand{\candidate}[2]{$\mathrm{C}_{#1}^{\mathrm{#2}}$}

\newcommand{\mutationfigureblock}[4]{
\vspace{#3ex}

\hspace{0.0ex}\begin{tikzpicture}
        \node[anchor=south west,inner sep=0] (image) at (0.55,0) {% Figure removed};
        \node[anchor=south west,inner sep=0] (image) at (5.45,0) {% Figure removed};
        \mutrevarr{4.1,1.1}{5.4,1.1};
%    \node at (0,3.4) {\Large{(\mutationlabel{#1})}}
\end{tikzpicture}
\vspace{-#2ex}
\begin{itemize}
\item[\textbf{\mutationlabel{#1}:}] #4
\end{itemize}
}

\newcommand{\resstructexblock}[2]{
\hspace{-3.0ex}

\begin{tikzpicture}
        \node[anchor=south west,inner sep=0] (image) at (0.0,0) {% Figure removed};
        \node[anchor=south west,inner sep=0] (image) at (4.5,0) {% Figure removed};
        \resstructarr{3.7,1.3}{4.7,1.3};
        \node at (-0.2,1.7) {(#2)};
\end{tikzpicture}


}


% for rotation next to multirow
\newcommand{\STAB}[1]{\begin{tabular}{@{}c@{}}#1\end{tabular}}

\SectionNumbersOn


\title{Evolutionary Monte Carlo of QM properties in chemical space: Electrolyte design}

\author{Konstantin Karandashev}
\email{konstantin.karandashev@univie.ac.at}
\affiliation{University of Vienna, Faculty of Physics, Kolingasse 14-16, AT-1090 Wien, Austria}
\author{Jan Weinreich}
\affiliation{University of Vienna, Faculty of Physics, Kolingasse 14-16, AT-1090 Wien, Austria}
\author{Stefan Heinen}
\affiliation{Vector Institute for Artificial Intelligence, Toronto, ON, M5S 1M1, Canada}
\author{Daniel Jose Arismendi Arrieta}
\affiliation{Department of Chemistry-{\AA}ngstr\"om Laboratory, Uppsala University, Box 538, SE-75121 Uppsala, Sweden}
\author{Guido Falk von Rudorff}
\affiliation{University Kassel, Department of Chemistry, Heinrich-Plett-Str.40, 34132 Kassel, Germany}
\alsoaffiliation{Center for Interdisciplinary Nanostructure Science and Technology (CINSaT), Heinrich-Plett-Straße 40, 34132 Kassel}
\author{Kersti Hermansson}
\affiliation{Department of Chemistry-{\AA}ngstr\"om Laboratory, Uppsala University, Box 538, SE-75121 Uppsala, Sweden}
\author{O. Anatole von Lilienfeld}
\affiliation{Vector Institute for Artificial Intelligence, Toronto, ON, M5S 1M1, Canada}
\alsoaffiliation{Departments of Chemistry, Materials Science and Engineering, and Physics, University of Toronto, St. George Campus, Toronto, ON, Canada}
\alsoaffiliation{Machine Learning Group, Technische Universit\"at Berlin and Institute for the Foundations of Learning and Data, 10587 Berlin, Germany}

\begin{tocentry}
% Figure removed
\end{tocentry}

\begin{document}

\begin{abstract}
Optimizing a target function over the space of organic molecules is an important problem appearing in many fields of applied science, but also a very difficult one due to the vast number of possible molecular systems. We propose an Evolutionary Monte Carlo algorithm for solving such problems which is capable of straightforwardly tuning both exploration and exploitation characteristics of an optimization procedure while retaining favourable properties of genetic algorithms.  The method, dubbed MOSAiCS (\textbf{M}etropolis \textbf{O}ptimization by \textbf{S}ampling \textbf{A}daptively \textbf{i}n \textbf{C}hemical \textbf{S}pace), is tested on problems related to optimizing components of battery electrolytes, namely minimizing solvation energy in water or maximizing dipole moment while enforcing a lower bound on the HOMO-LUMO gap; optimization was done over sets of molecular graphs inspired by QM9 and Electrolyte Genome Project (EGP) datasets. MOSAiCS reliably generated molecular candidates with good target quantity values, which were in most cases better than the ones found in QM9 or EGP. While the optimization results presented in this work sometimes required up to $10^{6}$ QM calculations and were thus only feasible thanks to computationally efficient \emph{ab initio} approximations of properties of interest, we discuss possible strategies for accelerating MOSAiCS using machine learning approaches.
\end{abstract}

\maketitle


\section{Introduction}
\label{sec:introduction}

Increasing efficiency and longevity of energy storage systems is critical for improving economic sustainability of lowering greenhouse gas emissions.\cite{Jafari_Apurba:2022} One aspect of this problem is searching chemical compound space for organic molecules optimal for a target application, such as lithium battery electrolyte component\cite{Korth:2014,Cheng_Curtiss:2015,Borodin_Knap:2015,Qu_Persson:2015,Lian_Wu:2019} or electroactive molecules for redox flow batteries.\cite{Agarwal_Assary:2021,Sorkun_Er:2022} In this work we focused on the former, more specifically on finding electrochemically stable organic molecules that are good solvents for alkali salts. While such searches can be aided with high-throughput screening,\cite{Korth:2014,Cheng_Curtiss:2015,Borodin_Knap:2015} there has been a surge of ways to go beyond by increasing efficiency of compound property evaluations, \emph{e.g.} with machine learning\cite{Huang_Lilienfeld:2023} or quantum alchemy,\cite{Chang_Lilienfeld:2018,Griego_Keith:2021,Eikey_Keith:2022} and by sampling chemical space more efficiently. In the context of optimizing small organic molecules, most methods of the latter category can be classified as those based on Markov decision processes,\cite{You_Leskovec:2018,Zhou_Riley:2019,Stahl_Bostrom:2019,Khemchandani_Kell:2020,Horwood_Noutahi:2020,Pereira_Arrais:2021} recurrent neural networks,\cite{Gupta_Schneider:2018,Popova_Isayev:2019} genetic algorithms,\cite{Globus_Wipke:1999,Brown_Gasteiger:2004,Virshup_Beratan:2013,Jensen:2019,Nigam_Aspuru-Guzik:2022,Laplaza_Corminboeuf:2022} and variational autoencoders.\cite{Gomez-Bombarelli_Aspuru-Guzik:2018,Oliveira_Quiles:2022} 


While several variants of Markov chain Monte Carlo\cite{Levin_Peres:2017} sampling have also been applied to molecule optimization problems,\cite{Fu_Sun:2021,Xie_Lei:2021} one intriguing variant, namely Evolutionary Monte Carlo,\cite{Liang_Wong:2000,Hu_Tsui:2010,Spezia:2020} has been overlooked so far. The approach combines two philosophies that have demonstrated reliable performance for a range of optimization problems: parallel tempering\cite{Hukushima_Nemoto:1996,Sambridge:2014,Angelini_Ricci-Tersenghi:2019} and genetic algorithms.\cite{Holland:1975,Johannesson_Norskov:2002,Sharma_Balint-Kurti:2010} As illustrated in Figure~\ref{fig:workflow_illustration}, Evolutionary Monte Carlo involves running several Markov chain Monte Carlo simulations that focus on \emph{exploitation} (\emph{i.e.} refining already known molecules via incremental changes) or \emph{exploration} (\emph{i.e.} finding promising regions of chemical space), which interact by swapping configurations analogously to parallel tempering or by creating ``child configurations'' similarly to genetic algorithms in a way that observes detailed balance condition.\cite{Hastings:1970} As is the case for genetic algorithms, increasing the number of replicas yields more opportunities for creating "child configurations," thus accelerating exploration of chemical space. Unlike genetic algorithms though, Evolutionary Monte Carlo allows straightforward control of its exploration and exploitation aspects while guaranteeing to \emph{eventually} find the global minimum due to the properties of Markov chain Monte Carlo. Evolutionary Monte Carlo can also potentially be combined with nested Monte Carlo techniques\cite{Iftimie_Schofield:2000,Gelb:2003,Jadrich_Leiding:2020} to utilize multiple optimized quantity evaluation methods at once, \emph{e.g.} when laboratory experiments are used alongside theoretical and machine learning approaches,\cite{Zhang_Henkelman:2013,Anderson_Crooks:2015,Shields_Doyle:2021,Park_Jung:2023} an advantage particularly relevant for high-throughput automated laboratory workflows.\cite{Rahmanian_Stein:2022,Stein_Schroeder:2022,Manzano_Cronin:2022,Park_Jung:2023}


% Figure environment removed

With these reasons in mind, we implemented an Evolutionary Monte Carlo algorithm inspired by a family of genetic algorithms for optimization in the space of molecular graphs.\cite{Globus_Wipke:1999,Brown_Gasteiger:2004,Virshup_Beratan:2013,Jensen:2019} While some recently proposed methods for molecular optimization operate in string representations,\cite{Gupta_Schneider:2018,Pereira_Arrais:2021,Nigam_Aspuru-Guzik:2021,Nigam_Aspuru-Guzik:2022,Born_Manica:2023} we performed all procedures directly on chemical graphs to facilitate ensuring validity of generated molecules and maintaining detailed balance, as well as provide a more direct connection between the molecules considered and graph-based representations that have proven efficient in machine learning applications.\cite{Lemm_Lilienfeld:2021,Weinreich_Lilienfeld:2022} Lastly, we implemented a simple Wang-Landau biasing potential\cite{Wang_Landau:2001} as a \emph{curiosity reward}\cite{Thiede_Aspuru-Guzik:2022} increasing exploration aspect of the algorithm by ``pushing'' our Markov chain Monte Carlo simulations out of previously occupied graphs. The resulting method is named MOSAiCS (\textbf{M}etropolis \textbf{O}ptimization by \textbf{S}ampling \textbf{A}daptively \textbf{i}n \textbf{C}hemical \textbf{S}pace). While we were mainly designing our approach with battery applications in mind, we think it should be useful for other molecular optimization problems, such as those arising in drug design.\cite{Gupta_Schneider:2018,Reker:2019,Stahl_Bostrom:2019,Xie_Lei:2021,Horwood_Noutahi:2020, Fu_Sun:2022,Carter_Jorgensen:2023}

The rest of the paper is organized as follows. Section~\ref{sec:theory} presents the main ideas behind our approach in Subsecs.~\ref{subsec:base_definitions}-\ref{subsec:Monte_Carlo_moves}, following up with description of the optimization problem on which we test it in Subsec.~\ref{subsec:minfunc_choice} and details of our Monte Carlo simulations in Subsec.~\ref{subsec:target_min_comp_details}. Section~\ref{sec:experiment} discusses our experimental results, Section~\ref{sec:conclusions_outlook} concludes the paper with a results summary and outline of possible strategies to improve our approach. Some technical details of our method's implementation, experimental setup, and results were left for Supporting Information.


\section{Theory}
\label{sec:theory}

\subsection{Chemical space definition}
\label{subsec:base_definitions}

We aim to minimize a loss function $F$ over a set of molecules, the latter represented by their \emph{chemical graphs}. We define a chemical graph as an undirected graph whose \emph{nodes} correspond to heavy atoms, along with, where present, hydrogen atoms covalently connected to them, and whose \emph{edges} connect a pair of nodes if their heavy atoms share a covalent bond. For a chemical graph we also define a \emph{resonance structure} as a set of \emph{valences} of nodes' heavy atoms and \emph{orders of covalent bonds} connecting these heavy atoms, both quantities taking integer values. The sum of covalent bond orders connecting a heavy atom to other atoms equals its valence, with the orders of bonds between a heavy atom and a hydrogen atom counted as one. Valence numbers are chosen to be chemically reasonable (\emph{e.g.} IV for C, II, or IV, or VI for S) and we require their sum to be the minimum needed to build a set of covalent bond orders. We also forbid a covalent bond order to be larger than three. The reasons for not including valences and bond orders in the definition of a chemical graph, but rather enumerating their possible values separately, are illustrated in Figure~\ref{fig:resonance_structure_examples} demonstrating examples of molecules for which several resonance structures differing in bond orders or bond orders and heavy atom valences can be defined. We emphasize that while this definition of bond orders and valences is loosely based on valence structure theory, it was designed not to reflect actual electronic structure of a molecule, but to allow convenient definitions of changes of chemical graphs that are illustrated in Figures~\ref{fig:elementary_mutations} and~\ref{fig:cross_coupling_moves}, as will be discussed in detail in Subsec.~\ref{subsec:Monte_Carlo_moves}.


Our definition of chemical graph \emph{a priori} prevents us from differentiating between conformers or stereoisomers and we will assume our optimization problem to be unaffected by this, \emph{e.g.} if for a given chemical graph we are interested only in the most stable stereoisomer and we optimize a Boltzmann average. We also did not implement support for molecules where valid Lewis structures can only be generated by assigning charges to atoms, \emph{e.g.} compounds with nitro groups, hence they were ignored during all calculations done in this work.

 % Figure environment removed


\subsection{Monte Carlo sampling}
\label{subsec:extended_ensemble}

We perform optimization by running a Markov chain Monte Carlo simulation (referred to as just ``simulation'' from now on) of unnormalized probability density similar to the one used for parallel tempering
\begin{equation}
    \begin{split}
    P(\mathbf{X})= &  \exp\left\{-\sum_{i=1}^{\Nopt}\Cinf\left[F\left(X^{(i)}\right)\right] \right. \\ &\left.-\sum_{i=\Nopt+1}^{\Nwalkers}\beta^{(i)}\left[F\left(X^{(i)}\right)+\Vb^{(i)}\left(X^{(i)}\right)\right]\right\},
    \end{split}
    \label{eq:sample_prob}
\end{equation}
where $\mathbf{X}$ is a set of $\Nwalkers$ chemical graphs (also referred to as \emph{replicas}) $X^{(i)}$ ($i=1,\ldots,\Nwalkers$), $\beta^{(i)}$ ($i=\Nopt+1,\ldots,\Nwalkers$) are temperature parameters, $\Vb$ is biasing potential, $\Cinf$ is the ``infinitely convex function'' defined to be such that for arbitrary sets of numbers $x^{(j)}$ and $y^{(j)}$ ($j=1,\ldots,\Nopt$)
\begin{equation}
\begin{split}
    \min_{j=1,\ldots,\Nopt}x^{(j)}-\min_{j=1,\ldots,\Nopt}y^{(j)}<0
    \Leftrightarrow\\
    \sum_{j=1}^{\Nopt}\left[\Cinf(x^{(j)})-\Cinf(y^{(j)})\right]\rightarrow+\infty,
\end{split}
\label{eq:Cinf_defined}
\end{equation}
and $\Nopt$ is the number of replicas that, as will become clear later, effectively undergo greedy stochastic minimization and are referred to as \emph{greedy replicas}, with the other replicas, referred to as \emph{exploration replicas}, providing a less restricted exploration of chemical space and preventing greedy replicas from getting stuck in a local minimum of $F$. The history-dependent biasing potential $\Vb^{(i)}$ is defined as\cite{Wang_Landau:2001}
\begin{equation}
    \Vb^{(i)}\left(X\right)=\frac{\biasprop}{\beta^{(i)}}\sum_{j=\Nopt+1}^{\Nwalkers}\rho^{(j)}(X),
    \label{eq:biasing_potential}
\end{equation}
where $\rho^{(j)}(X)$ is the number of times $X$ has been visited during the simulation by replica with index $j$ (details on how it was evaluated are left for Subsec.~\ref{subsec:target_min_comp_details}), $\biasprop$ is the user-defined bias proportionality coefficient. Setting a non-zero $\biasprop$ makes sampling $\mathbf{X}$ non-Markovian; as a result our certainty that in this regime a global minimum of $F$ w.r.t. $X$ is eventually found is based not on properties of Markov chain Monte Carlo, but on heuristic expectation that the biasing potential would make probability distribution of each exploration replica approach uniformity, leading to at least one replica coming across the global minimum over a finite number of simulation steps.


\subsection{Monte Carlo moves}
\label{subsec:Monte_Carlo_moves}

A simulation consists of taking a sequence of \emph{moves} in a way outlined in Algorithm~\ref{alg:MC_outline}. If the current set of replicas is in configuration $\mathbf{X}_{1}$, a move involves randomly generating parameters $\mathbf{w}$ of a change and deciding to replace $\mathbf{X}_{1}$ with the change's outcome (or \emph{trial configuration}) $\mathbf{X}_{2}$ with an acceptance probability similar to the standard Metropolis-Hastings expression\cite{Hastings:1970}
\begin{equation}
\begin{split}
    \Pacc\left(\mathbf{X}_{1},\mathbf{w},\mathbf{X}_{2}\right)=&\mathrm{min}\left[1,
    \vphantom{\frac{\Pprop\left(\mathbf{X}_{\mathrm{2}},\mathbf{w}^{-1}\right)P\left(\mathbf{X}_{2}\right)}
    {\Pprop(\mathbf{X}_{1},\mathbf{w})P\left(\mathbf{X}_{1}\right)}}\right.\\
    &\left.\frac{\Pprop(\mathbf{X}_{1},\mathbf{w})P\left(\mathbf{X}_{2}\right)}
    {\Pprop\left(\mathbf{X}_{\mathrm{2}},\mathbf{w}^{-1}\right)P\left(\mathbf{X}_{1}\right)}\right],
\end{split}
    \label{eq:acceptance_probability}
\end{equation}
where $\Pprop(\mathbf{X}_{1},\mathbf{w})$ is the probability that $\mathbf{w}$ is proposed given that $\mathbf{X}_{1}$ is the initial configuration and $\mathbf{w}^{-1}$ are parameters of a random change yielding $\mathbf{X}_{1}$ when applied to $\mathbf{X}_{2}$ and corresponding to a unique $\mathbf{w}$. The latter property ensures that detailed balance still holds in situations when several $\mathbf{w}$ yield the same trial configuration $\mathbf{X}_{2}$. Trial configurations decreasing the minimal value of $F$ among greedy replicas compared to initial configurations is accepted automatically due to our definition of $\Cinf$~(\ref{eq:Cinf_defined}). 


\begin{algorithm}
\caption{Sampling $P(\mathbf{X})$~(\ref{eq:sample_prob}).}
\begin{algorithmic} 
\REQUIRE{Initial configuration: $\mathbf{X}_{1}$;}
\LOOP
\STATE{Randomly choose change parameters $\mathbf{w}$;}
\STATE{Use $\mathbf{w}$ on $\mathbf{X}_{1}$ to generate $\mathbf{X}_{2}$;}
\STATE{Randomly sample $r$ from uniform distribution in $[0,1]$;}
\STATE{$r_{\mathrm{acc.}}\leftarrow P_{\mathrm{acc.}}(\mathbf{X}_{1},\mathbf{w},\mathbf{X}_{2})$ (see Eq.~(\ref{eq:acceptance_probability});}
\IF{$r<r_{\mathrm{acc.}}$}
\STATE{$\mathbf{X}_{1}\leftarrow\mathbf{X}_{2}$;}
\ENDIF
\ENDLOOP
\end{algorithmic}
\label{alg:MC_outline}
\end{algorithm}



We use three types of moves to propose the trial configurations $\mathbf{X}_{2}$; we will only discuss the general idea behind them here with implementation details left for Supporting Information. The first type, referred to as \emph{elementary moves}, applies an \emph{elementary mutation} outlined in Figure~\ref{fig:elementary_mutations} to a single replica; such moves correspond to incremental exploration of chemical space. To accelerate greedy optimization of molecules, we additionally introduced the ``no reconsiderations condition'': if change parameters $\mathbf{w}$ corresponding to an elementary move have been rejected for a greedy replica they are not considered again. The second type of moves is \emph{tempering swap} moves that are analogous to the swap moves in conventional parallel tempering techniques and involve randomly choosing replicas with indices $i$ and $j$ in such a way that at least one of them is an exploration replica, considering a swap of the corresponding chemical graphs, and accepting it with acceptance probability~(\ref{eq:acceptance_probability}). These moves allow greedy replicas stuck in a local minimum of $F$ to get to chemical graphs with lower values of $F$ if the latter are discovered by an exploration replica.




% Figure environment removed


The third type of moves are \emph{crossover moves} inspired by the procedure developed in Ref.~\citenum{Globus_Wipke:1999}, which are introduced to allow drastic changes of chemical graphs occupied by replicas. The general idea is illustrated in Figure~\ref{fig:cross_coupling_moves}: a pair of nodes is randomly chosen in two chemical graphs and the neighborhoods of these two nodes are exchanged to create two new chemical graphs. Thus defined crossover moves are more restrictive than the ones of Ref.~\citenum{Globus_Wipke:1999} as they do not allow exchanging fragments of arbitrary shape and connectivity. These restrictions, however, make it straightforward to ensure that the resulting chemical graphs satisfy constraints on the number of nodes, are connected, and correspond to a change for which the $\Pprop(\mathbf{X}_{1},\mathbf{w})/\Pprop(\mathbf{X}_{2},\mathbf{w}^{-1})$ ratio in $\Pacc$~(\ref{eq:acceptance_probability}) can be easily calculated.

 % Figure environment removed


Setting $F$ to be infinitely large for chemical graphs violating certain user-defined constraints is a general way to enforce the latter on the optimization result. However, it is in general preferable to maintain a given constraint as early as during the proposition of trial configuration $\mathbf{X}_{2}$ to increase average acceptance probability and the resulting speed of chemical space exploration. We implemented the corresponding algorithms for maintaining constraints on the number of heavy atoms in a molecule and the kinds of atoms that can share a covalent bond since they are simple to maintain, yet quite important for our applications. Lastly, the question of the moves' sufficiency to access the chemical space and sets of molecules considered in Section~\ref{sec:experiment} in their entirety is discussed in Supporting Information.

\subsection{Minimization problems}
\label{subsec:minfunc_choice}

A good battery electrolyte is a good solvent for lithium salts and is electrochemically stable. We approximated the former property with polarity; maximizing a molecule's polarity was in turn approximated by either maximizing the dipole moment $\dipole$ or minimizing the free energy of solvation in water $\dEsolv$. We approximated the electrochemical stability requirement with a lower bound on the HOMO-LUMO $\gap$, with which we approximated the width of the compound's electrochemical stability window.\cite{Korth:2014} While the latter relation is not actually practical for battery design,\cite{Borodin:2019} we still opted for a $\gap$-based electrochemical stability criterion to connect our work with other compound optimization problems where $\gap$ can be used.\cite{Teunissen_De_Vleeschouwer:2017,De_Lile_Lee:2020} For both $\dipole$ and $\dEsolv$ optimization we constrained the molecules' $\gap$ to be larger than either benzene (\emph{strong $\gap$ constraint}) or octa-1,3,5,7-tetraene (\emph{weak $\gap$ constraint}), resulting in four minimization problems of differing difficulty. While in this work we focused on testing performance of MOSAiCS against these single objective optimization problems, our approach can also be used to optimize several properties at once via a suitable multiobjective loss function.\cite{Fromer_Coley:2023}

We aimed to estimate $\dEsolv$, $\dipole$, and $\gap$ as computationally cheaply as possible while being qualitatively correct over a wide range of chemical compounds; the resulting protocol is explained in detail in Supporting Information. Here we just mention that for a given chemical graph we used the MMFF94 forcefield\cite{Halgren:1996_I,*Halgren:1996_II,*Halgren:1996_III,*Halgren_Nachbar:1996_IV,*Halgren:1996_V,*Halgren:1999_VI,*Halgren:1999_VII} to generate molecular conformers, for which we performed GFN2-xTB\cite{Bannwarth_Grimme:2019} calculations with analytical linearized
Poisson-Boltzmann model\cite{Ehlert_Grimme:2021} simulating presence of water. The root mean square error (RMSE) that is presented for calculated quantities corresponds to statistical error from randomness of conformer generation. We used two sets of parameters for our protocol: ``converged'' that produced reasonable RMSEs for a wide variety of compounds, but was relatively computationally expensive, and ``cheap'' that was used during our simulations. From now on, $\dEsolv$, $\dipole$, and $\gap$ will denote estimates of these quantities obtained with the ``converged'' protocol, while estimates obtained with the ``cheap'' protocol will be marked with addition of ``cheap'' superscript.


Each of the four minimization problems was solved in two sets of molecules based on QM9\cite{Ruddigkeit_Reymond:2012,*Ramakrishnan_Lilienfeld:2014} and the Electrolyte Genome Project\cite{Qu_Persson:2015} (EGP) datasets. The QM9 dataset consists of 134k molecules containing up to 9 heavy atoms (C, O, N, and F). We defined the ``QM9*'' set to consist of molecules (not necessarily in QM9) that also contain up to 9 heavy atoms of the same elements as QM9, but are additionally constrained by not allowing bonds between N, O, and F atoms, as well as O-H and H-F bonds, since these covalent bonds are typically associated with increased chemical reactivity. The EGP dataset was generated with the Materials Project\cite{Jain_Persson:2013} workflows in an effort to facilitate discovery of novel battery electrolyte molecules; the version currently hosted on the Materials Project website contains 24.5k species in total; neutral species for which MMFF94 coordinates could be generated included 19.7k individual chemical graphs containing up to 92 heavy atoms. These characteristics of the EGP dataset were the basis for defining the ``EGP*'' set, whose molecules (not necessarily in EGP) contain up to 15 heavy atoms (B, C, N, O, F, Si, P, S, Cl, and Br, which are elements present in organic molecules of EGP) and, for the sake of chemical stability, do not contain covalent bonds between N, O, F, Cl, and Br, between H and B, O, F, Si, P, S, Cl, or Br, as well as S-S and P-P bonds.

We chose 15 as the maximum number of heavy atoms allowed in EGP* molecules because this size restriction is obeyed by 87.0\% and 97.0\% of EGP's chemical graphs satisfying weak and strong $\gap$ constraints. When choosing which elements can not share a covalent bond in QM9* and EGP* molecules we mainly aimed for excluding weak bonds, although we also forbade some relatively strong bonds whose presence can signify molecular reactivity. Since we only consider molecules whose valid Lewis structures can be generated without assigning charges to atoms, H-F and double O-O bonds can only be encountered in hydrogen fluoride and oxygen, which we excluded from consideration due to their corrosive properties. Creating N-N bonds inside an organic compound risks making it prone to releasing nitrogen on excitation, adding functional groups containing double N-O bonds to a molecule risks making the latter prone to self-oxidation, and hydroxyl groups engage relatively easily in reactions involving oxidation or nucleophilic attacks.\cite{Clayden_Warren:2012} We note that in practice, managing this kind of reactive behavior would require additional use of more sophisticated compound stability measures.

While both QM9* and EGP* are well defined and finite sets of chemical graphs, their huge size makes evaluating any of their properties exactly, \emph{i.e.} through exact enumeration of all their chemical graphs, unfeasible. However, we do summarize properties of intersections of QM9* and QM9, as well as EGP* and EGP, in Supporting Information.



\subsection{Simulation details}
\label{subsec:target_min_comp_details}

During a simulation we used $\gap^{\mathrm{cheap}}$ to estimate whether a molecule satisfies the constraint on $\gap$; dimensionless loss functions corresponding to $\dipole$ and $\dEsolv$ were defined as
\begin{align}
F_{\mathrm{solv.}}(X)=&\frac{\dEsolv^{\mathrm{cheap}}(X)}{\mathrm{STD}_\mathrm{dataset}(\dEsolv)},\label{eq:F_solv}\\
F_{\mathrm{dipole}}(X)=&-\frac{\dipole^{\mathrm{cheap}}(X)}{\mathrm{STD}_\mathrm{dataset}(\dipole)},\label{eq:F_dipole}
\end{align}
where $\mathrm{STD}_\mathrm{dataset}$ refers to standard deviation of a quantity over molecules at the intersection of chemical graph set of interest and the reference dataset (QM9 for QM9* and EGP for EGP*) which satisfy the $\gap$ constraint of interest. We chose 1000 ``pre-final'' molecules exhibiting the smallest value of loss function out of the molecules visited during the simulation and evaluated converged estimates of the quantities of interest for them; the molecule with the best $\dipole$ or $\dEsolv$ value among pre-final molecules satisfying the $\gap$ constraint is the one considered the \emph{candidate} molecule proposed by the simulation. 



We used $\Nwalkers=36$ with $\Nopt=4$ (cf. definitions in Subsection~\ref{subsec:extended_ensemble}); virtual temperature parameters $\beta^{(i)}$ appearing in $P$~(\ref{eq:sample_prob}) were defined in such a way that the smallest and largest $\beta^{(i)}$ were 1 and 8, and the other $\beta^{(i)}$ formed a geometric progression between the two extrema values, the latter being a simple recipe taken from applications of parallel tempering to configuration space sampling.\cite{Rathore_Pablo:2005,Kone_Kofke:2005} A simulation consisted of 50000 ``global'' steps, out of which 60\% were ``simple'' steps applying an elementary move to each replica, 20\% were ``tempering'' steps making tempering swap moves on 128 randomly chosen pairs of replicas, and another 20\% were ``crossover'' steps making  crossover moves on 32 randomly chosen pairs of replicas. $\rho^{(j)}(X)$ appearing in $\Vb^{(i)}$~(\ref{eq:biasing_potential}) was counted as the number of times replica $j$ was found in $X$ after a global step had been completed. For elementary moves we additionally set that: the nodes added or removed during \mutationlabel{1} mutation could be connected to the molecule with bonds of order from 1 to 3; bonds changed with \mutationlabel{2} and \mutationlabel{6} mutations could have their order increased or decreased by 1 and 2 respectively; nodes added or removed with \mutationlabel{5} mutation could be connected to the molecule with bonds of order~1 or~2.

We set $\biasprop$ to $0.0$, $0.2$, or $0.4$; for each of the resulting 12 combinations of $\biasprop$ and optimization problem we ran 8 simulations with different random number generator seeds. For all simulations all replicas initially occupied the chemical graph of methane. While it would be natural to assign each replica a randomly chosen molecule from the intersection of QM9 and QM9* or EGP and EGP*, we went with the intentional handicap of using methane as the starting molecule to demonstrate that MOSAiCS is capable of constructing all the candidate molecules presented in this Section from scratch. The effect of choice of initial conditions on the final result is briefly addressed in Supporting Information.

\section{Results and discussion}
\label{sec:experiment}



In this Section we describe the main results of our numerical experiments. The more technical aspects, such as full information on generated candidates and influence of biasing potential on search efficiency, are left for Supporting Information.

While we ran in total 96 simulations in QM9*, or 24 simulations with different random generator seed and $\biasprop$ values for each optimization problem, they agreed remarkably often on candidates proposed, only yielding 10 candidates in total. Table~\ref{tab:qm9_summary} summarizes the best and worst values of optimized quantities of candidates proposed by MOSAiCS along with the corresponding relative improvement, which we define as absolute difference between a candidate’s optimized quantity value and the corresponding value for the best molecule for the optimization problem taken from the reference dataset (cf. Table~S2 in Supporting Information), divided by the corresponding $\mathrm{STD}_{\mathrm{dataset}}$. For optimization of $\dEsolv$ with weak $\gap$ constraint all trajectories proposed the minimum of $\dEsolv$ already present in QM9, while for all other optimization problems all trajectories proposed candidates that improved significantly on molecules in QM9. Best candidates proposed for a given optimization problem are shown in Figure~\ref{fig:qm9_best_compounds}; note that to facilitate discussion of candidates' properties in Supporting Information, each candidate is referred by a capital $C$ with a unique index subscript and a superscript denoting the reference dataset. We see how MOSAiCS successfully constructed complex conjugated bond structures facilitating charge transfer which, in turn, led to smaller, \emph{i.e.} more negative, $\dEsolv$  or larger $\dipole$. Figure~\ref{fig:optimization_log_QM9} displays optimization progress with number of global Monte Carlo steps for different $\biasprop$ values for minimizing $\dEsolv$ with weak $\gap$ constraint. We observe convergence of the optimized property with a rate not significantly affected by changing $\biasprop$; the same is true with varying degree for other optimization problems as discussed in Supporting Information. To visualize how simulations explored chemical space for different optimization problems and values of $\biasprop$, for each such combination we took a simulation that had produced the best candidate and plotted the density of molecules it encountered with respect to the optimized quantity and $\gap$. Figure~\ref{fig:qm9_pareto_front_solvation_weak} presents such plots for minimizing $\dEsolv$ with weak $\gap$ constraint, with plots for other optimization problems presented and discussed in Supporting Information. We see that increasing $\biasprop$ tended to increase diversity of molecules encountered during the simulations, but this was mainly done by considering more molecules in regions of chemical space with larger values of $\dEsolv$.



 \begin{table*}%[htb]
 \centering
\input{tables/candidate_tables/best_worst_candidates_QM9}
\caption{Best and worst QM9* candidates proposed during minimization of free energy of solvation $\dEsolv$ or maximization of dipole $\dipole$ with weak or strong constraint on the HOMO-LUMO gap $\gap$, along with their optimized quantity values and the relative improvement compared to QM9 dataset as defined in Sec.~\ref{sec:experiment}. $\dEsolv$ and $\dipole$ values are in kJ/mol and debye. The full list of candidate molecules can be found in Supporting Information.}
\label{tab:qm9_summary}
\end{table*}

 % Figure environment removed

 % Figure environment removed


 % Figure environment removed


Optimization in EGP* was harder than in QM9* due to larger size of the former set of molecules, resulting in our protocol generating underconverged simulations that rarely agreed on candidates, producing 83 candidates in total. However, as summarized in Table~\ref{tab:egp_summary}, we still observed significant improvement of optimized quantities compared to EGP, though the improvements' impressive magnitudes are largely due to EGP containing a much less representative portion of EGP* compared to the case of QM9 and QM9*. Best EGP* candidates for each optimization problem are presented in Figure~\ref{fig:egp_best_candidates}; unlike QM9* candidates, no chemical intuition is seen in how they were constructed beyond adding as many polar covalent bonds as possible, which may be due to underconvergence of our EGP* simulations. The underconvergence can also be observed on  our optimization progress plots, the plot for minimizing $\dEsolv$ with weak $\gap$ constraint presented in  Figure~\ref{fig:optimization_log_EGP} and the rest found in Supporting Information. Figure~\ref{fig:optimization_log_EGP} also demonstrates how adding $\biasprop$ can accelerate optimization as a function of global Monte Carlo steps, though we need to note that simulations with larger $\biasprop$ on average process more chemical graphs per global Monte Carlo steps as discussed in Supporting Information. Densities of molecules encountered during simulations minimizing $\dEsolv$ with weak $\gap$ constraint that produced the best candidates are presented in Figure~\ref{fig:egp_pareto_front_solvation_weak}; unlike the case of QM9*, increasing $\biasprop$ helped simulations explore parts of chemical space with smaller values of $\dEsolv$. Analogous plots for other optimization problems in EGP* are presented in Supporting Information.


 \begin{table*}%[htb]
 \centering
\input{tables/candidate_tables/best_worst_candidates_EGP}
\caption{Best and worst EGP* candidates, data notation is analogous to Table~\ref{tab:qm9_summary}. Full list of candidate molecules can be found in Supporting Information.}
\label{tab:egp_summary}
\end{table*}

 % Figure environment removed

 % Figure environment removed


 % Figure environment removed



\section{Conclusions and outlook}
\label{sec:conclusions_outlook}

We have proposed an effective algorithm for optimization in chemical space, dubbed MOSAiCS, and successfully applied it to several test optimization problems connected to lithium battery electrolyte design.  In the current implementation, it is only feasible to optimize estimates of quantities of interest that can be evaluated with little computational effort due to the large number of evaluations of loss function made during a simulation (see Supporting Information); given successes in using active learning for optimization problems in both configuration\cite{Gastegger_Marquetand:2017,Podryabinkin_Shapeev:2017,Schaaf_Csanyi:2023,Vandermause_Kozinsky:2023} and chemical\cite{Hernandez-Lobato_Aspuru-Guzik:2017,Smith_Roitberg:2018,Reker:2019} space, our first priority is to combine MOSAiCS with a similar protocol to decrease the number of loss function evaluations done during the simulations. Successful use of Markov Decision Process formalism to accelerate genetic algorithms in chemical space\cite{Fu_Sun:2022} suggests MOSAiCS might similarly be improved with a smarter policy for choosing elementary mutations and crossover moves. On a more general note, any method for generating chemical graphs that can also provide corresponding proposition probability $\Pprop$ needed for $\Pacc$~(\ref{eq:acceptance_probability}) can be integrated into MOSAiCS framework directly.

While we aimed to propose an approach that would be agnostic to how much is known about the chemical graph set of interest, we still relied on QM9 and EGP to get reasonably rescaled loss functions $ F_{\mathrm{solv.}} $~(\ref{eq:F_solv}) and $F_{\mathrm{dipole}}$~(\ref{eq:F_dipole}) that were then used during simulations in QM9* and EGP*. This dependence on previously published data should become avoidable by implementing more sophisticated schemes\cite{Vousden_Mandel:2015} for adjusting temperature parameters $\beta^{(i)}$ based on trajectory history. Also, while we used heavy atoms with connected hydrogens as nodes of chemical graphs to maximize chemical diversity of generated compounds, it is possible to expand the algorithm to using larger compound fragments as nodes instead. If applicable to the optimization problem at hand, this modification should simplify the search by both decreasing effective dimensionality of the graphs considered\cite{Xie_Lei:2021,Laplaza_Corminboeuf:2022} and improving scalability of machine learning models for the molecules of interest.\cite{Huang_Lilienfeld:2020,Huang_Benali:2023}

\section{Code availability}

Python implementation of MOSAiCS is available at \url{https://github.com/chemspacelab/mosaics}.

\begin{suppinfo}
Details of MOSAiCS implementation and quantity of interest evaluation, discussion of accessibility of QM9* and EGP* by our simulations, additional experimental results.
\end{suppinfo}

\begin{acknowledgement}
This project has received funding from the European Union’s Horizon 2020 research and innovation programme under grant agreement No~957189 (BIG-MAP) and  No~957213 (BATTERY 2030+). O.A.v.L. has received funding from the European Research Council (ERC) under the European Union’s Horizon 2020 research and innovation programme (grant agreement No.~772834). O.A.v.L. has
received support as the Ed Clark Chair of Advanced Materials and as a Canada CIFAR AI Chair. O.A.v.L. acknowledges that this research is part of the University of Toronto’s Acceleration Consortium, which receives funding from the Canada First Research Excellence Fund (CFREF). Obtaining the presented computational results has been facilitated using the queueing system implemented at \href{https://leruli.com}{http://leruli.com}. The project has been supported by the Swedish Research Council (Vetenskapsrådet), and the Swedish National Strategic e-Science program eSSENCE as well as by computing resources from the Swedish National Infrastructure for Computing (SNIC/NAISS).
\end{acknowledgement}


\bibliography{references}

\end{document}
