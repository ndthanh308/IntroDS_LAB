\begin{tikzpicture}

    % queue
    \pgfmathsetmacro\qy{-1.7}
    \pgfmathsetmacro\qx{-.5}
    \pgfmathsetmacro\qw{.5} % 1/2 queue width
    \pgfmathsetmacro\qh{.25} % 1/2 queue height
    \coordinate (queue) at (\qx,\qy);
    \path[fill=DodgerBlue1!20,draw] ($(queue)+(-\qw,\qh)$) --
        ($(queue)+(\qw, \qh)$) --
        node (betaqball) {}
        ($(queue)+(\qw,-\qh)$) --
        ($(queue)+(-\qw,-\qh)$);
    \node[circle,draw,fill=DodgerBlue1!20]
        (ballq)
        at ($(betaqball.east)+(.4,0)$)
        {$\beta_{q\phantom{'}}^*$};
    \node at (queue) {$q$};

    % Delay box
    %\node[rectangle,draw]

    % Arrival flow
    \draw[->,color=DodgerBlue3]
        ($(queue)-(2*\qw,0)$)
        node[anchor=east,align=center]
        {$A_q(t)$\\$\alpha_q(t)$}
        -- ($(queue)-(\qw,0)$);

    % low priority queue q2
    \pgfmathsetmacro\qly{-2.65}
    \pgfmathsetmacro\qlx{-.5}
    \pgfmathsetmacro\qlw{.5} % 1/2 queue width
    \pgfmathsetmacro\qlh{.25} % 1/2 queue height
    \pgfmathsetmacro\llmax{.2} % max low packet
    \coordinate (queuel) at (\qlx,\qly);
    \path[fill=Firebrick1!20,draw] ($(queuel)+(-\qw,\qh)$) --
        ($(queuel)+(\qlw, \qlh)$) --
        node (betaqlball) {}
        ($(queuel)+(\qlw,-\qlh)$) --
        ($(queuel)+(-\qlw,-\qlh)$);
    \node[circle,draw,fill=Firebrick1!20]
        (ballql)
        at ($(betaqlball.east)+(.4,0)$)
        {$\beta_{q'}^*$};
    \node at (queuel) {$q'$};

    % Scaling box
    \node (middle) at ($(0,.5*\qy+.5*\qly)$) {};
    \node (rightballql) at
        ($(ballql.east)+(1.9,0)$) {};
    \node[rectangle,draw,fill=gray!20,
        inner sep=1em] (scaling) at
        (rightballql |- middle)
        {$S$};
    \node[anchor=north,align=center]
        at (scaling.south)
        {Channel\\Stochastic Scaling};

    % Delay box
    \node[rectangle,draw,fill=gray!20,
        inner sep=1em]
        (delay) at ($(scaling)+(2,0)$)
        {$\delta_W$};
    \node[anchor=north] at (delay.south) {Loss delay};

    % Arrival flow low priority
    \draw[->,color=Firebrick3]
        ($(queuel)-(2*\qlw,0)$)
        node[anchor=east,align=center]
        {$A_{q'}(t)$\\$\alpha_{q'}(t)$}
        -- ($(queuel)-(\qlw,0)$);

    
    %%%%%%%%%%%%%%%%%%
    %%%% ARROWS %%%%%%
    %%%%%%%%%%%%%%%%%%

    \draw[->,color=DodgerBlue3] (ballq) -|
        ($(scaling.west)+(-1.2,.2)$) --
        node[pos=0,anchor=south west]
        {$D_q(t)$}
        ($(scaling.west)+(0,.2)$);

    \draw[->,color=Firebrick3] (ballql) -|
        ($(scaling.west)-(1.2,.2)$) --
        node[pos=0,anchor=north west]
        {$D_{q'}(t)$}
        ($(scaling.west)-(0,.2)$);


    \draw[->,color=DodgerBlue3]
        ($(scaling.east)+(0,.2)$)
        -- ($(delay.west)+(0,.2)$)
        node[pos=0.2,circle,fill=DodgerBlue3,
        minimum size=.1em,inner sep=.1em]
        (exit) {};
    \draw[->,color=DodgerBlue3!50]
        (exit) -- ($(exit)+(0,.35)$)
        node[anchor=south]
        {Tx success};

    \draw[->,color=Firebrick3]
        ($(scaling.east)-(0,.2)$)
        -- ($(delay.west)-(0,.2)$)
        node[pos=0.5,circle,fill=Firebrick3,
        minimum size=.1em,inner sep=.1em]
        (exitl) {};
    \draw[->,color=Firebrick3]
        (exitl) -- ($(exitl)-(0,.35)$);


    \draw[->,color=Firebrick3]
        ($(delay.east)-(0,.2)$)
        -- ($(delay.east)+(.4,-.2)$)
        |- ($(queuel.west)-(1.5*\qlw,4*\qlh)$)
        |- ($(queuel.west)-(\qlw,.2)$)
        node[pos=.1,anchor=east]
        {$\alpha_{q'}^{(i)}(t)$};


    \draw[->,color=DodgerBlue3]
        ($(delay.east)+(0,.2)$)
        -- ($(delay.east)+(.4,.2)$)
        |- ($(queue.west)+(-1.5*\qlw,4*\qlh)$)
        |- ($(queue.west)+(-\qlw,.2)$)
        node[pos=.1,anchor=east]
        {$\alpha_{q}^{(i)}(t)$};



\end{tikzpicture}
