\begin{tikzpicture}

    % queue
    \pgfmathsetmacro\qy{-1.7}
    \pgfmathsetmacro\qx{-.5}
    \pgfmathsetmacro\qw{.5} % 1/2 queue width
    \pgfmathsetmacro\qh{.25} % 1/2 queue height
    \coordinate (queue) at (\qx,\qy);
    \path[fill=DodgerBlue1!20,draw] ($(queue)+(-\qw,\qh)$) --
        ($(queue)+(\qw, \qh)$) --
        ($(queue)+(\qw,-\qh)$) --
        ($(queue)+(-\qw,-\qh)$);
    \node at (queue) {$q$};

    % Arrival flow
    \draw[->] ($(queue)-(2*\qw,0)$)
        node[anchor=south] {$A_q(t)$}
        -- ($(queue)-(\qw,0)$);

    % low priority queue q2
    \pgfmathsetmacro\qly{-2.65}
    \pgfmathsetmacro\qlx{-.5}
    \pgfmathsetmacro\qlw{.5} % 1/2 queue width
    \pgfmathsetmacro\qlh{.25} % 1/2 queue height
    \pgfmathsetmacro\llmax{.2} % max low packet
    \coordinate (queuel) at (\qlx,\qly);
    \path[fill=Firebrick1!20,draw] ($(queuel)+(-\qw,\qh)$) --
        ($(queuel)+(\qlw, \qlh)$) --
        ($(queuel)+(\qlw,-\qlh)$) --
        ($(queuel)+(-\qlw,-\qlh)$);
    \node at (queuel) {$q'$};

    % Arrival flow low priority
    \draw[->] ($(queuel)-(2*\qlw,0)$)
        node[anchor=south] {$A_{q'}(t)$}
        -- ($(queuel)-(\qlw,0)$);

    % Opening gates params
    \pgfmathsetmacro\TmL{1} % T-L
    \pgfmathsetmacro\L{.5} % L
    \pgfmathsetmacro\h{.5} % TDMA height
    \pgfmathsetmacro\deltaA{.8} % deltaA
    \pgfmathsetmacro\steps{2}

    % Slope params high prio
    \pgfmathsetmacro\C{\h/\L} % channel rate
    \pgfmathsetmacro\Cq{.1*\C} % q arriving rate
    \pgfmathsetmacro\bq{.2*\h} % q burst
    \pgfmathsetmacro\Rq{\C*\L /(\TmL+2*\L)} % TDMA rate

    % Slope params low prio
    \pgfmathsetmacro\Cql{.24*\C} % q' arriving rate
    \pgfmathsetmacro\bql{.3*\h} % q' burst
    \pgfmathsetmacro\Rql{\Rq} % q' TDMA rate


    % Bounding box for STA
    \draw[gray] ($(queue)-(3*\qw,-2.5*\qh)$)
        rectangle ++($(6+3*\qw,-9.5*\qh)$)
        node[anchor=south east,align=center,
        rotate=270]
        {802.11 STA\\with 802.1Qbv};
    
    % Draw opening gates
    \draw (0,\qy) -- (\deltaA, \qy)
        node[circle,fill=black,inner sep=0,
        minimum size=.25em] {};

    % Draw opening gates queue 2
    \draw (0,\qly) -- (\deltaA, \qly)
        node[circle,fill=black,inner sep=0,
        minimum size=.25em] {};


    \foreach \i in {0,...,\steps}{
        % Opening gates
        \draw  ($(\deltaA+\i*\TmL+\i*\L   ,\qy)$)
            -- ($(\deltaA+\i*\TmL+\i*\L+\L,\qy+.2)$);
        \draw  ($(\deltaA+\i*\TmL+\i*\L+\L   ,\qy)$)
        node[circle,fill=black,inner sep=0,
            minimum size=.25em] {}
            -- ($(\deltaA+\i*\TmL+\i*\L+\L+\TmL,\qy)$);
        \ifthenelse{\i=2}{}{%
            \node[circle,fill=black,inner sep=0,
                minimum size=.25em]
                at ($(\deltaA+\i*\TmL+\i*\L+\L+\TmL,\qy)$)
                {};
        }


        % Opening gates low prio. queue
        \draw  ($(\deltaA+\i*\TmL+\i*\L   ,\qly)$)
            -- ($(\deltaA+\i*\TmL+\i*\L+\L,\qly+.2)$);
        \draw  ($(\deltaA+\i*\TmL+\i*\L+\L   ,\qly)$)
        node[circle,fill=black,inner sep=0,
            minimum size=.25em] {}
            -- ($(\deltaA+\i*\TmL+\i*\L+\L+\TmL,\qly)$);
        \ifthenelse{\i=2}{}{%
            \node[circle,fill=black,inner sep=0,
                minimum size=.25em]
                at ($(\deltaA+\i*\TmL+\i*\L+\L+\TmL,\qly)$)
                {};
        }




        % TDMA increase
        \draw[color=gray,very thick]
            ($(\deltaA+\i*\TmL+\i*\L,\i*\h)$)
            --
            ($(\deltaA+\i*\TmL+\i*\L+\L,\i*\h+\h)$);
        
        \ifthenelse{\i=2}{%
            \node[anchor=south east,
                color=gray] at
                ($(\deltaA+\i*\TmL+\i*\L+.5*\L,\i*\h+.5*\h)$)
                {$\beta_{L_q,T_q}([t-\delta_q]^+)$};
        }{}

        \draw[color=gray,ultra thick]
            ($(\deltaA+\i*\TmL+\i*\L+\L,\i*\h+\h)$)
            --
            ($(\deltaA+\i*\TmL+\i*\L+\L+\TmL,\i*\h+\h)$);


    }

    % Lower envelope
    \draw[gray,thick,dashed] ($(\deltaA,0)$)
        --
        ($(\deltaA+\steps*\L+\L+\steps*\TmL+\TmL,\steps*\h+\h)$);
        % node[midway,anchor=north west]
        % {$\beta_q(t)$};


    % Lower envelope impacted
    \draw[color=DodgerBlue4,thick] ($(\deltaA+\llmax/\Rq,0)$)
        --
        ($(\deltaA+\steps*\L+\L+\steps*\TmL+\TmL,\steps*\h+\h-\llmax)$)
        node[pos=.8,anchor=north]
        {$\beta_q^*(t)$};

    
    % Low prio packet impact
    \draw [|-|,color=Firebrick4]
        ($(.15+ \deltaA+\steps*\L+\L+\steps*\TmL+\TmL,\steps*\h+\h-\llmax)$)
        --
        ($(.15+ \deltaA+\steps*\L+\L+\steps*\TmL+\TmL,\steps*\h+\h)$)
        node[midway,anchor=west] {$l_{\max}^{q'}$};


    % Lower envelope impacted for q'
    \pgfmathsetmacro\delayl{(\Rql*\deltaA+\bq)/(\Rql-\Cq)}
    \pgfmathsetmacro\ratel{(\Rql-\Cq)}
    \draw[color=Firebrick4,thick]
        ($(\delayl,0)$)
        --
        ($(5.5,\ratel*5.5 - \ratel*\delayl)$)
        node[pos=1,anchor=west]
        {$\beta_{q'}^*(t)$};


    % AXIS
    \draw[->] (0,0) -- (5.5,0)
        node[anchor=west] {$t$};
    \draw[->] (0,0) -- (0,\h*3)
        node[pos=.8,rotate=90,anchor=south] {bits};


    \draw[color=gray,very thick]
        (0,0) -- (\deltaA,0);

    % Specify the offset
    \draw[|-|,gray] ($(\qx+\qw+.1, \qly-.2)$)
        -- node[midway,anchor=north] {$\delta_{q'}$}
        ($(\qx+\qw+\deltaA-.1, \qly-.2)$);

    % Specify the gate opening time L
    \draw[|-|,gray] ($(\qx+\qw+\deltaA+.05, \qly-.2)$)
        -- node[midway,anchor=north] {$L_{q'}$}
        ($(\qx+\qw+\deltaA+\L-.05, \qly-.2)$);

    % Specify the gate period
    \draw[|-|,gray] ($(\qx+\qw+\deltaA+\TmL+\L, \qly-.2)$)
        -- node[midway,anchor=north] {$T_{q'}$}
        ($(\qx+\qw+\deltaA+2*\L+2*\TmL-.1, \qly-.2)$);


    % Specify q' envelope delay
    \pgfmathsetmacro\latencyl{%
        (\Rql*\deltaA+\bq)/(\Rql-\Cq)}
    \draw[|-|,color=Firebrick4]
        (0,-.25) -- (\latencyl,-.25)
        node[midway,anchor=north]
        {$\frac{R_{q'}\delta_{q'}+b_q}{R_{q'}-C_q}$};





    %%%%%%%%%%%%%%%
    % TWT windows %
    %%%%%%%%%%%%%%%

    % low priority queue q2
    \pgfmathsetmacro\twty{-5}
    \pgfmathsetmacro\twth{1}

    % TWT session time-axis
    \draw[->] (0,\twty) --
        ($(0,\twty)+(5.5,0)$)
        node[anchor=west] {$t$};
    \draw[->] (0,\twty) --
        ($(0,\twty)+(0,\twth)$)
        node[pos=.8,anchor=south,rotate=90] {freq.};

    % TWT sessions
    \foreach \i in {0,...,\steps}{
        \node (twtstart) at ($(\deltaA+\i*\TmL+\i*\L   ,\twty)$) {};

        % MU Tx box
        \draw[draw=black] (twtstart) {} rectangle ++(\L,\twth) ;
        % TWT session
        \draw[draw=gray,dotted]
            ($(twtstart)-(.1,0)$) {} rectangle ++($(\L,\twth)+(.2,.1)$) ;



        % First session
        \ifthenelse{\i=0}{%

            \draw[|-|] ($(twtstart)+(\L+.2,.05)$)
                -- ($(twtstart)+(\L+.2,\twth)$)
                node[anchor=south,pos=.5,
                rotate=270]
                {MU Tx};

            % packets
            \draw[fill=DodgerBlue1!40]
                ($(\deltaA+\i*\TmL+\i*\L,\twty+\twth/3)$) rectangle ++(\L/3,\twth/3);
            \draw[fill=Firebrick1!40]
                ($(\deltaA+\i*\TmL+\i*\L+\L/3,\twty+\twth/3)$) rectangle ++(\L/3,\twth/3);
            \draw[fill=DodgerBlue1!40]
                ($(\deltaA+\i*\TmL+\i*\L+2*\L/3,\twty+\twth/3)$) rectangle ++(\L/3,\twth/3);

        }{}


        % Second session
        \ifthenelse{\i=1}{%
            \draw[fill=DodgerBlue1!40]
                ($(\deltaA+\i*\TmL+\i*\L,\twty+\twth/3)$) rectangle ++(\L,\twth/3);

            % ALLOCATED RU
            \draw[|-|] ($(twtstart)+(\L+.2,\twth/3)$)
                -- ($(twtstart)+(\L+.2,2*\twth/3)$)
                node[anchor=west,pos=.5]
                {RU};
        }{}

        % Third session
        \ifthenelse{\i=2}{%
            


            \draw[fill=DodgerBlue1!40]
                ($(\deltaA+\i*\TmL+\i*\L,\twty+\twth/3)$) rectangle ++(2*\L/3,\twth/3);
            \draw[fill=Firebrick1!40]
                ($(\deltaA+\i*\TmL+\i*\L+2*\L/3,\twty+\twth/3)$) rectangle ++(\L/3,\twth/3);

            \node[anchor=west,align=left,
                color=gray]
                at ($(twtstart)+(\L+.1,\twth-.3)$)
                {\gls{rtwt}\\session};


            % MU Tx box
            \draw[black,dashed]
                ($(\deltaA+\i*\TmL+\i*\L,\twty+\twth)$) --
                ($(\deltaA+\i*\TmL+\i*\L,\qy)$);
            \draw[black,dashed]
                ($(\deltaA+\i*\TmL+\i*\L+\L,\twty+\twth)$) --
                ($(\deltaA+\i*\TmL+\i*\L+\L,\qy)$);


        }{}

    }

    %% Illustrate the allignment


\end{tikzpicture}
