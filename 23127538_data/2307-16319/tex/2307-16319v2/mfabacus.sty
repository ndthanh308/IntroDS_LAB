%%%%%%%%%%%%%%%%%%%%new abacus commands
\newif\ifdots@top \dots@topfalse
\newdimen\abax \abax=0cm
\newdimen\abay \abay=0cm
\newdimen\abah \abah=1cm
\newdimen\abav \abav=.85cm
\newdimen\abahd \abahd=1.6cm
\newdimen\abavd \abavd=1.16875cm
\newdimen\abavv \abavv=1.275cm
\newdimen\abadts \abadts=.9cm
\newdimen\abab \abab=.8cm
\newdimen\aban \aban=.2cm
\newdimen\abat \abat=.3cm
\def\abas{.37}
\def\drawbead{\draw(\abax,\abay)--++(0,\abav);\shade[shading=ball,ball color=black](\abax,\abay+.5*\abav)circle(.5*\abab);\advance\abax\abah}
\def\drawwhitebead{\draw(\abax,\abay)--++(0,\abav);\shade[shading=ball,ball color=white](\abax,\abay+.5*\abav)circle(.5*\abab);\advance\abax\abah}
\def\drawnobead{\draw(\abax,\abay)--++(0,\abav);\draw(\abax-.5*\aban,\abay+.5*\abav)--++(\aban,0);\advance\abax\abah}
\def\drawx{\draw(\abax,\abay)--++(0,.3*\abav)++(0,.4*\abav)--++(0,.3*\abav);\draw(\abax-.8*\aban,\abay+.5*\abav-.8*\aban)--++(1.6*\aban,1.6*\aban);\draw(\abax-.8*\aban,\abay+.5*\abav+.8*\aban)--++(1.6*\aban,-1.6*\aban);\advance\abax\abah}
\def\drawnobeadormark{\draw(\abax,\abay)--++(0,\abav);\advance\abax\abah}
\def\drawvdots{\ifdots@top%
\draw(\abax,\abay)--++(0,\abav/8)++(0,\abav/8)--++(0,\abav/8)++(0,\abav/8)--++(0,\abav/8);%
\else%
\draw(\abax,\abay)++(0,3*\abav/16)--++(0,\abav/8)++(0,\abav/8)--++(0,\abav/8)++(0,\abav/8)--++(0,\abav/8);%
\fi%
\advance\abax\abah}
\def\drawvvdots{%
\draw(\abax,\abay)--++(0,\abav/8)++(0,\abav/8)--++(0,\abav/8)++(0,\abav/8)--++(0,\abav/8)++(0,\abav/8)--++(0,\abav/8)++(0,\abav/8)--++(0,\abav/8)++(0,\abav/8)--++(0,\abav/8);%
\advance\abax\abah}
\def\drawhdots{\draw[dotted,thick](\abax+.5*\abahd-.5*\abah-.5*\abadts,\abay+.5*\abav)--++(\abadts,0);\advance\abax\abahd}
\def\drawtopleft{\draw(\abax,\abay-.1cm)--++(0,\abat+.1cm)--++(.5*\abah+.1cm,0);\advance\abax\abah}
\def\drawtopright{\draw(\abax,\abay-.1cm)--++(0,\abat+.1cm)--++(-.5*\abah-.1cm,0);\advance\abax\abah}
\def\drawtopmiddle{\draw(\abax,\abay-.1cm)--++(0,\abat+.1cm)++(-.5*\abah-.1cm,0)--++(\abah+.2cm,0);\advance\abax\abah}
\def\drawtopdots{\draw[dotted,thick](\abax+.5*\abahd-.5*\abah-.5*\abadts,\abay+\abat)--++(\abadts,0);\advance\abax\abahd}
\def\drawnobeadtwo{\draw(\abax,\abay)--++(0,\abav);\draw(\abax-.5*\aban,\abay+.5*\abav)--++(\aban,0);\draw(\abax,\abay+.5*\abav)node[fill=white,inner sep=.5pt]{\footnotesize2};\advance\abax\abah}
\def\drawbeadtwo{\draw(\abax,\abay)--++(0,\abav);\shade[shading=ball,ball color=black](\abax,\abay+.5*\abav)circle(.5*\abab);\draw(\abax,\abay+.5*\abav)node[white,inner sep=.5pt]{\footnotesize2};\advance\abax\abah}
\def\@bacussingle#1{%
\if b#1\drawbead\fi%
\if n#1\drawnobead\fi%
\if ,#1\abax=0cm\advance\abay-\abav\fi%\dots@topfalse\fi% I think dots@top is now defunct - I was using to do dots differently in the first row
\if ;#1\abax=0cm\advance\abay-\abavd\fi%
\if h#1\drawhdots\fi%
\if v#1\drawvdots\fi%
\if w#1\drawvvdots\fi%
\if l#1\drawtopleft\fi%
\if m#1\drawtopmiddle\fi%
\if r#1\drawtopright\fi%
\if t#1\drawtopdots\fi%
\if x#1\drawx\fi%
\if o#1\drawwhitebead\fi%
\if 2#1\drawbeadtwo\fi%
\if 3#1\drawnobeadtwo\fi%
\if s#1\drawnobeadormark\fi%
\if_#1\advance\abax\abah\fi%
}
\def\@bacustwo#1#2#3.{%there are at least two actual tokens #1 and #2; #3 is a sequence of tokens ending with space (possibly as its only token)
\if e#1% this is where we allow a custom entry
\draw(\abax,\abay+.5*\abav)node{\small$\vphantom1\smash{#2}$};\advance\abax\abah%
\if\space #3\else\@bacus#3.\fi%
\else%
\@bacussingle#1%
\@bacus#2#3.%
\fi%
}
\def\@bacus#1#2.{%
\if\space #2%
\@bacussingle#1%
\else\@bacustwo#1#2 .\fi%
}
\def\sabacus(#1,#2){%\dots@toptrue
\abax=0cm\abay=0cm\begin{tikzpicture}[scale=\abas*#1,,baseline={([yshift=-.8ex]current bounding box.center)}]\@bacus#2 .\end{tikzpicture}}
\def\abacus(#1){\sabacus(1.2,#1)}
