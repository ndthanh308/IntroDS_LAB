\section{Our Quantum Lightning Scheme}\label{sec:constr}

Here, we give our basic quantum lightning construction, which assumes a cryptographic group action.

\begin{construction}\label{constr:main} Let $\gen,\ver$ be the following QPT procedures:
	\begin{itemize}
		\item $\gen(1^\lambda)$: Initialize quantum registers $\Ss$ (for serial number) and $\Ms$ (for money) to states $|0\rangle_\Ss$ and $|0\rangle_\Ms$, respectively. Then do the following:
		\begin{itemize}
			\item Apply $\QFT_{\G_\lambda}$ to $\Ss$, yielding the joint state $\frac{1}{\sqrt{|\G_\lambda|}}\sum_{g\in\G_\lambda}|g\rangle_\Ss|0\rangle_\Ms$.
			\item Apply in superposition the map $|g\rangle_\Ss|y\rangle_\Ms\mapsto |g\rangle_\Ss|y\oplus (g*x_\lambda)\rangle_\Ms$. Here, $x_\lambda$ is an arbitrary set element. The joint state of the system $\Ss\otimes\Ms$ is then $\frac{1}{\sqrt{|\G_\lambda|}}\sum_{g\in\G_\lambda}|g\rangle_\Ss|g*x_\lambda\rangle_\Ms$.
			\item Apply $\QFT_{\G_\lambda}$ to $\Ss$ again, yielding $\frac{1}{|\G_\lambda|}\sum_{g,h\in\G_\lambda}\chi(g,h)|h\rangle_\Ss|g*x_\lambda\rangle_\Ms$
			\item Measure $\Ss$, giving the serial number $\sigma:=h$. The $\Ms$ register then collapses to the banknote $\$=|\G_\lambda^h*x_\lambda\rangle:=\frac{1}{\sqrt{|\Gs_\lambda|}}\sum_{g\in\G_\lambda}\chi(g,h)|g*x_\lambda\rangle_\Ms$. Output $(\sigma,\$)$. 
		\end{itemize}
		\item $\ver(\sigma,\$):$ First verify that the support of $\$$ is contained in $\Xs_\lambda$, by applying the assumed algorithm for recognizing $\Xs_\lambda$ in superposition. Then do the following:
		\begin{itemize}
			\item Initialize a new register $\Hs$ to $\frac{1}{\sqrt{|\G_\lambda|}}\sum_{u\in\G_\lambda}|u\rangle_\Hs$
			\item Apply in superposition the map $|u\rangle_\Hs|y\rangle_\Ms\mapsto |u\rangle_\Ss|(-u)*y\rangle_\Ms$\enspace \footnote{Note that we used the ``minimal'' oracle here for the group action computation, having $(-u)*y$ replace $y$, instead of being written to a response register as in the standard quantum oracle. However, since the computation $y\mapsto (-u)*y$ is efficiently reversible given $u$ (by $y\mapsto u*y$), we can easily implement the minimal oracle efficiently by first computing $|(-u)*y\rangle_{\Ms'}$ in a new register $\Ms'$, then uncomputing $|y\rangle_\Ms$ using the efficient inverse (so it now contains $|0\rangle_\Ms$), and finally swapping $\Ms'$ with $\Ms$.}. 
			\item Apply $\QFT^{-1}_{\G_\lambda}$ to $\Hs$.
			\item Measure $\Hs$, obtaining a group element $h'$. Accept if and only if $h'=h$.
		\end{itemize}
	\end{itemize}
\end{construction}

\begin{remark}If using a probabilistic setup of the group action, there are two options. The first is to have $\gen$ set up the group action, and have the parameters be included in the serial number. The second is to have a trusted third party set up the group action, and publish the parameters in a common reference string (CRS). If the goal is only quantum money security, then the former option is always possible, since the security experiment uses an honestly generated serial number. If the goal is quantum lightning security, the former option may not be possible, as the adversary computes the serial number; it may be that there are bad choices of parameters for the group action (and hence the CRS inside the serial number) which make it easy to forge banknotes. Therefore, for quantum lightning security, we would expect using a trusted setup to generate a CRS containing the group action parameters.
\end{remark}




\subsection{Accepting States of the Verifier}

Above we showed that honest banknote states are accepted by the verifier. We now prove that, roughly, honest banknote states are the \emph{only} states accepted by the verifier.

\begin{theorem}\label{thm:reject} Let $|\psi\rangle$ be a state over $\Ms$. Then $\Pr[\ver(h,|\psi\rangle)=1]=\|\langle\psi |\G_\lambda^h*x_\lambda\rangle \|^2$. Moreover, if verification accepts, the resulting state is exactly $|\G_\lambda^h*x_\lambda\rangle$.
\end{theorem}
In other words, we can treat $\ver(h,|\psi\rangle)$ as projecting exactly onto $|\G_\lambda^h*x_\lambda\rangle$. In particular, honest banknotes are accepted with probability 1. The remainder of this subsection is devoted to proving Theorem~\ref{thm:reject}.

\begin{lemma}For $h'\neq h$, $\langle \G_\lambda^{h'}*x_\lambda|\G_\lambda^h*x_\lambda\rangle=0$
\end{lemma}
\begin{proof} 
	\begin{align*}
		\langle \G_\lambda^{h'}*x_\lambda|\G_\lambda^h*x_\lambda\rangle&=\frac{1}{|\G_\lambda|}\sum_{g,g'\in\G_\lambda}\chi(g',h')^{-1}\chi(g,h)\langle g'*x_\lambda|g*x_\lambda\rangle\\
		&=\frac{1}{|\G_\lambda|}\sum_{g\in\G_\lambda}\chi(g,h')^{-1}\chi(g,h)=\frac{1}{|\G_\lambda|}\sum_{g\in\G_\lambda}\chi(g,h-h')=0
	\end{align*}
\end{proof}

Let $|\psi\rangle$ be a state with support on $\Xs$. Since the $|\G^{h'}*x_\lambda\rangle$ are orthogonal and the number of $h'$ equals the size of $\Xs$, the set $\{|\G_\lambda^{h'}*x_\lambda\rangle\}_{h'}$ forms a basis for the set of states with support on $\Xs$. We can then write $|\psi\rangle=\sum_{h'}\alpha_{h'}|\G_\lambda^{h'}*x_\lambda\rangle$ where $\sum_{h'} \|\alpha_{h'}\|^2=1$. We then have $\|\alpha_h\|^2=\|\langle\psi |\G_\lambda^h*x_\lambda\rangle\|^2$.

We now consider applying the verification algorithm to the state $|\psi\rangle_\Ms$. After initializing $\Hs$ to $\frac{1}{\sqrt{|\G_\lambda|}}\sum_{u\in\G_\lambda}|u\rangle_\Hs$ and applying the map $(u,y)\mapsto (u,(-u)*y)$, the state of $\Hs,\Ms$ is:
\begin{align*}&\frac{1}{\sqrt{|\G_\lambda|}}\sum_{u}|u\rangle_\Hs \sum_{h'}\alpha_{h'} \frac{1}{\sqrt{|G_\lambda|}}\sum_g \chi(g,h') |(g-u)*x_\lambda\rangle_\Ms\\
	&=\frac{1}{\sqrt{|\G_\lambda|}}\sum_{u}|u\rangle_\Hs \sum_{h'}\alpha_{h'}\frac{1}{\sqrt{|G_\lambda|}}\sum_{g'} \chi(g'+u,h') |g'*x_\lambda\rangle_\Ms\\
	&=\sum_{h'}\alpha_{h'} \frac{1}{\sqrt{|\G_\lambda|}}\sum_u \chi(u,h')|u\rangle_\Hs \frac{1}{\sqrt{|G_\lambda|}} \sum_{g'}\chi(g',h')|g'*x_\lambda\rangle_\Ms\\
	&=\sum_{h'}\alpha_{h'} \frac{1}{\sqrt{|\G_\lambda|}}\sum_u \chi(u,h')|u\rangle_\Hs |\G^{h'}*x_\lambda\rangle_\Ms
\end{align*}
where above we used the substitution $g'=g-u$. Now when we apply the inverse $\QFT$ to $\Hs$, the resulting state is:
\[\sum_{h'}\alpha_{h'} |h'\rangle_\Hs |\G^{h'}*x_\lambda\rangle_\Ms\]
We now measure $\Hs$, which produces outcome $h'$ with probability $|\alpha_{h'}|^2$, and the register $\Ms$ collapses to the state $|\G^{h'}*x_\lambda\rangle$. We have that the verifier accepts if $h'=h$, which occurs with probability $\|\alpha_h\|^2=\|\langle\psi |\G_\lambda^h*x_\lambda\rangle\|^2$ as desired. In this case, the register $\Ms$ collapses to $|\G^{h}*x_\lambda\rangle$, as desired. This completes the proof of Theorem~\ref{thm:reject}.\qed

\iffalse 

Consider a single iteration of $\ver$ on serial number $h$, which samples a random $u$, initializes $\Hs$ to $(|0\rangle+|1\rangle)/\sqrt{2}$, applies the map ${\sf Apply}$,
and then measures $\Hs$ is basis $B_{h,u}$ to get outcome $b$. Let  $|\psi'\rangle$ be the post-measurement state of $\Ms$ conditioned on $b=0$.

\begin{lemma} Conditioned on $u$, $p:=\Pr[b_u=0]=\frac{1}{4}\sum_{h'} \|\alpha_{h'}\|^2 \|1+\chi(u,h-h')\|^2$, and \\$|\psi'\rangle=\frac{1}{\sqrt{p}}\sum_{h'}\alpha_{h'} \frac{1+\chi(u,h-h')}{2}|\G_\lambda^{h'}*x_\lambda\rangle_\Ms$.
\end{lemma}
\begin{proof}By adapting the correctness proof above, we see that the state after applying ${\sf Apply}$ (but before measurement) is:
	\[|\phi\rangle=\sum_{h'\in\G_\lambda}\alpha_{h'}\frac{1}{\sqrt{2}}\left(|0\rangle_\Hs+\chi(u,h')|1\rangle_\Hs\right)|\G_\lambda^{h'}*x_\lambda\rangle_\Ms\]
Then $p$ is length squared of the projection of $|\phi\rangle$ onto $(|0\rangle_\Hs+\chi(u,h)|1\rangle_\Hs)/\sqrt{2}$. Therefore, $p=\frac{1}{4}\sum_{h'} \|\alpha_{h'}\|^2 \|1+\chi(u,h')^{-1}\chi(u,h)\|^2=\frac{1}{4}\sum_{h'} \|\alpha_{h'}\|^2 \|1+\chi(u,h-h')\|^2$. Before re-normalization, the state of $\Ms$ conditioned on $b=0$ is then $\sum_{h'}\alpha_h \frac{1+\chi(u,h-h')}{2}|\G_\lambda^{h'}*x_\lambda\rangle_\Ms$. Re-normalization gives $|\psi'\rangle$.
\end{proof}

We now iterate, replacing $\alpha_{h'}$ with $\alpha_{h'} \frac{1+\chi(u,h-h')}{2}/\sqrt{p}$. This means that after $\lambda$ trials, conditioned on trial $i$ using $u_i$ and giving measurement outcome $b_i$, we have that \[p_{\sf final}:=\Pr[b_1=b_2=\cdots=b_\lambda=0]=\frac{1}{4^\lambda}\sum_{h'} \|\alpha_{h'}\|^2\prod_{1=1}^\lambda \|1+\chi(u_i,h-h')\|^2\]

We now average over $u$ to get $\E[p_{\sf final}]$, the overall probability that $\ver$ accepts $|\psi\rangle$. 
\begin{align*}
	\E[p_{\sf final}]&=\frac{1}{(4|\G_\lambda|)^\lambda}\sum_{h',u_1,\cdots,u_\lambda}\|\alpha_{h'}\|^2\prod_{i=1}^\lambda \|1+\chi(u_i,h-h')\|^2\\
	&=\sum_{h'}\|\alpha_{h'}\|^2\prod_{i=1}^\lambda \left(\frac{1}{4|\G_\lambda|}\sum_u \|1+\chi(u,h-h')\|^2\right)\\
	&=\sum_{h'}\|\alpha_{h'}\|^2\prod_{i=1}^\lambda \left(\frac{1}{4|\G_\lambda|}\sum_u 2+\chi(u,h-h')+\chi(u,h-h')^{-1}\right)\\
	&=\|\alpha_h\|^2+2^{\lambda}\sum_{h'\neq h}\|\alpha_{h'}\|^2=\|\alpha_h\|^2+2^{-\lambda}(1-\|\alpha_h\|^2)\\
	&=\|\alpha_h\|^2(1-2^{-\lambda})+2^{-\lambda}
\end{align*}
This completes the proof of Theorem~\ref{thm:reject}.\qed\fi




\subsection{Computing the Serial Number}\label{sec:compserial}

Here, we show that, given a valid banknote $\$=|\G_\lambda^h*x_\lambda\rangle$ with unknown serial number $h$, it is possible to efficiently compute $h$. This result is not needed for understanding the construction or its security, but will be used in Section~\ref{sec:knowledge} to break a certain natural knowledge assumption.

\begin{theorem}\label{thm:computeh} There exists a QPT algorithm ${\sf Findh}$ such that, on input $|\G_\lambda^h*x_\lambda\rangle$, outputs $h$ with probability $1$.
\end{theorem}
\begin{proof} We originally had a much more complicated algorithm ${\sf Findh}$ (and one that had a negligible correctness error). We thank Jake Doliskani for pointing our a much simpler version using phase kickback. 
	
Indeed, by simply modifying $\ver$ to output the measurement result $h'$ instead of testing whether or not $h'=h$, we immediately obtain such a {\sf Findh}. The proof of Theorem~\ref{thm:reject} shows that {\sf Findh} indeed outputs $h$ with probability 1 for the input state $|\G_\lambda^h*x_\lambda\rangle$.
\end{proof}
	
	
	








