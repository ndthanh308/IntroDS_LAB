\ProvidesPackage{myisabelle}

\RequirePackage{ifxetex}
\RequirePackage{xspace}
\RequirePackage[cmbtt]{bold-extra}
\RequirePackage[dvipsnames]{xcolor}

\DeclareOption{it}{
\isabellestyleit
}
\DeclareOption{sf}{
\isabellestylesf
}
\DeclareOption{tt}{
\isabellestylett
}
\DeclareOption{color}{
\def\isa@color@In{\color[gray]{.4}}
\def\isa@color@St{\color{NavyBlue}}
\def\isa@color@Pr{\color{Cyan}}
\def\isa@color@Kw{\color{OliveGreen}}
\def\isa@color@InKw{\color{PineGreen}}
\def\isa@color@Tac{\color{BrickRed}}
\def\isa@color@Comm{\color[RGB]{204,0,0}}
}
\DeclareOption{nocolor}{
\let\isa@color@In\relax
\let\isa@color@St\relax
\let\isa@color@Pr\relax
\let\isa@color@Kw\relax
\let\isa@color@InKw\relax
\let\isa@color@Tac\relax
\let\isa@color@Comm\relax
}

\def\imath#1{\ifmmode#1\else\ifvmode$#1$\/\else\/$#1$\fi\fi}%

\def\isa@sp{ }% default space
\def\isa@indent{\mbox{\hspace{.5em}}}% default indent
\def\isa@openIn{}%
\def\isa@closeIn{}%
\def\isa@apos{'}
\def\isa@eq{\imath=}
\def\isa@lt{\imath<}
\def\isa@gt{\imath>}
\def\isa@bar{\imath|}
\def\isa@barindent{\hbox to .5em{\hfil\boldmath\isa@bar}}% indent with bar
\def\isa@hyp{\imath-}
\def\isa@plus{\imath+}
\def\isa@ast{\imath{*}}
\def\isa@com{\imath,}
\def\isa@dot{\imath.}
\def\isa@col{\imath:}
\def\isa@lpa{\ifmmode(\else\/{\upshape(}\fi}
\def\isa@rpa{\ifmmode)\else\/{\upshape)}\fi}
\def\isa@lbracket{\ifmmode[\else\/{\upshape[}\fi}
\def\isa@rbracket{\ifmmode]\else\/{\upshape]}\fi}
\def\isa@lbrace{\ifmmode\lbrace\else\/{\upshape\textbraceleft}\fi}
\def\isa@rbrace{\ifmmode\rbrace\else\/{\upshape\textbraceright}\fi}
\def\isa@us{\ifmmode\sb\else\isa@char@us\fi}%
\def\isa@usKw{\isa@char@us}
\def\isa@hat{\ifmmode\sp\else\isa@char@hat\fi}

%isabelle style for sanserif
\newcommand\isabellestylesf{%
\def\isa@style{\sf}%
\def\isa@In{\isa@color@In}%
\def\isa@St{\bfseries\isa@color@St}%
\def\isa@Kw{\bfseries\isa@color@Kw}%
\def\isa@InKw{\isa@color@InKw}%
\def\isa@Pr{\bfseries\isa@color@Pr}%
\def\isa@Tac{\bfseries\isa@color@Tac}%
\def\isa@Scr{\isa@style}%
\def\isa@Comm{\tt\isa@color@Comm}%
\def\isa@openIn{{``}}%
\def\isa@closeIn{\nolinebreak\hspace{.5pt}{''}}%
\def\isa@char@us{{\tt\char`_}\penalty100\relax}%
\def\isa@char@hat{{\tt\char`^}}%
}
%isabelle style for italic
\newcommand\isabellestyleit{%
\def\isa@style{\it}%
\def\isa@In{\isa@color@In}%
\def\isa@St{\bfseries\upshape\isa@color@St}%
\def\isa@Kw{\bfseries\upshape\isa@color@Kw}%
\def\isa@InKw{\bfseries\isa@color@InKw}%
\def\isa@Pr{\bfseries\upshape\isa@color@Pr}%
\def\isa@Tac{\bfseries\upshape\isa@color@Tac}%
\def\isa@Scr{\rmfamily\upshape}%
\def\isa@Comm{\tt\isa@color@Comm}%
\def\isa@openIn{{}}%
\def\isa@closeIn{\/}%
\def\isa@char@us{-}%
\def\isa@char@hat{{\char`^}}%
}
%isabelle style for typewriter
\newcommand\isabellestylett{%
\def\isa@style{\tt}%
\def\isa@In{\isa@color@In}%
\def\isa@St{\bfseries\isa@color@St}%
\def\isa@Kw{\bfseries\isa@color@Kw}%
\def\isa@InKw{\bfseries\isa@color@InKw}%
\def\isa@Pr{\bfseries\isa@color@Pr}%
\def\isa@Tac{\bfseries\isa@color@Tac}%
\def\isa@Scr{\isa@style}%
\def\isa@Comm{\tt\isa@color@Comm}%
\def\isa@openIn{"}%
\def\isa@closeIn{\nolinebreak\hspace{.5pt}"}%
\def\isa@eq{=}%
\def\isa@lt{<}%
\def\isa@gt{>}%
\def\isa@bar{|}%
\def\isa@hyp{-}%
\def\isa@plus{+}%
\def\isa@ast{*}%
\def\isa@com{,}%
\def\isa@dot{\ifmmode.\else.\@\fi}%
\def\isa@col{\ifmmode:\else:\@\fi}%
\def\isa@char@us{\char`_\penalty100\relax}%
\def\isa@char@hat{{\char`^}}%
}

\def\isa@scriptsize{\scriptsize}%
\def\isa@scriptscriptsize{\scriptscriptsize}%

% in \isa and isabelle environments special characters are replaced
{\catcode`\^^M\active\gdef\isa@defcr{\catcode`\^^M\active\def^^M}}
\begingroup
\catcode`^\active
\catcode`_\active
\catcode` \active
\catcode`<\active
\catcode`>\active
\catcode`|\active
\catcode`-\active
\catcode`+\active
\catcode`*\active
\catcode`(\active
\catcode`)\active
\catcode`'\active
\catcode`,\active
\catcode`.\active
\catcode`[\active
\catcode`]\active
\catcode`:\active
\catcode`=\active
\catcode`"\active
\gdef\isa@leave{%
\catcode`^7%
\catcode`_8%
\catcode` 10%
\catcode`<12%
\catcode`>12%
\catcode`|12%
\catcode`-12%
\catcode`+12%
\catcode`*12%
\catcode`(12%
\catcode`)12%
\catcode`'12%
\catcode`,12%
\catcode`.12%
\catcode`[12%
\catcode`]12%
\catcode`:12%
\catcode`=12%
\catcode`"12%
\restorecr%
}
\gdef\isa@enter{%
	% for right style in scripts
	\def\sub##1{$\sb{\textrm{\isa@Scr\isa@scriptsize\let\isa@scriptsize\isa@scriptscriptsize##1}}$}%
	\def\sup##1{$\sp{\textrm{\isa@Scr\isa@scriptsize\let\isa@scriptsize\isa@scriptscriptsize##1}}$}%
	\def\inner##1{{\isa@In##1}}%
	\def\isa@text##1{##1\egroup}%
	\def\isatext{\bgroup\isa@leave\isa@text}%
	\def\var##1{\xspace{\color{Blue}##1}\xspace}%
	\def\lvar##1{\xspace{\color{Green}##1}\xspace}% local variable
	\def\pvar##1{\xspace{\color{RedOrange}##1}\xspace}% 
	\def\tvar##1{\xspace{\color{Purple}##1}\xspace}% type variable
	\def\svar##1{\xspace{\color{Blue}##1}\xspace}% schematic variable
	\def\Kw##1{{\isa@Kw##1}}%
	\def\InKw##1{{\isa@InKw##1}}%
	\def\St##1{{\isa@St##1}}%
	\def\Pr##1{{\isa@Pr##1}}%
	\def\Tac##1{{\isa@Tac##1}}%
	% predefined keywords
	\def\theory{\St{theory}}%
	\def\imports{\Kw{imports}}%
	\def\lemma{\St{lemma}}%
	\def\theorem{\St{theorem}}%
	\def\corollary{\St{corollary}}%
	\def\proposition{\St{proposition}}%
	\def\definition{\St{definition}}%
	\def\abbreviation{\St{abbreviation}}%
	\def\liftdefinition{\St{lift_definition}}%
	\def\primrec{\St{primrec}}%
	\def\fun{\St{fun}}%
	\def\function{\St{function}}%
	\def\termination{\St{termination}}%
	\def\partialfun{\St{partial_function}}%
	\def\declare{\St{declare}}%
	\def\context{\St{context}}%
	\def\private{\Kw{private}}%
	\def\locale{\St{locale}}%
	\def\sublocale{\St{sublocale}}%
	\def\interpretation{\St{interpretation}}%
	\def\interpret{\St{interpret}}%
	\def\class{\St{class}}%
	\def\subclass{\St{subclass}}%
	\def\instantiation{\St{instantiation}}%
	\def\instance{\St{instance}}%
	\def\consts{\St{consts}}%
	\def\datatype{\St{datatype}}%
	\def\typedef{\St{typedef}}%
	\def\quotienttype{\St{quotient_type}}%
	\def\typesyn{\St{type_synonym}}%
	\def\instantiation{\St{instantiation}}%
	\def\ibegin{\Kw{begin}}%
	\def\iend{\Kw{end}}%
	\def\iin{\Kw{in}}%
	\def\assumes{\Kw{assumes}}%
	\def\and{\Kw{and}}%
	\def\is{\Kw{is}}%
	\def\for{\Kw{for}}%
	\def\shows{\Kw{shows}}%
	\def\fixes{\Kw{fixes}}%
	\def\defines{\Kw{defines}}%
	\def\rewrites{\Kw{rewrites}}%
	\def\where{\Kw{where}}%
	\def\proof{\St{proof}}%
	\def\ilet{\St{let}}%
	\def\infix{\Kw{infix}}%
	\def\infixl{\Kw{infixl}}%
	\def\infixr{\Kw{infixr}}%
	\def\assume{\Pr{assume}}%
	\def\fix{\Pr{fix}}%
	\def\define{\Pr{define}}%
	\def\obtain{\Pr{obtain}}%
	\def\case{\Pr{case}}%
	\def\have{\St{have}}%
	\def\show{\Pr{show}}%
	\def\thus{\Pr{thus}}%
	\def\from{\St{from}}%
	\def\then{\St{then}}%
	\def\with{\St{with}}%
	\def\moreover{\St{moreover}}%
	\def\ultimately{\St{ultimately}}%
	\def\also{\St{also}}%
	\def\finally{\St{finally}}%
	\def\hence{\St{hence}}%
	\def\note{\St{note}}%
	\def\next{\St{next}}%
	\def\using{\St{using}}%
	\def\unfolding{\St{unfolding}}%
	\def\by{\St{by}}%
	\def\apply{\Tac{apply}}%
	\def\done{\Tac{done}}%
	\def\qed{\St{qed}}%
	\def\thm{\St{thm}}%
	\def\sledgehammer{\St{sledgehammer}}%
	\def\nitpick{\St{nitpick}}%
	\def\nunchaku{\St{nunchaku}}%
	\def\implies{\imath\Longrightarrow}%
	\def\all{\imath\bigwedge}%
	\def\eq{\imath\equiv}%
	\def\To{\imath\Rightarrow}%
	\def\ALL{\imath\forall}%
	\def\EX{\imath\exists}%
	\def\TO{\imath\rightarrow}%
	\def\IMP{\imath\longrightarrow}%
	\def\OR{\imath\vee}%
	\def\AND{\imath\wedge}%
	\def\NEG{\imath\neg}%
	\def\IFF{\imath\longleftrightarrow}%
	\def\IN{\imath\in}%
	\def\If{\InKw{if}}%
	\def\Then{\InKw{then}}%
	\def\Else{\InKw{else}}%
	\def\Let{\InKw{let}}%
	\def\In{\InKw{in}}%
	\def\Case{\InKw{case}}%
	\def\Of{\InKw{of}}%
	\def\comment##1{{\isa@Comm(* ##1 *)}}%
	\def\syntaxelement##1{$\langle${\it##1\/}$\rangle$}%
	\def\method{\syntaxelement{method}}%
	\def\params{\syntaxelement{params}}%
	\def\fact{\syntaxelement{fact}}%
	\def\noproof{\syntaxelement{proof}}%
	\def\isar{\syntaxelement{isar}}%
	\catcode`<\active\let<\isa@lt
	\catcode`>\active\let>\isa@gt
	\catcode`|\active\let|\isa@bar
	\catcode`-\active\let-\isa@hyp
	\catcode`+\active\let+\isa@plus
	\catcode`*\active\let*\isa@ast
	\catcode`(\active\let(\isa@lpa
	\catcode`)\active\let)\isa@rpa
	\catcode`'\active\let'\isa@apos
	\catcode`,\active\let,\isa@com
	\catcode`.\active\let.\isa@dot
	\catcode`[\active\let[\isa@lbracket
	\catcode`]\active\let]\isa@rbracket
	\catcode`:\active\let:\isa@col
	\catcode`=\active\let=\isa@eq
	\catcode`_\active\let_\isa@us
	\catcode`^\active\let^\isa@hat%
	\let\{\isa@lbrace
	\let\}\isa@rbrace
	\catcode`"\active\def"##1"{\xspace\inner{\isa@openIn##1\unskip\isa@closeIn}}%
	\catcode` \active\let \isa@sp%
	\xspaceaddexceptions{\isa@sp}%
	\def\isa@indent@{\@ifnextchar {\isa@indent@@}{\@ifnextchar|{\isa@indent@bar}{}}}%
	\def\isa@indent@@ {\isa@indent\isa@indent@}%
	\def\isa@indent@bar|{\isa@barindent\isa@indent@}%
	\isa@defcr{\mbox{}\\\isa@indent@}%
}
\endgroup

\def\isa@end#1{\textrm{\isa@style#1\/}\egroup}%
\def\isa{\bgroup\isa@enter\isa@end}%follows the arguments

% replacing the isabelle environment.
\newenvironment{isabelle}{\parindent=0pt%
\begin{trivlist}\item\isa@enter\isa@style\@gobblecr%
}{\unpenalty\unskip\unpenalty\end{trivlist}}

\ifxetex
	\catcode`⟹\active\def⟹{\imath{\Longrightarrow}}%
	\catcode`⇒\active\def⇒{\imath{\Rightarrow}}%
	\catcode`⋀\active\def⋀{\imath{\bigwedge}}%
	\catcode`λ\active\defλ{\imath{\lambda}}%
	\catcode`❙\active\def❙#1{{\bfseries\boldmath#1}}%
	\catcode`∃\active\def∃{\imath{\exists}}%
	\catcode`∀\active\def∀{\imath{\forall}}%
	\catcode`≤\active\def≤{\imath{\le}}%
	\catcode`≥\active\def≥{\imath{\ge}}%
	\catcode`∈\active\def∈{\imath{\in}}%
	\catcode`⊆\active\def⊆{\imath{\subseteq}}%
	\catcode`⟶\active\def⟶{\imath{\longrightarrow}}%
	\catcode`⟷\active\def⟷{\imath{\longleftrightarrow}}%
	\catcode`∧\active\def∧{\imath{\wedge}}%
	\catcode`∨\active\def∨{\imath{\vee}}%
	\catcode`¯\active\def¯{\sup{-}}%
	\catcode`≠\active\def≠{\imath{\neq}}%
	\catcode`≡\active\def≡{\imath{\equiv}}%
	\catcode`⇩\active\def⇩{\sub}%
	\catcode`⇧\active\def⇧{\sup}%
	\catcode`⊑\active\def⊑{\imath{\sqsubseteq}}%
	\catcode`⊒\active\def⊒{\imath{\sqsupseteq}}%
	\catcode`⊏\active\def⊏{\imath{\sqsubset}}%
	\catcode`≼\active\def≼{\imath{\preceq}}%
	\catcode`∼\active\def∼{\imath{\sim}}%
	\catcode`⋂\active\def⋂{\imath{\bigcap}}%
	\catcode`⊥\active\def⊥{\imath{\bot}}%
\fi

\ExecuteOptions{sf}
\ExecuteOptions{color}

\ProcessOptions\relax

