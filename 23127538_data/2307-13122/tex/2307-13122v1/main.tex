\pdfoutput=1
\documentclass[shortAfour, sageh, times]{sagej}
\input{preprint_formatting.tex}
\usepackage[utf8]{inputenc}

\makeatletter % Change subsubsections headings to be clearer
\renewcommand\subsubsection{\@startsection{subsubsection}{3}{\z@}%
                                     {0.9\@bls plus .3\@bls minus .1\@bls}%
                                     {4pt\@afterindentfalse}%
                                     {\sagesf\large\itshape\raggedright}}
\makeatother

% \paperwidth=\dimexpr \paperwidth + 6cm\relax
% \oddsidemargin=\dimexpr\oddsidemargin + 3cm\relax
% \evensidemargin=\dimexpr\evensidemargin + 3cm\relax
% \marginparwidth=\dimexpr\marginparwidth + 2cm\relax
% \usepackage{todonotes}
% \usepackage[disable]{todonotes}

% \usepackage{graphicx}
% \usepackage{amsmath}
% \usepackage{amsfonts}
% \usepackage{amssymb}
% \usepackage{amsthm}
% \usepackage{booktabs} % horizontal rules for tables
\usepackage{xcolor} % Colored text for comments
\usepackage{hyperref} % hyperlinks for urls and references

\usepackage[subrefformat=parens,labelformat=parens]{subfig} % https://tex.stackexchange.com/questions/16291/adding-parentheses-around-subfig-references
\usepackage{flushend} % Equal columns in last page

% https://tex.stackexchange.com/questions/10924/underfull-hbox-in-bibliography
\usepackage{etoolbox}
\apptocmd{\sloppy}{\hbadness 10000\relax}{}{}



% \overfullrule=1mm

% \usepackage{refcheck} % Check for unused references with \nocite{*}

% %%%%%%%%%%%%%%%%%%%%%%%%
% % Show frame around each column
% \usepackage{showframe}
% \newlength\Fcolumnseprule
% \setlength\Fcolumnseprule{0.4pt}

% \makeatletter
% \def\@outputdblcol{%
%   \if@firstcolumn
%     \global \@firstcolumnfalse
%     \global \setbox\@leftcolumn \box\@outputbox
%   \else
%     \global \@firstcolumntrue
%     \setbox\@outputbox \vbox {%
%                          \hb@xt@\textwidth {%
%                            \hb@xt@\columnwidth {%
%                              \box\@leftcolumn \hss}%
%                            \vrule \@width\Fcolumnseprule\hfil
%                                 {\normalcolor\vrule \@width\columnseprule}%original:
%                                                 %\normalcolor\vrule \@width\columnseprule
%                            \hfil\vrule \@width\Fcolumnseprule
%                            \hb@xt@\columnwidth {%
%                              \box\@outputbox \hss}%
%                                              }%
%                               }%
%     \@combinedblfloats
%     \@outputpage
%     \begingroup
%       \@dblfloatplacement
%       \@startdblcolumn
%       \@whilesw\if@fcolmade \fi
%         {\@outputpage
%          \@startdblcolumn}%
%     \endgroup
%   \fi
% }
% \makeatother
% %%%%%%%%%%%%%%%%%%%%%%%%

% \newcommand{\AEtodo}[1]{\begingroup \color{red}TODO: #1 \endgroup}

\DeclareMathOperator*{\argmax}{arg\,max}
\DeclareMathOperator*{\argmin}{arg\,min}

\def\calO{{\mathcal O}}
\def\calE{{\mathcal E}}
\def\Rot{{\cal R}}
\def\rot{{\tt R}}
\def\norm#1{\left\|{#1}\right\|}

\def\tr{^T}
\def\sq{^2}
\def\inv{^{-1}}
\def\cross{^\times}
\def\rr#1{\mathbb{R}^{#1}}

\setcounter{secnumdepth}{3} % submitting to a SAGE journal that requires numbered sections (for example, IJRR)
\begin{document}

\runninghead{Elias and Wen}

% IJRR says to only capitalize first word of title
\title{Redundancy parameterization and inverse kinematics of 7-DOF revolute manipulators}
\author{Alexander~J.~Elias and John~T.~Wen}
\affiliation{Department of Electrical, Computer, and Systems Engineering, Rensselaer Polytechnic Institute, Troy, NY}
\corrauth{Alexander J. Elias, Rensselaer Polytechnic Institute, Troy, NY.}

\email{eliasa3@rpi.edu}

\begin{abstract} % IJRR has 250 word limit for abstract
Seven degree-of-freedom (DOF) robot arms have one redundant DOF which does not change the translational or rotational motion of the end effector. The redundant DOF offers greater manipulability of the arm configuration to avoid obstacles and steer away from singularities, but it must be parameterized to fully specify the joint angles for a given end effector pose.
For 7-DOF revolute (7R) manipulators, we introduce a new concept of generalized shoulder-elbow-wrist (SEW) angle, a generalization of the conventional SEW angle but with an arbitrary choice of the reference direction function. The SEW angle is easy for human operators to visualize as a rotation of the elbow about the line from the shoulder to the wrist and has been used in the teleoperation of space robot arms.
Since the conventional SEW angle formulation is prone to singularities, we introduce a special choice of the reference direction function called the stereographic SEW angle which has a singularity in only one direction in the workspace. We prove that such a singularity is unavoidable for any parameterization.
We also include expressions for the SEW angle Jacobian along with singularity analysis. Finally, we provide inverse kinematics solutions for most known 7R manipulators using the general SEW angle and the subproblem decomposition method. These solutions are often closed-form but may sometimes involve a 1D or 2D search. Inverse kinematics solutions, examples, and evaluations are available in a publicly accessible repository.
\end{abstract}

\keywords{ % Min 3, max 6, see IJRR_keywords.txt
Kinematics,
Redundant Robots,
Industrial Robots,
Space Robotics and Automation,
Telerobotics and Teleoperation,
Humanoid Robot Systems}

\maketitle

\section{Introduction}
Most industrial robot arms have six revolute joints to control the six degrees of freedom (DOF) of the robot end effector pose,
but a human arm has seven DOF: three for the  shoulder, one for the elbow, and three for the wrist. Similarly, there are 7-DOF revolute (7R) robot arms such as the 
    Robotics Research Corporation (RRC) arm \citep*{RRC},
    Baxter \citep*{baxter},
    Sawyer \citep*{sawyer},
    Yumi \citep*{ABB_YUMI},
    and the Space Station Robot Manipulator System (SSRMS) \citep*{crane1991kinematic}.
The extra {\em redundant} degree of freedom means that there is a continuum of arm configurations for a given hand or robot end effector pose. Holding the end effector pose constant while moving through the continuum of arm configurations, called self-motion, commonly looks like the elbow rotating around the line passing from the shoulder to the wrist (Figure~\ref{fig:manifold}).
Benefits of 7R arms over 6R arms include using redundancy to
    avoid singularities and obstacles \citep*{hollerbach1985optimum},
    optimize motion time \citep*{chen2023kinematics},
    avoid joint motion limits \citep*{flacco2012motion},
    and avoid joint torque limits \citep*{hollerbach1987redundancy}.

To fully specify the pose of a 7R robot up to a finite number of solutions, the end effector pose must be augmented by a secondary task.
During pure self-motion, the only difference between parameterizations would be the rate of movement; differences between parameterizations are made clearer during motion of the end effector.
Redundancy in human and many 7R robot arms may be conveniently parameterized by the shoulder-elbow-wrist (SEW) angle, sometimes called the elbow angle, which characterizes the rotation of the plane containing the shoulder, elbow, and wrist about the shoulder-wrist line with respect to a reference plane. This reference plane is conventionally chosen as the plane containing the shoulder-wrist line and a reference vector. This redundancy parameterization is easy to visualize. Furthermore, for certain 7R arms, the inverse kinematics has an analytical solution, i.e., for a given robot end effector pose and SEW angle, the finite set of the seven robot joint angles may be solved directly instead of iteratively. The augmented Jacobian, the $7\times7$ matrix that maps the joint velocity vector to the end effector spatial velocity and the SEW angular velocity, is easily characterized. 
% Figure environment removed

An issue with the conventional SEW angle becomes apparent when the shoulder-wrist line is collinear with the reference vector because the reference plane becomes undefined. This is referred to as an {\em algorithmic singularity}, a singularity due to the choice of redundancy parameterization.

In this paper, we introduce a new generalized concept of SEW angle which includes the conventional SEW angle as a special case.  We show that an algorithmic singularity is unavoidable for any redundancy parameterization, but a special choice of the generalized SEW angle based on the stereographic projection changes the bidirectional singularity to a unidirectional singularity. The singularity direction may be located towards the base of the arm so it will not be encountered in the robot workspace. The advantages of SEW angle redundancy parameterization are still retained for the generalized SEW angle, including analytical inverse kinematics for many 7R arms, intuitive teleoperation, and an analytical Jacobian.

We also provide inverse kinematics (IK) solutions using the general SEW angle and the subproblem decomposition method \citep*{elias2022canonical} for most 7R robots used in practice or mentioned in the literature. The solutions are often closed-form, but for some robots IK is solved using a 1D or 2D search.

The remainder of the paper is organized as follows.
In Section~\ref{sec:background} we discuss previous related works, and we describe forward kinematics for 7R arms using coordinate-free notation and the product of exponentials approach.
We introduce the general SEW angle in Section~\ref{sec:gen_SEW} including forward and differential kinematics, we  discuss singularity conditions, and we relate it to the conventional SEW angle.
In Section~\ref{sec:singularityexistence} we prove the existence of algorithmic singularities for any redundancy parameterization.
We define the stereographic SEW angle in Section~\ref{sec:stereographic_SEW_angle}, discuss its relationship to stereographic projection and its singularity behavior, and we provide an example comparing using the conventional and stereographic SEW angle formulations.
We provide IK solutions in Section~\ref{sec:IK}, and we conclude in Section~\ref{sec:conclusion}.

Inverse kinematics solutions, examples, and evaluations are available in a publicly accessible repository\footnote{\url{https://github.com/rpiRobotics/stereo-sew}}.

\section{Background}\label{sec:background}
\subsection{Robot Notation}
To notate different families of robot kinematic parameters, we follow and slightly extend the notation introduced by \cite*{pieper1969kinematics}. A single revolute joint is notated by R, and when multiple joints intersect, they may be notated as 2R or 3R for two or three intersecting joints, respectively. The order of joints is given in order from the base to the end effector. For example, a robot with a spherical shoulder, a revolute elbow, and a spherical wrist may be notated as 3R-R-3R. We also introduce the notation of 2R\textbar\textbar{} and 3R\textbar\textbar{} to indicate two or three consecutive parallel revolute joints. Note that since a given joint may intersect or be parallel with both the joint before it and the joint after it, a single robot may fall into multiple robot kinematic families.

We use superscript S, E, or W to indicate when the shoulder, elbow, or wrist is placed at a joint or joint intersection. For example, 2R\textsuperscript{E} would indicate a 2R joint with the elbow placed at the joint intersection. Unless otherwise indicated, a robot has its shoulder on the first joint or joint intersection and has its wrist on its last joint or joint intersection.

\subsection{Related Literature}
The analysis and parameterization of the redundant degree of freedom in 7R manipulators has been primarily driven by space robotics applications and more recently motivated by industrial robots in manufacturing and humanoid robots.
Early papers focused on analyzing the geometry, topology, and differential kinematics of 7-DOF manipulators. \cite*{baillieul1985kinematic} introduced the concept of the augmented Jacobian (termed the extended Jacobian) and discussed the algorithmic singularity. \cite*{hollerbach1985optimum} discussed options for 7-DOF manipulator designs, including how adding an extra degree of freedom removes internal singularities. The paper discusses the self-motion manifold and was one of the earliest papers to recommend using the conventional SEW angle (with the reference vector pointing up). \cite*{burdick1989characterization} gave an overview of the topology of the self-motion manifold. \cite*{kreutz1990kinematic,kreutz1992kinematic}
provided a detailed analysis of the conventional SEW angle with application to 3R-R-3R arms and the RRC arm, which has no intersecting joint axes. They also provided the expression for the SEW Jacobian and singularity analysis.

There have been several other proposed redundancy parameterizations besides the conventional SEW angle. \cite*{yan2014analytical} attempted to address the singularity issue of the conventional SEW angle by proposing a method which picks two different reference vectors and switches between the corresponding SEW angles when one of them encounters a singularity. The resulting parameterization is non-smooth, and singularities would still be present.
\cite*{shimizu2007practical} used the SEW angle where the reference plane is formed by the elbow when joint three is zero. They explained the reference plane is undefined in a shoulder or elbow singularity, so there is no benefit in terms of singularity existence as compared to the conventional SEW angle.

One can also parameterize the redundant DOF by choosing one joint angle and reducing the problem to the IK of a non-redundant 6R manipulator, but this introduces singularities resulting from the equivalent 6R robot.
    \cite*{xu2014analytical} found the inverse kinematics for a 2R-3R\textbar\textbar-2R arm by parameterizing the redundant degree of freedom with any joint angle.
    \cite*{jiang2013integrated} found the R-R-3R-2R arm IK solution by parameterizing joint 1.
    \cite*{an2014analytical} found the IK solution for a 2R-2R-3R arm by parameterizing joint 1.
    \cite*{tondu2006closed} found IK for a 3R-R-3R arm by parameterizing joint 1, and \cite*{pfurner2016closed} found the IK for a 3R-R-3R arm by parameterizing joint 2 or 3.
    \cite*{nammoto2012analytical} found the IK solutions for an R-R-3R-2R arm parameterized by joint 1.
    \cite*{sinha2019geometric} found a 1D search-based IK for R-2R-2R-2R arms parameterized by joint 1.

Many papers provide inverse kinematics solutions using the conventional SEW angle.
    \cite*{gong2019analytical, tian2021analytical, faria2018position} used the conventional SEW angle to provide closed-form IK for 3R-R-3R arms.
    \cite*{an2014analytical} found a closed-form IK solution for 2R-2R-3R arms.
Many papers used an iterative IK method with an approximate closed-form solution as a starting point:
    \cite*{wang2021inverse} for an R-2R-R-3R arm, and
    \cite*{ma2021precise} for a 2R-3R\textbar\textbar-2R arm. \citep*{zhao2023inverse} also found an iterative solution for an 2R-3R\textbar\textbar-2R. The paper states closed-form IK is not possible when using SEW angle.
However, \citep*{jin2020efficient} solved IK for a 2R-3R\textbar\textbar-2R manipulator in closed form by defining the SEW plane to be perpendicular to joint axes 3, 4, and 5.

There are also applications of the conventional SEW angle not just to typical 7-DOF robots, but also to human arms and wearable robots \citep*{
kim2011redundancy,
kim2012redundancy,
li2013rotational,
wang2013closed,
liu2017analytical,
su2018online,
wang2019kinematic,
li2022human}.
The conventional SEW angle can also be used to help with redundancy resolution. \cite*{lamperti2015redundancy} used conventional SEW angle to propose a human-like redundancy resolution method. \cite*{xiong2020null} used the conventional SEW angle to parameterize the redundant degree of freedom for null-space impedance control. Algorithmic singularities remain an issue in these methods and would need to be avoided. They are not explicitly addressed in these papers.

\subsection{Robot Kinematics}
\begin{table}[t]
    \small\sf\centering
    \caption{Nomenclature.}
    \begin{tabular}{l @{\quad} l}
        \toprule
        \multicolumn{2}{l}{Coordinate-Free Notation}\\
        \midrule
        $\calO$     &  Point in Euclidean space. \\
        $\vec p$    &  Vector in Euclidean space. \\
        $\calE$     &  Orthonormal frame, \(=[ \vec e_x \  \vec e_y \ \vec e_z]\). \\
        $\Rot(\vec h,\theta)$ & Rotation operator about $\vec h$ over angle $\theta$. \\
        \midrule
        \multicolumn{2}{l}{Robot Kinematics}\\
        \midrule
        \(\calO _S\) & Shoulder. \\
        \(\calO _E\) &  Elbow. \\
        \(\calO _W\) & Wrist. \\
        \(\calO _C\) & Projection of elbow on shoulder-wrist line. \\
        \(J\)   & End effector Jacobian.\\
        \(J_E\) & Elbow Jacobian. \\
        \(J_W\) & Wrist Jacobian. \\
        \midrule
        \multicolumn{2}{l}{General SEW Angle}\\
        \midrule
        \(k_{SEW}\) & \(= p_{SW}^\times p_{SE}\). \\
        \(n_{SEW}\) & \(= k_{SEW} / \norm{k_{SEW}}\). SEW plane normal. \\
        \(\psi\) & SEW angle.\\
        \(e_x {=} f_x(p_{SW})\) & Reference direction function.\\
        \((e_x,e_y, e_{SW})\) & SEW angle coordinate frame.\\
        \(J_{f_x}\) & Reference direction Jacobian w.r.t. \(p_{SW}\).\\
        \(J_\psi\) & SEW angle Jacobian. \\
        \(J_A\) & Augmented Jacobian. \\
        \midrule
        \multicolumn{2}{l}{Conventional SEW Angle}\\
        \midrule
        \(e_r\) & Arbitrary unit \underline{r}eference vector. \\
        \(k_y\) & \(= p_{SW}^\times e_r\), meaning \(e_y = k_y / \norm{k_y}\). \\
        \midrule
        \multicolumn{2}{l}{Stereographic SEW Angle}\\
        \midrule
        \(e_t\) & Unit \underline{t}ranslation vector. \\
        \(k_{rt}\) & \(= (e_{SW} - e_t)^\times e_r\).\\
        \(k_x\) & \(= k_{rt} ^\times p_{SW}\), meaning \(e_x = k_x / \norm{k_x}\). \\
        \bottomrule
    \end{tabular}

    \label{tab:nomenclature}
\end{table}
We use the coordinate-free notation shown in Table~\ref{tab:nomenclature}. Vector $\vec p$ represented in frame $\calE_a$ is the $\rr 3$ vector $p_a = \calE_a^* \vec p$, where
\begin{equation}
\calE_a^*=\begin{bmatrix} \vec e_x \cdot \\ \vec e_y \cdot \\ \vec e_z \cdot \end{bmatrix}
\end{equation}
is the adjoint of $\calE_a$. Frame $\calE_b$ represented in frame $\calE_a$ is the $SO(3)$ matrix $R_{ab}=\calE_a^* \calE_b$. Rotation $\Rot(\vec h,\theta)$ in frame $\calE_a$ is the $SO(3)$ matrix ${\tt R}(h_a,\theta)=e^{h_a^\times \theta}$, where $(\cdot)^\times$ is the $3\times 3$ skew-symmetric matrix representation of the cross product:
\begin{equation}
    h^\times := \begin{bmatrix}  0 & -h_z & h_y \\ h_z & 0 & -h_x \\ -h_y & h_x & 0 \end{bmatrix}.
\end{equation}
For a unit vector \(h\), \(-h^{\times^2} = -h^\times h^\times = I - h h\tr\) is the projector onto the orthogonal complement of \(h\).



Consider a 7R robot as shown in Figure~\ref{fig:arbitrary_7_dof} with joint angles \(q = [q_1 \ q_2 \ \cdots \ q_7]\tr\).
We will use the product of exponentials approach to describe the arm kinematics.
Denote the base frame and base frame origin as \((\calE_0, \calO_0)\) and the end effector task frame and task frame origin as \((\calE_T, \calO_T)\).
Choose the link frame origins $\calO_i$ along each unit joint axis $\vec h_i$.
Let $\vec p_{ij}$ be the vector from $\calO_{i}$ to $\calO_j$. Define the $i$th frame $\calE_i=\Rot(\vec h_i, q_i)\calE_{i-1}$. 
Then the forward kinematics of the task frame represented in the base frame is
\begin{subequations}\label{eq:fwdkin}
\begin{align}
R_{0T} ={}& R_{01}R_{12}R_{23}R_{34}R_{45}R_{56}R_{67}R_{7T}\\
\begin{split}
p_{0T} ={}& p_{01}+R_{01}p_{12}+R_{02}p_{23}+R_{03}p_{34} \\
{}& + R_{04}p_{45} + R_{05} p_{56} + R_{06} p_{67} + R_{07} p_{7T}
\end{split}
\end{align}
\end{subequations}
where \(R_{ij}=R_{i,i+1}\dotsm R_{j-1,j}\), $h_i$ and $p_{i-1,i}$ are constant $\rr 3$ vectors representing $\vec h_i$ and $\vec p_{i-1,i}$ in $\calE_{i-1}$, \(R_{i-1,i}= e^{h_i^\times q_i}\) is $\Rot(\vec h_i,q_i)$ represented in $\calE_{i-1}$, $R_{7T}$ is a constant $SO(3)$ matrix for the fixed wrist-tool transform, and $p_{7T}$ is the constant tool offset in the 7 frame. The constant vectors $h_i$, $p_{i-1,i}$, $p_{7T}$ and constant transform $R_{7T}$ are obtained by putting the arm in the zero configuration $q=0$.

% Figure environment removed

Define three points \(\mathcal O_S\), \(\mathcal O_E\), and \(\mathcal O_W\) to represent the robot shoulder, elbow, and wrist, respectively. The location for these points are arbitrary, but different choices will lead to different inverse kinematics methods and different singularity structures. For easier inverse kinematics, \(\mathcal O_S\) should be constant in the base frame and \(\calO_W\) should be constant in the 7 frame (which also means it is constant in the tool frame). \(\calO_E\) must be placed somewhere in the kinematic chain such that it rotates around the line passing through \(\calO_S\) and \(\calO_W\) as the robot moves through its redundant degree of freedom while keeping the end effector pose constant. For many robots, a good choice is to make \(\calO_E\) constant in frame \(\calE_3\) or \(\calE_4\). 
In this paper, we will use $\calE_3$ for illustration. Representing these points in their respective constant frames, we have constant vectors \(p_{0S}\), \(p_{3E}\), and \(p_{7W}\).
For a given pose, we can find \(p_{SE}\), \(p_{SW}\), and \(p_{SW}\), which are \(\vec p_{SE}\), \(\vec p_{SW}\), and \(\vec p_{SW}\) represented in \(\calE_0\). The shoulder-wrist vector is
\begin{equation}
    p_{SW} = p_{0T} - R_{07}p_{7T} + R_{07}p_{7W} - p_{0S},
    \label{eq:p_SW}
\end{equation}
and the shoulder-elbow vector is
\begin{equation}
    p_{SE} = p_{01}+R_{01}p_{12}+R_{02}p_{23}+R_{03}p_{3E} - p_{0S}.
\end{equation}
It is often helpful for the inverse kinematics solution to set the shoulder, elbow, or wrist offset vector to \(0\) so that \(\calO_S\), \(\calO_E\), or \(\calO_W\) is coincident with the link frame origin.

On some robots, such as those with three consecutive parallel axes, it may be helpful to define the shoulder-elbow vector \(p_{SE}\) to be a unit vector \(e_{SE}\) which is equal to one of the joint axes represented in the base frame. For example, we may pick \(p_{SE} = e_{SE} = R_{02}h_3\). Since three parallel joint axes are the limit of three intersecting axes where the point of intersection moves infinitely far away, this can be interpreted as choosing \(p_{SE}\) to be the normalized vector pointing at this intersection (Figure~\ref{fig:three_parallel_limit}). For some robots this leads to closed-form inverse kinematics using the subproblem decomposition approach.
% Figure environment removed

\section{General SEW Angle}\label{sec:gen_SEW}

\subsection{Kinematics Description}

Consider a 7-DOF arm with shoulder, elbow, and wrist defined. The SEW (shoulder-elbow-wrist) angle \(\psi\), also commonly referred to as the arm angle or swivel angle, is the angle of the shoulder-elbow vector \(p_{SE}\) about the shoulder-wrist vector \(p_{SW}\) with respect to some reference vector. Consider an arbitrary mapping, called the reference direction function, from the shoulder-wrist vector \(p_{SW}\) to a unit vector \(e_x\) that is orthogonal to \(p_{SW}\). Denote this mapping by \(e_x = f_x(p_{SW})\). From this we can form an orthonormal basis \((e_x,\ e_y,\ e_{SW})\), where \(e_{SW}\) is the normalized \(p_{SW}\) and \(e_y=e_{SW}^\times e_x\). This frame may be used to measure the SEW angle.

% Figure environment removed

There are two equivalent definitions of the SEW angle, as shown in Figure~\ref{fig:axes_2d}. The elbow definition is that \(\psi\) is the angle between shoulder-elbow vector \(p_{SE}\) and reference vector \(e_x\) measured along the shoulder-wrist rotational axis \(e_{SW}\). The plane definition is that \(\psi\) is the angle between \(n_{SEW}\), which is the normal vector of the SEW plane containing the shoulder, elbow and, wrist, and \(e_y\), which is the normal vector of the reference plane containing the shoulder, wrist, and reference vector \(e_x\). While the elbow definition is helpful for forward kinematics, the plane definition is more useful for inverse kinematics when using the subproblem decomposition approach.

Using the elbow definition, the SEW angle is
\begin{equation}
    \psi = \argmin_\theta \norm{ \rot(e_{SW}, \theta) e_x - p_{SE} }.
\end{equation}
We can also rewrite this more compactly by removing the component of \(p_{SE}\) along \(e_{SW}\). Let $\calO_C$ be the point on $p_{SW}$ such that $p_{CE}$ is orthogonal to $e_{SW}$, i.e.,
\begin{equation} \label{eq:p_CE}
        p_{CE} = -e_{SW}^{\times^2} p_{SE}.
\end{equation}
Then, 
\begin{equation} \label{eq:e_CE}
    e_{CE} = \rot(e_{SW},\psi) e_x,
\end{equation}
where \(e_{CE} = p_{CE} / \norm{p_{CE}}\).

Using the plane definition, the SEW angle is 
\begin{equation} \label{eq:n_SEW}
    n_{SEW} = \rot(e_{SW},\psi) e_y,
\end{equation}
where the normal of the plane containing the shoulder, elbow, and wrist is
\begin{subequations}
\begin{align}
    n_{SEW} &= \frac{k_{SEW}}{\norm{k_{SEW}}},\\ \label{eq:nsew}
    k_{SEW} &= p_{SW}^\times p_{SE}.
\end{align}
\end{subequations}
Subproblem~1 \citep*{elias2022canonical} may be used to solve the forward kinematics for the SEW angle, which is
\begin{subequations}
\begin{align}
    \psi &= \mbox{atan2}\left(
    e_y\tr p_{SE},
    e_x\tr p_{SE}
    \right)\\
    &= \mbox{atan2}\left( \label{eq:psi_p_CE}
    e_y\tr p_{CE},
    e_x\tr p_{CE}
    \right)\\
    &= \mbox{atan2}\left(
    -e_x\tr n_{SEW},
    e_y\tr  n_{SEW}
    \right)\\
    &= \mbox{atan2}\left(
    -e_x\tr k_{SEW},
    e_y\tr  k_{SEW}
    \right).
\end{align}
\end{subequations}

To perform inverse kinematics, we can use a given \((R_{0T}, p_{0T})\) to find \(p_{SW}\) from \eqref{eq:p_SW}. Next, use the reference direction function \(f_x(p_{SW})\) to find \(e_x\) or \(e_y\). Then, for a given \(\psi\), we can calculate \(e_{CE}\) or \(n_{SEW}\) using \eqref{eq:e_CE} or \eqref{eq:n_SEW}, respectively, which may then be used to determine the joint angle vector \(q\). For the subproblem decomposition approach in Section~\ref{sec:IK}, we always calculate \(n_{SEW}\).

Some robots are not easily parameterized using the SEW angle. For example, the FANUC R-1000iA/120F-7B is an R-3R\textbar\textbar-3R robot \citep*{fanuc}. The redundant degree of freedom in this family of robots is the movement of joints 2, 3, and 4, along with the corresponding movement in the spherical wrist, which results in the shortening or lengthening of the distance between joints 2 and 4 \citep*{shi2021kinematics}. However, with \(\calO_S\) placed at joint 1 and \(\calO_W\) placed at the spherical wrist, there is no movement of joints 2, 3, or 4 around \(e_{SW}\) during self-motion; they stay in the same half plane and the SEW angle would fail to parameterize the redundant degree of freedom. Robots such as this are better parameterized by specifying a joint angle. (A good choice for this robot is \(q_3\).)

To find the Jacobian of the SEW angle with respect to the joint angles, \(J_\psi\), we will write it in terms of the partial Jacobians mapping joint angular velocities to the linear velocity of $\calO_E$ and $\calO_W$:
\begin{equation}
\dot p_{SE}  = \dot p_{0E} = J_{E} \dot q,  \quad
\dot p_{SW}  = \dot p_{0W} = J_{W} \dot q 
\end{equation}
If \(\calO_S\) is not constant in the base frame, then \(J_S\) is nonzero and we must subtract  \(J_S \dot q\).

Taking the total derivative of \eqref{eq:psi_p_CE}, we obtain
\begin{equation} \label{eq:total_derivative}
    \dot \psi = \frac{1}{\norm{p_{CE}}} (e_{SW}^\times e_{CE})\tr \dot p_{CE} - e_y \tr \dot e_x.
\end{equation}
Geometrically, these two terms are the angular velocities of \(p_{CE}\) and \(e_x\) around the axis of rotation \(e_{SW}\). Define \(J_{f_x}\) such that \(\dot e_x = J_{f_x} \dot p_{SW}\), which depends on the choice for the function \(f_x(p_{SW})\). Then by using \eqref{eq:p_CE}, we can expand \eqref{eq:total_derivative} as
\begin{multline}
    \dot \psi =
    \frac{1}{\norm{p_{CE}}} (e_{SW}^\times e_{CE})\tr \dot p_{0E}\\
    - \left( e_y\tr J_{f_x} + \frac{e_{SW}\tr p_{SE}}{\norm{p_{SW}}\norm{p_{CE}}} (e_{SW}^\times e_{CE})\tr 
     \right) \dot p_{0W}
\end{multline}
Since we have
\begin{equation}
    \dot \psi = J_\psi \dot q
\end{equation}
we can write the SEW Jacobian as
\begin{equation}
    J_\psi = J_{\psi, E} J_E + J_{\psi, W} J_W ,
\end{equation}
where
\begin{align}
    J_{\psi, E} &= \frac{(e_{SW}^\times e_{CE})\tr}{\norm{p_{CE}}},\\
    J_{\psi, W} &= -e_y\tr J_{f_x}
  - \frac{e_{SW}\tr p_{SE}}{\norm{p_{SW}}\norm{p_{CE}}} (e_{SW}^\times e_{CE})\tr.
\end{align}
We can form the \(7 \times 7\)  augmented Jacobian \(J_A\) by stacking \(J\) and \(J_\psi\):
\begin{equation}
    J_A = \begin{bmatrix}
        J \\ J_\psi
    \end{bmatrix},\ 
    \begin{bmatrix}
        \omega \\ v \\ \dot\psi
    \end{bmatrix} = J_A \dot q.
\end{equation}
The augmented task space, which has the end effector orientation as well as the SEW angle, has 7 degrees of freedom.

\subsection{Singularity Conditions}
\begin{table*}[t]
    \small\sf\centering
    \caption{Singularity conditions. Cases 2 and 3 are both algorithmic singularities.}
    \begin{tabular}{l l l}
        \toprule
        Condition & Singularity Name & Description \\
        \midrule
        1. \(J\) loses rank                                         & Kinematic     & End effector cannot move in one direction\\
        \qquad A. Null space of \(J\) tangent to self-motion manifold & Internal    & Extra continuous self-motion possible\\
        \qquad B. Null space of \(J\) not tangent to self-motion manifold & Boundary& Self-motion is instantaneous\\
        2. \(J_A\) singular (Full rank \(J\) and \(J_\psi\))        & Augmentation  & Self-motion doesn't change SEW angle\\
        3. \(J_\psi\) undefined                                     & SEW Angle     & SEW angle undefined\\
        \qquad A. \(\calO_S\), \(\calO_E\), \(\calO_W\) collinear   & Collinear     & Depends on choice of \(\calO_S\), \(\calO_E\), \(\calO_W\) \\
        \qquad B. \(J_{f_x}\) undefined                             & Coordinate    & Depends on choice of \(f_x(p_{SW})\)\\
        \bottomrule
    \end{tabular}
    \label{tab:singularity_cases}
\end{table*}

When controlling a robot using end effector pose augmented with SEW angle, singularities occur when the matrix \(J_A^{-1}\) does not exist. When a robot is close to a singularity, there may be large internal joint motion which is undesirable and possibly dangerous. There are a number of conditions which result in a singularity, as shown in Table~\ref{tab:singularity_cases}. Multiple singularity types can occur simultaneously.

The self-motion manifold for 7-DOF spatial manipulators is a curve in joint space for which all points map to the same end effector pose \citep*{burdick1989characterization}. A single end effector pose may have multiple self-motion manifolds, where each manifold belongs to a different inverse kinematics branch. This manifold exists independently of any parameterization of the redundant degree of freedom, and the goal of parameterizations such as SEW angle is to assign a value to each point on the self-motion manifold. When \(J\) is full rank, the self-motion manifold is one-dimensional and the null space of \(J\) is the tangent to the self-motion manifold.

A kinematic singularity occurs when \(J\) loses rank, meaning some spatial velocity of the end effector cannot be achieved. This is a condition that depends on the kinematics and joint angles of the robot and does not depend on the parameterization of the redundant degree of freedom. There are two types of kinematic singularities: Internal singularities and boundary singularities. At internal singularities, e.g., when two joint axes are collinear, the null space of \(J\) is tangent to the self-motion manifold. A new degree of freedom for self-motion is introduced, but parameterizations such as the SEW angle may not be able to parameterize this degree of freedom. At boundary singularities, e.g., when two links are collinear, the null space of \(J\) is not tangent to the self-motion manifold, and self-motion is only instantaneous. In some cases, the entire null space of \(J\) causes only instantaneous rather than continuous self-motion, and the self-motion manifold degenerates into a point: The self-motion manifold is zero-dimensional and any parameterization for the redundant degree of freedom is unnecessary because for each inverse kinematics branch there is only one choice for \(\psi\).

For all conditions other than the kinematic singularity, we call them algorithmic singularities as they occur not because of the robot itself but because of the algorithms we use to parameterize the redundancy. Many authors \citep*{kreutz1990kinematic, chiaverini1997singularity, marani2003algorithmic} have defined algorithmic singularities to occur when \(J_A^{-1}\) does not exist and \(J\) and \(J_\psi\) are separately full rank. However, as in \cite*{wang1995identification, faria2018position}, we generalize the definition of algorithmic singularity to include cases where \(J_\psi\) may not be full rank (i.e., may be a zero vector) or may not exist.

One type of algorithmic singularity is when \(J_A\) loses rank, which is possible even when \(J\) and \(J_\psi\) are full rank. We call this the augmentation singularity, as it occurs only when end effector and SEW angle rates are considered simultaneously. Algebraically, this singularity occurs when \(J_\psi\) is linearly dependant with the rows of \(J\). Geometrically, this means self-motion does not cause a change in SEW angle.

The second type of algorithmic singularity is when \(J_A^{-1}\) does not exist because \(J_\psi\) does not exist, which we call the SEW angle singularity. There are two cases for the SEW angle singularity. The first case, called the collinear singularity, happens when \(\calO_S\), \(\calO_E\), and \(\calO_W\) are collinear, which causes \(p_{SW} = 0\) or \(p_{CE} = 0\). The second case, called the coordinate singularity, is when \(J_\psi\) does not exist because \(J_{f_x}\) does not exist. In fact, in section~\ref{sec:singularityexistence}, we show that for any choice of \(f_x(p_{SW})\) there will always be choices of \(p_{SW}\) that causes singularities in \(J_{f_x}\).

Given that the collinear singularity is unavoidable for some robots, it can be beneficial to place  \(\calO_S\), \(\calO_E\), and \(\calO_W\) such that the SEW angle is undefined exactly when there is only one choice for elbow position per IK branch due to boundary singularities. This reduces the total number of singularities in the workspace. In the case of a 2R-2R-3R robot, placing the shoulder, elbow, and wrist at the joint intersections means that SEW angle is undefined when the robot has no self-motion of the elbow to parameterize anyway.

The condition of \(J_\psi\) losing rank, meaning \(J_\psi =0\), may occur for a general parameterization of the redundant degree of freedom, but for most reasonable choices of placement of  \(\calO_S\), \(\calO_E\), and \(\calO_W\), this condition will not occur for the SEW angle. \cite*{choi2004multiple} called this case the secondary task singularity.

\subsection{Conventional SEW Angle}
\label{sec:classicalSEW}
The conventional SEW angle, shown in Figure~\subref*{fig:f_x_conv}, is a widely used parameterization. \cite*{kreutz1990kinematic} were the first to provide detailed analysis of the conventional SEW angle, but the idea was described earlier by \cite*{hollerbach1985optimum}.

Let $e_r$ be an arbitrary unit reference vector. For the conventional SEW angle, we define the reference direction function \(f_x\) as
\begin{subequations}
\begin{align}
    e_x &= f_x(p_{SW}) = e_y^ \times e_{SW},\\
    e_y &= \frac{k_y}{\norm{k_y}},\\
    k_y &= p_{SW} ^ \times e_r.
\end{align}
\end{subequations}
Equivalently, \(e_x= f_x(p_{SW})\) is the normalized \(-e_{SW}^{\times^2}e_r\), so \(e_x\) is the unit vector orthogonal to \(e_{SW}\) closest to \(e_r\).

% Figure environment removed

The conventional SEW angle is intuitive to understand. \(\psi = 0\) corresponds to \(e_{CE}\) pointing as much towards \(e_r\) as possible. This is similar to navigating on a globe using cardinal directions where \(e_r\) provides the north direction and the SEW angle is measured from north. 

The conventional SEW angle becomes undefined and a coordinate singularity occurs when \(k_y = p_{SW}^\times e_r =0\), which occurs when \(p_{SW}\) is collinear with \(e_r\). In this case. all possible choices of \(e_{CE}\) are equally close to \(e_r\).
This is akin to being on the north or south pole of a globe where there is no north direction and cardinal directions are undefined. If the shoulder is constant in the base frame, then this singularity occurs when the wrist is on the line spanned by \(e_r\) passing through the wrist, as shown in Figure~\subref*{fig:singularity_locations_conv}.

% Figure environment removed

Using the elbow definition of the SEW angle, the
conventional SEW angle can be succinctly expressed as
\begin{equation}
    \psi = \argmin_\theta \norm{ \rot(e_{SW}, \theta) e_r - p_{SE} },
\end{equation}
(notice we may use \(e_r\) in place of \(e_x\)), which may be directly solved using Subproblem~1 as
\begin{subequations}
\begin{align}
    \psi &= \mbox{atan2}\left(
    (e_{SW} ^\times e_r)\tr p_{SE},
    -(e_{SW} ^{\times\sq} e_r)\tr p_{SE}
    \right)\\
    &= \mbox{atan2}( e_{SW}\tr e_r^\times p_{CE}, e_r\tr p_{CE} ).
\end{align}
\end{subequations}
Alternatively, using the plane definition we have
\begin{subequations}
\begin{align}
    \psi
    & = \argmin_\theta \norm{ \rot(e_{SW}, \theta) k_y - k_{SEW} }\\
    & = \mbox{atan2}( (e_{SW}^\times k_y)\tr k_{SEW},-(e_{SW}^{\times^2} k_y)\tr k_{SEW})\\
    &= \mbox{atan2}(e_{SW}\tr k_y^\times k_{SEW}, k_y \tr k_{SEW}).
\end{align}
\end{subequations}
To calculate the Jacobian, we can express \(-e_y\tr \dot e_x \) as
\begin{equation}
    \frac{e_x\tr}{\norm{k_y}} \dot k_y
    = \frac{e_x\tr}{\norm{k_y}} e_r ^\times  \dot p_{SW}
    = \frac{e_{SW}\tr e_r}{\norm{k_y}}e_y\tr  \dot p_{SW}.
\end{equation}
Therefore, the Jacobian with respect to the wrist is
\begin{equation}
    J_{\psi, W} = \frac{e_{SW}\tr e_r}{\norm{k_y}}e_y\tr
  - \frac{e_{SW}\tr p_{SE}}{\norm{p_{SW}}\norm{p_{CE}}} (e_{SW}^\times e_{CE})\tr.
\end{equation}
The Jacobian becomes undefined when \(k_y = p_{SW}^\times e_r =0\), again exhibiting the algorithmic singularity condition when $e_r$ and $p_{SW}$ become collinear.

\section{Existence of Singularity}
\label{sec:singularityexistence}
\cite*{hollerbach1985optimum} showed any revolute manipulator will have internal singularities associated with end effector orientation because it is always possible to find a pose with all joints lying in the same plane. \cite*{gottlieb1986robots} used topology to arrive at the same conclusion: Every smooth map \(T^n \rightarrow SO(3)\) must have singularities. Furthermore, he showed it is impossible to construct a smooth left-inverse of a mapping \(T^4 \rightarrow SO(3)\), so there is no singularity-free function to map from orientation to joint angles in a 4R joint. (However, it is possible to always find joint angles to follow a given trajectory while avoiding singularities, but this does not follow a function and so will not be cyclical.)

In this section, we will show for a 7-DOF revolute arm with a sufficiently large workspace, e.g., a 3R-R-3R robot with orthogonal consecutive joints, and a task space augmented by any parameterization of the redundant degree of freedom, e.g., the SEW angle, there will always be an algorithmic singularity.

The so-called Hairy Ball Theorem \citep*{mcgrath2016extremely} states that a continuous vector field on a sphere must have at least one point where it vanishes. We will use this theorem to show that a singularity must exist for any redundancy parameterization, $\phi:T^7\to \rr{}$. Given any end effector pose $(p_{0T},R_{0T})$ and $\phi$, there exists a finite number of inverse kinematics solutions $q$. Consider the sphere generated by a constant shoulder-wrist distance $\norm{p_{SW}}$ such that the elbow $\calO_E$ does not lie on the shoulder-wrist line, i.e., $p_{SE}$ and $p_{SW}$ are not collinear. For any point on the sphere and a constant orientation and $\phi$, find the inverse kinematics solution $q$ that is on the same branch of the finite number of solutions. 
Define the vector field $e_{CE}(p_{SE})$ as the unit vector perpendicular to $p_{SE}$ and pointing towards the elbow, which is the normalized version of \(-e_{SW}^{\times^2}p_{SE}\), as shown in Figure~\ref{fig:singularity_proof}. By the Hairy Ball Theorem, $e_{CE}$ cannot be continuous everywhere on the sphere. This implies there is discontinuity in the joint angle while the wrist travels along the sphere, corresponding to the algorithmic singularity.

% Figure environment removed

It is also straightforward to demonstrate that for the general SEW angle specifically, any choice of \(f_x(p_{SW})\) must have a singularity. If we restrict the input to have some constant nonzero  \(\norm{p_{SW}}\), then \(f_x\) defines a unit-magnitude vector field on a sphere. By the Hairy Ball Theorem, this vector field must be discontinuous. For the conventional SEW angle, the singularity occurs when \(e_{SW} = \pm e_r\). If we choose \(\phi\) to be the arm angle where \(e_x\) corresponds to \(e_{CE}\) when \(q_3 = 0\) and the robot has a spherical wrist, then the singularity occurs when \(e_{SW} = \pm h_1\).

Another common parameterization choice is \(\phi(q) = q_1\). In this case if the robot has a spherical wrist then the singularity occurs when \(e_{SW} = \pm R_{01}h_2\). 

The Poincaré–Hopf theorem \citep*{poincare1885courbes, hopf1927vektorfelder} implies that not only must there be a singularity on the sphere, but the total order of singularities must be two. For this vector field, the order of the singularity is how many times the elbow rotates about the shoulder-wrist line as the wrist travels around the singularity once. In all the examples of \(\phi\) shown above, there are two antipodal singularities of order one. 

The goal of Section~\ref{sec:stereographic_SEW_angle} is to find a redundancy parameterization that has a single singularity on this sphere of order two. This is in some sense the best-case singularity structure, as this results in a singularity along a half-line in the robot workspace. For most robots, this line can be chosen so that it goes into the structure holding the robot in place, meaning the singularity is out of the reachable workspace.

\section{Stereographic SEW angle} \label{sec:stereographic_SEW_angle}
\subsection{Definition}
The conventional definition of the SEW angle in Section~\ref{sec:classicalSEW} encounters a singularity when the shoulder-wrist vector $p_{SW}$ becomes collinear with the reference vector $e_r$. As discussed in Section~\ref{sec:singularityexistence}, an algorithmic singularity is unavoidable, but we can reduce its impact by slightly changing the SEW angle definition so that the bidirectional line condition becomes a unidirectional half-line condition, as shown in Figure~\ref{fig:singularity_locations_stereo}.

For the stereographic SEW angle (Figure~\ref{fig:f_x_stereo}), we define the reference direction function \(f_x\) as
\begin{subequations}\label{eq:stereo_SEW_def}
\begin{align}
    e_x     &= f_x(p_{SW}) = \frac{k_x}{\norm{k_x}},\\
    k_x     &= k_{rt} ^\times p_{SW},\\
    k_{rt}  &= (e_{SW} - e_t)^\times e_r.
\end{align}
\end{subequations}
This also means \(e_y\) is the normalized version of \(-e_{SW}^{\times^2} k_{rt}\).
$e_t$ is an arbitrary vector chosen to place the singularity structure. We will show we need the conditions \(\norm{e_r} = 1\), \(\norm{e_t} = 1\), and \(e_r \tr e_t = 1\) to achieve the half-line singularity condition. If we instead set \(e_t=0\) then \eqref{eq:stereo_SEW_def} becomes the conventional SEW angle definition.

Using the plane definition, the stereographic SEW angle can be written as
\begin{equation}
    \psi = \argmin_\theta \norm{ \rot(e_{SW}, \theta) k_{rt} - k_{SEW} },
\end{equation}
which may be solved using
\begin{equation}
    \psi = \mbox{atan2}(e_{SW}\tr k_{rt}^\times k_{SEW}, k_{SEW}\tr k_{rt}).
\end{equation}
Using the elbow definition, we may equivalently write
\begin{equation}
    \psi = \mbox{atan2}(k_{rt} \tr p_{CE}, - e_{SW}\tr k_{rt}^\times p_{CE}).
\end{equation}

For any \((e_r, e_t)\) with nonzero \(e_r\) we can always pick a new \((\tilde e_r, \tilde e_t)\) such that  \(e_r \tr e_t = 1\) and \(\norm{e_r} = 1\) where the direction of \(k_{rt}\) is identical according to
\begin{equation}
    \tilde e_r = \frac{e_r}{\norm{e_r}},\quad
    \tilde e_t = -\tilde e_r ^{\times^2} e_t.
\end{equation}
We can show that once we require \(\norm{e_r} = 1\) and \(e_r \tr e_t = 0\) (without loss of generality), the half-line singularity condition occurs if and only if \(\norm{e_t} = 1\).
The algorithmic singularity corresponds to $k_x=0$, which occurs when $k_{rt}$ is a zero vector or collinear with $e_{SW}$.
We consider two cases below:
\begin{enumerate}
    \item \(\norm{e_t} \leq 1\): For two choices of \(e_{SW}\), \(k_{rt}=0\):
    \begin{equation} \label{eq:norm_e_SW_geq_1}
        e_{SW} = e_t \pm \sqrt{1-\norm{e_t}^2} e_r
    \end{equation} 
    This corresponds to the points on the unit sphere which intersect with the line spanned by \(e_r\) and translated by \(e_t\).
    \item \(\norm{e_t} \geq 1\): For two choices of \(e_{SW}\), $k_{rt}$ is collinear with $e_{SW}$:
    \begin{equation} \label{eq:norm_e_SW_leq_1}
        e_{SW} = \frac{e_t}{\norm{e_t}^2}
                 \pm \sqrt{{\norm{e_t}^2}-1}\frac{e_t ^\times e_r}{\norm{e_t}^2}.
    \end{equation} 
    This corresponds to the points on the unit sphere which is tangent to a plane passing through the line spanned by \(e_r\) and translated by \(e_t\).
    
\end{enumerate}
%
There are two unique singularities if \(\norm{e_t} < 1\) and 2 unique singularities if \(\norm{e_t} > 1\). By choosing \(\norm{e_t} = 1\), both \eqref{eq:norm_e_SW_geq_1} and \eqref{eq:norm_e_SW_leq_1} simplify to the half-line condition \(e_{SW} = e_t\). Geometrically, this is because the line spanned by \(e_r\) and translated by \(e_t\) only passes through one point on the unit sphere (at \(e_t\)), and the only plane tangent to the unit sphere and passing through the line spanned by \(e_r\) and translated by \(e_t\) is tangent at \(e_t\). If we instead set $e_t=0$, then we recover the conventional SEW angle.

A good choice of $e_t$ is to point in the opposite direction of the robot workspace (e.g., into the ground) so that the singularity will not affect the robot operation.

For the Jacobian, we must calculate
\begin{equation}
    -e_y\tr \dot e_x = -\frac{1}{\norm{k_x}} e_y \tr \dot k_x.
\end{equation}
Recall that \(k_x = k_{rt}^\times p_{SW}\), which means the derivative is
\begin{gather}
    \dot k_x =k_{rt} ^\times \dot p_{SW} - p_{SW}^\times \dot k_{rt},
\end{gather}
and so
\begin{equation}
    -e_y\tr \dot e_x = - \frac
        {(e_y^\times k_{rt})\tr}
        {\norm{ k_x }}
        \dot p_{SW}
    + \frac
        {(e_y^\times p_{SW}) \tr}
        {\norm{ k_x }}
        \dot k_{rt}.
\end{equation}
We can rewrite the first term as 
\begin{equation}
\begin{split}
    -\frac
        {(e_y^\times k_{rt})\tr}
        {\norm{ k_x }}
        \dot p_{SW}
    &= -\frac
        {e_{SW}\tr k_{rt}}
        {\norm{ k_x }}
        e_x \tr  J^W \dot q \\
    &= \frac
        {e_{SW} \tr e_t^\times e_r}
        {\norm{ k_x }}
        e_x\tr  J^W \dot q.
\end{split}
\end{equation}
Notice that
\begin{equation}
    \dot e_{SW} = -\frac{e_{SW} ^{\times^2}}{\norm{p_{SW}}} \dot p_{SW}.
\end{equation}
The second term can be written as
\begin{equation}
\begin{split}
    \frac
        {(e_y^\times p_{SW}) \tr}
        {\norm{ k_x }}
        \dot k_{rt}
    &=  \frac
        {\norm{ p_{SW} }}
        {\norm{ k_x }}
        e_x \tr
     \left(
        e_r^\times \frac
            {{e_{SW}^\times}^2}
            {\norm{ p_{SW} }}
        J_W \dot q
    \right) \\
    &= \frac
        {e_{SW} \tr e_r}
        {\norm{ k_x }}
    e_y \tr  J_W \dot q.
\end{split}
\end{equation}
This means the Jacobian with respect to the wrist is
\begin{equation}
    \begin{split}
    J_{\psi, W} ={}&     \frac{e_{SW}\tr e_r}{\norm{k_x}}e_y\tr
  + \frac{e_{SW}\tr e_t^\times e_r}{\norm{k_x}}e_x\tr \\
  &{}- \frac{e_{SW}\tr p_{SE}}{\norm{p_{SW}}\norm{p_{CE}}} (e_{SW}^\times e_{CE})\tr
  \end{split}
\end{equation}
As expected based on the previous singularity analysis, other than the \(p_{SW} = 0\) and \(p_{CE} = 0\) conditions from the general SEW angle, \(J_\psi\) is only undefined when \(k_x = 0\).

In deriving the Jacobian, we made no assumptions on the norms or orthogonality of \(e_r\) or \(e_t\). Setting \(e_t = 0\) lets us recover the Jacobian for the conventional SEW angle.

\subsection{Relationship to Stereographic Projection}
The stereographic SEW angle gets its name from stereographic projection, which is a type of one-to-one mapping between points on a sphere and a plane \citep*{needham1997visual}. Stereographic projection has the following geometric definition: Pick a point on the sphere as the pole of the projection and place the plane tangent to the sphere at the antipodal point.
Corresponding points on the sphere and plane are collinear with the pole.

We can show the reference direction \(e_x\) for the stereographic SEW angle is generated by performing a stereographic projection of a constant vector field onto a unit sphere (Figure~\ref{fig:stereo_proj}). For any choice of \(e_t\) and \(e_r\), we can generate a constant vector field in the \(e_r\) direction on the projection plane and place the projection pole at \(e_t\). Then, for any choice of \(e_{SW}\), we can form a projection line passing through \(e_t\) and \(e_{SW}\) and intersecting with the projection plane. The projection of \(e_r\) onto the sphere is then the vector which is tangent to the circle formed by the intersection of the unit sphere and the plane which contains the tips of \(e_t\) and \(e_{SW}\) and is parallel to \(e_r\). This plane is normal to \(k_{rt}\), and so the projection of \(e_r\) from the plane to the sphere is \(e_x\).

% Figure environment removed

\subsection{Preservation of Angles} \label{sec:preservation_of_angles}
Although it appears that we have three DOF in picking the parameters for the stereographic SEW angle (two DOF for \(e_t\) and one remaining DOF for \(e_r\)), we can show that the one DOF for \(e_r\) does not change the behavior of the SEW angle; it only changes the angle by a constant. Changing the angle of \(e_r\) around \(e_t\) is equivalent to changing the SEW angle \(\psi\) by the same angle.

Since stereographic projection is a conformal mapping, changes of angles in the projection plane get preserved after projecting onto the unit sphere. This means changing the angle of \(e_r\) on the projection plane corresponds to an equal change of angle to \(e_x\) and \(e_y\).

We can also prove this preservation of angles property directly (Figure~\ref{fig:circles_proof}). First, set \(e_r = e_{r,1}\), which results in \(e_{x,1}\). This vector is tangent to the circle which is tangent to \(e_{r,1}\) and is passing through \(e_{SW}\) and \(e_t\). Now, pick a new \(e_r = e_{r,2}\) which is \(e_{r,1}\) rotated by an angle \(\alpha\) about \(-e_t\). This generates \(e_{x,2}\) which is tangent to the circle passing through \(e_{SW}\) and \(e_t\) but tangent to \(e_{r,2}\). The angle from \(e_{x,1}\) to \(e_{x,2}\) about \(e_{SW}\) is an angle \(\beta\). The angles of intersection of any two circles on a sphere are equal, so \(\alpha = \beta\).

The preservation of angles property can aid in analyzing the behavior of SEW angle when only \(q_1\) changes in the typical case of \(e_t = -h_1\), which occurs when the first joint of the robot is pointing up and the singularity direction is chosen to point down. In this case, the when \(q_1\) changes but all other joint angles are held constant, \(\psi\) changes at the same rate. This means the first element of  \(J_\psi\) is always 1.

We can compare this to the conventional SEW angle where \(e_r = h_1\). In this case, the SEW angle does not change when only \(q_1\) changes. (The conventional SEW angle has rotational invariance about \(e_r\).) This means the first element of \(J_\psi\) is always 0.

% Figure environment removed
\subsection{Singularity Behavior}

The singularity for the stereographic SEW angle is of order two. This means that if \(e_{SW}\) travels in a small circle around \(e_t\), \(e_x\) rotates twice for each rotation of \(e_{SW}\). This is unlike the conventional SEW angle, where each singularity is of order one.

Although a singularity of order two would result in larger elbow motion than a singularity of order one for a fixed SEW angle as \(e_{SW}\) passes close to \(e_t\), large motion disappears if \(e_{SW}\) passes directly through \(e_t\) in a smooth path. As a path gets closer to the singularity, \(e_x\) gets closer to making a full revolution of \(2\pi\) radians. At the limit, the elbow rotates by exactly \(2\pi\), which is equivalent to not rotating at all. We can compare this to the conventional SEW angle, where passing through the singularity in a smooth path causes \(e_x\) to rotate by \(\pi\) radians.

\subsection{Example}

Two joint trajectories were generated for a KUKA LBR iiwa 14 R820 robot \citep*{KUKA} with constants \(R_{07} = I\) and \(\psi=\pi/4\): One using the conventional SEW angle with  \(e_r = [
       0 \   0 \   1
]\tr\), and the other using the stereographic SEW angle with \(e_t = [
       0 \   0 \ {-1}
]\tr\) and \(e_r = [
       0 \   1 \   0
]\tr\). The task-space trajectory for \(p_{0T}\) took a straight-line path through 4 points, with \(x=\pm 0.40\) m, \(y = 0.01\) m, and \(z = 0.36 \pm 0.40\) m.
There was a small offset in the \(y\) direction as otherwise there would not be any large joint motion for the stereographic SEW angle. For each trajectory, the initial pose was picked such that \(q_2>0\), \(q_4>0\), and \(q_6>0\). Results are shown in Figure~\ref{fig:demo}.

% Figure environment removed

For the conventional SEW angle, the singularities occur near \(e_{SW} = \pm [
       0 \   0 \   1
]\tr\). In following the trajectory with the conventional SEW angle, there were large joint motions in two places, each corresponding to the positive and negative direction.

For the stereographic SEW angle, the singularity only occurs near \(e_{SW} = [
       0 \   0 \   {-1}
]\tr\). We see that the large joint motion only occurred at one time in the trajectory. The joint motion was also larger than in the conventional SEW case, as the singularity is of order two instead of one. The singularity occurs when the wrist is below the base, which in many cases would be out of the feasible workspace.

\section{Inverse Kinematics} \label{sec:IK}
\begin{table*}[t]
    \small\sf\centering
    \caption{Kinematic families of robots with IK solutions demonstrated in this paper. The Motoman SIA50D appears as two examples since one robot may be part of multiple kinematic families.}
    \begin{tabular}{l r@{\ }l l}
        \toprule
        IK Type & \multicolumn{2}{l}{Kinematic Family} & Robot Example \\
        \midrule Closed-Form
        & 1. & 2R-2R-3R              & FREND \citep*{debus2009overview}\\
        &    &                       & KUKA LBR iiwa 14 R820 \citep*{KUKA}\\
        & 2. & 3R-R-3R               & Motoman SIA5D \citep*{moto5d} \\
        &3. & R-R-3R\textsuperscript{E}-2R             & Motoman SIA50D  \citep*{moto50d}\\
        &4. & 2R-3R-2R  &\\
        &5. & 2R-3R\textbar\textbar-2R & SSRMS \citep*{crane1991kinematic} \\
        &&                       & SPDM \citep*{mukherji2001special}\\
        &&                       & ERA \citep*{boumans1998european}\\
        &6. & R-R-3R\textbar\textbar\textsuperscript{E}-2R & \\
        \midrule
        1D Search
        & 7. & R-2R-2R\textsuperscript{E}-2R            & Sawyer \citep*{sawyer} \\
        &&                       & Baxter \citep*{baxter}\\
        &&                       & OSAM-2 \citep*{osam2}\\
        &&                       & OB7 \citep*{OB7} \\
        &8. & 3R-R\textsuperscript{E}-2R-R             & Franka Production 3 \citep*{franka} \\
        &&                       & xArm7 \citep*{xarm}\\
        &9. & R-2R\textsuperscript{S}-R-3R             & Motoman SIA50D  \citep*{moto50d}\\
        \midrule
        2D Search
        &10. & General 7-DOF         & ABB Yumi \citep*{ABB_YUMI} \\
        &&                       & RRC \citep*{RRC}\\
        \bottomrule
    \end{tabular}

    \label{tab:robot_IK_types}
\end{table*}
\subsection{Problem Formulation}
The inverse kinematics problem for a 7R robot arm is to find all possible joint angles \(q\) corresponding to an end effector pose and SEW angle \((R_{0T}, p_{0T}, \psi)\) given the robot kinematic parameters \(\left(\{p_{i-1,i}\}_{i=1}^7,\ p_{7T},\ \{h_i\}_{i=0}^7,\ R_{7T}\right)\) and stereographic SEW parameters \(\left(e_r,\ e_t,\ p_{iS},\ p_{jE},\ p_{kW}\right)\). These inverse kinematics solutions are agnostic to the SEW formulation, and so the conventional SEW angle definition may be used instead.

The inverse kinematics procedures can apply not just to 7-DOF manipulators, but also to 6-DOF manipulators which have been provided an extra degree of freedom, say, by being placed on an omnidirectional mobile base with the location of the origin of the base specified. For example, if we use a UR5 robot \citep*{UR5}, tilt the robot so the first joint is not vertical, and pick the origin of the mobile base to be directly under the intersection of joints 1 and 2, then the system becomes a 3R-R-2R-R or 3R-2R\textbar\textbar-2R robot.

To find the inverse kinematics of a 7-DOF robot where the redundant degree of freedom is parameterized by some joint angle \(q_i\), find the 6-DOF robot generated by fixing \(q_i\) and refer to the inverse kinematics procedures provided in \cite*{elias2022canonical}.

Without loss of generality, assume \(p_{01} = 0\). (Otherwise, subtract \(p_{01}\) from \(p_{0T}\) and \(p_{0S}\).)  Rewrite the kinematics equations in terms of \(R_{07}\) and \(p_{07}\), which can be immediately calculated:
\begin{subequations} 
    \begin{align}
    R_{07} ={}& R_{0T}R_{7T}\tr = R_{01} R_{12} R_{23} R_{34} R_{45} R_{56} R_{67},\\
    \begin{split}
    p_{07} ={}& p_{0T}-R_{07}p_{7T}\\
    ={}& R_{01} p_{12} + R_{02} p_{23} + R_{03} p_{34}\\
    &+R_{04} p_{45}+R_{05} p_{56}+R_{06} p_{67}.
    \end{split}
    \end{align}
    \label{eq:fwdkin_simplified}
\end{subequations}
The inverse kinematics procedures can now be written in terms of \((R_{07},\ p_{07},\ \psi)\).
If the shoulder is constant in the 0 frame and the wrist is constant in the 7 frame, then we can use \eqref{eq:n_SEW} to find \(n_{SEW}\) since \(\psi\) is given \(p_{SW}\) is known:
\begin{equation}
    p_{SW} = p_{07} + R_{07}p_{7W} - p_{0S}.
\end{equation}
A key step in the inverse kinematics procedure is to find the elbow location, i.e., \(p_{SE}\). This sometimes involves finding the shoulder angle \(\theta_S\) or the wrist angle \(\theta_W\), defined as 
\begin{equation}
    p_{SE} = \rot(n_{SEW},\theta_S)e_{SW}\norm{p_{SE}},
\end{equation}
\begin{equation}
    p_{EW} = \rot(n_{SEW}, \theta_W) e_{SW}\norm{p_{EW}}.
\end{equation}
Note that for a given shoulder position, wrist position, and SEW angle, the elbow must be somewhere in a half plane: Given \(n_{SEW}\) and \(e_{CE}\), we require \(n_{SEW}\tr p_{SE} = 0\) and \(e_{CE}\tr p_{SE} > 0\).
To place the elbow in the correct half plane, \(\theta_S \in [0,\pi]\) and \(\theta_W \in [-\pi,0]\). A singularity occurs when \(\theta_S = 0\) or \(\theta_W = 0\), as this corresponds to the shoulder, elbow, and wrist being collinear.

% Figure environment removed

A number of inverse kinematics solutions are provided below, and the different kinematic families, along with examples of specific robots for some types, are shown in Table~\ref{tab:robot_IK_types} and Figure~\ref{fig:robots}. There exist many other kinematic families, but we include enough examples to demonstrate the technique of applying the subproblem decomposition method to solve the inverse kinematics problem. The reader is referred to the discussions in \cite*{elias2022canonical} for information regarding handling multiple branches, extraneous solutions, least-squares solutions, 1D and 2D searches, and internal and boundary singularities.

Closed-form solutions may exist when a robot has 3R or 3R\textbar\textbar{} joints, as a 3R joint may result in decoupling between position and orientation, and a 3R\textbar\textbar{} joint is the limit of a 3R joint as the point of intersection moves infinitely far away. (It only makes sense to place \(\calO_E\) infinitely far away, as placing \(\calO_S\) or \(\calO_W\) infinitely far away results in \(e_{SW}\) being a constant vector in the base or end effector frame.) In other cases, the solution requires a 1D or 2D search over \(q_i\), \(\theta_S\), or \(\theta_W\).

A common step in the IK solutions below is to solve the orientation of a 3R joint. To solve such a spherical joint (shown here at the robot wrist)
\begin{equation}
    R_{45} R_{56} R_{67} = R_{47},
\end{equation}
first solve for \((q_5, q_6)\) using Subproblem~2
\begin{equation}
    R_{56} h_7 = R_{54} R_{47} h_7.
\end{equation}
Then, solve for \(q_7\) using Subproblem~1:
\begin{equation}
    R_{67} p = R_{65}R_{54} R_{47} p,
\end{equation}
where \(p\) is any vector not collinear with \(h_7\).

In the following IK solutions, always pick the origins of intersecting axes for that kinematic family to be coincident. For example, in a 3R-R-3R robot, pick  \(\mathcal O_1 = \mathcal O_2 = \mathcal O_3 = \mathcal O_S\), which means \(p_{12}=p_{23}=p_{0S}=0\). When an elbow is made of parallel joints (say, that include joint 3), pick \(p_{SE} = e_{SE} = R_{02}h_3\).

\subsection{IK Solutions}
\subsubsection{2R-2R-3R Arm}
The position equation becomes
\begin{equation}
    p_{07} = p_{SW} = R_{02} (p_{23} + R_{24}p_{45}),
\end{equation}
and given \(\theta_S\) we have
\begin{equation}
    R_{02}p_{23} = \rot(n_{SEW},\theta_S)e_{SW}\norm{p_{23}}.
\end{equation}
Use Subproblem~3 to find \(\theta_S \in [0,\pi]\):
\begin{equation}
    \norm{ \rot(n_{SEW},\theta_S)e_{SW}\norm{p_{23}} - p_{07}} = \norm{p_{45}}.
\end{equation}
Find \((q_1, q_2)\) using Subproblem~2:
\begin{equation} \label{eq:q_12_using_sp2}
    R_{12} p_{23} = R_{10} \rot(n_{SEW},\theta_S)e_{SW}\norm{p_{23}}.
\end{equation}
Similarly, find \((q_3, q_4)\) using Subproblem~2:
\begin{equation}
    R_{32}(R_{21}R_{10}p_{07}-p_{24}) = R_{34}p_{45}.
\end{equation}
Finally, find \((q_5, q_6, q_7)\) by solving the spherical wrist:
\begin{equation}\label{eq:spherical_wrist_with_RHS}
    R_{45}R_{56}R_{67} = (R_{01}R_{12}R_{23}R_{34})\tr R_{07}.
\end{equation}

\subsubsection{3R-R-3R Arm}
The position equation becomes
\begin{equation}
    p_{07} = p_{SW} =  R_{03} (p_{34} + R_{34}p_{45}).
\end{equation}
Solve for up to two solutions of \(q_4\) using Subproblem~3:
\begin{equation}
    \norm{R_{34}p_{45} + p_{34}} = \norm{p_{07}}.
\end{equation}
Represent \(R_{03}\) as three consecutive orthogonal rotations:
\begin{equation}
    R_{03} = \rot(e_{SW},\theta_a)\rot(n_{SEW},\theta_b)\rot(e_{SW},\theta_c).
\end{equation}
There are up to two solutions for \((\theta_a, \theta_b, \theta_c)\), but they represent the same \(R_{03}\), so only keep one solution. Solve for \((\theta_b, \theta_c)\) using Subproblem~2:
\begin{equation}
    \rot(n_{SEW}, \theta_b)\tr p_{07} =  \rot(e_{SW},\theta_c)(p_{34} + R_{34}p_{45}).
\end{equation}
Then, use Subproblem~4 to find \(\theta_a\), keeping only the solutions that place the elbow in the correct half plane:
\begin{equation}
    n_{SEW}\tr \rot(e_{SW},\theta_a)\rot(n_{SEW},\theta_b)\rot(e_{SW},\theta_c) p_{3E} = 0.
\end{equation}
Find \((q_1, q_2, q_3)\) by solving the spherical shoulder:
\begin{equation}
    R_{01} R_{12} R_{23} = \rot(e_{SW},\theta_a)\rot(n_{SEW},\theta_b)\rot(e_{SW},\theta_c).
\end{equation}
Similarly, find \((q_5, q_6, q_7)\) by solving \eqref{eq:spherical_wrist_with_RHS}.

\subsubsection{\texorpdfstring{R-R-3R\textsuperscript{E}-2R Arm}{R-R-3Rᴱ-2R Arm}}
Write \(\theta_W\) as
\begin{equation}
    R_{05}p_{56} = \rot(n_{SEW}, \theta_W) e_{SW}\norm{p_{56}}.
\end{equation}
Using Subproblem~5, we can find up to four solutions of \((q_1, q_2,\theta_W)\), where \(\theta_W \in [-\pi, 0]\):
\begin{multline}
    p_{07} - \rot(n_{SEW}, \theta_W) e_{SW}\norm{p_{56}} \\= R_{01} (p_{12} + R_{12} p_{23}).
\end{multline}
Next, find up to two solutions of \((q_6, q_7)\) using Subproblem~2:
\begin{equation}
    R_{67} R_{07}\tr \rot(n_{SEW}, \theta_W) e_{SW}\norm{p_{56}} = R_{65} p_{56}.
\end{equation}
To solve for \((q_3, q_4, q_5)\), solve the spherical elbow:
\begin{equation}\label{eq:spherical_elbow}
    R_{23}R_{34}R_{45} = (R_{01} R_{12})\tr R_{07} (R_{56} R_{67})\tr.
\end{equation}

\subsubsection{2R-3R-2R Arm}
Find \(\theta_S\in [0,\pi]\) using Subproblem~3:
\begin{equation}
    \norm{ \rot(n_{SEW},\theta_S)e_{SW}\norm{p_{23}} - p_{07}} = \norm{p_{56}}.
\end{equation}
Find \((q_1,q_2)\) with Subproblem~2 to solve \eqref{eq:q_12_using_sp2}. Similarly, find \((q_6, q_7)\):
\begin{equation}
    R_{67} R_{07}\tr (p_{07}- R_{02}p_{23}) = R_{65} p_{56}.
\end{equation}
Find \((q_3, q_4, q_5)\) by solving \eqref{eq:spherical_elbow}.

\subsubsection{2R-3R\textbar\textbar-2R Arm}
This robot is the limit of a 2R-3R-2R arm where the intersection point of the elbow joint moves to infinity.
We can write
\begin{equation}\label{eq:2R_shoulder_theta_S}
    R_{01} R_{12} h_3 = \rot(n_{SEW}, \theta_S) e_{SW}.
\end{equation}
Combining with the position equation gives
\begin{equation}
    h_3\tr (p_{23} + p_{34} + p_{45} + p_{56}) = h_3 \tr R_{02}\tr p_{07}.
\end{equation}
Solve for \(\theta_S\in [0, \pi]\) using Subproblem~4:
\begin{equation}
    e_{SW}\tr \rot(n_{SEW}, \theta_S)\tr p_{07} =   h_3\tr (p_{23} + p_{34} + p_{45} + p_{56}).
\end{equation}
Find \((q_1, q_2)\) using Subproblem~2:
\begin{equation}
    R_{12} h_3 = R_{10}\rot(n_{SEW}, \theta_S) e_{SW}.
\end{equation}
Find \((q_3+q_4+q_5, q_6, q_7)\) by solving a spherical joint:
\begin{equation} \label{eq:3_parallel_spherical_joint}
    R_{25} R_{56} R_{67} = R_{02}\tr R_{07}.
\end{equation}
Use Subproblem~3 to find \(q_4\):
\begin{equation}
    \norm{p_{34} + R_{34} p_{45}}
    = \norm{R_{02} \tr p_{07} - p_{23} - R_{25}p_{56}}.
\end{equation}
Use Subproblem~1 to find \(q_3\):
\begin{equation}
    R_{23}(p_{34} + R_{34} p_{45})
    = R_{02} \tr p_{07} - p_{23} - R_{25}p_{56}.
\end{equation}
Find \(q_5\) with subtraction, wrapping to \([-\pi, \pi]\) if desired.
\subsubsection{\texorpdfstring{R-R-3R\textbar\textbar\textsuperscript{E}-2R Arm}{R-R-3R\textbar\textbarᴱ-2R Arm}}
This is a more general version of a 2R-3R\textbar\textbar-2R robot. Use Subproblem 6 to find \((\theta_S, q_2)\), where \(\theta_S \in [0, \pi]\):
\begin{subequations}
\begin{multline}
        e_{SW} \tr \rot(n_{SEW}, \theta_S)\tr p_{07} - h_3 \tr R_{21} p_{12} \\
            = h_3\tr (p_{23} + p_{34} + p_{45} + p_{56}),
\end{multline}
\begin{equation}
        h_1 \tr \rot(n_{SEW}, \theta_S)\ e_{SW} - h_1 \tr R_{12} h_3= 0.
\end{equation}
\end{subequations}
Use Subproblem~1 to find \(q_1\) solving \eqref{eq:2R_shoulder_theta_S}. Find \((q_3+q_4+q_5, q_6, q_7)\) by solving a spherical joint \eqref{eq:3_parallel_spherical_joint}.
Use Subproblem~3 to find \(q_4\):
\begin{multline}
    \norm{p_{34} + R_{34} p_{45}}\\
    = \norm{R_{02} \tr p_{07} - R_{21} p_{12} - p_{23} - R_{25}p_{56}}.
\end{multline}
Use Subproblem~1 to find \(q_3\):
\begin{multline}
    R_{23}(p_{34} + R_{34} p_{45})\\
       = R_{02} \tr p_{07} - R_{21} p_{12} - p_{23} - R_{25}p_{56}.
\end{multline}
Find \(q_5\) with subtraction, wrapping to \([-\pi, \pi]\) if desired.

\subsubsection{\texorpdfstring{R-2R-2R\textsuperscript{E}-2R Arm (1D Search)}{R-2R-2Rᴱ-2R Arm (1D Search)}}
% Figure environment removed
% Figure environment removed
Given \(\theta_W\), we can write
\begin{equation}
    R_{05}p_{56} = \rot(n_{SEW}, \theta_W) e_{SW}\norm{p_{56}}.
\end{equation}
Then, find \(q_1\) using Subproblem~3:
\begin{equation}
    \norm{R_{01} p_{12} - p_{07} +  R_{05}p_{56}} = \norm{p_{34}}.
\end{equation}
Find \((q_2, q_3)\) using Subproblem~2:
\begin{equation}
    R_{23}p_{34} = R_{21}(R_{10}p_{07}- R_{10}R_{05}p_{56} - p_{12}).
\end{equation}
Find \((q_4, q_5)\) using Subproblem~2:
\begin{equation}
    R_{45}p_{56} = R_{43}(R_{32}R_{21}(R_{10}p_{07}-p_{12})-p_{34}).
\end{equation}
The error is a metric of solvability of
\begin{equation}
    R_{56}R_{67} = R_{05}\tr R_{07}.
\end{equation}
By projecting onto \(h_6\) and \(h_7\), we get the error
\begin{equation}
    e(\theta_W) = h_6\tr R_{05}\tr R_{07}h_7 - h_6 \tr h_7.
\end{equation}
Search over \(\theta_W \in [-\pi,0]\) to find all solutions of \(e(\theta_W)=0\). For each solution \(\theta_W\), calculate \(q_6\) and \(q_7\) using Subproblem~1:
\begin{equation}
    R_{56} h_7 = R_{05}\tr R_{07}h_7,
\end{equation}
\begin{equation}
    R_{76} h_6 =  R_{07}\tr R_{05}h_6.
\end{equation}
A Sawyer arm example is shown in Figures~\ref{fig:sawyer_error_plot} and \ref{fig:sawyer_IK}.

\subsubsection{\texorpdfstring{3R-R\textsuperscript{E}-2R-R Arm (1D Search)}{3R-Rᴱ-2R-R Arm (1D Search)}}
Given \(\theta_S \in [0,\pi]\), we have
\begin{equation}
    R_{03}p_{34} = \rot(n_{SEW},\theta_S)e_{SW}\norm{p_{34}}.
\end{equation}
Then use Subproblem~3 to find \(q_7\) from
\begin{equation}
    \norm{R_{07}\tr(p_{07} - R_{03}p_{34}) - R_{76} p_{67}} = \norm{p_{45}}.
\end{equation}
Solve \((q_5, q_6)\) using Subproblem~2:
\begin{equation}
    R_{54} p_{45} = R_{56} (R_{67}R_{07}\tr(p_{07}-{R_{03}p_{34}})-p_{67}).
\end{equation}
We have the identity
\begin{equation}
    R_{43} p_{34} = R_{47} R_{07}\tr R_{03}p_{34},
\end{equation}
which may be expressed as an error function in terms of \(\theta_S\):
\begin{equation}
    e(\theta_S) = h_4\tr ( p_{34} -R_{47} R_{07}\tr R_{03}p_{34}).
\end{equation}
Search over \(\theta_S\in[0,\pi]\) to find the zeros of this error. For each solution \(\theta_S\), find \(q_4\) with Subproblem~1, then find \((q_1, q_2, q_3)\) by solving the spherical shoulder:
\begin{equation}
    R_{01}R_{12}R_{23} = R_{07}(R_{34}R_{45}R_{56}R_{67})\tr.
\end{equation}

\subsubsection{\texorpdfstring{R-2R\textsuperscript{S}-R-3R Arm (1D Search)}{R-2Rˢ-R-3R Arm (1D Search)}}
Given \(q_1 \in [-\pi, \pi]\), solve for \(q_4\) using Subproblem~3:
\begin{equation}
    \norm{p_{34} + R_{34}p_{45}} = \norm{R_{10} p_{07} - p_{12}}.
\end{equation}
Solve for \((q_2, q_3)\) using Subproblem~2:
\begin{equation}
    R_{21}(R_{10} p_{07} - p_{12}) = R_{23}(p_{34}+R_{34}p_{45}).
\end{equation}
Find the shoulder-elbow vector \(p_{SE} = R_{03}p_{34}\),
from which we can calculate the error for \(\psi\) in terms of \(q_1\).
A plot of this error is a good graphical tool to determine what range of SEW angle is feasible for a given end effector pose.
For each solution \(q_1\), find \((q_5,q_6,q_7)\) by solving \eqref{eq:spherical_wrist_with_RHS}.

\subsubsection{General 7-DOF Arm (2D Search)}
Pick \(\mathcal O_1 = \mathcal O_S\), \(\mathcal O_4 = \mathcal O_E\), and \(\mathcal O_7 = \mathcal O_W\).
Given \((q_1, q_2)\), find \(q_3\) using Subproblem~4, keeping only solutions which place the elbow in the correct half plane:
\begin{equation}
    n_{SEW}\tr R_{02} R_{23} p_{34} = -n_{SEW}\tr (R_{01}p_{12} + R_{02}p_{23}).
\end{equation}
Then, find \((q_5, q_6, q_7)\) with Subproblem 5 to solve
\begin{equation}
-p_{67} + R_{67} R_{07}\tr (p_{07}-p_{14}) = R_{65} (p_{56} + R_{54} p_{45}),
\end{equation}
and find the error
\begin{equation}
    e(q_1,q_2) = \norm{R_{03}\tr R_{07} R_{47}\tr h_4 - h_4}.
\end{equation}
Search over \((q_1, q_2)\) to find zeros of this error. Then, find \(q_4\) using Subproblem~1:
\begin{equation}
    R_{34}p = R_{03}\tr R_{07} R_{47}\tr p,
\end{equation}
where \(p\) is any vector not collinear with \(h_4\).
\subsection{Least-Squares Inverse Kinematics}
Any IK solution which only uses Subproblems~1--4 is robust to boundary singularities if the least-squares solutions for these subproblems is used, as discussed in \cite*{elias2022canonical}. For some special cases, the IK solution is also the solution to the global least-squares IK problem, which is posed as
\begin{equation} \label{eq:IK_LS_minimization}
\begin{aligned}
    \min_q & \norm{p_{0T}(q) - p_{0T}^{des}}\\
    \text{ s.t. } &R_{0T}(q) = R_{0T}^{des},\ \psi(q) = \psi^{des}
\end{aligned}
\end{equation}
where \((R_{0T}^{des}, p_{0T}^{des},\psi^{des})\) is the desired end effector pose and SEW angle. For some robots, the \( \psi(q) = \psi^{des}\) constraint cannot be achieved when at a boundary singularity because the self-motion manifold degenerates to a point, and so this constraint must be dropped when \(p_{0T}(q) \neq p_{0T}^{des}\).

3R-R-3R, 2R-3R-2R, and 2R-2R-3R arms can all achieve least-squares inverse kinematics if the task frame is at the wrist center (\(p_{7T} = 0\)), all 2R joints have a spherical workspace (\(h_i\tr h_{i+1}=h_{i+1}\tr p_{i+1,i+2}=0\)) and all 3R joints can achieve any orientation (\(h_i\tr h_{i+1}=h_{i+1}\tr h_{i+2}=0\)).

For a 3R-R-3R arm, since rotation of the whole arm is always possible between the spherical shoulder and wrist, the self-motion manifold does not degenerate to a point at boundary singularities. Therefore, \(\calO_E\) should be placed such that it is not collinear with \(\calO_S\) and \(\calO_W\) at the workspace boundary. (Using \(p_{SE} = e_{SE} = R_{03}h_4\) may also be a good option.)

For 2R-3R-2R and 2R-2R-3R arms, the robot's self-motion manifold degenerates into a point at boundary singularities, so although the SEW angle will be undefined at the boundary singularity, the SEW angle is not needed. This also means the SEW angle constraint in \eqref{eq:IK_LS_minimization} must be dropped.

\section{Conclusion}\label{sec:conclusion}
We have introduced the general SEW angle which allows us to analyze the behavior of the conventional SEW angle but with arbitrary reference direction function. A special choice of the reference direction function, the stereographic SEW angle, reduces the effect of the coordinate singularity as compared to the conventional SEW angle. The stereographic SEW angle allows the use of more of the workspace without encountering singularities. Even at a singularity, the arm can have continuous joint movement as long as a smooth path is taken directly through the singularity. We have shown that since an algorithmic singularity is unavoidable for any choice of parameterization of the redundant degree of freedom, the stereographic SEW angle is ideal in that it only encounters a singularity when the wrist is at a half-line from the shoulder.

We have also used the subproblem decomposition method to provide IK solutions for most known 7R robots. These solutions are often closed-form and may sometimes require a 1D or 2D search. This method finds all IK solutions and finds least-squares solutions for some robots as well. We provide IK solutions for both common robots as well as robots which do not seem to be manufactured yet, such as a R-R-3R\textbar\textbar-2R arm.

There exist other 7R robots which may have similar solutions to the ones provided above. It may be worthwhile to find a closed-form or polynomial root-finding IK solution to the robots which are solved in this paper using a 1D or 2D search.

% \begin{acks} % "Acknowledgements" section.
% \end{acks}
% \begin{biog} % "Author biography" section.
% \end{biog}
% \begin{biogs} % "Author Biographies" section.
% \end{biogs}

\begin{dci} % "Declaration of conflicting interests" section.
The authors declare that there is no conflict of interest.
\end{dci}
% https://us.sagepub.com/en-us/nam/funding-acknowledgements
\begin{funding} %  "Funding" section.
The author(s) received no financial support for the research, authorship, and/or publication of this article.
\end{funding}
% \begin{sm} % "Supplemental material" section.
% \end{sm}

% \nocite{*} % List out whole bib to check for anything uncited 
\interlinepenalty=10000 % Don't break in middle of bib entry
\bibliographystyle{SageH}
\bibliography{bib, robot_kin_refs}

% \renewcommand{\thesubsection}{\Alph{subsection}}
% \appendix
% \section*{Appendices}

\end{document}