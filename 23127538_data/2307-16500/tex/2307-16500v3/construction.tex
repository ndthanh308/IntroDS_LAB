\section{Depth Proper Normal Form}

The depth proper normal form requires that each parameter of
each state $q$ occurs at unbounded depth in the output trees of that state 
(for each given look-ahead state $p$ such that $(q,p)$ is reachable).
Formally, let $q$ be a state of rank $m\geq 1$, $j\in[m]$, and
$p\in P$. 
If $(q,p)$ is reachable, then 
for every natural number $n$ there must exist an input tree $s_n$ such that
$y_j$ occurs at depth $>n$ in the tree $M_q(s_n)$.
Conversely, we say that parameter $y_j$ is \emph{improper} for $q$
if there exists an $n$ for which no such input tree $s_n$ exists;
more generally, we say that $Z\subseteq Y_m$ is
\emph{improper} for $q$, if each $y\in Z$ is improper for $q$.

If $Z$ is improper for $q$, then there are only finitely many output paths
in the trees in $M_q(T_\Sigma)$ under which the parameters from $Z$ occur.
The \emph{$Z$-skeleton} of an arbitrary tree $t$ is obtained from $t$
by replacing each top-most node $u$ such that $t/u$ does not contain any
occurrence of a parameter from $Z$ by some symbol. 
Clearly, $Z$ is improper for $q$ if and only if the $Z$-skeleta of
all trees in $M_q(T_\Sigma)$ form a finite set.

Let $\Delta$ be an arbitrary ranked alphabet, $m\geq 1$, 
$t\in T_\Delta(Y_m)$, and $Z\subseteq Y_m$.
Let us write \(\paras{t}\subseteq{Y_m}\) for the set of parameters 
occurring in $t$.
Let us now be more specific as to which symbols replace the top-most nodes $u$
of $t$ such that $\paras{t/u}\cap Z=\emptyset$. Since in our construction later
we will want to obtain a transducer that is nondeleting, it will be helpful
to know which parameters appear in a given deleted tree. Therefore we replace
such nodes $u$ by the set $\paras{t/u}$. 
We denote by $\lcop{t}_Z$ the $Z$-skeleton of $t$ and define it inductively as follows
(where $\delta\in\Delta$):
\begin{align*}
\lcop{t}_Z &= 
\begin{cases}
t &
\text{if \(t\in Z\)}
\\
\delta(\lcop{t_1}_Z,\dots,\lcop{t_n}_Z) &
\text{if \(\paras{t}\cap Z\ne\emptyset\) and \(t = \delta(t_1,\dots,t_n)\)}
\\
\paras{t} & \text{if \(\paras{t}\cap Z = \emptyset\)}.
\end{cases}
\end{align*}

The definition of $\lcop{t}_Z$ is extended to sets $L$ of trees
as $\lcop{L}_Z=\{\lcop{t}_Z\mid t\in L\}$.
We call \emph{sequence nodes} the nodes $u$ in $V(\lcop{t}_Z)$ such 
that $\lcop{t}_Z/u=Z'\subseteq Y_m$. We denote by 
$\mathcal{U}(\lcop{t}_Z)$ the set of sequence nodes on $\lcop{t}_Z$. 
The notion of parameters in a tree naturally extends to $Z$-skeleta with, 
for a sequence node $Z'$: $\paras{Z'} = Z'$. 

\begin{lemma}\label{lm:nd}
Let $\Delta$ be a ranked alphabet, $m\geq 1$, $Z\subseteq Y_m$, and
$t\in T_\Delta(Y_m)$.
(1)~$t=\lcop{t}_Z[u\leftarrow t/u\mid u\in\mathcal{U}(\lcop{t}_Z)]$.
(2)~$\paras{\lcop{t}_Z} = \paras{t}$. 
%(3)~If $y\in Y_m$ occurs in $t$, then 
%there exists a leaf $u\in V(\lcop{t}_Z)$
%such that either $\lcop{t}_Z/u=y$ or 
%$\lcop{t}_Z/u=Z'\subseteq Y_m$ and $y\in Z'$.
\end{lemma}
\begin{proof}
The proof is by induction on the structure of $\lcop{t}_Z$.
Let us denote the substitution $[u\leftarrow t/u\mid u\in\mathcal{U}(\lcop{t}_Z)]$
by $[t]$.
%
There are three cases.

Case 1: $t = y\in Z$. Then $\mathcal{U}(\lcop{t}_Z)=\emptyset$.
Hence $\lcop{t}_Z[t]=\lcop{y}_Z$. The latter equals $y=t$ by 
the definition of $\lcop{.}_Z$. Thus~(1)~holds. Also 
$\paras{\lcop{t}_Z}=\{y\}=\paras{t}$ and so~(2)~holds. 
%the definition of $\lcop{.}_Z$. Thus~(1)~holds and~(2)~holds for $u=\epsilon$.

Case 2: $\paras{t} \cap Z = \emptyset$. Then $\lcop{t}_Z = \paras{t} = Z' \subseteq Y_m$ 
by the definition of $\lcop{.}_Z$, and $\mathcal{U}(\lcop{t}_Z)=\{ \epsilon \}$. Hence
$\lcop{t}_Z[t] = \lcop{t}_Z[\epsilon\leftarrow t/\epsilon = t] = t$ which proves~(1). 
Again~(2)~holds 
because $\paras{\lcop{t}_Z}=\paras{\paras{t}}=\paras{t}$. 
%for $u=\varepsilon$ for each $y \in \paras{t}$ i.e.\ $y$ occurring in $t$.

Case 3: \(\paras{t}\cap Z\ne\emptyset\). Then $t=\delta(t_1,\dots,t_n)$, 
$\delta\in\Delta^{(n)}$, $n\geq 0$,
and $t_1,\dots, t_n\in T_\Delta(Y_m)$.
To show~(1) we obtain from the definition of $\lcop{t}_Z$ that
\[
\lcop{t}_Z[t]=\delta(\lcop{t_1}_Z,\dots,\lcop{t_n}_Z)[t]
= \delta(\lcop{t_1}_Z[t_1],\dots,\lcop{t_n}_Z[t_n]),
\]
where for $i\in[n]$, $[t_i]$ denotes the substitution
$[u\leftarrow t_i/u\mid u\in\mathcal{U}(\lcop{t_i}_Z)]$.
By induction the latter equals $\delta(t_1,\dots,t_n)=t$.
Finally~(2)~is implied by the induction hypothesis:
$\paras{\lcop{t}_Z}=\bigcup_{j\in[n]} \paras{\lcop{t_j}_Z}
=\bigcup_{j\in[n]} \paras{t_j}= \paras{t}$
%To show~(2), assume $y\in Y_m$ occurs in $t$.
%Thus, $n\geq 1$ and there exists an $i\in[n]$
%such that $y$ occurs in $t_i$.
%By induction of Statement~(2), there exists a leaf $u$ of $t_i$ such that 
%Statement~(2) holds (for $u$ and $t_i$); therefore Statement~(2) holds
%for $iu$ and $t$.
\qed


%%Sebastian's version:
%The proof is by induction on the structure of $t$.
%Let us denote the substitution $[u\leftarrow t/u\mid u\in\mathcal{U}(\lcop{t}_Z)]$
%by $[t]$.
%%
%We first consider $t=y\in Y$. There are two cases.
%
%Case 1: $y\in Z$. Then $\mathcal{U}(\lcop{t}_Z)=\emptyset$.
%Hence $\lcop{t}_Z[t]=\lcop{y}_Z$. The latter equals $y=t$ by 
%the definition of $\lcop{.}_Z$. Thus~(1)~holds and~(2)~holds for $u=\epsilon$.
%
%Case 2: $y\not\in Z$. Then $\mathcal{U}(\lcop{t}_Z)=\{ \epsilon \}$ and hence
%$\lcop{t}_Z[t] = \lcop{t}_Z[\epsilon\leftarrow t/\epsilon = t] = t$ which proves~(1).
%Moreover, $\lcop{t}_Z=\{y_j\}$ by the definition of $\lcop{.}_Z$,
%i.e., again~(2)~holds for $u=\varepsilon$.
%
%Now consider $t=\delta(t_1,\dots,t_n)$, $\delta\in\Delta^{(n)}$, $n\geq 0$,
%and $t_1,\dots, t_n\in T_\Delta(Y_m)$.
%To show~(1) we obtain from the definition $\lcop{t}_Z$ that
%\[
%\lcop{t}_Z[t]=\delta(\lcop{t_1}_Z,\dots,\lcop{t_n}_Z)[t]
%= \delta(\lcop{t_1}_Z[t_1],\dots,\lcop{t_n}_Z[t_n]),
%\]
%where for $i\in[n]$, $[t_i]$ denotes the substitution
%$[u\leftarrow t_i/u\mid u\in\mathcal{U}(\lcop{t_i}_Z)]$.
%By induction the latter equals $\delta(t_1,\dots,t_n)=t$.
%To show~(2) we assume that $y_j$ occurs in $t$ for some $j\in[m]$.
%Thus, $n\geq 1$ and there exists an $i\in[n]$
%such that $y_j$ occurs in $t_i$.
%By the induction for Statement~(2), there exists a leaf $u$ of $t_i$ such that 
%the Statement~(2) holds (for $u$ and $t_i$), and therefore Statement~(2) holds
%for $iu$ and $t$.
\end{proof}

Finally, we define depth properness for mtts with look-ahead. 

\begin{definition} \label{df_depth_proper}
The mttr $M=(Q,P,\Sigma,\Delta,q_0,R,h)$ is in \emph{depth proper normal form}
if for every $q\in Q^{(m)}$, $m\geq 1$, and $p\in P$ it holds that
if $(q,p)$ is reachable, then  
$\lcop{M_q(L_p)}_{\{y_j\}}$ is infinite for all $j\in[m]$.
\end{definition}

From now on we will want to make use of the following definitions:
\[
\begin{array}{lcl}
F_p &=& \{ q\in Q^{(m)}\mid \exists j\in[m], \lcop{M_q(L_p)}_{\{y_j\}}
\text{ is finite}\}\\
Y(q,p) &=& \{ y_j\mid j\in[\text{rank}_Q(q)]\text{ such that }
\lcop{M_q(L_p)}_{\{y_j\}}\text{ is finite}\}.
\end{array}
\]

Before we proceed with the construction of the depth proper normal form,
we want to be able to decide whether or not a given mttr is depth proper.

\newpage

\subsection{Deciding whether or not a given Mttr is Depth Proper}

In this section we prove that for a given mttr it is decidable whether or
not it is depth proper.
Moreover, we present a technical lemma giving properties of parameters and 
skeleta of state-calls appearing in right-hand-sides of rules. 
%states that if a certain
%parameter is depth proper and appears nested in the right-hand side of a rule,
%then a parameter of the nested state is depth proper as well. 

\begin{lemma}\label{lm:dec}
Let $M=(Q,P,\Sigma,\Delta,q_0,R,h)$ be an mttr and let
$q\in Q^{(m)}$, $m\geq 1$, $j\in[m]$, and $p\in P$.
It is decidable whether or not 
$\lcop{M_q(L_p)}_{\{y_j\}}$ is finite.
In case of finiteness, 
$\lcop{M_q(L_p)}_{\{y_j\}}$ can be constructed.
\end{lemma}
\begin{proof}
Let $Z=\{y_j\}$.
We now consider symbols in $Y_m$ as rank zero symbols.
It is straightforward to construct a  top-down tree transducer with look-ahead $T_Z$ which outputs
$\lcop{t}_Z$ for input trees $t\in T_{\Delta\cup T_m}$.
The transducer $T_Z$ computes in its look-ahead $h'$ the set of parameters of
the input tree, i.e.\ $h'(t)=\paras{t}$ for every $t\in T_{\Delta\cup Y_m}$. 
The transducer $T_Z$ (which consists of a single state only) outputs $\paras{t}$
as soon as $\paras{t}\cap Z=\emptyset$. The details can be found in the Appendix.
\qed
\end{proof}

Since for a pair $(q,p)$ it is decidable whether or not it is reachable
(see Section~\ref{sect:mtt}), Lemma~\ref{lm:dec} implies that
it is decidable whether or not a given mttr is depth proper.
We conclude this section with a small lemma showing that, given a 
right-hand-side of rule $t$, the skeleton of $t$ is compatible with 
the skeleta of state calls appearing in $t$. 

To define this notion of compatibility, we consider the second-order 
substitution of a state call (in the right-hand-side of a rule) with the 
state's skeleton, which induces a 
first-order substitution of the parameters in the skeleton. We take such 
first-order substitutions to apply \emph{within} sequence nodes of the skeleton 
so that, given a sequence node $S=\{y_1,y_3\}$: 
$S[y_i \leftarrow t_i]_{i\in [3]} = \{t_1,t_3\}$. 
We assume given an mttr $M$ as before, with the condition that 
$M$ is \emph{nondeleting}, which 
means that all parameters of a state are used to build the state's output.

\begin{definition}\label{def:meta-skeleta}
For all states $q \in Q^{(m)}, q'\in Q^{(m')}$, $\sigma\in\Sigma^{(k)}$, 
and $p_1,\dots,p_k\in P$, and noting $p=h(\sigma(p_1, \dots, p_k))$ and  
$t=\text{rhs}_M(q,\sigma,\<p_1,\dots, p_k>)$, any state call $\<q',x_i>$ 
in $t$ is \emph{compatible} with a set 
$Z \subseteq Y_m$ if, for all $s_i \in L_{p_i}$, the sequence nodes in 
$t[\![\<q',x_i>\leftarrow \lcop{M_{q'}(s_i)}_{Y(q',p_i)}]\!]$ contain no 
parameters from $Z$. 
\end{definition}

This notion of compatibility allows us to define the $Z$-skeleton of \\
$t[\![\<q',x_i>\leftarrow \lcop{M_{q'}(s_i)}_{Y(q',p_i)}]\!]$ inductively as 
before, with a new case for sequence nodes whose parameters have been 
substituted: for all sequence node $S=\{t'_1, \dots, t'_n\}$ we have 
$\lcop{S}_Z=\paras{S} = \bigcup_{j\in[n]} \paras{t'_j}$. 

\begin{lemma}\label{lm:rhs}
Let $M$ be an mttr as before.
Let $q,q'\in Q$, $\sigma\in\Sigma^{(k)}$, and
$p,p_1,\dots,p_k\in P$ such that $p=h(\sigma(p_1, \dots, p_k))$ and 
the tree $t=\text{rhs}_M(q,\sigma,\<p_1,\dots, p_k>)$ contains 
a subtree $\< q',x_i>(t_1,\dots,t_m)$.
\begin{enumerate}
\item[(1)] If $y\in Y(q,p)$ and $y$ occurs in $t_j$ ($j\in[m]$), 
then $y_j\in Y(q',p_i)$.
\item[(2)] Any state call $\<q',x_i>$ in $t$ is compatible with $Y(q,p)$. 
\item[(3)] For all input tree $s_i\in L_{p_i}$, we have: ~~~~
$\lcop{t[\![\dots]\!]}_{Y(q,p)} = \lcop{t[\![\lcop{\dots}]\!]}_{Y(q,p)}$ \\
where $[\![\dots]\!]$ denotes $[\![\<q',x_i>\leftarrow M_{q'}(s_i)]\!]$ \\
and $[\![\lcop{\dots}]\!]$ denotes $[\![\<q',x_i>\leftarrow \lcop{M_{q'}(s_i)}_{Y(q',p_i)} ]\!]$. 
\end{enumerate}
\end{lemma}
\begin{proof}
If $y_j\notin Y(q',p_i)$ then $\lcop{M_{q'}(L_{p_i})}_{y_j}$ is 
infinite and, if $y$ occurs in $t_j$ ($j\in[m]$), then 
$\lcop{M_{q}(L_{p})}_{y}$ is also infinite and $y\notin Y(q,p)$. 
So~(1)~holds. 

%(2)~is a consequence of~(1).
%Alternative proof of (2):
If $y \in Y(q,p)$ occurs in a sequence node of 
$t[\![\lcop{\dots}]\!]$, then it 
would occur in a $t_j$ with $y_j \notin Y(q',p_i)$, which contradicts~(1). 
So~(2)~holds. 

%As a consequence of~(1), parameter nodes and inner nodes are identical in 
%$\lcop{t[\![\dots]\!]}_{Y(q,p)}$ and 
%$\lcop{t[\![\lcop{\dots}]\!]}_{Y(q,p)}$. 
%Sequence nodes are also identical as a consequence of Lemma~\ref{lm:nd}(2). 
%Therefore~(3)~holds. 
%Alternatice proof of (3)
Both $\lcop{t[\![\dots]\!]}_{Y(q,p)}$ and 
$\lcop{t[\![\lcop{\dots}]\!]}_{Y(q,p)}$ contain three types of nodes: 
parameter nodes of the form $y\in Y(q,p)$, inner nodes and sequence nodes. 
As a consequence of~(1), paths to parameters nodes are identical in 
$\lcop{t[\![\dots]\!]}_{Y(q,p)}$ 
and $\lcop{t[\![\lcop{\dots}]\!]}_{Y(q,p)}$, and the same is true of the 
inner nodes along such paths. 
Sequence nodes are also identical as a consequence of Lemma~\ref{lm:nd}(2). 

%Another alternatice proof of (3)
%To prove~(3)~we look at the $Y(q,p)$-skeleta of $t[\![\dots]\!]$ and 
%$t[\![\lcop{\dots}]\!]$. Those contain three types of nodes: 
%parameter nodes of the form $y\in Y(q,p)$, inner nodes (which are along 
%the paths to parameter nodes), and sequence nodes. Paths to parameters nodes 
%are identical in $t[\![\dots]\!]$ as in $t[\![\lcop{\dots}]\!]$ and so 
%are the inner nodes along such paths. Sequence nodes are also identical as a 
%consequence of Lemma~\ref{lm:nd}(2). 
\qed
\end{proof}


\subsection{Construction of the Normal Form and Examples}
\label{sect:examples}

%\subsection{Formal Construction of the Depth Proper Normal Form}
%\label{sect:dp}

Let $M$ be an mttr as before. 
We assume that $M$ is nondeleting (which is justified by 
Proposition~\ref{prop:nondeleting}).
The idea of the construction is as follows.
First, we determine all reachable pairs $(q,p)$ 
such that $Y(q,p)\not=\emptyset$.
Let $(q,p)$ be such a pair and let $Z=Y(q,p)$.
An occurrence of $\<q,x_i>$ in a right-hand side
$\text{rhs}_M(q',\sigma,\< p_1,\dots,p_k>)$ such that $p_i=p$ is
called a \emph{$(q,p)$-call}. Our aim is to replace each $(q,p)$-call
by an appropriate tree from $\lcop{M_q(L_p)}_Z$. Just which tree is
the appropriate one will be determined by regular look-ahead. 
Moreover, such trees should be modified not to contain leaf nodes 
labeled by subsets of $Y$: such nodes will be replaced by 
calls of new ``helper states''. 

We now present the formal construction of the transducer $\pi(M)$.
Note that in general, $\pi(M)$ is \emph{not} depth proper yet, but
the construction needs to be iterated several times (cf. the examples in
Section~\ref{sect:examples}).

\begin{definition}
\label{df:pi}
Let $M=(Q,P,\Sigma,\Delta,q_0,R,h)$ be a nondeleting mttr.
We construct the new mttr
$\pi(M)=(Q\cup H,P',\Sigma,\Delta,q_0,R',h')$.
% The sets $H$ and $P'$ are defined as follows.
Let $q\in Q^{(m)}$, $m\geq 1$, and $p\in P$ such that $Y(q,p)\not=\emptyset$.
If there are no such $q,m,p$, then $M$ is 
depth proper already.
Otherwise $H$ contains the following set of helper states:
\[
\{ [q,p,t,u]^{(|U|)}\mid 
t\in \lcop{M_q(L_p)}_{Y(q,p)}, 
u\in V(t),
t/u=U\subseteq Y_m, 
Y(q,p)\not=\emptyset \}.
\]
Moreover, the set $P'$ contains $(p,\varphi)$ for any
function $\varphi$ that assigns to each $q\in F_p$ 
a tree in $\lcop{M_q(L_p)}_{Y(q,p)}$.
Note that $|U|\leq |Y_m \setminus Y(q,p)|$; since $Y(q,p)$ is non-empty this implies that
the rank of each helper state is at most $(r-1)$, where $r$ is the maximal
rank of the states in $Q$. 
For every $q\in Q^{(m)}$, $m\geq 0$, 
$\sigma\in\Sigma^{(k)}$, $k\geq 0$, and 
$(p_1,\varphi_1),\dots,(p_k,\varphi_k)\in P'$ we let the rule
\[
\<q,\sigma(x_1:(p_1,\varphi_1),\dots,x_k:(p_i,\varphi_i)>(y_1,\dots,y_m)
\to\text{rhs}_M(q,\sigma,\<p_1,\dots,p_k>)[\![ . ]\!]
\]
be in $R$', where the second-order tree substitution
$[\![ . ]\!]$ is defined as follows.
\begin{multline*}
[\![ . ]\!] = 
[\![\< q',x_i>\leftarrow \varphi_i(q')[
u\leftarrow [q',p_i,\varphi_i(q'),u](y_{j_1},\dots,y_{j_n})\mid \\
\varphi_i(q')/u=\{y_{j_1},\dots,y_{j_n}\},
j_1<\cdots <j_n] \mid q'\in F_{p_i}, i\in[k]
 ]\!].
\end{multline*}
We define $h_\sigma'((p_1,\varphi_1),\dots,(p_k,\varphi_k))=(p,\varphi)$
where $p=h_\sigma(p_1,\dots,p_k)$ and for every 
$q\in F_p$, 
\[
\varphi(q)=
\lcop{
\text{rhs}_M(q,\sigma,\<p_1,\dots,p_k>)
[\![\< q',x_i>\leftarrow \varphi_i(q')\mid q'\in F_{p_i}, i\in[k]]\!]
}_{Y(q,p)}.
\]
%
For every helper state $[q,p,t,u]\in H^{(n)}$, $n\geq 0$,
$\sigma\in\Sigma^{(k)}$, $k\geq 0$, and 
$(p_1,\varphi_1),\dots,$ $(p_k,\varphi_k)\in P'$ 
such that $h_\sigma(p_1,\dots,p_k)=p$
we let the rule
\[
\<[q,p,t,u](\sigma(x_1:(p_1,\varphi_1),\dots,x_k:(p_k,\varphi_k))>(y_1,\dots,y_n)
\to \xi/u[y_{j_\nu}\leftarrow y_\nu\mid\nu\in[n]]
\]
be in $R'$ where
$t/u=\{y_{j_1},\dots,y_{j_n}\}$,
$j_1<\cdots <j_n$,
$\xi=\text{rhs}_M(q,\sigma,\<p_1,\dots,p_k>)[\![ . ]\!]$, and
$[\![ . ]\!]$ is the substitution from above.
\end{definition}

\input{example}

\subsection{Correctness Proof and Termination of Iteration}
\label{sect:corr}

Here we prove the correctness of transducer $\pi(M)$ that was defined
in Definition~\ref{df_depth_proper}. Lemma~\ref{lm:corr} establishes
the correctness of the look-ahead, relates the states of $\pi(M)$ to those
of $M$, and shows that the transducer $\pi(M)$ is nondeleting.
The latter is needed, so that the construction of $\pi$ can be carried
out iteratively (recall from Definition~\ref{df_depth_proper} that $M$ is
required to be nondeleting, in order to construct $\pi(M)$).


\begin{lemma}
\label{lm:corr}
Let $M$ be a nondeleting mttr and $N=\pi(M)$ be the mtt of
Definition~\ref{df:pi}, both with the tuples as in that definition. 
Let $s\in T_\Sigma$ with $h'(s)=(p,\varphi)$.
Then
\begin{enumerate}
\item[(1)] $p=h(s)$,
\item[(2)] $\forall q\in F_p$: $\varphi(q)=\lcop{M_q(s)}_{Y(q,p)}$, 
\item[(3)] $\forall q\in Q$: $N_q(s)=M_q(s)$,
\item[(4)] $\forall q\in F_p$ and $u\in V(t)$ with $t=\varphi(q)$ and
$t/u=\{y_{j_1},\dots,y_{j_n}\}$ with \\
$j_1<\cdots <j_n$:
$N_{[q,p,t,u]}(s)=M_q(s)/u[y_{j_\nu}\leftarrow y_\nu\mid\nu\in[n]]$, and
\item[(5)] the mttr $N$ is nondeleting.
\end{enumerate}
\end{lemma}
\begin{proof}
All the statements are proven by induction on the structure of $s$.
Let $s=\sigma(s_1,\dots,s_k)$ with $\sigma\in\Sigma^{(k)}$,
$k\geq 0$, and $s_1,\dots,s_k\in T_\Sigma$.
For $i\in[k]$ let $h'(s_i)=(p_i,\varphi_i)$.
By the definition of $h'$, $p=h_\sigma(p_1,\dots,p_k)$, which 
is equal to $h(s)$.
Thus, Statement~(1) holds.
For Statement~(2) let $q\in F_p$: 
Then $\varphi(q)$ is defined as 
$\lcop{\zeta[\![\varphi_i]\!]}_{Y(q,p)}$ where 
$\zeta=\text{rhs}_M(q,\sigma,\<p_1,\dots,p_k>)$
and
$[\![\varphi_i]\!]$ denotes the substitution
$[\![ \< q',x_i>\leftarrow \varphi_i(q')\mid q'\in F_{p_i}, i\in[k]]\!]$.
By induction, $\lcop{\zeta[\![\varphi_i]\!]}_{Y(q,p)}$ equals
$\lcop{\zeta[\![ \< q',x_i>\leftarrow \lcop{M_{q'}(s_i)}_{Y(q',p_i)}
\mid q'\in F_{p_i}, i\in[k]]\!]}_{Y(q,p)}$.
By Lemma~\ref{lm:rhs}(3) the latter equals
$\lcop{\zeta[\![ \< q',x_i>\leftarrow M_{q'}(s_i)
\mid q'\in F_{p_i}, i\in[k]]\!]}_{Y(q,p)}
=\lcop{M(s)}_{Y(q,p)}$.


We now prove Statement~(3).
Let $q\in Q$.
Then $N_q(s)=\zeta[\![ . ]\!][\![N]\!]$, 
where 
$\zeta=\text{rhs}_M(q,\sigma,\<p_1,\dots,p_k>)$,
$[\![ . ]\!]$ is the substitution as in the construction, and
$[\![N]\!]=
[\![ \<r,x_i>\leftarrow N_r(s_i)\mid r\in Q',i\in[k] ]\!]$.
%
By the induction hypothesis of Statement~(2), we can replace
$\varphi_i(q')$ by $\lcop{M_{q'}(s_i)}_{Y(q',p_i)}$ in the
substitution $[\![ . ]\!]$. This gives
\begin{multline*}
\zeta
[\![ \<q',x_i>\leftarrow \lcop{M_{q'}(s_i)}_{Y(q',p_i)}
[
u'\leftarrow [q',p_i,\varphi_i(q'),u'](y_{j_1},\dots,y_{j_n})\mid \\
\varphi_i(q')/u'=\{y_{j_1},\dots,y_{j_n}\},
j_1<\cdots <j_n]
\mid q'\in F_{p_i},
i\in[k] ]\!]
[\![ N ]\!].
\end{multline*}
This can be written as 
$\zeta[\![.]\!][\![ H ]\!] [\![ Q ]\!]$,
where
$[\![ H ]\!]=[\![\< q',x_i>\leftarrow N_{q'}(s_i)\mid q'\in H,i\in[k] ]\!]$
and
$[\![ Q ]\!]  = 
[\![\< q',x_i>\leftarrow N_{q'}(s_i)\mid q'\in (Q \setminus F_{p_i}),i\in[k] ]\!]$.
%
By induction of Statement~(4) the substitution $[\![ H]\!]$ replaces the 
subtree $[q',p_i,\varphi_i(q'),u'](y_{j_1},\dots,y_{j_n})$ by the tree 
$M_{q'}(s_i)/u[y_{j_\nu}\leftarrow y_\nu\mid\nu\in[n]]
[y_\nu\leftarrow y_{j_\nu}\mid\nu\in[n]]=M_{q'}(s_i)/u$. 
Thus we obtain:
\begin{multline*}
\zeta
[\![ \<q',x_i>\leftarrow \lcop{M_{q'}(s_i)}_{Y(q',p_i)}
[
u'\leftarrow M_{q'}(s_i)/u'\mid 
u'\in\mathcal{U}(\lcop{M_{q'}(s_i)}_{Y(q',p_i)})]\\
\mid q'\in F_{p_i},
i\in[k] ]\!] 
[\![ Q ]\!]
\end{multline*}
By Lemma~\ref{lm:nd} (for $Z=Y(q',p_i)$ and $t=M_{q'}(s_i)$)
the tree on the right of the arrow
in the leftmost second-order substitution equals $M_{q'}(s_i)$.
We have:
\[
\zeta
[\![ \<q',x_i>\leftarrow M_{q'}(s_i)\mid q'\in F_{p_i},i\in[k] ]\!] 
[\![\< q',x_i>\leftarrow N_{q'}(s_i)\mid q'\in Q \setminus F_{p_i},i\in[k] ]\!].
\]
By induction of Statement~(3), $N_{q'}(s_i)=M_{q'}(s_i)$ for
$q\in Q \setminus F_{p_i}$. This gives us exactly $M_q(s)$, by the definition
of the semantics of mttrs. 
Thus,
\begin{equation}\label{eq:MN}
N_q(s)=\zeta[\![ . ]\!][\![N]\!]=M_q(s).
\end{equation}
This concludes the proof of Statement~(3).


We now prove Statement~(4).
Let $q\in F_p$ and $u\in V(t)$ with $t=\varphi(q)$ 
and $t/u\subseteq Y$.
By the definition of the rules for the helper states, \\
$N_{[q,p,t,u]}(s)=(\zeta[\![ . ]\!])/u[\![ N ]\!][y]$
where $t/u=\{y_{j_1},\dots,y_{j_n}\}$, $j_1<\cdots <j_n$, and \\
$[y]=[y_{j_\nu}\leftarrow y_\nu\mid\nu\in[n]]$.
It follows from Lemma~\ref{lm:rhs}(1) that if $\<q',x_i>$ occurs in \\
$\zeta=\text{rhs}_M(q,\sigma,\<p_1,\dots,p_k>)$
and $q\in F_p$, then $q'\not\in Q \setminus F_{p_i}$.
Hence, every proper ancestor
$v$ of $u$ is labeled by a symbol in $\Delta$, i.e.,
$(\zeta[\![.]\!][y])[v]\in\Delta$. 
This implies that we can move the ``$/u$'' operation of 
taking the subtree at node $u$
to the right (after the application of the substitution $[\![ N ]\!]$)
in the above displayed formula.
We obtain 
$\zeta[\![ . ]\!][\![ N ]\!]/u[y]$.
By the right equation in Formula~\ref{eq:MN}, this equals
$M_q(s)/u[y]$.

To prove Statement~(5), let $q\in Q^{(m)}$, $m\geq 0$.
Then \\
$\zeta'=\text{rhs}_N(q,\sigma,\< (p_1,\varphi_1),\dots,(p_k,\varphi_k)>)=
\zeta[\![.]\!]$, where 
$\zeta=\text{rhs}_M(q,\sigma,\<p_1,\dots,p_k>)$ and
$[\![.]\!]$ as before. 
By Statement~(2), $[\![.]\!]$ substitutes occurrences of 
$\<q',x_i>$ with $i\in[k]$ and $q'\in F_{p_i}$ by 
the tree $\lcop{M_{q'}(s_i)}_{Y(q',p_i)}$ in which leaves
labeled by $Z\subseteq Y_m$ are replaced by $\<q_H,x_i>(y_{j_1},\dots,
y_{j_n})$ with $Z=\{y_{j_1},\dots,y_{j_n}\}$.
By Lemma~\ref{lm:nd}(2) this implies that 
$y_j$ occurs in $\zeta'$ for each $j\in[m]$.
\qed
\end{proof}

\input{termination}
