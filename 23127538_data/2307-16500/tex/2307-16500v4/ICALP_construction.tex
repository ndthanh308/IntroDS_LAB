%!TEX root = main.tex
\section{Depth Proper Normal Form}

The depth proper normal form requires that each parameter of
each state $q$ occurs at unbounded depth in the output trees of that state 
(for each given look-ahead state $p$ such that $(q,p)$ is reachable).
Formally, let $q$ be a state of rank $m\geq 1$, $j\in[m]$, and
$p\in P$. 
If $(q,p)$ is reachable, then 
for every natural number $n$ there must exist an input tree $s_n \in L_p$ such that
$y_j$ occurs at depth $>n$ in the tree $M_q(s_n)$.
Conversely, we say that parameter $y_j$ is \emph{depth-bounded} for $q$ and $p$ 
if there exists an $n$ for which no such input tree $s_n \in L_p$ exists;
more generally, we say that $Z\subseteq Y_m$ is
\emph{depth-bounded} for $q$ and $p$, if each $y\in Z$ is depth-bounded for $q$ and $p$.

If $Z$ is depth-bounded for $q$ and $p$, then there are only finitely many output paths
in the trees in $M_q(L_p)$ under which the parameters from $Z$ occur.
The \emph{$Z$-skeleton} of an arbitrary tree $t$ is obtained from $t$
by replacing each top-most node $u$ such that $t/u$ does not contain any
occurrence of a parameter from $Z$ by some symbol. 
Clearly, $Z$ is depth-bounded for $q$ and $p$ if and only if the $Z$-skeleta of
all trees in $M_q(L_p)$ form a finite set.

Let $\Delta$ be an arbitrary ranked alphabet, $m\geq 1$, 
$t\in T_\Delta(Y_m)$, and $Z\subseteq Y_m$.
Let us write \(\paras{t}\subseteq{Y_m}\) for the set of parameters 
occurring in $t$.
Let us now be more specific as to which symbols replace the top-most nodes $u$
of $t$ such that $\paras{t/u}\cap Z=\emptyset$. Since in our construction later
we will want to obtain a transducer that is nondeleting, it will be helpful
to know which parameters appear in a given deleted tree. Therefore we replace
such nodes $u$ by the set $\paras{t/u}$. 
We denote by $\lcop{t}_Z$ the $Z$-skeleton of $t$ and define it inductively as follows
(where $\delta\in\Delta$):
\begin{align*}
\lcop{t}_Z &= 
\begin{cases}
t &
\text{if \(t\in Z\)}
\\
\delta(\lcop{t_1}_Z,\dots,\lcop{t_n}_Z) &
\text{if \(\paras{t}\cap Z\ne\emptyset\) and \(t = \delta(t_1,\dots,t_n)\)}
\\
\paras{t} & \text{if \(\paras{t}\cap Z = \emptyset\)}.
\end{cases}
\end{align*}

The definition of $\lcop{t}_Z$ is extended to sets $L$ of trees
as $\lcop{L}_Z=\{\lcop{t}_Z\mid t\in L\}$.
We call \emph{$Y$-nodes} the nodes $u$ in $V(\lcop{t}_Z)$ such 
that $\lcop{t}_Z/u=Z'\subseteq Y_m$. We denote by 
$\mathcal{U}(\lcop{t}_Z)$ the set of $Y$-nodes on $\lcop{t}_Z$. 
The notion of parameters in a tree naturally extends to $Z$-skeleta with, 
for a $Y$-node labeled $Z'$: $\paras{Z'} = Z'$. 
The proof of the next lemma is straightforward by induction on $t$
(see the Appendix).

\begin{lemma}\label{lm:nd}
Let $\Delta$ be a ranked alphabet, $m\geq 1$, $Z\subseteq Y_m$, and
$t\in T_\Delta(Y_m)$.
(1)~$t=\lcop{t}_Z[u\leftarrow t/u\mid u\in\mathcal{U}(\lcop{t}_Z)]$.
(2)~$\paras{\lcop{t}_Z} = \paras{t}$. 
%(3)~If $y\in Y_m$ occurs in $t$, then 
%there exists a leaf $u\in V(\lcop{t}_Z)$
%such that either $\lcop{t}_Z/u=y$ or 
%$\lcop{t}_Z/u=Z'\subseteq Y_m$ and $y\in Z'$.
\end{lemma}

%%Sebastian's version:
%The proof is by induction on the structure of $t$.
%Let us denote the substitution $[u\leftarrow t/u\mid u\in\mathcal{U}(\lcop{t}_Z)]$
%by $[t]$.
%%
%We first consider $t=y\in Y$. There are two cases.
%
%Case 1: $y\in Z$. Then $\mathcal{U}(\lcop{t}_Z)=\emptyset$.
%Hence $\lcop{t}_Z[t]=\lcop{y}_Z$. The latter equals $y=t$ by 
%the definition of $\lcop{.}_Z$. Thus~(1)~holds and~(2)~holds for $u=\epsilon$.
%
%Case 2: $y\not\in Z$. Then $\mathcal{U}(\lcop{t}_Z)=\{ \epsilon \}$ and hence
%$\lcop{t}_Z[t] = \lcop{t}_Z[\epsilon\leftarrow t/\epsilon = t] = t$ which proves~(1).
%Moreover, $\lcop{t}_Z=\{y_j\}$ by the definition of $\lcop{.}_Z$,
%i.e., again~(2)~holds for $u=\varepsilon$.
%
%Now consider $t=\delta(t_1,\dots,t_n)$, $\delta\in\Delta^{(n)}$, $n\geq 0$,
%and $t_1,\dots, t_n\in T_\Delta(Y_m)$.
%To show~(1) we obtain from the definition $\lcop{t}_Z$ that
%\[
%\lcop{t}_Z[t]=\delta(\lcop{t_1}_Z,\dots,\lcop{t_n}_Z)[t]
%= \delta(\lcop{t_1}_Z[t_1],\dots,\lcop{t_n}_Z[t_n]),
%\]
%where for $i\in[n]$, $[t_i]$ denotes the substitution
%$[u\leftarrow t_i/u\mid u\in\mathcal{U}(\lcop{t_i}_Z)]$.
%By induction the latter equals $\delta(t_1,\dots,t_n)=t$.
%To show~(2) we assume that $y_j$ occurs in $t$ for some $j\in[m]$.
%Thus, $n\geq 1$ and there exists an $i\in[n]$
%such that $y_j$ occurs in $t_i$.
%By the induction for Statement~(2), there exists a leaf $u$ of $t_i$ such that 
%the Statement~(2) holds (for $u$ and $t_i$), and therefore Statement~(2) holds
%for $iu$ and $t$.
%\end{proof}

Finally, we define depth properness for mtts with look-ahead. 

\begin{definition} \label{df_depth_proper}
The mttr $M=(Q,P,\Sigma,\Delta,q_0,R,h)$ is in \emph{depth proper normal form}
(or, synonymously, $M$ is \emph{depth proper})
if for every $q\in Q^{(m)}$, $m\geq 1$, and $p\in P$ it holds that
if $(q,p)$ is reachable, then  
$\lcop{M_q(L_p)}_{\{y_j\}}$ is infinite for all $j\in[m]$.
\end{definition}

From now on we will want to make use of the following definitions:
\[
\begin{array}{lcl}
F_p &=& \{ q\in Q^{(m)}\mid \exists j\in[m], \lcop{M_q(L_p)}_{\{y_j\}}
\text{ is finite}\}\\
Y(q,p) &=& \{ y_j\mid j\in[\text{rank}_Q(q)]\text{ such that }
\lcop{M_q(L_p)}_{\{y_j\}}\text{ is finite}\}
\end{array}
\]

It should be clear that $\lcop{M_q(L_p)}_{Y(q,p)}$ is finite for every $q$ and $p$,
as stated in the next lemma (the proof is in the Appendix).

\begin{lemma}\label{lm:lcop_finite}
Let $M$ be an mtt, $q$ a state of $M$, and $p$ a look-ahead state of $M$
such that $Y(q,p)\not=\emptyset$.
Then $\lcop{M_q(L_p)}_{Y(q,p)}$ is finite.
\end{lemma}

\input{ICALP_constr_plus_examples.tex}

\subsection{Correctness Proof and Termination of Iteration}
\label{sect:corr}

Here we prove the correctness of transducer $\pi(M)$ that was defined
in Definition~\ref{df_depth_proper}. Lemma~\ref{lm:corr} establishes
the correctness of the look-ahead, relates the states of $\pi(M)$ to those
of $M$, and shows that the transducer $\pi(M)$ is nondeleting.
The latter is needed, so that the construction of $\pi$ can be carried
out iteratively (recall from Definition~\ref{df_depth_proper} that $M$ is
required to be nondeleting, in order to construct $\pi(M)$).
The proof of the following lemma is somewhat involved but
rather technical and can be found in the Appendix; to prove Point~(2)
it uses a ``special'' kind of second-order tree substitution
which replace $Y$-nodes by new Y-nodes consisting of parameters in the output trees that
would have been substituted for the parameters in the original $Y$-node.


\begin{lemma}
\label{lm:corr}
Let $M$ be a nondeleting mttr and $N=\pi(M)$ be the mttr of
Definition~\ref{df:pi}, both with the tuples as in that definition. 
Let $s\in T_\Sigma$ with $\hat{h'}(s)=(p,\varphi)$.
%Then
\begin{enumerate}
\item[(1)] $p=\hat{h}(s)$,
\item[(2)] $\forall q\in F_p$: $\varphi(q)=\lcop{M_q(s)}_{Y(q,p)}$, 
\item[(3)] $\forall q\in Q$: $N_q(s)=M_q(s)$,
\item[(4)] $\forall q\in F_p$ and $u\in V(t)$ with $t=\varphi(q)$ and
$t/u=\{y_{j_1},\dots,y_{j_n}\}$ with \\
$j_1<\cdots <j_n$:
$N_{[q,p,t,u]}(s)=M_q(s)/u[y_{j_\nu}\leftarrow y_\nu\mid\nu\in[n]]$, and
\item[(5)] the mttr $N$ is nondeleting.
\end{enumerate}
\end{lemma}

\input{ICALP_termination}

