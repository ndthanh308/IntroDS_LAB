\subsection{Construction of the Normal Form and Examples}
\label{sect:examples}

%\subsection{Formal Construction of the Depth Proper Normal Form}
%\label{sect:dp}

Let $M$ be an mttr as before. 
We assume that $M$ is nondeleting (which is justified by 
Proposition~\ref{prop:nondeleting}).
The idea of the construction is as follows.
First, we determine all reachable pairs $(q,p)$ 
such that $Y(q,p)\not=\emptyset$.
Let $(q,p)$ be such a pair and let $Z=Y(q,p)$.
An occurrence of $\<q,x_i>$ in a right-hand side
$\text{rhs}_M(q',\sigma,\< p_1,\dots,p_k>)$ such that $p_i=p$ is
called a \emph{$(q,p)$-call}. Our aim is to replace each $(q,p)$-call
by an appropriate tree from $\lcop{M_q(L_p)}_Z$. Just which tree is
the appropriate one will be determined by regular look-ahead. 
Moreover, such trees should be modified not to contain leaf nodes 
labeled by subsets of $Y$: such nodes will be replaced by 
calls of new ``helper states''. 

%We now present the formal construction of the transducer $\pi(M)$.
%Note that in general, $\pi(M)$ is \emph{not} depth proper yet, but
%the construction needs to be iterated several times (cf. the examples in
%Section~\ref{sect:examples}).

\begin{definition}
\label{df:pi}
Let $M=(Q,P,\Sigma,\Delta,q_0,R,h)$ be a nondeleting mttr
that is not depth proper.
We construct the new mttr
$\pi(M)=(Q\cup H,P',\Sigma,\Delta,q_0,R',h')$.
% The sets $H$ and $P'$ are defined as follows.
For every 
$q\in Q^{(m)}$, $m\geq 1$, and $p\in P$ such that $Y(q,p)\not=\emptyset$,
$H$ contains the following set of helper states:
\[
\{ [q,p,t,u]^{(|U|)}\mid 
t\in \lcop{M_q(L_p)}_{Y(q,p)}, 
u\in V(t),
t/u=U\subseteq Y_m \}
\]
and $P'$ contains $(p,\varphi)$ for any
function $\varphi$ that assigns to each $q\in F_p$ 
a tree in $\lcop{M_q(L_p)}_{Y(q,p)}$.
%
Observe that $H$ and $P'$ are well defined, because
$\lcop{M_q(L_p)}_{Y(q,p)}$ is finite by Lemma~\ref{lm:lcop_finite}. 
%
Note that $|U|\leq |Y_m \setminus Y(q,p)|$; since $Y(q,p)$ is non-empty this implies that
the rank of each helper state is at most $(r-1)$, where $r$ is the maximal
rank of the states in $Q$. 

For every $q\in Q^{(m)}$, $m\geq 0$, 
$\sigma\in\Sigma^{(k)}$, $k\geq 0$, and 
$(p_1,\varphi_1),\dots,(p_k,\varphi_k)\in P'$ we let the rule
\[
\<q,\sigma(x_1:(p_1,\varphi_1),\dots,x_k:(p_i,\varphi_i)>(y_1,\dots,y_m)
\to\text{rhs}_M(q,\sigma,\<p_1,\dots,p_k>)[\![ . ]\!]
\]
be in $R'$, where the second-order tree substitution
$[\![ . ]\!]$ is defined as follows.
\begin{multline*}
[\![ . ]\!] = 
[\![\< q',x_i>\leftarrow \varphi_i(q')\big[
u\leftarrow [q',p_i,\varphi_i(q'),u](y_{j_1},\dots,y_{j_n})\mid \\
\varphi_i(q')/u=\{y_{j_1},\dots,y_{j_n}\},
j_1<\cdots <j_n\big] \mid q'\in F_{p_i}, i\in[k]
 ]\!].
\end{multline*}
We define $h_\sigma'((p_1,\varphi_1),\dots,(p_k,\varphi_k))=(p,\varphi)$
where $p=h_\sigma(p_1,\dots,p_k)$ and, using special second-order substitution 
from Definition~\ref{def:meta-skeleta}, for every $q\in F_p$,  
\[
\varphi(q)=
\lcop{
\text{rhs}_M(q,\sigma,\<p_1,\dots,p_k>)
[\![\< q',x_i>\leftarrow \varphi_i(q')\mid q'\in F_{p_i}, i\in[k]]\!]\su
}_{Y(q,p)}.
\]
%
For every helper state $[q,p,t,u]\in H^{(n)}$, $n\geq 0$,
$\sigma\in\Sigma^{(k)}$, $k\geq 0$, and 
$(p_1,\varphi_1),\dots,$ $(p_k,\varphi_k)\in P'$ 
such that $h_\sigma(p_1,\dots,p_k)=p$
we let the rule
\[
\<[q,p,t,u](\sigma(x_1:(p_1,\varphi_1),\dots,x_k:(p_k,\varphi_k))>(y_1,\dots,y_n)
\to \xi/u[y_{j_\nu}\leftarrow y_\nu\mid\nu\in[n]]
\]
be in $R'$ where
$t/u=\{y_{j_1},\dots,y_{j_n}\}$,
$j_1<\cdots <j_n$,
$\xi=\text{rhs}_M(q,\sigma,\<p_1,\dots,p_k>)[\![ . ]\!]$, and
$[\![ . ]\!]$ is the substitution from above.
\end{definition}

\input{ICALP_example}

