%\documentclass{article}

%\usepackage[utf8]{inputenc}
%\usepackage[a4paper,left=20mm,right=20mm, top=2cm, bottom=2cm]{geometry}
%\usepackage[style=numeric]{biblatex}
%\usepackage{algpseudocode}
%\usepackage[]{siunitx}
%\usepackage{algorithm}
%\usepackage{hyperref}
%\usepackage{graphicx}
%\usepackage{amsmath}
%\usepackage{subfig}
%\usepackage{color}
%\usepackage{float}

%\addbibresource{bib/bib_jmw.bib}



%\begin{document}

%\maketitle

\documentclass{article}
\usepackage[utf8]{inputenc}
\RequirePackage[a4paper]{geometry}
\geometry{top=25mm,bottom=25mm,left=25mm,right=25mm,nohead,nofoot,includeheadfoot}
\pagestyle{empty}
\usepackage{mathptmx,graphicx}
\usepackage{siunitx}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{amsthm}
\usepackage{abstract}

\usepackage[utf8]{inputenc}
%\usepackage[a4paper,left=20mm,right=20mm, top=2cm, bottom=2cm]{geometry}
%\usepackage[style=numeric]{biblatex}
\usepackage{algpseudocode}
\usepackage[]{siunitx}
\usepackage{algorithm}
\usepackage{hyperref}
\usepackage{graphicx}
\usepackage{amsmath}
\usepackage{subfig}
\usepackage{color}
\usepackage{float}
\usepackage{lineno}
%\linenumbers
\usepackage[
style=nature,
]{biblatex}
\addbibresource{bib_jmw.bib} %Import the bibliography file


\begin{document}

\begin{center}
{\Large\bfseries
Supplementary Information \par}
\vspace{3ex}
{\bfseries
Kilian Scheffter$^{1,2}$, Jonathan Will$^{1,2}$, Claudius Riek$^{3}$, Herve Jousselin$^{4}$, Sébastien Coudreau$^{4}$, Nicolas Forget$^{4}$, Hanieh Fattahi$^{1,2}$\par}
{\footnotesize\itshape
1. Max Planck Institute for the Science of Light, Staudtstr. 2, 91058 Erlangen, Germany\\
2. Friedrich-Alexander University Erlangen-Nürnberg, Staudtrstr. 7, 91085 Erlangen, Germany\\
3. Zurich Instruments Germany, Mühldorfstraße 15, 81671 Munich, Germany\\
4. Fastlite, rue des Cistes 165, 06600 Antibes, France
\par}
\vspace{3ex}
\end{center}

\section{Experimental setup}

\subsection{Lock-in detection}

To minimize measurement noise, the experiment uses lock-in detection to measure the signal from the balanced photodetector. Ideally, the balanced photodetector output yields $\SI{0}{V}$ in the absence of the THz-pulse. However, drifts can occur due to alignment imperfections or changes caused by thermal effects or by scanning the delay with the Dazzler or mechanical delay stage. To remove these drifts, the THz-pulses are chopped at half the laser repetition rate. Consequently, the balanced photodetector measures periodically one probe pulse with the THz-field and one without it. Since drifts are present in both pulses, it results in a $\SI{1}{kHz}$ signal. However, the information about the THz-field strength is present in only one probe pulse yielding a signal at $\SI{500}{Hz}$. By demodulating the signal of the balanced photodetector with a reference signal at $\SI{500}{Hz}$ in a lock-in amplifier, the resulting signal is free from systematic noise and possesses only information about the THz-field.

\subsection{Synchronization}


Various trigger signals are present in the experimental setup to synchronize the different devices and to ensure accurate data acquisition. Fig. \ref{fig:trigger_signals_path} provides a layout of the different trigger signals. The front-end generates a trigger signal at a frequency of $\SI{1}{kHz}$ (red) corresponding to the outgoing optical pulse train. This signal triggers both the chopper and the Dazzler. To block every other optical pulse, the chopper uses the first subharmonic of this trigger signal with a frequency of $\SI{500}{Hz}$. This chopping frequency is further used as the demodulation frequency of the lock-in amplifier (green). The Dazzler utilizes the trigger of the Legend to trigger an RF-pulse that drives an acoustic wave in the crystal-unit. A control signal is then sent to the electronic control-board via the "GATE"-output S1 of the Dazzler (blue, at $\SI{1}{kHz}$) for every launched RF-pulse, even if the Dazzler is running but not controlled by the computer.


When a measurement is started by the computer, the information about the acoustic pulses launched within the experiment is send via a USB connection to the Dazzler. The "PATTERN-GATE" output of the Dazzler becomes high before the first acoustic wave of the sequence is launched, indicating that the Dazzler is running a user-defined sequence controlled by the computer. This output signal remains high until the sequence is over. To ensure that the lock-in signal is sampled only when the user-defined sequence is played and when a pulse passes through the chopper, an electronic control board is used. The board consists of an AND gate and a D-flip-flop. The AND gate combines the "GATE" and "PATTERN-GATE" outputs of the Dazzler resulting in a $\SI{1}{kHz}$ trigger signal whenever a user-defined sequence is played from the computer. If no user-defined sequence is playing, the AND gate outputs a low signal. In the presence of a sequence, the frequency of the $\SI{1}{kHz}$ trigger signal after the AND gate is divided by two using a D-flip-flop to sample only the lock-in amplifier signal of pulses which are passing through the chopper. The signal leaving the electronic board is triggering the data acquisition of the lock-in amplifier.\\
% Figure environment removed

Due to the lack of synchronization between the chopper and the Dazzler in the setup described above, the Dazzler is unable to determine if a pulse is blocked or transmitted by the chopper during the start of a sequence. As a result, in every second measurement in average, the electronic control board produces an incorrect trigger signal sampling the lock-in amplifier when a pulse is blocked by the chopper. In this case, the measurement must be discarded.

\subsection{Rapid field measurements}

To minimize measurement time, the Dazzler rapidly scans in a shot-to-shot manner, producing the same time delay for a pair of two consecutive probe pulses. Following one pair of probe pulses, a next pair of probe pulses experiences a new delay. As the beam generating the THz-pulse is chopped at half the repetition frequency, each pair of probe pulses coincides with one generated THz-pulse and one blocked pulse. Therefore, for every time-delay within a scan, one probe pulse probes the THz-pulse while the other one serves as a reference. By measuring the probe pulses via a lock-in amplifier, systematic noise present in both probe pulses of a pair is eliminated, leaving only the THz-signal.\\

For large step sizes or random scanning, the measured signal amplitude can jump from zero to the peak value of the THz-pulse. Hence, the probe pulses have to resolve this and it must be captured with the detection electronics. The UHFLI lock-in amplifier from Zurich Instruments can follow such a jump when using the boxcar averager functionality while reducing noise due to the signals low duty-cycle. Here, the temporal moving average (boxcar) ensures a pure signal of the last data point without any residual contribution by prior data due to the exponential filter function used in traditional lock-in amplifiers.\\

\section{Reconstruction strategy}
\label{sec:compressed_sensing}

\subsection{Mathematical Description of Compressed Sensing}

Compressed Sensing is a technique where an analog signal $s(t)$ is sampled with a low number of $M$ sampling points resulting in the measured $M\times 1$ discrete signal $y[t]$. As it is not feasible to mathematically describe sampling an analog signal $s(t)$, an oversampled $N\times 1$ digital signal $s[t]$ with $N>>M$ sampling points represents the original signal. Sampling this signal can then be described with the $M\times N$ sensing matrix $\Phi$

\begin{equation}
y[t] = \Phi s[t].
\label{eq:cs_y}
\end{equation}

As an example, the sensing matrix $\Phi$ can be the spike basis possessing the columns $\phi_i[t] = \delta[t-i]$ in the sensing matrix \cite{4472240}.

Compressed Sensing requires the signal $s[t]$ to be sparse in some orthonormal basis. The original signal $s[t]$ can be expressed in this basis with a $N\times N$ basis matrix $\Psi$ and a $N\times 1$ amplitude vector $\vec{c}$



\begin{equation}
s[t] = \Psi \vec{c}.
\label{eq:cs_s}
\end{equation}

One example for an orthonormal basis is the Fourier-basis with the discrete-Fourier-transform (DFT) matrix as the basis matrix $\Psi$.

The original signal can be regained by solving the equation
\begin{equation}
y[t] = \Phi \Psi \vec{c}
\label{eq:cs_y_inf}
\end{equation}
for the vector $\vec{c}$.
Since this system is undetermined, the unique solution can be found by solving for the minimum $l_0$ norm of $\vec{c}$. However, to obtain the minimum $l_0$ norm, all possible solutions need to be tried out making the problem not feasible to compute.

Hence, in Compressed Sensing one usually solves the optimization problem \cite{8260873,4472240}

\begin{equation}
\text{min }||\vec{c}||_1 \text{ subject to } y[t] = \Phi \Psi \vec{c},
\label{eq:cs_optim}
\end{equation}

where $||\vec{c}||_1 = \sum_i |c_i|$ is the $l_1$ norm. The solution of equation \ref{eq:cs_y_inf} has the minimum $l_1$ norm of $\vec{c}$.

The necessary condition to regain $s[t]$ from the measured signal $y[t]$ is that the reconstruction matrix $\Theta = \Phi \Psi$ needs to obey the restricted isometry property (RIP). As this condition is hard to check, the incoherence between the matrices $\Phi$ and $\Psi$ can be used as an indication for a stable and faithful reconstruction. The coherence between the two matrices is defined as \cite{8260873,4472240}

\begin{equation}
\mu (\Phi, \Psi) = \sqrt{N} \max_{i\leq M, j\leq N} |\langle \phi_i, \psi_j \rangle|,
\end{equation}

measuring the largest correlation between any of the elements in the two matrices.

The coherence values that can yield values in the range from $1$ to $\sqrt{N}$, with 1 being the value of maximum incoherence. A higher degree of incoherence, which translates to lower coherence values, increases the likelihood of accurately reconstructing the signal $s[t]$. In certain instances, the incoherence value is calculable. For instance, the spike basis possesses a maximum incoherence of $\mu = 1$ with the Fourier-basis, while the noiselet basis has a coherence value of $\mu = \sqrt{2}$ with the wavelet basis. For a fixed basis with matrix $\Psi$ of unknown coherence to any sensing matrix $\Phi$, the sensing matrix can be chosen to be a random, orthonormal matrix. This results in a high probability of having a low coherence value with the fixed matrix $\Psi$ \cite{8260873,4472240}.


\subsection{Convex Compressed Sensing Reconstruction}

Equation \ref{eq:cs_optim} can be understood as a convex optimization problem which can be solved by linear programming algorithms. Since the problem as stated in equation \ref{eq:cs_optim} is not considering noise, the so called basis pursuit algorithm can only reconstruct a stable, faithful solution for noise-free measurements. For noisy measurements, it is not optimal to solve equation \ref{eq:cs_y_inf} exactly. Therefore, a relaxed problem needs to be formulated \cite{8260873}. Two convex approaches capable of dealing with noisy measurements are investigated for compressed sensing. The first algorithm is called basis pursuit denoising optimizing the problem \cite{BergFriedlander:2008}

\begin{equation}
\min ||\vec{c}||_1 \text{    subject to    } \frac{1}{2} \left|\left| \Phi \Psi \vec{c}-y[t]  \right|\right|_2^2 \leq \sigma,
\end{equation} 

where $\sigma$ is a parameter chosen according to the magnitude of noise in the measurement.
The second algorithm is solving the so called Lasso problem given as \cite{BergFriedlander:2008}

\begin{equation}
\min \frac{1}{2} \left|\left| \Phi \Psi \vec{c}-y[t]  \right|\right|_2^2 \text{    subject to    } ||\vec{c}||_1 \leq \tau,
\end{equation}

where the parameter $\tau$ is the regularization parameter of the problem.

Open source Lasso and basis-pursuit denoise algorithms are investigated \cite{spgl1site,BergFriedlander:2008}. For the Lasso as well as the basis-pursuit problem, the value of $\tau$, respectively $\sigma$ needs to be determined empirically. For that, one randomly sampled trace with $N = 88$ sampling points of the UHLFI measurement set is used for the determination of $\tau$ and $\sigma$. This explicit measurement is taken, since the number of sampling points correspond to the measurement with the linear sampling scheme with $\Delta t = \SI{341}{fs}$. This step size yields a Nyquist-frequency of $f_\text{Nyquist} \approx \SI{1.5}{THz}$ positioned in the middle of the absorption spectrum of water vapor. Therefore, this measurement correlates to the border in which compressed sensing could outperform the Fourier-transformation of a traditional linear sampling scheme. 

% Figure environment removed

The data is fed to the Lasso as well as the basis-pursuit denoise algorithm for different values of $\tau$ and $\sigma$, respectively \cite{MAKilian}. For the respective reconstructed traces, the mean squared error to a oversampled reference trace is calculated. The results are depicted in Fig. \ref{fig:check_tau_sigma}. Both algorithms exhibit a similar minimal value of the mean squared error. However, the Lasso algorithm possesses a distinct global minimum at $\tau \approx 70$, whereas the basis-pursuit denoise algorithm shows a constant minimum value for $\sigma < 10^{-1}$. Since it is not always possible to find a reference for arbitrary measurements to optimize the value of $\tau$, the basis pursuit algorithm fits better as a compressed sensing algorithm for accelerating time domain spectroscopy. Consequently, solely the basis pursuit algorithm with a fixed value of $\sigma = 10^{-6}$ is investigated.


\subsection{StOMP}
A reconstruction program consisting of the three algorithms StOMP, TRF and iFFT was developed for evaluating the measured data [The code will be publicly available upon acceptance for publication]. The code aims for fast data processing, minimum human intervention and control characteristics of result. Stagewise Orthogonal Matching Pursuit is a greedy algorithm developed in 2012 which is popular due to the low level of computational complexity resulting in fast data processing \cite{6145475}.  

The developed implementation of the iterative algorithm StOMP is shown in Algorithm 1. In each iteration $s$, the different entries of the sparse domain $\vec{c}$ for a residual signal $r_s$ are weighted via the matched filter $\kappa_s = \Theta^\text{T}r_{s}$ (In case of the first iteration: $r_0 = y$). The result $\kappa_s$ scales the presence of the different entries of $\vec{c}$ in the signal $r_s$. The most prominent entries are selected via a threshold $\tau_s$ yielding a set of outliers $J_s = \{j: |\kappa_s(j)|> \tau_s\}$. The threshold $\tau_s = t_s \cdot \sigma_s$ is constructed by a threshold parameter $t_s$ and the formal noise level of the residual $r_s$ given by
\begin{equation}
    \sigma_s = \frac{||r_s||_2}{\sqrt{\text{dimension}(r_s)}}.
\end{equation}

The entries in this set are merged with all the previous found outliers given in the set $I_{s-1}$ updating the total set of detected outliers $I_s = I_{s-1} \cup J_s$. The projection of the measured data on the detected outliers $I_s$ yields the result for this iteration 

\begin{equation}
\label{eq:projection_stomp}
    \vec{c_s} = \left( \Theta^\text{T}_{I_s}\Theta_{I_s}\right)^{-1}\Theta^\text{T}_{I_s}y.
\end{equation}

Here, $\Theta_{I_s}$ indicates the $M\times|I_s|$ matrix which is constructed of $\Theta$ by choosing only the columns according to the index set $I_s$. With that, the result $\vec{c_s}$ possesses nonzero values for the dominant entries in $I_s$ weighted by the projection of the measured signal $y$. If a certain exit condition is fulfilled, $c_s$ yields the final result of the algorithm. If the exit condition is not yet fulfilled, the residual for the next iteration is updated by $r_{s+1} = y-\Theta\vec{c_s}$. Consequently, the residual of the next iteration $r_{s+1}$ contains the remaining signal contributions which have not been yet detected.

The value of the threshold parameter $t_s$ to achieve an optimal reconstruction depends on the input signal $y$ and is varying significantly between different measurements. Hence, we developed an automatic thresholding approach based on the Inter-Quartile Range (IQR) method for outlier detection \cite{10.1007/978-981-10-7563-6_53}. The IQR indicates the midspread of a dataset and is defined as the difference of the third and first quartile $IQR = Q_3 - Q_1$. The first and third quartile are hereby defined as the mean of the lower and upper half of a statistical distribution, respectively. In the developed algorithm, $t_s$ is calculated by the formula

\begin{equation}
    t_s = \frac{Q_3 + \gamma\cdot IQR}{\sigma_s},
\end{equation}

where $\gamma$ is a set filter value dictating the sensitivity to reconstruct less dominant entries of $\vec{c}$ in the measured signal.

The discussed reconstructions in this work were computed with a filter value of $\gamma = 1.8$.
The developed algorithm applies the threshold only to entries $\vec{c_s}$ within in a set of given boundary conditions. In the case of the presented measurements, only entries corresponding to frequencies within the spectrum of the excitation pulse $f \leq \SI{2.5}{THz}$ are considered.
To improve the robustness of the algorithm, a range of sparsity for the reconstructed signal is defined.  In case the set of detected outliers $I_s$ contains a number of entries below the minimum allowed sparsity, the algorithm fills this set by the most prominent entries of $\vec{c_s}$ according to the matched filter until the set possesses the minimum allowed sparsity. In case the set $I_s$ is above the maximum allowed sparsity, the algorithm stops and returns the solution of the current iteration $c_s$.

As StOMP is indifferent towards amplitude optimization, a Nonlinear Least Squares (NLS) solver was included in the reconstruction algorithm. The “Nonlinear Least Squares” solver is a wrapper for scipy.optimize.curve\_fit which is a wrapper for scipy.optimize.least\_squares, the used algorithm is “Trust Region Reflective”. It has been chosen because it is well suited for large sparse optimization problems. We choose to use scipy.optimize.curve\_fit instead of scipy.optimize.least\_squares because its user-friendliness compared to other optimization methods in python. Due to the fact that NLS only optimizes the result of StOMP and does not “’add’ any frequency to the optimized result, only a few iterations are needed. NLS tries to minimize the error between the reconstruction and the measurement in time domain. Therefore, it is capable of changing/readjusting all nonzero values of the reconstruction in frequency domain. 
\input{content/stomp_algorithm}

\section{Reconstruction details}


\subsection{Basis and measurement matrix}
Compressed sensing algorithms require a measurement matrix $\Phi$ as well as a basis matrix $\Psi$. In this work, the discrete-Fourier-transformation (DFT) is used as the basis matrix $\Psi$. Hence, the entries $\vec{c}$ correspond to the frequency spectrum of the measured signal.

The size of the basis and the corresponding matrix $\Psi$ is determined by the length of the time vector for the reconstructed signal. The time vector and the correlating measurement matrix can be chosen arbitrarily. In the present work, the minimum and maximum of the time vector is bound to the temporal window of the molecular response. This allows to compare the Fourier-transformation of the reconstruction to the one of the linear sampled data laying within this window with equal spectral resolution. The step size of the time vector for the reconstruction is upper bounded by the Nyquist criteria of the signal. By decreasing the step size, the quality of the reconstruction improves since differences between time points of the reconstruction and the random time points of the measurement are decreasing. However, decreasing the step size is increasing the size of the matrices and hence the computation time. In this work, we use a moderate step size of $\Delta t = \SI{75}{fs}$. 

In the case of the basis pursuit denoise algorithm, a boundary matrix $\Sigma$ able to set boundary conditions is added to the basis matrix $\Psi_\text{BPD} = \Psi \Sigma$. $\Sigma$ allows to define a frequency range for non-zero values while keeping the DFT matrix large. We selected a frequency range from $0$ up to $\SI{2.5}{THz}$ corresponding to the spectrum of the excitation pulse. A large DFT matrix is favorable in BPD, since this corresponds to a fine time step of the reconstructed time signal. For finer time steps, the error calculation $||\Phi\Psi\vec{c}-y[t]||$ is more accurate, as the time points of the reconstructions are closer to the random time points of the measured signal. The boundary matrix transports the vector $\vec{c}$ with entries laying in the defined spectral region into the columns of a large fft matrix corresponding to the respective frequencies of $\vec{c}$.

\subsection{BPD reconstruction of measurements with different lock-in amplifier}

% Figure environment removed

The quality of reconstructed traces via BPD for two sets of measurements performed with two different lock-in amplifiers (UHLFI and MFLI from Zurich Instruments) are compared. The lock-in amplifier UHFLI is using the boxcar averager option to reduce noise due to the low duty cycle of the signal of the balanced photo diodes. The lock-in amplifier MFLI acquires data without a boxcar averager option. To speed up settling of the MFLI's low-pass filter to avoid unwanted contribution due to the exponential filter, the time constant is lowered. To attenuate signal contributions of DC offsets, non-linearities and signal components situated at twice the demodulation frequency, a sinc-filter is applied. The combination of the low time constant with the sinc-filter results in higher measurement noise compared to the detection with the boxcar filter. Consequently, we are able to compare the quality of reconstruction of measurements with two different noise levels. For a quantitative comparison, the mean squared error of the reconstructed traces for the random sampled measurements is calculated with respect to the average of the ten linear sampled traces with the lowest step size for the respective set of measurements. The mean as well as the standard deviation for the mean squared error of the ten repetitions for different number of sampling points are shown in Fig. \ref{fig:reconstruction_different_lockins}. As a measure for the measurement noise, the mean squared error of the linear sampled measurements is depicted for the different number of sampling points. The MFLI measurement exhibits measurement noise which is by a factor of three higher compared to the UHFLI measurement. For measurements possessing a large number of sampling points, the BPD reconstruction is below the noise level for both set of measurements. However, the reconstructions of the MFLI measurement show a bigger noise rejection with respect to the noise level compared to the UHFLI measurement. This shows the potential of compressed sensing in improving the signal quality of noisy measurements.



\subsection{BPD reconstruction quality}

The reconstruction quality of linearly sampled and randomly sampled measurement are compared in Fig. \ref{linear_recon_small_and_freq} and \ref{linear_recon_fire}. The probability to reconstruct absorption peaks via BPD for a randomly sampled waveform with $N=46$ is shown in Fig \ref{fig:probability}.




% Figure environment removed
  
  % Figure environment removed
  
% Figure environment removed
  \newpage
  \printbibliography
\end{document}


