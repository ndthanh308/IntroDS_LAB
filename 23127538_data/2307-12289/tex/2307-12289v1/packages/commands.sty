
%
% Package of custom commands too specific to be included in the thesis class
%
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{packages/commands}[2017/11/24 Package for custom commands]

\ExecuteOptions*

\RequirePackage{xparse}
\RequirePackage{xspace}
\RequirePackage{mathtools}
\RequirePackage{soul}

%
% Encourage TeX to better fit the paragraph
%
\NewDocumentCommand\fitpar{}{\looseness=-1}

%
% C-like comments
%
\long\def\*#1*/{}
\* Like this one */

%
% Pauses in text flow (especially useful in text-heavy sections like intros)
%
\NewDocumentCommand\pause{}{\bigbreak\noindent}

%
% Swapping the definition of two commands
%
\NewDocumentCommand\letswap{mm}{%
  \let\@temp#1%
  \let#1#2%
  \let#2\@temp
}

%
% Declaring symbols
%
\NewDocumentCommand\DeclareSymbol{O{} o m}{%
  \IfValueTF{#2}{%
    \def#2{\ensuremath{#1{#3}}\xspace}%
  }{%
    \csdef{#3}{\ensuremath{#1{#3}}\xspace}%
  }%
}

% Complexity classes (to say \EXPSPACE[2] for 2EXPSPACE)
\NewDocumentCommand\DeclareClassSymbol{m}{%
  \expandafter\NewDocumentCommand\csname#1\endcsname{O{}}{%
    \ensuremath{\mathsf{##1#1}}\xspace
  }%
}

%
% A version of \DeclareMathOperator which ignores already-defined commands
%
\NewDocumentCommand\ReDeclarePairedDelimiter{m m m}{%
  \let#1\undefined
  \DeclarePairedDelimiter{#1}{#2}{#3}%
}

%
% Tools to typeset common notation that is error-prone to write in code
%

% Slicing sequences
\NewDocumentCommand\slice{m e{_}}{%
  #1\IfValueT{#2}{_{[\@range #2]}}%
}

\def\@range#1,#2{%
  #1\ldots#2%
}

% Notation for function restriction (not only functions)
\NewDocumentCommand\restrict{m e{_^}}{%
  #1|\IfValueT{#2}{_{#2}}\IfValueT{#3}{^{#3}}
}

%
% Useful column types for tabular and array
%
\RequirePackage{array}
\RequirePackage{collcell}

% Math columns
\newcolumntype{$}[1]{>{$}#1<{$}}\* $ */
\newcolumntype{M}[2]{>{$}#1{#2}<{$}}

% paragraph columns with pre-defined alignment
\newcolumntype{C}[1]{>{\centering\arraybackslash}p{#1}}
\newcolumntype{L}[1]{>{\raggedright\arraybackslash}p{#1}}
\newcolumntype{R}[1]{>{\raggedleft\arraybackslash}p{#1}}

%
% environment to show, e.g. the semantics of logics
%
\RequirePackage{longtable}

\newcounter{condition}
\RenewDocumentCommand\thecondition{}{\arabic{condition}.}

\NewDocumentEnvironment{conditions}{O{29em} O{0.8em}}{%
  \setlength\leftmargin{0pt}%
  \setlength\LTleft{\leftmargin}%
  \setlength\LTpre{\topsep}%
  \setlength\LTpost{\lastskip}%
  \setcounter{condition}{0}%
  \global\def\gt@itemcr{\global\def\gt@itemcr{\\[\itemsep]}}%
  \RenewDocumentCommand\item{O{\refstepcounter{condition}\thecondition}}{%
    \gt@itemcr ##1 &%
  }%
  \NewDocumentCommand\nocondition{O{#1}}{\item \multicolumn{2}{@{}l@{}}}%
  \RenewDocumentCommand\intertext{m}{%
    \gt@itemcr \multicolumn{3}{@{}p{\textwidth}@{}}{##1\vspace*{\topsep}}%
  }%
  \leavevmode
  \begin{longtable}{%
      @{}
  		R{2.5em}% default value of left margin set by itemize, afaik
      @{\hspace{\labelsep}}
  		l
  		@{\hspace{#2}iff\hspace{#2}}
  		L{#1}
  }%
}{%
  \end{longtable}%
  \addtocounter{table}{-1}%
}

%
% Command to format a formula with a succinct and natural syntax
% This is in LaTeX 3 syntax even if I can't stand it.
%
\RequirePackage{xstring}% for \StrSubstitute
\RequirePackage{pgffor}% for \foreach

% the strange `\iffalse{\fi` thing is a 'brace hack', to make this work inside
% `tabular`-like envs. See https://tex.stackexchange.com/questions/452442
\NewDocumentCommand\ltl{+m}{\iffalse{\fi
  \def\gt@formula{#1}%
  \saveexpandmode
  \saveexploremode
  \expandarg
  \exploregroups
  \foreach \gt@keyword/\gt@operator in \gt@ltl@operators {%
    \StrSubstitute{\gt@formula}{\gt@keyword}{\gt@operator}[\@temp]%
    \global\let\gt@formula\@temp
  }%
  \restoreexploremode
  \restoreexpandmode
  \ensuremath{\gt@formula}%
\iffalse}\fi}

\def\gt@ltl@operators{}

\NewDocumentCommand\RegisterLTLOperators{m}{
  \def\gt@ltl@operators{#1}
}

% Column type to show Formulas in tables
\newcolumntype{f}[1]{>{\collectcell\ltl}#1<{\endcollectcell}}

%
% TODO machinery
%
% \let\old@marginpar\marginpar
% \RenewDocumentCommand\marginpar{O{#2}m}{%
%   \old@marginpar[\flushright\scriptsize #1]{\flushleft\scriptsize #2}%
% }
%
%\NewDocumentCommand\todo{m}{%
%  \marginpar{\textsf{TODO}\\#1}%
%}
\NewDocumentCommand{\statement}{m}{(Step: #1).}