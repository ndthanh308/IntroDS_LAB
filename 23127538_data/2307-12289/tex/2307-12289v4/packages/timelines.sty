%!TeX root = ../ai2019.tex
%
% Package of custom commands too specific to be included in the thesis class
%
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{packages/timelines}[2017/11/24 Package for all symbols]

\ExecuteOptions*

\RequirePackage{tikz}

\usetikzlibrary{calc}
\usetikzlibrary{patterns}

% Code to draw timelines

\def\@toklength{1cm}
\def\@tokcolor{primary}
\def\@tokvar{}
\def\@toklabel{}
\def\@tokname{token}
\def\@tokfont{}
\def\@timelinesdist{1cm}
\newif\if@tokmath
\@tokmathfalse

\tikzset{
  timelines/.is family,
  timelines,
  timelines/.search also={/tikz},
  timelines distance/.store in=\@timelinesdist,
  length/.store in=\@toklength,
  color/.store in=\@tokcolor,
  var/.store in=\@tokvar,
  label font/.store in=\@tokfont,
  math labels/.is if=@tokmath
}

\NewDocumentCommand\@tokformatlabel{m}{%
  \if@tokmath
    \(\@tokfont{#1}\)%
  \else
    \@tokfont{#1}%
  \fi
  \vphantom{gT}%
}

\NewDocumentCommand\@token{O{} d() m t;}{%

  \IfValueTF{#2}{
    \def\@tokname{#2}
  }{\def\@tokname{token}}

  \begin{scope}[timelines, #1]
    \path (lasttok)
      node[
        anchor=west,
        rectangle, fill=\@tokcolor, text width={\@toklength-1pt},
        inner xsep=0pt, inner ysep=2pt, outer xsep=0.5pt
      ] (\@tokname) {};

    \path (\@tokname.north west) 
      node[
        anchor=south west,
        inner xsep=0pt, inner ysep=2pt
      ] {\@tokformatlabel{#3}};

    \coordinate (lasttok) at (\@tokname.east);
  \end{scope}
}

\NewDocumentCommand\@tokens{O{} m t;}{%
  \foreach \@value/\@length in {#2} {
    \@token[length=\@length, #1] {\@value};
  }
}

\AtBeginEnvironment{tikzpicture}{%
  \let\token\@token
  \let\tokens\@tokens
  \DeclareDocumentEnvironment{timelines}{O{}}{
    \begin{scope}[timelines, #1]
      \coordinate (nexttimeline) at (0,0);
  }{\end{scope}}%
  \DeclareDocumentEnvironment{timeline}{O{}}{
    \begin{scope}[timelines, #1]
      \path (nexttimeline) node[left] {$\@tokvar$};
      \coordinate (lasttok) at (nexttimeline);
      \coordinate (nexttimeline) at
        ($(nexttimeline)+(0,-\@timelinesdist)$);
  }{\end{scope}}%
}
