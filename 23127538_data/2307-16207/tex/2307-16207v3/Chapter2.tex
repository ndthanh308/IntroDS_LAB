\section{Problem Statement}\label{sec2}
We consider a cellular network with $M$ BSs and $N\leq M$ charging stations (CSs). In this network, a UAV with limited battery capacity travels from an initial point $\mathbf{U}_0$ to a final point $\mathbf{U}_F$ to deliver or transport a payload. The detailed description of the UAV model is in Section \ref{sec2A}. The UAV should maintain the connectivity with one of the BSs while delivering the payload. The BS model and the BS-UAV connectivity are described in Section \ref{sec2B}. The UAV can swap its battery at a CS if needed, as explained in Section \ref{sec2C}. This paper's goal is to plan an optimal transportation path from $\mathbf{U}_0$ to $\mathbf{U}_F$, which minimizes the mission (travel) time $T$ encompassing both the flight time and the battery swapping time at CSs. This optimization problem is formally presented in Section \ref{sec2D}. The overall model is illustrated in Fig. \ref{Fig1}.

% Figure environment removed

\subsection{UAV Model}\label{sec2A}
A UAV performs a mission to transport a payload from an initial point $\mathbf{U}_0$ to a final point $\mathbf{U}_F$ within the framework of the cellular network, under the assumption that the UAV is equipped with rotary-wings and travels at a fixed altitude $H\in[H_\mathrm{min},H_\mathrm{max}]$, where $H_\mathrm{min}$ is determined by the heights of obstacles in the network and $H_\mathrm{max}$ corresponds to the maximum allowable altitude according to government regulations. The 3-dimensional (3D) coordinates of $\mathbf{U}_0$, $\mathbf{U}_F$, and the position of the UAV at time $t$ are represented by $(x_0,y_0,H)$, $(x_F,y_F,H)$, and $(x(t),y(t),H)$, respectively, where those 2-dimensional (2D) coordinates (i.e., horizontally projected locations) are indicated as $\mathbf{u}_0=(x_0,y_0)$, $\mathbf{u}_F=(x_F,y_F)$, and $\mathbf{u}(t)=(x(t),y(t))$, respectively. While performing the mission, the UAV can adaptively adjust its speed $v(t)\triangleq\|\nabla_t\mathbf{u}(t)\|$ at time $t$ in finite set $\mathcal{V}=\{0,v_1,v_2,...,v_q\}$ ($0<v_1<...<v_q$).
In terms of energy usage, our paper concentrates solely on the energy consumed by the UAV propulsion, by the relatively marginal impact of communication power consumption \cite{Mozaffari:2019}. The overall UAV consists of the UAV body, a battery, and its payload, where those weights are denoted by $w_1$, $w_2$, and $w_3$, respectively with the total UAV weight $w\triangleq w_1+w_2+w_3$.
The power consumed by propulsion (in Watts) during flight at speed $v$ is
\begin{align}
\begin{split}\label{eq:1}
&P_\mathrm{UAV}(v)=P_1\left(1+{3({v}/{v_\mathrm{tip}}})^2\right)+P_2(w)\cdot\\
&\big(\sqrt{1\!+\!0.25{({v}/{v_0(w)}})^4}\!-\!{0.5({v}/{v_0(w)})^2}\big)^{0.5} \!\!\!\!\! +0.5S_\mathrm{FP}{\rho} v^3,
\end{split}
\end{align}
where $v_\mathrm{tip}$, $v_0(w)$, $P_1$, $P_2(w)$, $S_\mathrm{FP}$, and $\rho$ refer to the parameters established through the UAV's physical structure and delivery environment, with pointing out that only $v_0(w)$ and $P_2(w)$ rely on the total weight $w$. A comprehensive discussion regarding the propulsion power consumption \eqref{eq:1} including its parameters will be provided in Section \ref{sec6}. The UAV receives the energy for operation from its battery. The capacity (in Joules) of the battery is directly proportional to its weight $w_2$ as follows \cite{Zhang:2021_2}:
\begin{align}
C_\mathrm{batt}=\epsilon_\mathrm{batt}w_2,\label{eq:2}
\end{align}
where $\epsilon_\mathrm{batt}$ means the energy density (per unit weight) of fully charged battery. From \eqref{eq:1} and \eqref{eq:2}, the maximum flight distance under the assumption that UAV does not swap its battery and maintains a constant speed $v$ is provided as follows \cite{Zhang:2021_2}:
\begin{align}
d_\mathrm{fly}(v)=v\cdot{{\gamma\eta C_\mathrm{batt}}/({r_\mathrm{safe}P_\mathrm{UAV}(v)})},\label{eq:3}
\end{align}
where $\gamma\in(0,1)$ represents the depth of discharge, i.e., the maximum fraction of the energy that can be used in the fully charged battery, $\eta\in(0,1)$ signifies the ratio of the charged energy transferable to the UAV body under the circuit resistance, and $r_\mathrm{safe}\in(1,\infty)$ denotes the energy reserving factor of the battery for unforeseeable situations like strong winds. More precisely, the maximum flight distance $d_\mathrm{fly}(v)$ is obtained by first dividing the actual maximum available energy from the complete charged battery, ${\gamma C_\mathrm{batt}}\over r_\mathrm{safe}$ (in Joules) into the consumed power in the UAV body, ${P_\mathrm{UAV}(v)}\over{\eta}$ (in Watts) and then multiplying the speed $v$.


%\hs{We note that the consumed power in the battery is ${r_\mathrm{safe}P_\mathrm{UAV}}\over{\gamma\eta}$, where the smaller $\gamma$ and $\eta$ and the larger $r_\mathrm{safe}$ reduce the energy consumption efficiency of the UAV.}
%We note that \sh{the smaller $\gamma$ and $\eta$ and the larger $r_\mathrm{safe}$ reduce the energy consumption efficiency of the UAV.}

\subsection{BS-UAV Connectivity}\label{sec2B}
In the cellular network, the UAV can communicate with one of $M\geq 1$ BSs, where the $m$th BS for $m\in[1:M]$ is denoted by $\mathrm{BS}_m$. The 3D coordinate of $\mathrm{BS}_m$ is $(a_{m1},a_{m2},H_\mathrm{BS})$, with its 2D coordinate $\mathbf{a}_m=(a_{m1},a_{m2})$. It is assumed that the altitudes of all BSs are identical to $H_\mathrm{BS}<H$. Each BS is equipped with one omni-directional antenna and operates at the same transmission power denoted by $P_\mathrm{tx}$. We note that there exists a control station to plan the UAV trajectory and approve the handover between BSs. The control station is connected to every BS through a backhaul network as shown in Fig. \ref{Fig1} and hence it is assumed that the control station can maintain the control of the UAV if the communication rate between the UAV and its connected BS is not smaller than a certain threshold.

We assume that the channel between the UAV and a BS is determined by the line-of-sight (LoS) probabilistic model \cite{Al-Hourani:2014}. The LoS probability between the UAV and $\mathrm{BS}_m$ at time $t$, $p_m(t)\in[0,1]$ is given as follows \cite{Al-Hourani:2014}:
\begin{align}
p_m(t)={1/({1+\mu_1\exp(-\mu_2(\theta_m(t)-\mu_1))}}),\label{eq:3.1}
\end{align}
where $\mu_1>0$ and $\mu_2>0$ refer to the parameters to determine the LoS probability and $\theta_m(t)$ is the elevation angle between the UAV and $\mathrm{BS}_m$ at time $t$. We note that the LoS probability $p_m(t)$ increases as the elevation angle $\theta_m(t)$ increases.
The expected path loss between the UAV and $\mathrm{BS}_m$ at time $t$, $\Lambda_m(t)$ (in $\mathrm{dB}$) is given as follows \cite{Al-Hourani:2014_2}:
\begin{align}
\Lambda_m(t) = \mathrm{FSPL}_m(t)+p_m(t)\cdot\zeta_1 + (1-p_m(t))\cdot\zeta_2,\label{eq:4}
\end{align}
%The expected path loss between the UAV and $\mathrm{BS}_m$ at time $t$, $\Lambda_m(t)$ (in $\mathrm{dB}$) is given as $\Lambda_m(t) = \mathrm{FSPL}_m(t)+p_m(t)\cdot\zeta_1 + (1-p_m(t))\cdot\zeta_2$, where $\mathrm{FSPL}_m(t)$ and $p_m(t)\in[0,1]$ are the free space path loss and the LoS probability between the UAV and $\mathrm{BS}_m$ at time $t$, respectively,
where $\mathrm{FSPL}_m(t)$ is the free space path loss (FSPL) which only depends on the distance between the UAV and $\mathrm{BS}_m$ and $\zeta_1>0$ and $\zeta_2>\zeta_1$ refer to the excessive path losses for LoS and non-LoS (NLoS) links, respectively \cite{Al-Hourani:2014_2}. The received signal to interference plus noise ratio (SINR) from $\mathrm{BS}_m$ to the UAV at time $t$ is
\begin{align}
\mathrm{SINR}_m(t)={{P_\mathrm{tx}\cdot 10^{\Lambda_m(t)/10}}/(\!\!\!\!\!{\sum_{m'\in[1:M]\setminus m}\!\!\!\!\!I_{m'm}(t)+N_0})},\label{eq:5}
\end{align}
%The received signal to interference plus noise ratio (SINR) from $\mathrm{BS}_m$ to the UAV at time $t$ is $\mathrm{SINR}_m(t)={{P_\mathrm{tx}\cdot 10^{\Lambda_m(t)/10}}\over {\sum_{m'\in\mathcal{M}\setminus m}I_{m'm}(t)+N_0}}$, 
where $I_{m'm}(t)$ is the interference power by $\mathrm{BS}_{m'}$ at time $t$ when the UAV is communicating with $\mathrm{BS}_{m}$ and $N_0$ is the additive noise power.\footnote{Our path loss model is based on large-scale fading, i.e., small-scale fading effects are ignored. However, we note that our results are also applicable under small-scale fading  by considering the SINR averaged over the randomness.}  Note that $I_{m'm}$ would be equal to zero if $\mathrm{BS}_{m'}$ uses a different frequency band from $\mathrm{BS}_{m}$, 
and even if the two BSs use the same frequency band, it will become negligible if $\mathrm{BS}_{m'}$ is far away from the UAV.

To maintain the control of the UAV, the communication rate from a BS to the UAV should not be less than the minimum required data rate, i.e., \sh{the SINR from $\mathrm{BS}_m$ to the UAV, maximized over $m\in[1:M]$,} should satisfy
% the maximally achievable SINR of the UAV should satisfy 
\begin{align}
\max_{m\in[1:M]} \mathrm{SINR}_m(t)\geq \mathrm{SINR}_\mathrm{th}\label{eq:6}
\end{align}
for any time $t$ where $\mathrm{SINR}_\mathrm{th}$ is the hard SINR threshold to achieve the minimum required data rate. We note that the connectivity constraint \eqref{eq:6} does not mandatorily require LoS links between the UAV and BSs since the SINR value \eqref{eq:5} from a BS to the UAV is determined by averaging the pathloss over the LoS probability between them. In weak interference regime, i.e., the frequency reuse factor is sufficiently low, it can be easily checked that the condition \eqref{eq:6} can be equivalently written as  $\min_{m\in[1:M]}\|\mathbf{u}(t)-\mathbf{a}_m\|\leq d_0$ for some $d_0$, where we call $d_0$ the base coverage radius of each BS.
%\footnote{Each BS has the same base coverage radius $d_0$ since every BS has the same transmission power $P_\mathrm{tx}$ and the same altitude $H_\mathrm{BS}$, but it can be verified that our results also hold under different base coverage radii due to different transmission powers or BS altitudes.}
For other cases, however, it is generally hard to represent the exact coverage region satisfying  \eqref{eq:6} in a simple form. For tractable analysis, we introduce the coverage offset $\lambda_m\in [0,d_0]$ for $\mathrm{BS}_m$ and assume that the UAV can connect with $\mathrm{BS}_m$  if the UAV is in the effective coverage region of $\mathrm{BS}_m$ given as $\|\mathbf{u}(t)-\mathbf{a}_m\|\leq d_0-\lambda_m$, as explained in more detail in Remark \ref{rmk1}. 
Consequently, by introducing offsets $\lambda_m$ taking into account the effect of interference, we assume that \eqref{eq:6} holds if the following equation holds:%\footnote{In Section \ref{sec2B}, we only state the connectivity for downlink communications from a BS to the UAV, but we can set a similar coverage region as \eqref{eq:6} and \eqref{eq:7} for uplink communications.}
\begin{align}
\min_{m\in[1:M]}\|\mathbf{u}(t)-\mathbf{a}_m\|+\lambda_m\leq d_0.\label{eq:7}
\end{align}
Note that the connectivity condition is stated for downlink communications, but it can be defined similarly as in \eqref{eq:6} and \eqref{eq:7} for uplink communications.

\begin{remark}\label{rmk1}
Note that the coverage offset $\lambda_m$ for $m\in[1:M]$ depends on the environment around $\mathrm{BS}_m$. More specifically, $\lambda_m$ is chosen in a way that the UAV can connect with $\mathrm{BS}_m$ as long as its location $\mathbf{u}(t)$ satisfies $\|\mathbf{u}(t)-\mathbf{a}_m\|\leq d_0-\lambda_m$.  Fig. \ref{Fig2} illustrates an example of choosing $\lambda_m$ in the presence of interference. In general, we have large (small) $\lambda_m$ for urban (suburban) environments since there are many (few) other BSs around $\mathrm{BS}_m$. A higher flight altitude of the UAV induces a larger coverage offset $\lambda_m$ since the LOS probability of the channel between the UAV and other BSs increases  \cite{Lin:2019}. Also, $\lambda_m$ increases in the traffic of other BSs around $\mathrm{BS}_m$ \cite{Zhang:2021}.
\end{remark}

% Figure environment removed

\subsection{Charging Station Model}\label{sec2C}
To successfully transport the payload in the situation that the initial and the final points are far away and the battery capacity is limited, we assume that the UAVâ€™s depleted battery can be swapped with a completely charged one at a charging station. \sh{It is assumed that all the CSs have the same height of $H_\mathrm{CS}\leq H$.} The $n$th charging station for $n\in[1:N]$ is denoted by $C_n$, and its 3D coordinate is indicated by $(c_{n1},c_{n2},H_\mathrm{CS})$ with the 2D coordinate $\mathbf{c}_n=(c_{n1},c_{n2})$, where $\mathbf{c}_n\neq \mathbf{c}_{n'}$ if $n\neq n'$. 
% It is assumed that the vertical position of all CSs are identical to $H_\mathrm{CS}\leq H$.
To expedite the battery replacement, we assume that every CS employs an automated battery swapping system, as described in \cite{Lee:2015}. %\footnote{The automated battery swapping system in \cite{Lee:2015} takes about $60$ seconds for the entire battery swapping process.} 
The total delay for battery replacement at CS $C_n$, which is denoted as $\tau_{C_n}$ and bounded by the interval $[0,\tau_\mathrm{max}]$, encompasses waiting and battery swapping times (e.g., the automated battery swapping system in \cite{Lee:2015} takes about $60$ seconds for the entire battery swapping process) and the additional penalty for UAV takeoff and landing at the CS. It is worth mentioning that the waiting time can differ in accordance with the congestion level of the charging station. Hence, the delay $\tau_{C_n}$ is contingent upon the CS index $n$. We assume that all CSs are connected to the control station via backhaul network as illustrated in Fig. \ref{Fig1}, which allows the control station to have the complete knowledge of the delay for each CS and enables it to plan an effective UAV trajectory.

\subsection{Goal}\label{sec2D}
Our goal is to plan an optimal transportation path from $\mathbf{U}_0$ to $\mathbf{U}_F$, which minimizes the mission time $T$ that encompasses both the airborne flight time and the delay for battery replacement at CSs. The formulation of the optimization problem is represented as follows:
\begin{align} 
&\textbf{Problem 1} \cr
&\mbox{Objective:~}~~~~ \min_{T\geq 0,\{\mathbf{u}(t),\ \psi(t),\ t\in[0,T]\}} T\label{eq:8}\\
&\mbox{Constraints: }\cr%\label{eq:8.1}
&\mathbf{u}(0)=\mathbf{u}_0,\ E_\mathrm{batt}(0)=C_\mathrm{batt},\ 
 \mathbf{u}(T)=\mathbf{u}_F \label{eq:9}\\  
&\mathbf{u}(t)\in\mathbb{R}^2,\ v(t)\in \mathcal{V},\ \psi(t)\in[0:N],\ t\in[0,T] \label{eq:9.1}\\
&\min_{m\in[1:M]}\|\mathbf{u}(t)-\mathbf{a}_m\|+\lambda_m\leq d_0,\ t\in[0,T]\label{eq:11}\\
&\psi(t)=0\ \mathrm{if~} \mathbf{u}(t)\not\in\{\mathbf{c}_n|n\in[1:N]\},\ t\in[0,T]\label{eq:12}\\
&\psi(t)\in\{0,n\} \ \mathrm{if~}  \mathbf{u}(t)=\mathbf{c}_n,\ n\in[1:N],\ t\in[0,T]\label{eq:13}\\
%\psi(t)\in\{0,n\} \ \mathrm{if~}  \mathbf{u}(t)\in\{\mathbf{c}_n|n\in[1:N]\},\ t\in[0,T]\label{eq:13}\\
&E_\mathrm{batt}(t)\geq (1-(\gamma/ r_\mathrm{safe}))\cdot C_\mathrm{batt},\ t\in[0,T]\label{eq:14}\\
&-\nabla_t  E_\mathrm{batt}(t)=\! P_\mathrm{UAV}(v(t))/\eta\ \mathrm{if~} \psi(t)=0,\ t\in[0,T]\label{eq:15}\\
&-\nabla_t E_\mathrm{batt}(t)=\! 0\ \mathrm{if~} \psi(t)\in [1:N],\ t\in[0,T]\label{eq:16}\\
&E_\mathrm{batt}(t)=C_\mathrm{batt}\ \mathrm{if~} \psi(t)\in[1:N] \text{ and }\cr
&~~t-\max_{t_1}\{t_1|\psi(t_1)=0,t_1\in [0,t]\}=\tau_{C_{\psi(t)}},\ \! t\in[0,T]\label{eq:17}
\end{align}
where the auxiliary indicator $\psi(t)\in[0:N]$ is used to distinguish whether the UAV is airborne $(\psi(t)=0)$ or stays at CS $C_n$ $(\psi(t)=n)$ at time $t$ and $E_\mathrm{batt}(t)\geq 0$ refers to the battery's remaining energy at time $t$. Here, \eqref{eq:9} means that the UAV departs from $\mathbf{u}_0$ with fully charged battery and arrives at $\mathbf{u}_F$ at time $T$, \eqref{eq:9.1} corresponds to the range of optimizing variables including the set $\mathcal{V}$ of possible UAV speeds, \eqref{eq:11} is the connectivity constraint in \eqref{eq:7}, \eqref{eq:12}-\eqref{eq:13} identifies whether the UAV is airborne or stays at a CS, and \eqref{eq:14} means that the actual maximum available energy in the fully charged battery is ${\gamma C_\mathrm{batt}}\over r_\mathrm{safe}$. Next, \eqref{eq:15} and \eqref{eq:16} means the power usage during flight and battery replacement at a CS, respectively, and \eqref{eq:17} signifies that the depleted battery is just swapped to fully charged one.

We point out that Problem 1 doesn't fall under convex optimization due to the variable $\psi(t)\in[1:N]$ with discrete codomain and the non-convex constraint \eqref{eq:11}. Furthermore, optimizing $\mathbf{u}(t)$ and $\psi(t)$ over continuous $t\in[0,T]$ adds to the non-triviality of the problem. To address the challenges, in Sections \ref{sec3} and \ref{sec4}, we initially reframe the problem within a weighted graph methodology. Subsequently, we analytically show that leveraging the Dijkstra algorithm \cite{Dijkstra:1959} facilitates solving the problem efficiently in polynomial time.
