% ==================================================
%           Capitulo 3
% ==================================================
\section{Results}

%%%%%%%%%%%%%%%%%%%%%%%%%
% MODELO DEEP LEARNING  %
%%%%%%%%%%%%%%%%%%%%%%%%%
This section presents the optimal betting portfolios for the second part of the 2020/2021 season of the English Premier League. These portfolios are derived using the Sharpe Ratio Criterion and the Kelly Criterion based on odds estimated by deep learning models. For each criterion, two types of strategies were examined\nospacecolon \ unrestricted strategies and restricted strategies. The former allows for betting on all possible events of each match, while the latter imposes limitations on the number of events that can be bet upon.

It is worth noting that excessive betting can lead to a negative log-growth rate $G(\underline{\ell}) < 0$, resulting in the wealth tending towards zero, as mentioned in the first property of the Kelly Criterion \cite{thorp1969optimal}.  However, according to the findings of E. Thorp stated at \ref{2ss:properties}, this negative impact occurs after reaching the optimal point. Therefore, it is preferable to underestimate the bets rather than overestimate them. This rationale underscores the inclusion of fractional bets in the strategies.

\subsection{Predictive Model}
The predictive model was constructed based on data obtained from three distinct public sources. Firstly,  \href{https://sofifa.com/}{EA Sports' ratings} \cite{sofifa} were utilized to assess the overall quality, offense, midfield, and defense of teams on a weekly basis. Secondly, team statistics were collected from \href{https://understat.com/}{Understats} \cite{understat}. Lastly, match odds from multiple bookmakers, obtained through \href{https://www.football-data.co.uk/englandm.php}{Football Data U.K.}. \cite{footballdata}, were integrated into the model.

\subsubsection{Data}
The dataset encompassed the period from the 2014/2015 season to the 2020/2021 season. To ensure the reliability of the analysis, data from the initial week of each season was excluded. These initial weeks were deemed less informative due to ongoing team rebuilding during the summer transfer market, introducing substantial uncertainty in team performance.

The final dataset comprised a total of 2,660 games, which were divided into three distinct groups\nospacecolon \ training (2014/2015 to 2019/2020 seasons), validation (first half of the 2020/2021 season), and test (second half of the 2020/2021 season). Temporal variables were aggregated using weighted maximum likelihood, employing an exponential decay rate of 0.1. This particular value was suggested by the Dixon-Coles analysis \cite{dixon1997modelling} and effectively captured the diminishing impact of historical data as time progressed. Moreover, the model considered variables for both home and visiting teams, encompassing various aspects of team performance (refer to the appendix for detailed variable information).

As an additional input to the model, the final odds from Pinnacle Sports \cite{pinnacle}, a reputable bookmaker, were incorporated. This incorporation was motivated by the by the work of Surowiecki, which recognize that market information holds predictive power in estimating potential events \cite{surowiecki2005wisdom}. By integrating these odds, the model could effectively leverage market insights to enhance its predictive capabilities.

\subsubsection{Model Selection}
To determine the variables with the highest predictive power, lasso-shrinkage techniques were employed for a multinomial regression analysis \cite{tibshirani1996regression}. The use of variable selection was motivated by the relatively limited size of the dataset compared to the number of parameters in the neural network, which increased the risk of overfitting.

By employing the lasso technique, a subset of variables with the most significant predictive impact was identified. The multinomial regression model trained on this reduced set of variables achieved a predictive accuracy of 41.76\% and a cross-entropy value of 1.34. In contrast, when trained on the complete set of variables, the model achieved an accuracy of 51.76\% and a cross-entropy value of 1.22. It is important to note that the coefficients of the multinomial regression model were not easily interpretable, and the accuracy was significantly reduced by 19.3\% compared to the original model, while the entropy was 9.8\% higher. Considering these findings, it was determined that utilizing all variables in the subsequent deep learning models would be more beneficial. This decision was influenced by the understanding that deep learning models have the capability to effectively capture complex relationships and patterns present in the data, even if certain variables may have less intuitive interpretations.
% Figure environment removed

A training set consisting of 2,200 observations was obtained, while the number of parameters to estimate was 2,700, given the $30 \times 30 \times 3$ dimensions. Consequently, regularization was necessary to address the challenge of having more variables than observations.

Furthermore, certain hyperparameters were fixed across all deep learning models with different regularizations using the framework described at \cite{nielsen2015neural} \cite{geron2019hands}. These fixed hyperparameters included the architecture design, where a funnel architecture was employed, progressing from a higher number of neurons to a lower number as the number of hidden layers increased. The random seed and kernel initializer were also standardized, using He-Normal for hidden layers and Glorot-Normal for the output layer \cite{geron2019hands}. The number of hidden layers was set to three, and for models incorporating batch normalization regularization, the number of hidden layers became a hyperparameter. Additionally, the NAdAM learning algorithm \cite{nocedal1999numerical} was utilized consistently across all models.

Subsequently, several hyperparameters were learned through the optimization process. The number of neurons in the first layer was explored within a range of 70\% to 200\% of the number of variables, while for subsequent layers, the algorithm initiated the search with the number of neurons from the previous layer. The learning rate was selected from a list of three values\nospacecolon \ $10^{-2}$, $10^{-3}$, and $10^{-4}$. The penalization magnitude and the convexity trade-off (elastic net) were determined by sampling penalty values from a uniform distribution.
\begin{table}[ht]
\captionsetup{font=footnotesize}
\centering
\resizebox{16cm}{!}{
    \begin{tabular}{@{}lccccc@{}}
    \toprule
    \multicolumn{1}{c}{\textbf{Hyperparameters \textbackslash \ Model}} & \textbf{Elastic Net} & \textbf{Lasso} & \textbf{Ridge} & \textbf{Drop Out} & \textbf{Batch Norm} \\ \midrule
    \textbf{Num. Layers}                                        & 3                    & 3              & 3              & 3                 & 9                   \\
    \textbf{Num. Neurons}                                     & 37, 25, 21           & 25, 21, 25     & 37, 33, 33     & 25, 41, 37        & 33,33,37,37,37,37,49,45,97                \\
    \textbf{Learning Rate}                                  & 0.01                 & 0.01           & 0.01           & 0.001             & 0.01                \\
    \textbf{Penalty}                                     & 0.9, 0.8, 0.1, 0.3           & 0.1, 0.5, 0.06, 0.5   & 0.6, 0.8, 0.2, 0.01   & -                 & -                   \\
    \textbf{Convexity}                                      & 0.12, 0.03, 0.33, 0.23        & -              & -              & -                 & -                   \\
    \textbf{Dropout Rate}                                   & -                    & -              & -              & 0.1122, 0.00025, 0.000055   & -                   \\ \bottomrule
    \end{tabular}
}
\caption{\label{tab:table_model_stats} Optimal Hyperparameters for Different Regularizations in the Validation Set.
}
\end{table}

To evaluate the predictive errors and information loss, cross-temporal validation techniques, specifically the Split Temporal Cross-Validation (STCV) approach, were employed.

\begin{table}[ht]
\captionsetup{font=footnotesize}
\centering
\resizebox{8cm}{!}{
    \begin{tabular}{@{}ccccc@{}}
    \toprule
    \multicolumn{1}{c} \textbf{\textbf{Elastic Net}} & \textbf{Lasso} & \textbf{Ridge} & \textbf{Drop Out} & \textbf{Batch Norm} \\ \midrule
    1.02                                       & 1.03                   & 1.01            & 1.99             & 1.02                               \\
    \bottomrule
    \end{tabular}
}
\caption{\label{tab:table_model_entropy} Cross Entropy in the Validation Set.
}
\end{table}

\subsubsection{Model Assessment}
Subsequently, the best models selected from the training and validation sets were trained. Among the different architectures considered, the \textit{Drop Out} architecture \textit{consistently} demonstrated superior performance in terms of precision and information loss. Therefore, it was chosen as the best model for further analysis.

\begin{table}[ht]
\captionsetup{font=footnotesize}
\centering
\resizebox{6cm}{!}{
\begin{tabular}{@{}lcc@{}}
    \toprule
    \multicolumn{1}{c}{\textbf{Model}} & \textbf{Loss}    & \textbf{Accuracy} \\ \midrule
    \textbf{Elastic Net}                & 1.0288 $\pm$ 0.1241 & 58\% $\pm$ 16.91\%    \\
    \textbf{Lasso}                      & 1.0405 $\pm$ 0.1234    & 55\% $\pm$ 16.88\%    \\
    \textbf{Ridge}                      & 1.0185 $\pm$0.1273     & 57\% $\pm$ 19\%       \\
    \textbf{Drop Out}                   & 0.9819 $\pm$0.0996     & 55\% $\pm$11.61\%     \\
    \textbf{Batch Norm}                 & 0.9386 $\pm$0.1569     & 57\% $\pm$ 17.64\%    \\ \bottomrule
    \end{tabular}
}
\caption{\label{tab:table_models_metrics} The average of the metrics plus/minus one sample standard deviation, in the test set is presented using STCV.}
\end{table}

The predictions made by the model were compared to the pre-match odds provided by the bookmaker Pinnacle Sports. This comparison was motivated by the belief that the odds reflect the collective wisdom of the crowds \cite{surowiecki2005wisdom}.
In terms of accuracy, the model achieved a 54\% accuracy rate, while the crowds achieved 51.5\%. In comparison, the null models of "always bet on the home team," "always bet on a draw," and "always bet on the away team" had accuracy rates of 38\%, 20\%, and 42\% respectively.
Regarding information loss, the model achieved a value of 1.0318, while the crowds achieved 0.9966, and the historical frequencies up to the 19th matchweek of the 2020/2021 season had an information loss value of 1.0631.

\begin{table}[ht]
\captionsetup{font=footnotesize}
\centering
\resizebox{9cm}{!}{
\begin{tabular}{ll|ccc|c}
\multicolumn{2}{c|}{\multirow{2}{*}{\diagbox{\textbf{Drop Out}}{\textbf{Market Odds}}}} & \multicolumn{4}{c}{\textbf{Prediction}}                                    \\
\multicolumn{2}{c|}{}                                                                     & Home                 & Draw     & Away               & \textbf{Total}  \\ 
\hline
\multirow{4}{*}{\textbf{Observed}} & Home                                                & 60\textbackslash{}55 & 0\textbackslash{}0          & 16\textbackslash{}21 & \textbf{76}     \\
                                    & Draw                                              & 17\textbackslash{}15 & 0\textbackslash{}0          & 23\textbackslash{}25 & \textbf{40}     \\
                                    & Away                                              & 36\textbackslash{}36 & 0\textbackslash{}0         & 48\textbackslash{}48 & \textbf{84}     \\ 
\cline{2-6}
                                    & \textbf{Total}                                      & \textbf{113\textbackslash{}106}         & \textbf{0\textbackslash{}0} & \textbf{87\textbackslash{}94}          & \textbf{200}   
\end{tabular}
}
\caption{\label{tab:mat_conf} The confusion matrix compares the predictions of the models to the actual outcomes. The lower part of the table corresponds to the predictions made by the models, while the last column represents the observed outcomes. The elements on the left side of the diagonals correspond to the predictions made by the Drop Out model, while the elements on the right side represent the odds ratios provided by Pinnacle Sports.}
\end{table}


%%%%%%%%%%%%%%%%%%%%%%%%%
% MODELO DEEP LEARNING  %
%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Portfolios} 

This section presents the results of the optimal portfolios based on quadratic and logarithmic utilities. It is important to note the following assumptions and constraints throughout the analysis\nospacecolon \ no more than 100 percent of the wealth can be bet, short selling is not allowed, the risk-free asset has a zero return, money is infinitely divisible, the portfolio is also infinitely divisible\footnote{For numerical purposes, any wager less than 0.0001 was considered negligible.}. Without loss of generality the initial wealth is set to \$1. Gains are reinvested each matchweek, i.e. $W_{n} = \prod_{\text{J}19}^{\text{J}38}R_{i}(\underline{\ell})$.

Four types of scenarios were considered for the portfolios. Each strategy was evaluated under two scenarios\nospacecolon \ restricted betting, where only a single event per match can be bet upon, and unrestricted betting, allowing for multiple bets per match. Furthermore, portfolios were examined for both full strategies and fractional strategies at $f = $17\%. The optimal fraction of 17\% for this set was determined after conducting two hundred Dirichlet simulations in the validation set. In practice, it is common to use 25\% of the Kelly Criterion strategy for betting purposes. The decision to split the bets is based on the insight that under-betting is preferable to over-betting, as indicated by E. Thorp \cite{thorp1969optimal}.
% Figure environment removed

\subsubsection{Complete Strategies}
In the test set, there are 20 matchweeks, with 10 matches taking place on each match day. Each match has three possible outcomes\nospacecolon \ home win, draw, or away win. The results of one match are independent of the results of the other matches. Consequently, there are $M = \sum_{i}^{r}m_{i} = 3 \times 10 = 30$ possible bets and $N = \prod_{i}^{r}m_{i} = 3^{10} = 59,049$ combinations of outcomes per matchweek.

For portfolios with logarithmic utilities, the optimal bets were determined by optimizing the Multiple Simultaneous Kelly Criterion (\ref{eq2:multiple_simult_kelly}) using the SQP algorithm. On average, this model took approximately 20.9 seconds to converge per fixture. However, it should be noted that the numerical algorithm did not converge for matchweek 23 due to gradient overflow. Despite this challenge, it was decided to use the stakes from the last iteration of the algorithm as an approximation for that matchweek. Although it is important to acknowledge this approximation, it was necessary in order to maintain the continuity of the analysis and ensure the inclusion of matchweek 23 in the overall assessment of the strategies.

In the case of quadratic utilities, the optimal portfolios were obtained by maximizing the Sharpe Ratio through the solution of the convex optimization problem (\ref{eq:2.min_sharperatio_convex}) using the SQP algorithm. On average, the algorithm took 5.3 seconds per fixture to converge. It is worth mentioning that all optimizations successfully converged for the Sharpe Ratio criterion.

% Figure environment removed

Three matches with arbitrage opportunities across three different matchweeks were identified. One notable example is the match between Everton and Aston Villa on June 5, 2021, which had a commission of $tt = -0.0085$. The following table provides a summary of the performance of both strategies in comparison to the match featuring arbitrage on that particular match day.

\begin{table}[ht]
\captionsetup{font=footnotesize}
\centering
\resizebox{10cm}{!}{
\begin{tabular}{@{}lcccccc@{}}
    \toprule
    \multicolumn{1}{c}{\textbf{Result}} & \textbf{$\hat{p}$}  & \textbf{$\ou$} & \textbf{$\ou^{-1}$} & \textbf{$\ou^{-1} / (1 + tt)$} & \textbf{$\ell_{*}^{(S)}$} &  \textbf{$\ell_{*}^{(K)}$}  \\ \midrule
    \textbf{Home}                          & 42.34\%          & 2.07          & 48.31\%               & 48.73\%                         & 48.71\%          &0.52\%\\
    \textbf{Draw}                        & 32.08\%          & 3.7           & 27.03\%               & 27.26\%                         & 27.25\%          &7.35\%\\
    \textbf{Away}                        & 25.58\%          & 4.2           & 23.81\%               & 24.01\%                         & 24.01\%          &4.04\%\\
    \textbf{Total}                         & \textbf{100.0\%} & \textbf{-}    & \textbf{99.1\%}       & \textbf{100.0\%}                & \textbf{99.7\%} & \textbf{11.91\%}\\ \bottomrule
    \end{tabular}
}
\caption{\label{tab:table_arbitrage} Sharpe Criterion $\ell_{*}^{(S)}$ and Kelly $\ell_{*}^{(K)}$ strategies for the 2021 Everton v.s. Aston Villa match.}
\end{table}

\subsubsection{Restricted Strategies}

The restricted betting sample space consists of the event with the highest expected value. Mathematically, it can be defined as $\Omega := \bigtimes_{i}^{r} \left\{\omega_{k} \suchthat k = \argmax_{j} \{\mathbb{E}[\varrho_{i,j}]\}, \quad j = 1, 2, \dots, m_{i} \right\}$. Consequently, the number of possible outcomes is reduced to $N = 2^{10}$, and the total number of bets is $M = 3 \times 10$. The algorithms for both utilities exhibited convergence, with an average convergence time of approximately 1 second for all match days, and there were no instances of non-convergence.

% Figure environment removed

The table below presents the portfolios derived from the Kelly Criterion and the Sharpe Ratio Criterion for the final matchweek of the English Premier League. It is noteworthy that the Kelly criterion never wagers the entire wealth, unlike the Sharpe Ratio criterion. Additionally, while the two criteria allocate similar amounts for each event, the magnitude of the largest bet differs between them.

\begin{table}[ht]
\captionsetup{font=footnotesize}
\centering
\resizebox{16cm}{!}{
\begin{tabular}{lcccccccccc} 
\hline
\textbf{Home}                                            & Arsenal    & Aston Villa & Fulham     & Leeds      & Leicester  & Liverpool  & Man. City   & Sheffield  & Westham     & Wolves      \\
\textbf{Away}                                           & Brighton   & Chelsea     & Newcastle  & West Brom  & Tottenham  & Crystal    & Everton    & Burnley    & Southampton & Man. United  \\ 
\hline
\textbf{$\mathscr{e}$}                          & \textbf{D} & \textbf{H}  & \textbf{A} & \textbf{A} & \textbf{A} & \textbf{A} & \textbf{H} & \textbf{A} & \textbf{A}  & \textbf{A}  \\
\textbf{$\ou$ }                            & 4.46       & 7           & 3.41       & 7          & 3.5        & 18.32      & 1.47       & 2.45       & 5.03        & 2.75        \\
\textbf{$\hat{p}$ }                             & 26.25\%    & 31.66\%     & 41.48\%    & 26.85\%    & 31.58\%    & 10.17\%    & 75.39\%    & 48.46\%    & 25.11\%     & 41.88\%     \\
\textbf{$\mathbb{E}[\varrho]$} & 17.07\%    & 121.65\%    & 41.45\%    & 87.95\%    & 10.53\%    & 86.24\%    & 10.82\%    & 18.73\%    & 26.31\%     & 15.17\%     \\
\multicolumn{11}{c}{\textbf{Strategies}}                                                                                                                                                      \\
\textbf{Kelly}                                            & 3.23\%     & 17.89\%     & 12.77\%    & 12.05\%    & 2.65\%     & 3.93\%     & 14.33\%    & 8.56\%     & 4.47\%      & 5.61\%      \\
\textbf{Sharpe}                                        & 4.44\%     & 11.50\%     & 14.72\%    & 9.16\%     & 3.99\%     & 2.82\%     & 27.05\%    & 12.52\%    & 5.54\%      & 8.26\%      \\
\hline
\end{tabular}
}
\caption{\label{tab:table_mtchw_kelly_mktz} Restricted strategies for the final day of the 20/21 EPL. The events $e$ denote bets on home win \textbf{H}, draw \textbf{D} or away win \textbf{A}.}
\end{table}

\subsubsection{Portfolios' Performance}
The metrics for the eight portfolios for the 20 fixtures are summarized below, including the metrics \textit{pval bets} and \textit{pval wealth}. The \textit{pval bets} metric represents the p-value of the hypothesis test that the average of the betting outcomes is not positive. Similarly, the \textit{pval wealth} metric is the p-value for the hypothesis that the wealth obtained in the matchweeks is not positive.

\begin{table}[ht]
\captionsetup{font=footnotesize}
\centering
\resizebox{14cm}{!}{
\begin{tabular}{llcccccccc} 
\toprule
\multirow{3}{*}{\textbf{Model}}    & \textbf{Strategy}              & \textbf{Sharpe} & \textbf{Kelly} & \textbf{Kelly} & \textbf{Sharpe} & \textbf{Kelly} & \textbf{Sharpe} & \textbf{Kelly} & \textbf{Sharpe}  \\
                                    & \textbf{Restricted}             & Yes                & Yes            & No            & No                & Yes            & No                & No            & Yes                 \\
                                    & \textbf{FracciÃ³n}                & 17\%               & 17\%           & 17\%           & 17\%               & 100\%          & 100\%              & 100\%          & 100\%               \\ 
\midrule
\multirow{10}{*}{\textbf{Metrics}} & \textbf{Final Wealth}                      & \textbf{135\%}     & \textbf{111\%} & \textbf{102\%} & \textbf{97\%}      & \textbf{24\%}  & \textbf{16\%}      & \textbf{3\%}   & \textbf{0\%}        \\
                                    & \textbf{Number of Bets}           & 196                & 195            & 319            & 323                & 195            & 323                & 319            & 176                 \\
                                    & \textbf{Average Stake} & 17\%               & 14\%           & 17\%           & 17\%               & 83\%           & 100\%              & 98\%           & 100\%               \\
                                    & \textbf{Hits}        & 33\%               & 33\%           & 30\%           & 30\%               & 33\%           & 30\%               & 30\%           & 32\%                \\
                                    & \textbf{Sharpe Average}                  & 0.62               & 0.58           & 0.64           & 1.41               & 0.58           & 1.41               & 0.64           & 0.62                \\
                                    & \textbf{Log-Growth Average}                      & 0.06               & 0.06           & 0.07           & 0.04               & 0.21           & 0.16               & 0.23           & -$\infty$                \\
                                    & \textbf{Volatility Average}                & 0.01               & 0.02           & 0.02           & 0.00               & 0.56           & 0.13               & 0.54           & 0.38                \\
                                    & \textbf{Betting pval}           & 0.21               & 0.35           & 0.42           & 0.50               & 0.35           & 0.50               & 0.42           & 0.35                \\
                                    & \textbf{Wealth pval}            & 0.16               & 0.33           & 0.41           & 0.50               & 0.33           & 0.50               & 0.41           & 0.31                \\
\bottomrule
\end{tabular}
}
\caption{\label{tab:table_comparative_finance} Summary statistics of the performance for each of the portfolios throughout the test period.}
\end{table}