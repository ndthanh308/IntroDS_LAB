%!TEX root = ../main.tex
%%% Local Variables:
%%% mode: latex
%%% TeX-master: "../main"
%%% End:

\section{Semantics}
\label{sec:semantics}

We briefly recall the setup of abstract separation logic~\cite{DBLP:conf/lics/CalcagnoOY07} which we adapt slightly as a basis for our formal development.

A separation algebra $(\setstates, \mstar, \emp)$ is a cancellative and
commutative monoid in which the multiplication $\mstar$ is only partially defined and we have a set of units $\emp$.
By cancellativity, we mean that if $\astate_1\mstar\astatep$ and $\astate_2\mstar\astatep$ are both defined and $\astate_1\mstar\astatep=\astate_2\mstar\astatep$, then $\astate_1=\astate_2$ follows.
For every state $\astate\in\setstates$, we require that there is a unit $\munit\in\emp$ with $\astate\mstar\munit=\astate$.
Moreover, for every pair of units $\munit\neq \munit'$ in $\emp$, we expect that the multiplication is undefined.
We use $\astate\statemultdef\astatep$ to denote definedness of the multiplication.

Predicates in the set $\setpreds=\powerset{\setstates}\cup\set{\abort}$ are sets of states or a dedicated symbol~$\abort$ that indicates a failure of a computation.
We extend the multiplication to predicates, then called separating conjunction, by defining $\apred\mstar \apredp=\setcond{\astate\mstar\astatep}{\astate\in\apred\wedge \astatep\in\apredp\wedge \astate\statemultdef\astatep}$ for $\apred, \apredp\subseteq\setstates$ and $\apred\mstar\abort=\abort\mstar\apred=\abort$ for $\apred\in\setpreds$.
We endow predicates with an ordering that coincides with inclusion on sets of states and has $\abort$ as the top element: $\apred\predleq\apredp$ if $\apred, \apredp\subseteq\setstates$ and~$\apred\subseteq\apredp$, and $\apred\predleq\abort$ for all $\apred\in\setpreds$.
Then $(\setpreds, \predleq)$ is a complete lattice and we use~$\bigpredjoin\asetpreds$ to denote the least upper bound, or simply join, of a set of predicates $\asetpreds\subseteq\setpreds$.

We say $\apred \subseteq \setstates$ is \emph{precise} if it identifies unique substates: for every $\astate \in \setstates$ there exists at most one $\astatep \in \apred$ such that $\astate \in \{\astatep\} \mstar \setstates$.

We define our programming language parametric in a set of commands $\setcom$.
The set is expected to come with a semantics
\begin{align*}
	\sem{-}: \setcom\rightarrow \setpredtrans
\end{align*}
that assigns to each $\acom\in\setcom$ a predicate transformer $\sem{\acom}\in\setpredtrans$.
The predicate transformers used in separation logic are functions $\sem{\acom}:\setpreds\rightarrow\setpreds$ that satisfy $\semof{\acom}{\abort}=\abort$ and $\semof{\acom}{\bigpredjoin\asetpreds}=\bigpredjoin \semof{\acom}{\asetpreds}=\bigpredjoin\setcond{\semof{\acom}{\apred}}{\apred\in\asetpreds}$ for all $\asetpreds\subseteq\setpreds$.
They are strict in $\abort$ and distribute over arbitrary joins.
With a pointwise lifting of the ordering on predicates, predicate transformers form a complete lattice $(\setpredtrans, \predtransleq)$ as well.

We consider sequential while-programs over $\setcom$ of the form
\begin{align*}
	\astmt\quad \defebnf\quad \acom\bnf\choiceof{\astmt_1}{\astmt_2}\bnf\seqof{\astmt_1}{\astmt_2}\bnf{\loopof{\astmt}} \enspace.
\end{align*}
Programs also have a semantics in terms of predicate transformers that is derived from the semantics of commands.
The non-deterministic choice is the join, $\sem{\choiceof{\astmt_1}{\astmt_2}}=\sem{\astmt_1}\predtransjoin\sem{\astmt_2}$, the composition is function composition, $\sem{\seqof{\astmt_1}{\astmt_2}}=\sem{\astmt_2}\circ\sem{\astmt_1}$, and the semantics of iteration is $\sem{\loopof{\astmt}}=\bigpredtransjoin_{i\in\nat}\sem{\astmt^i}$ with $\sem{\astmt^0}$ being the identity and $\sem{\astmt^{i+1}}=\sem{\seqof{\astmt}{\astmt^i}}$.
The set of predicate transformers is closed under these constructions, and so $\sem{\astmt}\in\setpredtrans$.

We specify program correctness with Hoare triples of the form $\hoareof{\apred}{\astmt}{\apredp}$.
The triple is valid, denoted by $\models \hoareof{\apred}{\astmt}{\apredp}$, if $\semof{\astmt}{\apred}\predleq\apredp$.
We reason about validity using the separation logic (SL) induced by $\sem{-}$, which is given in \cref{Figure:PL} (ignore the \makeColorLogic{blue} parts for now).
If there is a derivation for a Hoare triple, we write $\vdash\hoareof{\apred}{\astmt}{\apredp}$.
For soundness of the frame rule, it is well-known that the predicate transformers $\sem{\acom}$ need to satisfy an extra property called \emph{locality}: for all $\apred, \apredp\in\setpreds$ we need
\begin{align}
	\semof{\acom}{\apred\mstar\apredp}\predleq\semof{\acom}{\apred}\mstar\apredp
	\enspace .
	\tag{Locality}
	\label{Equation:Locality}
\end{align}
We say that a rule is sound if validity of the premise entails validity of the conclusion.

\begin{theorem}
	\label{Lemma:SoundnessHoare}
	\label{Lemma:SoundnessSL}
	Separation logic is sound: ${}\vdash\hoareof{\apred}{\astmt}{\apredp}$ entails ${}\models \hoareof{\apred}{\astmt}{\apredp}$.
\end{theorem}

\input{content/rules}

A state $\astate$ is a footprint of $\sem{\acom}$ if $\semof{\acom}{\set{\astate}}\neq \abort$, the transformer does not abort on the state.
