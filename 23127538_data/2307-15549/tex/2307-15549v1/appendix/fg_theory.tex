%!TEX root = ../main.tex
%%% Local Variables:
%%% mode: latex
%%% TeX-master: "../main"
%%% End:

For simplicity, we write $\aflowconstraint.\fval$ and $\aflowconstraint.\outflow$ to refer to a flow graph $\aflowconstraint$'s flow and outflow, which are derived quantities (cf. \cref{sec:instantiation}).

\subsection{Additional Meta Theory}

\begin{definition}
	Consider functions $f,g$ with the same signature.
	We write $f \fpreldot g$ iff $f(x) \fprel g(x)$ for all $x$.
	We write $f \fpreleq g$ iff $f(x) \fprel g(x) \,\vee\, f(x) = g(x)$ for all $x$.
\end{definition}

\begin{definition}
	Consider a flow graph $\aflowconstraint=(\setnodes,\edges,\aninflow)$ and $\setnodesp\subseteq\nat$.
	Define \[
	  \restrictto{\aflowconstraint}{\setnodesp}
	  ~~\defeq~~
	  (\setnodes\cap\setnodesp, \restrictto{\edges}{(\setnodes\cap\setnodesp)\times\nat}, \inflow')
	\]
	such that
	\begin{inparaenum}
	 	\item $\inflow'(\anodepp, \anodep)\defeq\inflow(\anodepp, \anodep)$ for all $\anodepp\in\nat\setminus\setnodes$, $\anodep\in\setnodes\cap\setnodesp$, and
	 	\item $\inflow(\anode, \anodep)\defeq\edges_{(\anode, \anodep)}(\aflowconstraint.\fvalof{\anode})$ for all $\anode\in\setnodes\setminus\setnodesp$,  $\anodep\in\setnodes\cap\setnodesp$.
	\end{inparaenum}
\end{definition}

\begin{definition}
	Define $\transformerof{\aflowconstraint_1} \fprel_{\inflow} \transformerof{\aflowconstraint_2}$
	iff
	$\transformerof{\aflowconstraint_1}(\inflow') \fpreldot \transformerof{\aflowconstraint_2}(\inflow')$, for all inflows $\inflow' \leq \inflow$ and all nodes $\anode$.
\end{definition}

\begin{remark}
	We have $\aflowconstraint_1 \ctxfprel \aflowconstraint_2$ iff $\aflowconstraint_1.\setnodes = \aflowconstraint_2.\setnodes$ and $\aflowconstraint_1.\inflow = \aflowconstraint_2.\inflow$ and $\transformerof{\aflowconstraint_1}\fprel_{\aflowconstraint_1.\inflow}\transformerof{\aflowconstraint_2}$.
\end{remark}

\begin{definition}
	Consider an inflow $\inflow : (\nat\setminus\setnodes)\times\setnodes \to \amonoid$ and a set of nodes $\setnodesp\subseteq\nat\setminus\setnodes$.
	Then, the $\fprel$-upward $\setnodesp$-closure of $\inflow$ is: \[
		\fpclosureof{\setnodesp}{\inflow}
		~\defeq~
		\setcond{
			\restrictto{\inflow}{(\nat\setminus\setnodesp)\times\setnodes} \,\uplus\, \inflow'
		}{
			% \restrictto{\inflow}{\setnodesp\times\setnodes} \fprel \inflow_2
			\forall\anode\in\setnodes.~\sum_{\anodep\in\setnodesp} \inflow(\anodep,\anode) \fprel \sum_{\anodep\in\setnodesp} \inflow'(\anodep,\anode)
		}
		\ .
	\]
	We write $\fpclosureof{\setnodesp}{\aflowconstraint}$ for a flow constraint $\aflowconstraint=(\setnodes,\edges,\inflow)$ to mean $\fpclosureof{\setnodesp}{\inflow}$.
	We may also write $\fpclosureof{\aflowconstraint'}{\aflowconstraint}$ for another flow graph $\aflowconstraint'$ to mean $\fpclosureof{\aflowconstraint'\!.\setnodes}{\aflowconstraint}$.
\end{definition}

\begin{definition}
	\label{def:fpcompat}
	For a relation $\fprel {\:\subseteq\;} \amonoid \times \amonoid$ and a flow graph $\aflowconstraint$, we write $\fpcompatible[\fprel]{\aflowconstraint}$ if:
	\begin{compactenum}[({C}1)]
		\item\customlabel{def:fpcompat:refl-trans}{C\theenumi}
			$\fprel$ is transitive and $\bot\fprel\bot$,
		\item\customlabel{def:fpcompat:add}{C\theenumi}
			$\amonval \fprel \amonvalp$ implies $\amonval+\amonvalpp \fprel \amonvalp+\amonvalpp$ for all $\amonval,\amonvalp,\amonvalpp\in\amonoid$,
		\item\customlabel{def:fpcompat:edges}{C\theenumi}
			all edge functions $f$ in $\aflowconstraint.\edges$ are $\fpreldot$-monotonic, i.e., 
			$\amonval \fprel \amonvalp$ implies $f(\amonval) \fprel f(\amonvalp)$, and
		\item\customlabel{def:fpcompat:lfp}{C\theenumi}
			$\bigjoin\achain\fpreldot\bigjoin\achainp$ holds for all $\leq$-ascending chains $\achain,\achainp$ of the form $\achain=f^0(\bot)\leq f^1(\bot)\leq\cdots$ and $\achainp=g^0(\bot)\leq g^1(\bot)\leq\cdots$ that have the following properties: $\bigjoin\achain\fpreldot g(\bigjoin\achain)$, and $f^i(\bot)\fpreldot g^i(\bot)$ for all $i\in\nat$, and $f,g$ are $\leq$-continuous and $\fpreldot$-monotonic functions with the signature $f,g:(\aflowconstraint.\setnodes{\to}\amonoid)\to(\aflowconstraint.\setnodes{\to}\amonoid)$.
	\end{compactenum}
\end{definition}

% ----------------------------------------------------------------------------
% ----------------------------------------------------------------------------

\begin{lemma}
	\label{thm:our-monoid-has-bot}
	The $\omega$-cpo $(\amonoid,\leq)$ has a least element $\bot$, namely $\bot=\monunit$.
\end{lemma}

\begin{lemma}
	\label{thm:our-monoid-has-addprop}
	Consider $\amonval,\amonval',\amonvalp,\amonvalp',\amonvalpp\in\amonoid$.
	If $\amonval\leq\amonvalp$, then $\amonval+\amonvalpp\leq\amonvalp+\amonvalpp$.
	Moreover, if $\amonval\leq\amonvalp$ and $\amonval'\leq\amonvalp'$, then $\amonval+\amonval'\leq\amonvalp+\amonvalp'$.
\end{lemma}

\begin{lemma}
	\label{thm:our-monoid-sum-vs-join}
	Consider $\leq$-ascending chains $\achain_0,\dots,\achain_n$ with $\achain_i=\amonval_{i,0}\leq\amonval_{i,1}\leq\cdots$.
	Then, we have the following: $\sum_{i=0}^{n}\bigjoin\setcond{\amonval_{i,j}}{j\in\nat}=\bigjoin\setcond{\sum_{i=0}^{n}\amonval_{i,j}}{j\in\nat}$.
\end{lemma}

\begin{lemma}
	\label{thm:add-relations}
	If $\fpcompatible[\fprel]{\dontcare}$, then $\amonval\fprel\amonvalp$ and $\amonval'\fprel\amonvalp'$ implies $\amonval+\amonval'\fprel\amonvalp+\amonvalp'$, for all $\amonval,\amonval',\amonvalp,\amonvalp'\in\amonoid$.
\end{lemma}

\begin{lemma}
	\label{thm:continuous-implies-monotonic-special}
	Consider $f \in \contfunof{\amonoid\to\amonoid}$ and $g \in \contfunof{(\setnodes{\to}\amonoid)\to(\setnodes{\to}\amonoid)}$ for some $\setnodes\subseteq\nat$.
	Then both $f$ and $g$ are $\leq$-monotonic.
\end{lemma}

\begin{lemma}[Kleene]%[Kleene~\cite{??}]
	\label{thm:fixpoint-kleene}
	Consider a $\leq$-continuous function $f: (\setnodes{\to}\amonoid) \to (\setnodes{\to}\amonoid)$ for some $\setnodes\subseteq\nat$.
	Then, we have (i) an $\leq$-ascending Kleene chain $\achain = f^0(\bot)\leq f^1(\bot)\leq\cdots$, (ii) the join $\bigjoin\achain$ exists in $\amonoid$, (iii) and $\lfpof{f}=\bigjoin\achain$.
\end{lemma}

\begin{lemma}
	\label{thm:flow-iteration-monotonic-continuous}
	Consider a flow graph $\aflowconstraint=(\setnodes,\edges,\inflow)$ and function $f : (\setnodes\to\amonoid)\to(\setnodes\to\amonoid)$ defined by $f(\cval)(\anode)=\sum_{\anodep\in\nat\setminus\setnodes}\inflow(\anodep,\anode) + \sum_{\anodep\in\setnodes}\edgesatof{\anodep}{\anode}{\cval(\anodep)}$.
	Then, $f$ is $\leq$-monotonic and $\leq$-continuous.
	Moreover, if $\fpcompatible[\fprel]{\aflowconstraint}$, then $f$ is also $\fprel$-monotonic.
\end{lemma}

\begin{lemma}
	\label{thm:flow-as-lfp}
	Consider a flow graph $\aflowconstraint=(\setnodes,\edges,\inflow)$.
	Define the function $\fiter : (\setnodes\prall{\to}\amonoid) \to (\setnodes\prall{\to}\amonoid)$ by $\fiter(\fval)(\anode)\defeq\fval(\anode)$
	Then, the flow in $\aflowconstraint$. is given by $\aflowconstraint.\fval = \lfpof{\fiter} = \bigjoin\setcond{\fiter^i(\bot)}{i\in\nat}$.
\end{lemma}

% ----------------------------------------------------------------------------
% ----------------------------------------------------------------------------

\begin{lemma}
	\label{thm:restriction-vs-statemult}
	Consider $\aflowconstraint$ and $\setnodesp\subseteq\nat$.
	Then, we have:
	\begin{inparaenum}[(i)]
		\item $\restrictto{\aflowconstraint}{\setnodesp}.\fval = \restrictto{\aflowconstraint.\fval}{\setnodesp}$,
		\item $\restrictto{\aflowconstraint}{\setnodesp} \statemultdef \restrictto{\aflowconstraint}{\aflowconstraint.\setnodes\setminus\setnodesp}$, and
		\item $\restrictto{\aflowconstraint}{\setnodesp} \statemult \restrictto{\aflowconstraint}{\aflowconstraint.\setnodes\setminus\setnodesp} = \aflowconstraint$.
	\end{inparaenum}
\end{lemma}

\begin{lemma}
	\label{thm:outflow-vs-statemult}
	Consider $\aflowconstraint_1,\aflowconstraint_2$ with $\aflowconstraint_1\statemultdef\aflowconstraint_2$ and $\anode\in\aflowconstraint_1.\setnodes$ and $\anodep\in\nat\setminus(\aflowconstraint_1.\setnodes\cup\aflowconstraint_2.\setnodes)$.
	Then, we have the following: $(\aflowconstraint_1\statemult\aflowconstraint_2).\outflow(\anode,\anodep)=\aflowconstraint_1.\outflow(\anode,\anodep)=\aflowconstraint_1.\edgesatof{\anode}{\anodep}{\aflowconstraint_1.\fval(\anode)}$.
\end{lemma}

\begin{lemma}
	\label{thm:transformer-vs-statemult}
	Consider $\aflowconstraint_1,\aflowconstraint_2$ with $\aflowconstraint_1\statemultdef\aflowconstraint_2$ and $\anode\in\nat\setminus(\aflowconstraint_1.\setnodes\cup\aflowconstraint_2.\setnodes)$.
	Then, the transformer decomposes as follows: $\transformerofof{\aflowconstraint_1\statemult\aflowconstraint_2}{(\aflowconstraint_1\statemult\aflowconstraint_2).\inflow}(\anode)=\transformerofof{\aflowconstraint_1}{\aflowconstraint_1.\inflow}(\anode)+\transformerofof{\aflowconstraint_2}{\aflowconstraint_2.\inflow}(\anode)$.
\end{lemma}

\begin{lemma}
	\label{thm:inflow-leq}
	Consider $\aflowconstraint$ and inflows $\inflow_1 \leq \inflow_2$.
	Then,
	\begin{inparaenum}
		\item $\aflowconstraint[\inflow\mapsto\inflow_1].\fval \leq \aflowconstraint[\inflow\mapsto\inflow_2].\fval$, and
		\item $\transformerofof{\aflowconstraint}{\inflow_1} \leq \transformerofof{\aflowconstraint}{\inflow_2}$.
	\end{inparaenum}
\end{lemma}

\begin{lemma}
	\label{thm:inflow-fprel}
	Consider $\aflowconstraint$ with $\fpcompatible[\fprel]{\aflowconstraint}$ and inflows $\inflow_1 \fpreleq \inflow_2$.
	Then, we have the following:
	\begin{inparaenum}
		\item $\aflowconstraint[\inflow\mapsto\inflow_1].\fval \fpreldot \aflowconstraint[\inflow\mapsto\inflow_2].\fval$, and
		\item $\transformerofof{\aflowconstraint}{\inflow_1} \fpreldot \transformerofof{\aflowconstraint}{\inflow_2}$.
	\end{inparaenum}
\end{lemma}

\begin{lemma}
	\label{thm:partial-fixpoint}
	Consider flow graphs $\aflowconstraint_1=(\setnodes_1,\edges_1,\inflow_1)$ and $\aflowconstraint_2=(\setnodes_2,\edges_2,\inflow_2)$ with $\aflowconstraint_1\statemultdef\aflowconstraint_2$.
	Define functions $f : (\setnodes_2 \prall{\to} \amonoid) \to (\setnodes_2 \prall{\to} \amonoid)$ and $\inflow_\cval : (\nat\setminus\setnodes_1) \times \setnodes_1 \to \amonoid$ by:
	\begin{align*}
		f(\cval)(\anode) ~&\defeq~~
			\sum_{\anodepp\notin\setnodes_1\cup\setnodes_2} (\aflowconstraint_1\statemult\aflowconstraint_2).\inflowat{\anodepp,\anode}
			+
			\transformerofof{\aflowconstraint_1}{\inflow_\cval}(\anode)
			+
			\sum_{\anodep\in\setnodes_2} \aflowconstraint_2.\edgesatof{\anodep}{\anode}{\cval(\anodep)}
		\\
		\inflow_\cval(\anode,\anodep) ~&\defeq~~
			\anode\in\setnodes_2 ~~~?~~~
			\aflowconstraint_2.\edgesatof{\anodep}{\anode}{\cval(\anodep)}
			~~:~~
			(\aflowconstraint_1\statemult\aflowconstraint_2).\inflowat{\anode,\anodep}
	\end{align*}
	Then, $f$ is $\leq$-monotonic and $\leq$-continuous and $\aflowconstraint_2.\fval = \lfpof{f} = \bigjoin\setcond{f^i(\bot)}{i\in\nat}$.
	Furthermore, if $\fpcompatible[\fprel]{\aflowconstraint_1\statemult\aflowconstraint_2}$, then $f$ is also $\fpreldot$-monotonic.
\end{lemma}

\begin{lemma}
	\label{thm:upward-closed-outflow}
	Consider $\aflowconstraint_1,\aflowconstraint_2,\aflowconstraint_F$ with $\aflowconstraint_1\statemultdef \aflowconstraint_F$ and $\aflowconstraint_1 \ctxfprel \aflowconstraint_2$ and $\fpcompatible[\fprel]{\aflowconstraint_1,\aflowconstraint_2,\aflowconstraint_F}$.
	Then there is a flow graph $\aflowconstraint_{2+F} = (\aflowconstraint_2.\setnodes\uplus\aflowconstraint_F.\setnodes,\:\aflowconstraint_2.\edges\uplus\aflowconstraint_F.\edges,\:\aninflow)$ such that $\transformerofof{\aflowconstraint_1\statemult\aflowconstraint}{\aninflow}\fpreldot\transformerofof{\aflowconstraint_{2+F}}{\aninflow}$, where $\aninflow=(\aflowconstraint_1\statemult\aflowconstraint_F).\inflow$.
	Moreover, $\restrictto{\aflowconstraint_{2\statemult F}}{\aflowconstraint_2.\setnodes}\in\fpclosureof{\aflowconstraint_F}{\aflowconstraint_2}$ and $\restrictto{\aflowconstraint_{2\statemult F}}{\aflowconstraint_F.\setnodes}\in\fpclosureof{\aflowconstraint_2}{\aflowconstraint_F}$.
\end{lemma}

\begin{theorem}
	\label{thm:upward-closed-framing}
	Consider flow graphs $\aflowconstraint_1,\aflowconstraint_2,\aflowconstraint_F$ with $\aflowconstraint_1\statemultdef \aflowconstraint_F$ and $\aflowconstraint_1 \ctxfprel \aflowconstraint_2$.
	Furthermore, assume $\fpcompatible[\fprel]{\aflowconstraint_1,\aflowconstraint_2,\aflowconstraint_F}$.
	Then there are $\aflowconstraint_2'\in\fpclosureof{\aflowconstraint_F}{\aflowconstraint_2}$ and $\aflowconstraint_F'\in\fpclosureof{\aflowconstraint_2}{\aflowconstraint_F}$ such that $\aflowconstraint_2'\statemultdef\aflowconstraint_F'$ and  $\aflowconstraint_1 \statemult \aflowconstraint_F \ctxfprel \aflowconstraint_2'\statemult\aflowconstraint_F'$.
\end{theorem}

\begin{lemma}
	\label{thm:easy-fprel-lfp}
	Assume $\bigjoin\achain\fprel\bigjoin\achainp$ for all $\leq$-ascending chains $\achain,\achainp$ of the form $\achain=\amonval_0\leq\amonval_1\leq\cdots$ and $\achainp=\amonvalp_0\leq\amonvalp_1\leq\cdots$ with $\amonval_i\fprel\amonvalp_i$ for all $i\in\nat$.
	Then, \eqref{def:fpcompat:lfp} holds.
\end{lemma}

\begin{lemma}
	\label{thm:fprelcompatible-sub-omega-cpo}
	If $\fprel$ is a sub-$\omega$-cpo of $\leq$, then \eqref{def:fpcompat:lfp} holds.
\end{lemma}

\begin{lemma}
	\label{thm:fprelcompatible-acc}
	If $(\amonoid,\leq)$ satisfies the ascending chain condition, then \eqref{def:fpcompat:lfp} holds.
\end{lemma}

\begin{lemma}
	\label{thm:trivial-choices}
	For all flow graphs $\aflowconstraint$ we have $\fpcompatible[\leq]{\aflowconstraint}$ and $\fpcompatible[=]{\aflowconstraint}$.
\end{lemma}
