
\begin{algorithm}
    \caption{Trainable Dynamic Difference Layer (TDDL)}\label{alg:TDDL}
    \begin{algorithmic}[1]
        \STATE \textbf{initialize} $K_{uv}^0$ for all possible $u$ and $v$ by Prop. \ref{prop:kernels-in-hyperplane} with $L$, $\Delta x$, $\Delta y$ defined in Sec. \ref{sec:tddl}

        \item[]
        \FUNCTION{TDDL($h$, \texttt{pqr\_list})}%\COMMENT{\texttt{pqr\_list} stores all the pairs of $(p,q)$ and $r$ we need}

        \item[]
        \STATE $\texttt{h\_diff\_list}\gets\texttt{[]}$
        \STATE
        \FOR{\texttt{var} \textbf{in} $h$:}%\COMMENT{\texttt{var} loops through all the variables (channels) of $h$}
        \STATE
        \STATE $\texttt{var\_diff\_list}\gets\texttt{[]}$
        \STATE
        \FOR{$(p,q), r$ \textbf{in} $\texttt{pqr\_list}$:}
        \STATE
        \STATE \texttt{Cuv} $\gets$ CNN{$h$, $p+q+r$}%\COMMENT{the parameters of CNNs vary according}
        \STATE \COMMENT{to different \texttt{var} and $((p,q), r)$}
        \FOR{\texttt{i,j} \textbf{in} grid point locations:}
        \STATE
        \STATE $(c_{uv})_{u+v>p+q+r}\gets\texttt{Cuv[i,j]}$%\COMMENT{aliasing}
        \STATE $\texttt{K[i,j]}\gets K_{pq}^0+\sum_{u+v>p+q+r}c_{uv}K_{uv}^0$%\COMMENT{by Prop. \ref{prop:kernels-in-hyperplane}}
        \STATE
        \ENDFOR
        \STATE
        \STATE $\texttt{conv[i,j]}\gets\sum_{\texttt{s,t}=-L}^L\texttt{K[i,j][s,t] * var[i+s,j+t]}$%\COMMENT{dynamic conv.}
        \STATE \textbf{append} \texttt{conv} \textbf{to} \texttt{var\_diff\_list}
        \STATE
        \ENDFOR
        %\Statex
        \STATE \textbf{append} \texttt{var\_diff\_list} \textbf{to} \texttt{h\_diff\_list}
        \STATE
        \ENDFOR
        \STATE \textbf{return} \texttt{h\_diff\_list}
        \STATE
        \ENDFUNCTION
        \STATE
        \FUNCTION{CNN($h$, $m$)}

        \STATE
        \STATE $\texttt{x}\gets\texttt{Relu}(\texttt{Conv2d}(h))$%\COMMENT{16 output channels}
        \STATE $\texttt{x}\gets\texttt{Relu}(\texttt{Conv2d}(\texttt{x}))$%\COMMENT{16 output channels}
        \STATE $\texttt{x}\gets\texttt{Conv2d}(\texttt{x})$%\COMMENT{$((2L+1)^2-\frac12m(m+1))$ output channels by Eq. (\ref{eq:channel-num})}
        \STATE \textbf{return} \texttt{x}
        \STATE
        \ENDFUNCTION
    \end{algorithmic}
\end{algorithm}