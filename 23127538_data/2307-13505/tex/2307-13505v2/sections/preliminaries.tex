\textbf{Basic concepts and notations.}
An alphabet $\Sigma$ is a finite set of letters.
The set of finite words over $\Sigma$ will be denoted by $\Sigma^*$,
the empty word by $\epsilon$ and, for two words $u$ and $v$, $uv$ will denote their concatenation.
For two sets $X$ and $Y$, we denote by $X \times Y$ their cartesian product and by
$\proj{X}\colon X \times Y \to X$ and $\proj{Y}\colon X \times Y \to Y$
we denote the canonical projection on $X$ and $Y$ respectively.
The set nonnegative integers will be denoted by $\mathbb{N}$.
For two integers $i,j$, we will denote by $\intInterv{i}{j}$
the interval of integers between $i$ and $j$ (both included).

A \emph{semigroup} $(S,*)$ is a set $S$ together with an associative binary operation $*$.
If $(S,*)$ has an identity element $e$, $(S,*,e)$ is called a \emph{monoid}
and if, moreover, every element has an inverse, $(S,*,e)$ is called a \emph{group}.
If there is no ambiguity, we will identify algebraic structures with the set that they are defined on.
A semigroup (or a monoid/group) is said to be \emph{commutative} if its law is.
A sub-semigroup (or submonoid/subgroup) of $S$ is a subset of $S$ that is a semigroup (or a monoid/group).
Given $E \subseteq S$, the monoid \emph{generated} by $E$, denoted
$\genMono{E}$, is the smallest sub-monoid of $S$ containing $E$.

A \emph{field} $(\mathbb{K},+,\cdot)$ is a structure where $(\mathbb{K},+,0)$ and
$(\mathbb{K}\setminus \left\{ 0 \right\}, \cdot, 1)$ are commutative groups and multiplication distributes
over addition.
In this work, we will consider $\mathbb{K}$ as the field of rational numbers $\mathbb{Q}$,
or any finite field extension of $\mathbb{Q}$, to perform basic operations in polynomial time.
For all $n \in \mathbb{N}$, $\mathbb{K}^n$ is an $n$-dimensional \emph{vector space}
over the field $\mathbb{K}$.
We will work with row vectors and apply matrices on the right, and we will identify
linear maps (\resp linear forms) with their corresponding matrices (\resp column vectors).
The set of $n$ by $m$ matrices over $\mathbb{K}$ will be denoted by $\matrSet{\mathbb{K}}{n}{m}$,
and $\vectSet{\mathbb{K}}{n}$ (or simply $\mathbb{K}^n$ when there is no ambiguity)
will denote the set of $n$-dimensional vectors.
For any matrix $M$ (\resp vector $v$), and indices $i$ and $j$,
$M_{i,j}$ (\resp $v_i$) will denote the value of the
entry in the $i$-th row and the $j$-th column of $M$ (\resp the $i$-th entry of $v$).
Matrix transposition will be denoted by $M^t$.
A \emph{vector subspace} of $\mathbb{K}^n$ is a subset of $\mathbb{K}^n$
stable by linear combinations and for all subsets $E$ of $\mathbb{K}^n$,
$\linSpan{E}$ will denote the smallest vector subspace of $\mathbb{K}^n$
containing $E$ (if $E$ contains a single vector $(x_1, \dots, x_n)$,
$\linSpan{E}$ will be denoted by $\linSpan{x_1, \dots, x_n}$).

$\mathbb{K}^n$ can also be seen as an $n$-dimensional \emph{affine space}.
Affine maps $f \colon \mathbb{K}^n \to \mathbb{K}^m$ are maps of the form
$f(u) = u \linPart{f} + \affPart{f}$ where $\linPart{f} \in \matrSet{\mathbb{K}}{n}{m}$
and $\affPart{f} \in \vectSet{\mathbb{K}}{m}$.
An \emph{affine subspace} $A$ of $\mathbb{K}^n$ is a subset
of $\mathbb{K}^n$ of the form $A = p + V$ with $p \in A$ and $V$ a vector subspace of $\mathbb{K}^n$.
They are stable by affine combinations (linear combinations with coefficients adding up to 1).
For all $E \subseteq \mathbb{K}^n$, $\affSpan{E}$ will denote the smallest
affine subspace of $\mathbb{K}^n$ containing $E$.


\textbf{Weighted Automata.}
Let $\Sigma$ be a finite alphabet and $(\mathbb{K},+,\cdot)$ be a field.

\begin{definition}[Weighted Automaton]
  A \emph{Weighted Automaton} (\WA for short) of dimension $\dWA$,
  on $\Sigma$ over $\mathbb{K}$, is a triple $\mathcal{R} = (u,\mu,v)$,
  where $u \in \vectSet{\mathbb{K}}{\dWA}$, $v \in \matrSet{\mathbb{K}}{\dWA}{1}$
  and $\mu \colon \Sigma^* \to \sqmatrSet{\mathbb{K}}{\dWA}$ is a monoid morphism.
  We will call $u$ and $v$ the \emph{initial} and \emph{terminal} vectors respectively and
   $\mu(a)$, for $a \in \Sigma$, will be called a \emph{transition matrix}.
  A \WA realizes a \emph{formal power series} over $\Sigma^*$ with coefficients in $\mathbb{K}$
  (a function from $\Sigma^*$ to $\mathbb{K}$) defined, for all $w \in \Sigma^*$,
  by $ \left\llbracket \mathcal{R} \right\rrbracket (w) = u \mu(w) v$.
  Any series that can be realized by a \WA will be called \emph{rational}.
\end{definition}

\input{figures/fig-WA}
\WA also have a representation in terms of finite-state automata,
in which transitions are equipped with weights. We then say that a \WA
is sequential (resp. unambiguous) when its underlying automaton is.
Formally, we say that a \WA $\mathcal{R} = (u,\mu,v)$ is \emph{sequential} when
$u$ has a single non-zero entry and, for each letter $a$, and each index $i$,
there is at most one index $j$ such that  $\mu(a)_{i,j} \neq 0$.

\begin{example}
  \label{ex:WA}
  We consider the \WA, on the alphabet $\{a\}$ and over the field of real
  numbers, $\mathcal{R} =(u,\mu,v)$ with $u=(1, 0)$, $v = (1, 0)^{t}$, and
  $\mu(a) = \begin{pmatrix}
              0 & 2 \\
              2 & 0
  \end{pmatrix}$.
  One can verify that the function realized by this \WA maps the
  word $a^n$ to $2^n$ if $n$ is even, and to $0$ otherwise.
  It can be represented graphically by the automaton depicted on Figure~\ref{fig:WA}.
\end{example}

A $\WA$ realizing a rational series $f$ is said to be \emph{minimal}
if its dimension is minimal among all the $\WA$ realizing $f$.
We also have the following characterization of minimal \WA
(see~\cite[Proposition 4.8 (Chapter III)]{Sakarovitch09}):
\begin{proposition}
  \label{prop:caracMinRep}
  Let $\mathcal{R} = (u,\mu,v)$ be a $\dWA$-dimensional \WA
  and let $\lReachSet{\mathcal{R}} = u \mu(\Sigma^*) = \left\{ u \mu(w) \,\middle|\, w \in \Sigma^* \right\}$
  be its (left) \emph{reachability set} and $\rReachSet{\mathcal{R}} = \mu(\Sigma^*) v$
  be its right reachability set.

  $\mathcal{R}$ is a minimal \WA if and only if
  $\linSpan{\lReachSet{\mathcal{R}}} = \vectSet{\mathbb{K}}{\dWA}$
  and $\linSpan{\rReachSet{\mathcal{R}}} = \matrSet{\mathbb{K}}{\dWA}{1}$.
\end{proposition}


\textbf{Expressions, substitutions and Cost Register Automata.}
For a field $(\mathbb{K},+,\cdot)$ and a finite set of variables $\varSet$
disjoint from $\mathbb{K}$,
let $\expr{\varSet}$ denote the set of expressions generated by the grammar
$e \Coloneqq k \,|\, X \,|\, e + e \,|\, e \cdot e$, where $k \in \mathbb{K}$
and $X \in \varSet$.
A \emph{substitution} over $\varSet$ is a map $s \colon \varSet \to \expr{\varSet}$.
It can be extended to a map $\expr{\varSet} \to \expr{\varSet}$ by substituting each variable $X$ in the
expression given as an input by $s(X)$.
By identifying $s$ with its extension, we can compose substitutions.
We call \emph{valuations} the substitutions of the form $v \colon \varSet \to \mathbb{K}$.
The set of substitutions over $\varSet$ will be denoted by $\subs{\varSet}$
and the set of valuations $\valuations{\varSet}$.

\begin{definition}[Cost Register Automaton]
  A \emph{cost register automaton} ($\CRA$ for short), on the alphabet $\Sigma$ over the field $\mathbb{K}$,
  is a tuple $\mathcal{A} = (Q, q_0, \varSet, v_0, \outFctCRA, \delta)$
  where $Q$ is a finite set of \emph{states}, $q_0 \in Q$ is the initial state,
  $\varSet$ is a finite set of registers (variables),
  $v_0 \in \valuations{\varSet}$ is the registers' initial valuation,
  $\outFctCRA \colon Q \to \expr{\varSet}$ is the output function,
  and $\delta \colon Q \times \Sigma \to Q \times \subs{\varSet}$ is the transition function.
  We will denote by $\delta_Q \coloneqq \proj{Q} \circ \delta$ the transition function of the underlying
  automaton of the $\CRA$ and $\delta_{\varSet} \coloneqq \proj{\subs{\varSet}} \circ \delta$
  its register update function.

  $\mathcal{A}$ computes a function $\llbracket \mathcal{A} \rrbracket \colon \Sigma^* \to \mathbb{K}$
  defined as follows: the configurations of $\mathcal{A}$ are pairs $(q,v) \in Q \times \valuations{
    \varSet}$.
  The run of $\mathcal{A}$ on a word $w = a_1 \dots a_n \in \Sigma^*$ is the sequence of
  configurations $(q_i,v_i)_{i \in \intInterv{0}{n}}$
  where, $q_0$ is the initial state, $v_0$ is the initial valuation and,
  for all $i \in \intInterv{1}{n}$, $q_i = \delta_Q (q_{i-1},a_i)$
  and $v_i = v_{i-1} \circ \delta_{\varSet}(q_{i-1},a_i)$.
  We then define $\llbracket \mathcal{A} \rrbracket (w) = v_n (\outFctCRA(q_n))$.

  $\delta$ can be extended to words by setting, for all $q \in Q$,
  $\delta (q,\epsilon) = (q , id_{\varSet})$, where $id_{\varSet}$
  is the substitution such that $id_{\varSet}(X) = X$ for all $X \in \varSet$,
  and, for all $a \in \Sigma$ and $w \in \Sigma^*$,
  $\delta_Q (q,aw) = \delta_Q(\delta_Q(q,a),w)$
  and $\delta_{\varSet} (q,aw) = \delta_{\varSet}(q,a)
  \circ \delta_{\varSet}(\delta_Q(q,a),w)$.
  We then have
  \[\llbracket \mathcal{A} \rrbracket (w)
  = v_0 \circ \delta_{\varSet} (q_0, w) (\outFctCRA(\delta_Q(q_0,w)))\]

\end{definition}


\begin{example}[Example~\ref{ex:WA} continued]
  \label{ex:CRA}
  Two \CRA are depicted on Figure~\ref{fig:CRA}.
  They are both on the alphabet
  $\{a\}$ and over the field of real numbers, and both realize the same function as the $\WA$ considered in
  Example~\ref{ex:WA}.
\end{example}

\input{figures/fig-CRA}

An expression is called \emph{linear} if it has the form
$\sum_{i=1}^{\rCRA} \alpha_i X_i$, for some family of $\alpha_i \in \mathbb{K}$ and $X_i \in \varSet$,
and if it has the form $\sum_{i=1}^{\rCRA} \alpha_i X_i + \beta$, for some $\beta \in \mathbb{K}$,
it is called \emph{affine}.
We will denote by $\linExpr{\varSet}$ (\resp $\affExpr{\varSet}$) the set of linear
(\resp affine) expressions.

\begin{definition}[Linear/Affine \CRA]
  A $\CRA$ $\mathcal{A} = (Q, q_0, \varSet, \allowbreak v_0, \outFctCRA, \delta)$ is called \emph{linear}
  if, $\delta_{\varSet}(q,a)(X) \in \linExpr{\varSet}$ and $\outFctCRA(q)\in \linExpr{\varSet}$,
  for all $q \in Q, a \in \Sigma$ and $X \in \varSet$,
  and if $\delta_{\varSet}(q,a)(X) \in \affExpr{\varSet}$ and $\outFctCRA(q)\in \affExpr{\varSet}$,
  the \CRA is called \emph{affine}.
\end{definition}

Linear \CRA are a particular case of affine \CRA and, given an affine \CRA
it is always possible to define an equivalent linear \CRA using one more register
with a constant value of $1$ to realize affine register updates in a linear way, thus :
\begin{remark}
  Linear and affine \CRA have the same expressiveness.
\end{remark}
The added cost of a register will however become relevant when we will consider
minimization problems in the next sections.

Observe that we can assume that $\varSet=\left\{X_1, \dots, X_\rCRA \right\}$ is ordered,
and identify any linear expression $e =  \sum_{i=1}^{\rCRA} \alpha_i X_i$
(with the $\alpha_i$ not present in the expression assumed to be 0)
with the linear form $\expToMap{e} \colon \mathbb{K}^\rCRA \to \mathbb{K}$
defined by the column vector $(\alpha_1, \dots, \alpha_\rCRA)^t$.
We can then identify any linear substitution $s \colon \varSet \to \linExpr{\varSet}$
with the linear map $\expToMap{s} \colon \mathbb{K}^\rCRA \to \mathbb{K}^\rCRA$
defined by the block matrix $(\expToMap{s(X_1)} | \cdots | \expToMap{s(X_\rCRA)})$,
and we can identify any valuation $v \colon \varSet \to \mathbb{K}$ with the vector
$\expToMap{v}=(v(X_1), \cdots, v(X_\rCRA))$ of the vector space $\mathbb{K}^\rCRA$.

In the following, we will drop the underline notation and make the identifications implicitly.

Thanks to these observations, the registers of a linear
\CRA and their updates can be characterized by the values of the vector
associated with $\noUnderline{v_0}$, and the linear maps associated with the
$\noUnderline{\delta_{\mathcal{X}}(q,a)}$ and $\noUnderline{\outFctCRA(q)}$,
for all $q \in Q$ and $a \in \Sigma$, and we can check that
\[
  \llbracket \mathcal{A} \rrbracket (w) = \noUnderline{v_0}\ \noUnderline{\delta_{\varSet}(q_0,w)}\
  \noUnderline{\outFctCRA(\delta_Q(q_0,w))}
\]

We can also identify affine expressions with affine forms and affine substitutions with affine maps
to simplify dealing with affine \CRA.
We will define and use these identifications in Appendix~\ref{apx:proofChar}.

\begin{proposition}[\cite{AlurDDRY13}]
  \label{prop:linRepEquivCRA1Stt}
  There is a bijection between \WA and linear \CRA with a single state.
\end{proposition}

Given a \WA, one can build an equivalent \CRA with as many registers as states of the \WA:
for each letter $a$, the transition matrix $\mu(a)$ can be interpreted as a (linear) substitution,
associated with the self-loop of label $a$.
The converse easily follows from the previous observations when the \CRA has a single state.

\begin{example}[Example~\ref{ex:WA} continued]
  The \CRA depicted on the left of Figure~\ref{fig:CRA} is obtained by the translation of
  the \WA of Figure~\ref{fig:WA} into \CRA with a single state.
\end{example}

\begin{remark}\label{rk:seq}Sequential \WA are exactly linear \CRA with a single register.
\end{remark}

Indeed, both sequential \WA and linear \CRA with only one register are
deterministic finite automata that can also store a single value updated at each
transition using only products.
They can then be identified.