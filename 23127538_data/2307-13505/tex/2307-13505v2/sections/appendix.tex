\section{Complements to Section~\ref{sec:characterization}}

\subsection{Examples of Subsection~\ref{subsec:Zariski}}

\noindent
\textbf{Complement to Remark~\ref{rk:lin_not_alg}}

Consider a \WA
over a one-letter alphabet $\{a\}$ with $u = (1, 1)$ and $\mu(a) =
\begin{pmatrix}
  2 & 0 \\
  0 & 4
\end{pmatrix} $. One can verify that the strongest algebraic invariant is described by a polynomial
of degree $2$ (the second coordinate is the square of the first one),
hence is not linear.


\noindent
\textbf{Complement to Example~\ref{ex:sumPow2}}

A graphical representation of the reachability set of the WA described in
Example~\ref{ex:sumPow2} is depicted in Figure~\ref{fig:reachSet}.

All the reachable vectors are on the affine line $y = x+1$ so the affine hull is one dimensional
but, since the line does not cross the origin, the linear hull is two dimensional.

\input{figures/fig-reachSet}

\subsection{Proofs of the building blocks of Theorem~\ref{thm:mainThm}} \label{apx:proofChar}
We will prove Lemma~\ref{lem:leftRightMin} (wich yields Proposition~\ref{prop:dimLHMin})
and Propositions~\ref{prop:linRepToCRA} and~\ref{prop:CRATolinRep} in the affine setting
(\ie using Z-affine sets and affine \CRA) as it is more general,
and all the results for the linear setting follow directly from the constructions of this section.

To simplify dealing with affine \CRA, we make the same observations we made in Section~\ref{sec:prelim}
about linear expressions (bringing back the underline notation to avoid confusion):
for a finite set of variables $\varSet=\left\{X_1, \dots, X_\rCRA \right\}$ that we can assume to be ordered,
we identify any affine expression
$e = \sum_{i=1}^{\rCRA} \alpha_i X_i + \beta$
with the affine form $\expToMap{e} \colon \mathbb{K}^\rCRA \to \mathbb{K}$
defined by $\expToMap{e}(u) = u \linPart{\expToMap{e}} + \affPart{\expToMap{e}}$
with $\linPart{\expToMap{e}} = (\alpha_1, \dots, \alpha_\rCRA)^t$ and $\affPart{\expToMap{e}} = \beta$.
We can then identify any affine substitution $s \colon \varSet \to \affExpr{\varSet}$
with the affine map $\expToMap{s} \colon \mathbb{K}^\rCRA \to \mathbb{K}^\rCRA$
defined by $\expToMap{s}(u) = u \linPart{\expToMap{s}} + \affPart{\expToMap{s}}$
with $\linPart{\expToMap{s}} = \linPart{(\expToMap{s(X_1)}} | \cdots| \linPart{\expToMap{s(X_\rCRA)}})$
and $\affPart{\expToMap{s}} = (\affPart{\expToMap{s(X_1)}}, \cdots, \affPart{\expToMap{s(X_\rCRA)}})$,
and we can identify any valuation $v \colon \varSet \to \mathbb{K}$ with the point
$\expToMap{v}=(v(X_1), \cdots, v(X_\rCRA))$ of the affine space $\mathbb{K}^\rCRA$.

We now drop the underline notation and observe that the registers of a linear (\resp affine)
\CRA and their updates can be characterized by the values of the vector (\resp point)
associated with $\noUnderline{v_0}$, and the linear (\resp affine) maps associated with the
$\noUnderline{\delta_{\mathcal{X}}(q,a)}$ and $\noUnderline{\outFctCRA(q)}$,
for all $q \in Q$ and $a \in \Sigma$, and we can check that
\[
  \llbracket \mathcal{A} \rrbracket (w) = \noUnderline{\outFctCRA(\delta_Q(q_0,w))}
  \left(\noUnderline{\delta_{\varSet}(q_0,w)} \left(\noUnderline{v_0}\,\right)\right)
\]

\subsubsection{Proof of Lemma~\ref{lem:leftRightMin}}

In the following, for all $\dWA \in \mathbb{N}$,
let $\canonBasis{\dWA} = \left\{ e_1, \dots, e_\dWA \right\}$
denote the canonical basis of $\mathbb{K}^\dWA$.
For two bases $B$ and $B'$ of the same vector space,
let $\chgBaseMatr{B}{B'}$ denote the change of basis matrix from $B$ to $B'$
(whose lines are the coordinates of the vectors of $B'$ in the basis $B$).
And finally, for two integers $i$ and $j$, let $I_i$ denote the identity matrix of size $i$
and let $\resizIdMatr{i}{j}$ denote the $i$ by $j$ matrix $(I_i \ |\ 0)$ if $i \leq j$
and $\resizIdMatr{j}{i}^t$ otherwise.

\begin{claim}
%  \nl{j'appellerai ça Claim plutot que remarque}
  \label{clm:chgBase}
  If $V$ is an $r$-dimensional vector subspace of $\mathbb{K}^\dWA$ and
  $B$ is a basis of $\mathbb{K}^\dWA$ whose first $r$ vectors form a basis of $V$,
  then, for all $v \in V$, since the $\dWA-r$ last entries of the vector
  $v \chgBaseMatr{\canonBasis{\dWA}}{B}$
  are all zeros, we note that
  $v \chgBaseMatr{\canonBasis{\dWA}}{B} \resizIdMatr{\dWA}{r} \resizIdMatr{r}{\dWA}
  \chgBaseMatr{B}{\canonBasis{\dWA}} = v$.
\end{claim}

\begin{proof}[Proof of Lemma \ref{lem:leftRightMin}]
  Let us first prove the lemma for the left reachability set.
  Let $\mathcal{R} = (u,\mu,v)$, let $\dWA$ be the dimension of $\mathcal{R}$ and
  let $B$ be a basis of $\vectSet{\mathbb{K}}{\dWA}$ obtained by completing a basis
  of $\linSpan{\lReachSet{\mathcal{R}}}$ with arbitrary vectors.

  We define $\mathcal{R}'$ as $(u',\mu',v')$ where, for all $a \in \Sigma$,
  \begin{gather*}
    u' = u \chgBaseMatr{\canonBasis{\dWA}}{B} \resizIdMatr{\dWA}{r} \quad
    v' = \resizIdMatr{r}{\dWA} \chgBaseMatr{B}{\canonBasis{\dWA}} v \quad
    \mu'(a) = \resizIdMatr{r}{\dWA} \chgBaseMatr{B}{\canonBasis{\dWA}} \mu(a)
    \chgBaseMatr{\canonBasis{\dWA}}{B} \resizIdMatr{\dWA}{r}
  \end{gather*}

  We can show by induction, thanks to Claim~\ref{clm:chgBase}, that
  $\lReachSet{\mathcal{R}'} = \lReachSet{\mathcal{R}}\chgBaseMatr{\canonBasis{\dWA}}{B} \resizIdMatr{\dWA}{
    r}$,
  and then $\llbracket \mathcal{R}' \rrbracket = \llbracket \mathcal{R} \rrbracket$.
%  and, since $\left\{ b_1, \dots, b_r \right\} \chgBaseMatr{\canonBasis{n}}{B} \resizIdMatr{n}{r}
%  = \left\{ e_1, \dots, e_r \right\} \resizIdMatr{n}{r} = \canonBasis{r}$,
%  then $\linSpan{\lReachSet{\mathcal{R}}_m} = \mathbb{K}^r$.

  It remains to show that, if $\mathcal{R}$ has a Z-affine invariant $S_{\mathcal{R}}$
  of length $\lInv$ and dimension $\dInv$, then $\mathcal{R}'$ has a Z-affine invariant
  $S_{\mathcal{R}'}$ of length $\leq \lInv$ and dimension $\leq \dInv$.
  Note that we can assume that $S_{\mathcal{R}} \subseteq \linSpan{\lReachSet{\mathcal{R}}}$,
  since $S_{\mathcal{R}} \cap \linSpan{\lReachSet{\mathcal{R}}}$ is also a Z-affine
  invariant of $\mathcal{R}$, with a length $\leq \lInv$ and a dimension $\leq \dInv$.

  Let us take $S_{\mathcal{R}'} = S_{\mathcal{R}} \chgBaseMatr{\canonBasis{\dWA}}{B} \resizIdMatr{\dWA}{r}$
  and show that it has the right properties.
  First, it is clear that $S_{\mathcal{R}'}$ is a Z-affine invariant of $\mathcal{R}'$,
  since $u \in S_{\mathcal{R}}$ then $u' = u \chgBaseMatr{\canonBasis{\dWA}}{B} \resizIdMatr{\dWA}{r} \in
  S_{\mathcal{R}'}$
  and, for all $w' \in S_{\mathcal{R}}'$ and $a \in \Sigma$,
  there exists a $w \in S_{\mathcal{R}}$ such that
  $w' = w \chgBaseMatr{\canonBasis{\dWA}}{B} \resizIdMatr{\dWA}{r}$,
  thus, since $S_{\mathcal{R}} \subseteq \linSpan{\lReachSet{\mathcal{R}}}$
  and thanks to Claim~\ref{clm:chgBase}:
  \begin{align*}
%    \label{eq:invar}
    w' \mu'(a) & = w \chgBaseMatr{\canonBasis{\dWA}}{B} \resizIdMatr{\dWA}{r}
    \resizIdMatr{r}{\dWA} \chgBaseMatr{B}{\canonBasis{\dWA}} \mu(a)  \chgBaseMatr{\canonBasis{\dWA}}{B}
    \resizIdMatr{\dWA}{r} \\
    & = w \mu(a) \chgBaseMatr{\canonBasis{\dWA}}{B} \resizIdMatr{\dWA}{r} \in S_{\mathcal{R}}'
  \end{align*}
  and the image of a Z-affine set by a linear map is still a Z-affine set.
  Moreover, the irreducible components of $S_{\mathcal{R}'}$ are images of
  the irreducible components of $S_{\mathcal{R}}$ by a linear map.
  Thus $\dim(S_{\mathcal{R}'}) \leq \dim(S_{\mathcal{R}})$ and
  $\textup{\textsf{length}}(S_{\mathcal{R}'}) \leq \textup{\textsf{length}}(S_{\mathcal{R}})$.

  The case of the right reachability set is proven similarly,
  using a basis of $\linSpan{\rReachSet{\mathcal{R}}}$.
  Let $C$ be a basis of $\vectSet{\mathbb{K}}{\dWA}$ obtained by completing a basis
  of $\linSpan{\rReachSet{\mathcal{R}}}^t$ with arbitrary vectors.

  We define $\mathcal{R}''$ as $(u'',\mu'',v'')$ where, for all $a \in \Sigma$,
  \begin{gather*}
    u'' = u \chgBaseMatr{C}{\canonBasis{\dWA}}^t \resizIdMatr{\dWA}{r} \quad
    v'' = \resizIdMatr{r}{\dWA} \chgBaseMatr{\canonBasis{\dWA}}{C}^t v \quad
    \mu''(a) = \resizIdMatr{r}{\dWA} \chgBaseMatr{\canonBasis{\dWA}}{C}^t \mu(a)
    \chgBaseMatr{C}{\canonBasis{\dWA}}^t \resizIdMatr{\dWA}{r}
  \end{gather*}



  We can show by induction, thanks to Claim~\ref{clm:chgBase}, that
  $\rReachSet{\mathcal{R}'} = \resizIdMatr{r}{\dWA} \chgBaseMatr{\canonBasis{\dWA}}{C}^t
  \rReachSet{\mathcal{R}}$,
  and then $\llbracket \mathcal{R}' \rrbracket = \llbracket \mathcal{R} \rrbracket$.

  Like in the previous case, let $S_{\mathcal{R}}$ be a Z-affine invariant of $\mathcal{R}$,
  of length $\lInv$ and dimension $\dInv$ and let
  $S_{\mathcal{R}''} = S_{\mathcal{R}} \chgBaseMatr{C}{\canonBasis{\dWA}}^t \resizIdMatr{\dWA}{r}$.
  Obviously, $u'' \in S_{\mathcal{R}''}$ and,
  if $w'' = w \chgBaseMatr{C}{\canonBasis{\dWA}}^t \resizIdMatr{\dWA}{r} \in S_{\mathcal{R}''}$,
  then we can show that, for all $a \in \Sigma$, $w'' \mu''(a) \in S_{\mathcal{R}''}$
  by observing that $\chgBaseMatr{\canonBasis{\dWA}}{C}^t \mu(a)
  \chgBaseMatr{C}{\canonBasis{\dWA}}^t \resizIdMatr{\dWA}{r}$
  is a $\dWA$ by $r$ matrix whose last $\dWA-r$ rows are all null.
  Thus $ \resizIdMatr{\dWA}{r} \resizIdMatr{r}{\dWA} \chgBaseMatr{\canonBasis{\dWA}}{C}^t \mu(a)
  \chgBaseMatr{C}{\canonBasis{\dWA}}^t \resizIdMatr{\dWA}{r}
  = \chgBaseMatr{\canonBasis{\dWA}}{C}^t \mu(a) \chgBaseMatr{C}{\canonBasis{\dWA}}^t \resizIdMatr{\dWA}{r}$.


%  The case of the right reachability set is proven similarly,
%  using a basis of $\linSpan{\rReachSet{\mathcal{R}}}$.
%  However, care must be taken as the arguments differ slightly from the previous case.
%  The key differences being that the equivalence between $\mathcal{R}$ and $\mathcal{R}'$
%  is shown, using Claim~\ref{clm:chgBase}, on the right reachability set instead of the left one
%  and~\eqref{eq:invar} holds thanks to the form of the matrices after the
%  change of basis instead of Claim~\ref{clm:chgBase}.\nl{je pense que ça peut être bien de mettre la preuve
%  dans l'autre sens aussi, quitte à la mettre en annexe ensuite}

  Note that the construction only uses linear maps and, thus, still holds for Z-linear invariants.
%  \nl{je pense que c'est plus clair si dans la preuve on ne parle que de Z-affine, et à la fin on
%    remarque que la linearité est préservée.}
\end{proof}

\subsubsection{Proof of Proposition~\ref{prop:linRepToCRA}}

\begin{proof}
  Let $\mathcal{R} = (u,\mu,v)$, let $\dWA$ be the dimension of $\mathcal{R}$
  and let $W_1, \dots, W_\lInv$ be the irreducible components of a Z-affine invariant of $\mathcal{R}$
  of length $\lInv$ and dimension $\dInv$.
  We assume, without loss of generality, that $u \in W_1$.

  For all $i \in \intInterv{1}{\lInv}$, let $W_i = p_i + V_i$ with $p_i \in \mathbb{K}^\dWA$
  and $V_i$ a vector subspace of $\mathbb{K}^\dWA$ and let $B_i$ be a basis of $\mathbb{K}^\dWA$
  obtained by completing a basis of $V_i$ with arbitrary vectors.

  We define $\mathcal{A}$ as $(Q, q_0, \varSet, v_0, \outFctCRA, \delta)$ where:
  \begin{itemize}
    \item $Q = \intInterv{1}{\sCRA}$ and $q_0 = 1$.
    \item $\varSet = \left\{ X_1, \dots, X_\rCRA \right\}$ and
    $\noUnderline{v_0} = (u-p_{q_0}) \chgBaseMatr{\canonBasis{\dWA}}{B_{q_0}} \resizIdMatr{\dWA}{\rCRA}$
    \item for all $q \in Q$, $x \in \mathbb{K}^\rCRA$,
    $\noUnderline{\outFctCRA(q)}(x) = \left( p_q + x
    \resizIdMatr{\rCRA}{\dWA} \chgBaseMatr{B_q}{E_\dWA} \right)v$.
    \item for all $q \in Q$ and $a \in \Sigma$, let $q' \in
    \left\{ p \in \llbracket 1,\sCRA \rrbracket \,\middle|\, W_q \mu(a) \subseteq W_p \right\}$
    (chosen arbitrarily).
    $\delta(q,a)$ will be defined by $\delta_Q(q,a) = q'$ and, for all $x \in \mathbb{K}^\rCRA$,
    \[\noUnderline{\delta_{\mathcal{X}}(q,a)}(x) =
    \left( \left( p_q + x \resizIdMatr{\rCRA}{\dWA}\chgBaseMatr{B_q}{E_\dWA} \right) \mu(a) - p_{q'}\right)
    \chgBaseMatr{E_\dWA}{B_{q'}} \resizIdMatr{\dWA}{\rCRA}\]
  \end{itemize}

  We can show by induction, using Claim~\ref{clm:chgBase}, that, for all $w \in \Sigma^*$,
  \[\noUnderline{\delta_{\mathcal{X}}(q_0,w)} \left( \noUnderline{v_0} \right) =
  \left( u \mu(w) - p_{\delta_Q(q_0,w)} \right)
  \chgBaseMatr{E_\dWA}{B_{\delta_Q(q_0,w)}} \resizIdMatr{\dWA}{\rCRA}\]

  Thus, for all $w \in \Sigma^*$,
  \[\llbracket \mathcal{A} \rrbracket(w) = \noUnderline{\outFctCRA(\delta_Q(q_0,w))}
  \left(\noUnderline{\delta_{\varSet}(q_0,w)} \left(\noUnderline{v_0}\,\right)\right) \allowbreak
  = \llbracket \mathcal{R} \rrbracket (w)\]

  The same construction can be applied to obtain the linear version of the proposition
  (it is the case where $p_i = 0$ for all $i \in \intInterv{1}{n}$).
\end{proof}

\subsubsection{Proof of Proposition~\ref{prop:CRATolinRep}}

\begin{proof}
  Let's assume, without loss of generality, that
  $\mathcal{A} = (Q, q_0, \allowbreak \varSet,  v_0, \outFctCRA, \delta)$
  is an affine \CRA where $Q = \intInterv{1}{\sCRA}$, $q_0 = 1$,
  $\mathcal{X} = \left\{ X_1, \dots, X_\rCRA \right\}$.

  We define $\mathcal{R}$ as $(u,\mu,v)$, where:
  \begin{itemize}
    \item $u = (\noUnderline{v_0}, 1 , 0, \dots, 0) \in \vectSet{\mathbb{K}}{\sCRA(\rCRA+1)}$
    \item $v = \left(\begin{array}{c}
                       \outFctCRA_1 \\
                       \vdots       \\
                       \outFctCRA_n
    \end{array}\right) \in \matrSet{\mathbb{K}}{\sCRA(\rCRA+1)}{1}$.
    where, for all $i \in \intInterv{1}{\sCRA}$,
    $\outFctCRA_i = \left(\begin{array}{c}
                            \linPart{\noUnderline{\outFctCRA(i)}} \\
                            \affPart{\noUnderline{\outFctCRA(i)}}
    \end{array}\right)$.
    \item for all $a \in \Sigma$, $\mu (a) =
    \left( \begin{array}{c|c|c}
             \delta_{1,1}(a)     & \dots  & \delta_{1,\sCRA}(a)     \\
             \hline
             \vdots              & \ddots & \vdots                  \\
             \hline
             \delta_{\sCRA,1}(a) & \dots  & \delta_{\sCRA,\sCRA}(a)
    \end{array} \right) $
    where, for all $i,j \in \intInterv{1}{\sCRA}$, $\delta_{i,j}(a) = \left(
    \begin{array}{c|c}
      \linPart{\noUnderline{\delta_{\mathcal{X}}(i,a)}} & 0 \\[5pt]
      \hline
      \affPart{\noUnderline{\delta_{\mathcal{X}}(i,a)}} & 1
    \end{array} \right)\in \sqmatrSet{\mathbb{K}}{\rCRA+1}$ if $\delta_{Q}(i,a) = j$ and 0 otherwise.
  \end{itemize}

  We can show by induction that the definition of the $\delta_{i,j}$
  extends to words and thus, for all $w \in \Sigma^*$,
  \begin{align*}
    \llbracket \mathcal{R} \rrbracket (w)
    &= \left( \noUnderline{v_0}\ \linPart{\noUnderline{\delta_{\mathcal{X}}(i,w)}}
    + \affPart{\noUnderline{\delta_{\mathcal{X}}(i,w)}} \right)
    \linPart{\noUnderline{\outFctCRA(\delta_Q(q_0,w))}}
    + \affPart{\noUnderline{\outFctCRA(\delta_Q(q_0,w))}}\\
    &= \noUnderline{\outFctCRA(\delta_Q(q_0,w))}
    \left(\noUnderline{\delta_{\varSet}(q_0,w)} \left(\noUnderline{v_0}\,\right)\right)\\
    \llbracket \mathcal{R} \rrbracket (w) &= \llbracket \mathcal{A} \rrbracket (w)
  \end{align*}

  Let $S = \bigcup_{i=1}^{\sCRA} \psi_i(\mathbb{K}^\rCRA)$ where, for all $i \in \intInterv{1}{\sCRA}$,
  $\psi_i : \mathbb{K}^\rCRA \to \mathbb{K}^{\sCRA(\rCRA+1)}$
  maps every vector $v \in \mathbb{K}^\rCRA$ to the vector of $\mathbb{K}^{\sCRA(\rCRA+1)}$
  that has $(v,1)$ as its $i$-th ``block'' of size $\rCRA+1$ and zeros everywhere else.

  We show that $S$ is the desired Z-affine invariant of $\mathcal{R}$ :
  First, $S$ is an invariant of $\mathcal{R}$, since
  $u = \psi_1(\noUnderline{v_0}) \in S$ and
  $\psi_i(x) \mu(a) = \psi_{\delta_Q (i,a)}(\delta_{\varSet}(i,a)(x)) \in S$,
  for all $\psi_i(x) \in S$ and $a \in \Sigma$.
  Then, since the $\psi_i$ are affine maps, $S$ is a Z-affine set,
  whose irreducible components are the $\psi_i(\mathbb{K}^\rCRA)$, which have a dimension
  $\dInv$ as required.

  Observe that the proposition is also proved in the linear setting,
  since applying this construction to a linear \CRA yields a \WA with the desired Z-linear invariant.
\end{proof}


\section{Complements to Section~\ref{sec:algos}}

\subsection{Proof of Lemma~\ref{lem:rep}}

\begin{proof}
  Let $\mathcal R=(u,\mu,v)$ be a \WA over alphabet $\Sigma$.
  Let $I$ be a Z-affine invariant of $\mathcal R$ of length $\lInv$ and dimension $\dInv$, with irreducible
  components $A_1,\ldots, A_\lInv$.

  We will define sets $S_1,\ldots, S_\lInv$ such that, for all $i\in \set{1,\cdots,\lInv}$,
  $\affSpan{\set{u\mu(w)|\ w\in S_i}}\subseteq A_i$, representing a Z-affine set $J$.
  Given a word $w$, we will write $u_w=u\mu(w)$.
  Since $I$ is an invariant, there is an index $i$ such that $u_\epsilon=u\in A_i$.
  Thus, the set $S_i$ is initialized as $\set{\epsilon}$ and all other sets are initially empty.

  If $J$ is not an invariant, this means there exist $i\in \set{1,\ldots, \lInv}$,  $w\in S_i$ and
  $a\in\Sigma$ such that $u_{wa}\notin J$.
  However, we know that since $I$ is an invariant, it must at least contain the reachability set of
  $\mathcal R$ and thus $u_{wa}\in I$.
  Hence, there exists $j$ such that $u_{wa}\in A_j$.
  Thus, we update $S_j\coloneqq S_j\cup \set{w}$.
  Note that we still have that $\set{u_s|\ s\in S_j}\subseteq A_j$ thus the invariant\footnote{We heard you
  liked invariants, so we put invariants in your invariants.} $J\subseteq I$ is preserved.

  A first observation is that each time we add a new vector to the representation of $J$, the dimension of
  one of the components increases by $1$, hence this can happen at most $(\dInv+1)\lInv-1$ times (assuming the
  dimension of the empty set is $-1$). Similarly, each time this happens, the maximum length of a word in
  the representation increases by at most $1$.

  Thus, after at most $(\dInv+1)\lInv-1$ steps, $J$ is an invariant included in $I$, of length $\leq n$
  , with a representation
  of size
  at most $O(\dInv^2 \lInv^2)$.
\end{proof}

\subsection{Proof of Lemma~\ref{lem:subspaces}}


\begin{proof}
  Let $\mathcal R=(u,\mu,v)$ be a \WA, let $c,k\in \mathbb N$ and
  let $A_1,\ldots, \allowbreak A_{c^{k}+1}\subseteq I_c(\calR)$ be spaces satisfying the assumptions.

  Assume by contradiction that
  $\affSpan{\cup_{i\in \intInterv{1}{c^{k}+1}}A_i}\not\subseteq I_c(\calR)$.
  Then, by definition, there must exist an invariant $I$ of length $\leq c$
  such that $\affSpan{\cup_{i\in \intInterv{1}{c^{k}+1}}A_i}\not\subseteq I$.
  This means that any component of $I$ can contain at most $c^{k-1}$ $A_i$s
  (or else it would contain a $k$-dimensional component included in
  $\affSpan{\cup_{i\in \intInterv{1}{c^{k}+1}}A_i}$, which is $k$-dimensional as well).
  As a consequence, $I$ must have at least $c+1$ components, which yields a contradiction.
\end{proof}

\subsection{Proof of Claim~\ref{claim:reduce}}

\begin{proof}
  Let $\mathcal R=(u,\mu,v)$ be a \WA, of dimension $\dWA$, let $c\in \mathbb N$.
  We show by induction on $k$ that if $A_1,\ldots,A_{c^{k}+1}\subseteq I_c(\calR)$ generates a subspace of
  dimension $\leq k$ then there exist $1\leq i<j\leq c^k+1$ such that
  $\affSpan{A_i\cup A_j}\subseteq I_c(\calR)$, and these indices can be found in time $O(c^{p(d)})$.

  For $k=0$, if two subspaces generate an affine subspace of dimension $0$, it means that $A_1=A_2$, which
  are singletons.
  Thus $\affSpan{A_1\cup A_2}=A_1\subseteq I_c(\calR)$.
  Assume the result holds for some $k$, let us show it holds for $k+1$.
  Let $A_1,\ldots,A_{c^{k+1}+1}\subseteq I_c(\calR)$ be subspaces generating a space
  of dimension $\leq k+1$.
  We want to find, if it exists, a set $P\subseteq \intInterv{1}{c^{k+1}+1}$ with $|P|= c^{k}+1$, such that
  $\affSpan{\cup_{i\in P}A_i}$ has
  dimension $\leq k$.
  If it exists then we use the induction assumption.
  Otherwise, Lemma~\ref{lem:subspaces} yields the result.
  We have to show that we can find such a set $P$, if it exists, in the given time constraint.
  Let $Q\subseteq \intInterv{1}{c^{k+1}+1}$, we denote by $A_Q=\affSpan{\cup_{i\in Q}A_i}$ the affine space
  associated with $Q$.
  We say that $Q$ is \emph{minimal} if it is minimal, inclusion-wise, among the sets associated with $A_Q$.
  Note that a minimal set has cardinality at most $d$.
  Thus there are at most $(c^d +1)^{d+1}\leq c^{d^2+2d+1}$ such sets.
  We say that $i\leq c^{k+1}+1$ is \emph{compatible} with $Q$ if $A_i\subseteq A_Q$.
  Given a set $Q$ one can obtain the set of indices compatible with $Q$ in time $c^{k+1}$.
  To find a set $P$ as above, one simply has to enumerate the minimal sets for strict subsets of
  $A_{\intInterv{1}{c^{k+1}+1}}$,
  and check if one of them has a set of compatible indices of size $\geq c^k +1$.
\end{proof}

\subsection{Proof of Theorem~\ref{thm:lengths}}
\label{app:length}

The first item of the statement has already been explained in the core of the paper.

We consider the proof of the simply exponential upper bound in the case where the transition matrices
of the given \WA commute (and in particular, for any \WA on a unary alphabet).
We will show it, using results and ideas from~\cite{BS23} and some basic linear algebra:

\begin{theorem}
  \label{thm:casCommut}
  If $\mathcal{R} = (u,\mu,v)$ is a $\dWA$-dimensional \WA on a finite alphabet $\Sigma$
  such that $\genMono{\mu(\Sigma)}$ is commutative, then the length of $\linHull{\mathcal{R}}$
  is, at most, exponential in $\dWA$.

  Thus, in this case, both the computation of the \LH and
  the resolution of the register minimization problem for linear \CRA can be done in \exptime.
\end{theorem}

The proof of this theorem relies on the two following lemmas:
The first provides a constant we will use to bound the length of the \LH
and characterizes it for minimal \WA on a unary alphabet
(see~\cite[Lemma 13 and Theorem 10]{BS23}):
\begin{lemma}
  \label{lem:powN}
  For all $\dWA \in \mathbb{N}$, there exists an integer $N \in \mathbb{N}$
  such that, for all invertible matrix $A \in \sqmatrSet{\mathbb{K}}{d}$,
  \begin{enumerate}
    \item for all vector subspace $V \subseteq \mathbb{K}^\dWA$,
    if $V A^n = V$ for some $n > 0$ then $V A^N = V$.
    \item \(\linClosure{\genMono{A}} = \bigcup_{i=0}^{N-1} A^i \linSpan{\genMono{A^N}}\).
    %  = \bigcup_{i=0}^{N-1} A^i \linSpan{\left\{ A^{Nj} \,\middle|\, j \in \intInterv{0}{d-1} \right\} }
  \end{enumerate}
\end{lemma}

Note that the value of $N$ depends only on $\mathbb{K}$ and $\dWA$ and is exponential in $\dWA$.

Indeed, in the proof of~\cite[Theorem 10]{BS23} (see also~\cite[Lemma 12]{BS23})
$N$ is taken to be the least common multiple of all $n \in \mathbb{N}$
such that $\phi(n) \leq [\mathbb{K}:\mathbb{Q}] \dWA$,
where $\phi$ is Euler's totient function and $[\mathbb{K}:\mathbb{Q}]$
is the degree of the field extension and a well-known property of $\phi$ is that,
for all $n \geq 1$, $\sqrt {\frac{n}{2}} \leq \phi(n) \leq n-1$.
Thus $N \leq \left( 2 [\mathbb{K}:\mathbb{Q}]^2 \dWA^2\right)!$

The second lemma is a direct consequence of~\cite[Lemma 9]{BS23}:
\begin{lemma}
  \label{lem:uniqueCompoId}
  If $S \subseteq \sqmatrSet{\mathbb{K}}{\dWA}$ is a monoid,
  then $\linClosure{S}$ has a unique irreducible component that contains the identity matrix $I_{\dWA}$.
\end{lemma}

Last, we focus on the third statement of Theorem~\ref{thm:lengths}, showing that
the exponential bound is sharp. This is shown by the following example,
where we define a sequence of \WA $(\mathcal{R}_i)_{i\in \mathbb{N}}$
with a dimension that is polynomial in $i$ and a \LH with a length that is exponential in $i$.
\begin{example}
  For all $i \in \mathbb{N}$, let $\mathbb{P}_{\leq i}$ denote the set of prime numbers up to $i$,
  let $M_p =
  \left( \begin{array}{ccccc}
           0      & 1 & 0      & \dots & 0      \\
           0      & 0 & 1      & \dots & 0      \\
           \vdots &   & \ddots &       & \vdots \\
           0      & 0 & 0      & \dots & 1      \\
           1      & 0 & 0      & \dots & 0
  \end{array} \right) \in \sqmatrSet{\mathbb{K}}{p}$,
  and for all $p \in \mathbb{P}_{\leq i}$
  (it is the permutation matrix associated with the $p$-cycle $(1\, 2\, \dots\, p)$).

  Let $d = \sum_{p \in \mathbb{P}_{\leq i}} p$ and $\mathcal{R}_i = (u_i,\mu_i,v_i)$
  be a $d$-dimensional \WA, on the unary alphabet $\Sigma = \left\{ a \right\} $,
  where $u_i = v_i^t = (1\, 2\, \dots\, d)$ and $\mu_i(a) = \left( \begin{array}{c|c|c|c}
                                                                     M_2    & 0     & \dots  & 0
                                                                     \\
                                                                     \hline
                                                                     0      & M_3   & \dots  & 0
                                                                     \\
                                                                     \hline
                                                                     \vdots &       & \ddots & \vdots
                                                                     \\
                                                                     \hline
                                                                     0      & \dots & 0      & M_
                                                                       {\max(\mathbb{P}_{\leq i})}
  \end{array} \right)$ is a $d$-dimensional block diagonal matrix.

  Observe that the monoid generated by $\mu_i(a)$ is a cyclic group of order
  $n =\textup{\textsf{lcm}}(\mathbb{P}_{\leq i}) = \prod_{p \in \mathbb{P}_{\leq i}} p$.
  Thus, the \LH of $\mathcal{R}_i$ has a length of $n$, since it is the union of $n$ lines.

\end{example}

\subsection{Proof of Theorem~\ref{thm:casCommut}} \label{apx:casCommut}

First, observe that, for all matrices $M \in \sqmatrSet{\mathbb{K}}{\dWA}$,
$(\ker{M^i})_{i\in \mathbb{N}}$ is an increasing sequence of vector subspaces of $\mathbb{K}^\dWA$.
Thus, for all $i \in \mathbb{N}$, $\ker{M^\dWA} = \ker {M^{\dWA+i}}$ and
$\mathbb{K}^\dWA = \im{M^\dWA} \oplus \ker{M^\dWA}$.

Let $r$ be the rank of $M^\dWA$ and $B$ be a basis of $\mathbb{K}^\dWA$
whose first $r$ (\resp last $\dWA-r$) vectors form a basis of $\im{M^\dWA}$ (\resp $\ker{M^\dWA}$).
Then, $\chgBaseMatr{B}{\canonBasis{\dWA}} M^\dWA \chgBaseMatr{\canonBasis{\dWA}}{B}$
is a matrix of the form $\left(
\begin{array}{c|c}
  M' & 0 \\
  \hline
  0  & 0
\end{array} \right)$ with $M' \in \sqmatrSet{\mathbb{K}}{r}$ an invertible matrix.

We can then bound the length of
$\linClosure{\genMono{M}} = \bigcup_{i=0}^{\dWA-1} M^i \linClosure{\genMono{M^\dWA}}$
using the bound for a single invertible matrix of Lemma~\ref{lem:powN}
by observing that $\genMono{M^\dWA} = \chgBaseMatr{\canonBasis{\dWA}}{B}
\genMono{\chgBaseMatr{B}{\canonBasis{\dWA}} M^\dWA \chgBaseMatr{\canonBasis{\dWA}}{B}}
\chgBaseMatr{B}{\canonBasis{\dWA}}$,
and $\genMono{M'}$ is isomorphic (as a semigroup) to
$\genMono{\chgBaseMatr{B}{\canonBasis{\dWA}} M^\dWA \chgBaseMatr{\canonBasis{\dWA}}{B}}$
by an isomorphism which is also a linear map.
Thus, $\textup{\textsf{length}}(\linClosure{\genMono{M^\dWA}}) \leq
\textup{\textsf{length}}(\linClosure{\genMono{M'}})$
which is exponential in $r \leq \dWA$.

This approach can be generalized to an arbitrary number of matrices $M_1, \dots, M_n$,
provided that $\genMono{M_1, \dots, M_n}$ is commutative, as we show next.

If  $M_1, \dots, M_n$ are invertible $\linClosure{\genMono{M_1, \dots, M_n}}$
has a unique irreducible component $W$ containing the identity matrix
(thanks to Lemma~\ref{lem:uniqueCompoId}) and, for all $i \in \intInterv{1}{n}$,
$M_i$ acts by permutation on a finite number of irreducible components of
$\linClosure{\genMono{M_1, \dots, M_n}}$, thus there exists $N_i > 0$
such that $W M_i^{N_i} = W$.
We can take $N_1 = \dots = N_n = N$ given by Lemma~\ref{lem:powN}
(which is exponential in $\dWA$).
Thus, the length of $\linClosure{\genMono{M_1, \dots, M_n}} =
\bigcup_{j_i \in \intInterv{0}{N-1}} M_1^{j_1}M_2^{j_2} \cdots M_n^{j_r} W $
is at most $N^n$.
Like previously, we can use this result to bound the length in the general case.

For all $I \subseteq \intInterv{1}{n}$, let $M_I = \left\{ M_i \,\middle|\, i \in I \right\}$
and let, for all $k \in \mathbb{N}$,
\[\genMono{M_I}^{\leq k} =
\left\{ \prod_{i \in I} M_i^{j_i} \,\middle|\, \forall i \in I, j_i \in \intInterv{0}{k}  \right\}\]
then
\[
  \genMono{M_1, \dots, M_n} = \left(\left(\prod_{i=1}^n M_i \right)^\dWA
  \genMono{M_1, \dots, M_n} \right)
  \bigcup
  \left( \bigcup_{k=1}^{n-1} \left(
  \bigcup_{\substack{I \subseteq \intInterv{1}{n}\\|I| = k}}
  \genMono{M_I}^{\leq \dWA-1} \genMono{M_{\intInterv{1}{n}\setminus I}} \right)\right)
\]
Thus, it suffices to show that
$\linClosure{\left(\prod_{i=1}^n M_i \right)^\dWA \genMono{M_1, \dots, M_n}}$
is of length at most exponential in $\dWA$.

Let $r$ be the rank of $\left( \prod_{i=1}^n M_i \right)^\dWA$ and let $B$ be a basis of $\mathbb{K}^\dWA$
whose first $r$ (\resp last $\dWA-r$) vectors form a basis of
$\im{\left( \prod_{i=1}^n M_i \right)^\dWA}$ (\resp $\ker{\left(\prod_{i=1}^n M_i \right)^\dWA}$).

Then, $\chgBaseMatr{B}{\canonBasis{\dWA}} \left(\prod_{i=1}^n M_i \right)^\dWA \chgBaseMatr{\canonBasis{
  \dWA}}{B} = \left(
\begin{array}{c|c}
  M' & 0 \\
  \hline
  0  & 0
\end{array} \right)$ for some invertible matrix $M' \in \sqmatrSet{\mathbb{K}}{r}$.

For all $i \in \intInterv{1}{n}$, $\im{\left( \prod_{j=0}^n M_j \right)^\dWA} =
\im{\left( \prod_{j=0}^n M_j \right)^\dWA M_i}$.
Thus, $\chgBaseMatr{B}{\canonBasis{\dWA}} M_i \chgBaseMatr{\canonBasis{\dWA}}{B}$
has the form $\left(
\begin{array}{c|c}
  M'_i  & 0      \\
  \hline
  M''_i & M'''_i
\end{array} \right)$
with $M'_i \in \sqmatrSet{\mathbb{K}}{r}$ invertible
because $M'$ is invertible and $\min_{i \in \intInterv{1}{n}}\textsf{rank}(M_i') \geq
\textsf{rank}\left(\left(\prod_{i=1}^n M_i'\right)^\dWA\right)
= \textsf{rank}(M') =r$.

Since
\[
  \linClosure{\left(\prod_{i=1}^n M_i \right)^\dWA \genMono{M_1, \dots, M_n}}
  =
  \chgBaseMatr{\canonBasis{\dWA}}{B}\linClosure{\chgBaseMatr{B}{\canonBasis{\dWA}}
  \left(\prod_{i=1}^n M_i \right)^\dWA \genMono{M_1, \dots, M_n}
  \chgBaseMatr{\canonBasis{\dWA}}{B}}\chgBaseMatr{B}{\canonBasis{\dWA}}
\]

we conclude by noting that  $M' \genMono{M_1', \dots, M_n'}$
is isomorphic (as a semigroup)
to\\  $\chgBaseMatr{B}{\canonBasis{\dWA}}
\left(\prod_{i=1}^n M_i \right)^\dWA \genMono{M_1, \dots, M_n}
\chgBaseMatr{\canonBasis{\dWA}}{B}$ by an isomorphism which is a linear map.

\subsection{Proof of Theorem~\ref{thm:tradeoff}}

The inequalities stated in Theorem~\ref{thm:tradeoff}
are graphically depicted on Figure~\ref{fig:tradeoff}.

\input{figures/fig-tradeoff}

Regarding the proof of the theorem, we know, thanks to
Proposition~\ref{prop:linRepEquivCRA1Stt}, that if one wants to minimize the
number of states of the \CRA, then it is possible to build a \CRA with
a single state, and the minimal number of registers is
the dimension $d'$ of any minimal \WA realizing $f$ (hence $d'\le d$).

On the other side, if one wants to minimize the number of registers, then
Theorem~\ref{thm:mainThm} ensures that the minimal number of
registers is exactly $\textsf{dim}(\linHull{\mathcal{R}})$,
and for this value, the minimal number of states is upper bounded
by $\textsf{length}(\linHull{\mathcal{R}})$.

(This is valid in the affine setting as well thanks to Theorem~\ref{thm:charAff})

\subsection{Details of Remark~\ref{rk:length} } \label{apx:permutMerge}


To illustrate Remark~\ref{rk:length}, we give an example of rational series
which illustrates the expected situation.

\begin{example}
  \label{ex:perm}
  Let $n \in \mathbb{N}$.
  An $n$-dimensional permutation matrix is an $n$ by $n$ matrix that has exactly
  one 1 in each row and each column and zeros everywhere else.
  The set $\permutMatrSet{n}$ of permutation
  matrices together with matrix multiplication form a group of order $n!$
  that is isomorphic to the symmetric group which can be generated using two elements.
  $\linClosure{\permutMatrSet{n}}$ is one-dimensional and has $n!$ irreducible components,
  as it is a union of $n!$ lines.

  It is then possible, using a four-letter alphabet and these permutation matrices,
  to define a $2n$-dimensional \WA with a \LH that is decomposed into the union of
  $n!$ one-dimensional irreducible components and a $(n-1)$-dimensional one,
  such that all the one-dimensional components can be merged together without raising the dimension
  of the invariant.
  We proceed as follows:

  Take two generators of $\permutMatrSet{n}$, \eg let $C_n$ and $T_n$ be the matrices of $\permutMatrSet{n}$
  corresponding to the cycle $(1\, 2\, \dots\, \allowbreak n)$ and the transposition $(1\, 2)$ respectively
  and let $\mathcal{R} = (u,\mu,v)$ be the $2n$-dimensional \WA,
  on $\Sigma = \left\{ a, b, c, d \right\}$, defined by:
  $u = (1\, 2\, \dots\, n\,|\, 0\, \dots\, 0\, 1) \in \vectSet{\mathbb{K}}{2n}$,
  $\mu(a) = \left(
  \begin{array}{c|c}
    C_n & 0   \\
    \hline
    0   & I_n
  \end{array} \right)$, $\mu(b) = \left(
  \begin{array}{c|c}
    T_n & 0   \\
    \hline
    0   & I_n
  \end{array} \right)$, $\mu(c) = \left(
  \begin{array}{c|c}
    0 & 0 \\
    \hline
    0 & M
  \end{array} \right)$ and $\mu(d) = \left(
  \begin{array}{c|c}
    0 & 0  \\
    \hline
    0 & M'
  \end{array} \right)$
  where $M = \left(
  \begin{array}{c|c}
    I_{n-1} & 0 \\
    \hline
    e_1     & 1
  \end{array} \right)$ and $M' = \left(
  \begin{array}{c|c}
    C_{n-1} & 0 \\
    \hline
    0       & 1
  \end{array} \right)$.
  $v \in \matrSet{\mathbb{K}}{n}{1}$ can be arbitrary.

  Note that $\genMono{\mu(a),\mu(b)} = \left\{ \left(
  \begin{array}{c|c}
    P & 0   \\
    \hline
    0 & I_n
  \end{array} \right) \,\middle|\, P \in \permutMatrSet{n} \right\}$ and,
  for all $x \in \vectSet{\mathbb{K}}{n}$
  and $y = (y_1, y_2, \dots, y_{n-1}, 1)  \in \vectSet{\mathbb{K}}{n}$
  \begin{gather*}
  (x \,|\, y)
    \mu(c) = (0 \,|\, (y_1+1), y_2, \dots, y_{n-1}, 1)\\
    (x \,|\, y) \mu(d) = (0 \,|\, y_{n-1}, y_1, \dots, y_{n-2}, 1)
  \end{gather*}

  Then, $\lReachSet{\mathcal{R}} = S_1 \cup S_2$ where
  \begin{gather*}
    S_1 = \left\{ \Bigl( (1\, 2\, \dots\, n) P \,|\, 0\, \dots\, 0\, 1 \Bigr) \,\middle|\,
    P \in \permutMatrSet{n} \right\}\\
    S_2 = \left\{ \Bigl(0\, \dots\, 0 \,|\, l_1\, \dots\, l_{n-1} \, 1 \Bigr)
    \,\middle|\, (l_1\, \dots\, l_{n-1}) \in \mathbb{N}^{n-1} \right\}
  \end{gather*}

  Thus, $\linHull{\mathcal{R}}$ is the union of $\linSpan{S_2}$ and the $n!$ lines,
  going through the origin, directed by the vectors of $S_1$.

  Since $\dim \left( \linSpan{\permutMatrSet{n}} \right) = n-1$
  \ie $\dim \left( \linSpan{S_1} \right) = n-1 = \dim \left( \linSpan{S_2} \right)$,
  we can merge together the one-dimensional irreducible
  components into a single one (which is $\linSpan{S_1}$). We get this way
  a Z-linear invariant
  $I = \linSpan{S_1} \cup \linSpan{S_2}$
  (which is an invariant because for all $a \in \Sigma$ and $i \in \left\{ 1,2 \right\}$,
  there exists $j \in \left\{ 1,2 \right\}$ such that $S_i \mu(a) \subseteq S_j$)
  with the same dimension as $\linHull{\mathcal{R}}$
  but a length of 2, thus reducing the number of states of the corresponding $\CRA$
  to 2 while keeping the same number of registers.
\end{example}  
