






Recall that 
\begin{align}
&T_4 = \sum_{k=1}^K \left( \sum_{h=1}^H \hat{r}_h^k(s_h^k,a_h^k) - V_1^{\pi^k}(s_1^k) \right);\nonumber
\\&T_5 = \sum_{k=1}^K \sum_{h=1}^H \mathbb{V}(\hat{P}_{s_h^k,a_h^k,h},V_{h+1}^k);\nonumber
\\ &T_6 = \sum_{k=1}^K \sum_{h=1}^H \mathbb{V}(P_{s_h^k,a_h^k,h},V_{h+1}^k).\nonumber
 \end{align}
Recall that $B =4000\log^2_3(K)\log(3SAH)\log(\frac{1}{\delta})$.


\subsubsection{Bound of $T_2$}
Recall in \eqref{eq:boundt2}, we show that
\begin{align}
T_2 &\leq \frac{460}{9}\sqrt{2SAH\log_2(K)\log(\frac{1}{\delta})T_5} \nonumber
\\ & \qquad \qquad +4\sqrt{SAH\log_2(K)\log(\frac{1}{\delta})}\sqrt{\sum_{k,h}\left(\hat{\sigma}_h^k(s_h^k,a_h^k)- (\hat{r}_h^k(s_h^k,a_h^k))^2\right)} + \frac{1088}{9}SAH^2\log_2(K)\log(\frac{1}{\delta}).\label{eq:local3}
 \end{align}


Define the variance of $R_h(s,a)$ as $v_h(s,a)$. We then have the following lemma.
\begin{lemma}\label{lemma:bdrv}
With probability $1-4SAHK\delta$,
\begin{align}
\sum_{k,h}\left(\hat{\sigma}_h^k(s_h^k,a_h^k)- (\hat{r}_h^k(s_h^k,a_h^k))^2\right)\leq  6K\mathrm{var}_1 + 242SAH^3\log_2(K)\log(\frac{1}{\delta}).
\end{align}
\end{lemma}
\begin{proof}
We first control each $\hat{\sigma}_h^k(s_h^k,a_h^k)- (\hat{r}_h^k(s_h^k,a_h^k))^2$ with $v_h(s,a)$. Fix $(s,a,h,k)$. Using Lemma~\ref{lemma:con}, with probability $1-2\delta$,
\begin{align}
N_h^k(s,a)\left(\hat{\sigma}_h^k(s_h^k,a_h^k)- (\hat{r}_h^k(s_h^k,a_h^k))^2\right)\leq 3N_h^k v_h(s,a)+ H^2\log(\frac{1}{\delta}).
\end{align}

Then we have that, with probability $1-2SAHK\delta$,
\begin{align}
&\sum_{k,h}\left(\hat{\sigma}_h^k(s_h^k,a_h^k)- (\hat{r}_h^k(s_h^k,a_h^k))^2\right)\nonumber
\\ &\leq 3\sum_{k,h}v_h(s_h^k,a_h^k) + \sum_{k,h}\frac{H^2\log(\frac{1}{\delta})}{N_h^k(s_h^k,a_h^k)} \leq 3\sum_{k,h}v_h(s_h^k,a_h^k) +2SAH^3\log_2(K)\log(\frac{1}{\delta}).\label{eq:bdvr1}
\end{align}


Now it suffices to control $\sum_{k,h}v_h(s_h^k,a_h^k)$. Let $\tilde{V}_h^k(s):=\mathbb{E}_{\pi^k}[\sum_{h'=h}^H v_{h'}(s_{h'},a_{h'})|s_h = s]$ be the value function with reward as $\{v_h(s,a)\}$ and policy $\pi^k$. Then $\tilde{V}^k_h(s,a)\leq H^2$.

Then, by Lemma~\ref{lemma:self-norm}, with probability $1-2SAHK\delta$,
\begin{align}
\sum_{k=1}^K\sum_{h=1}^Hv_h(s_h^k,a_h^k) - \sum_{k=1}^K \tilde{V}_1^k(s_1^k) &= \sum_{k=1}^K \left( \sum_{h=1}^H \left(\textbf{1}_{s_{h+1}^k}-P_{s_h^k,a_h^k,h}\right)\tilde{V}^k_{h+1} \right) \nonumber
\\ & \leq 2\sqrt{2\sum_{k=1}^K \sum_{h=1}^H \mathbb{V}(P_{s_h^k,a_h^k,h},\tilde{V}_{h+1}^k)\log(\frac{1}{\delta})} + 3H^2 \log(\frac{1}{\delta}).\label{eq:local0}
\end{align}

On the other hand, using Lemma~\ref{lemma:self-norm} again, we obtain that with probability $1-2SAHK\delta$
\begin{align}
&\sum_{k=1}^K \sum_{h=1}^H \mathbb{V}(P_{s_h^k,a_h^k,h},\tilde{V}_{h+1}^k)\nonumber
 \\ & = \sum_{k=1}^K \sum_{h=1}^H \left( P_{s_h^k,a_h^k,h} -\textbf{1}_{s_{h+1}^k}  \right)(\tilde{V}_{h+1}^k)^2  \nonumber
 \\ & \qquad \qquad \qquad + \sum_{k=1}^H \sum_{h=1}^H \left((\tilde{V}_{h+1}^k(s_{h+1}^k))^2- (\tilde{V}_h^k(s_h^k))^2 \right)+\sum_{k=1}^K \sum_{h=1}^H \left( (\tilde{V}_h^k(s_h^k))^2 - (P_{s_h^k,a_h^k,h}\tilde{V}_{h+1}^k)^2\right) \nonumber
 \\ & \leq 2\sqrt{8H^4\sum_{k=1}^K \sum_{h=1}^H \mathbb{V}(P_{s_h^k,a_h^k,h},\tilde{V}_{h+1}^k)\log(\frac{1}{\delta})   } +2H^2\sum_{k=1}^K\sum_{h=1}^H v_h(s_h^k,a_h^k) + 3H^4\log(\frac{1}{\delta})\nonumber
 \\ & \leq 4H^2\sum_{k=1}^K\sum_{h=1}^H v_h(s_h^k,a_h^k)+42H^4\log(\frac{1}{\delta}).\label{eq:local1}
\end{align}

By \eqref{eq:local0} and \eqref{eq:local1}, we learn that, with probability $1-4SAHK\delta$,
\begin{align}
\sum_{k=1}^K\sum_{h=1}^K v_h(s_h^k,a_h^k) & \leq \sum_{k=1}^K \tilde{V}_1^k(s_1^k) + 2\sqrt{8H^2\sum_{k=1}^K\sum_{h=1}^Hv_h(s_h^k,a_h^k) \log\frac{1}{\delta}+ 84H^4\log^2(\frac{1}{\delta})}+3H^2\log(\frac{1}{\delta}) \nonumber
\\ & \leq   2\sum_{k=1}^K \tilde{V}_1^k(s_1^k)  +80H^2\log(\frac{1}{\delta})\nonumber
\\ & \leq 2K\mathrm{var}_1 +80H^2\log(\frac{1}{\delta}).\label{eq:bdddv}
\end{align}

\end{proof}

With Lemma~\ref{lemma:bdrv} and \eqref{eq:local3}, with probability $1-4SAHK\delta$,
\begin{align}
T_2\leq \frac{460}{9}\sqrt{2SAH\log_2(K)\log(\frac{1}{\delta})T_5} +12\sqrt{SAH\log_2(K)\log(\frac{1}{\delta})}\sqrt{2K\mathrm{var}_1} + 157SAH^2\log_2(K)\log(\frac{1}{\delta}).\label{eq:nbt2}
\end{align}


\subsubsection{Bound of $T_4$}

Recall that $T_4 = \check{T}_1+\check{T}_2$ where $\check{T}_1 = \sum_{k=1}^K \sum_{h=1}^H  \left( \hat{r}_h^k(s_h^k,a_h^k)-r_h(s_h^k,a_h^k) \right)$ and $\check{T}_2 = \sum_{k=1}^K \left( \sum_{h=1}^H r_h(s_h^k,a_h^k) - V_1^{\pi^k}(s_1^k) \right)$.

We first bound $\check{T}_1$. By Lemma~\ref{bennet} and a union bound over all proper $(s,a,h,k)$, with probability $1-2SAHK\delta$,
\begin{align}
\hat{r}_h^k(s,a)-r_h(s,a)\leq \sqrt{\frac{2v_h(s,a)\log(\frac{1}{\delta})}{N_h^k(s,a)}}+ \frac{H\log(\frac{1}{\delta})}{N_h^k(s,a)}.
\end{align}

As a result, we have that
\begin{align}
|\check{T}_1| &  \leq \sum_{k=1}^K \sum_{h=1}^H\left(  \sqrt{\frac{2v_h(s_h^k,a_h^k)\log(\frac{1}{\delta})}{N_h^k(s_h^k,a_h^k)}}+ \frac{H\log(\frac{1}{\delta})}{N_h^k(s_h^k,a_h^k)}  \right)\nonumber
\\ & \leq \sqrt{4SAH\log_2(K)\log(\frac{1}{\delta})}\cdot \sqrt{\sum_{k=1}^K\sum_{h=1}^H v_h(s_h^k,a_h^k)} + 2SAH^2\log_2(K)\log(\frac{1}{\delta}).\label{eq:wc3}
\end{align}

By \eqref{eq:bdddv}, with probability $1-4SAHK\delta$,
\begin{align}
\sum_{k=1}^K\sum_{h=1}^H v_h(s_h^k,a_h^k)\leq 2K\mathrm{var}_1 + 80H^2\log(\frac{1}{\delta}).\label{eq:wc1}
\end{align}

Then
\begin{align}
|\check{T}_1| \leq \sqrt{8SAHK\mathrm{var}_1\log_2(K)\log(\frac{1}{\delta})}+ 20SAH^2\log_2(K)\log(\frac{1}{\delta}).\label{eq:cht1}
\end{align}

On the other hand, to bound $\check{T}_2$, we have that
\begin{align}
\check{T}_2 = \sum_{k=1}^K \sum_{h=1}^H \left(\textbf{1}_{s_{h+1}^k}-P_{s_h^k,a_h^k,h} \right)V_{h+1}^{\pi^k}.
\end{align}

Using Lemma~\ref{lemma:self-norm}, with probability $1-2SAHK\delta$,
\begin{align}
|\check{T}_2|  & \leq 2\sqrt{2\sum_{k=1}^K\sum_{h=1}^H \mathbb{V}(P_{s_h^k,a_h^k,h},V_{h+1}^{\pi^k})\log(\frac{1}{\delta}) }+ 3H\log(\frac{1}{\delta})\nonumber
\\ & \leq 2\sqrt{4\sum_{k=1}^K \sum_{h=1}^H (\mathbb{V}(P_{s_h^k,a_h^k,h},V_{h+1}^*) + \mathbb{V}(P_{s_h^k,a_h^k,h}, V^*_{h+1}-V_{h+1}^{\pi^k})  )\log(\frac{1}{\delta})}+3H\log(\frac{1}{\delta}).\label{eq:cls0}
\end{align}


Continue the computation,
\begin{align}
&\sum_{k=1}^K\sum_{h=1}^H \mathbb{V}(P_{s_h^k,a_h^k,h},V_{h+1}^* -V_{h+1}^{\pi^k}) \nonumber
\\ & = \sum_{k=1}^K\sum_{h=1}^H \left(  P_{s_h^k,a_h^k,h} (V_{h+1}^* - V_{h+1}^{\pi^k})^2 - (P_{s_h^k,a_h^k,h} (V_{h+1}^* - V_{h+1}^{\pi^k}) )^2       \right)\nonumber
\\ & \leq \sum_{k=1}^K \sum_{h=1}^H \left( P_{s_h^k,a_h^k,h}-\textbf{1}_{s_{h+1}^k} \right) (V_{h+1}^* -V_{h+1}^{\pi^k})^2 \nonumber
\\  &\quad + 2H\sum_{k=1}^K \sum_{h=1}^H \max\left\{   \left( V_{h}^*(s_h^k)-r_{h}(s_h^k,a_h^k) - P_{s_h^k,a_h^k,h}V_{h+1}^*\right)- \left( V_{h}^{\pi^k}(s_h^k) -r_h(s_h^k,a_h^k) - P_{s_h^k,a_h^k,h}V_{h+1}^{\pi^k} \right)    ,0 \right\} \nonumber
\\ & \leq 2\sqrt{8H^2\sum_{k=1}^K\sum_{h=1}^H \mathbb{V}(P_{s_h^k,a_h^k,h},V_{h+1}^* - V_{h+1}^{\pi^k})\log(\frac{1}{\delta})}   
\nonumber
\\ &\qquad \qquad \qquad \qquad +    2H\sum_{k=1}^K \sum_{h=1}^H \left(V_{h}^*(s_h^k)-r_h(s_h^k,a_h^k) -P_{s_h^k,a_h^k,h}V_{h+1}^*\right)   + 3H^2\log(\frac{1}{\delta})\label{eq:csl1}
\end{align}
Here \eqref{eq:csl1} holds with probability $1-2SAHK\delta$ because of Lemma~\ref{lemma:self-norm}
 and Lemma~\ref{lemma:sqv}.

Then we consider to bound
\begin{align}
& \sum_{k=1}^K \sum_{h=1}^H \left(V_{h}^*(s_h^k)-r_h(s_h^k,a_h^k) -P_{s_h^k,a_h^k,h}V_{h+1}^*\right)   \nonumber
\\ & = \sum_{k=1}^K \left( V_1^*(s_1^k) - V_1^{\pi^k}(s_1^k) \right) + \sum_{k=1}^K(V_1^{\pi^k}(s_1^k) - \sum_{h=1}^H r_h(s_h^k,a_h^k)) + \sum_{k=1}^K\sum_{h=1}^H (\textbf{1}_{s_{h+1}^k}-P_{s_h^k,a_h^k,h})V_{h+1}^*.\label{eq:d1}
\end{align}

The first term in the right hand side \eqref{eq:d1} is exactly $\mathrm{Regret}(K)=T_1+T_2+T_3+T_4$, the second term is $-T_4$, and the third term is bounded by 
\begin{align}
\sum_{k=1}^K\sum_{h=1}^H (\textbf{1}_{s_{h+1}^k}-P_{s_h^k,a_h^k,h})V_{h+1}^*\leq 2\sqrt{2\sum_{k=1}^K\sum_{h=1}^H \mathbb{V}(P_{s_h^k,a_h^k,h},V_{h+1}^*)\log(\frac{1}{\delta})}+3H\log(\frac{1}{\delta})
\end{align}
with probability $1-2SAHk\delta$.


It then follows that with probability $1-8SAHK\delta$,
\begin{align}
& \sum_{k=1}^K \sum_{h=1}^H \left(V_{h}^*(s_h^k)-r_h(s_h^k,a_h^k) -P_{s_h^k,a_h^k,h}V_{h+1}^*\right) \nonumber
\\ & \leq T_1+T_2+T_3+2|T_4| + 2\sqrt{2\sum_{k=1}^K\sum_{h=1}^H\mathbb{V}(P_{s_h^k,a_h^k,h},V_{h+1}^*)\log(\frac{1}{\delta})} + 55H\log(\frac{1}{\delta}).
\end{align}

With \eqref{eq:csl1}, we further obtain that, with probability $1-8SAHK\delta$
\begin{align}
&\sum_{k=1}^K\sum_{h=1}^H \mathbb{V}(P_{s_h^k,a_h^k,h},V_{h+1}^*-V_{h+1}^{\pi^k}) \nonumber
\\ & \leq   4H(T_1+T_2+T_3+2|T_4|+2\sqrt{2\sum_{k=1}^K\sum_{h=1}^H\mathbb{V}(P_{s_h^k,a_h^k,h},V_{h+1}^*)\log(\frac{1}{\delta})})    +262H^2\log(\frac{1}{\delta}).\label{eq:wc2}
\end{align}

Define $T_{10} = \sum_{k=1}^K\sum_{h=1}^H\mathbb{V}(P_{s_h^k,a_h^k,h},V_{h+1}^*)$.  
Plugging \eqref{eq:wc2} into \eqref{eq:cls0}, with probability $1-10SAHK\delta$,
\begin{align}
|\check{T}_2|&\leq 2\sqrt{8K\mathrm{var}_1 \log(\frac{1}{\delta})} +  8\sqrt{H(T_1+T_2+T_3+2|T_4|+2\sqrt{2T_{10}\log(\frac{1}{\delta})})\log(\frac{1}{\delta})} +107H\log(\frac{1}{\delta})  \nonumber
\\ &  \leq 11\sqrt{T_{10}\log(\frac{1}{\delta})} +16\sqrt{H(T_1+T_2+T_3+2|T_4|)\log(\frac{1}{\delta})} + 115H\log(\frac{1}{\delta}).
\end{align}

Recalling \eqref{eq:cht1},  with probability $1-10SAHK\delta$
\begin{align}
|T_4|&\leq  18\sqrt{SAHT_{10}\log_2(K)\log(\frac{1}{\delta})} +16\sqrt{H(T_1+T_2+T_3+2|T_4|)\log(\frac{1}{\delta})} + 135SAH^2\log_2(K)\log(\frac{1}{\delta}) \nonumber
\\ & \leq   36\sqrt{SAHT_{10}\log_2(K)\log(\frac{1}{\delta})} + 32\sqrt{H(T_1+T_2+T_3)\log(\frac{1}{\delta})}+           306SAH^2\log_2(K)\log(\frac{1}{\delta}).\label{eq:nbt4}
\end{align}



\subsubsection{Bound of $T_5$ and $T_6$}

We start with the following lemma
\begin{lemma}\label{lemma:empv}
With probability $1-2SAHK\delta$,
\begin{align}
 T_5 \leq  5T_6 +8BSAH^3.\label{eq:var5x}
\end{align}

\end{lemma}
\begin{proof}[Proof of Lemma~\ref{lemma:empv}]
Direct computation gives that
\begin{align}
 & \sum_{k,h}\mathbb{V}(\hat{P}_{s_h^k,a_h^k,h}^k, V_{h+1}^k)\nonumber\\ &  = \sum_{k,h} \left(\hat{P}_{s_h^k,a_h^k,h}^k  (V_{h+1}^k)^2 - (\hat{P}_{s_h^k,a_h^k,h}V_{h+1}^k)^2 \right) \nonumber
\\ & \leq  \sum_{k,h}\left(P_{s_h^k,a_h^k,h}^k  (V_{h+1}^k)^2   - (P_{s_h^k,a_h^k,h}V_{h+1}^k)^2 \right) + \sum_{k,h}\left(\hat{P}_{s_h^k,a_h^k,h}-P_{s_h^k,a_h^k,h}\right)(V_{h+1}^k)^2 + 2H\sum_{k,h}\left(\hat{P}_{s_h^k,a_h^k,h}-P_{s_h^k,a_h^k,h}\right)V_{h+1}^k\nonumber
\\ & \leq  \sum_{k,h}\mathbb{V}(P_{s_h^k,a_h^k,h}^k  ,V_{h+1}^k) + \sum_{k,h}\left(\hat{P}_{s_h^k,a_h^k,h}-P_{s_h^k,a_h^k,h}\right)(V_{h+1}^k)^2 + 2H\sum_{k,h}\left(\hat{P}_{s_h^k,a_h^k,h}-P_{s_h^k,a_h^k,h}\right)V_{h+1}^k\nonumber
\\ & = T_5 + T_7+ 2HT_1.
\end{align}

Using Lemma~\ref{lemma:key3} to bound $T_7$ and $T_1$, with probability $1-2SAHK\delta$, it holds that
\begin{align}
 \sum_{k,h}\mathbb{V}(\hat{P}_{s_h^k,a_h^k,h}^k, V_{h+1}^k) &\leq \sum_{k,h}\mathbb{V}(P_{s_h^k,a_h^k,h}^k  , V_{h+1}^k) +  6\sqrt{ \sum_{k,h} \mathbb{V}(P_{s_h^k,a_h^k,h},V_{h+1}^k)BSAH^3 }+3BSAH^3\nonumber
 \\ & \leq 5\sum_{k,h}\mathbb{V}(P_{s_h^k,a_h^k,h}^k  , V_{h+1}^k) +8BSAH^3.\label{eq:var5}
\end{align}

\end{proof}

By Lemma~\ref{lemma:empv}, it suffices to bound $T_5 = \sum_{k,h}\mathbb{V}(P_{s_h^k,a_h^k,h},V_{h+1}^k)$.


Because $\mathrm{Var}(X+Y)\leq 2(\mathrm{Var}(X)+\mathrm{Var}(Y))$ for any two random variable $X,Y$ with finite variance, we have that
\begin{align}
\sum_{k,h} \mathbb{V}(P_{s_h^k,a_h^k,h},V_{h+1}^k)  & \leq  2\sum_{k,h} \mathbb{V}(P_{s_h^k,a_h^k,h},V_{h+1}^* ) + 2\sum_{k,h}\mathbb{V}(P_{s_h^k,a_h^k,h},V_{h+1}^k -V_{h+1}^* )\nonumber
\\ & \leq 3   K\mathrm{var}_1 +\sum_{k=1}^K \left( \sum_{h=1}^H \mathbb{V}(P_{s_h^k,a_h^k,h},V_{h+1}^* ) - 3\mathrm{var}_1 \right) + 2\sum_{k,h}\mathbb{V}(P_{s_h^k,a_h^k,h},V_{h+1}^k -V_{h+1}^* ).\label{eq:var0}
\end{align}




\begin{lemma}\label{lemma:k1}
With probability $1-4SAHK\delta$, it holds that
\begin{align}
T_{10} -2K\mathrm{var}_1=\sum_{k=1}^K \left( \sum_{h=1}^H \mathbb{V}(P_{s_h^k,a_h^k,h},V_{h+1}^* ) -2\mathrm{var}_1 \right)  \leq 80H^2\log(\frac{1}{\delta}).
\end{align}
\end{lemma}
\begin{proof}




Let $\bar{R}_{h}^*(s,a) = \mathbb{V}(P_{s,a,h},V_{h+1}^*)$. Define
\begin{align}
\bar{V}^k_h (s) = \mathbb{E}\left[ \sum_{h'=h}^H \bar{R}_{h'}(s_{h'},a_{h'}) |s_h = s\right].\nonumber
\end{align}
Then $\bar{V}_h^k(s)\leq \mathrm{var}_1\leq H^2$.

We then have that
\begin{align}
  \sum_{h=1}^H  \mathbb{V}(P_{s_h^k,a_h^k,h},V_{h+1}^*)-\mathrm{var}_1 \nonumber & =\sum_{h=1}^H  \bar{R}_h^*(s_h^k,a_h^k)-\mathrm{var}_1  \nonumber
 \\ & \leq \sum_{h=1}^H \bar{R}_h^*(s_h^k,a_h^k) - \bar{V}^k_1(s_1^k)\nonumber
 \\ & = \sum_{h=1}^H \left(\textbf{1}_{s_{h+1}^k} - P_{s_{h}^k,a_h^k,h}  \right)\bar{V}^k_{h+1}.
\end{align}

Note that $\bar{V}^k$ only depends on $\pi^k$, which is determined before the $k$-th episode start.  
With Lemma~\ref{lemma:self-norm}, with probability $1-2SAHK\delta$,
\begin{align}
 & \sum_{k=1}^K \left( \sum_{h=1}^H \mathbb{V}(P_{s_h^k,a_h^k,h},V_{h+1}^*) - \bar{V}_1^k(s_1^k)  \right) \nonumber
 \\ & \leq 2\sqrt{2\sum_{k=1}^K \sum_{h=1}^H \mathbb{V}(P_{s_h^k,a_h^k,h},\bar{V}_{h+1}^k)\log(\frac{1}{\delta}) } + 3H^2\log(\frac{1}{\delta}).\label{eq:xlll1}
\end{align}

We further bound
\begin{align}
 & \sum_{k=1}^K \sum_{h=1}^H \mathbb{V}(P_{s_h^k,a_h^k,h},\bar{V}_{h+1}^k) \nonumber
 \\ &  =\sum_{k=1}^K \sum_{h=1}^H \left( P_{s_h^k,a_h^k,h} (\bar{V}_{h+1}^k)^2 - (P_{s_h^k,a_h^k,h}\bar{V}_{h+1}^k)^2 \right)\nonumber
 \\ & = \sum_{k=1}^K \sum_{h=1}^H \left( P_{s_h^k,a_h^k,h} -\textbf{1}_{s_{h+1}^k}  \right)(\bar{V}_{h+1}^k)^2  \nonumber
 \\ & \qquad \qquad + \sum_{k=1}^H \sum_{h=1}^H \left((\bar{V}_{h+1}^k(s_{h+1}^k))^2- (\bar{V}_h^k(s_h^k))^2 \right)+\sum_{k=1}^K \sum_{h=1}^H \left( (\bar{V}_h^k(s_h^k))^2 - (P_{s_h^k,a_h^k,h}\bar{V}_{h+1}^k)^2\right) \nonumber
 \\ & \leq 2\sqrt{8H^4\sum_{k=1}^K \sum_{h=1}^H \mathbb{V}(P_{s_h^k,a_h^k,h},\bar{V}_{h+1}^k)\log(\frac{1}{\delta})   } +2H^2\sum_{k=1}^K\sum_{h=1}^H \bar{R}_h(s_h^k,a_h^k) + 3H^4\log(\frac{1}{\delta}).\label{eq:xllll2}
\end{align}
Here the last inequality is by Lemma~\ref{lemma:self-norm} and Lemma~\ref{lemma:sqv} (with probability $1-2SAHK\delta$) and the fact that $\bar{V}_h^k(s_h^k) = \bar{R}_h(s_h^k,a_h^k)+P_{s_h^k,a_h^k,h}\bar{V}_{h+1}^k$.

It then follows that
\begin{align}
\sum_{k=1}^K \sum_{h=1}^H \mathbb{V}(P_{s_h^k,a_h^k,h},\bar{V}_{h+1}^k)  \leq 4H^2\sum_{k=1}^K \sum_{h=1}^H \bar{R}_h(s_h^k,a_h^k) + 42 H^4\log(\frac{1}{\delta}).\label{eq:xlll3}
\end{align}

By \eqref{eq:xlll1} and \eqref{eq:xlll3}, we learn that
\begin{align}
\sum_{k=1}^K \sum_{h=1}^H \mathbb{V}(P_{s_h^k,a_h^k,h},V_{h+1}^*) \leq \sum_{k=1}^H \bar{V}_1^k(s_1^k) +2\sqrt{8 H^2 \sum_{k=1}^K \sum_{h=1}^H \mathbb{V}(P_{s_h^k,a_h^k,h},V_{h+1}^*) \log(\frac{1}{\delta})     } + 21H^2\log(\frac{1}{\delta}),\nonumber
\end{align}
which further implies that
\begin{align}
\sum_{k=1}^K \sum_{h=1}^H \mathbb{V}(P_{s_h^k,a_h^k,h},V_{h+1}^*) \leq 2\sum_{k=1}^K \bar{V}_1^k(s_1^k)+ 84H^2\log(\frac{1}{\delta}) \leq 2K\mathrm{var}_1 + 84H^2\log(\frac{1}{\delta}).\nonumber
\end{align}

The proof is completed.







\end{proof}


For the left term $\sum_{k,h}\mathbb{V}(P_{s_h^k,a_h^k,h},V_{h+1}^k -V_{h+1}^* )$,   we have the lemma below.
\begin{lemma}\label{lemma:bdv1}
With probability $1-2\delta$, it holds that
\begin{align}
 & \sum_{k,h}\mathbb{V}(P_{s_h^k,a_h^k,h}, V_{h+1}^k -V_{h+1}^*)   \leq 4\sqrt{BH^2\sum_{k,h}\mathbb{V}(P_{s_h^k,a_h^k,h},V_{h+1}^k)}+ 4H\sum_{k,h}b_h^k(s_h^k,a_h^k)+ 3BSAH^3.\nonumber
\end{align}
\end{lemma}
\begin{proof}[Proof of Lemma~\ref{lemma:bdv1}]
Direct computation gives that
\begin{align}
 & \sum_{k,h}\mathbb{V}(P_{s_h^k,a_h^k,h},V_{h+1}^k - V_{h+1}^*)  \nonumber
 \\ & =\sum_{k,h} \left(  P_{s_h^k,a_h^k,h} (V_{h+1}^k - V_{h+1}^*)^2 - (P_{s_h^k,a_h^k,h} (V_{h+1}^k - V_{h+1}^*) )^2       \right)
 \\ &  = \sum_{k,h} \left(    (P_{s_h^k,a_h^k,h}-\textbf{1}_{s_{h+1}^k}) (V_{h+1}^k - V_{h+1}^*)^2   \right) \nonumber
 \\ & \qquad \qquad \qquad \qquad + \sum_{k,h} \left( (V_{h+1}^k(s_{h+1}^k)- V_{h+1}^*(s_{h+1}^k))^2 - ((P_{s_h^k,a_h^k,h} (V_{h+1}^k - V_{h+1}^*) )^2   ) \right)\nonumber
 \\ &  =\sum_{k,h} \left(    (P_{s_h^k,a_h^k,h}-\textbf{1}_{s_{h+1}^k}) (V_{h+1}^k - V_{h+1}^*)^2   \right) + \sum_{k,h} \left( (V_{h}^k(s_{h}^k)- V_{h}^*(s_{h}^k))^2 - ((P_{s_h^k,a_h^k,h} (V_{h+1}^k - V_{h+1}^*) )^2   ) \right).\label{eq:var1}
 \end{align}

%Let $T_{101} = \sum_{k,h} \left(    (P_{s_h^k,a_h^k,h}-\textbf{1}_{s_{h+1}^k}) (V_{h+1}^k - V_{h+1}^*)^2   \right)$ and $T_{102} =\sum_{k,h} \left( (V_{h}^k(s_{h}^k)- V_{h}^*(s_{h}^k))^2 - ((P_{s_h^k,a_h^k,h} (V_{h+1}^k - V_{h+1}^*) )^2   ) \right) $. 
By Lemma~\ref{lemma:self-norm} and Lemma~\ref{lemma:sqv}, with probability $1-\delta$, it holds that
\begin{align}
 \sum_{k,h} \left(    (P_{s_h^k,a_h^k,h}-\textbf{1}_{s_{h+1}^k}) (V_{h+1}^k - V_{h+1}^*)^2   \right)\leq 2\sqrt{2}\sqrt{4H^2\sum_{k,h}\mathbb{V}(P_{s_h^k,a_h^k,h}, V_{h+1}^k - V_{h+1}^* )\log(\frac{1}{\delta})} + 3H^2\log(\frac{1}{\delta}).\label{eq:var3}
\end{align}

On the other hand, with probability $1-\delta$,
 \begin{align}
 & \sum_{k,h} \left( (V_{h}^k(s_{h}^k)- V_{h}^*(s_{h}^k))^2 - ((P_{s_h^k,a_h^k,h} (V_{h+1}^k - V_{h+1}^*) )^2   ) \right)\nonumber
 \\ & \leq  2H\sum_{k,h} \max\{ V_h^k(s_h^k)-P_{s_h^k,a_h^k,h} V_{h+1}^k - (V^*_{h}(s_h^k)-P_{h}^k V_{h+1}^*) ,0  \}  \nonumber
\\ & \leq 2H \sum_{k,h} \max\{V_h^k(s_h^k) - P_{s_h^k,a_h^k,h}V_{h+1}^k-r_h(s_h^k,a_h^k),0\} \nonumber
\\ & \leq 2H\sum_{k,h}\max\{(\hat{P}_{s_h^k,a_h^k,h}-P_{s_h^k,a_h^k,h})V_{h+1}^k ,0\} +2H\sum_{k,h} b_h^k \nonumber
\\ & \leq  2\sqrt{BSAH^3\sum_{k,h}\mathbb{V}(P_{s_h^k,a_h^k,h}, V_{h+1}^k)}+2H\sum_{k,h}b_h^k(s_h^k,a_h^k) + BSAH^3.\label{eq:var4}
 \end{align}



It then follows that, with probability $1-2\delta$,
\begin{align}
 & \sum_{k,h}\mathbb{V}(P_{s_h^k,a_h^k,h}, V_{h+1}^k -V_{h+1}^*)  \leq 4\sqrt{BSAH^3\sum_{k,h}\mathbb{V}(P_{s_h^k,a_h^k,h},V_{h+1}^k)}+ 4H\sum_{k,h}b_h^k(s_h^k,a_h^k)+ 3BSAH^3.
\end{align}


The proof is completed.





\end{proof}


By Lemma~\ref{lemma:k1} and Lemma~\ref{lemma:bdv1}, we have that with probability $1-6SAHK\delta$,
\begin{align}
T_6:=&\sum_{k,h}\mathbb{V}(P_{s_h^k,a_h^k,h},V_{h+1}^k)\nonumber
\\ & \leq  2\sum_{k,h}\mathbb{V}(P_{s_h^k,a_h^k,h},V_{h+1}^*)+2\sum_{k,h}\mathbb{V}(P_{s_h^k,a_h^k,h},V_{h+1}^k - V_{h+1}^*)\nonumber
\\ & \leq 4K\mathrm{var}_1 +  8\sqrt{BSAH^3 T_6}+8HT_2 + 7BSAH^3\nonumber
\\ & \leq 8K\mathrm{var}_1 + 16HT_2 + 78BSAH^3.\label{eq:nbt6}
\end{align}

By Lemma~\ref{lemma:empv} and \eqref{eq:nbt6}, with probability $1-8SAHK\delta$, it holds that
\begin{align}
T_5:=\sum_{k,h}\mathbb{V}(\hat{P}_{s_h^k,a_h^k,h},V_{h+1}^k)\leq 40K\mathrm{var}_1 + 80HT_2+398BSAH^3.\label{eq:nbt5}
\end{align}


\subsubsection{Putting All Together}
We rewrite the inequalities $\eqref{eq:obt1}-\eqref{eq:obt8}$ as follows with \eqref{eq:obt2}, \eqref{eq:obt4}, \eqref{eq:obt5} and \eqref{eq:obt6}  replaced by  \eqref{eq:nbt2}, \eqref{eq:nbt4}
\eqref{eq:nbt5} and \eqref{eq:nbt6}. 
Recall $B =4000 \log_2^3(K)\log(3SA)\log(\frac{1}{\delta})$.

\begin{align}
& T_1 \leq \sqrt{128BSAHT_6}+24BSAH^2;\nonumber
\\ & T_7 \leq H\sqrt{512BSAHT_6}+24BSAH^3;\nonumber
\\ & T_9 \leq \sqrt{128BSAHT_6}+24BSAH^2;\nonumber
\\ & T_2\leq 100 \sqrt{B SAHT_5}+140BSAH^2;\nonumber
 \\ & T_3 \leq \sqrt{8BT_6}+3H\log(\frac{1}{\delta})  ;\nonumber
 \\ & T_4 \leq \sqrt{BSAHT_{10}}+32\sqrt{BH(T_1+T_2+T_3)}+BSAH^2;\nonumber
 \\ & T_5 \leq 40K\mathrm{var}_1 + 80HT_2+398BSAH^3  ;\nonumber
 \\ &  T_6 \leq  8K\mathrm{var}_1 + 16HT_2 + 78BSAH^3 ;\nonumber
 \\ & T_8 \leq \sqrt{32BH^2T_6 } + 3BH^2 .\nonumber
\end{align}
On the other hand, by Lemma~\ref{lemma:k1}, we have 
$$ T_{10} \leq 2K\mathrm{var}_1 + 80BH^2.$$ 
Solving the inequalities above, we obtain that, with probability $1-200SAH^2K^2\delta$, 
\begin{align}
\mathrm{Regret}(K)= T_1+T_2+T_3+T_4 \leq O\left( \sqrt{BSAHK\mathrm{var_1} }+ BSAH^2 \right).\label{eq:rbvar1}
\end{align}

The proof is completed by replacing $\delta$ with $\frac{\delta}{200SAH^2K^2}$.  
