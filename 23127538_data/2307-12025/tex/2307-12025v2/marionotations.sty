\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{marionotations}[2010/05/26 (2022/09/01 updated) TeX command definitions
used by Mario Chan]

\RequirePackage{xparse}   % to have flexible option arguments for commands
\RequirePackage{amsmath}
\RequirePackage{amsfonts}
\RequirePackage{amssymb}
\RequirePackage{mathrsfs} % in order to use the font type \mathscr
% \RequirePackage{atveryend} % for using tikz package and AtEndDocument simultaneously

%%%%% This defines an environment which helps to distinguish the parts
%%%%% of the work which are managed by Mario Chan
\NewDocumentEnvironment{mario}{O{}}{}{}
\newcommand{\mariocolor}[1]{}

%%%%% Mario's comment which is shown only when option "show-mario" is applied
\newcommand{\mariocomment}[2][]{}
\newcommand{\mariocommentcolor}[1]{}

%%%%% Color the text when option "show-mario" is applied
% \newcommand{\mmark}[2]{#1}
\NewDocumentCommand{\mmark}{s O{} m m}{#3}
\newcommand{\mmarkcolor}[1]{}

\NewDocumentCommand{\mhlight}{s O{} m}{\IfBooleanF{#1}{#3}}
\newcommand{\mhlightcolor}[1]{}

%%%%% Option which invokes the distinction and show comments
\DeclareOption{show-mario}{
  \AtEndOfPackage{
    \RequirePackage[usenames,dvipsnames]{xcolor}  % called just for the use of the "mario" environment
    \xdef\MarioColour{BlueViolet}
    \renewcommand{\mariocolor}[1]{\xdef\MarioColour{#1}}
    \RenewDocumentEnvironment{mario}{O{\MarioColour}}{\color{#1}}{}

    \xdef\MariocommentColour{OliveGreen}
    \renewcommand{\mariocommentcolor}[1]{\xdef\MariocommentColour{#1}}
    \renewcommand{\mariocomment}[2][\MariocommentColour]{%
      \marginpar{\parbox{\marginparwidth}{\color{#1}\footnotesize #2}}%
    }
    
    % \renewcommand{\mmark}[2]{{\color{OliveGreen} #1}\mariocomment{#2}}
    \xdef\MmarkColour{OliveGreen}
    \renewcommand{\mmarkcolor}[1]{\xdef\MmarkColour{#1}}
    \RenewDocumentCommand{\mmark}{s O{\MmarkColour} m m}{{\color{#2} #3}%
      \IfBooleanTF{#1}{%
        \mariocomment[#2]{See footnote \footnotemark}\footnotetext{\color{#2}#4}%
      }{\mariocomment[#2]{#4}}}

    \xdef\MhlightColour{OliveGreen}
    \renewcommand{\mhlightcolor}[1]{\xdef\MhlightColour{#1}}
    \RenewDocumentCommand{\mhlight}{s O{\MhlightColour} m}{{\color{#2}#3}}
    
    \AtEndDocument{\PackageWarningNoLine{marionotations}{Self commentaries are shown}}
  }
}

\newif\if@loadCommands
\@loadCommandstrue
\DeclareOption{no-commands}{
  \@loadCommandsfalse
}

\DeclareOption*{\AtEndDocument{
%     \PackageWarningNoLine{marionotations}{Unknown option
%       \CurrentOption}
    \relax
  } 
}
\ProcessOptions\relax


%%%%% For the use with my amsrefs database references.ltb %%%%%
\@ifpackageloaded{amsrefs}{
  \DefineSimpleKey{bib}{arxiv}
  % \DefineSimpleKey{bib}{keyalias}


  % \def\citesel@write#1#2#3#4#5{%
  % \toks@{{#3}{#4}}%
  % \immediate\write\@auxout{\string\bibcite{\CurrentBib}{\the\toks@}}%
  % \ifx\@empty\bib'keyalias
  % \relax%
  % \else
  % \immediate\write\@auxout{\string\@xp\string\let\@nx\csname b@\@nx\csname bib'keyalias\@nx\endcsname\string\@xp\string\endcsname\@nx\csname b@\CurrentBib\string\endcsname}%
  % \fi
  % }

  \NewDocumentCommand{\citealias}{
    m  %% #1 citekey alias
    m  %% #2 original citekey in amsrefs
  }{
    \nocite{#2}
    \if@filesw
      % \AtEndDocument{\write\@auxout{citealias at work}}
      % \AfterLastShipout{\PackageWarningNoLine{marionotations}{citealias at work}}
      \AtEndDocument{\immediate\write\@auxout{\string\@makealias{#1}{#2}}}
      % \AtEndDocument{\write\@auxout{\string\HyperDestRename{cite.#2}{cite.#1}}}
    \fi
    \HyperDestRename{cite.#2}{cite.#1} %% need 'destlabel' option in
                                       %% hyperref package
  }

  \newcommand{\@makealias}[2]{
    \global\expandafter\let\csname b@#1\expandafter\endcsname\csname b@#2\endcsname
  }


  \BibSpec{article}{%
    +{} {\PrintAuthors} {author}
    +{,} { \textit} {title}
    +{.} { } {part}
    +{:} { \textit} {subtitle}
    +{,} { \PrintContributions} {contribution}
    +{.} { \PrintPartials} {partial}
    +{,} { } {journal}
    +{} { \textbf} {volume}
    +{} { \PrintDate} {date}
    +{,} { \issuetext} {number}
    +{,} { \eprintpages} {pages}
    +{,} { } {status}
    +{,} { \PrintDOI} {doi}
    +{,} { available at \eprint} {eprint}
    +{,} { arXiv version at \arXivlinkprint} {arxiv}
    +{} { \parenthesize} {language}
    +{} { \PrintTranslation} {translation}
    +{;} { \PrintReprint} {reprint}
    +{.} { } {note}
    +{.} {} {transition}
    +{} {\SentenceSpace \PrintReviews} {review}
  }

  \NewDocumentCommand{\arXivlinkprint}{
    >{\SplitArgument{1}{ }} m
  }{\arXivlink #1}

  \NewDocumentCommand{\arXivlink}{
    m  %% #1 arXiv article number
    m  %% #2 arXiv article category
  }{\href{https://arxiv.org/abs/#1}{arXiv:#1 #2}}
}{}

%%%%%%%%%%% End of macros for refereces.ltb %%%%%%%%%%%%%%%%%%%%%



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Begin of definitions of commands 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\if@loadCommands
  \RequirePackage{tikz} % to draw the symbol \ibar
  \usetikzlibrary{positioning,babel}
  \InputIfFileExists{mariostdcommands}{}{}
\fi


\endinput