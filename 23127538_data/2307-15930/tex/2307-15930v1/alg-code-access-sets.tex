\begin{algorithm}[!htp]
\Initial{$\explore(\emptyseq)$~with~$\wut{\emptyseq}=\emptytree$}
\BlankLine
\Fn{$\explore(\exseq)$\tcp*[f]{Returns access sequences of messages}}{
$\done(\exseq) := \emptyset$\;\label{algacsl:doneset-init}
$\pendingwus{\exseq} := \emptyset$\;\label{algacsl:pendingwus-init}
%% $\doneaccesses(\exseq) := \emptyset$\;\label{algacsl:doneaccessesset-init}
  \If(\tcp*[f]{When $E$ is maximal, enter race detection}){$\enabled{\exseq} = \emptyset$}{
    \label{algacsl:event-race-begin}
    \ForEach{$\exseq' \leq \exseq$}{\label{algacsl:insert-parkedwus-begin}
  %%     $\done'(\exseq') := \done(\exseq')$\tcp*{\bjcom{This line to be explained}}
      \ForEach(\tcp*[f]{Parked wakeup sequences}){$v \in \pendingwus{\exseq'}$}{
        $\insertpendingwu{v}{E'}$\tcp*{are inserted at the appropriate place}\label{algacsl:insert-pendingwu}
      }
    }
    \ForEach(\tcp*[f]{For each race in $\exseq$}){$\event,\event'\ \keyword{such that} \ \event \revrace{\exseq} \event'$\label{algacsl:race-loop}} {
%%  \ \ \keyword{and each} \ \ e,  m, m', \event'\ \keyword{such that} \ e\msgrevrace{E}{m}{m'}e'$
%%     \keyword{let} \ \mbox{$\event_{pre}$ be  in }\;
      \ForEach(\tcp*[f]{For each race reversal}){$\tuple{\exseq',v} \in \reverserace(\exseq,e,e')$\label{algacsl:rev-race}}{
%% , built from events in $\notsucc{\event}{E}$, which enables $\event'$}){maximal $\exseq''$ with $\exseq'' \mtprefix \notsucc{\event}{E}$ which contains the $\happbf{\po}{E}$-predecessor of $\event'$}{
%%      \keyword{let} \ \mbox{$\exseq'$ and $u$ be such that $\exseq.u.\procof{\event'} \mtequiv \exseq''.\procof{\event'}$ and $\exseq'$ is a maximal prefix of $E$}\label{algacsl:normal-race-assign-x}\tcp*{Find the prefix $\exseq'$ at which the wakeup sequence $u.\procof{\event'}$ will be inserted}\label{algacsl:def-msg-E}
%%      \keyword{let} \ \mbox{$v = u.\procof{\event'}$}\;
%%        \If(\tcp*[f]{Has no equivalent sequence already been explored?}){$\neg \redundant{\exseq'}{\done}{v}$\label{algacsl:event-test}}{
        \If(\tcp*[f]{If $v$ is not redundant}){$\neg \exists E'',w,p \ \mbox{ s.t. }\ E''.w = E' \land p \in \dom{\done(E'')} \land p \in \winits{E''}{w.v}$\label{algacsl:event-test}}{
          $\insertwus{v}{\exseq'}{\emptyseq}$\tcp*{insert $v$ into the wakeup tree at $E'$}\label{algacsl:event-insert}\label{algacsl:event-race-end}
          %% \keyword{let} $p$ is the next in $\exseq$ after $\exseq'$\tcp*{\bjcom{This and the next three lines to be explained}}
          %% \If{$\nextev{\exseq'}{p} = \fst{p}$} {add the run of $p$ from $\exseq$ in $\done'(\exseq')$}
          %% \lElse{add $\nextev{\exseq'}{p}$ to $\done'(\exseq')$}
        }
      }
    }
  }
\Else(\label{algacsl:event-explore-begin}\tcp*[f]{If not at a maximal execution sequence, explore...}){
  \If{$\wut{\exseq} = \emptytree$ }{\label{algacsl:exploration-begin}
    $\keyword{choose}\; p \in \enabled{\exseq}$\tcp*{... or by selecting an arbitrary $p$...}\label{algacsl:wut-empty-choose}
    $\wut{\exseq} := \tuple{\set{\emptyseq,p},\set{(p,\emptyseq)}}$\tcp*{Adapt wakeup tree accordingly}\label{algacsl:wut-empty-init}
%%     $\sizeofws := |\exseq|$\tcp*{\bjcom{This line is to be explained}}
  }
  \ForEach{message $q$ that is active after $\exseq$}{$\accesses(q) := \emptyset$\tcp*{Initialize the sequences of accesses for messages}\label{algacsl:accesses-initialize}}
  \While(\tcp*[f]{While the wakeup tree is not empty...}){$\exists q \in \wut{\exseq}$\label{algacsl:while-WuT}}{
    $\keyword{let}\; p = \min_{\prec} \{ q \in \wut{\exseq} \}$\label{algacsl:pick-WuT}\tcp*{... pick next branch, ...}
    $\wut{\exseq.p} := \subtreeafter{p}{\wut{\exseq}}$\label{algacsl:def-WuT}\tcp*{extract next wakeup tree)}
    $\keyword{let}\; \tmpaccesses = \explore(\exseq.p)$\label{algacsl:event-call-explore}\tcp*{... and make a recursive call}
    \If{$\nextev{E}{p}$ is the last event of message $p$}{\label{algacsl:collection-start}
      add $p$ to $\dom{\tmpaccesses}$ with $\tmpaccesses(p) = \set{\emptyseq}$ \label{algacsl:initialize-accesses}
    }
    \If{$\nextev{E}{p}$ performs a global access}{
      prepend $\nextev Ep$'s access to each sequence in $\tmpaccesses(p)$\label{algacsl:extend-tmpaccesses}
    }
    \ForEach{message $q$ that is active after $\exseq$}{$\accesses(q) \ \cup\!= \tmpaccesses(q)$}\label{algacsl:accumulate-accesses}
    add $p$ to the domain of $\done(\exseq)$\label{algacsl:doneset-add}\tcp*{Mark $p$ as explored}
    \If(\tcp*[f]{If $p$ starts}){$p$ starts after $E$}{
      $\done(\exseq)(p) := \accesses(p)$\tcp*{... store $p$'s accesses}\label{algacsl:donesleeptree-add}
    }
    \lElse(\tcp*[f]{... store $\nextev{E}{p}$'s access}){$\done(\exseq)(p) := \mbox{$\nextev{E}{p}$}$'s access}\label{algacsl:donesleeptree-add-ev}
    {remove all sequences of form $p.w$ from $\wut{\exseq}$}\tcp*{At end, cleanup}\label{algacsl:wut-deletebranch}
  }
  $\keyword{return}\; \accesses$\label{algacsl:exploration-end}
}
}
\caption{\EventDPOR}
\label{alg:eventdpor-access}
\end{algorithm}
