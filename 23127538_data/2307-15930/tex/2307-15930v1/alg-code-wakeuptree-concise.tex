\begin{algorithm}[t]
\newcommand{\lIfElse}[3]{\lIf{#1}{#2 \textbf{else}~#3}}
\SetAlFnt{\small\sf}
\SetKw{Continue}{continue}
%% \Initial{$\insertrec{E}{\emptyseq}{v}{\tuple{B,\prec}}$}
\BlankLine
\Fn{$\insertwus{v}{E'}{u}$}{
  \lIf{$v$ is the empty sequence \keyword{or} $u$ is a leaf in $\wut{E'}$}{\Return{}}\label{alg:wut-insert-empty}
%%   \keyword{let} $L$ be the list of children of $u$ in $\wut{E'}$ from left to right\;\label{alg:wut-insert-forever}
  \ForEach{\mbox{\rm child $u.p$ of $u$, in order (from left to right)}}{\label{algl:wut-foreach-child}
    \If(\tcp*[f]{If a new message is not started ...}){$p$ does not start after ${\exseq'.u}$}{\label{alg:no-message}
      \If{$p \in \winits{\exseq'.u}{v}$}{
        \lIfElse{$\nextev{\exseq'.u}{p} \in v$}{$\insertwus{v\remove p}{E'}{u.p}$}{\Return{}\label{alg:travers-no-message}}
      }
    }
    \Else{\label{alg:message}
      \If{$p$ is the first (if any) message on its handler in $v$}{
        \lIfElse{$\nextev{\exseq'.u}{p} \in v$}{$\insertwus{v\remove p}{E'}{u.p}$}{\Return{}\label{alg:wut-pfirst}}
      }
      \ElseIf{$p$ is fully present in $v$\label{alg:wut-pfull}} {
	      \lIfElse{$p \in \winits{\exseq'.u}{v}$}{$\insertwus{v\remove p}{E'}{u.p}$}{
         %\lElse{
%%            add the run of $p$ from $v$ in $\done'(\exseq'.u)$\bjcom{Hmmm}\;
           \Continue
         }\label{alg:wut-pfull-continue}
      }
      \Else{
        add $v$ to $\pendingwus{E'.u.p}$\;
        \Return{}\;
      }
    }
%%     add $p$ to $\done'(\exseq'.u)$\bjcom{Hmmm}
  }
%%   Construct $v'$ from events in $v$ such that $\valid{E.u}{v'}$ and $\neg \redundant{E.u}{\done'}{v'}$\;\label{algwut:new-branch}
insert $v$ as a new branch from $u$, ordered after the existing children of $u$\;\label{alg:wut-insert-branch}
  \Return{}\;
}
\caption{Insertion into Wakeup Tree.}
\label{alg:wakeuptree}
\end{algorithm}
