\begin{algorithm}[!htp]
\SetAlFnt{\small\sf}
\BlankLine
\Fn{$\reverserace({E},{\event},{\event'})$}{
  \keyword{let} $E''$ be the subsequence of $E$ consisting of the events $e'''$ with $\event \nhappbf{\hb}{E} \event'''$\;\label{algl:revrace-init-notdep}
  \keyword{let} $\event''$ be the last event performed by $\procof{\event'}$\;
  $\happbf{sc}{E''} := \weaksatrel{\happbf{hb}{E''}}$\;\label{algl:revrace-init-ordering}
  \keyword{let} $S=\{E''\}$\label{algl:revrace-lin-seq}\;
  \ForEach{$F\in S$}{
    \Repeat{each handler in $F$ has at most one incomplete message}{\label{algl:revrace-msg-del-start}
      \label{algl:converge-begin}
      \If{an incomplete message includes an event $e'''$ with $e''' \happbf{\hb}{F} e''$}{\label{algl:revrace-rule-must}
        remove all other incomplete messages on same handler from $F$\;
      }
      \If{several incomplete messages execute on one
        handler}{\label{algl:revrace-rule-choose}
        \ForEach{incomplete message $p$ in the same handler}{
          construct a sequence $U$ where all the messages except $p$ from
          this handler are removed\;
          add $U$ to the set $S$\;
        }
        delete $F$ from $S$\;
        pick another sequence $F$ from $S$\;
      }
      \ForEach{incomplete message $p$}{\label{algl:revrace-rule-last}
        add relation $\happbf{sc}{F}$ from all other messages on
        same handler to $p$ and saturate\;
      }
      \ForEach{cycle in $\happbf{sc}{F}$}{\label{algl:revrace-rule-cycle}
        remove a message in the cycle\;
      }
      remove events that follow already removed events in the $\happbf{\hb}{F}$ ordering\;
      \If{an event $e'''$ s.t. $e''' \happbf{\hb}{F} e''$ is
        deleted}{\label{algl:revrace-irreversible}
        remove $F$ from $S$ and exit the loop;
      }
    }\label{algl:converge-end}
  }\label{algl:revrace-msg-del-end}
  %$E'$ is the maximal prefix s.t. $E'.u = E''$ \ $E' \leq E''$ and
  %$E' \leq E$\; \label{algl:revrace-determine-prefix}
  \keyword{let} $WSS=\emptyset$ \tcp*[f]{set of wakeup sequences}\;
  \ForEach{$F\in S$}{
    \ForEach{two messages from the same handler that are not ordered by $\happbf{sc}{F}$}{
      add relation $\happbf{sc'}{F}$ as they appear in $F$; \label{algl:revrace-msg-order}
    }
    \Repeat{until $\happbf{sc}{F}$ and $\happbf{sc'}{F}$ together
      are acyclic}{
      nondeterministically pick two messages ordered by the relation $\happbf{sc'}{F}$ and
      reverse the order; \label{algl:revrace-next-msg-order}
    }
    topologically sort $F$ respecting
    $\happbf{sc}{F}$ and $\happbf{sc'}{F}$ \label{algl:revrace-linearize}\;
    extract largest common prefix $E'$ of $F$ and $E$\;
    add \tuple{E',.u.e'} to $WSS$, where $F=E'.u$\;
  }
  $\Return(WSS)$\;
}
\caption{Reversal of a Race.}
\label{alg:reverserace}
\end{algorithm}
