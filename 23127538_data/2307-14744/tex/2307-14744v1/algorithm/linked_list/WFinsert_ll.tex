\begin{algorithm}[H]
\label{WFllinsert}
\caption{\texttt{wfLLInsert}(key, value, tid, phase)}
\While{\textup{\texttt{true}}}
{
    llNode* $prevNode :=$ \texttt{nullptr}\;
    llNode* $nextNode :=$ \texttt{llFind}($key,\  \&prevNode$)\;
    \If{$nextNode ==$ \textup{\texttt{nullptr}}}
    {
        \textbf{return} \texttt{false}\;
    }
    \ElseIf{$nextNode \rightarrow key == key$}
    {
        \While{\textup{\texttt{true}}}
        {
            $currState := stateArray[tid]$\;
            \label{alg25:line294}
            \textbf{if} $currState \rightarrow finished$ || $currState \rightarrow phase \neq phase$  \textbf{then return} \texttt{true} \;\label{alg25:line295}
            $newVnode := currState \rightarrow vNode$\;
            \label{alg25:line296}
            $nextVnode := newVnode \rightarrow nextv$\;
            \label{alg25:line297}
            $currVhead := nextNode \rightarrow vhead$\;
            \label{alg25:line298}
             \texttt{initTs}($currVhead)$\;
             \label{alg25:init}
             $currValue := currVhead \rightarrow value$\;
            \label{alg25:line303}
            
            \If{$currState \rightarrow vnode \rightarrow ts \neq$ -1}
            {
                \label{alg25:line300}
                $currState \rightarrow finished =$ \texttt{true}\;
                \textbf{return} \texttt{true}\;
                \label{alg25:line302}
            }
            \textbf{if} \texttt{isMarked}($currVhead$) \textbf{then} \textbf{return} \texttt{false} \;
            \If{\textup{\texttt{wfVCAS}}($nextNode,\ currValue,\ value,\ newVnode,\ \newline
            nextVnode,\ currVhead  $)}{
            \label{alg25:line304}
            $currState \rightarrow finished := true$\;
            \textbf{return} \texttt{true}
            }
        }
    }
    \Else
    {
        $currState := stateArray[tid]$\;
        \textbf{if} $currState \rightarrow finished$ \textbf{then return} \texttt{true} \;\label{alg25:line308}
        \If{$phase \neq currState \rightarrow phase\  \&\& \ currState \rightarrow vnode \rightarrow ts \neq$ -1}
            {
                \label{alg25:line309}
                $currState \rightarrow finished =$ \texttt{true}\;
                \textbf{return} \texttt{true}\;
            }
        llNode* $newNode :=$ \texttt{new llNode}($key,\ value,\ currState \rightarrow vnode$)\;
        $newNode \rightarrow next := nextNode$\;
        \If{$prevNode \rightarrow next$.\textup{\texttt{CAS}}($nextNode,\ newNode$)}{
        \label{alg25:line314}
            \texttt{initTs}$(newNode \rightarrow vhead)$\;
            \label{alg25:line312}
            $currState \rightarrow finished := true$
            \textbf{return} \texttt{true}\;
        }
        \textbf{else if} \texttt{isMarked}($prevNode \rightarrow next$) \textbf{then return} \texttt{false}\;
    }
}
\end{algorithm}