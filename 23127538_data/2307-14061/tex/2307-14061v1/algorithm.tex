\begin{algorithm}[t]
\caption{Set-level Guidance Attack}
\begin{algorithmic}
\State \textbf{Input:} Image encoder $f_I$, Text encoder $f_T$, Dataset $D$, Image-caption pair $(v,t)$, Image scale sets $S=\{s_1,s_2,...,s_N\}$, iteration steps $K$, number of paired captions $M$ 
\State \textbf{Output:} adversarial image $v'$, adversarial caption $t'$
\State Build caption set $\boldsymbol{t}=\{t_1,t_2,...,t_M\} \gets D$ \\
$/*$ Build adversarial caption set $\boldsymbol{t'}=\{t_1^{'},t_2^{'},...,t_M^{'}\}$ $*/$
    \For{$iter$ $i = 1, 2, ..., M$} 
        \State $t_{i}' = \mathop{\arg\max}\limits_{t_{i}'\in {B}[t_i,\epsilon_t]}-\frac{f_T(t_{i}')\cdot f_I(v)}{\Vert f_T(t_{i}') \Vert \Vert f_I(v) \Vert}$
    \EndFor \\
$/*$ Build image set $\boldsymbol{v}=\{v_1,v_2,...,v_N\}$ $*/$
\For{$iter$ $i = 1, 2, ..., N$} 
    \State $v_i = resize(v, s_i) + 0.05 \cdot \boldsymbol{N}(0,1)$
\EndFor \\
$/*$ Generate adversarial image $v'$ $*/$
\For{$iter$ $k = 1, 2, ..., K$}
    \State $v'=\mathop{\arg\max}\limits_{v'\in {B}[v,\epsilon_v]} -\sum_{i=1}^{M}\frac{f_T(t_{i}')}{\Vert f_T(t_{i}')\Vert}\sum_{v_i\in \boldsymbol{v}}\frac{f_I(v_i)}{\Vert f_I(v_i)\Vert}$
\EndFor \\
$/*$ Generate adversarial caption $t'$ $*/$
\State \quad \space $t' = \mathop{\arg\max}\limits_{t'\in {B}[t,\epsilon_t]}-\frac{f_T(t')\cdot f_I(v')}{\Vert f_T(t') \Vert \Vert f_I(v') \Vert}$
\end{algorithmic}
\label{alg:sga_algp}
\end{algorithm}
