
\begin{proof}
    By simultaneous induction on the derivation.
    \begin{enumit}
        \item
        \begin{description}
            \item[Case \rulename{WEc-Empty}:] Obvious since $\cpsinv{\emptyset} = \emptyset$.
            \item[Case \rulename{WEc-Var}:] We have
                \begin{itemize}
                    \item $\Gamma = \Gamma', x:\tau$,
                    \item $\jdwf{}{\Gamma'}$,
                    \item $x \notin \dom(\Gamma')$, and
                    \item $\jdwf{\Gamma'}{\tau}$
                \end{itemize}
                for some $\Gamma', x$, and $\tau$.
                By the IH, we have $\jdwf{}{\cpsinv{\Gamma'}}$.
                Also, we have $x \notin \dom(\cpsinv{\Gamma'})$
                since $\dom(\Gamma') \supseteq \dom(\cpsinv{\Gamma'})$.
                Moreover, since $\Gamma$ is cps-wellformed, $\tau = \cps{T}$ for some $T$.
                Then, by the IH, we have $\jdwf{\cpsinv{\Gamma'}}{T}$.
                We have the conclusion by \rulename{WE-Var}.
                (Note that $\cpsinv{\Gamma} = \cpsinv{\Gamma', x:\cps{T}} = \cpsinv{\Gamma'}, x: T$.)
            \item[Case \rulename{WEc-BVar}:] By the IH and \rulename{WE-BVar}.
            \item[Case \rulename{WEc-PVar}:] By the IH and \rulename{WE-PVar}.
            \item[Case \rulename{WEc-TVar}:] By the IH.
                Note that $\cpsinv{\Gamma', \alpha} = \cpsinv{\Gamma'}$.
        \end{description}
        \item Case analysis on $T$.
        \begin{description}
            \item[Case $T = \tyrfn{z}{B}{\phi}$:]
                By Assumption \ref{asm:cps:formula-cpsinv} and \rulename{WT-Rfn}.
            \item[Case $T = (x:T_1) \rarr C_1$:] By the IHs and \rulename{WT-Fun}.
        \end{description}
        \item Case analysis on $C$.
        \begin{description}
            \item[Case $C = \tycomp{\Sigma}{T}{\square}$:] We have
                $\cps{C} = \forall \alpha. \cps{\Sigma} \rarr (\cps{T} \rarr \alpha) \rarr \alpha$
                for some $\alpha$.
                By inversion, we have
                \begin{itemize}
                    \item $\jdwf{\Gamma, \alpha}{\cps{\Sigma}}$ and
                    \item $\jdwf{\Gamma, \alpha, h: \cps{\Sigma}}{\cps{T}}$~.
                \end{itemize}
                By \ref{lem:rm-nonrfn}, we have
                \begin{itemize}
                    \item $\jdwf{\Gamma, \alpha}{\cps{T}}$~.
                \end{itemize}
                By the IHs, we have
                \begin{itemize}
                    \item $\jdwf{\cpsinv{\Gamma}}{\Sigma}$ and
                    \item $\jdwf{\cpsinv{\Gamma}}{T}$~.
                \end{itemize}
                Also, by \rulename{WT-Pure}, we have $\jdwf{\cpsinv{\Gamma} \mid T}{\square}$.
                Then we have the conclusion by \rulename{WT-Comp}.
            \item[Case $C = \tycomp{\Sigma}{T}{\tyctl{x}{C_1}{C_2}}$:] We have
                $\cps{C} = \forall \alpha. \cps{\Sigma} \rarr ((x:\cps{T}) \rarr \cps{C_1}) \rarr \cps{C_2}$~.
                By inversion, we have
                \begin{itemize}
                    \item $\jdwf{\Gamma, \alpha}{\cps{\Sigma}}$,
                    \item $\jdwf{\Gamma, \alpha, h: \cps{\Sigma}}{\cps{T}}$,
                    \item $\jdwf{\Gamma, \alpha, h: \cps{\Sigma}, x:\cps{T}}{\cps{C_1}}$, and
                    \item $\jdwf{\Gamma, \alpha, h: \cps{\Sigma}, k: (x:\cps{T}) \rarr \cps{C_1}}{\cps{C_2}}$~.
                \end{itemize}
                By \ref{lem:rm-nonrfn}, we have
                \begin{itemize}
                    \item $\jdwf{\Gamma, \alpha}{\cps{T}}$,
                    \item $\jdwf{\Gamma, \alpha, x:\cps{T}}{\cps{C_1}}$, and
                    \item $\jdwf{\Gamma, \alpha}{\cps{C_2}}$~.
                \end{itemize}
                By the IHs, we have
                \begin{itemize}
                    \item $\jdwf{\cpsinv{\Gamma}}{\Sigma}$,
                    \item $\jdwf{\cpsinv{\Gamma}}{T}$,
                    \item $\jdwf{\cpsinv{\Gamma}, x:T}{C_1}$, and
                    \item $\jdwf{\cpsinv{\Gamma}}{C_2}$~.
                \end{itemize}
                Then we have the conclusion by \rulename{WT-ATM} and \rulename{WT-Comp}.
        \end{description}
        \item By the IHs and \rulename{WT-Sig}.
    \end{enumit}
\end{proof}