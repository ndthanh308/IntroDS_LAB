% depends on:: asm:formla asm:prim
%              lem:weaken lem:rm-nonrfn lem:rm-unused lem:subst lem:subst-pred lem:wfg
\begin{proof}
    \def\currentprefix{wft}
    By simultaneous induction on the derivations.
    \begin{enumit}
        \item 
        \begin{description}
            \item[Case \rulename{T-CVar}:] We have
                \def\currentprefix{wft:cvar}
                \begin{enumrm}
                    \item\llabel{eq-v} $v = x$,
                    \item\llabel{eq-T} $T = \tyrfn{z}{B}{z = x}$,
                    \item\llabel{wf-G} $\jdwf{}{\Gamma}$, and
                    \item\llabel{eq-Gx} $\Gamma(x) = \tyrfn{z}{B}{\phi}$
                \end{enumrm}
                for some $z, x$, and $B$.
                W.l.o.g., we can assume that $z \notin \dom(\Gamma)$.
                Then, By \rulename{WE-BVar} with \lref{wf-G}, we have
                % \begin{enumrm}[resume]
                    % \item\llabel{wf-Gx} 
                    $\jdwf{}{\Gamma, x: B}$.
                % \end{enumrm}
                Also, since \lref{eq-Gx} implies $x \in \dom(\Gamma)$,
                it holds that $\dom(\Gamma, x: B) \supseteq \fv(z = x)$.
                By the Assumption \ref{asm:formla} with these two fact,
                we have $\jdwf{\Gamma, x: B}{z = x}$.
                By \rulename{WT-Rfn}, we have the conclusion.
            \item[Case \rulename{T-Var}:] We have
                \def\currentprefix{wft:var}
                \begin{enumrm}
                    \item\llabel{eq-v} $v = x$,
                    \item\llabel{eq-T} $T = \Gamma(x)$,
                    \item\llabel{wf-G} $\jdwf{}{\Gamma}$, and
                    \item\llabel{eq-Gx} $\Gamma(x) \neq \tyrfn{z}{B}{\phi}$ for all $z, B$, and $\phi$
                \end{enumrm}
                for some $x$.
                \lref{eq-T} implies that $\Gamma$ is of the form $\Gamma_1, x: T, \Gamma_2$
                for some $\Gamma_1$ and $\Gamma_2$.
                Therefore, by inverting \lref{wf-G} repeatedly, we have $\jdwf{\Gamma_1}{T}$.
                By Lemma \ref{lem:weaken} with \lref{wf-G}, we have the conclusion.
            \item[Case \rulename{T-Prim}:] We have
                \def\currentprefix{wft:prim}
                \begin{enumrm}
                    \item\llabel{eq-v} $v = p$,
                    \item\llabel{eq-T} $T = \ty(p)$, and
                    \item\llabel{wf-G} $\jdwf{}{\Gamma}$
                \end{enumrm}
                for some $p$.
                By Assumption \ref{asm:prim}, we have $\jdwf{}{\ty(p)}$.
                By Lemma \ref{lem:weaken} with \lref{wf-G}, we have the conclusion.
            \item[Case \rulename{T-Fun}:] We have
                \def\currentprefix{wft:fun}
                \begin{enumrm}
                    \item\llabel{eq-v} $v = \exprec{f}{x}{c}$,
                    \item\llabel{eq-T} $T = (x: T_0) \rarr C$, and
                    \item\llabel{ty-c} $\jdty{\Gamma, x: T_0}{c}{C}$
                \end{enumrm}
                for some $f, x, c, T_0$, and $C$.
                By the IH of \lref{ty-c}, we have $\jdwf{\Gamma, f:(x: T_0) \rarr C, x: T_0}{C}$.
                By Lemma \ref{lem:rm-nonrfn}, we have $\jdwf{\Gamma, x: T_0}{C}$.
                By \rulename{WT-Fun}, we have the conclusion.
            \item[Case \rulename{T-VSub}:] Immediate by inversion.
        \end{description}
        \item 
        \begin{description}
            \item[Case \rulename{T-Ret}:] We have
                \def\currentprefix{wft:ret}
                \begin{enumrm}
                    \item\llabel{eq-c} $c = \expret{v}$,
                    \item\llabel{eq-C} $C = \tycomp{\emptyset}{T}{\square}$, and
                    \item\llabel{ty-v} $\jdty{\Gamma}{v}{T}$
                \end{enumrm}
                for some $v$ and $T$.
                By the IH of \lref{ty-v}, we have $\jdwf{\Gamma}{T}$.
                By Lemma \ref{lem:wfg}, we have $\jdwf{}{\Gamma}$.
                Then, we have the conclusion by the following derivation:
                \[
                    \infer{\jdwf{\Gamma}{\tycomp{\emptyset}{T}{\square}}}{
                        \infer{\jdwf{\Gamma}{\emptyset}}{}
                        &
                        \jdwf{\Gamma}{T}
                        &
                        \infer{\jdwf{\Gamma \mid T}{\square}}
                        {\jdwf{}{\Gamma}}
                    }
                \]
            \item[Case \rulename{T-App}:] We have
                \def\currentprefix{wft:app}
                \begin{enumrm}
                    \item\llabel{eq-c} $c = v_1~v_2$,
                    \item\llabel{eq-C} $C = C_0[v_2/x]$,
                    \item\llabel{ty-v1} $\jdty{\Gamma}{v_1}{(x:T_0) \rarr C_0}$, and
                    \item\llabel{ty-v2} $\jdty{\Gamma}{v_2}{T_0}$
                \end{enumrm}
                for some $x, v_1, v_2, T_0$ and $C_0$.
                By the IH of \lref{ty-v1}, we have $\jdwf{\Gamma}{(x:T_0) \rarr C_0}$.
                By inversion, we have $\jdwf{\Gamma, x:T_0}{C_0}$.
                By Lemma \ref{lem:subst}, we have the conclusion.
            \item[Case \rulename{T-If}:] We have
                \def\currentprefix{wft:if}
                \begin{enumrm}
                    \item\llabel{eq-c} $c = \expif{v}{c_1}{c_2}$,
                    \item\llabel{ty-v} $\jdty{\Gamma}{v}{\tyrfn{x}{\tybool}{\phi}}$,
                    \item\llabel{ty-c1} $\jdty{\Gamma, v = \exptrue}{c_1}{C}$, and
                    \item\llabel{ty-c2} $\jdty{\Gamma, v = \expfalse}{c_2}{C}$
                \end{enumrm}
                for some $x, v, c_1, c_2$, and $\phi$.
                By the IH of \lref{ty-c1}, we have $\jdwf{\Gamma, v = \exptrue}{C}$.
                By Lemma \ref{lem:rm-unused}, we have the conclusion.
            \item[Case \rulename{T-CSub}:] Immediate by inversion.
            \item[Case \rulename{T-Let}:] We have
                \def\currentprefix{wft:let}
                \begin{enumrm}
                    \item\llabel{eq-c} $c = \explet{x}{c_1}{c_2}$,
                    \item\llabel{eq-C} $C = \tycomp{\Sigma}{T_2}{\bind{S_1}{x}{S_2}}$,
                    \item\llabel{ty-c1} $\jdty{\Gamma}{c_1}{\tycomp{\Sigma}{T_1}{S_1}}$,
                    \item\llabel{ty-c2} $\jdty{\Gamma, x: T_1}{c_2}{\tycomp{\Sigma}{T_2}{S_2}}$, and
                    \item\llabel{in-x} $x \notin \fv(T_2) \cup \fv(\Sigma)$
                \end{enumrm}
                for some $x, c_1, c_2, \Sigma, T_1, T_2, S_1$ and $S_2$.
                By the IHs of \lref{ty-c1} and \lref{ty-c2} respectively, we have
                \begin{itemize}
                    \item $\jdwf{\Gamma}{\tycomp{\Sigma}{T_1}{S_1}}$ and
                    \item $\jdwf{\Gamma, x: T_1}{\tycomp{\Sigma}{T_2}{S_2}}$.
                \end{itemize}
                By inversion, we have
                \begin{enumrm}[resume]
                    \item\llabel{wf-sig} $\jdwf{\Gamma}{\Sigma}$,
                    \item\llabel{wf-S1} $\jdwf{\Gamma \mid T_1}{S_1}$,
                    \item\llabel{wf-T2} $\jdwf{\Gamma, x:T_1}{T_2}$, and
                    \item\llabel{wf-S2} $\jdwf{\Gamma, x:T_1 \mid T_2}{S_2}$.
                \end{enumrm}
                By Lemma \ref{lem:rm-unused} with \lref{in-x} \lref{wf-T2}, we have
                \begin{enumrm}[resume]
                    \item\llabel{wf-T2-2} $\jdwf{\Gamma}{T_2}$~.
                \end{enumrm}
                Case analysis on $\bind{S_1}{x}{S_2}$.
                (Note that the definition of $\ggeq$ has only two cases.)
                \begin{description}
                    \item[Case $S_1 = S_2 = \square$:]
                        By Lemma \ref{lem:wfg} with \lref{wf-sig}, we have $\jdwf{}{\Gamma}$.
                        From this fact and \lref{wf-sig} and \lref{wf-T2-2},
                        we have the conclusion by the following derivation:
                        \[
                            \infer{\jdwf{\Gamma}{\tycomp{\Sigma}{T_2}{\square}}}{
                                \jdwf{\Gamma}{\Sigma}
                                &
                                \jdwf{\Gamma}{T_2}
                                &
                                \infer{\jdwf{\Gamma \mid T_2}{\square}}
                                {\jdwf{}{\Gamma}}
                            }
                        \]
                    \item[Case $S_1 = \tyctl{x}{C_0}{C_1}$ and $S_2 = \tyctl{z}{C_2}{C_0}$
                        for some $z, C_0, C_1$, and $C_2$:]
                        We have
                        \begin{enumrm}[resume]
                            \item\llabel{in-x-2} $x \notin \fv(C_2) \setminus \{z\}$
                        \end{enumrm}
                        from the side condition of the definition of $\ggeq$.
                        By inversion with \lref{wf-S1} and \lref{wf-S2} respectively, we have
                        \begin{enumrm}[resume]
                            \item\llabel{wf-C0} $\jdwf{\Gamma, x:T_1}{C_0}$,
                            \item\llabel{wf-C1} $\jdwf{\Gamma}{C_1}$, and
                            \item\llabel{wf-C2} $\jdwf{\Gamma, x:T_1, z:T_2}{C_2}$~.
                        \end{enumrm}
                        W.l.o.g., we can assume $x \neq z$.
                        Then, \lref{in-x-2} implies $x \notin \fv(C_2)$.
                        Therefore, by Lemma \ref{lem:rm-unused} with \lref{wf-C2} and \lref{in-x},
                        we have $\jdwf{\Gamma, z:T_2}{C_2}$.
                        From this and \lref{wf-sig}, \lref{wf-T2-2}, and \lref{wf-C1},
                        we have the conclusion by the following derivation
                        (note that $\bind{S_1}{x}{S_2} = \tyctl{z}{C_2}{C_1}$):
                        \[
                            \infer{\jdwf{\Gamma}{\tycomp{\Sigma}{T_2}{\tyctl{z}{C_2}{C_1}}}}{
                                \jdwf{\Gamma}{\Sigma}
                                &
                                \jdwf{\Gamma}{T_2}
                                &
                                \infer{\jdwf{\Gamma \mid T_2}{\tyctl{z}{C_2}{C_1}}}{
                                    \jdwf{\Gamma, z:T_2}{C_2}
                                    &
                                    \jdwf{\Gamma}{C_1}
                                }
                            }
                        \]
                \end{description}
            \item[Case \rulename{T-Op}:] We have
                \def\currentprefix{wft:op}
                \begin{enumrm}
                    \item\llabel{eq-c} $c = \expop{v}{y}{c}$,
                    \item\llabel{eq-C} $C = \tycomp{\Sigma}{T_3}{\tyctl{z}{C_0}{C_2[\rep{A/X}][v/x]}}$,
                    \item\llabel{in-sig} $\Sigma \ni \op: \forall \rep{X: \rep{B}}. (x: T_1) \rarr ((y: T_2) \rarr C_1) \rarr C_2$,
                    \item\llabel{in-y} $y \notin \fv(T_3) \cup \fv(\Sigma) \cup (\fv(C_0) \setminus \{ z \})$,
                    \item\llabel{wf-A} $\rep{\jdty{\Gamma}{A}{\rep{B}}}$,
                    \item\llabel{ty-v} $\jdty{\Gamma}{v}{T_1[\rep{A/X}]}$, and
                    \item\llabel{ty-c} $\jdty{\Gamma, y: T_2[\rep{A/X}][v/x]}{c}{\tycomp{\Sigma}{T_3}{\tyctl{z}{C_0}{C_1[\rep{A/X}][v/x]}}}$,
                \end{enumrm}
                for some $x, y, z, v, c, \rep{X}, \rep{A}, \rep{\rep{B}}, \Sigma, T_1, T_2, T_3, C_0, C_1$ and $C_2$.
                By the IH of \lref{ty-c}, we have
                \[
                    \jdwf{\Gamma, y: T_2[\rep{A/X}][v/x]}{\tycomp{\Sigma}{T_3}{\tyctl{z}{C_0}{C_1[\rep{A/X}][v/x]}}}~.
                \]
                By inversion and Lemma \ref{lem:rm-unused} with \lref{in-y}, we have
                \begin{enumrm}[resume]
                    \item\llabel{wf-sig} $\jdwf{\Gamma}{\Sigma}$,
                    \item\llabel{wf-T3} $\jdwf{\Gamma}{T_3}$, and
                    \item\llabel{wf-C0} $\jdwf{\Gamma, z:T_3}{C_0}$~.
                \end{enumrm}
                By inversion of \lref{wf-sig} with \lref{in-sig}, we have
                $\jdwf{\Gamma, \rep{X: \rep{B}}}{(x: T_1) \rarr ((y: T_2) \rarr C_1) \rarr C_2}$~.
                By more inversion and Lemma \ref{lem:rm-nonrfn},
                we have $\jdwf{\Gamma, \rep{X: \rep{B}}, x: T_1}{C_2}$.
                By Lemma \ref{lem:subst-pred} with \lref{wf-A} and Lemma \ref{lem:subst} with \lref{ty-v},
                we have $\jdwf{\Gamma}{C_2[\rep{A/X}][v/x]}$.
                From this and \lref{wf-sig}, \lref{wf-T3}, \lref{wf-C0},
                we have the conclusion by the following derivation:
                \[
                    \infer{\jdwf{\Gamma}{\tycomp{\Sigma}{T_3}{\tyctl{z}{C_0}{C_2[\rep{A/X}][v/x]}}}}{
                        \jdwf{\Gamma}{\Sigma}
                        &
                        \jdwf{\Gamma}{T_3}
                        &
                        \infer{\jdwf{\Gamma \mid T_3}{\tyctl{z}{C_0}{C_2[\rep{A/X}][v/x]}}}{
                            \jdwf{\Gamma, z:T_3}{C_0}
                            &
                            \jdwf{\Gamma}{C_2[\rep{A/X}][v/x]}
                        }
                    }
                \]
            \item[Case \rulename{T-Hndl}:] We have
                \def\currentprefix{wft:hndl}
                \begin{enumrm}
                    \item\llabel{eq-c} $c = \expwith{h}{c_0}$,
                    \item\llabel{ty-c0} $\jdty{\Gamma}{c_0}{\tycomp{\Sigma}{T}{\tyctl{x_r}{C_1}{C}}}$
                \end{enumrm}
                for some $x_r, h, c_0, \Sigma, T$ and $C_1$.
                We have the conclusion by applying inversion twice to \lref{ty-c0}.
        \end{description}
    \end{enumit}
\end{proof}