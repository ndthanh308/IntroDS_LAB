% depends on:: lem:refl lem:trans lem:narrow
\begin{proof}
    \def\currentprefix{inv}
    By induction on the derivations.
    \begin{enumit}
        \item Straightforward with Lemma \ref{lem:refl} and \ref{lem:trans}.
        \item Straightforward with Lemma \ref{lem:refl} and \ref{lem:trans}.
        \item Straightforward with Lemma \ref{lem:refl} and \ref{lem:trans}.
        \item 
        \begin{description}
            \item[Case \rulename{T-Op}:] Obvious with Lemma \ref{lem:refl}.
            \item[Case \rulename{T-CSub}:] We have
                \begin{enumrm}
                    \item\llabel{ty-op} $\jdty{\Gamma}{\expop{v}{y}{c}}{\tycomp{\Sigma'}{T'}{S'}}$,
                    \item\llabel{sub-C} $\jdsub{\Gamma}{\tycomp{\Sigma'}{T'}{S'}}{\tycomp{\Sigma}{T}{S}}$, and
                    \item $\jdwf{\Gamma}{\tycomp{\Sigma}{T}{S}}$
                \end{enumrm}
                for some $\Sigma', T'$, and $C'$.
                W.l.o.g., we can assume that $y \notin \fv(\Sigma) \cup \fv(T)$.
                By inversion of \lref{sub-C}, we have
                \begin{enumrm}[resume]
                    \item\llabel{sub-sig} $\jdsub{\Gamma}{\Sigma}{\Sigma'}$,
                    \item\llabel{sub-T} $\jdsub{\Gamma}{T'}{T}$, and
                    \item\llabel{sub-S} $\jdsub{\Gamma \mid T'}{S'}{S}$~.
                \end{enumrm}
                By the IH on \lref{ty-op}, we have
                \begin{enumrm}[resume]
                    \item\llabel{in-sig} $\Sigma' \ni \op \forall \rep{X: \rep{B}}. \op: (x: T_1) \rarr ((y: T_2) \rarr C_1) \rarr C_2$,
                    \item\llabel{wf-A} $\rep{\jdty{\Gamma}{A}{\rep{B}}}$,
                    \item\llabel{ty-v} $\jdty{\Gamma}{v}{T_1[\rep{A/X}]}$,
                    \item\llabel{sub-T'} $\jdsub{\Gamma}{T''}{T'}$,
                    \item\llabel{ty-c} $\jdty{\Gamma, y: T_2[\rep{A/X}][v/x]}{c}{\tycomp{\Sigma}{T''}{\tyctl{z}{C_0}{C_1[\rep{A/X}][v/x]}}}$,
                    \item\llabel{sub-S'} $\jdsub{\Gamma \mid T''}{\tyctl{z}{C_0}{C_2[\rep{A/X}][v/x]}}{S'}$, and
                    \item\llabel{in-y} $y \notin \fv(\Sigma') \cup \fv(T') \cup \fv(T'') \cup (\fv(C_0) \setminus \{ z \})$
                \end{enumrm}
                for some $\rep{X}, \rep{\rep{B}}, \rep{A}, x, z, T'', T_1, T_2, C_0, C_1$, and $C_2$.
                From the assumption on $y$ and \lref{in-y}, we have
                \begin{enumrm}[resume]
                    \item \llabel{in-y'} $y \notin \fv(\Sigma) \cup \fv(T) \cup \fv(T'') \cup (\fv(C_0) \setminus \{ z \})$~.
                \end{enumrm}
                Inversion on \lref{sub-sig} implies that all field in $\Sigma'$ is also in $\Sigma$,
                and therefore we have
                \begin{enumrm}[resume]
                    \item\llabel{in-sig'} $\Sigma \ni \op: \forall \rep{X: \rep{B}}. (x: T_1) \rarr ((y: T_2) \rarr C_1) \rarr C_2$
                \end{enumrm}
                from \lref{in-sig}.
                Lemma \ref{lem:narrow} with \lref{sub-T'} and \lref{sub-S} implies
                \begin{enumrm}[resume]
                    \item\llabel{sub-S-str} $\jdsub{\Gamma \mid T''}{S'}{S}$~.
                \end{enumrm}
                Lemma \ref{lem:trans} with \lref{sub-T}, \lref{sub-T'}, \lref{sub-S-str} and \lref{sub-S'} implies
                $\jdsub{\Gamma}{T''}{T}$ and $\jdsub{\Gamma \mid T''}{\tyctl{z}{C_0}{C_2[\rep{A/X}][v/x]}}{S}$~.
                From these two with \lref{wf-A}, \lref{ty-v}, \lref{ty-c}, \lref{in-y'} and \lref{in-sig'},
                we have the conclusion.
        \end{description}
    \end{enumit}
\end{proof}