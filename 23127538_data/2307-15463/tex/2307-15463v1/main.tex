\pdfoutput=1
\newif\iffull \fullfalse

\documentclass[acmsmall, screen]{acmart}
% \documentclass[acmsmall, screen, review, anonymous]{acmart}
\settopmatter{printfolios=true,printccs=false,printacmref=false}
\setcopyright{none}


%% TODO
%% > Rights management information.  This information is sent to you
%% > when you complete the rights form.  These commands have SAMPLE
%% > values in them; it is your responsibility as an author to replace
%% > the commands and values with those provided to you when you
%% > complete the rights form.
% \setcopyright{acmcopyright}
% \copyrightyear{2023}
% \acmYear{2023}
% \acmDOI{XXXXXXX.XXXXXXX}

%% TODO
%% > These commands are for a PROCEEDINGS abstract or paper.
% \acmConference[]
%   {Make sure to enter the correct conference title from your rights confirmation email}
%   {}{}
% \acmPrice{15.00}
% \acmISBN{978-1-4503-XXXX-X/18/06}

%% TODO ?
%% > Submission ID.
%% > Use this when submitting an article to a sponsored event. You'll
%% > receive a unique submission ID from the organizers
%% > of the event, and this ID should be used as the parameter to this command.
%%\acmSubmissionID{123-A56-BU3}

\citestyle{acmauthoryear}
% \citestyle{acmnumeric}

\usepackage{proof}
\usepackage{mathtools}
\mathtoolsset{showonlyrefs=true}

\usepackage{multirow}
\usepackage{wrapfig}

\usepackage{bussproofs}
\usepackage{stackengine}

\usepackage{thelanguage}
% \newcommand*{\defeq}{\stackrel{\text{def}}{=}}
\newcommand*{\defeq}{\triangleq}
\newcommand{\rulename}[1]{(\textsc{#1})}
\newcommand{\infersc}[3][]{\infer[\!\!\text{\rulename{#1}}]{#2}{#3}}

\usepackage[normalem]{ulem}
\newcommand{\stkout}[1]{\ifmmode\text{\sout{\ensuremath{#1}}}\else\sout{#1}\fi}
\newcommand{\tchanged}[2]{{\color{red}\stkout{#1}}{\color{blue}#2}}
\newcommand{\tcomment}[1]{{\color{green}#1}}
\newcommand{\TS}[2]{{\color{cyan}\stkout{#1}}{\color{magenta}#2}}
\newcommand{\Fnew}[2]{{\color{olive}\stkout{#1}}{\color{orange}#2}}

\newcommand{\todo}[1]{{\color{blue} [TODO: #1]}}

\begin{document}

\title{Answer Refinement Modification}
\subtitle{Refinement Type System for Algebraic Effects and Handlers}

\author{Fuga Kawamata}
\email{maple-river@fuji.waseda.jp}
\affiliation{%
  \institution{Waseda University}
  \city{Tokyo}
  \country{Japan}
}

\author{Hiroshi Unno}
\email{uhiro@cs.tsukuba.ac.jp}
\affiliation{%
  \institution{University of Tsukuba}
  \city{Ibaraki}
  \country{Japan}
}

\author{Taro Sekiyama}
\email{tsekiyama@acm.org}
\affiliation{%
  \institution{National Institute of Informatics}
  \city{Tokyo}
  \country{Japan}
}

\author{Tachio Terauchi}
\email{terauchi@waseda.jp}
\affiliation{%
  \institution{Waseda University}
  \city{Tokyo}
  \country{Japan}
}

\renewcommand{\shortauthors}{Kawamata et al.}

\begin{abstract}
Algebraic effects and handlers are a mechanism to structure
programs with computational effects in a modular way. They
are recently gaining popularity and being adopted in practical languages,
such as OCaml.
%
Meanwhile, there has been substantial progress in program verification via {\em
refinement type systems}.  While a variety of
refinement type systems have been proposed, thus far, there has not been a
satisfactory refinement type system for
algebraic effects and handlers.  In this paper, we fill the void by proposing a
novel refinement type system for languages with algebraic effects and handlers.
%
The expressivity and usefulness of algebraic effects and handlers come
from their ability to manipulate \emph{delimited continuations}, but delimited continuations also complicate programs'
control flow and make their verification harder.
%
To address the complexity,
we introduce a novel concept that we call {\em answer refinement modification} (ARM for
short), which allows the refinement type system to precisely track what effects occur and in what order when a program is executed, and reflect the information as modifications to the refinements in the types of delimited continuations.
%
We formalize our type system that supports ARM (as well as answer \emph{type} modification, or ATM) and prove its soundness. Additionally, as a proof of concept, we have designed a refinement type system that supports our novel ARM and implemented a corresponding type checking and inference algorithm
for a subset of OCaml 5 which comes with a built-in support for effect handlers,
and evaluated it on a number of benchmark programs that use algebraic effects and handlers.
The evaluation demonstrates that ARM is conceptually simple and practically useful.

Finally, a natural alternative to directly reasoning about a program with delimited continuations is to apply a {\em continuation passing style} (CPS) transformation that transforms the program to a pure program without delimited continuations.  We investigate this alternative in the paper, and show that the approach is indeed possible by proposing a novel CPS transformation for algebraic effects and handlers that enjoys bidirectional (refinement-)type-preservation.  We show that there are pros and cons with this approach, namely, while one can use an existing refinement type checking and inference algorithm that can only (directly) handle pure programs, there are issues such as making the inferred types less informative to a user.
\end{abstract}

%% TODO
%% > The code below is generated by the tool at http://dl.acm.org/ccs.cfm.
%% > Please copy and paste the code instead of the example below.
\begin{CCSXML}
% <ccs2012>
%  <concept>
%   <concept_id>10010520.10010553.10010562</concept_id>
%   <concept_desc>Computer systems organization~Embedded systems</concept_desc>
%   <concept_significance>500</concept_significance>
%  </concept>
%  <concept>
%   <concept_id>10010520.10010575.10010755</concept_id>
%   <concept_desc>Computer systems organization~Redundancy</concept_desc>
%   <concept_significance>300</concept_significance>
%  </concept>
%  <concept>
%   <concept_id>10010520.10010553.10010554</concept_id>
%   <concept_desc>Computer systems organization~Robotics</concept_desc>
%   <concept_significance>100</concept_significance>
%  </concept>
%  <concept>
%   <concept_id>10003033.10003083.10003095</concept_id>
%   <concept_desc>Networks~Network reliability</concept_desc>
%   <concept_significance>100</concept_significance>
%  </concept>
% </ccs2012>
\end{CCSXML}
% \ccsdesc[500]{Computer systems organization~Embedded systems}
% \ccsdesc[300]{Computer systems organization~Redundancy}
% \ccsdesc{Computer systems organization~Robotics}
% \ccsdesc[100]{Networks~Network reliability}

%% > Keywords. The author(s) should pick words that accurately describe
%% > the work being presented. Separate the keywords with commas.
%\keywords{algebraic effects and handlers, refinement type system, answer type modification, answer refinement modification, CPS transformation}

% \received{20 February 2007}
% \received[revised]{12 March 2009}
% \received[accepted]{5 June 2009}

\maketitle

\input{intro.tex}

\input{overview.tex}

\input{language.tex}

\input{impl.tex}

\input{cps.tex}

\input{related.tex}

\input{conclusion.tex}

%% TODO
\begin{acks}

\end{acks}

\bibliographystyle{ACM-Reference-Format}
\bibliography{main}

\input{appendix.tex}

\end{document}
\endinput
