\pdfoutput=1
\documentclass[a4paper]{article}

\usepackage[margin=20truemm]{geometry}

\usepackage{amsmath,amssymb,stmaryrd}
\usepackage[inline]{enumitem}

\renewcommand*{\labelitemii}{$\circ$}

\usepackage{proof}
\usepackage{mathtools}
\mathtoolsset{showonlyrefs=true}

\usepackage{thelanguage}
\newcommand*{\defeq}{\stackrel{\text{def}}{=}}
\newcommand{\rulename}[1]{({\mdseries\textsc{#1}})}
\newcommand{\infersc}[3][]{\infer[\!\!\text{\rulename{#1}}]{#2}{#3}}

\usepackage{amsthm}
\theoremstyle{plain}
\newtheorem{theorem}{Theorem}
\newtheorem{lemma}[theorem]{Lemma}
\theoremstyle{definition}
\newtheorem{definition}[theorem]{Definition}
\newtheorem{assumption}[theorem]{Assumption}
\newtheorem{corollary}[theorem]{Corollary}

\usepackage{color, xcolor}
\newcommand{\todo}[1][]{\textcolor{red}{TODO: #1}}


\newcommand{\llabel}[1]{\label{\currentprefix:#1}}
\newcommand{\lref}[2][\currentprefix]{\ref{#1:#2}}

\newlist{enumrm}{enumerate}{3}
\setlist[enumrm]{label=(\roman*)}
\newlist{enumit}{enumerate}{3}
\setlist[enumit]{label=\arabic*., font=\itshape}

\begin{document}

\section{Definitions and Assumptions}

\subsection{Evaluation rules}

\fbox{$c \eval c'$}
\begin{gather}
    \infersc[E-Let]{\explet{x}{c_1}{c_2} \eval \explet{x}{c'_1}{c_2}}
    {c_1 \eval c'_1}
    \quad
    \infersc[E-LetRet]{\explet{x}{\expret{v}}{c_2} \eval c_2[v/x]}
    {}
    \\
    \infersc[E-LetOp]{\explet{x}{\expop{v}{y}{c_1}}{c_2} \eval \expop{v}{y}{\explet{x}{c_1}{c_2}}}
    {}
    \quad
    \infersc[E-IfT]{\expif{\exptrue}{c_1}{c_2} \eval c_1}
    {}
    \\
    \infersc[E-IfF]{\expif{\expfalse}{c_1}{c_2} \eval c_2}
    {}
    \quad
    \infersc[E-App]{(\exprec{f}{x}{c})~v \eval c[v/x][(\exprec{f}{x}{c})/f]}
    {}
    \quad
    \infersc[E-Prim]{p~v \eval \zeta(p, v)}
    {}
    \\
    \text{below, let } h = \{ \expret{x_r} \mapsto c_r, \repi{\op_i(x_i, k_i) \mapsto c_i} \}
    \\
    \infersc[E-Hndl]{\expwith{h}{c} \eval \expwith{h}{c'}}
    {c \eval c'}
    \quad
    \infersc[E-HndlRet]{\expwith{h}{\expret{v}} \eval c_r[v/x_r]}
    {}
    \\
    \infersc[E-HndlOp]{\expwith{h}{\expop[\op_i]{v}{y}{c}} \eval c_i[v/x_i][(\expfun{y}{\expwith{h}{c}})/k_i]}
    {}
\end{gather}

\subsection{Well-formedness of typing contexts, value types, and computation types}

\fbox{$\jdwf{}{\Gamma}$} \quad
\fbox{$\jdwf{\Gamma}{T}$} \quad \fbox{$\jdwf{\Gamma}{C}$} \quad
\fbox{$\jdwf{\Gamma}{\Sigma}$} \quad \fbox{$\jdwf{\Gamma \mid T}{S}$}
\begin{gather}
    \infersc[WE-Empty]{\jdwf{}{\emptyset}}
    {}
    \quad
    \infersc[WE-Var]{\jdwf{}{\Gamma, x: T}}
    {
        \jdwf{}{\Gamma} &
        x \notin \dom(\Gamma) &
        \jdwf{\Gamma}{T}
    }
    \quad
    \infersc[WE-BVar]{\jdwf{}{\Gamma, x: B}}
    {
        \jdwf{}{\Gamma} &
        x \notin \dom(\Gamma)
    }
    \\
    \infersc[WE-PVar]{\jdwf{}{\Gamma, X: \rep{B}}}
    {
        \jdwf{}{\Gamma} &
        X \notin \dom(\Gamma)
    }
    \qquad
    \infersc[WT-Rfn]{\jdwf{\Gamma}{\tyrfn{x}{B}{\phi}}}
    {\Gamma, x: B \vdash \phi}
    \quad
    \infersc[WT-Fun]{\jdwf{\Gamma}{(x: T) \rarr C}}
    {
        \jdwf{\Gamma, x: T}{C}
    }
    \\
    \infersc[WT-Comp]{\jdwf{\Gamma}{\tycomp{\Sigma}{T}{S}}}
    {
        \jdwf{\Gamma}{\Sigma} &
        \jdwf{\Gamma}{T} &
        \jdwf{\Gamma \mid T}{S}
    }
    \qquad
    \infersc[WT-Sig]{\jdwf{\Gamma}{\{ \repi{\op_i : \forall \rep{X_i: \rep{B}_i}. F_i} \}}}
    {\repi{\jdwf{\Gamma, \rep{X_i: \rep{B}_i}}{F_i}}}
    \\
    \infersc[WT-Pure]{\jdwf{\Gamma \mid T}{\square}}
    {\jdwf{}{\Gamma}}
    \quad
    \infersc[WT-ATM]{\jdwf{\Gamma \mid T}{\tyctl{x}{C_1}{C_2}}}
    {
        \jdwf{\Gamma, x: T}{C_1} &
        \jdwf{\Gamma}{C_2}
    }
\end{gather}

\subsection{Syntax of typing contexts of the target language of the CPS transformation}

\begin{gather}
    \Gamma ::= \emptyset \mid \Gamma, x: \tau \mid \Gamma, x: B
        \mid \Gamma, X:\rep{B} \mid \Gamma, \alpha
\end{gather}

\subsection{Well-formedness rules of the target language of the CPS transformation}

\fbox{$\jdwf{}{\Gamma}$} \quad \fbox{$\jdwf{\Gamma}{\tau}$}
\begin{gather}
    \infersc[WEc-Empty]{\jdwf{}{\emptyset}}
    {}
    \quad
    \infersc[WEc-Var]{\jdwf{}{\Gamma, x: \tau}}
    {
        \jdwf{}{\Gamma} &
        x \notin \dom(\Gamma) &
        \jdwf{\Gamma}{\tau}
    }
    \quad
    \infersc[WEc-BVar]{\jdwf{}{\Gamma, x: B}}
    {
        \jdwf{}{\Gamma} &
        x \notin \dom(\Gamma)
    }
    \\
    \infersc[WEc-PVar]{\jdwf{}{\Gamma, X: \rep{B}}}
    {
        \jdwf{}{\Gamma} &
        X \notin \dom(\Gamma)
    }
    \quad
    \infersc[WEc-TVar]{\jdwf{}{\Gamma, \alpha}}
    {
        \jdwf{}{\Gamma} &
        \alpha \notin \dom(\Gamma)
    }
    \\
    \infersc[WTc-Rfn]{\jdwf{\Gamma}{\tyrfn{x}{B}{\phi}}}
    {\Gamma, x: B \vdash \phi}
    \quad
    \infersc[WTc-Fun]{\jdwf{\Gamma}{(x: \tau_1) \rarr \tau_2}}
    {
        \jdwf{\Gamma, x: \tau_1}{\tau_2}
    }
    \quad
    \infersc[WTc-PPoly]{\jdwf{\Gamma}{\forall \rep{X: \rep{B}}. \tau}}
    {
        \jdwf{\Gamma, \rep{X: \rep{B}}}{\tau}
    }
    \\
    \infersc[WTc-Rcd]{\jdwf{\Gamma}{\{\repi{\op_i: \tau_i}\}}}
    {
        \bigrepi{\jdwf{\Gamma}{\tau_i}}
    }
    \quad
    \infersc[WTc-TVar]{\jdwf{\Gamma}{\alpha}}
    {
        \alpha \in \Gamma
    }
    \quad
    \infersc[WTc-TPoly]{\jdwf{\Gamma}{\forall \alpha. \tau}}
    {
        \jdwf{\Gamma, \alpha}{\tau}
    }
    \quad
\end{gather}


\subsection{Typing rules of the target language of the CPS transformation}

\fbox{$\jdty{\Gamma}{c}{\tau}$}
\begin{gather}
    \infersc[Tc-CVar]{\jdty{\Gamma}{x}{\tyrfn{y}{B}{x = y}}}
    {
        \jdwf{}{\Gamma} &
        \Gamma(x) = \tyrfn{y}{B}{\phi}
    }
    \quad
    \infersc[Tc-Var]{\jdty{\Gamma}{x}{\Gamma(x)}}
    {
        \jdwf{}{\Gamma} &
        \forall y, B, \phi. \Gamma(x) \neq \tyrfn{y}{B}{\phi}
    }
    \quad
    \infersc[Tc-Prim]{\jdty{\Gamma}{p}{\tycps(p)}}
    {\jdwf{}{\Gamma}}
    \\
    \infersc[Tc-Fun]{\jdty{\Gamma}{\exprec{f:(x: \tau_1) \rarr \tau_2}{x:\tau_1}{c}}{(x: \tau_1) \rarr \tau_2}}
    {
        \jdty{\Gamma, f: (x: \tau_1) \rarr \tau_2, x: \tau_1}{c}{\tau_2}
    }
    \quad
    % \infersc[Tc-Lam]{\jdty{\Gamma}{\lambda x. c}{(x: \tau_1) \rarr \tau_2}}
    % {
    %     \jdty{x: \tau_1}{c}{\tau_2}
    % }
    % \\
    \infersc[Tc-App]{\jdty{\Gamma}{c~v}{\tau_2[v/x]}}
    {
        \jdty{\Gamma}{c}{(x: \tau_1) \rarr \tau_2} &
        \jdty{\Gamma}{v}{\tau_1}
    }
    \\
    \infersc[Tc-TAbs]{\jdty{\Gamma}{\Lambda \alpha. c}{\forall \alpha. \tau}}
    {\jdty{\Gamma, \alpha}{c}{\tau}}
    \quad
    \infersc[Tc-TApp]{\jdty{\Gamma}{v~\nmbullet}{\tau[\tau'/\alpha]}}
    {
        \jdty{\Gamma}{v}{\forall \alpha. \tau} &
        \jdwf{\Gamma}{\tau'}
    }
    \\
    \infersc[Tc-PAbs]{\jdty{\Gamma}{\Lambda \rep{X: \rep{B}}. c}{\forall \rep{X: \rep{B}}. \tau}}
    {
        \jdty{\Gamma, \rep{X: \rep{B}}}{c}{\tau}
    }
    \quad
    \infersc[Tc-PApp]{\jdty{\Gamma}{c~\rep{A}}{\tau[\rep{A/X}]}}
    {
        \jdty{\Gamma}{c}{\forall \rep{X: \rep{B}}. \tau} &
        \rep{\jdty{\Gamma}{A}{\rep{B}}}
    }
    \\
    \infersc[Tc-Rcd]{\jdty{\Gamma}{\{ \repi{\op_i = v_i} \}}{\{ \repi{\op_i : \tau_i} \}}}
    {
        \repi{\jdty{\Gamma}{v_i}{\tau_i}}
    }
    \quad
    \infersc[Tc-Proj]{\jdty{\Gamma}{v\#\op_i}{\tau_i}}
    {
        \jdty{\Gamma}{v}{\{ \repi{\op_i : \tau_i} \}}
    }
    \\
    \infersc[Tc-If]{\jdty{\Gamma}{\expif{v}{c_1}{c_2}}{\tau}}
    {
        \jdty{\Gamma}{v}{\tyrfn{x}{\tybool}{\phi}} &
        \jdty{\Gamma, v = \exptrue}{c_1}{\tau} &
        \jdty{\Gamma, v = \expfalse}{c_2}{\tau}
    }
    \\
    \infersc[Tc-Ascr]{\jdty{\Gamma}{(c : \tau)}{\tau}}
    {
        \jdty{\Gamma}{c}{\tau'} &
        \jdsub{\Gamma}{\tau'}{\tau} &
        \jdwf{\Gamma}{\tau}
    }
    \quad
    \infersc[Tc-Sub]{\jdty{\Gamma}{c}{\tau_2}}
    {
        \jdty{\Gamma}{c}{\tau_1} &
        \jdsub{\Gamma}{\tau_1}{\tau_2} &
        \jdwf{\Gamma}{\tau_2}
    }
\end{gather}

\subsection{Subtyping rules of the target language of the CPS transformation}

\fbox{$\jdsub{\Gamma}{\tau_1}{\tau_2}$}
\begin{gather}
    \infersc[Sc-Rfn]{\jdsub{\Gamma}{\tyrfn{x}{B}{\phi_1}}{\tyrfn{x}{B}{\phi_2}}}
    {\Gamma, x: B \vDash \phi_1 \implies \phi_2}
    \quad
    \infersc[Sc-Fun]{\jdsub{\Gamma}{(x: \tau_{11}) \rarr \tau_{12}}{(x: \tau_{21}) \rarr \tau_{22}}}
    {
        \jdsub{\Gamma}{\tau_{21}}{\tau_{11}} &
        \jdsub{\Gamma, x: \tau_{21}}{\tau_{12}}{\tau_{22}}
    }
    \\
    \infersc[Sc-PPoly]{\jdsub{\Gamma}{\forall \rep{X: \rep{B}}. \tau_1}{\forall \rep{X: \rep{B}}. \tau_2}}
    {
        \jdsub{\Gamma, \rep{X: \rep{B}}}{\tau_1}{\tau_2}
    }
    \quad
    \infersc[Sc-Rcd]{\jdsub{\Gamma}{\{ \repi{\op_i: \tau_{1i}}, \repi{\op'_i: \tau'_i} \}}{\{ \repi{\op_i:  \tau_{2i}} \}}}
    {\repi{\jdsub{\Gamma}{\tau_{1i}}{\tau_{2i}}}}
    \\
    \infersc[Sc-TVar]{\jdsub{\Gamma}{\alpha}{\alpha}}
    {\alpha \in \Gamma}
    \quad
    \infersc[Sc-Poly]{\jdsub{\Gamma}{\forall \alpha. \tau_1}{\forall \beta. \tau_2}}
    {
        \jdsub{\Gamma, \beta}{\tau_1[\tau/\alpha]}{\tau_2} &
        \jdwf{\Gamma, \beta}{\tau}&
        \beta \notin \fv(\forall \alpha. \tau_1)
    }
\end{gather}

\subsection{CPS transformation of expressions}

\begingroup
\allowdisplaybreaks
\begin{align}
    \cps{x} &\defeq x \\
    \cps{p} &\defeq \mathit{cps}(p) \\
    \cps{\exprec{f^{(x:T_1) \rarr C_1}}{x^{T_2}}{c}} &\defeq \exprec{f:\cps{(x:T_1) \rarr C_1}}{x:\cps{T_2}}{\cps{c}} \\
    \cps{\expret{v^T}} &\defeq \Lambda \alpha. \lambda h:\{\}. \lambda k:\cps{T} \rarr \alpha. k~\cps{v} \\
    \cps{\explet{x}{c_1^{\tycomp{\Sigma}{T_1}{\square}}}{c_2^{\tycomp{\Sigma}{T_2}{\square}}}}
        &\defeq \Lambda \alpha. \lambda h: \cps{\Sigma}. \lambda k:\cps{T_2} \rarr \alpha.
        \cps{c_1}~\nmbullet~h~(\lambda x:\cps{T_1}. \cps{c_2}~\nmbullet~h~k) \\
    & \hspace*{-120pt} \cps{\explet{x}{c_1^{\tycomp{\Sigma}{T_1}{\tyctl{x}{C_1}{C_2}}}}{c_2^{\tycomp{\Sigma}{T_2}{\tyctl{z}{C_0}{C_1}}}}} \defeq \\
        & \hspace*{-90pt} \Lambda \alpha. \lambda h: \cps{\Sigma}. \lambda k:(z:\cps{T_2}) \rarr \cps{C_0}.
        \cps{c_1}~\nmbullet~h~(\lambda x:\cps{T_1}. \cps{c_2}~\nmbullet~h~k) \\
    \cps{v_1~v_2} &\defeq \cps{v_1}~\cps{v_2} \\
    \cps{(\expif{v}{c_1}{c_2})^{C}} &\defeq (\expif{\cps{v}}{\cps{c_1}}{\cps{c_2}} : \cps{C}) \\
    \cps{\expop[\op^{\rep{\mathit{A}}}]{v}{y^{T_y}}{c^{\tycomp{\Sigma}{T}{\tyctl{z}{C_1}{C_2}}}}} &\defeq \\
        & \hspace*{-20pt} \Lambda \alpha. \lambda h:\cps{\Sigma}. \lambda k:(z: \cps{T}) \rarr \cps{C_1}.
        h\#\op~\rep{A}~\cps{v}~(\lambda y:\cps{T_y}. \cps{c}~\nmbullet~h~k) \\
        & (~ \text{where} \ y \notin \fv(\Sigma) \cup \fv(T) \cup (\fv(C_1) \setminus \{z\}) ~) \\
    \cps{\expwith{h}{c}} &\defeq \cps{c}~\nmbullet~\cps{h^{\mathit{ops}}}~\cps{h^{\mathit{ret}}} \\
        \text{where} \hspace{50pt} \quad& \hspace{-50pt} \left\{ \begin{aligned}
        h &= \{ \expret{x_r^{T_r}} \mapsto c_r, \repi{\op_i^{\rep{X_i: \rep{B_i}}}(x_i^{T_{i1}}, k_i^{(y_i:T_{i2}) \rarr C_{i1}}) \mapsto c_i} \} \\
        \cps{h^{\mathit{ret}}} &\defeq \cps{\expret{x_r^{T_r}} \mapsto c_r} \defeq
            \lambda x_r:\cps{T_r}. \cps{c_r} \\
        \cps{h^{\mathit{ops}}} &\defeq \cps{\repi{\op_i^{\rep{X_i: \rep{B_i}}}(x_i^{T_{i1}}, k_i^{(y_i:T_{i2}) \rarr C_{i1}}) \mapsto c_i}} \\
            &\defeq \{ \repi{\op_i = \Lambda \rep{X_i: \rep{B_i}}. \lambda x_i:\cps{T_{i1}}. \lambda k_i:(y_i:\cps{T_{i2}}) \rarr \cps{C_{i1}}. \cps{c_i}} \}
    \end{aligned} \right.
\end{align}
\endgroup

\subsection{CPS transformation of types and typing contexts}

\begin{align}
    \cps{\tyrfn{x}{B}{\phi}} &\defeq \tyrfn{x}{B}{\phi} \\
    \cps{(x: T) \rarr C} &\defeq (x: \cps{T}) \rarr \cps{C} \\
    \cps{\tycomp{\Sigma}{T}{\tyctl{x}{C_1}{C_2}}} &\defeq
        \forall \_. \cps{\Sigma} \rarr ((x: \cps{T}) \rarr \cps{C_1}) \rarr \cps{C_2} \\
    \cps{\tycomp{\Sigma}{T}{\square}} &\defeq
        \forall \alpha. \cps{\Sigma} \rarr (\cps{T} \rarr \alpha) \rarr \alpha \\
    \cps{\{ \repi{\op_i : \forall \rep{X_i: \rep{B}_i}. F_i} \}} &\defeq
        \{ \repi{\op_i : \forall \rep{X_i: \rep{B}_i}. \cps{F_i}^\mathcal{F}} \} \\
    \cps{(x: T_1) \rarr ((y: T_2) \rarr C_1) \rarr C_2}^\mathcal{F} &\defeq
        (x: \cps{T_1}) \rarr \cps{((y: T_2) \rarr C_1)} \rarr \cps{C_2}
\end{align}
\begin{align}
    \cps{\emptyset} &\defeq \emptyset \\
    \cps{\Gamma, x: T} &\defeq \cps{\Gamma}, x: \cps{T} \\
    \cps{\Gamma, x: B} &\defeq \cps{\Gamma}, x: B \\
    \cps{\Gamma, X:\rep{B}} &\defeq \cps{\Gamma}, X:\rep{B}
\end{align}




\subsection{Assumptions on well-formedness judgments of formulas, well-formedness judgments of predicates, and semantic validity judgements of formulas}


\begin{assumption} \label{asm:formla} \quad
    \begin{itemize}
        \item If $\jdwf{\Gamma}{\phi}$, then $\jdwf{}{\Gamma}$.
        \item If $\jdwf{}{\Gamma}$ and $\dom(\Gamma) \supseteq \fv(\phi)$, then $\jdwf{\Gamma}{\phi}$.
        % \item If $\dom(\Gamma) \supseteq \fv(t)$, then $\jdwf{\Gamma}{t = t}$.
        \item If $\jdwf{}{\Gamma, x: T, \Gamma'}$ and $\jdty{\Gamma, \Gamma'}{A}{\rep{B}}$, then $\jdty{\Gamma, x: T, \Gamma'}{A}{\rep{B}}$.
        \item If $\jdwf{}{\Gamma, x: T, \Gamma'}$ and $\jdwf{\Gamma, \Gamma'}{\phi}$, then $\jdwf{\Gamma, x: T, \Gamma'}{\phi}$.
        \item If $\valid{\Gamma, \Gamma'}{\phi}$, then $\valid{\Gamma, x: T, \Gamma'}{\phi}$.
        \item If $\jdty{\Gamma}{v}{T}$ and $\jdty{\Gamma, x: T, \Gamma'}{A}{\rep{B}}$, then $\jdty{\Gamma, \Gamma'[v/x]}{A[v/x]}{\rep{B}}$.
        \item If $\jdty{\Gamma}{v}{T}$ and $\jdwf{\Gamma, x: T, \Gamma'}{\phi}$, then $\jdwf{\Gamma, \Gamma'[v/x]}{\phi[v/x]}$.
        \item If $\jdty{\Gamma}{v}{T}$ and $\valid{\Gamma, x: T, \Gamma'}{\phi}$, then $\valid{\Gamma, \Gamma'[v/x]}{\phi[v/x]}$.
        \item If $\jdty{\Gamma}{A}{\rep{B}}$ and $\jdty{\Gamma, X: \rep{B}, \Gamma'}{A'}{\rep{B'}}$, then $\jdty{\Gamma, \Gamma'[A/X]}{A'[A/X]}{\rep{B'}}$.
        \item If $\jdty{\Gamma}{A}{\rep{B}}$ and $\jdwf{\Gamma, X: \rep{B}, \Gamma'}{\phi}$, then $\jdwf{\Gamma, \Gamma'[A/X]}{\phi[A/X]}$.
        \item If $\jdty{\Gamma}{A}{\rep{B}}$ and $\valid{\Gamma, X: \rep{B}, \Gamma'}{\phi}$, then $\valid{\Gamma, \Gamma'[A/X]}{\phi[A/X]}$.
        \item If $\jdsub{\Gamma}{T_1}{T_2}$, $\jdwf{}{\Gamma, x:T_1, \Gamma'}$ and $\jdty{\Gamma, x:T_2, \Gamma'}{A}{\rep{B}}$, then $\jdty{\Gamma, x:T_1, \Gamma'}{A}{\rep{B}}$.
        \item If $\jdsub{\Gamma}{T_1}{T_2}$, $\jdwf{}{\Gamma, x:T_1, \Gamma'}$ and $\jdwf{\Gamma, x:T_2, \Gamma'}{\phi}$, then $\jdwf{\Gamma, x:T_1, \Gamma'}{\phi}$.
        \item If $\jdsub{\Gamma}{T_1}{T_2}$ and $\valid{\Gamma, x:T_2, \Gamma'}{\phi}$, then $\valid{\Gamma, x:T_1, \Gamma'}{\phi}$.
        \item If $x \notin \fv(\Gamma', \phi)$ and $\jdwf{\Gamma, x: T_0, \Gamma'}{\phi}$, then $\jdwf{\Gamma, \Gamma'}{\phi}$.
        \item If $\jdwf{\Gamma, x: (y: T_1) \rarr C_1, \Gamma'}{\phi}$, then $x \notin \fv(\Gamma', \phi)$.
        % \item If $\vDash \phi$ and $\jdty{\Gamma, \phi, \Gamma'}{A}{\rep{B}}$, then $\jdty{\Gamma, \Gamma'}{A}{\rep{B}}$.
        % \item If $\vDash \phi$ and $\jdwf{\Gamma, \phi, \Gamma'}{\phi'}$, then $\jdwf{\Gamma, \Gamma'}{\phi'}$.
        \item If $\vDash \phi$ and $\valid{\Gamma, \phi, \Gamma'}{\phi'}$, then $\valid{\Gamma, \Gamma'}{\phi'}$.
        \item If $\jdwf{\Gamma}{\phi}$, then $\Gamma \vDash \phi \Rarr \phi$.
        \item If $\Gamma \vDash \phi_1 \Rarr \phi_2$ and $\Gamma \vDash \phi_2 \Rarr \phi_3$, then $\Gamma \vDash \phi_1 \Rarr \phi_3$.
    \end{itemize}
\end{assumption}

\subsection{Assumptions on primitives}

\begin{assumption} \label{asm:prim} \quad
    \begin{itemize}
        \item $\jdwf{}{\ty(p)}$ for all $p$.
        \item If $\ty(p) = (x: T) \rarr C$, then
            $\zeta(p, v)$ is defined and $\jdty{}{\zeta(p, v)}{C[v/x]}$
            for all $v$ such that $\jdty{}{v}{T}$.
        \item If $\ty(p) = \tyrfn{z}{\tybool}{\phi}$, then $p = \exptrue$ or $p = \expfalse$.
    \end{itemize}
\end{assumption}





\section{Proof of Type Safety}

\begin{lemma}[Weakening] \label{lem:weaken} \quad
    \begin{enumerate}
        \item Assume that $\jdwf{}{\Gamma, x: T_0, \Gamma'}$.
            \begin{itemize}
                \item If $\jdwf{\Gamma, \Gamma'}{T}$, then $\jdwf{\Gamma, x: T_0, \Gamma'}{T}$.
                \item If $\jdwf{\Gamma, \Gamma'}{C}$, then $\jdwf{\Gamma, x: T_0, \Gamma'}{C}$.
                \item If $\jdwf{\Gamma, \Gamma'}{\Sigma}$, then $\jdwf{\Gamma, x: T_0, \Gamma'}{\Sigma}$.
                \item If $\jdwf{\Gamma, \Gamma' \mid T}{S}$, then $\jdwf{\Gamma, x: T_0, \Gamma' \mid T}{S}$.
            \end{itemize}
        \item Assume that $\jdwf{}{\Gamma, x: T_0, \Gamma'}$.
            \begin{itemize}
                \item If $\jdty{\Gamma, \Gamma'}{v}{T}$, then $\jdty{\Gamma, x: T_0, \Gamma'}{v}{T}$.
                \item If $\jdty{\Gamma, \Gamma'}{c}{C}$, then $\jdty{\Gamma, x: T_0, \Gamma'}{c}{C}$.
            \end{itemize}
        \item
            \begin{itemize}
                \item If $\jdsub{\Gamma, \Gamma'}{T_1}{T_2}$, then $\jdsub{\Gamma, x: T_0, \Gamma'}{T_1}{T_2}$.
                \item If $\jdsub{\Gamma, \Gamma'}{C_1}{C_2}$, then $\jdsub{\Gamma, x: T_0, \Gamma'}{C_1}{C_2}$.
                \item If $\jdsub{\Gamma, \Gamma'}{\Sigma_1}{\Sigma_2}$, then $\jdsub{\Gamma, x: T_0, \Gamma'}{\Sigma_1}{\Sigma_2}$.
                \item If $\jdsub{\Gamma, \Gamma' \mid T}{S_1}{S_2}$, then $\jdsub{\Gamma, x: T_0, \Gamma' \mid T}{S_1}{S_2}$.
            \end{itemize}
    \end{enumerate}
\end{lemma}
\begin{proof}
    % depends on:: asm:formula
    By simultaneous induction on the derivations.
    The cases for \rulename{WT-Rfn}, \rulename{T-Op} and \rulename{S-Rfn} use Assumption \ref{asm:formla}.
\end{proof}

\begin{lemma}[Narrowing] \label{lem:narrow} \quad
    \begin{enumerate}
        \item Assume that $\jdsub{\Gamma}{T_1}{T_2}$ and $\jdwf{}{\Gamma, x:T_1, \Gamma'}$.
            \begin{itemize}
                \item If $\jdwf{\Gamma, x:T_2, \Gamma'}{T}$, then $\jdwf{\Gamma, x: T_1, \Gamma'}{T}$.
                \item If $\jdwf{\Gamma, x:T_2, \Gamma'}{C}$, then $\jdwf{\Gamma, x: T_1, \Gamma'}{C}$.
                \item If $\jdwf{\Gamma, x:T_2, \Gamma'}{\Sigma}$, then $\jdwf{\Gamma, x: T_1, \Gamma'}{\Sigma}$.
                \item If $\jdwf{\Gamma, x:T_2, \Gamma' \mid T}{S}$, then $\jdwf{\Gamma, x: T_1, \Gamma' \mid T}{S}$.
            \end{itemize}
        \item Assume that $\jdsub{\Gamma}{T_1}{T_2}$ and $\jdwf{}{\Gamma, x:T_1, \Gamma'}$.
            \begin{itemize}
                \item If $\jdty{\Gamma, x:T_2, \Gamma'}{v}{T}$, then $\jdty{\Gamma, x: T_1, \Gamma'}{v}{T}$.
                \item If $\jdty{\Gamma, x:T_2, \Gamma'}{c}{C}$, then $\jdty{\Gamma, x: T_1, \Gamma'}{c}{C}$.
            \end{itemize}
        \item Assume that $\jdsub{\Gamma}{T_1}{T_2}$.
            \begin{itemize}
                \item If $\jdsub{\Gamma, x:T_2, \Gamma'}{T_1'}{T_2'}$, then $\jdsub{\Gamma, x: T_1, \Gamma'}{T_1'}{T_2'}$.
                \item If $\jdsub{\Gamma, x:T_2, \Gamma'}{C_1}{C_2}$, then $\jdsub{\Gamma, x: T_1, \Gamma'}{C_1}{C_2}$.
                \item If $\jdsub{\Gamma, x:T_2, \Gamma'}{\Sigma_1}{\Sigma_2}$, then $\jdsub{\Gamma, x: T_1, \Gamma'}{\Sigma_1}{\Sigma_2}$.
                \item If $\jdsub{\Gamma, x:T_2, \Gamma' \mid T}{S_1}{S_2}$, then $\jdsub{\Gamma, x: T_1, \Gamma' \mid T}{S_1}{S_2}$.
            \end{itemize}
        \item If $\jdsub{\Gamma}{T_1}{T_2}$ and $\jdsub{\Gamma \mid T_2}{S_1}{S_2}$, then $\jdsub{\Gamma \mid T_1}{S_1}{S_2}$.
    \end{enumerate}
\end{lemma}
\begin{proof}
    % depends on:: asm:formula
    By simultaneous induction on the derivations.
    The cases for \rulename{WT-Rfn}, \rulename{T-Op} and \rulename{S-Rfn} use Assumption \ref{asm:formla}.
\end{proof}

\begin{lemma}[Substitution] \label{lem:subst} \quad
    \begin{enumerate}
        \item Assume that $\jdty{\Gamma}{v}{T_0}$.
            \begin{itemize}
                \item If $\jdwf{}{\Gamma, x:T_0, \Gamma'}$, then $\jdwf{}{\Gamma, \Gamma'[v/x]}$.
                \item If $\jdwf{\Gamma, x:T_0, \Gamma'}{T}$, then $\jdwf{\Gamma, \Gamma'[v/x]}{T[v/x]}$.
                \item If $\jdwf{\Gamma, x:T_0, \Gamma'}{C}$, then $\jdwf{\Gamma, \Gamma'[v/x]}{C[v/x]}$.
                \item If $\jdwf{\Gamma, x:T_0, \Gamma'}{\Sigma}$, then $\jdwf{\Gamma, \Gamma'[v/x]}{\Sigma[v/x]}$.
                \item If $\jdwf{\Gamma, x:T_0, \Gamma' \mid T}{S}$, then $\jdwf{\Gamma, \Gamma'[v/x] \mid T[v/x]}{S[v/x]}$.
            \end{itemize}
        \item Assume that $\jdty{\Gamma}{v}{T_0}$.
            \begin{itemize}
                \item If $\jdty{\Gamma, x:T_0, \Gamma'}{v}{T}$, then $\jdty{\Gamma, \Gamma'[v/x]}{v[v/x]}{T[v/x]}$.
                \item If $\jdty{\Gamma, x:T_0, \Gamma'}{c}{C}$, then $\jdty{\Gamma, \Gamma'[v/x]}{c[v/x]}{C[v/x]}$.
            \end{itemize}
        \item Assume that $\jdty{\Gamma}{v}{T_0}$.
            \begin{itemize}
                \item If $\jdsub{\Gamma, x:T_0, \Gamma'}{T_1}{T_2}$, then $\jdsub{\Gamma, \Gamma'[v/x]}{T_1[v/x]}{T_2[v/x]}$.
                \item If $\jdsub{\Gamma, x:T_0, \Gamma'}{C_1}{C_2}$, then $\jdsub{\Gamma, \Gamma'[v/x]}{C_1[v/x]}{C_2[v/x]}$.
                \item If $\jdsub{\Gamma, x:T_0, \Gamma'}{\Sigma_1}{\Sigma_2}$, then $\jdsub{\Gamma, \Gamma'[v/x]}{\Sigma_1[v/x]}{\Sigma_2[v/x]}$.
                \item If $\jdsub{\Gamma, x:T_0, \Gamma' \mid T}{S_1}{S_2}$, then $\jdsub{\Gamma, \Gamma'[v/x] \mid T}{S_1[v/x]}{S_2[v/x]}$.
            \end{itemize}
    \end{enumerate}
\end{lemma}
\begin{proof}
    % depends on:: asm:formula
    By simultaneous induction on the derivations.
    The cases for \rulename{WT-Rfn}, \rulename{T-Op} and \rulename{S-Rfn} use Assumption \ref{asm:formla}.
\end{proof}

\begin{lemma}[Predicate Substitution] \label{lem:subst-pred} \quad
    \begin{enumerate}
        \item Assume that $\jdty{\Gamma}{A}{\rep{B}}$.
            \begin{itemize}
                \item If $\jdwf{}{\Gamma, X: \rep{B}, \Gamma'}$, then $\jdwf{}{\Gamma, \Gamma'[A/X]}$.
                \item If $\jdwf{\Gamma, X: \rep{B}, \Gamma'}{T}$, then $\jdwf{\Gamma, \Gamma'[A/X]}{T[A/X]}$.
                \item If $\jdwf{\Gamma, X: \rep{B}, \Gamma'}{C}$, then $\jdwf{\Gamma, \Gamma'[A/X]}{C[A/X]}$.
                \item If $\jdwf{\Gamma, X: \rep{B}, \Gamma'}{\Sigma}$, then $\jdwf{\Gamma, \Gamma'[A/X]}{\Sigma[A/X]}$.
                \item If $\jdwf{\Gamma, X: \rep{B}, \Gamma' \mid T}{S}$, then $\jdwf{\Gamma, \Gamma'[A/X] \mid T[A/X]}{S[A/X]}$.
            \end{itemize}
        \item Assume that $\jdty{\Gamma}{A}{\rep{B}}$.
            \begin{itemize}
                \item If $\jdty{\Gamma, X: \rep{B}, \Gamma'}{v}{T}$, then $\jdty{\Gamma, \Gamma'[A/X]}{v[A/X]}{T[A/X]}$.
                \item If $\jdty{\Gamma, X: \rep{B}, \Gamma'}{c}{C}$, then $\jdty{\Gamma, \Gamma'[A/X]}{c[A/X]}{C[A/X]}$.
            \end{itemize}
        \item Assume that $\jdty{\Gamma}{A}{\rep{B}}$.
            \begin{itemize}
                \item If $\jdsub{\Gamma, X: \rep{B}, \Gamma'}{T_1}{T_2}$, then $\jdsub{\Gamma, \Gamma'[A/X]}{T_1[A/X]}{T_2[A/X]}$.
                \item If $\jdsub{\Gamma, X: \rep{B}, \Gamma'}{C_1}{C_2}$, then $\jdsub{\Gamma, \Gamma'[A/X]}{C_1[A/X]}{C_2[A/X]}$.
                \item If $\jdsub{\Gamma, X: \rep{B}, \Gamma'}{\Sigma_1}{\Sigma_2}$, then $\jdsub{\Gamma, \Gamma'[A/X]}{\Sigma_1[A/X]}{\Sigma_2[A/X]}$.
                \item If $\jdsub{\Gamma, X: \rep{B}, \Gamma' \mid T}{S_1}{S_2}$, then $\jdsub{\Gamma, \Gamma'[A/X] \mid T}{S_1[A/X]}{S_2[A/X]}$.
            \end{itemize}
    \end{enumerate}
\end{lemma}
\begin{proof}
    % depends on:: asm:formula
    By simultaneous induction on the derivations.
    The cases for \rulename{WT-Rfn}, \rulename{T-Op} and \rulename{S-Rfn} use Assumption \ref{asm:formla}.
\end{proof}

\begin{lemma}[Remove unused type bindings] \label{lem:rm-unused} \quad
    \begin{itemize}
        \item If $x \notin \fv(\Gamma')$ and $\jdwf{}{\Gamma, x:T_0, \Gamma'}$, then $\jdwf{}{\Gamma, \Gamma'}$.
        \item If $x \notin \fv(\Gamma', T)$ and $\jdwf{\Gamma, x:T_0, \Gamma'}{T}$, then $\jdwf{\Gamma, \Gamma'}{T}$.
        \item If $x \notin \fv(\Gamma', C)$ and $\jdwf{\Gamma, x:T_0, \Gamma'}{C}$, then $\jdwf{\Gamma, \Gamma'}{C}$.
        \item If $x \notin \fv(\Gamma', \Sigma)$ and $\jdwf{\Gamma, x:T_0, \Gamma'}{\Sigma}$, then $\jdwf{\Gamma, \Gamma'}{\Sigma}$.
        \item If $x \notin \fv(\Gamma', T, S)$ and $\jdwf{\Gamma, x:T_0, \Gamma' \mid T}{S}$, then $\jdwf{\Gamma, \Gamma' \mid T}{S}$.
    \end{itemize}
\end{lemma}
\begin{proof}
    % depends on:: asm:formula
    By simultaneous induction on the derivations.
    The case for \rulename{WT-Rfn} uses Assumption \ref{asm:formla}.
\end{proof}

\begin{lemma}[Variables of non-refinement types do not appear in types] \label{lem:notin-nonrfn} \quad
    \begin{itemize}
        \item If $\jdwf{}{\Gamma, x:(y:T_1) \rarr C_1, \Gamma'}$, then $x \notin \fv(\Gamma')$.
        \item If $\jdwf{\Gamma, x:(y:T_1) \rarr C_1, \Gamma'}{T}$, then $x \notin \fv(\Gamma', T)$.
        \item If $\jdwf{\Gamma, x:(y:T_1) \rarr C_1, \Gamma'}{C}$, then $x \notin \fv(\Gamma', C)$.
        \item If $\jdwf{\Gamma, x:(y:T_1) \rarr C_1, \Gamma'}{\Sigma}$, then $x \notin \fv(\Gamma', \Sigma)$.
        \item If $\jdwf{\Gamma, x:(y:T_1) \rarr C_1, \Gamma' \mid T}{S}$, then $x \notin \fv(\Gamma', T, S)$.
    \end{itemize}
\end{lemma}
\begin{proof}
    % depends on:: asm:formula
    By simultaneous induction on the derivations.
    The case for \rulename{WT-Rfn} uses Assumption \ref{asm:formla}.
\end{proof}

\begin{lemma}[Remove non-refinement type bindings] \label{lem:rm-nonrfn} \quad
    \begin{itemize}
        \item If $\jdwf{}{\Gamma, x:(y:T_1) \rarr C_1, \Gamma'}$, then $\jdwf{}{\Gamma, \Gamma'}$.
        \item If $\jdwf{\Gamma, x:(y:T_1) \rarr C_1, \Gamma'}{T}$, then $\jdwf{\Gamma, \Gamma'}{T}$.
        \item If $\jdwf{\Gamma, x:(y:T_1) \rarr C_1, \Gamma'}{C}$, then $\jdwf{\Gamma, \Gamma'}{C}$.
        \item If $\jdwf{\Gamma, x:(y:T_1) \rarr C_1, \Gamma'}{\Sigma}$, then $\jdwf{\Gamma, \Gamma'}{\Sigma}$.
        \item If $\jdwf{\Gamma, x:(y:T_1) \rarr C_1, \Gamma' \mid T}{S}$, then $\jdwf{\Gamma, \Gamma' \mid T}{S}$.
    \end{itemize}
\end{lemma}
\begin{proof}
    Immediate by Lemma \ref{lem:notin-nonrfn} and \ref{lem:rm-unused}.
\end{proof}

\begin{lemma}[Well-formedness of typing contexts from other judgements] \label{lem:wfg} \quad
    \begin{enumerate}
        \item If $\jdwf{\Gamma}{T}$, then $\jdwf{}{\Gamma}$.
        \item If $\jdwf{\Gamma}{C}$, then $\jdwf{}{\Gamma}$.
        \item If $\jdwf{\Gamma}{\Sigma}$, then $\jdwf{}{\Gamma}$.
        \item If $\jdwf{\Gamma \mid T}{S}$, then $\jdwf{}{\Gamma}$.
    \end{enumerate}
\end{lemma}
\begin{proof}
    By simultaneous induction on the derivations.
\end{proof}

\begin{lemma}[Well-formedness of types from other judgements] \label{lem:wft} \quad
    \begin{enumerate}
        \item If $\jdty{\Gamma}{v}{T}$, then $\jdwf{\Gamma}{T}$.
        \item If $\jdty{\Gamma}{c}{C}$, then $\jdwf{\Gamma}{C}$.
    \end{enumerate}
\end{lemma}
\input{proofs/wf-type.tex}

\begin{lemma}[Canonical forms] \label{lem:cano} \quad
    \begin{enumerate}
        \item If $\jdty{}{v}{(x: T) \rarr C}$, then (i) $v = \exprec{f}{x}{c}$ for some $f, c$,
            or (ii) $v = p$ for some $p$ and $\zeta(p, v)$ is defined for all $v$ such that $\jdty{}{v}{T}$.
        \item If $\jdty{}{v}{\tyrfn{x}{\tybool}{\phi}}$, then $v = \exptrue$ or $v = \expfalse$.
    \end{enumerate}
\end{lemma}
\begin{proof}
    % depends on:: asm:prim lem:wft
    By induction on the derivations.
    \begin{enumit}
        \item 
        \begin{description}
            \item[Case \rulename{T-Fun}:] Obvious.
            \item[Case \rulename{T-Prim}:] Immediate from Assumption \ref{asm:prim}.
            \item[Case \rulename{T-VSub}:] By the IH and inversion of the subtyping judgment.
                The case for (ii) uses Lemma \ref{lem:wft}.
            \item[Otherwise:] Contradictory.
        \end{description}
        \item 
        \begin{description}
            \item[Case \rulename{T-Prim}:] Immediate from Assumption \ref{asm:prim}.
            \item[Case \rulename{T-VSub}:] By the IH and inversion of the subtyping judgment.
            \item[Otherwise:] Contradictory.
        \end{description}

    \end{enumit}
\end{proof}

\begin{theorem}[Progress]
    If $\jdty{}{c}{\tycomp{\Sigma}{T}{S}}$, then either
    \begin{itemize}
        \item $c = \expret{v}$ for some $v$,
        \item $c = \expop{v}{y}{c_1}$ for some $\op, v, y, c_1$ s.t. $\op \in \dom(\Sigma)$, or
        \item $c \eval c'$ for some $c'$.
    \end{itemize}
\end{theorem}
\input{proofs/progress.tex}


\subsection{Subject Reduction}

\begin{lemma}[Remove tautology] \label{lem:rm-tauto} \quad
    \begin{enumerate}
        \item If $\jdwf{}{\Gamma, \phi, \Gamma'}$, then $\jdwf{}{\Gamma, \Gamma'}$.
        \item 
            \begin{itemize}
                \item If $\jdwf{\Gamma, \phi, \Gamma'}{T}$, then $\jdwf{\Gamma, \Gamma'}{T}$.
                \item If $\jdwf{\Gamma, \phi, \Gamma'}{C}$, then $\jdwf{\Gamma, \Gamma'}{C}$.
                \item If $\jdwf{\Gamma, \phi, \Gamma'}{\Sigma}$, then $\jdwf{\Gamma, \Gamma'}{\Sigma}$.
                \item If $\jdwf{\Gamma, \phi, \Gamma' \mid T}{S}$, then $\jdwf{\Gamma, \Gamma' \mid T}{S}$.
            \end{itemize}
        \item Assume that $\vDash \phi$.
            \begin{itemize}
                \item If $\jdty{\Gamma, \phi, \Gamma'}{v}{T}$, then $\jdty{\Gamma, \Gamma'}{v}{T}$.
                \item If $\jdty{\Gamma, \phi, \Gamma'}{c}{C}$, then $\jdty{\Gamma, \Gamma'}{c}{C}$.
            \end{itemize}
        \item Assume that $\vDash \phi$.
            \begin{itemize}
                \item If $\jdsub{\Gamma, \phi, \Gamma'}{T_1'}{T_2'}$, then $\jdsub{\Gamma, \Gamma'}{T_1'}{T_2'}$.
                \item If $\jdsub{\Gamma, \phi, \Gamma'}{C_1}{C_2}$, then $\jdsub{\Gamma, \Gamma'}{C_1}{C_2}$.
                \item If $\jdsub{\Gamma, \phi, \Gamma'}{\Sigma_1}{\Sigma_2}$, then $\jdsub{\Gamma, \Gamma'}{\Sigma_1}{\Sigma_2}$.
                \item If $\jdsub{\Gamma, \phi, \Gamma' \mid T}{S_1}{S_2}$, then $\jdsub{\Gamma, \Gamma' \mid T}{S_1}{S_2}$.
            \end{itemize}
    \end{enumerate}
\end{lemma}
\begin{proof} \quad
    % depends on:: asm:formula lem:rm-unused
    \begin{enumit}
        \item Immediate by Lemma \ref{lem:rm-unused}.
        \item Immediate by Lemma \ref{lem:rm-unused}.
        \item By simultaneous induction on the derivations.
        \item By simultaneous induction on the derivations.
            The case for \rulename{S-Rfn} uses Assumption \ref{asm:formla}.
    \end{enumit}
\end{proof}

\begin{lemma}[Reflexivity of subtyping] \label{lem:refl} \quad
    \begin{enumerate}
        \item If $\jdwf{\Gamma}{T}$, then $\jdsub{\Gamma}{T}{T}$.
        \item If $\jdwf{\Gamma}{C}$, then $\jdsub{\Gamma}{C}{C}$.
        \item If $\jdwf{\Gamma}{\Sigma}$, then $\jdsub{\Gamma}{\Sigma}{\Sigma}$.
        \item If $\jdwf{\Gamma \mid T}{S}$, then $\jdsub{\Gamma \mid T}{S}{S}$.
    \end{enumerate}
\end{lemma}
\begin{proof}
    % depend on:: asm:formula
    By simultaneous induction on the derivations.
    The case for \rulename{WT-Rfn} uses Assumption \ref{asm:formla}.
\end{proof}

\begin{lemma}[Transitivity of subtyping] \label{lem:trans} \quad
    \begin{enumerate}
        \item If $\jdsub{\Gamma}{T_1}{T_2}$ and $\jdsub{\Gamma}{T_2}{T_3}$, then $\jdsub{\Gamma}{T_1}{T_3}$.
        \item If $\jdsub{\Gamma}{C_1}{C_2}$ and $\jdsub{\Gamma}{C_2}{C_3}$, then $\jdsub{\Gamma}{C_1}{C_3}$.
        \item If $\jdsub{\Gamma}{\Sigma_1}{\Sigma_2}$ and $\jdsub{\Gamma}{\Sigma_2}{\Sigma_3}$, then $\jdsub{\Gamma}{\Sigma_1}{\Sigma_3}$.
        \item If $\jdsub{\Gamma \mid T}{S_1}{S_2}$ and $\jdsub{\Gamma \mid T}{S_2}{S_3}$, then $\jdsub{\Gamma \mid T}{S_1}{S_3}$.
    \end{enumerate}
\end{lemma}
\input{proofs/trans.tex}

\begin{lemma}[Inversion] \label{lem:inv} \quad
    \begin{enumerate}
        \item If $\jdty{\Gamma}{p}{T}$, then
            \begin{itemize}
                \item $\jdsub{\Gamma}{\ty(p)}{T}$, and
                \item $\jdty{\Gamma}{p}{\ty(p)}$.
            \end{itemize}
        \item If $\jdty{\Gamma}{\exprec{f}{x}{c}}{(x: T) \rarr C}$, then
            there exist some $T_0$ and $C_0$ such that
            \begin{itemize}
                \item $\jdty{\Gamma}{\exprec{f}{x}{c}}{(x: T_0) \rarr C_0}$,
                \item $\jdsub{\Gamma}{(x: T_0) \rarr C_0}{(x: T) \rarr C}$, and
                \item $\jdty{\Gamma, f: (x: T_0) \rarr C_0, x: T_0}{c}{C_0}$.
            \end{itemize}
        \item If $\jdty{\Gamma}{\expret{v}}{\tycomp{\Sigma}{T}{S}}$, then
            there exist some $T'$ such that
            \begin{itemize}
                \item $\jdsub{\Gamma}{T'}{T}$,
                \item $\jdty{\Gamma}{v}{T'}$, and
                \item $\jdsub{\Gamma \mid T'}{\square}{S}$.
            \end{itemize}
        \item If $\jdty{\Gamma}{\expop{v}{y}{c}}{\tycomp{\Sigma}{T}{S}}$, then
            there exist some $\rep{X}, \rep{\rep{B}}, \rep{A}, x, z, T', T_1, T_2, C_0, C_1$, and $C_2$ such that
            \begin{itemize}
                \item $\Sigma \ni \op: \forall \rep{X: \rep{B}}. (x: T_1) \rarr ((y: T_2) \rarr C_1) \rarr C_2$,
                \item $\rep{\jdty{\Gamma}{A}{\rep{B}}}$,
                \item $\jdty{\Gamma}{v}{T_1[\rep{A/X}]}$,
                \item $\jdsub{\Gamma}{T'}{T}$,
                \item $\jdty{\Gamma, y: T_2[\rep{A/X}][v/x]}{c}{\tycomp{\Sigma}{T'}{\tyctl{z}{C_0}{C_1[\rep{A/X}][v/x]}}}$,
                \item $\jdsub{\Gamma \mid T'}{\tyctl{z}{C_0}{C_2[\rep{A/X}][v/x]}}{S}$, and
                \item $y \notin \fv(\Sigma) \cup \fv(T) \cup \fv(T') \cup (\fv(C_0) \setminus \{ z \})$.
            \end{itemize}
    \end{enumerate}
\end{lemma}
\input{proofs/inversion.tex}

\begin{theorem}[Subject reduction]
    If $\jdty{}{c}{C}$ and $c \eval c'$, then $\jdty{}{c'}{C}$.
\end{theorem}
\input{proofs/subject-reduction.tex}


\section{Proof of type preservation of the CPS transformation}

\subsection{Basic properties for the target language of the CPS transformation}

\begin{assumption} \label{asm:cps:formula} \quad
    \begin{itemize}
        \item If $\jdwf{}{\Gamma}$ and $\dom(\Gamma) \supseteq \fv(\phi)$, then $\jdwf{\Gamma}{\phi}$.
        \item If $\jdwf{\Gamma}{\phi}$, then $\jdwf{}{\Gamma}$.
        \item If $\jdwf{\Gamma}{\phi}$, then $\Gamma \vDash \phi \Rarr \phi$.
        \item If $\Gamma \vDash \phi_1 \Rarr \phi_2$ and $\Gamma \vDash \phi_2 \Rarr \phi_3$, then $\Gamma \vDash \phi_1 \Rarr \phi_3$.
        \item If $\jdty{\Gamma}{v}{\tau}$ and $\jdty{\Gamma, x: \tau, \Gamma'}{A}{\rep{B}}$, then $\jdty{\Gamma, \Gamma'[v/x]}{A[v/x]}{\rep{B}}$.
        \item If $\jdty{\Gamma}{v}{\tau}$ and $\jdwf{\Gamma, x: \tau, \Gamma'}{\phi}$, then $\jdwf{\Gamma, \Gamma'[v/x]}{\phi[v/x]}$.
        \item If $\jdty{\Gamma}{v}{\tau}$ and $\valid{\Gamma, x: \tau, \Gamma'}{\phi}$, then $\valid{\Gamma, \Gamma'[v/x]}{\phi[v/x]}$.
        \item If $\jdty{\Gamma}{A}{\rep{B}}$ and $\jdty{\Gamma, X: \rep{B}, \Gamma'}{A'}{\rep{B'}}$, then $\jdty{\Gamma, \Gamma'[A/X]}{A'[A/X]}{\rep{B'}}$.
        \item If $\jdty{\Gamma}{A}{\rep{B}}$ and $\jdwf{\Gamma, X: \rep{B}, \Gamma'}{\phi}$, then $\jdwf{\Gamma, \Gamma'[A/X]}{\phi[A/X]}$.
        \item If $\jdty{\Gamma}{A}{\rep{B}}$ and $\valid{\Gamma, X: \rep{B}, \Gamma'}{\phi}$, then $\valid{\Gamma, \Gamma'[A/X]}{\phi[A/X]}$.
        \item If $\jdwf{}{\Gamma_1, \Gamma_2, \Gamma_3}$ and $\jdwf{\Gamma_1, \Gamma_2}{\phi}$, then $\jdwf{\Gamma_1, \Gamma_2, \Gamma_3}{\phi}$.
        \item If $\jdwf{}{\Gamma_1, \Gamma_2, \Gamma_3}$ and $\jdty{\Gamma_1, \Gamma_2}{A}{\rep{B}}$, then $\jdty{\Gamma_1, \Gamma_2, \Gamma_3}{A}{\rep{B}}$.
        \item If $\jdwf{}{\Gamma_1, \Gamma_2, \Gamma_3}$ and $\Gamma_1, \Gamma_2 \vDash \phi$, then $\Gamma_1, \Gamma_2, \Gamma_3 \vDash \phi$.
        \item If $\jdsub{\Gamma}{\tau_1}{\tau_2}$, $\jdwf{}{\Gamma, x:\tau_1, \Gamma'}$ and $\jdty{\Gamma, x:\tau_2, \Gamma'}{A}{\rep{B}}$, then $\jdty{\Gamma, x:\tau_1, \Gamma'}{A}{\rep{B}}$.
        \item If $\jdsub{\Gamma}{\tau_1}{\tau_2}$, $\jdwf{}{\Gamma, x:\tau_1, \Gamma'}$ and $\jdwf{\Gamma, x:\tau_2, \Gamma'}{\phi}$, then $\jdwf{\Gamma, x:\tau_1, \Gamma'}{\phi}$.
        \item If $\jdsub{\Gamma}{\tau_1}{\tau_2}$ and $\valid{\Gamma, x:\tau_2, \Gamma'}{\phi}$, then $\valid{\Gamma, x:\tau_1, \Gamma'}{\phi}$.
        \item If $x \notin \fv(\Gamma', \phi)$ and $\jdwf{\Gamma, x: \tau_0, \Gamma'}{\phi}$, then $\jdwf{\Gamma, \Gamma'}{\phi}$.
        \item If $x \notin \fv(\Gamma', A)$ and $\jdty{\Gamma, x: \tau_0, \Gamma'}{A}{\rep{B}}$, then $\jdty{\Gamma, \Gamma'}{A}{\rep{B}}$.
        \item If $\jdwf{\Gamma, x: \tau, \Gamma'}{\phi}$ and $\tau$ is not a refinement type, then $x \notin \fv(\Gamma', \phi)$.
        \item If $\jdty{\Gamma, x: \tau, \Gamma'}{A}{\rep{B}}$ and $\tau$ is not a refinement type, then $x \notin \fv(\Gamma', A)$.
        \item If $\Gamma, x: \tau, \Gamma' \vDash \phi$ and $\tau$ is not a refinement type, then $x \notin \fv(\Gamma', \phi)$ and $\Gamma, \Gamma' \vDash \phi$.
        \item If $\alpha \notin \fv(\Gamma', \phi)$ and $\jdwf{\Gamma, \alpha, \Gamma'}{\phi}$, then $\jdwf{\Gamma, \Gamma'}{\phi}$.
        \item If $\alpha \notin \fv(\Gamma', \phi)$ and $\Gamma, \alpha, \Gamma' \vDash \phi$, then $\Gamma, \Gamma' \vDash \phi$.
    \end{itemize}
\end{assumption}

\begin{assumption} \label{asm:cps:prim} \quad
    \begin{itemize}
        \item $\jdwf{}{\tycps(p)}$ for all $p$.
    \end{itemize}
\end{assumption}

\begin{lemma}[Weakening] \label{lem:cps:weaken} \quad
    Assume that $\jdwf{}{\Gamma_1, \Gamma_2, \Gamma_3}$.
    \begin{itemize}
        \item If $\jdwf{\Gamma_1, \Gamma_3}{\tau}$, then $\jdwf{\Gamma_1, \Gamma_2, \Gamma_3}{\tau}$.
        \item If $\jdty{\Gamma_1, \Gamma_3}{c}{\tau}$, then $\jdty{\Gamma_1, \Gamma_2, \Gamma_3}{c}{\tau}$.
        \item If $\jdsub{\Gamma_1, \Gamma_3}{\tau_1}{\tau_2}$, then $\jdsub{\Gamma_1, \Gamma_2, \Gamma_3}{\tau_1}{\tau_2}$.
    \end{itemize}
\end{lemma}
\begin{proof}
    By induction on the derivation. Assumption \ref{asm:cps:formula} is used.
\end{proof}

\begin{lemma}[Narrowing] \label{lem:cps:narrow}
    Assume that $\jdsub{\Gamma}{\tau_1}{\tau_2}$.
    \begin{itemize}
        \item If $\jdwf{}{\Gamma, x: \tau_1, \Gamma'}$ and $\jdwf{\Gamma, x: \tau_2, \Gamma'}{\tau}$,
            then $\jdwf{\Gamma, x: \tau_1, \Gamma'}{\tau}$.
        \item If $\jdwf{}{\Gamma, x: \tau_1, \Gamma'}$ and $\jdty{\Gamma, x: \tau_2, \Gamma'}{c}{\tau}$,
            then $\jdty{\Gamma, x: \tau_1, \Gamma'}{c}{\tau}$.
        \item If $\jdsub{\Gamma, x: \tau_2, \Gamma'}{\tau_1}{\tau_2}$,
            then $\jdsub{\Gamma, x: \tau_1, \Gamma'}{\tau_1}{\tau_2}$.
    \end{itemize}
\end{lemma}
\begin{proof}
    By induction on the derivation. Assumption \ref{asm:cps:formula} is used.
\end{proof}

\begin{lemma}[Remove unused type bindings] \label{lem:cps:rm-unused} \quad
    \begin{itemize}
        \item If $x \notin \fv(\Gamma')$ and $\jdwf{}{\Gamma, x: \tau_0, \Gamma'}$,
            then $\jdwf{}{\Gamma, \Gamma'}$.
        \item If $x \notin \fv(\Gamma', \tau)$ and $\jdwf{\Gamma, x: \tau_0, \Gamma'}{\tau}$,
            then $\jdwf{\Gamma, \Gamma'}{\tau}$.
    \end{itemize}
\end{lemma}
\begin{proof}
    By induction on the derivation.
    The case for \rulename{WTc-Rfn} uses Assumption \ref{asm:cps:formula}.
\end{proof}

\begin{lemma}[Variables of non-refinement types do not apper in types] \label{lem:cps:notin-nonrfn}
    Assume that $\tau_0$ is not a refinement type.
    \begin{itemize}
        \item If $\jdwf{}{\Gamma, x: \tau_0, \Gamma'}$, then  $x \notin \fv(\Gamma')$.
        \item If $\jdwf{\Gamma, x: \tau_0, \Gamma'}{\tau}$, then $x \notin \fv(\Gamma', \tau)$.
    \end{itemize}
\end{lemma}
\begin{proof}
    By induction on the derivation.
    The case for \rulename{WTc-Rfn} uses Assumption \ref{asm:cps:formula}.
\end{proof}

\begin{lemma}[Remove non-refinement type bindings] \label{lem:cps:rm-nonrfn}
    Assume that $\tau_0$ is not a refinement type.
    \begin{enumerate}
        \item If $\jdwf{}{\Gamma, x: \tau_0, \Gamma'}$,
            then $\jdwf{}{\Gamma, \Gamma'}$.
        \item If $\jdwf{\Gamma, x: \tau_0, \Gamma'}{\tau}$,
            then $\jdwf{\Gamma, \Gamma'}{\tau}$.
        \item If $x \notin \fv(c)$ and $\jdty{\Gamma, x: \tau_0, \Gamma'}{c}{\tau}$,
            then $\jdty{\Gamma, \Gamma'}{c}{\tau}$.
        \item If $\jdsub{\Gamma, x: \tau_0, \Gamma'}{\tau_1}{\tau_2}$,
            then $\jdsub{\Gamma, \Gamma'}{\tau_1}{\tau_2}$.
    \end{enumerate}
\end{lemma}
\begin{proof}
    \begin{enumit}
        \item Immediate by Lemma \ref{lem:cps:notin-nonrfn} and \ref{lem:cps:rm-unused}.
        \item Immediate by Lemma \ref{lem:cps:notin-nonrfn} and \ref{lem:cps:rm-unused}.
        \item By induction on the derivation.
            The case for \rulename{Tc-PApp} uses Assumption \ref{asm:cps:formula}.
        \item By induction on the derivation.
            The case for \rulename{Sc-Rfn} uses Assumption \ref{asm:cps:formula}.
        \end{enumit}
\end{proof}

\begin{lemma}[Remove unused type variable bindings] \label{lem:cps:rm-unused-tvar} \quad
    \begin{itemize}
        \item If $\alpha \notin \fv(\Gamma')$
            and $\jdwf{}{\Gamma, \alpha, \Gamma'}$,
            then $\jdwf{}{\Gamma, \Gamma'}$.
        \item If $\alpha \notin \fv(\Gamma', \tau)$
            and $\jdwf{\Gamma, \alpha, \Gamma'}{\tau}$,
            then $\jdwf{\Gamma, \Gamma'}{\tau}$.
        \item If $\alpha \notin \fv(\Gamma', \tau_1, \tau_2)$
            and $\jdsub{\Gamma, \alpha, \Gamma'}{\tau_1}{\tau_2}$,
            then $\jdsub{\Gamma, \Gamma'}{\tau_1}{\tau_2}$.
    \end{itemize}
\end{lemma}
\begin{proof}
    By induction on the derivation.
    The case for \rulename{WTSc-Rfn} and \rulename{Sc-Rfn} uses Assumption \ref{asm:cps:formula}.
\end{proof}

\begin{lemma}[Substitution] \label{lem:cps:subst}
    Assume that $\jdty{\Gamma}{v}{\tau_0}$.
    \begin{itemize}
        \item If $\jdwf{}{\Gamma, x: \tau_0, \Gamma'}$,
            then $\jdwf{}{\Gamma, \Gamma'[v/x]}$.
        \item If $\jdwf{\Gamma, x: \tau_0, \Gamma'}{\tau}$,
            then $\jdwf{\Gamma, \Gamma'[v/x]}{\tau[v/x]}$.
        \item If $\jdty{\Gamma, x: \tau_0, \Gamma'}{c}{\tau}$,
            then $\jdty{\Gamma, \Gamma'[v/x]}{c[v/x]}{\tau[v/x]}$.
        \item If $\jdsub{\Gamma, x: \tau_0, \Gamma'}{\tau_1}{\tau_2}$,
            then $\jdsub{\Gamma, \Gamma'[v/x]}{\tau_1[v/x]}{\tau_2[v/x]}$.
    \end{itemize}
\end{lemma}
\begin{proof}
    By induction on the derivation. Assumption \ref{asm:cps:formula} is used.
\end{proof}

\begin{lemma}[Predicate substitution] \label{lem:cps:subst-pred}
    Assume that $\jdty{\Gamma}{A}{\rep{B}}$.
    \begin{itemize}
        \item If $\jdwf{}{\Gamma, X: \rep{B}, \Gamma'}$,
            then $\jdwf{}{\Gamma, \Gamma'[A/X]}$.
        \item If $\jdwf{\Gamma, X: \rep{B}, \Gamma'}{\tau}$,
            then $\jdwf{\Gamma, \Gamma'[A/X]}{\tau[A/X]}$.
        \item If $\jdty{\Gamma, X: \rep{B}, \Gamma'}{c}{\tau}$,
            then $\jdty{\Gamma, \Gamma'[A/X]}{c[A/X]}{\tau[A/X]}$.
        \item If $\jdsub{\Gamma, X: \rep{B}, \Gamma'}{\tau_1}{\tau_2}$,
            then $\jdsub{\Gamma, \Gamma'[A/X]}{\tau_1[A/X]}{\tau_2[A/X]}$.
    \end{itemize}
\end{lemma}
\begin{proof}
    By induction on the derivation. Assumption \ref{asm:cps:formula} is used.
\end{proof}

\begin{lemma}[Type substitution] \label{lem:cps:subst-type}
    Assume that $\jdwf{\Gamma}{\tau_0}$.
    \begin{itemize}
        \item If $\jdwf{}{\Gamma, \alpha, \Gamma'}$,
            then $\jdwf{}{\Gamma, \Gamma'[\tau_0/\alpha]}$.
        \item If $\jdwf{\Gamma, \alpha, \Gamma'}{\tau}$,
            then $\jdwf{\Gamma, \Gamma'[\tau_0/\alpha]}{\tau[\tau_0/\alpha]}$.
        \item If $\jdty{\Gamma, \alpha, \Gamma'}{c}{\tau}$,
            then $\jdty{\Gamma, \Gamma'[\tau_0/\alpha]}{c[\tau_0/\alpha]}{\tau[\tau_0/\alpha]}$.
        \item If $\jdsub{\Gamma, \alpha, \Gamma'}{\tau_1}{\tau_2}$,
            then $\jdsub{\Gamma, \Gamma'[\tau_0/\alpha]}{\tau_1[\tau_0/\alpha]}{\tau_2[\tau_0/\alpha]}$.
    \end{itemize}
\end{lemma}
\begin{proof}
    By induction on the derivation. Assumption \ref{asm:cps:formula} is used.
\end{proof}

\begin{lemma}[Well-formedness of typing contexts from that of types] \label{lem:cps:wfg}
    If $\jdwf{\Gamma}{\tau}$, then $\jdwf{}{\Gamma}$.
\end{lemma}
\begin{proof}
    By induction on the derivation.
    The case for \rulename{WTc-Rfn} uses Assumption \ref{asm:cps:formula}.
\end{proof}

\begin{lemma}[Well-formedness of types from typings] \label{lem:cps:wft}
    If $\jdty{\Gamma}{c}{\tau}$, then $\jdwf{\Gamma}{\tau}$.
\end{lemma}
\begin{proof}
    By induction on the derivation.
    \begin{description}
        \item[Case \rulename{Tc-CVar}:] By Assumption \ref{asm:cps:formula}.
        \item[Case \rulename{Tc-Var}:] By Lemma \ref{lem:cps:weaken}.
        \item[Case \rulename{Tc-Prim}:]
            By Assumption \ref{asm:cps:prim} and Lemma \ref{lem:cps:weaken}.
        \item[Case \rulename{Tc-Fun}:]
            By the IH, Lemma \ref{lem:cps:rm-nonrfn}, and \rulename{WTc-Fun}.
        \item[Case \rulename{Tc-App}:]
            By the IH, inversion, and Lemma \ref{lem:cps:subst}.
        \item[Case \rulename{Tc-TAbs}:]
            By the IH and \rulename{WTc-TPoly}.
        \item[Case \rulename{Tc-TApp}:]
            By the IH, inversion, and Lemma \ref{lem:cps:subst-type}.
        \item[Case \rulename{Tc-PAbs}:]
            By the IH and \rulename{WTc-PPoly}.
        \item[Case \rulename{Tc-PApp}:]
            By the IH, inversion, and Lemma \ref{lem:cps:subst-pred}.
        \item[Case \rulename{Tc-If}:]
            By the IH and Lemma \ref{lem:cps:rm-unused}.
        \item[Case \rulename{Tc-Ascr} and \rulename{Tc-Sub}:]
            Immediate.
    \end{description}
\end{proof}

\begin{lemma}[Reflexivity] \label{lem:cps:refl}
    If $\jdwf{\Gamma}{\tau}$, then $\jdsub{\Gamma}{\tau}{\tau}$.
\end{lemma}
\begin{proof}
    By induction on the derivation.
    The case for \rulename{WTc-Rfn} uses Assumption \ref{asm:cps:formula}.
\end{proof}

\begin{lemma}[Transitivity] \label{lem:cps:trans}
    If $\jdsub{\Gamma}{\tau_1}{\tau_2}$ and $\jdsub{\Gamma}{\tau_2}{\tau_3}$, then $\jdsub{\Gamma}{\tau_1}{\tau_3}$.
\end{lemma}
\begin{proof}
    By induction on the structure of $\tau_2$.
    Lemma \ref{asm:cps:formula}, \ref{lem:cps:narrow}, and \ref{lem:cps:weaken} are used.
\end{proof}

\begin{lemma}[Inversion] \label{lem:cps:inv} \quad
    \begin{itemize}
        \item If $\jdty{\Gamma}{x}{\tau}$, then either
            \begin{itemize}
                \item $\jdwf{}{\Gamma}$ and  $\jdsub{\Gamma}{\tyrfn{z}{B}{z = x}}{\tau}$
                    (if $\Gamma(x) = \tyrfn{z}{B}{\phi}$ for some $z, B$ and $\phi$)
                \item $\jdwf{}{\Gamma}$ and $\jdsub{\Gamma}{\Gamma(x)}{\tau}$ (otherwise)
            \end{itemize}
        \item If $\jdty{\Gamma}{p}{\tau}$, then
            $\jdwf{}{\Gamma}$ and  $\jdsub{\Gamma}{\tycps(p)}{\tau}$.
        \item If $\jdty{\Gamma}{\exprec{f:(x:\tau_1) \rarr \tau_2}{x:\tau_1}{c}}{\tau}$, then
            $\jdty{\Gamma, f:(x:\tau_1) \rarr \tau_2, x:\tau_1}{c}{\tau_2}$ and
            $\jdsub{\Gamma}{(x:\tau_1) \rarr \tau_2}{\tau}$.
        \item If $\jdty{\Gamma}{\Lambda \alpha. c}{\tau}$, then
            $\jdty{\Gamma, \alpha}{c}{\tau'}$ and $\jdsub{\Gamma}{\forall \alpha. \tau'}{\tau}$
            for some $\tau'$.
        \item If $\jdty{\Gamma}{\{\repi{\op_i = v_i}\}}{\tau}$, then
            $\bigrepi{\jdty{\Gamma}{v_i}{\tau_i}}$ and $\jdsub{\Gamma}{\{\op_i: \tau_i\}}{\tau}$
            for some $\repi{\tau_i}$.
        \item If $\jdty{\Gamma}{c~v}{\tau}$, then
            $\jdty{\Gamma}{c}{(x:\tau_1) \rarr \tau_2}$, $\jdty{\Gamma}{v}{\tau_1}$
            and $\jdsub{\Gamma}{\tau_2[v/x]}{\tau}$
            for some $x, \tau_1$ and $\tau_2$.
        \item If $\jdty{\Gamma}{c~\rep{A}}{\tau}$, then
            $\jdty{\Gamma}{c}{\forall \rep{X:\rep{B}}. \tau'}$, $\rep{\jdty{\Gamma}{A}{\rep{B}}}$
            and $\jdsub{\Gamma}{\tau'[\rep{A/X}]}{\tau}$
            for some $\rep{X}, \rep{\rep{B}}$ and $\tau'$.
        \item If $\jdty{\Gamma}{c~\nmbullet}{\tau}$, then
            $\jdty{\Gamma}{c}{\forall \alpha. \tau_1}$, $\jdwf{\Gamma}{\tau_2}$
            and $\jdsub{\Gamma}{\tau_2[\tau_2/\alpha]}{\tau}$
            for some $\alpha, \tau_1$ and $\tau_2$.
        \item If $\jdty{\Gamma}{v\#\op}{\tau}$, then
            $\jdty{\Gamma}{v}{\{\ldots, \op:\tau, \ldots\}}$.
        \item If $\jdty{\Gamma}{(c : \tau')}{\tau}$, then
            $\jdty{\Gamma}{c}{\tau'}$ and $\jdsub{\Gamma}{\tau'}{\tau}$.
        \item If $\jdty{\Gamma}{\expif{v}{c_1}{c_2}}{\tau}$, then
            $\jdty{\Gamma}{v}{\tyrfn{z}{\tybool}{\phi}}$,
            $\jdty{\Gamma, v = \exptrue}{c_1}{\tau'}$, $\jdty{\Gamma, v = \expfalse}{c_2}{\tau'}$, 
            and $\jdsub{\Gamma}{\tau'}{\tau}$
            for some $z, \phi$ and $\tau'$.
    \end{itemize}
\end{lemma}
\begin{proof}
    By induction on the derivation. Lemma \ref{lem:cps:refl} and \ref{lem:cps:trans} are used.
\end{proof}

\begin{lemma}[Inversion for CPS-transformed computations] \label{lem:cps:inv-c}
    If $\jdty{\Gamma}{\Lambda \alpha. \lambda h:\tau_h. \lambda k:\tau_k. c}{\tau}$
    and neither $\tau_h$ nor $\tau_k$ is a refinement type,
    then there exists some $\tau'$ such that
    \begin{itemize}
        \item $\jdty{\Gamma, \alpha, h:\tau_h, k:\tau_k}{c}{\tau'}$ and
        \item $\jdsub{\Gamma}{\forall \alpha. \tau_h \rarr \tau_k \rarr \tau'}{\tau}$~.
    \end{itemize}
\end{lemma}
\begin{proof}
    By Lemma \ref{lem:cps:inv}, \rulename{Sc-Poly}, \rulename{Sc-Fun}, and Lemma \ref{lem:cps:trans}.
\end{proof}

\begin{lemma}[Inversion for the specific form of application] \label{lem:cps:inv-c-app}
    If $\jdty{\Gamma}{c~\nmbullet~v_1~v_2}{\tau}$, then
    there exist some $\tau', \tau_1$, and $\tau_2$ such that
    \begin{itemize}
        \item $\jdty{\Gamma}{c}{\tau'}$,
        \item $\jdty{\Gamma}{v_1}{\tau_1}$, and
        \item $\jdty{\Gamma}{v_2}{\tau_2}$~.
    \end{itemize}
    In addition, if $\jdsub{\Gamma}{\tau_1'}{\tau_1}$ and $\jdsub{\Gamma}{\tau_2'}{\tau_2}$
    for some $\tau_1'$ and $\tau_2'$
    and neither $\tau_1'$ nor $\tau_2'$ is a refinement type,
    then $\jdsub{\Gamma}{\tau'}{\forall \alpha. \tau_1' \rarr \tau_2' \rarr \tau}$
    where $\alpha$ is fresh.
\end{lemma}
\begin{proof}
    The first half is by Lemma \ref{lem:cps:inv}.
    The second half is by Lemma \ref{lem:cps:wft}, \ref{lem:cps:weaken} and \ref{lem:cps:trans}
    with the results of the first half.
\end{proof}



\subsection{Forward type preservation}

\begin{assumption} \label{asm:cps:formula-cps} \quad
    \begin{itemize}
        \item If $\jdwf{\Gamma}{\phi}$, then $\jdwf{\cps{\Gamma}}{\phi}$.
        \item If $\jdty{\Gamma}{A}{\rep{B}}$, then $\jdty{\cps{\Gamma}}{A}{\rep{B}}$.
        \item If $\Gamma \vDash \phi$, then $\cps{\Gamma} \vDash \phi$.
    \end{itemize}
\end{assumption}

\begin{assumption} \label{asm:cps:prim-cps} \quad
    \begin{itemize}
        \item $\cps{\ty(p)} = \tycps(\cps{p})$.
        \item If $\ty(p) = \tyrfn{x}{B}{\phi}$ for some $x, B$ and $\phi$, then $\cps{p} = p$.
    \end{itemize}
\end{assumption}

\begin{lemma}[CPS transformation preserves free variables in types] \label{lem:cps:presv-fv} \quad
    \begin{itemize}
        \item $\fv(\cps{T}) = \fv(T)$.
        \item $\fv(\cps{C}) = \fv(C)$.
        \item $\fv(\cps{\Sigma}) = \fv(\Sigma)$.
    \end{itemize}
\end{lemma}
\begin{proof}
    By simultaneous induction on the structure of types.
\end{proof}

\begin{lemma}[CPS transformation is homomorphic for substitution] \label{lem:cps:homo-subst} \quad
    \begin{itemize}
        \item $\cps{T[v/x]} = \cps{T}[\cps{v}/x]$.
        \item $\cps{C[v/x]} = \cps{C}[\cps{v}/x]$.
        \item $\cps{\Sigma[v/x]} = \cps{\Sigma}[\cps{v}/x]$.
        \item $\cps{T[A/X]} = \cps{T}[A/X]$.
        \item $\cps{C[A/X]} = \cps{C}[A/X]$.
        \item $\cps{\Sigma[A/X]} = \cps{\Sigma}[A/X]$.
    \end{itemize}
\end{lemma}
\begin{proof}
    By simultaneous induction on the structure of types.
    The case for $T = \tyrfn{x}{B}{\phi}$ uses Assumption \ref{asm:cps:prim-cps}.
\end{proof}

\begin{lemma}[CPS transformation preserves well-formedness] \label{lem:cps:presv-wf} \quad
    \begin{itemize}
        \item If $\jdwf{}{\Gamma}$, then $\jdwf{}{\cps{\Gamma}}$.
        \item If $\jdwf{\Gamma}{T}$, then $\jdwf{\cps{\Gamma}}{\cps{T}}$.
        \item If $\jdwf{\Gamma}{C}$, then $\jdwf{\cps{\Gamma}}{\cps{C}}$.
        \item If $\jdwf{\Gamma}{\Sigma}$, then $\jdwf{\cps{\Gamma}}{\cps{\Sigma}}$.
    \end{itemize}
\end{lemma}
\begin{proof}
    By simultaneous induction on the derivations. Lemma \ref{lem:cps:weaken} is used.
    The case for \rulename{WT-Rfn} uses Assumption \ref{asm:cps:formula-cps}.
\end{proof}

\begin{lemma}[CPS transformation preserves subtyping] \label{lem:cps:presv-sub} \quad
    \begin{itemize}
        \item If $\jdsub{\Gamma}{T_1}{T_2}$, then $\jdsub{\cps{\Gamma}}{\cps{T_1}}{\cps{T_2}}$.
        \item If $\jdsub{\Gamma}{C_1}{C_2}$, then $\jdsub{\cps{\Gamma}}{\cps{C_1}}{\cps{C_2}}$.
        \item If $\jdsub{\Gamma}{\Sigma_1}{\Sigma_2}$, then $\jdsub{\cps{\Gamma}}{\cps{\Sigma_1}}{\cps{\Sigma_2}}$.
    \end{itemize}
\end{lemma}
\begin{proof}
    By simultaneous induction on the derivations. Lemma \ref{lem:cps:weaken} is used.
    The case for \rulename{S-Rfn} uses Assumption \ref{asm:cps:formula-cps}.
\end{proof}

\begin{theorem}[Forward type preservation] \quad
    \begin{enumerate}
        \item If\, $\jdty{\Gamma}{v}{T}$, then $\jdty{\cps{\Gamma}}{\cps{v}}{\cps{T}}$.
        \item If\, $\jdty{\Gamma}{c}{C}$, then $\jdty{\cps{\Gamma}}{\cps{c}}{\cps{C}}$.
    \end{enumerate}
\end{theorem}
\input{proofs/cps-forward.tex}


\subsection{Backward type preservation}

For the backward direction, we define some notations.
\begin{definition}
    $\Gamma$ is \emph{cps-wellformed}
    if for all $(x:\tau) \in \Gamma$, it holds that $\tau = \cps{T}$ for some $T$.
\end{definition}
\begin{definition}
    $\rmtv$ is a function which removes all bindings of type variables
    from a typing context. Formally, it is defined as follows:
    \begin{align}
        \rmtv(\emptyset) &\defeq \emptyset &
        \rmtv(\Gamma, x: \tau) &\defeq \rmtv(\Gamma), x: \tau \\
        \rmtv(\Gamma, x: B) &\defeq \rmtv(\Gamma), x: B &
        \rmtv(\Gamma, X: \rep{B}) &\defeq \rmtv(\Gamma), X: \rep{B} \\
        \rmtv(\Gamma, \alpha) &\defeq \rmtv(\Gamma) & &
    \end{align}
\end{definition}

\begin{lemma} \label{lem:cps:cpswf-rmtv}
    If $\Gamma$ is cps-wellformed,
    then there exists some $\Gamma'$ such that $\cps{\Gamma'} = \rmtv(\Gamma)$.
\end{lemma}
\begin{proof}
    By induction on the structure of $\Gamma$.
\end{proof}

Since the CPS transformation is injective,
there is only one $\Gamma'$ which satisfies the equation in Lemma \ref{lem:cps:cpswf-rmtv}.
Therefore, we define a function $\cpsinv{-}$ that maps $\Gamma$ to $\Gamma'$:
\begin{definition}
    Let $\Gamma$ be a cps-wellformed typing context in the target language.
    We define $\cpsinv{\Gamma}$ to be the typing context in the source language
    such that $\cps{\cpsinv{\Gamma}} = \rmtv(\Gamma)$.
\end{definition}

\begin{assumption} \label{asm:cps:formula-cpsinv}
    Assume that $\Gamma$ is cps-wellformed.
    \begin{itemize}
        \item If $\jdwf{\Gamma}{\phi}$, then $\jdwf{\cpsinv{\Gamma}}{\phi}$.
        \item If $\jdty{\Gamma}{A}{\rep{B}}$, then $\jdty{\cpsinv{\Gamma}}{A}{\rep{B}}$.
        \item If $\Gamma \vDash \phi$, then $\cpsinv{\Gamma} \vDash \phi$.
    \end{itemize}
\end{assumption}

\begin{lemma}[Computation types in the specific form of subtyping are pure] \label{lem:cps:sub-pure}
    If $\jdsub{\Gamma}{\cps{C}}{\forall \alpha. \tau_1 \rarr (\tau_2 \rarr \beta) \rarr \tau_4}$
    and $\beta \in \Gamma$,
    then $C = \tycomp{\Sigma}{T}{\square}$ (for some $\Sigma$ and $T$),
    and $\tau_4 = \beta$.
\end{lemma}
\begin{proof}
    Assume that $C = \tycomp{\Sigma}{T}{\tyctl{x}{C_1}{C_2}}$ for some $\Sigma, T, x, C_1$ and $C_2$.
    Then, we have
    \[
        \jdsub{\Gamma}
            {\forall \gamma. \cps{\Sigma} \rarr ((x: \cps{T}) \rarr \cps{C_1}) \rarr \cps{C_2}}
            {\forall \alpha. \tau_1 \rarr (\tau_2 \rarr \beta) \rarr \tau_4}
    \]
    where $\gamma$ is fresh.
    By inversion, we have $\jdsub{\Gamma, \alpha, h:\tau_1, x:\cps{T}}{\beta}{\cps{C_1}}$,
    that is, $\jdsub{\Gamma, \alpha, h:\tau_1, x:\cps{T}}{\beta}{\forall \delta. \tau_5}$
    for some $\tau_5$ and $\delta$.
    This is contradictory since there is no subtyping rule for such a judgment.

    Therefore, $C = \tycomp{\Sigma}{T}{\square}$ for some $\Sigma$ and $T$.
    In this case, we have
    \[
        \jdsub{\Gamma}
            {\forall \gamma. \cps{\Sigma} \rarr (\cps{T} \rarr \gamma) \rarr \gamma}
            {\forall \alpha. \tau_1 \rarr (\tau_2 \rarr \beta) \rarr \tau_4}
    \]
    where $\gamma$ is fresh.
    By inversion, we have
    \begin{itemize}
        \item $\jdwf{\Gamma, \alpha}{\tau_6}$,
        \item $\jdsub{\Gamma, \alpha, h:\tau_1, x:\cps{T}[\tau_6/\gamma]}{\beta}{\gamma[\tau_6/\gamma]}$, and
        \item $\jdsub{\Gamma, \alpha, h:\tau_1, x:\cps{T}[\tau_6/\gamma]}{\gamma[\tau_6/\gamma]}{\tau_4}$
    \end{itemize}
    for some $\tau_6$.
    The second judgment can be derived by only \rulename{Sc-TVar} where $\gamma[\tau_6/\gamma] = \beta$.
    Therefore, the third judgment becomes
    $\jdsub{\Gamma, \alpha, h:\tau_1, x:\cps{T}[\tau_6/\gamma]}{\beta}{\tau_4}$,
    which can be derived by only \rulename{Sc-TVar} where $\tau_4 = \beta$.
\end{proof}

\begin{lemma}[Computation types can be assumed to be impure] \label{lem:assume-atm}
    If $\jdty{\Gamma}{c}{C}$, then w.l.o.g.,
    we can assume that $C = \tycomp{\Sigma}{T}{\tyctl{x}{C_1}{C_2}}$
    for some $\Sigma, T, x, C_1$ and $C_2$.
\end{lemma}
\begin{proof} \quad
    \begin{description}
        \item[Case $C = \tycomp{\Sigma}{T}{\tyctl{x}{C_1}{C_2}}$:] Immediate.
        \item[Case $C = \tycomp{\Sigma}{T}{\square}$:]
            It holds that
            $\jdsub{\Gamma}{\tycomp{\Sigma}{T}{\square}}{\tycomp{\Sigma}{T}{\tyctl{x}{C_0}{C_0}}}$
            for any $C_0$ such that $\jdwf{\Gamma}{C_0}$.
            Therefore, by subsumption
            we have $\jdty{\Gamma}{c}{\tycomp{\Sigma}{T}{\tyctl{x}{C_0}{C_0}}}$~.
    \end{description}
\end{proof}

\begin{lemma}[Backward preservation on well-formedness] \label{lem:cps:presv-b-wf}
    Assume that $\Gamma$ is cps-wellformed.
    \begin{enumerate}
        \item If $\jdwf{}{\Gamma}$, then $\jdwf{}{\cpsinv{\Gamma}}$.
        \item If $\jdwf{\Gamma}{\cps{T}}$, then $\jdwf{\cpsinv{\Gamma}}{T}$.
        \item If $\jdwf{\Gamma}{\cps{C}}$, then $\jdwf{\cpsinv{\Gamma}}{C}$.
        \item If $\jdwf{\Gamma}{\cps{\Sigma}}$, then $\jdwf{\cpsinv{\Gamma}}{\Sigma}$.
    \end{enumerate}
\end{lemma}
\input{proofs/cps-bw-wf.tex}

\begin{lemma}[Backward preservation on subtyping] \label{lem:cps:cpsinv-sub}
    Assume that $\Gamma$ is cps-wellformed.
    \begin{enumerate}
        \item If $\jdsub{\Gamma}{\cps{T_1}}{\cps{T_2}}$, then $\jdsub{\cpsinv{\Gamma}}{T_1}{T_2}$.
        \item If $\jdsub{\Gamma}{\cps{C_1}}{\cps{C_2}}$, then $\jdsub{\cpsinv{\Gamma}}{C_1}{C_2}$.
        \item If $\jdsub{\Gamma}{\cps{\Sigma_1}}{\cps{\Sigma_2}}$, then $\jdsub{\cpsinv{\Gamma}}{\Sigma_1}{\Sigma_2}$.
    \end{enumerate}
\end{lemma}
\input{proofs/cps-bw-sub.tex}

% Using these notations and lemmas, the backward direction is stated as follows.
\begin{theorem}[Backward type preservation (for open expressions)] \label{thm:cps-backward}
    Assume that $\Gamma$ is cps-wellformed.
    \begin{enumerate}
        \item If $\jdty{\Gamma}{\cps{v}}{\tau}$, then
            there exists $T$ such that
            $\jdty{\cpsinv{\Gamma}}{v}{T}$ and $\jdsub{\Gamma}{\cps{T}}{\tau}$.
        \item If $\jdty{\Gamma}{\cps{c}}{\tau}$, then
            there exists $C$ such that
            $\jdty{\cpsinv{\Gamma}}{c}{C}$ and $\jdsub{\Gamma}{\cps{C}}{\tau}$.
    \end{enumerate}
\end{theorem}
\input{proofs/cps-backward.tex}

\begin{corollary}[Backward type preservation (for closed expressions)] \quad
    \begin{itemize}
     \item If\, $\jdty{\emptyset}{\cps{v}}{\tau}$, then
           there exists some $T$ such that
           $\jdty{\emptyset}{v}{T}$ and
           $\jdsub{\emptyset}{\cps{T}}{\tau}$.
     \item If\, $\jdty{\emptyset}{\cps{c}}{\tau}$, then
           there exists some $C$ such that
           $\jdty{\emptyset}{c}{C}$ and
           $\jdsub{\emptyset}{\cps{C}}{\tau}$.
    \end{itemize}
\end{corollary}
\begin{proof}
    Immediate from Theorem \ref{thm:cps-backward}
    since $\emptyset$ is obviously cps-wellformed.
\end{proof}

\end{document}
