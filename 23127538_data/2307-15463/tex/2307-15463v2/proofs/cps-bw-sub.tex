

\begin{proof}
    By simultaneous induction on the derivation.
    \begin{enumit}
        \item Case analysis on $T_1$ and $T_2$.
        \begin{description}
            \item[Case $T_1 = \tyrfn{z}{B}{\phi_1}$ and $T_2 = \tyrfn{z}{B}{\phi_2}$:] We have
                \begin{itemize}
                    \item $\cps{T_1} = \tyrfn{z}{B}{\phi_1}$ and
                    \item $\cps{T_2} = \tyrfn{z}{B}{\phi_2}$~.
                \end{itemize}
                We have the conclusion
                by Assumption \ref{asm:cps:formula-cpsinv} and \rulename{S-Rfn}.
            \item[Case $T_1 = (x:T_{10}) \rarr C_1$ and $T_1 = (x:T_{10}) \rarr C_1$:] We have
                \begin{itemize}
                    \item $\cps{T_1} = (x:\cps{T_{10}}) \rarr \cps{C_1}$ and
                    \item $\cps{T_2} = (x:\cps{T_{20}}) \rarr \cps{C_2}$.
                \end{itemize}
                We have the conclusion by the IHs and \rulename{S-Fun}.
            \item[Otherwise:] Contradictory since there is no applicable rule.
        \end{description}
        \item Case analysis on $C_1$ and $C_2$.
        \begin{description}
            \item[Case $C_1 = \tycomp{\Sigma_1}{T_1}{\square}$
                and $C_2 = \tycomp{\Sigma_2}{T_2}{\square}$:] We have
                \begin{itemize}
                    \item $\cps{C_1} = \forall \alpha. \cps{\Sigma_1} \rarr (\cps{T_1} \rarr \alpha) \rarr \alpha$ and
                    \item $\cps{C_2} = \forall \beta. \cps{\Sigma_2} \rarr (\cps{T_2} \rarr \beta) \rarr \beta$
                \end{itemize}
                for some $\alpha$ and $\beta$.
                By inversion, we have
                \begin{itemize}
                    \item $\jdwf{\Gamma, \beta}{\tau}$,
                    \item $\jdsub{\Gamma, \beta}{\cps{\Sigma_2}}{\cps{\Sigma_1}[\tau/\alpha]}$ and
                    \item $\jdsub{\Gamma, \beta, h: \cps{\Sigma_2}}{\cps{T_1}}{{\cps{T_2}[\tau/\alpha]}}$
                \end{itemize}
                for some $\tau$.
                Since CPS-transformed types do not contain type variables, we have
                \begin{itemize}
                    \item $\jdsub{\Gamma, \beta}{\cps{\Sigma_2}}{\cps{\Sigma_1}}$ and
                    \item $\jdsub{\Gamma, \beta, h: \cps{\Sigma_2}}{\cps{T_1}}{{\cps{T_2}}}$~.
                \end{itemize}
                By \ref{lem:rm-nonrfn}, we have
                \begin{itemize}
                    \item $\jdsub{\Gamma, \beta}{\cps{\Sigma_2}}{\cps{\Sigma_1}}$ and
                    \item $\jdsub{\Gamma, \beta}{\cps{T_1}}{{\cps{T_2}}}$~.
                \end{itemize}
                By the IHs, we have
                \begin{itemize}
                    \item $\jdsub{\cpsinv{\Gamma}}{\Sigma_2}{\Sigma_1}$ and
                    \item $\jdsub{\cpsinv{\Gamma}}{T_1}{T_2}$~.
                \end{itemize}
                Also, by \rulename{S-Pure}, we have $\jdsub{\cpsinv{\Gamma} \mid T_1}{\square}{\square}$.
                Then we have the conclusion by \rulename{S-Comp}.
            \item[Case $C_1 = \tycomp{\Sigma_1}{T_1}{\tyctl{x}{C_{11}}{C_{12}}}$
                and $C_2 = \tycomp{\Sigma_2}{T_2}{\tyctl{x}{C_{21}}{C_{22}}}$:] We have
                \begin{itemize}
                    \item $\cps{C_1} = \forall \alpha. \cps{\Sigma_1} \rarr ((x:\cps{T_1}) \rarr \cps{C_{11}}) \rarr \cps{C_{12}}$ and
                    \item $\cps{C_2} = \forall \beta. \cps{\Sigma_2} \rarr ((x:\cps{T_2}) \rarr \cps{C_{21}}) \rarr \cps{C_{22}}$~.
                \end{itemize}
                By inversion, we have
                \begin{itemize}
                    \item $\jdwf{\Gamma, \beta}{\tau}$,
                    \item $\jdsub{\Gamma, \beta}{\cps{\Sigma_2}}{\cps{\Sigma_1}[\tau/\alpha]}$,
                    \item $\jdsub{\Gamma, \beta, h: \cps{\Sigma_2}}{\cps{T_1}[\tau/\alpha]}{{\cps{T_2}}}$,
                    \item $\jdsub{\Gamma, \beta, h: \cps{\Sigma_2}, x:\cps{T_1}[\tau/\alpha]}{\cps{C_{21}}}{\cps{C_{11}}[\tau/\alpha]}$, and
                    \item $\jdsub{\Gamma, \beta, h: \cps{\Sigma_2}, k: (x:\cps{T_2}) \rarr \cps{C_{21}}}{\cps{C_{12}}[\tau/\alpha]}{\cps{C_22}}$~.
                \end{itemize}
                for some $\tau$.
                Since CPS-transformed types do not contain type variables, we have
                \begin{itemize}
                    \item $\jdsub{\Gamma, \beta}{\cps{\Sigma_2}}{\cps{\Sigma_1}}$,
                    \item $\jdsub{\Gamma, \beta, h: \cps{\Sigma_2}}{\cps{T_1}}{{\cps{T_2}}}$,
                    \item $\jdsub{\Gamma, \beta, h: \cps{\Sigma_2}, x:\cps{T_1}}{\cps{C_{21}}}{\cps{C_{11}}}$, and
                    \item $\jdsub{\Gamma, \beta, h: \cps{\Sigma_2}, k: (x:\cps{T_2}) \rarr \cps{C_{21}}}{\cps{C_{12}}}{\cps{C_22}}$~.
                \end{itemize}
                By \ref{lem:rm-nonrfn}, we have
                \begin{itemize}
                    \item $\jdsub{\Gamma, \beta}{\cps{\Sigma_2}}{\cps{\Sigma_1}}$,
                    \item $\jdsub{\Gamma, \beta}{\cps{T_1}}{{\cps{T_2}}}$,
                    \item $\jdsub{\Gamma, \beta, x:\cps{T_1}}{\cps{C_{21}}}{\cps{C_{11}}}$, and
                    \item $\jdsub{\Gamma, \beta}{\cps{C_{12}}}{\cps{C_22}}$~.
                \end{itemize}
                By the IHs, we have
                \begin{itemize}
                    \item $\jdsub{\cpsinv{\Gamma}}{\Sigma_2}{\Sigma_1}$,
                    \item $\jdsub{\cpsinv{\Gamma}}{T_1}{T_2}$,
                    \item $\jdsub{\cpsinv{\Gamma}, x:T_1}{C_{21}}{C_{11}}$, and
                    \item $\jdsub{\cpsinv{\Gamma}}{C_{12}}{C_{22}}$~.
                \end{itemize}
                Then we have the conclusion by \rulename{S-ATM} and \rulename{S-Comp}.
            \item[Case $C_1 = \tycomp{\Sigma_1}{T_1}{\square}$
                and $C_2 = \tycomp{\Sigma_2}{T_2}{\tyctl{x}{C_{21}}{C_{22}}}$:] We have
                \begin{itemize}
                    \item $\cps{C_1} = \forall \alpha. \cps{\Sigma_1} \rarr (\cps{T_1} \rarr \alpha) \rarr \alpha$ and
                    \item $\cps{C_2} = \forall \beta. \cps{\Sigma_2} \rarr ((x:\cps{T_2}) \rarr \cps{C_{21}}) \rarr \cps{C_{22}}$~.
                \end{itemize}
                W.l.o.g., we can assume that $x \notin \cps{C_{22}}$.
                By inversion, we have
                \begin{itemize}
                    \item $\jdwf{\Gamma, \beta}{\tau}$,
                    \item $\jdsub{\Gamma, \beta}{\cps{\Sigma_2}}{\cps{\Sigma_1}[\tau/\alpha]}$,
                    \item $\jdsub{\Gamma, \beta, h: \cps{\Sigma_2}}{\cps{T_1}[\tau/\alpha]}{{\cps{T_2}}}$,
                    \item $\jdsub{\Gamma, \beta, h: \cps{\Sigma_2}, x:\cps{T_1}[\tau/\alpha]}{\cps{C_{21}}}{\alpha[\tau/\alpha]}$, and
                    \item $\jdsub{\Gamma, \beta, h: \cps{\Sigma_2}, k: (x:\cps{T_2}) \rarr \cps{C_{21}}}{\alpha[\tau/\alpha]}{\cps{C_22}}$~.
                \end{itemize}
                for some $\tau$.
                Since CPS-transformed types do not contain type variables, we have
                \begin{itemize}
                    \item $\jdsub{\Gamma, \beta}{\cps{\Sigma_2}}{\cps{\Sigma_1}}$,
                    \item $\jdsub{\Gamma, \beta, h: \cps{\Sigma_2}}{\cps{T_1}}{{\cps{T_2}}}$,
                    \item $\jdsub{\Gamma, \beta, h: \cps{\Sigma_2}, x:\cps{T_1}}{\cps{C_{21}}}{\tau}$, and
                    \item $\jdsub{\Gamma, \beta, h: \cps{\Sigma_2}, k: (x:\cps{T_2}) \rarr \cps{C_{21}}}{\tau}{\cps{C_22}}$~.
                \end{itemize}
                By \ref{lem:rm-nonrfn}, we have
                \begin{itemize}
                    \item $\jdsub{\Gamma, \beta}{\cps{\Sigma_2}}{\cps{\Sigma_1}}$,
                    \item $\jdsub{\Gamma, \beta}{\cps{T_1}}{{\cps{T_2}}}$,
                    \item $\jdsub{\Gamma, \beta, x:\cps{T_1}}{\cps{C_{21}}}{\tau}$, and
                    \item $\jdsub{\Gamma, \beta}{\tau}{\cps{C_22}}$~.
                \end{itemize}
                By Lemma \ref{lem:cps:weaken} and \ref{lem:cps:trans}, we have
                \begin{itemize}
                    \item $\jdsub{\Gamma, \beta}{\cps{\Sigma_2}}{\cps{\Sigma_1}}$,
                    \item $\jdsub{\Gamma, \beta}{\cps{T_1}}{{\cps{T_2}}}$, and
                    \item $\jdsub{\Gamma, \beta, x:\cps{T_1}}{\cps{C_{21}}}{\cps{C_22}}$~.
                \end{itemize}
                By the IHs, we have
                \begin{itemize}
                    \item $\jdsub{\cpsinv{\Gamma}}{\Sigma_2}{\Sigma_1}$,
                    \item $\jdsub{\cpsinv{\Gamma}}{T_1}{T_2}$, and
                    \item $\jdsub{\cpsinv{\Gamma}, x:T_1}{C_{21}}{C_{22}}$~.
                \end{itemize}
                Then we have the conclusion by \rulename{S-Embed} and \rulename{S-Comp}.
            \item[Case $C_1 = \tycomp{\Sigma_1}{T_1}{\tyctl{x}{C_{11}}{C_{12}}}$
                and $C_2 = \tycomp{\Sigma_2}{T_2}{\square}$:] We have
                \begin{itemize}
                    \item $\cps{C_1} = \forall \alpha. \cps{\Sigma_1} \rarr ((x:\cps{T_1}) \rarr \cps{C_{11}}) \rarr \cps{C_{12}}$ and
                    \item $\cps{C_2} = \forall \beta. \cps{\Sigma_2} \rarr (\cps{T_2} \rarr \beta) \rarr \beta$~.
                \end{itemize}
                By inversion, we have
                \begin{itemize}
                    \item $\jdwf{\Gamma, \beta}{\tau}$, and
                    % \item $\jdsub{\Gamma, \beta}{\cps{\Sigma_2}}{\cps{\Sigma_1}[\tau/\alpha]}$,
                    % \item $\jdsub{\Gamma, \beta, h: \cps{\Sigma_2}}{\cps{T_1}[\tau/\alpha]}{{\cps{T_2}}}$,
                    % \item $\jdsub{\Gamma, \beta, h: \cps{\Sigma_2}, x:\cps{T_1}[\tau/\alpha]}{\beta}{\cps{C_{11}}[\tau/\alpha]}$, and
                    \item $\jdsub{\Gamma, \beta, h: \cps{\Sigma_2}, k: (x:\cps{T_2}) \rarr \beta}{\cps{C_{12}}[\tau/\alpha]}{\beta}$~.
                \end{itemize}
                for some $\tau$.
                Since CPS-transformed types do not contain type variables, we have
                \begin{itemize}
                    % \item $\jdsub{\Gamma, \beta}{\cps{\Sigma_2}}{\cps{\Sigma_1}}$,
                    % \item $\jdsub{\Gamma, \beta, h: \cps{\Sigma_2}}{\cps{T_1}}{{\cps{T_2}}}$,
                    % \item $\jdsub{\Gamma, \beta, h: \cps{\Sigma_2}, x:\cps{T_1}}{\beta}{\cps{C_{11}}}$, and
                    \item $\jdsub{\Gamma, \beta, h: \cps{\Sigma_2}, k: (x:\cps{T_2}) \rarr \beta}{\cps{C_{12}}}{\beta}$~.
                \end{itemize}
                This is contradictory since $\cps{C_{12}}$ cannot be a type variable
                and thus there is no applicable rule.
        \end{description}
        \item By the IHs, and \rulename{S-Sig}.
    \end{enumit}
\end{proof}