% depends on :: lem:wft lem:wfg lem:sub-eq
%               lem:notin-nonrfn lem:refl lem:inv lem:weaken
\begin{proof}
    By induction on the structure of $K$.
    \begin{description}
        \item[{Case $K = [\ ]$:}]
            \def\currentprefix{inv-ctx:empty}
            We have $\jdty{\Gamma}{c}{\tycomp{\Sigma}{T}{\tyctl{z}{C_1}{C_2}}}$.
            By $\alpha$-renaming, we have
            \begin{enumrm}
                \item\llabel{ty-c} $\jdty{\Gamma}{c}{\tycomp{\Sigma}{T}{\tyctl{y}{C_1[y/z]}{C_2}}}$~.
            \end{enumrm}
            Therefore, we have the first half of the conclusion with $T_1 = T$ and $C_0 = C_1[y/z]$.

            On the other hand, from \lref{ty-c}, it holds that
            \begin{enumrm}[resume]
                \item\llabel{wf-gy} $\jdwf{}{\Gamma, y: T}$
            \end{enumrm}
            by Lemma~\ref{lem:wft}, Lemma~\ref{lem:wfg}, and inversion.
            We show the second half of the conclusion by case analysis on $T$.
            \begin{description}
                \item[Case that $T$ is a refinement type $\tyrfn{z_0}{B}{\phi}$:]
                    By \rulename{T-CVar} and \rulename{T-Ret} with \lref{wf-gy}, it holds that
                    \begin{enumrm}[resume]
                        \item\llabel{ty-rety} $\jdty{\Gamma, y: T}{\expret{y}}{\tycomp{\emptyset}{\tyrfn{z_0}{B}{z_0 = y}}{\square}}$~.
                    \end{enumrm}
                    % Also, we have
                    % $\jdsub{\Gamma, y: T}{\tycomp{\emptyset}{\tyrfn{z_0}{B}{z_0 = y}}{\square}}{\tycomp{\Sigma}{T}{\tyctl{z}{C_1}{C_1[y/z]}}}$
                    % by the following derivation:
                    % \[
                    %     \infer{\jdsub{\Gamma, y: T}{\tycomp{\emptyset}{\tyrfn{z_0}{B}{z_0 = y}}{\square}}{\tycomp{\Sigma}{T}{\tyctl{z}{C_1}{C_1[y/z]}}}}
                    %     {
                    %         \infer{\jdsub{\Gamma, y: T}{\Sigma}{\emptyset}}
                    %         {}
                    %         &
                    %         \infer{\jdsub{\Gamma, y: \tyrfn{z_0}{B}{\phi}}{\tyrfn{z_0}{B}{z_0 = y}}{\tyrfn{z_0}{B}{\phi}}}
                    %         {\Gamma, y: \tyrfn{z_0}{B}{\phi}, z_0: B \vDash z_0 = y \implies \phi}
                    %         &
                    %         \infer{\jdsub{\Gamma, y: T \mid \tyrfn{z_0}{B}{z_0 = y}}{\square}{\tyctl{z}{C_1}{C_1[y/z]}}}
                    %         {
                    %             \infer{\jdsub{\Gamma, y: T, z: \tyrfn{z_0}{B}{z_0 = y}}{C_1}{C_1[y/z]}}{}
                    %         }
                    %     }
                    % \]
                    Also, we have the following subtyping with Lemma~\ref{lem:sub-eq}:
                    \[
                        \infer{\jdsub{\Gamma, y: T \mid \tyrfn{z_0}{B}{z_0 = y}}{\square}{\tyctl{z}{C_1}{C_1[y/z]}}}
                        {
                            \infer{\jdsub{\Gamma, y: T, z: \tyrfn{z_0}{B}{z_0 = y}}{C_1}{C_1[y/z]}}
                            {}
                        }
                    \]
                    Then it holds that
                    \begin{enumrm}[resume]
                        \item\llabel{sub-comp} $\jdsub{\Gamma, y: T}{\tycomp{\emptyset}{\tyrfn{z_0}{B}{z_0 = y}}{\square}}{\tycomp{\Sigma}{T}{\tyctl{z}{C_1}{C_1[y/z]}}}$
                    \end{enumrm}
                    by subtyping.
                    Therefore, by subsumption with \lref{ty-rety} and \lref{sub-comp}, we have the conclusion.
                \item[Case that $T$ is not a refinement type:]
                    By \rulename{T-Var} and \rulename{T-Ret} with \lref{wf-gy}, it holds that
                    \begin{enumrm}[resume]
                        \item\llabel{ty-rety2} $\jdty{\Gamma, y: T}{\expret{y}}{\tycomp{\emptyset}{T}{\square}}$~.
                    \end{enumrm}
                    Also, since $T$ is not a refinement type, by Lemma~\ref{lem:notin-nonrfn}
                    we have $z \notin C_1$ and so $C_1[y/z] = C_1$.
                    Then, we have the following subtyping with Lemma~\ref{lem:refl}:
                    \[
                        \infer{\jdsub{\Gamma, y: T \mid T}{\square}{\tyctl{z}{C_1}{C_1[y/z]}}}
                        {
                            \infer{\jdsub{\Gamma, y: T, z: T}{C_1}{C_1[y/z]}}
                            {}
                        }
                    \]
                    Then it holds that
                    \begin{enumrm}[resume]
                        \item\llabel{sub-comp2} $\jdsub{\Gamma, y: T}{\tycomp{\emptyset}{T}{\square}}{\tycomp{\Sigma}{T}{\tyctl{z}{C_1}{C_1[y/z]}}}$
                    \end{enumrm}
                    by subtyping.
                    Therefore, by subsumption with \lref{ty-rety2} and \lref{sub-comp2}, we have the conclusion.
            \end{description}
        \item[Case $K = \explet{x}{K_1}{c_2}$:]
            \def\currentprefix{inv-ctx:let}
            We have $\jdty{\Gamma}{\explet{x}{K_1[c]}{c_2}}{\tycomp{\Sigma}{T}{\tyctl{z}{C_1}{C_2}}}$.
            By Lemma~\ref{lem:inv}, we have
            \begin{enumrm}
                \item\llabel{ty-k1c} $\jdty{\Gamma}{K_1[c]}{\tycomp{\Sigma}{T'}{\tyctl{x}{C'}{C_2}}}$,
                \item\llabel{ty-c2} $\jdty{\Gamma, x: T'}{c_2}{\tycomp{\Sigma}{T}{\tyctl{z}{C_1}{C'}}}$, and
                \item\llabel{in-x} $x \notin \fv(T) \cup \fv(\Sigma) \cup (\fv(C_1) \setminus \{z\})$
            \end{enumrm}
            for some $T'$ and $C'$.
            By the IH of \lref{ty-k1c}, we have
            \begin{enumrm}[resume]
                \item\llabel{ty-c} $\jdty{\Gamma}{c}{\tycomp{\Sigma}{T_1}{\tyctl{y}{C_0}{C_2}}}$ and
                \item\llabel{ty-k1y} $\jdty{\Gamma, y: T_1}{K_1[\expret{y}]}{\tycomp{\Sigma}{T'}{\tyctl{x}{C'}{C_0}}}$
            \end{enumrm}
            for some $y, T_1$ and $C_0$.

            By Lemma~\ref{lem:wfg} with \lref{ty-c2}, we have $\jdwf{}{\Gamma, x: T'}$.
            By inversion, we have $x \notin \dom(\Gamma)$ and $\jdwf{\Gamma}{T'}$.
            Also, By Lemma~\ref{lem:wfg} with \lref{ty-k1y}, we have $\jdwf{}{\Gamma, y: T_1}$.
            Then, by Lemma~\ref{lem:weaken} we have $\jdwf{\Gamma, y: T_1}{T'}$.
            Moreover, w.l.o.g, we can assume $x \ne y$, and so
            $x \notin \dom(\Gamma) \cup \{y\} = \dom(\Gamma, y: T_1)$.
            Then we have $\jdwf{}{\Gamma, y: T_1, x: T'}$.

            Therefore, by Lemma~\ref{lem:weaken} with \lref{ty-c2}, we have
            \[
                \jdty{\Gamma, y: T_1, x: T'}{c_2}{\tycomp{\Sigma}{T}{\tyctl{z}{C_1}{C'}}}~.
            \]
            Then, by \rulename{T-LetIp} with \lref{ty-k1y} and \lref{in-x}, we have
            \[
                \jdty{\Gamma, y: T_1}{\explet{x}{K_1[\expret{y}]}{c_2}}{\tycomp{\Sigma}{T}{\tyctl{z}{C_1}{C_0}}}~,
            \]
            that is,
            \begin{enumrm}[resume]
                \item\llabel{ty-ky} $\jdty{\Gamma, y: T_1}{K[\expret{y}]}{\tycomp{\Sigma}{T}{\tyctl{z}{C_1}{C_0}}}$~.
            \end{enumrm}
            Therefore, from \lref{ty-c} and \lref{ty-ky} we have the conclusion.
    \end{description}
\end{proof}