% depends on:: lem:cano
\begin{proof}
    \def\currentprefix{prog}
    By induction on the derivation.
    \begin{description}
        \item[Case \rulename{T-Ret} and \rulename{T-Op}:] Obvious.
        \item[Case \rulename{T-CSub}:] By the IH.
            Note that $\jdsub{}{\Sigma'}{\Sigma}$ implies $\dom(\Sigma') \supseteq \dom(\Sigma)$.
        \item[Case \rulename{T-App}:] We have
            \def\currentprefix{prog:app}
            \begin{enumrm}
                \item\llabel{eq-c} $c = v_1~v_2$,
                % \item\llabel{eq-C} $C = \tycomp{\Sigma}{T}{S}$,
                \item\llabel{ty-v1} $\jdty{}{v_1}{(x: T_1) \rarr \tycomp{\Sigma}{T}{S}}$, and
                \item\llabel{ty-v2} $\jdty{}{v_2}{T_1}$
            \end{enumrm}
            for some $v_1, v_2, x$, and $T_1$.
            By Lemma \ref{lem:cano} with \lref{ty-v1}, either one of the following two cases holds.
            \begin{itemize}
                \item $v_1 = \exprec{f}{x}{c_1}$ for some $f, c_1$: \\
                    By \rulename{E-App}, we have $(\exprec{f}{x}{c_1})~v_2 \eval c_1[v_2/x][(\exprec{f}{x}{c_1})/f]$~.
                \item $v_1 = p$ for some $p$ and $\zeta(p, v)$ is defined for all $v$ such that $\jdty{}{v}{T_1}$: \\
                    As \lref{ty-v2} holds, $\zeta(p, v_2)$ is defined.
                    Therefore, by \rulename{E-Prim} we have $p~v_2 \eval \zeta(p, v_2)$~.
            \end{itemize}
        \item[Case \rulename{T-If}:] We have
            \def\currentprefix{prog:if}
            \begin{enumrm}
                \item\llabel{eq-c} $c = \expif{v}{c_1}{c_2}$,
                \item\llabel{ty-v} $\jdty{}{v}{\tyrfn{x}{\tybool}{\phi}}$,
                \item\llabel{ty-c1} $\jdty{v = \exptrue}{c_1}{\tycomp{\Sigma}{T}{S}}$, and
                \item\llabel{ty-c2} $\jdty{v = \expfalse}{c_2}{\tycomp{\Sigma}{T}{S}}$
            \end{enumrm}
            for some $v, c_1, c_2, x$, and $\phi$.
            By Lemma \ref{lem:cano} with \lref{ty-v}, either one of the following two cases holds.
            \begin{itemize}
                \item $v = \exptrue$: By \rulename{E-IfT}, we have $\expif{\exptrue}{c_1}{c_2} \eval c_1$.
                \item $v = \expfalse$: By \rulename{E-IfF}, we have $\expif{\expfalse}{c_1}{c_2} \eval c_2$.
            \end{itemize}
        \item[Case \rulename{T-LetP}:] We have
            \def\currentprefix{prog:let}
            \begin{enumrm}
                \item\llabel{eq-c} $c = \explet{x}{c_1}{c_2}$, and
                % \item\llabel{eq-S} $S = \bind{S_1}{x}{S_2}$,
                \item\llabel{ty-c1} $\jdty{}{c_1}{\tycomp{\Sigma}{T_1}{\square}}$
                % \item\llabel{ty-c2} $\jdty{x: T_1}{c_2}{\tycomp{\Sigma}{T}{S_2}}$, and
                % \item\llabel{in-x} $x \notin \fv(T) \cup \fv(\Sigma)$
            \end{enumrm}
            for some $x, c_1, c_2$, and $T_1$.
            By the IH of \lref{ty-c1}, either one of the following three cases holds.
            \begin{itemize}
                \item $c_1 = \expret{v_1}$ for some $v_1$: \\
                    By \rulename{E-LetRet}, we have $\explet{x}{\expret{v_1}}{c_2} \eval c_2[v_1/x]$.
                \item $c_1 = K_1[\op~v_1]$ for some $K_1, \op$ and $v_1$ s.t. $\op \in \dom(\Sigma)$: \\
                    We have the conclusion with $c = K[\op~v_1]$ where $K = \explet{x}{K_1}{c_1}$.
                \item $c_1 \eval c_1'$ for some $c_1'$: \\
                    By \rulename{E-Let}, we have $\explet{x}{c_1}{c_2} \eval \explet{x}{c_1'}{c_2}$.
            \end{itemize}
        \item[Case \rulename{T-LetIp}:] Similar to the case for \rulename{T-LetP}.
        \item[Case \rulename{T-Hndl}:] We have
            \def\currentprefix{prog:hndl}
            \begin{enumrm}
                \item\llabel{eq-c} $c = \expwith{h}{c_0}$,
                \item\llabel{eq-h} $h = \{ \expret{x_r} \mapsto c_r, \repi{\op_i(x_i, k_i) \mapsto c_i} \}$,
                \item\llabel{eq-sig} $\Sigma_0 = \{ \repi{\op_i: \forall \rep{X_i: \rep{B}_i}. (x_i: T_{1i}) \rarr ((y_i: T_{2i}) \rarr C_{1i}) \rarr C_{2i}} \}$, and
                \item\llabel{ty-c0} $\jdty{}{c_0}{\tycomp{\Sigma_0}{T_0}{\tyctl{x_r}{C_1}{(\tycomp{\Sigma}{T}{S})}}}$
            \end{enumrm}
            for some $c_0, x_r, c_r, \repi{\op_i}, \repi{x_i}, \repi{k_i}, \repi{c_i}, \repi{\rep{X_i}}, \repi{\rep{\rep{B}_i}}, \repi{T_{1i}}, \repi{T_{2i}}, \repi{C_{1i}}, \repi{C_{2i}}, \Sigma_0, T_0$, and $C_1$.
            By the IH of \lref{ty-c0}, either one of the following three cases holds.
            \begin{itemize}
                \item $c_0 = \expret{v_0}$ for some $v_0$: \\
                    By \rulename{E-HndlRet}, we have $\expwith{h}{\expret{v_0}} \eval c_r[v_0/x_r]$.
                \item $c_0 = K_0[\op~v_0]$ for some $K_0, \op$, and $v_0$ s.t. $\op \in \dom(\Sigma_0)$: \\
                    Since $\op \in \dom(\Sigma_0) = \{ \repi{\op_i} \}$,
                    there exists some $j$ such that $1 \le j \le |\dom(\Sigma)|$ and $\op = \op_j$.
                    Then, by \rulename{E-HndlOp} we have
                    \[
                        \expwith{h}{K_0[\op_j~v_0]} \eval c_j[v_0/x_j][\expfun{y}{\expwith{h}{K_0[\expret{y}]}}/k_j]~.
                    \]
                \item $c_0 \eval c_0'$ for some $c_0'$: \\
                    By \rulename{E-Hndl}, we have $\expwith{h}{c_0} \eval \expwith{h}{c_0'}$.
            \end{itemize}
    \end{description}
\end{proof}