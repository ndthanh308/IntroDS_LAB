% depends on:: lem:refl lem:trans lem:narrow
\begin{proof}
    By induction on the derivations.
    \begin{enumit}
        \item Straightforward with Lemma \ref{lem:refl} and \ref{lem:trans}.
        \item Straightforward with Lemma \ref{lem:refl} and \ref{lem:trans}.
        \item Straightforward with Lemma \ref{lem:refl} and \ref{lem:trans}.
        \item 
        \def\currentprefix{inv:op}
        \begin{description}
            \item[Case \rulename{T-Op}:] Obvious with Lemma \ref{lem:refl}.
            \item[Case \rulename{T-CSub}:] We have
                \begin{enumrm}
                    \item\llabel{ty-op} $\jdty{\Gamma}{\op~v}{\tycomp{\Sigma'}{T'}{S'}}$,
                    \item\llabel{sub-C} $\jdsub{\Gamma}{\tycomp{\Sigma'}{T'}{S'}}{\tycomp{\Sigma}{T}{S}}$, and
                    \item $\jdwf{\Gamma}{\tycomp{\Sigma}{T}{S}}$
                \end{enumrm}
                for some $\Sigma', T'$, and $S'$.
                By the IH on \lref{ty-op}, we have
                \begin{enumrm}[resume]
                    \item\llabel{eq-S'} $S' = \tyctl{y}{C_{01}'}{C_{02}'}$,
                    \item\llabel{in-sig'} $\Sigma' \ni \op: \forall \rep{X: \rep{B}}. (x: T_1') \rarr ((y: T_2') \rarr C_1') \rarr C_2'$,
                    \item\llabel{wf-A} $\rep{\jdty{\Gamma}{A}{\rep{B}}}$,
                    \item\llabel{ty-v} $\jdty{\Gamma}{v}{T_1'[\rep{A/X}]}$,
                    \item\llabel{sub-T2'} $\jdsub{\Gamma}{T_2'[\rep{A/X}][v/x]}{T'}$,
                    \item\llabel{sub-C01'} $\jdsub{\Gamma, y: T_2'[\rep{A/X}][v/x]}{C_{01}'}{C_1'[\rep{A/X}][v/x]}$, and
                    \item\llabel{sub-C2'} $\jdsub{\Gamma}{C_2'[\rep{A/X}][v/x]}{C_{02}'}$
                \end{enumrm}
                for some $\rep{X}, \rep{\rep{B}}, \rep{A}, x, y, T_1', T_2', C_1', C_2', C_{01}'$, and $C_{02}'$.
                By inversion of \lref{sub-C}, we have
                \begin{enumrm}[resume]
                    \item\llabel{sub-sig} $\jdsub{\Gamma}{\Sigma}{\Sigma'}$,
                    \item\llabel{sub-T'} $\jdsub{\Gamma}{T'}{T}$, and
                    \item\llabel{sub-S'} $\jdsub{\Gamma \mid T'}{S'}{S}$~.
                \end{enumrm}
                By inversion of \lref{sub-S'} with \lref{eq-S'}, we have
                \begin{enumrm}[resume]
                    \item\llabel{eq-S} $S = \tyctl{y}{C_{01}}{C_{02}}$,
                    \item\llabel{sub-C01} $\jdsub{\Gamma, y: T'}{C_{01}}{C_{01}'}$, and
                    \item\llabel{sub-C02'} $\jdsub{\Gamma}{C_{02}'}{C_{02}}$
                \end{enumrm}
                for some $C_{01}$ and $C_{02}$.
                On the other hand,
                by inversion of \lref{sub-sig} with \lref{in-sig'} and Lemma~\ref{lem:rm-nonrfn}, we have
                \begin{enumrm}[resume]
                    \item\llabel{in-sig} $\Sigma \ni \op: \forall \rep{X: \rep{B}}. (x: T_1) \rarr ((y: T_2) \rarr C_1) \rarr C_2$,
                \end{enumrm}
                and
                \begin{itemize}
                    \item $\jdsub{\Gamma, \rep{X: \rep{B}}}{T_1'}{T_1}$,
                    \item $\jdsub{\Gamma, \rep{X: \rep{B}}, x: T_1'}{T_2}{T_2'}$,
                    \item $\jdsub{\Gamma, \rep{X: \rep{B}}, x: T_1', y: T_2}{C_1'}{C_1}$, and
                    \item $\jdsub{\Gamma, \rep{X: \rep{B}}, x: T_1'}{C_2}{C_2'}$
                \end{itemize}
                for some $T_1, T_2, C_1$ and $C_2$.
                Then, by Lemma~\ref{lem:subst-pred} with \lref{wf-A}
                and Lemma~\ref{lem:subst} with \lref{ty-v}, we have
                \begin{enumrm}[resume]
                    \item\llabel{sub-T1'} $\jdsub{\Gamma}{T_1'[\rep{A/X}]}{T_1[\rep{A/X}]}$,
                    \item\llabel{sub-T2} $\jdsub{\Gamma}{T_2[\rep{A/X}][v/x]}{T_2'[\rep{A/X}][v/x]}$,
                    \item\llabel{sub-C1'} $\jdsub{\Gamma, y: T_2[\rep{A/X}][v/x]}{C_1'[\rep{A/X}][v/x]}{C_1[\rep{A/X}][v/x]}$, and
                    \item\llabel{sub-C2} $\jdsub{\Gamma}{C_2[\rep{A/X}][v/x]}{C_2'[\rep{A/X}][v/x]}$~.
                \end{enumrm}
                By subsumption of \lref{ty-v} with \lref{sub-T1'},
                \begin{enumrm}[resume]
                    \item\llabel{ty-v-2} $\jdty{\Gamma}{v}{T_1[\rep{A/X}]}$~.
                \end{enumrm}
                By Lemma~\ref{lem:trans} with \lref{sub-T2}, \lref{sub-T2'} and \lref{sub-T'}, we have
                \begin{enumrm}[resume]
                    \item\llabel{sub-T2-T'} $\jdsub{\Gamma}{T_2[\rep{A/X}][v/x]}{T'}$ and
                    \item\llabel{sub-T2-T} $\jdsub{\Gamma}{T_2[\rep{A/X}][v/x]}{T}$~.
                \end{enumrm}
                By Lemma~\ref{lem:narrow} with ``\lref{sub-C01'} and \lref{sub-T2}'' and
                ``\lref{sub-C01} and \lref{sub-T2-T'}'' respectively, we have
                \begin{itemize}
                    \item $\jdsub{\Gamma, y: T_2[\rep{A/X}][v/x]}{C_{01}'}{C_1'[\rep{A/X}][v/x]}$ and
                    \item $\jdsub{\Gamma, y: T_2[\rep{A/X}][v/x]}{C_{01}}{C_{01}'}$~.
                \end{itemize}
                Then, by Lemma~\ref{lem:trans} with these two and \lref{sub-C1'}, we have
                \begin{enumrm}[resume]
                    \item\llabel{sub-C01-C1} $\jdsub{\Gamma, y: T_2[\rep{A/X}][v/x]}{C_{01}}{C_1[\rep{A/X}][v/x]}$~.
                \end{enumrm}
                Also, by Lemma~\ref{lem:trans} with \lref{sub-C2}, \lref{sub-C2'} and \lref{sub-C02'}, we have
                \begin{enumrm}[resume]
                    \item\llabel{sub-C2-C02} $\jdsub{\Gamma}{C_2[\rep{A/X}][v/x]}{C_{02}}$~.
                \end{enumrm}
                From \lref{in-sig}, \lref{wf-A}, \lref{ty-v-2}, \lref{sub-T2-T}, \lref{sub-C01-C1}
                and \lref{sub-C2-C02}, we have the conclusion.
        \end{description}
        \item
        \def\currentprefix{inv:letp}
        \begin{description}
            \item[Case \rulename{T-LetP}:] Obvious.
            \item[Case \rulename{T-LetIp}:] Contradictory.
            \item[Case \rulename{T-CSub}:] We have
                \begin{enumrm}
                    \item\llabel{ty-let} $\jdty{\Gamma}{\explet{x}{c_1}{c_2}}{\tycomp{\Sigma'}{T'}{S'}}$,
                    \item\llabel{sub-C'} $\jdsub{\Gamma}{\tycomp{\Sigma'}{T'}{S'}}{\tycomp{\Sigma}{T}{\square}}$, and
                    \item\llabel{wf-C} $\jdwf{\Gamma}{\tycomp{\Sigma}{T}{\square}}$
                \end{enumrm}
                for some $\Sigma', T'$, and $S'$.
                By inversion of \lref{sub-C'}, we have
                \begin{enumrm}[resume]
                    \item\llabel{eq-S'} $S = \square$,
                    \item\llabel{sub-sig'} $\jdsub{\Gamma}{\Sigma'}{\Sigma}$, and
                    \item\llabel{sub-T'} $\jdsub{\Gamma}{T'}{T}$~.
                \end{enumrm}
                Then, by the IH of \lref{ty-let}, we have
                \begin{enumrm}[resume]
                    \item\llabel{ty-c1} $\jdty{\Gamma}{c_1}{\tycomp{\Sigma'}{T_1}{\square}}$ and
                    \item\llabel{ty-c2} $\jdty{\Gamma, x: T_1}{c_2}{\tycomp{\Sigma'}{T'}{\square}}$
                    % \item $x \notin \fv(T') \cup \fv(\Sigma')$
                \end{enumrm}
                for some $T_1$.
                By subsumption of \lref{ty-c1} with \lref{sub-sig'}, we have
                \begin{enumrm}[resume]
                    \item\llabel{ty-c1-2} $\jdty{\Gamma}{c_1}{\tycomp{\Sigma}{T_1}{\square}}$~.
                \end{enumrm}
                By Lemma~\ref{lem:wfg} with \lref{ty-c2}, we have
                \begin{enumrm}[resume]
                    \item\llabel{wf-Gx} $\jdwf{}{\Gamma, x: T_1}{}$~.
                \end{enumrm}
                Then it holds that $x \notin \dom(\Gamma)$ and hence from \lref{wf-C} we have
                \begin{enumrm}[resume]
                    \item\llabel{in-x} $x \notin \fv(T) \cup \fv(\Sigma)$~.
                \end{enumrm}
                Also, by Lemma~\ref{lem:weaken} with \lref{sub-C'} and \lref{wf-Gx}, we have
                \begin{itemize}
                    \item $\jdsub{\Gamma, x: T_1}{\tycomp{\Sigma'}{T'}{\square}}{\tycomp{\Sigma}{T}{\square}}$~.
                \end{itemize}
                Then by subsumption of \lref{ty-c2} we have
                \begin{enumrm}[resume]
                    \item\llabel{ty-c2-2} $\jdty{\Gamma, x: T_1}{c_2}{\tycomp{\Sigma}{T}{\square}}$~.
                \end{enumrm}
                Now we have the conclusion from \lref{ty-c1-2}, \lref{ty-c2-2} and \lref{in-x}.
        \end{description}
        \item
        \def\currentprefix{inv:leti}
        \begin{description}
            \item[Case \rulename{T-LetP}:] Contradictory.
            \item[Case \rulename{T-LetIp}:] Obvious.
            \item[Case \rulename{T-CSub}:] We have
                \begin{enumrm}
                    \item\llabel{ty-let} $\jdty{\Gamma}{\explet{x}{c_1}{c_2}}{\tycomp{\Sigma'}{T'}{S'}}$,
                    \item\llabel{sub-C'} $\jdsub{\Gamma}{\tycomp{\Sigma'}{T'}{S'}}{\tycomp{\Sigma}{T}{\tyctl{z}{C_1}{C_2}}}$, and
                    \item\llabel{wf-C} $\jdwf{\Gamma}{\tycomp{\Sigma}{T}{\tyctl{z}{C_1}{C_2}}}$
                \end{enumrm}
                for some $\Sigma', T'$, and $S'$.
                By inversion of \lref{sub-C'}, we have
                \begin{enumrm}[resume]
                    \item\llabel{sub-sig'} $\jdsub{\Gamma}{\Sigma'}{\Sigma}$,
                    \item\llabel{sub-T'} $\jdsub{\Gamma}{T'}{T}$, and
                    \item\llabel{sub-S'} $\jdsub{\Gamma \mid T'}{S'}{\tyctl{z}{C_1}{C_2}}$~.
                \end{enumrm}
                Case analysis on the derivation of \lref{sub-S'}.
                \begin{description}
                    \item[Case \rulename{S-Pure}:] Contradictory.
                    \item[Case \rulename{S-ATM}:] We have
                        \begin{enumrm}[resume]
                            \item\llabel{eq-S'} $S' = \tyctl{z}{C_1'}{C_2'}$,
                            \item\llabel{sub-C1} $\jdsub{\Gamma, z: T'}{C_1}{C_1'}$, and
                            \item\llabel{sub-C2'} $\jdsub{\Gamma}{C_2'}{C_2}$
                        \end{enumrm}
                        for some $C_1'$ and $C_2'$.
                        Then, by the IH of \lref{ty-let}, we have
                        \begin{enumrm}[resume]
                            \item\llabel{ty-c1} $\jdty{\Gamma}{c_1}{\tycomp{\Sigma'}{T_1}{\tyctl{x}{C_0}{C_2'}}}$ and
                            \item\llabel{ty-c2} $\jdty{\Gamma, x: T_1}{c_2}{\tycomp{\Sigma'}{T'}{\tyctl{z}{C_1'}{C_0}}}$
                            % \item $x \notin \fv(T') \cup \fv(\Sigma') \cup (\fv(C_1') \setminus \{z\})$
                        \end{enumrm}
                        for some $T_1$ and $C_0$.
                        By subsumption of \lref{ty-c1} with \lref{sub-sig'} and \lref{sub-C2'}, we have
                        \begin{enumrm}[resume]
                            \item\llabel{ty-c1-2} $\jdty{\Gamma}{c_1}{\tycomp{\Sigma}{T_1}{\tyctl{x}{C_0}{C_2}}}$~.
                        \end{enumrm}
                        By Lemma~\ref{lem:wfg} with \lref{ty-c2}, we have
                        \begin{enumrm}[resume]
                            \item\llabel{wf-Gx} $\jdwf{}{\Gamma, x: T_1}$~.
                        \end{enumrm}
                        Then it holds that $x \notin \dom(\Gamma)$ and hence from \lref{wf-C} we have
                        \begin{enumrm}[resume]
                            \item\llabel{in-x} $x \notin \fv(T) \cup \fv(\Sigma) \cup (\fv(C_1) \setminus \{z\})$~.
                        \end{enumrm}
                        Also, by Lemma~\ref{lem:weaken} with \lref{sub-sig'}, \lref{sub-T'}, \lref{sub-C1}
                        and \lref{wf-Gx}, we have
                        \begin{itemize}
                            \item $\jdsub{\Gamma, x: T_1}{\Sigma'}{\Sigma}$,
                            \item $\jdsub{\Gamma, x: T_1}{T'}{T}$, and
                            \item $\jdsub{\Gamma, x: T_1, z: T'}{C_1}{C_1'}$~.
                        \end{itemize}
                        Then by subsumption of \lref{ty-c2} we have
                        \begin{enumrm}[resume]
                            \item\llabel{ty-c2-2} $\jdty{\Gamma, x: T_1}{c_2}{\tycomp{\Sigma}{T}{\tyctl{z}{C_1}{C_0}}}$~.
                        \end{enumrm}
                        Now we have the conclusion from \lref{ty-c1-2}, \lref{ty-c2-2} and \lref{in-x}.
                    \item[Case \rulename{S-Embed}:] We have
                        \begin{enumrm}[resume]
                            \item\llabel{eq-S'-pure} $S' = \square$,
                            \item\llabel{sub-C1-C2} $\jdsub{\Gamma, z: T}{C_1}{C_2}$, and
                            \item\llabel{in-z} $z \notin \fv(C_2)$~.
                        \end{enumrm}
                        Then, by Lemma~\ref{lem:inv} with \lref{ty-let}, we have
                        \begin{enumrm}[resume]
                            \item\llabel{ty-c1-} $\jdty{\Gamma}{c_1}{\tycomp{\Sigma'}{T_1}{\square}}$ and
                            \item\llabel{ty-c2-} $\jdty{\Gamma, x: T_1}{c_2}{\tycomp{\Sigma'}{T'}{\square}}$
                            % \item $x \notin \fv(T') \cup \fv(\Sigma')$
                        \end{enumrm}
                        for some $T_1$.
                        By Lemma~\ref{lem:wfg} with \lref{ty-c2-}, we have
                        \begin{enumrm}[resume]
                            \item\llabel{wf-Gx-} $\jdwf{}{\Gamma, x: T_1}$~.
                        \end{enumrm}
                        Then it holds that $x \notin \dom(\Gamma)$ and hence from \lref{wf-C} we have
                        \begin{enumrm}[resume]
                            \item\llabel{in-x-} $x \notin \fv(T) \cup \fv(\Sigma) \cup (\fv(C_1) \setminus \{z\})$ and
                            \item\llabel{in-x-2-} $x \notin \fv(C_2)$~.
                        \end{enumrm}
                        Also, by inversion of \lref{wf-C} we have $\jdwf{\Gamma}{C_2}$, and so we have
                        $\jdsub{\Gamma}{C_2}{C_2}$ by Lemma~\ref{lem:refl}.
                        Then, by Lemma~\ref{lem:weaken} with \lref{wf-Gx-} we have
                        $\jdsub{\Gamma, x: T_1}{C_2}{C_2}$.
                        And hence, by \rulename{S-Embed} with \lref{in-x-2-} we have
                        \begin{itemize}
                            \item $\jdsub{\Gamma \mid T_1}{\square}{\tyctl{x}{C_2}{C_2}}$~.
                        \end{itemize}
                        Therefore, by subsumption of \lref{ty-c1-} with \lref{sub-sig'}, we have
                        \begin{enumrm}[resume]
                            \item\llabel{ty-c1-2-} $\jdty{\Gamma}{c_1}{\tycomp{\Sigma}{T_1}{\tyctl{x}{C_2}{C_2}}}$~.
                        \end{enumrm}
                        Moreover, by Lemma~\ref{lem:weaken} with \lref{sub-C'} and \lref{wf-Gx-}, we have
                        \begin{itemize}
                            \item $\jdsub{\Gamma, x: T_1}{\tycomp{\Sigma'}{T'}{\square}}{\tycomp{\Sigma}{T}{\tyctl{z}{C_1}{C_2}}}$~.
                        \end{itemize}
                        Then by subsumption of \lref{ty-c2-} we have
                        \begin{enumrm}[resume]
                            \item\llabel{ty-c2-2-} $\jdty{\Gamma, x: T_1}{c_2}{\tycomp{\Sigma}{T}{\tyctl{z}{C_1}{C_2}}}$~.
                        \end{enumrm}
                        Now we have the conclusion from \lref{ty-c1-2-}, \lref{ty-c2-2-} and \lref{in-x-}.
                \end{description}
        \end{description}
    \end{enumit}
\end{proof}