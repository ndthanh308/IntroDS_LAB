% depend on:: asm:cps:prim asm:cps:formula
%             lem:cps:presv-wf lem:cps:presv-wf lem:cps:presv-sub
%             lem:cps:weaken lem:cps:homo-subst
\begin{proof}
    By simultaneous induction on the typing derivation of the source language.
    \begin{enumit}
        \item 
        \begin{description}
            \item[Case \rulename{T-CVar}:] By Lemma \ref{lem:cps:presv-wf},
                definition of CPS transformation of typing contexts, and \rulename{Tc-CVar}.
            \item[Case \rulename{T-Var}:] By Lemma \ref{lem:cps:presv-wf},
                definition of CPS transformation of typing contexts, and \rulename{Tc-Var}.
            \item[Case \rulename{T-Prim}:] By Lemma \ref{lem:cps:presv-wf},
                Assumption \ref{asm:cps:prim-cps}, and \rulename{Tc-Prim}.
            \item[Case \rulename{T-Fun}:] By the IH and \rulename{Tc-Fun}.
            \item[Case \rulename{T-VSub}:] By the IH, Lemma \ref{lem:cps:presv-sub},
                Lemma \ref{lem:cps:presv-wf} and \rulename{Tc-Sub}.
        \end{description}
        \item 
        \begin{description}
            \item[Case \rulename{T-Ret}:] we have
                \begin{itemize}
                    \item $c = \expret{v}$,
                    \item $C = \tycomp{\{\}}{T}{\square}$, and
                    \item $\jdty{\Gamma}{v}{T}$
                \end{itemize}
                for some $v$ and $T$.
                Then, we have
                \begin{itemize}
                    \item $\cps{c} = \Lambda \alpha. \lambda h:\{\}. \lambda k:\cps{T} \rarr \alpha. k~\cps{v}$ and
                    \item $\cps{C} = \forall \alpha. \{\} \rarr (\cps{T} \rarr \alpha) \rarr \alpha$~.
                \end{itemize}
                By the IH, we have
                \begin{itemize}
                    \item $\jdty{\cps{\Gamma}}{\cps{v}}{\cps{T}}$~.
                \end{itemize}
                We have the conclusion by the following derivation with Lemma \ref{lem:cps:weaken}:
                \[
                    \infersc[Tc-TAbs]{\jdty{\cps{\Gamma}}{\Lambda \alpha. \lambda h:\{\}. \lambda k:\cps{T} \rarr \alpha. k~\cps{v}}
                        {\forall \alpha. \{\} \rarr (\cps{T} \rarr \alpha) \rarr \alpha}}
                    {
                        \infersc[Tc-Lam]{\jdty{\cps{\Gamma}, \alpha}{\lambda h:\{\}. \lambda k:\cps{T} \rarr \alpha. k~\cps{v}}
                            {\{\} \rarr (\cps{T} \rarr \alpha) \rarr \alpha}}
                        {
                            \infersc[Tc-Lam]{\jdty{\cps{\Gamma}, \alpha, h: \{\}}{\lambda k\cps{T} \rarr \alpha. k~\cps{v}}
                                {(\cps{T} \rarr \alpha) \rarr \alpha}}
                            {
                                \infersc[Tc-App]{\jdty{\cps{\Gamma}, \alpha, h: \{\}, k:\cps{T} \rarr \alpha}
                                    {k~\cps{v}}{\alpha}}
                                {
                                    \infersc[Tc-Var]{\jdty{\Gamma_{\alpha,h,k}}
                                        {k}{\cps{T} \rarr \alpha}}
                                    {}
                                    &
                                    \jdty{\Gamma_{\alpha,h,k}}
                                        {\cps{v}}{\cps{T}}
                                }
                            }
                        }
                    }
                \]
                where $\Gamma_{\alpha,h,k} \defeq \cps{\Gamma}, \alpha, h: \{\}, k:\cps{T} \rarr \alpha$~.
            \item[Case \rulename{T-App}:] By the IH, Lemma \ref{lem:cps:homo-subst}
                and \rulename{Tc-App}.
            \item[Case \rulename{T-If}:] By the IH, \rulename{Tc-If} and \rulename{Tc-Ascr}.
            \item[Case \rulename{T-CSub}:] similar to the case for \rulename{T-VSub}.
            \item[Case \rulename{T-LetP}:] We have
                \begin{itemize}
                    \item $c = \explet{x}{c_1}{c_2}$,
                    \item $C = \tycomp{\Sigma}{T_2}{\square}$,
                    \item $\jdty{\Gamma}{c_1}{\tycomp{\Sigma}{T_1}{\square}}$,
                    \item $\jdty{\Gamma, x: T_1}{c_2}{\tycomp{\Sigma}{T_2}{\square}}$, and
                    \item $x \notin \fv(T_2) \cup \fv(\Sigma)$
                \end{itemize}
                for some $x, c_1, c_2, \Sigma, T_1$ and $T_2$.
                Then we have
                \begin{itemize}
                    \item $\cps{c} = \Lambda \alpha. \lambda h: \cps{\Sigma}. \lambda k:\cps{T_2} \rarr \alpha.
                        \cps{c_1}~\alpha~h~(\lambda x:\cps{T_1}. \cps{c_2}~\alpha~h~k)$ and
                    \item $\cps{C} = \forall \alpha. \cps{\Sigma} \rarr (\cps{T_2} \rarr \alpha) \rarr \alpha$~.
                \end{itemize}
                By Lemma \ref{lem:cps:presv-fv}, we have
                \begin{itemize}
                    \item $x \notin \fv(\cps{T_2}) \cup \fv(\cps{\Sigma})$~.
                \end{itemize}
                Also, by the IHs, we have
                \begin{itemize}
                    \item $\jdty{\cps{\Gamma}}{\cps{c_1}}
                        {\forall \beta. \cps{\Sigma} \rarr (\cps{T_1} \rarr \beta) \rarr \beta}$ and
                    \item $\jdty{\cps{\Gamma}, x:\cps{T_1}}{\cps{c_2}}
                        {\forall \gamma. \cps{\Sigma} \rarr (\cps{T_2} \rarr \gamma) \rarr \gamma}$~.
                \end{itemize}
                We have the conclusion by the following derivations with Lemma \ref{lem:cps:weaken}:
                \[  (A):
                    \infersc[Tc-App]{
                        \jdty{\cps{\Gamma}_{\alpha, h, k}}
                            {\cps{c_1}~\alpha~h}{(\cps{T_1} \rarr \alpha) \rarr \alpha}
                    }{
                        \infersc[Tc-App]{
                            \jdty{\Gamma_{\alpha, h, k}}
                                {\cps{c_1}~\alpha~h}{(\cps{T_1} \rarr \alpha) \rarr \alpha}
                        }{
                            \infersc[Tc-TApp]{
                                \jdty{\Gamma_{\alpha, h, k}}
                                    {\cps{c_1}~\alpha}{\cps{\Sigma} \rarr (\cps{T_1} \rarr \alpha) \rarr \alpha}
                            }{
                                \jdty{\Gamma_{\alpha, h, k}}
                                    {\cps{c_1}}{\forall \beta. \cps{\Sigma} \rarr (\cps{T_1} \rarr \beta) \rarr \beta}
                                &
                                \jdwf{\Gamma_{\alpha, h, k}}{\alpha}
                            }
                            &
                            \infersc[Tc-Var]{
                                \jdty{\Gamma_{\alpha, h, k}}
                                    {h}{\cps{\Sigma}}
                            }{}
                        }
                    }
                \]
                \[  (B):
                    \infersc[Tc-App]{
                        \jdty{\Gamma_{\alpha, h, k, x}}
                            {\cps{c_2}~\alpha~h}{(\cps{T_2} \rarr \alpha) \rarr \alpha}
                    }{
                        \infersc[Tc-TApp]{
                            \jdty{\Gamma_{\alpha, h, k, x}}
                                {\cps{c_2}~\alpha}{\cps{\Sigma} \rarr (\cps{T_2} \rarr \alpha) \rarr \alpha}
                        }{
                            \jdty{\Gamma_{\alpha, h, k, x}}
                                {\cps{c_2}}{\forall \gamma. \cps{\Sigma} \rarr (\cps{T_2} \rarr \gamma) \rarr \gamma}
                            &
                            \jdwf{\Gamma_{\alpha, h, k, x}}{\alpha}
                        }
                        &
                        \infersc[Tc-Var]{
                            \jdty{\Gamma_{\alpha, h, k, x}}
                                {h}{\cps{\Sigma}}
                        }{}
                    }
                \]
                \[
                    \infersc[Tc-TAbs]{
                        \jdty{\cps{\Gamma}}{\Lambda \alpha. \lambda h: \cps{\Sigma}. \lambda k:\cps{T_2} \rarr \alpha.
                            \cps{c_1}~\alpha~h~(\lambda x:\cps{T_1}. \cps{c_2}~\alpha~h~k)}
                            {\forall \alpha. \cps{\Sigma} \rarr (\cps{T_2} \rarr \alpha) \rarr \alpha}
                    }{
                        \infersc[Tc-Fun]{
                            \jdty{\cps{\Gamma}, \alpha}{\lambda h: \cps{\Sigma}. \lambda k:\cps{T_2} \rarr \alpha.
                                \cps{c_1}~\alpha~h~(\lambda x:\cps{T_1}. \cps{c_2}~\alpha~h~k)}
                                {\cps{\Sigma} \rarr (\cps{T_2} \rarr \alpha) \rarr \alpha}
                        }{
                            \infersc[Tc-Fun]{
                                \jdty{\cps{\Gamma}, \alpha, h: \cps{\Sigma}}{\lambda k:\cps{T_2} \rarr \alpha.
                                    \cps{c_1}~\alpha~h~(\lambda x:\cps{T_1}. \cps{c_2}~\alpha~h~k)}
                                    {(\cps{T_2} \rarr \alpha) \rarr \alpha}
                            }{
                                \infersc[Tc-App]{
                                    \jdty{\cps{\Gamma}, \alpha, h: \cps{\Sigma}, k:\cps{T_2} \rarr \alpha}{
                                        \cps{c_1}~\alpha~h~(\lambda x:\cps{T_1}. \cps{c_2}~\alpha~h~k)}
                                        {\alpha}
                                }{
                                    (A)
                                    &
                                    \infersc[Tc-Fun]{
                                        \jdty{\Gamma_{\alpha, h, k}}
                                            {\lambda x:\cps{T_1}. \cps{c_2}~\alpha~h~k}{\cps{T_1} \rarr \alpha}
                                    }{
                                        \infersc[Tc-App]{
                                            \jdty{\Gamma_{\alpha, h, k}, x:\cps{T_1}}
                                                {\cps{c_2}~\alpha~h~k}{\alpha}
                                        }{
                                            (B)
                                            &
                                            \infersc[Tc-Var]{
                                                \jdty{\Gamma_{\alpha, h, k, x}}
                                                    {k}{\cps{T_2} \rarr \alpha}
                                            }{}
                                        }
                                    }
                                }
                            }
                        }
                    }
                \]
                where $\Gamma_{\alpha, h, k} \defeq \cps{\Gamma}, \alpha, h: \cps{\Sigma}, k:\cps{T_2} \rarr \alpha$
                and $\Gamma_{\alpha, h, k, x} \defeq \Gamma_{\alpha, h, k}, x:\cps{T_1}$~.
            \item[Case \rulename{T-LetIp}:] We have
                \begin{itemize}
                    \item $c = \explet{x}{c_1}{c_2}$,
                    \item $C = \tycomp{\Sigma}{T_2}{\tyctl{z}{C_0}{C_2}}$,
                    \item $\jdty{\Gamma}{c_1}{\tycomp{\Sigma}{T_1}{\tyctl{x}{C_1}{C_2}}}$,
                    \item $\jdty{\Gamma, x: T_1}{c_2}{\tycomp{\Sigma}{T_2}{\tyctl{z}{C_0}{C_1}}}$, and
                    \item $x \notin \fv(T_2) \cup \fv(\Sigma) \cup (\fv(C_0) \setminus \{z\})$
                \end{itemize}
                for some $x, z, c_1, c_2, \Sigma, T_1, T_2, C_0, C_1$ and $C_2$.
                Then we have
                \begin{itemize}
                    \item $\cps{c} = \Lambda \alpha. \lambda h: \cps{\Sigma}. \lambda k:(z:\cps{T_2}) \rarr \cps{C_0}.
                        \cps{c_1}~\cps{C_2}~h~(\lambda x:\cps{T_1}. \cps{c_2}~\cps{C_1}~h~k)$ and
                    \item $\cps{C} = \forall \alpha. \cps{\Sigma} \rarr ((z:\cps{T_2}) \rarr \cps{C_0}) \rarr \cps{C_2}$~.
                \end{itemize}
                By Lemma \ref{lem:cps:presv-fv}, we have
                \begin{itemize}
                    \item $x \notin \fv(\cps{T_2}) \cup \fv(\cps{\Sigma}) \cup (\fv(\cps{C_0}) \setminus \{z\})$~.
                \end{itemize}
                Also, by the IHs, we have
                \begin{itemize}
                    \item $\jdty{\cps{\Gamma}}{\cps{c_1}}
                        {\forall \alpha. \cps{\Sigma} \rarr ((x:\cps{T_1}) \rarr \cps{C_1}) \rarr \cps{C_2}}$ and
                    \item $\jdty{\cps{\Gamma}, x:\cps{T_1}}{\cps{c_2}}
                        {\forall \alpha. \cps{\Sigma} \rarr ((z:\cps{T_2}) \rarr \cps{C_0}) \rarr \cps{C_1}}$~.
                \end{itemize}
                We have the conclusion by a straightforward derivation
                like the case for \rulename{T-LetP}
                using those judgements shown so far and Lemma \ref{lem:cps:weaken}.
            \item[Case \rulename{T-Op}:]
                (In this case, we use Lemma \ref{lem:cps:homo-subst} frequently and implicitly.) \\
                We have
                \begin{itemize}
                    \item $c = \op~v$,
                    \item $C = \tycomp{\Sigma}{T_2[\rep{A/X}][v/x]}{\tyctl{y}{C_1[\rep{A/X}][v/x]}{C_2[\rep{A/X}][v/x]}}$,
                    \item $\Sigma \ni \op: \forall \rep{X: \rep{B}}. (x: T_1) \rarr ((y: T_2) \rarr C_1) \rarr C_2$,
                    \item $\jdwf{\Gamma}{\Sigma}$,
                    \item $\rep{\jdty{\Gamma}{A}{\rep{B}}}$, and
                    \item $\jdty{\Gamma}{v}{T_1[\rep{A/X}]}$
                \end{itemize}
                for some $x, y, v, \rep{X}, \rep{A}, \rep{\rep{B}}, \Sigma, T_1, T_2, C_1$ and $C_2$.
                Then, we have
                \begin{itemize}
                    \item $\cps{c} = \Lambda \alpha. \lambda h:\cps{\Sigma}. \lambda k:(y: \cps{T_2}[\rep{A/X}][\cps{v}/x] \rarr \cps{C_1}[\rep{A/X}][\cps{v}/x]).$\\
                        \hspace*{180pt} $h\#\op~\rep{A}~\cps{v}~(\lambda y':\cps{T_2}[\rep{A/X}][\cps{v}/x]. k~y')$,
                    \item $\cps{C} = \forall \alpha. \cps{\Sigma} \rarr ((y: \cps{T_2}[\rep{A/X}][\cps{v}/x]) \rarr \cps{C_1}[\rep{A/X}][\cps{v}/x]) \rarr \cps{C_2}[\rep{A/X}][\cps{v}/x]$, and
                    \item $\cps{\Sigma} \ni \op: \forall \rep{X: \rep{B}}. (x: \cps{T_1}) \rarr ((y: \cps{T_2}) \rarr \cps{C_1}) \rarr \cps{C_2}$~.
                \end{itemize}
                Also, by the IHs, we have
                \begin{itemize}
                    \item $\jdty{\cps{\Gamma}}{\cps{v}}{\cps{T_1}[\rep{A/X}]}$~.
                \end{itemize}
                By Assumption~\ref{asm:cps:formula-cps}, we have
                \begin{itemize}
                    \item $\rep{\jdty{\cps{\Gamma}}{A}{\rep{B}}}$~.
                \end{itemize}
                We have the conclusion by a straightforward derivation
                like the cases for \rulename{T-Ret} and \rulename{T-LetP}
                using those judgements shown so far and Lemma \ref{lem:cps:weaken}.
            \item[Case \rulename{T-Hndl}:] We have
                \begin{itemize}
                    \item $c = \expwith{h}{c_0}$,
                    \item $h = \{ \expret{x_r} \mapsto c_r, \repi{\op_i(x_i, k_i) \mapsto c_i} \}$,
                    \item $\jdty{\Gamma}{c_0}{\tycomp{\Sigma_0}{T_r}{\tyctl{x_r}{C_1}{C}}}$,
                    \item $\jdty{\Gamma, x_r: T_r}{c_r}{C_1}$,
                    \item $\bigrepi{\jdty{\Gamma, \rep{X_i: \rep{B}_i}, x_i: T_{i1}, k_i: (y_i: T_{i2}) \rarr C_{i1}}{c_i}{C_{i2}}}$, and
                    \item $\Sigma_0 = \{ \repi{\op_i: \forall \rep{X_i: \rep{B}_i}. (x_i: T_{i1}) \rarr ((y_i: T_{i2}) \rarr C_{i1}) \rarr C_{2i}} \}$
                \end{itemize}
                Then, we have
                \begin{itemize}
                    \item $\cps{c} = \cps{c_0}~\cps{C}~\cps{h^{\mathit{ops}}}~\cps{h^{\mathit{ret}}}$,
                    \item $\cps{h^{\mathit{ret}}} = \lambda x_r:\cps{T_r}. \cps{c_r}$,
                    \item $\cps{h^{\mathit{ops}}} = \{ \repi{\op_i = \Lambda \rep{X_i: \rep{B_i}}. \lambda x_i:\cps{T_{i1}}. \lambda k_i:(y_i:\cps{T_{i2}}) \rarr \cps{C_{i1}}. \cps{c_i}} \}$, and
                    \item $\cps{\Sigma_0} = \{ \repi{\op_i: \forall \rep{X_i: \rep{B}_i}. (x_i: \cps{T_{i1}}) \rarr ((y_i: \cps{T_{i2}}) \rarr \cps{C_{i1}}) \rarr \cps{C_{i2}}} \}$~.
                \end{itemize}
                Also, by the IHs, we have
                \begin{itemize}
                    \item $\jdty{\cps{\Gamma}}{\cps{c_0}}{\forall \alpha. \cps{\Sigma_0} \rarr ((x_r: \cps{T_r}) \rarr \cps{C_1}) \rarr \cps{C}}$,
                    \item $\jdty{\cps{\Gamma}, x_r: \cps{T_r}}{\cps{c_r}}{\cps{C_1}}$, and
                    \item $\bigrepi{\jdty{\cps{\Gamma}, \rep{X_i: \rep{B}_i}, x_i: \cps{T_{i1}}, k_i: (y_i: \cps{T_{i2}}) \rarr \cps{C_{i1}}}{\cps{c_i}}{\cps{C_{i2}}}}$~.
                \end{itemize}
                We have the conclusion by a straightforward derivation
                like the cases for \rulename{T-Ret} and \rulename{T-LetP}
                using those judgements shown so far and Lemma \ref{lem:cps:weaken}.
                % We have the conclusion by the following derivations with Lemma \ref{lem:cps:weaken}:
                % \todo[derivation]
        \end{description}
    \end{enumit}
\end{proof}