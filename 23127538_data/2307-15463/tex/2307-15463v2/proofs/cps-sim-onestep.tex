% depends on:: asm:cps:prim-dyn
%              lem:cps:homo-subst-term lem:cps:pure-eval-ctx
\begin{proof}
    By induction on the derivation of $c \eval c'$.
    In the following, we implicitly use Lemma~\ref{lem:cps:homo-subst-term} and
    the equality $c[\tau/\alpha] = c$ and $c[A/X] = c$
    (note that we identify computations modulo types and predicates regarding dynamic semantics).
    \begin{description}
        \item[Case \rulename{E-Let}:]
            \begin{align}
                \text{LHS} &= \cps{\explet{x}{c_1}{c_2}} \stappBHK \\
                &= (\stLambda \alpha. \stlambda h. \stlambda k.
                    \cps{c_1} \stapp \tau \stapp h \stapp (\lambda x. \cps{c_2} \stapp \tau \stapp h \stapp k))
                    \stappBHK \\
                &\eval^* \cps{c_1} \stapp \tau \stapp v_h \stapp (\lambda x. \cps{c_2} \stapp \tau \stapp v_h \stapp v_k) \\
                &\text{(by the IH)} \\
                &\eval^* \cps{c_1'} \stapp \tau \stapp v_h \stapp (\lambda x. \cps{c_2} \stapp \tau \stapp v_h \stapp v_k) \\
                % &\text{(by equality of the meta language)} \\
                &\equiv_\beta (\stLambda \alpha. \stlambda h. \stlambda k.
                    \cps{c_1'} \stapp \tau \stapp h \stapp (\lambda x. \cps{c_2} \stapp \tau \stapp h \stapp k))
                    \stappBHK \\
                &= \cps{\explet{x}{c_1'}{c_2}} \stappBHK \\
                &= \text{RHS}
            \end{align}
        \item[Case \rulename{E-LetRet}:]
            First, w.l.o.g., we can assume that $x \notin \fv(v_h) \cup \fv(v_k)$. Then,
            \begin{align}
                \text{LHS} &= \cps{\explet{x}{\expret{v}}{c_2}} \stappBHK \\
                &= (\stLambda \alpha. \stlambda h. \stlambda k.
                    \cps{\expret{v}} \stapp \tau \stapp h \stapp (\lambda x. \cps{c_2} \stapp \tau \stapp h \stapp k))
                    \stappBHK \\
                &\eval^* \cps{\expret{v}} \stapp \tau \stapp v_h \stapp (\lambda x. \cps{c_2} \stapp \tau \stapp v_h \stapp v_k) \\
                &= (\stLambda \alpha. \stlambda h. \stlambda k. k~\cps{v})
                    \stapp \tau \stapp v_h \stapp (\lambda x. \cps{c_2} \stapp \tau \stapp v_h \stapp v_k) \\
                &\eval^* (\lambda x. \cps{c_2} \stapp \tau \stapp v_h \stapp v_k)~\cps{v} \\
                &\eval (\cps{c_2} \stapp \tau \stapp v_h \stapp v_k)[\cps{v}/x] \\
                &= (\cps{c_2} \stapp \tau \stapp v_h \stapp v_k)[\cps{v}/x] \\
                &= \cps{c_2}[\cps{v}/x] \stapp \tau \stapp v_h \stapp v_k \\
                &= \cps{c_2[v/x]} \stapp \tau \stapp v_h \stapp v_k \\
                &= \text{RHS}
            \end{align}
        \item[Case \rulename{E-IfT}:]
            \begin{align}
                \text{LHS} &= \cps{(\expif{\exptrue}{c_1}{c_2})^C} \stappBHK \\
                &= (\expif{\exptrue}{\cps{c_1}}{\cps{c_2}} : \cps{C}) \stappBHK \\
                &\eval^* \cps{c_1} \stappBHK \\
                &= \text{RHS}
            \end{align}
        \item[Case \rulename{E-IfF}:] similar.
        \item[Case \rulename{E-App}:]
            \begin{align}
                \text{LHS} &= \cps{(\exprec{f}{x}{c})~v} \stappBHK \\
                &= (\exprec{f}{x}{\cps{c}})~\cps{v} \stappBHK \\
                &\eval \cps{c}[\exprec{f}{x}{\cps{c}}/f, \cps{v}/x] \stappBHK \\
                &= \cps{c[\exprec{f}{x}{c}/f, v/x]} \stappBHK \\
                &= \text{RHS}
            \end{align}
        \item[Case \rulename{E-Prim}:] By Assumption~\ref{asm:cps:prim-dyn}.
        \item[Case \rulename{E-Hndl}:]
            \begin{align}
                \text{LHS} &= \cps{\expwith{h}{c}} \stappBHK \\
                &= (\cps{c} \stapp \tau \stapp \cps{h^{\mathit{ops}}} \stapp \cps{h^{\mathit{ret}}})
                    \stappBHK \\
                &\text{(by the IH)} \\
                &= (\cps{c'} \stapp \tau \stapp \cps{h^{\mathit{ops}}} \stapp \cps{h^{\mathit{ret}}})
                    \stappBHK \\
                &= \cps{\expwith{h}{c'}} \stappBHK \\
                &= \text{RHS}
            \end{align}
        \item[Case \rulename{E-HndlRet}:]
            \begin{align}
                \text{LHS} &= \cps{\expwith{h}{\expret{v}}} \stappBHK \\
                &= (\cps{\expret{v}} \stapp \tau \stapp \cps{h^{\mathit{ops}}} \stapp \cps{h^{\mathit{ret}}})
                    \stappBHK \\
                &= (((\stLambda \alpha. \stlambda h. \stlambda k. k~\cps{v}))
                    \stapp \tau \stapp \cps{h^{\mathit{ops}}} \stapp \cps{h^{\mathit{ret}}})
                    \stappBHK \\
                &\eval^* (\cps{h^{\mathit{ret}}}~\cps{v}) \stappBHK \\
                &= ((\lambda x_r. \cps{c_r})~\cps{v}) \stappBHK \\
                &= \cps{c_r}[\cps{v}/x_r] \stappBHK \\
                &= \cps{c_r[v/x_r]} \stappBHK \\
                &= \text{RHS}
            \end{align}
        \item[Case \rulename{E-HndlOp}:]
            \begin{align}
                \text{LHS} &= \cps{\expwith{h}{K[\op_i~v]}} \stappBHK \\
                &= (\cps{K[\op_i~v]} \stapp \tau \stapp \cps{h^{\mathit{ops}}} \stapp \cps{h^{\mathit{ret}}})
                    \stappBHK \\
                &\text{(by Lemma~\ref{lem:cps:pure-eval-ctx})} \\
                &\eval^* \cps{h^{\mathit{ops}}}\#\op_i~\rep{A}~\cps{v}
                    ~(\lambda y. \cps{K[\expret{y}]} \stapp \tau \stapp \cps{h^{\mathit{ops}}} \stapp \cps{h^{\mathit{ret}}}) \\
                &= \cps{h^{\mathit{ops}}}\#\op_i~\rep{A}~\cps{v}~(\lambda y. \cps{\expwith{h}{K[\expret{y}]}}) \\
                &\eval (\Lambda \rep{X_i}. \lambda x_i. \lambda k_i. \cps{c_i})
                    ~\rep{A}~\cps{v}~(\lambda y. \cps{\expwith{h}{K[\expret{y}]}}) \\
                &\eval^* \cps{c_i}[\cps{v}/x_i][\lambda y. \cps{\expwith{h}{K[\expret{y}]}}/k_i] \\
                &= \cps{c_i[v/x_i][\lambda y. \expwith{h}{K[\expret{y}]}/k_i]} \\
                &= \text{RHS}
            \end{align}
    \end{description}
\end{proof}