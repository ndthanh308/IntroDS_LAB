%%  Changelog:
%%
%%      29/05/2022: 
%%          (1) improve the behaviour of the \xxrev command with itemize and enumerate;
%%          (2) add "xxreview" environment.
%%
%%      17/05/2022: add "applyreplace" option.
%%
%%      14/05/2022: fix the bug with extra spaces on \xxreplace with "applyremove".
%%
%% A small package for tracking changes made by several people to a document.
%% Provides one command:
%%      \AddXNotesUser{prefix}{name}{color}
%% which will create 5 new commands:
%%      \xxnote{text} -- used to add notes.
%%      \xxremark{text} -- used for short remarks.
%%      \xxrev[remark]{text} -- used to highlight a changed piece of text.
%%      \xxadd[remark]{text} -- used to highlight new text (visually same as \xxrev{text}).
%%      \xxremove[remark]{text} -- used for removing text.
%%      \xxreplace[remark]{oldtext}{newtext} -- used for replacing text.
%% where xx is the prefix specified in the AddXNotesUser command.
%%
%% For example, a user named Tom Cruise may use the command as follows:
%%      \AddXNotesUser{tc}{Tom}{green}
%% Then command \tcadd{text} will highlight the text in green and command
%% \tcremove{text} will strike through the text with a green line.
%%
%% Package options:
%%      enable      --  enables xnotes commands (default).
%%      apply       --  applies all suggested changes to the text.
%%                      Use this option before submitting the manuscript.
%%      disable     --  disables all xnotes commands.
%%      nonotes     --  disables command \xxnote{text}.
%%      hideremarks --  hides all remarks.
%%      hidenotes   --  hides all notes.
%%      widepage    --  increase margins without affecting the text layout.
%%                      It gives more space for the remarks, but has to be
%%                      disabled before printing the document.
%%      applyremove -- actually removes the text instead of striking it out.
%%
%% Known issues:
%%      * Do not use remarks in floats or footnotes.
%%      * Avoid using xnotes commands in section titles.
%%      * When a citation or a reference are struck out with \xxremove
%%        or \xxreplace, it has to be wrapped in \mbox, such as:
%%        \xxreplace{old text~\mbox{\cite{abc99}}}{new text~\cite{abc99}}

\ProvidesPackage{xnotes}[2021/08/25]
\RequirePackage{xcolor}
\RequirePackage[normalem]{ulem}
\RequirePackage{xparse}
\RequirePackage{tikz}
% \RequirePackage{etoolbox}

\newcommand{\XN@mode@enable}{e}
\newcommand{\XN@mode@disable}{d}
\newcommand{\XN@mode@apply}{a}

\newcommand{\XN@mode}{\XN@mode@enable}
\newcommand{\XN@enablenotes}{1}
\newcommand{\XN@showremarks}{1}
\newcommand{\XN@shownotes}{1}
\newcommand{\XN@widepage}{0}
\newcommand{\XN@applyremove}{0}
\newcommand{\XN@applyreplace}{0}

\DeclareOption{enable}{\renewcommand{\XN@mode}{\XN@mode@enable}}
\DeclareOption{disable}{\renewcommand{\XN@mode}{\XN@mode@disable}}
\DeclareOption{apply}{\renewcommand{\XN@mode}{\XN@mode@apply}}
\DeclareOption{nonotes}{\renewcommand{\XN@enablenotes}{0}}
\DeclareOption{hideremarks}{\renewcommand{\XN@showremarks}{0}}
\DeclareOption{hidenotes}{\renewcommand{\XN@shownotes}{0}}
\DeclareOption{widepage}{\renewcommand{\XN@widepage}{1}}
\DeclareOption{applyremove}{\renewcommand{\XN@applyremove}{1}}
\DeclareOption{applyreplace}{\renewcommand{\XN@applyreplace}{1}}
\ProcessOptions\relax

\if \XN@showremarks 1
    %% The recent version of todonotes is required because older versions
    %% caused SyncTeX Errors (the "Couldnâ€™t find the corresponding source file." error).
    \RequirePackage{todonotes}[2021/06/04]
\fi

\newcommand{\XN@nonotes@error@message}{\protect\xxnote\space commands are disabled via the "nonotes" option}
\newcommand{\XN@nonotes@error@help}{Try removing the notes or the "nonotes" option.}

\newcommand{\XN@disable@error@message}{xnotes commands are disabled}
\newcommand{\XN@disable@error@help}{}

% Drawing remarks (code mostly from todonotes.sty):
%%%%%%%%%%%%%%%%%%
    \newcommand{\@XN@currentbordercolor}{black}
    \newcommand{\@XN@currentbackgroundcolor}{gray!30}
    \newcommand{\@XN@currenttextcolor}{black}

    %% From todonotes.sty
    \tikzstyle{remarkstyleraw} = [
        draw=\@XN@currentbordercolor,
        fill=\@XN@currentbackgroundcolor,
        text=\@XN@currenttextcolor,
        line width=0.5pt,
        text width = \@todonotes@textwidth - 1.6 ex - 1pt,
        inner sep = 0.8 ex,
        rounded corners=4pt]

    %% From todonotes.sty
    \newcommand{\XN@drawremark}[1]{%
        \marginpar{%
            \let\originalHbadness\hbadness%
            \hbadness 100000%
            \begin{tikzpicture}[remember picture,baseline=(X.base)]%
                \node(X){\vphantom{X}};%
                \draw node[remarkstyleraw,anchor=north] (inNote) at (X.north)%
                    {#1};%
            \end{tikzpicture}%
            \hbadness \originalHbadness%
        }%
    }
%%%%%%%%%%%%%%%%%%

%% If option "enable" is specified (default).
\if \XN@mode \XN@mode@enable
    % "widepage" option implementation is from https://tex.stackexchange.com/a/404766
    \if \XN@widepage 1
        \paperwidth=\dimexpr \paperwidth + 6cm\relax
        \oddsidemargin=\dimexpr\oddsidemargin + 3cm\relax
        \evensidemargin=\dimexpr\evensidemargin + 3cm\relax
        \marginparwidth=\dimexpr \marginparwidth + 3cm\relax

        % draw the disclaimer
        \appto{\maketitle}{%
            \XN@drawremark{WARNING: Pages are made artificially wide to fit xnotes remarks.
            Please, remove the ``widepage'' from the xnotes package options before printing.}}
    \fi

    %% this version worked badly with enumerates
    % \newcommand{\XN@colored}[2]{{\color{#1}{#2}}}
    \newcommand{\XN@colored}[2]{\bgroup\color{#1}{#2}\egroup}

    \newcommand{\XN@coloredst}[2]{%
        \bgroup\markoverwith{{\color{#1}{\rule[0.5ex]{2pt}{0.4pt}}}}\ULon{#2}}

    \if \XN@showremarks 1
        \newcommand{\XN@remark}[2]{%
            \IfValueTF{#2}{\todo[color=#1!30]{#2}}{}}
            % \IfValueTF{#2}{\todo[color=#1!30]{#2}}{}}
    \else
        \newcommand{\XN@remark}[2]{}
    \fi

    \newcommand{\AddXNotesUser}[3]{%
        \if \XN@enablenotes 1
            \if \XN@shownotes 1
                \expandafter\newcommand\csname #1note\endcsname[1]{%
                    \XN@colored{#3}{{\bf\small [#2: {##1}]}}}
            \else
                \expandafter\newcommand\csname #1note\endcsname[1]{}
            \fi
        \else
            \expandafter\newcommand\csname #1note\endcsname[1]{%
                \PackageError{xnotes}%
                    {\XN@nonotes@error@message}%
                    {\XN@nonotes@error@help}
            }
        \fi
        %% \xxremark adds a floating remark.
        \expandafter\NewDocumentCommand\csname #1remark\endcsname{m}{%
            \XN@remark{#3}{##1}}
        %% \xxrev simply highlights the text with the specified color.
        \expandafter\NewDocumentCommand\csname #1rev\endcsname{om}{%
            \XN@colored{#3}{##2}%
            \XN@remark{#3}{##1}}
        %% \xxadd simply highlights the text with the specified color.
        \expandafter\NewDocumentCommand\csname #1add\endcsname{om}{%
            \XN@colored{#3}{##2}%
            \XN@remark{#3}{##1}}
        \if \XN@applyremove 1
            %% \xxremove actually removes the text.
            \expandafter\NewDocumentCommand\csname #1remove\endcsname{om}{}
        \else
            %% \xxremove strikes through the text with a line of the specified color.
            \expandafter\NewDocumentCommand\csname #1remove\endcsname{om}{%
                \XN@coloredst{#3}{##2}%
                \XN@remark{#3}{##1}}
        \fi
        \ifthenelse {\XN@applyremove=1 \OR \XN@applyreplace=1}
        {
            %% \xxreplace actually replaces the text.
            \expandafter\NewDocumentCommand\csname #1replace\endcsname{omm}{%
                \csname #1add\endcsname[##1]{##3}}
        }{
            %% \xxreplace is a combination of \xxremove followed by \xxadd.
            \expandafter\NewDocumentCommand\csname #1replace\endcsname{omm}{%
                \csname #1remove\endcsname{##2} \csname #1add\endcsname[##1]{##3}}
        }
        \newenvironment{#1review}
            {\bgroup\color{#3}}
            {\egroup}
    }
\fi

%% If option "disable" is specified.
\if \XN@mode \XN@mode@disable
    %% All xnotes commands throw errors.
    \newcommand{\AddXNotesUser}[3]{
        \expandafter\newcommand\csname #1note\endcsname[1]{%
            \PackageError{xnotes}{\XN@disable@error@message}{}}
        \expandafter\NewDocumentCommand\csname #1remark\endcsname{m}{%
            \PackageError{xnotes}{\XN@disable@error@message}{}}
        \expandafter\NewDocumentCommand\csname #1rev\endcsname{om}{%
            \PackageError{xnotes}{\XN@disable@error@message}{}}
        \expandafter\NewDocumentCommand\csname #1add\endcsname{om}{%
            \PackageError{xnotes}{\XN@disable@error@message}{}}
        \expandafter\NewDocumentCommand\csname #1remove\endcsname{om}{%
            \PackageError{xnotes}{\XN@disable@error@message}{}}
        \expandafter\NewDocumentCommand\csname #1replace\endcsname{omm}{%
            \PackageError{xnotes}{\XN@disable@error@message}{}}
        \newenvironment{#1review}
            {\PackageError{xnotes}{\XN@disable@error@message}}
            {}
    }
\fi

%% If option "apply" is specified.
\if \XN@mode \XN@mode@apply
    \newcommand{\AddXNotesUser}[3]{%
        \if \XN@enablenotes 1
            %% \xxnote expands to nothing.
            \expandafter\newcommand\csname #1note\endcsname[1]{}
        \else
            \expandafter\newcommand\csname #1note\endcsname[1]{%
                \PackageError{xnotes}%
                    {\XN@nonotes@error@message}%
                    {\XN@nonotes@error@help}
            }
        \fi
        %% \xxremark simply disappers.
        \expandafter\newcommand\csname #1remark\endcsname[1]{}
        %% \xxrev expands simply to its parameter.
        \expandafter\NewDocumentCommand\csname #1rev\endcsname{om}{##2}
        %% \xxadd expands simply to its parameter.
        \expandafter\NewDocumentCommand\csname #1add\endcsname{om}{##2}
        %% \xxremove expands to nothing.
        \expandafter\NewDocumentCommand\csname #1remove\endcsname{om}{}
        %% \xxreplace expands to its second parameter.
        \expandafter\NewDocumentCommand\csname #1replace\endcsname{omm}{##3}
        \newenvironment{#1review}
            {}
            {}
    }
\fi
