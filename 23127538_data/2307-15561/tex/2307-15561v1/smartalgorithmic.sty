%%  Changelog:
%%
%%      16/10/2022:
%%          * fix compilation timeout caused by \State* implementation
%%          * add \algtab command
%%
%%      14/10/2022:
%%          * major code and documentation refactoring.
%%          * generalize the font size options.
%%          * add \State* and \LineComment*
%%          * fix an alignment bug in \BreakableLine
%%          * allow the style definition to access the argument (#1),
%%            which permits more complex style definitions to be made in-place,
%%            without any intermediate commands.
%%
%%      26/09/2022: add dependency on package xcolor.
%%
%%      03/06/2022: add Multiline and BreakableLine blocks.
%%
%%      26/05/2022: make \XxxStyle commands public.
%%
%%      24/05/2022: add \algspace command.
%%
%%      13/05/2022: add font size options.
%%
%%      07/05/2022: decrease the size of a tab from 1cm to 0.5cm for cppcommentstyle.
%%
%%  TODOs:
%%      * Add documentation for continuouslinenumbers
%%      * Add documentation for cppcommentstyle
%%      * Add documentation for the font styles
%%      * Add documentation for \algspace and \renewcommand{\algspaceskip}{...}
%%
%%  This package is an extension to the algpseudocode package, which provides
%%  the algorithmic environment.
%%  This core functionality of this package helps you to use consistent 
%%  naming and styles in pseudocode identifiers (such as functions, 
%%  variable names, type names, etc.).
%%  It also provides a valuable toolbox for common use-cases in typesetting
%%  pseudocode in academic papers.
%%
%%  The main command exported by the package is "\NewDeclarationType":
%%      \NewDeclarationType[prefix=<pref>]{<name>}[<1>]{<style>}
%%
%%  Example 1 (Basic declarations):
%%      %% function names will be typeset in the small caps font.
%%      \NewDeclarationType{Function}{\textsc} 
%%      %% Command \Foo will exist everywhere in the document and will
%%      %% expand to \textsc{Foo}:
%%      \DeclareGlobalFunction{Foo}
%%      %% Command \Bar will exist within the current section and will
%%      %% expand to \textsc{Bar}:
%%      \DeclareSectionFunction{Bar}
%%      %% Command \Baz will exist within the current smartalgorithmic
%%      %% environment and will expand to \textsc{Baz}:
%%      \DeclareLocalFunction{Baz}
%%      %% Currently, there are only 3 scopes: Global, Section, and Local.
%%
%%  Example 2 (Aliases and starred declarations):
%%      %% Variable names will be typeset in the italic font.
%%      \NewDeclarationType{Variable}{\textit}
%%      %% \val will expand to \textit{value}
%%      \DeclareGlobalVariable[val]{value}
%%      %% However, aliases are most useful in combination with
%%      %% another type of declarations.
%%      %% When you want to make an exception and not apply the
%%      %% corresponding style to an identifier, use the version of the 
%%      %% Declare command with a star:
%%      \DeclareGlobalVariable*[sigmax]{\sigma_{textrm{max}}}
%%      %% "\sigmax" will expand to "\sigma_{textrm{max}}", ignoring the
%%      %% style defined in "NewDeclarationType" (in this case, \textit).
%%
%%  Example 3 (Command prefix):
%%      %% Type names will be typeset in the bold font.
%%      %% Moreover, the latex commands used to typeset type names will be prefixed
%%      %% by the lett t (e.g., to avoid name collisions with other latex commands).
%%      \NewDeclarationType[prefix=t]{Type}{textbf}
%%      %% Command \tvalue expand to \textbf{value}.
%%      \DeclareGlobalType{value}
%%
%%  Example 4 (Complex style definitions):
%%      %% Variable names will be typeset in the italic font, with the first
%%      %% letter of the variable name in lowercase.
%%      %% Note the optional argument "[1]" before "{\mathit{\MakeLowercase#1}}".
%%      %% It indicates that you want to have access to #1 inside the style definition.
%%      \NewDeclarationType{Variable}[1]{\mathit{\MakeLowercase#1}}
%%      %% Command \FooBar will expand to \mathit{\MakeLowercase FooBar}, 
%%      %% which will further expand to "fooBar" in italic font.
%%      \DeclareSectionVariable{FooBar}
%%
%%  Example 5 (\XxxStyle command)
%%      %% Apart from \Declare<Scope>Variable command, it will also create
%%      %% a command named \VariableStyle, which is defined by the last 
%%      % argument to \NewDeclarationType.
%%      \NewDeclarationType{Variable}[1]{\mathit{\MakeLowercase#1}}
%%      %% \ValMax will expand to \mathit{val}_{\textrm{max}}.
%%      \DeclareGlobalVariable*[ValMax]{\VariableStyle{val}_{\textrm{max}}}
%%      %% This is similar to the following version that doesn't use \VariableStyle:
%%      \DeclareGlobalVariable{Val}
%%      \DeclareGlobalVariable*[ValMax]{\Val_{textrm{max}}}
%%
%%  Example of smartalgorithmic environment being used:
%%      \NewDeclarationType{Variable}{\mathit}
%%      \NewDeclarationType{Function}{\textsf}
%%      \DeclareGlobalVariable{foo}
%%      \begin{smartalgorithmic}[1]  % [1] means that all lines will be numbered
%%          \DeclareLocalFunction{Func}
%%          
%%          \Function{\Func}{\foo}
%%              \State \Return $\foo + 1$
%%          \EndFunction
%%      \end{smartalgorithmic}
%%  In this example, Func is a _local_ function declaration.
%%  It exists only inside this instance of smartalgorithmic.
%%  
%%  Finally, there are a few commands that provide slightly more general syntax:
%%      \DeclareGlobalCommand{\command_name}[number_of_arguments]{command_implementation}
%%      \DeclareSectionCommand{\command_name}[number_of_arguments]{command_implementation}
%%      \DeclareLocalCommand{\command_name}[number_of_arguments]{command_implementation}
%%
%%  \DeclareGlobalCommand is simply a synonym for \newcommand.
%%  \DeclareSectionCommand declares a command with the scope of the current section.
%%  \DeclareLocalCommand declares a command with the scope of the current
%%  smartalgorithmic environment.
%%
%%  I hope you enjoy using this package :)

\ProvidesPackage{smartalgorithmic}[2022/10/14]

\RequirePackage{kvoptions}
\RequirePackage{algpseudocode}
\RequirePackage{etoolbox}
\RequirePackage{xparse}
\RequirePackage{keyval}
\RequirePackage{tabto}
\RequirePackage{xcolor}
\RequirePackage{relsize}

%% the local variable names used by this package are prefixed with "\SMARTALG@".
\SetupKeyvalOptions{
    family=SMARTALG,
    prefix=SMARTALG@
}

\DeclareBoolOption{continuouslinenumbers}
\DeclareBoolOption{cppcommentstyle}
\DeclareStringOption[normalsize]{mainfont}
\DeclareStringOption[smaller]{lnfont}

\ProcessKeyvalOptions*

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Font and spacing.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%% \algmainstyle and \alglnstyle can be overwritten by the user.
\newcommand{\algmainstyle}{\csname\SMARTALG@mainfont\endcsname}
\newcommand{\alglnstyle}{\csname\SMARTALG@lnfont\endcsname}

\algrenewcommand\alglinenumber[1]{\alglnstyle #1:}

\newlength{\algspaceskip}

%% \algspaceskip can be overwritten by the user.
%% By default, \baselineskip in the main style (i.e., with \algmainstyle) is used.
\begingroup
    \algmainstyle
    \setlength{\algspaceskip}{\baselineskip}
    \global\algspaceskip=\algspaceskip
\endgroup

%% the optional argument is a fraction of \algspaceskip that should be skipped.
\algnewcommand{\algspace}[1][1]{\vspace{#1\algspaceskip}}

%% \algtab makes 1 indentation step manually.
\algnewcommand{\algtab}{\hspace{\algorithmicindent}}

% \State works in the same way as in algorithmicx.
% \State* creates a line without a line number, but indented as a normal line
\let\SMARTALG@OriginalState\State
\RenewDocumentCommand\State{s}{%
    \IfBooleanTF{#1}{%
        \SMARTALG@StateStar\ignorespaces%
    }{%
        \SMARTALG@OriginalState\ignorespaces%
    }%
}

\newcommand{\SMARTALG@StateStar}{%
    \let\SMARTALG@StateStar@originalalglinenumber\alglinenumber%
    \renewcommand{\alglinenumber}[1]{\phantom{\SMARTALG@StateStar@originalalglinenumber{##1}}}%
    \SMARTALG@OriginalState%
    \let\alglinenumber\SMARTALG@StateStar@originalalglinenumber%
    \undef\SMARTALG@StateStar@originalalglinenumber%
    \addtocounter{ALG@line}{-1}%
}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Continuous line numbers.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%% If "continuouslinenumbers" option is provided, create a counter to track line
%% numbers across smartalgorithmic blocks.
\ifSMARTALG@continuouslinenumbers
    \newcounter{SMARTALG@linenumber}
    \setcounter{SMARTALG@linenumber}{0}
    
    %% \smartalgresetlinenumbers can be used to reset the line number
    %% counter to 0.
    \newcommand{\resetlinenumbers}{%
        \setcounter{SMARTALG@linenumber}{0}%
    }
\fi

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Comments.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%% If "cppcommentstyle" option is provided, 
\ifSMARTALG@cppcommentstyle
    \definecolor{SMARTALG@commentcolor}{rgb}{0.4, 0.4, 0.4}

    \TabPositions{%
        1cm,1.5cm,2cm,2.5cm,3cm,3.5cm,4cm,4.5cm,5cm,5.5cm,6cm,6.5cm,
        7cm,7.5cm,8cm,8.5cm,9cm,9.5cm,10cm,10.5cm,11cm,11.5cm,12cm,
        12.5cm,13cm,13.5cm,14cm,14.5cm,15cm,15.5cm,16cm,16.5cm,17cm,
        17.5cm,18cm,18.5cm,19cm,19.5cm,20cm,20.5cm,21cm,21.5cm,22cm,
        22.5cm,23cm,23.5cm,24cm,24.5cm,25cm,25.5cm,26cm,26.5cm,27cm,
        27.5cm,28cm,28.5cm,29cm,29.5cm,30cm}
    
    %% Command "\commentstyle" can be overwritten by the user.
    \newcommand{\commentstyle}[1]{\textcolor{SMARTALG@commentcolor}{// #1}}
    \algrenewcomment[1]{~\tab\commentstyle{#1}}
\else
    \newcommand{\commentstyle}[1]{\(\triangleright\) #1}
\fi

%% LineComment is used to create a comment that takes the whole line.
%% LineComment* is the version without a line number.
%% LineCommentx is the version without a line number and indentation.
\NewDocumentCommand{\LineComment}{sm}{\IfBooleanTF{#1}{\State*}{\State} \commentstyle{#2}}
\NewDocumentCommand{\LineCommentx}{m}{\Statex \commentstyle{#1}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% The Multiline and BreakableLine blocks
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\algblockdefx[Multiline]{Multiline}{EndMultiline}{}{}
\algtext*{EndMultiline}

% it is used to help algorithmic keep track of opened and closed blocks
\algblockdefx[SMARTALG@BreakableLine@Block]{SMARTALG@BreakableLine@Block}{EndSMARTALG@BreakableLine@Block}{}{}
\algtext*{EndSMARTALG@BreakableLine@Block}

\newcommand{\SMARTALG@BreakableLine@DoNotUseStateErrorMessage}{%
    Don't use \protect\State\space and \protect\Statex\space commands inside a BreakableLine block. Use \protect\Break\space and/or \protect\RaggedBreak\space instead.%
}

\NewDocumentCommand{\BreakableLine}{o}{%
    \ifdefined\SMARTALG@BreakableLine@OrigState%
        \PackageError{smartalgorithmic}{Nesting BreakableLine blocks is not supported}{}%
    \fi%
    \let\SMARTALG@BreakableLine@OrigState\State%
    \let\SMARTALG@BreakableLine@OrigStatex\Statex%
    \renewcommand{\State}{%
        \PackageError{smartalgorithmic}{\SMARTALG@BreakableLine@DoNotUseStateErrorMessage}{}%
    }%
    \renewcommand{\Statex}{%
        \PackageError{smartalgorithmic}{\SMARTALG@BreakableLine@DoNotUseStateErrorMessage}{}%
    }%
    \newcommand{\RaggedBreak}{%
        \SMARTALG@BreakableLine@OrigState*%
        \IfValueTF{#1}{%
            \hspace{-\algorithmicindent}% removes the extra indentation from \SMARTALG@BreakableLine@Block
            \phantom{\mbox{#1}}%
        }{}% aligns indentation with the first line
        \ignorespaces%
    }%
    \newcommand{\JustBreak}{%
        \linebreak% justifies the previous line
        \vspace{-\baselineskip}% removes extra vertical space from the line break
        \RaggedBreak%
    }%
    \newcommand{\Break}{\JustBreak}%
    \SMARTALG@BreakableLine@Block%
    \IfValueTF{#1}{\mbox{#1}}{}%
    \ignorespaces%
}

\algnewcommand{\EndBreakableLine}{%
    \EndSMARTALG@BreakableLine@Block%
    \let\State\SMARTALG@BreakableLine@OrigState%
    \let\Statex\SMARTALG@BreakableLine@OrigStatex%
    \undef\SMARTALG@BreakableLine@OrigState%
    \undef\SMARTALG@BreakableLine@OrigStatex%
    \undef\RaggedBreak%
    \undef\JustBreak%
    \undef\Break%
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Package core.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\define@key{NewDeclarationTypeKeys}{prefix}{\def\SMARTALG@KVArg@Prefix{#1}}

% \SMARTALG@DeclarationTypes is the list of all defined declaration types.
% See: \NewDeclarationType below.
\newcommand{\SMARTALG@DeclarationTypes}{}

\NewDocumentCommand{\NewDeclarationType}{O{}mom}{%
    \setkeys{NewDeclarationTypeKeys}{prefix={},#1}%
    %
    \IfValueTF{#3}{%
        \expandafter\newcommand\csname #2Style\endcsname[1]{#4}%
    }{%
        \expandafter\newcommand\csname #2Style\endcsname{#4}%
    }%
    %
    \expandafter\let\csname SMARTALG@Prefixes@#2\endcsname\SMARTALG@KVArg@Prefix%
    \listadd{\SMARTALG@DeclarationTypes}{#2}%
    %
    \expandafter\NewDocumentCommand\csname DeclareGlobal#2\endcsname{som}{%
        \DeclareGlobalWithStyle{\ResolveName{#2}{##2}{##3}}{##3}{%
            %% If Star is present, no style command is passed.
            \IfBooleanTF{##1}{}{\csname #2Style\endcsname}}%
    }%
    %
    \expandafter\NewDocumentCommand\csname DeclareSection#2\endcsname{som}{%
        \DeclareSectionWithStyle{\ResolveName{#2}{##2}{##3}}{##3}{%
            %% If Star is present, no style command is passed.
            \IfBooleanTF{##1}{}{\csname #2Style\endcsname}}%
    }%
}

\NewDocumentCommand{\DeclareGlobalCommand}{mO{0}m}{%
    \newcommand#1[#2]{#3}%
}

%% Usage: \ResolveName{DeclarationType}{NameOverride}{NameDefault}
\NewDocumentCommand{\ResolveName}{mmm}{%
    \csname SMARTALG@Prefixes@#1\endcsname\IfValueTF{#2}{#2}{#3}%
}

%% Usage: \DeclareGlobalWithStyle{CommandName}{CommandBody}{StyleCommand}
\NewDocumentCommand{\DeclareGlobalWithStyle}{mmm}{%
    \expandafter\DeclareGlobalCommand\csname #1\endcsname{#3{#2}}%
}

\NewDocumentCommand{\DeclareSectionCommand}{mO{0}m}{%
    \newcommand#1[#2]{#3}%
    \listadd{\SMARTALG@SectionDeclarations}{#1}%
}

%% Usage: \DeclareSectionWithStyle{CommandName}{CommandBody}{StyleCommand}
\NewDocumentCommand{\DeclareSectionWithStyle}{mmm}{%
    \expandafter\DeclareSectionCommand\csname #1\endcsname{#3{#2}}%
}

%% TODO: Work out a real fix
\@ifpackageloaded{placeins}{
    \preto{\section}{%
        \ifdef{\SMARTALG@SectionDeclarations}%
        {% Then
            \renewcommand{\do}[1]{\undef##1}%
            \dolistloop{\SMARTALG@SectionDeclarations}%
            \undef\SMARTALG@SectionDeclarations%
        }{% Else
        }%
    }%
}{% Else
    \preto{\section}{%
        \ifdef{\SMARTALG@SectionDeclarations}%
        {% Then
            \renewcommand{\do}[1]{\undef#1}%
            \dolistloop{\SMARTALG@SectionDeclarations}%
            \undef\SMARTALG@SectionDeclarations%
        }{% Else
        }%
    }%
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Environment definition
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newenvironment{smartalgorithmic}[1][0]
{% \begin{smartalgorithmic}
    \algorithmic[#1]%
        \algmainstyle
        %
        \ifSMARTALG@continuouslinenumbers%
            \setcounter{ALG@line}{\value{SMARTALG@linenumber}}%
        \fi%
        %
        %% Usage: \DeclareLocalCommand{\CommandName}[ArgumentCount]{CommandBody}
        \NewDocumentCommand{\DeclareLocalCommand}{mO{0}m}{%
            \newcommand##1[##2]{##3}%
            \listadd{\SMARTALG@LocalDeclarations}{##1}%
        }%
        %
        %% Usage: \DeclareLocalWithStyle{CommandName}{CommandBody}{StyleCommand}
        \NewDocumentCommand{\DeclareLocalWithStyle}{mmm}{%
            \expandafter\DeclareLocalCommand\csname ##1\endcsname{##3{##2}}%
        }%
        %
        \renewcommand{\do}[1]{%
            \expandafter\NewDocumentCommand\csname DeclareLocal##1\endcsname{som}{%
                \DeclareLocalWithStyle{\ResolveName{##1}{####2}{####3}}{####3}{%
                    %% If Star is present, no style command is passed.
                    \IfBooleanTF{####1}{}{\csname ##1Style\endcsname}}%
            }%
        }%
        \dolistloop{\SMARTALG@DeclarationTypes}%
}{% \end{smartalgorithmic}
        \ifSMARTALG@continuouslinenumbers
            \setcounter{SMARTALG@linenumber}{\value{ALG@line}}%
        \fi
        %
        \ifdef{\SMARTALG@LocalDeclarations}%
        {% Then
            \renewcommand{\do}[1]{\undef##1}%
            \dolistloop{\SMARTALG@LocalDeclarations}%
            \undef\SMARTALG@LocalDeclarations%
        }{% Else
        }
        %
        \renewcommand{\do}[1]{\expandafter\undef\csname DeclareLocal##1\endcsname}%
        \dolistloop{\SMARTALG@DeclarationTypes}%
    \endalgorithmic%
}
