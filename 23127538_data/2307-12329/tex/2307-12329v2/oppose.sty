%% Typical packages
\usepackage{amsmath,amsthm,graphicx,float,mathtools}
\usepackage[letterpaper,footnotesep=1.5\baselineskip,margin=1in]{geometry}
\usepackage[american]{babel}
\usepackage[utf8]{inputenc}	% allows accented utf8 chars to be used
\usepackage{csquotes}
\usepackage{uri}
\iflineno		% turn on/off w/ \linenumbers & \nolinenumber
  \ifmulticol
    \RequirePackage[switch,mathlines,columnwise]{lineno}
  \else
    \RequirePackage[mathlines]{lineno}
  \fi
  \linenumbers\runningpagewiselinenumbers
\fi

%% set line spacing; could use \usepackage{setspace} \doublespace
\linespread{1.3}
\linespread{1.5}
%\linespread{1.6}

% special package helps to show sections and
% subsections in different fonts when no numbering
\usepackage{sectsty}
\sectionfont{\LARGE\bf}
\subsectionfont{\normalsize\bf}
%\subsubsectionfont{\bfseries\itshape}
\subsubsectionfont{\rm\itshape}
\newcommand*\subsubsubsection[1]{\medskip\noindent\textit{#1.}\space}

% FIGURE CAPTIONS FONT
\usepackage[font=small,labelfont=bf]{caption}

% HYPERREF, load after biblatex, use to embed author and title
\usepackage[]{hyperref} 

\usepackage[x11names]{xcolor}
\hypersetup{
    colorlinks = true,
    linkcolor = {RoyalBlue4},
    urlcolor = {RoyalBlue4},
    citecolor = {black},	% reset later according to citation style
}

% use \href{URL}{TEXT} for urls, see docs for xcolor and for hyperref

%% FOOTNOTE setup
\renewcommand{\footnotesep}{1\baselineskip}	% provide some space

\ifbiblatex\else
\makeatletter
\renewcommand\@makefntext[1]%
     {\noindent\makebox[15pt][r]{\textsuperscript{\@thefnmark}\,}#1}
\makeatother
\renewcommand{\thefootnote}{\fnsymbol{footnote}}
\fi

%% TITLE PAGE

\newdimen\absindent \absindent=0.5in
\newcommand{\setabstract}[3]{
  \newdimen\absopenup \absopenup=#1\baselineskip
  \newdimen\absskip \absskip=#2\baselineskip
  \newcommand{\myabstract}{#3}
}

\newcommand{\printabstract}{%
%
\begingroup
\advance\leftskip \absindent
\openup \absopenup
%
\noindent \myabstract

\ifdef{\mykeywords}{%
  \vskip 0.82\baselineskip
  \noindent{\bf Keywords:} \mykeywords}{}

\ifdef{\myrunninghead}{%
  \vskip 0.5\baselineskip
  \noindent{\bf Running head:} \myrunninghead}{}

\endgroup

%% adjust to balance lines if using twocolumn
\hbox{\null}\vskip\absskip\hbox{\null}\par
}

\providecommand*{\mytitleskip}{0in}		% define in manuscript if needed

\newcommand{\mymaketitle}{%
  \ifmulticol\twocolumn[\begin{@twocolumnfalse}\fi%
  \thispagestyle{empty} % turn off page number on first page
  {%
  \openup 0.4\baselineskip
  \begin{flushleft}
  \noindent{\sffamily\Large\textbf{\mytitle}}\hfill\break
  \end{flushleft}
  \vskip \ifcharter-0.2\else0.2\fi\baselineskip
  \vskip\mytitleskip
  \advance\leftskip \absindent
  \noindent{\sffamily\Large\myauthor\textsuperscript{\footnotemark}}%
  \vskip 0.5\baselineskip
  }%
  \printabstract%
  \setcounter{tocdepth}{\tocdepth}%
  \setcounter{secnumdepth}{\secnumdepth}%
  \ifmulticol\end{@twocolumnfalse}]\fi%
  \footnotetext{\myaddress\\[3pt] \hbox{\null}\hskip\ifbiblatex20pt\else15pt\fi%
    web: \mycontact}
}

%% TABLE OF CONTENTS, 1st param skip for first col, 2nd skip after (or \newpage)
\newcommand*{\mytoc}[2]{%
  {\renewcommand{\contentsname}{\vskip#1}\small\tableofcontents}#2}

%% COLUMNS: Two column layout, turn on or off \multicoltrue
%  use cuted \begin{strip} text \end{strip} to span two columns
%  make environment widetext to mimic RevTeX approach to spanning cols
%  alternative package multicol, but that does not allow single col floats
\ifmulticol
  \usepackage{cuted}
  \setlength\columnsep{20pt}
  \geometry{margin=0.75in,top=0.75in,bottom=1in}
  \linespread{1.15}
  \sectionfont{\Large\bf}
  \parskip=0pt
  % allow widows and orphans
  \widowpenalty=0
  \clubpenalty=0
\fi

%% PRINT BIBLIO
\newcommand*{\mybiblio}{
  \ifdef{\reftitle}{\addcontentsline{toc}{section}{\reftitle}}{}
  \ifbiblatex
    \printbibliography
  \else
    \ifdef{\reftitle}{\renewcommand{\refname}{\reftitle}}{}
    \bibliography{main}
  \fi
}

%% BibLaTeX
%  to use numeric superscript style, see biblatexSuperscript in ~/text/Submit/00_Template/OtherStyles
%  for additional Chicago style ideas, see biblatexChicago in ~/text/Submit/00_Template/OtherStyles
\ifbiblatex
\ifbibnum
\usepackage[autocite=superscript,citestyle=numeric-comp,bibstyle=safnum,
		sorting=nyt,backend=biber]{biblatex}

% for superscript style:
%	\autocite, \supercite give superscript
%	\textcite gives Name [#]
%	\cite and \parencite gives [#]
%	\numcite gives #, i.e., ref.~\citenum{key} => ref. # [see def below]

\ExecuteBibliographyOptions{maxnames=4,minnames=1,maxcitenames=2,giveninits=true,uniquename=false}
\ifbibnum\ifbibsort\else\ExecuteBibliographyOptions{sorting=none}\fi\fi

% formatting bibliography list
\setlength\bibitemsep{0pt plus 0pt minus 0pt} % no space between entries
% for page bottoms, see http://tug.org/TUGboat/tb31-1/tb97isambert.pdf
\appto\bibsetup{\clubpenalty=0 % align page bottoms, allow widows and orphans
   \widowpenalty=0 \brokenpenalty=0 \interlinepenalty=0\flushbottom}
% modified from https://tex.stackexchange.com/questions/341041
\DeclareFieldFormat{labelnumberwidth}{#1.} % Remove brackets from numbers
\DeclareFieldFormat{shorthandwidth}{#1.}   % Add period after number

% sort editors last, first initials
\DeclareNameAlias{editor}{sortname}

% Keep an eye on sorting by name and year, sorting=nyt

% Use bibmacros in article title
% Just prints title, but need this to remove quotes around title

\newbibmacro{string}[1]{#1}%
\DeclareFieldFormat[article]{title}{\usebibmacro{string}{#1}}
\DeclareFieldFormat[inbook]{title}{\usebibmacro{string}{#1}}
\DeclareFieldFormat[incollection]{title}{\usebibmacro{string}{#1}}

% Also, do not print doi or url

\AtEveryBibitem{%
\ifentrytype{article}{
    \clearfield{url}%
    \clearfield{urlyear}%
    \clearfield{doi}%
    \clearfield{eprint}%
}{}
\ifentrytype{book}{
    \clearfield{url}%
    \clearfield{urlyear}%
    \clearfield{eprint}%
}{}
\ifentrytype{collection}{
    \clearfield{url}%
    \clearfield{urlyear}%
    \clearfield{eprint}%
}{}
\ifentrytype{incollection}{
    \clearfield{url}%
    \clearfield{urlyear}%
    \clearfield{eprint}%
}{}
}

% prints number only inline, ie, ref.~\citenum{key} => ref. #
\DeclareCiteCommand{\citenum}
  {}
  {\printfield{labelnumber}}
  {}
  {}
\DeclareCiteCommand{\citenumb}
  {}
  {[\printfield{labelnumber}]}
  {}
  {}

% depends on etool package, see https://tex.stackexchange.com/questions/308
\renewcommand\textcite[2][]{%
  \ifstrempty{#1}{%
    \citeauthor{#2}\autocite{#2}%
  }{%
    \citeauthor{#2} [\citenum{#2}, #1]%
  }%
}

\renewcommand{\textcites}[1]{\citeauthor{#1}'s\autocite{#1}} % possessive

\else
\usepackage[authordate,ibidtracker=false,natbib,backend=biber]{biblatex-chicago}
% ibidtracker turned off so that repeated citations in text expand fully
% uniquename=init adds initials to text citations if same last name for different people
\ExecuteBibliographyOptions{maxbibnames=20,maxcitenames=2,mincitenames=1,uniquename=false,giveninits,doi=false,eprint=false,url=false}

% Biber directives to prevent use of number and month fields, prevents printing in journal entries
\DeclareSourcemap{
  \maps[datatype=bibtex, overwrite]{
    \map{
      \step[fieldset=number, null]
      \step[fieldset=month, null]
    }
  }
}

%% various adjustments for bibliography, see section 3.8.1 of biblatex manual

%\renewcommand*{\multicitedelim}{\addsemicolon\space}	% in text between cites
\renewcommand*{\finalnamedelim}{\space\&\space}			% "and" format
\renewcommand*{\nameyeardelim}{\addcomma\space}			% JEB format
\renewcommand*{\bibnamedash}{\printnames{author}}		% turn off dashes for redundant names
\renewcommand*{\bibinitdelim}{\unspace\nopunct}			% between initials
\DeclareNameAlias{author}{family-given}					% name inversion
%\DeclareNameAlias{author}{family-given/given-family}	% name inversion
% turn off quote marks for titles
\DeclareFieldFormat[article,inbook,incollection,inproceedings,patent,thesis,unpublished]{title}{#1\isdot}

%\DeclareLanguageMapping{american}{american-apa} % needed for apa style
%
\fi% \ifbibnum

% options for name-date and numbered
\ifmulticol\bibhang=15pt\bibsetup{\parskip=0pt}\bibitemsep=0pt\fi
%\addbibresource{cancer.bib}
\addbibresource{main.bib}
\DefineBibliographyStrings{english}{%
  bibliography = {Works Cited},
  references = {\ifdef{\reftitle}{\reftitle}{References}},	% title of ref section
}

\else% \ifbiblatex
%
%% BibTeX
\usepackage[\ifbibnum sort&compress\fi]{natbib}
\bibsep=0pt
\renewcommand{\bibnumfmt}[1]{#1.}
\def\autocite{\citep}
\def\textcite{\citet}
% default naturemag for numbers, alternatively IEEEtranN
\ifbibnum
  %\bibliographystyle{IEEEtranN}
  \bibliographystyle{naturemag}
  \setcitestyle{super,comma,open=,close=}
  \hypersetup{citecolor={RoyalBlue3}}
\else
  \bibliographystyle{newapa}		% default newapa for auth-date
  \hypersetup{citecolor={black}}	% could use RoyalBlue4
\fi%\ifbibnum
\fi%\ifbiblatex

%% ShowGit

% add gitinfo in footer watermark, see MEP directory and gitinfo2 documentation
% must add the files post-commit, post-merge, post-checkout to .git/hooks (see MEP example)
% to update input file .git/gitHeadInfo.gin, execute .git/hooks/post-commit
% add option marknotags to print reminder that head tag is missing.

\newif\ifshowtime \showtimetrue		% show current time 
\ifshowgit
% datetime2 for \DTMuse command, use "~" for timezonesep to get space
\usepackage[calc,timezonesep=, showseconds=false]{datetime2} 	
\DTMsavenow{now}
\DTMtozulu{now}{zdate}			% use \DTMuse{zdate} or \DTMuse{now} for Z zone or local zone
\ifgitlocal
  \usepackage[grumpy,mark,local,dirty=-*,raisemark=0.02\paperheight]{gitinfo2}
\else
  \usepackage[grumpy,mark,dirty=-*,raisemark=0.02\paperheight]{gitinfo2}
\fi
\renewcommand{\gitMarkPref}{git}
\renewcommand{\gitMark}{\gitBranch\,@\,\gitRel-\gitRoff::\gitAbbrevHash{}-% 
	\gitAuthorDate\ \ifshowtime(\DTMuse{zdate})\fi\ \textbullet{}\ safrank}%
	% use \gitAuthorIsoDate to show time also
\fi

%% FONTS
% May need to add amssymb to packages if no lucimatx
% charter is standard in texlive, so good choice for arXiv, submissions
% need to increase fontsize when using charter
% use package XCharter for small caps and other chars, see xcharter docs
% check out Linux Libertine fonts also, see OneNote on LaTeX fonts

\ifcm
  \ifmulticol
    % bottom=1.065in for 1.0 linespread; bottom=0.958in for 1.05 linespread
    \geometry{margin=0.75in,top=0.83in,bottom=0.958in} 
    \linespread{1.05}
  \fi
\fi

\iflucida
  \usepackage[T1]{fontenc}
  \ifmulticol
    \usepackage[lucidascale]{lucimatx}
    \geometry{margin=0.75in,top=0.83in,bottom=1.056in}
    \linespread{1.15}
  \else
    \usepackage{lucimatx}
  \fi
\fi

%% Libertine will use 11pt in two column
\iflibertine
  \usepackage{textcomp}
  \usepackage[sb]{libertine}
  \usepackage[varqu,varl]{zi4}% inconsolata
  \usepackage[libertine,bigdelims,vvarbb]{newtxmath} % bb from STIX
  \usepackage[cal=boondoxo]{mathalfa} % mathcal
  %\useosf % osf for text, not math, numbers with descenders
  \usepackage[supstfm=libertinesups,%
    supscaled=1.2,%
    raised=-.13em]{superiors}
  \ifmulticol
    % bottom=0.928in for 1.05 linespread
    \geometry{margin=0.75in,top=0.83in,bottom=0.928in} 
    \linespread{1.05}
  \fi
\fi

\ifcharter
  \usepackage[full]{textcomp}
  \usepackage[sups,scaled=0.97]{XCharter}
  \usepackage{cabin} % sans serif
  \usepackage[varqu,varl]{inconsolata} % sans serif typewriter
  \usepackage[libertine,bigdelims,vvarbb,scaled=1.03]{newtxmath} % bb from STIX
  \usepackage[cal=boondoxo]{mathalfa} % mathcal
  \ifmulticol
    % bottom=0.928in for 1.05 linespread
    \geometry{margin=0.75in,top=0.83in,bottom=0.928in} 
    \linespread{1.05}
  \fi
\fi

%% TEXT BOXES

% declare label for box with \boxlabel{label}
% use label with \Boxx{label} or \ref{box:label}

\newcount\BoxNum \BoxNum 1\relax
\makeatletter
\newcommand*{\boxlabel}[1]{%
  \protected@write \@auxout {}{\string \newlabel% 
    {box:#1}{{\the\BoxNum}{\thepage}{}{}{}}}%
  \global\advance\BoxNum 1\relax}
\makeatother
\newcommand*{\Boxx}[1]{Box~\ref{box:#1}}

%% Print box w/ parameters: \textbox{label}{caption}{text}
%% Vary locally as needed for formatting w/renewcommand
%% No * on newcommand to allow multiple paragraphs in text

\newcommand{\textbox}[3]{%
	\begin{figure*}[t]
	\begin{minipage}{\hsize}
	\parindent=15pt
	\noterule
	{\bf \noindent\Boxx{#1}. #2}
	\noterule
	\noindent #3      
	\noterule
	\end{minipage}
	\boxlabel{#1}
	\end{figure*}
}

