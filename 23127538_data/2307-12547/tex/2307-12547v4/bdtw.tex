% \subsection{\pa on Bounded Treewidth Graphs}
%\subsection{Treewidth as Parameter}
% In this part, we study \pa parameterized by the treewidth of the input graph $G$. Note that since the problem is \NPC even for stars, we do not expect FPT algorithms parameterized by the treewidth of $G$. However, we design an algorithm with running time $f(k)\cdot p(n,s,d)$; here $f$ is a computable function on $k = tw(G)$, and $p$ is a polynomial dependent on $n = |V(G)|$, the target size $s$ and the target value $d$.

\begin{theorem}\label{thm:treewidth-pa}
There is an algorithm for \pa with running time $2^{\OO(\tw\log \tw)}\cdot n\cdot {\sf min}\{s^2,d^2\}$ where $n$ is the number of vertices in the input graph, $\tw$ is the treewidth of the input graph, $s$ is the input size of the knapsack and $d$ is the input target value.
\end{theorem}



\begin{proof}
Let $(G = (V_G,E_G),{(w(u))_{u \in V_G}, (\alpha(u))_{u\in V_G}}, s,d)$ be an input instance of \pa such that $\tw=tw(G)$. Let $\mathcal{U} \subseteq V_G$ be a solution subset for the input instance. For technical purposes, we guess a vertex $v \in \mathcal{U}$ --- once the guess is fixed, we are only interested in finding solution subsets $\mathcal{U}'$ that contain $v$ and $\mathcal{U}$ is one such candidate. We also consider a nice edge tree decomposition $(\mathbb{T} = (V_{\mathbb{T}},E_{\mathbb{T}}),\mathcal{X})$ of $G$ that is rooted at a node $r$, and where $v$ has been added to all bags of the decomposition. Therefore, $X_{r} = \{v\}$ and each leaf bag is the singleton set $\{v\}$.

We define a function $\ell: V_{\mathbb{T}} \rightarrow \mathbb{N}$.
%For the root $r$, $\ell(r) = 0$. 
For a vertex $t \in V_\mathbb{T}$, $\ell(t) = \sf{dist}_\mathbb{T}(t,r)$, where $r$ is the root. Note that this implies that $\ell(r) = 0$. Let us assume that the values that $\ell$ takes over the nodes of $\mathbb{T}$ is between $0$ and $L$. Now, we describe a dynamic programming algorithm over $(\mathbb{T},\mathcal{X})$ for \pa.


%%%%%%%%
    \paragraph{\textbf{States.}} We maintain a DP table $D$ where a state has the following components:
    \begin{enumerate}
    \item $t$ represents a node in $V_\mathbb{T}$.
    \item $\mathbb{P} = (P_0,\ldots,P_m), m\leq \tw+1$ represents a partition of the vertex subset $X_t$. 
    \end{enumerate}
%%%%%%
    \paragraph{\textbf{Interpretation of States.}} For a state $[t,\mathbb{P}]$, if there is a solution subset $\mathcal{U}$ let $\mathcal{U'} = \mathcal{U} \cap V(\beta(t))$. Let $\beta_{\mathcal{U'}}$ be the graph induced on $\mathcal{U'}$ in $\beta(t)$. Let $C_1,C_2,\ldots,C_m$ be the connected components of $\beta_{\mathcal{U'}}$. Note that $m\leq \tw+1$. Then in the partition $\mathbb{P} = (P_0,P_1,\ldots,P_m)$, $P_i = C_i \cap X_t, 1 \leq i \leq m$. Also, $P_0 = X_t \setminus \mathcal{U'}$. 

Given a node $t\in V_{\mathbb{T}}$, a subgraph $H$ of $\beta(t)$ is said to be a $\mathbb{P}$-subgraph if (i) the connected components $C_1,C_2,\ldots,C_m$ of $H$, $m\leq \tw+1$ are such that $P_i = C_i \cap X_t, 1 \leq i \leq m$, (ii) $P_0 = X_t \setminus H$. For each state $[t,\mathbb{P}]$, a pair $(w,\alpha)$ with $w\leq s$ is said to be feasible if there is a $\mathbb{P}$-subgraph of $\beta(t)$ whose total weight is $w$ and total value is $\alpha$. Moreover, a feasible pair $(w,\alpha)$ is said to be undominated if there is no other $\mathbb{P}$-subgraph with weight $w'$ and value $\alpha'$ such that $w' \leq w$ and $\alpha' \geq \alpha$. Please note that by default, an empty $\mathbb{P}$-subgraph has total weight $0$ and total value $0$.

For each state $[t,\mathbb{P}]$, we initialize $D[t,\mathbb{P}]$ to the list $\{(0,0)\}$. Our computation shall be such that in the end each $D[t,\mathbb{P}]$ stores the set of all undominated feasible pairs $(w,\alpha)$ for the state $[t,\mathbb{P}]$.

%%%%%%
    \paragraph{\textbf{Dynamic Programming on $D$.}} We describe the following procedure to update the table $D$. We start updating the table for states with nodes $t\in V_\mathbb{T}$ such that $\ell(t)=L$. When all such states are updated, then we move to update states where the node $t$ has $\ell(t) = L-1$, and so on till we finally update states with $r$ as the node --- note that $\ell(r) =0$. For a particular $i$, $0\leq i< L$ and a state $[t,\mathbb{P}]$ such that $\ell(t) = i$, we can assume that $D[t',\mathbb{P}']$ have been evaluated for all $t'$ such that $\ell(t')>i$ and all partitions $\mathbb{P}'$ of $X_{t'}$. Now we consider several cases by which $D[t,\mathbb{P}]$ is updated based on the nature of $t$ in $\mathbb{T}$:
    \begin{enumerate}
    \item Suppose $t$ is a leaf node. Note that by our modification, $X_t = \{v\}$. There can be only 2 partitions for this singleton set --- $\mathbb{P}_t^1 = (P_0 = \emptyset, P_1 = \{v\})$ and $\mathbb{P}_t^2 = (P_0 = \{v\}, P_1 = \emptyset)$. If $\mathbb{P} = \mathbb{P}_t^1$ then $D[t,\mathbb{P}]$ stores the pair $(w(v),\alpha(v))$ if $w(v) \leq s$ and otherwise no modification is made. If $\mathbb{P} = \mathbb{P}_t^2$ then $D[t,\mathbb{P}]$ is not modified.
    
    \item Suppose $t$ is a forget vertex node. Then it has an only child $t'$ where $X_t \subset X_{t'}$ and there is exactly one vertex $u \neq v$ that belongs to $X_{t'}$ but not to $X_t$. Let $\mathbb{P}' = (P'_0,P'_1,\ldots,P'_{m'})$ be a partition of $X_{t'}$ such that when restricted to $X_t$ we obtain the partition $\mathbb{P} = (P_0,P_1,\ldots,P_m )$. For each such partition, we shall do the following.\\ Suppose $\mathbb{P}'$ has $u \in P'_0$, then each feasible undominated pair stored in $D[t',\mathbb{P}']$ is copied to $D[t,\mathbb{P}]$. \\
    Alternatively, suppose $\mathbb{P}'$ has $u \in P'_i, i>0$ and $|P'_i| >1$. Then, each feasible undominated pair stored in $D[t',\mathbb{P}']$ is copied to $D[t,\mathbb{P}]$.\\
    Finally, suppose $\mathbb{P}'$ has $u \in P'_i, i>0$ and $P'_i = \{u\}$. Then we do not make any changes to $D[t,\mathbb{P}]$.
    
    \item Suppose $t$ is an introduce node. Then it has an only child $t'$ where $X_{t'} \subset X_{t}$ and there is exactly one vertex $u \neq v$ that belongs to $X_{t}$ but not $X_{t'}$. Note that no edges incident to $u$ have been introduced yet, and so in $\beta(t)$ $u$ is not yet connected to any other vertex. Let $\mathbb{P}' = (P'_0,P'_1,\ldots,P'_{m'})$ be the partition of $X_{t'}$ obtained from restricting the partition $\mathbb{P} = (P_0,P_1,\ldots,P_m )$ to $X_{t'}$. First, suppose $u \in P_0$. Then we copy all pairs of $D[t',\mathbb{P}']$ to $D[t,\mathbb{P}]$. \\
    Next, suppose $u \in P_i, i>0$ and $P_i = \{u\}$. Then for each pair $(w,\alpha)$ in $D[t',\mathbb{P}']$, if $w + w(u) \leq s$ we add $(w+w(u),\alpha+\alpha(u))$ to the set in $D[t,\mathbb{P}]$.\\
    Finally, let $u \in P_i, i>0$ and $|P_i| >1 $. Then we make no changes to $D[t,\mathbb{P}]$.
    
    \item Suppose $t$ is an introduce edge node. Then it has an only child $t'$ where $X_{t'} = X_{t}$, and additionally for two vertices $u,w \in X_t = X_{t'}$, the edge $\{u,w\}$ is introduced into $\beta(t)$. First, suppose $\mathbb{P} = (P_0,P_1,\ldots,P_m)$ is such that one of $u,w$ is in $P_0$. Then all pairs of $D[t',\mathbb{P}]$ are copied to $D[t,\mathbb{P}]$.\\
    Next, let $u \in P_i$, $w\in P_j$, $i\neq j \neq 0$. Then no updates are made to $D[t,\mathbb{P}]$. \\
    Finally, suppose $u,w \in P_i, i>0$. Copy to $D[t,\mathbb{P}]$ all pairs from $D[t',\mathbb{P}]$. Consider a partition $\mathbb{P}'$ where the part $P'$ contains $u$ and $P''$ contains $w$. $\mathbb{P}'$ is such that $P_i = P' \cup P''$ and any other $P_j$ with $j \neq i$ is a part in $\mathbb{P}'$. Any pair of $D[t',\mathbb{P}']$ is copied to $D[t,\mathbb{P}]$.
    \item Suppose $t$ is a join node. Then it has two children $t_1,t_2$ such that $X_t = X_{t_1} = X_{t_2}$. Consider $\mathbb{P} = (P_0,P_1,\ldots,P_m)$. Let $(w_{\mathbb{P}}, \alpha_{\mathbb{P}})$ be the total weight and value of the vertices in $\cup_{1\leq i \leq m} P_i$. Consider a pair $(w_1,\alpha_1)$ in $D[t_1,\mathbb{P}]$ and a pair $(w_2,\alpha_2)$ in $D[t_2,\mathbb{P}]$. Suppose $w_1 + w_2 - w_{\mathbb{P}} \leq s$. Then we add $(w_1 + w_2 - w_{\mathbb{P}}, \alpha_1+\alpha_2-\alpha_{\mathbb{P}})$ to $D[t,\mathbb{P}]$.
    \end{enumerate}
    
Finally, in the last step of updating $D[t,\mathbb{P}]$, we go through the list saved in $D[t,\mathbb{P}]$ and only keep undominated pairs.

The output of the algorithm is a pair $(w,\alpha)$ stored in $D[r,\mathbb{P} = (P_0 = \emptyset, P_1 = \{v\})]$ such that $w \leq s$ and $\alpha$ is the maximum value over all pairs in $D[r,\mathbb{P}]$.


%%%%%%%
    \paragraph{\textbf{Correctness of the Algorithm.}}

    Recall that we are looking for a solution $\mathcal{U}$ that contains the fixed vertex $v$ that belongs to all bags of the tree decomposition. First, we show that a pair $(w,\alpha)$ belonging to $D[t,\mathbb{P}]$ for a node $t \in V_\mathbb{T}$ and a partition $\mathbb{P}$ of $X_t$ corresponds to a $\mathbb{P}$-subgraph $H$ in $\beta(t)$. Recall that $X_r = \{v\}$. Thus, this implies that a pair $(w,\alpha)$ belonging to $D[r,\mathbb{P} = (P_0 = \emptyset, P_1 = \{v\})]$ corresponds to a connected subgraph of $G$. Moreover, the output is a pair that is feasible and with the highest value. 

    In order to show that a pair $(w,\alpha)$ belonging to $D[t,\mathbb{P}]$ for a node $t \in V_\mathbb{T}$ and a partition $\mathbb{P}$ of $X_t$ corresponds to a $\mathbb{P}$-subgraph $H$ in $\beta(t)$, we need to consider the cases of what $t$ can be:
    \begin{enumerate}
    \item When $t$ is a leaf node with $\ell(t) = i$, $X_t$ only contains $v$ and the update to $D$ is done such that $v$ is the corresponding subgraph to a stored pair. This is true in particular when $i =L$, the base case. From now we can assume that for a node $t$ with $\ell(t) = i < L$ all $D[t',\mathbb{P}']$ entries are correct and correspond to $\mathbb{P}'$-subgraphs in $\beta(t')$ when $\ell(t') > i$.
    \item When $t$ is a forget vertex node, let $t'$ be the child node and $u \neq v$ be the vertex that is being forgotten. We copy pairs from $D[t',\mathbb{P}']$ depending on the structure of $\mathbb{P}'$. Since $\ell(t') > \ell(t)$, by induction hypothesis all entries in $D[t',\mathbb{P}']$ for any partition $\mathbb{P}'$ of $X_{t'}$ are feasible. From the cases considered, we copy a pair to $D[t,\mathbb{P}]$ from a $D[t',\mathbb{P}']$ only when $u$ is not part of the $\mathbb{P}'$-subgraph or is in a component of $\mathbb{P}'$ that has vertices in $X_t$. Thus, the same subgraph is a $\mathbb{P}$-subgraph in $\beta(t)$.
    \item When $t$ is an introduce node, there is a child $t'$ we are introducing a vertex $u \neq v$ that has no adjacent edges added in $\beta(t)$. Since $\ell(t') > \ell(t)$, by induction hypothesis all entries in $D[t',\mathbb{P}']$ for any partition $\mathbb{P}'$ of $X_{t'}$ are feasible. We update pairs in $D[t,\mathbb{P}]$ from $D[t',\mathbb{P}']$ such that either $u$ is not considered as part of a $\mathbb{P}$-subgraph and the pair is certified by the $\mathbb{P}'$-subgraph, or $u$ is added to a $\mathbb{P}'$-subgraph in order to obtain a new $\mathbb{P}$-subgraph.
    \item When $t$ is an introduce edge node, there is a child $t'$ such that $X_t = X_{t'}$ and the only difference is that two vertices $u,w$ in the bags $X_t = X_{t'}$ now have an edge in $\beta(t)$. Since $\ell(t') > \ell(t)$, by induction hypothesis all entries in $D[t',\mathbb{P}']$ for any partition $\mathbb{P}'$ of $X_{t'}$ are feasible. The updates are made in the cases when one of $u$ or $w$ is not in the intended $\mathbb{P}$-subgraph and the included pair is certified by a $\mathbb{P'}$-subgraph, or when the $u$ and $w$ belong to different components of a $\mathbb{P}'$-subgraph and the new $\mathbb{P}$-subgraph has these components merged as a single component.
    \item When $t$ is a join node, there are two children $t_1,t_2$ such that $X_T = X_{t_1} = X_{t_2}$. Note that this implies that $V(\beta(t_1)) \cap V(\beta(t_2)) = X_t$. Since $\ell(t_1),\ell(t_2) > \ell(t)$, by induction hypothesis all entries in $D[t_i,\mathbb{P}']$ for any partition $\mathbb{P}'$ of $X_{t_i}$ are feasible for $i \in \{1,2\}$.We update pairs in $D[t,\mathbb{P}]$ when there is a $\mathbb{P}$-subgraph in $\beta(t_1)$ and a $\mathbb{P}$-subgraph in $\beta(t_2)$ and we take the union of these two subgraphs to obtain a $\mathbb{P}$-subgraph in $\beta(t)$.
    \end{enumerate}
    Thus in all cases of $t$, a pair added to $D[t,\mathbb{P}]$ for some partition of $X_t$ is a feasible pair. Recall that as a last step of updating $D[t,\mathbb{P}]$, we go through the entire list and keep only  undominated pairs in the list.

    What remains to be shown is that an undominated feasible solution $\mathcal{U}$ of \pa in $G$ is contained in $D[r,\mathbb{P} = (P_0 = \emptyset, P_1 = \{v\})]$. Let $w$ be the weight of $\mathcal{U}$ and $\alpha$ be the value. Recall that $v \in \mathcal{U}$. For each $t$, we consider the subgraph $\beta(t) \cap \mathcal{U}$. Let $C_1,C_2,\ldots,C_m$ be components of $\beta(t) \cap \mathcal{U}$ and let for each $1\leq i \leq m, P_i = X_t \cap C_i$. Also, let $P_0 = X_t \setminus \mathcal{U}$. Consider $\mathbb{P} = (P_0,P_1,\ldots,P_m)$. The algorithm updates in $D[t,\mathbb{P}]$ the pair $(w',\alpha')$ for the subsolution $\beta(t) \cap \mathcal{U}$. Therefore, $D[r,\mathbb{P} = (\emptyset,\{v\})]$ contains the pair $(w,\alpha)$. Thus, we are done.
%%%%%%
    \paragraph{\textbf{Running time.}} There are $n$ choices for the fixed vertex $v$. Upon fixing $v$ and adding it to each bag of $(\mathbb{T}, \mathcal{X})$ we consider the total possible number of states.  There are at most $\OO(n)\cdot 2^{\tw\log \tw}$ states. For each state, since we are keeping only undominated pairs, for each $w$ there can be at most one pair with $w$ as the first coordinate; similarly, for each $\alpha$ there can be at most one pair with $\alpha$ as the second coordinate. Thus, the number of undominated pairs in each $D[t,\mathbb{P}]$ is at most ${\sf min}\{s,d\}$. By the description of the algorithm, the maximum length of the list stored at $D[t,\mathbb{P}]$ during updation, but before the check is made for only undominated pairs, is $2^{\tw \log \tw}\cdot{\sf min}\{s^2,d^2\}$. Thus, updating the DP table at any vertex takes $2^{\tw \log \tw}\cdot{\sf min}\{s^2,d^2\}$ time. Since there are $\OO(n\cdot\tw)$ vertices in $\mathbb{T}$, the total running time of the algorithm is $2^{\OO(\tw\log \tw)}\cdot n\cdot {\sf min}\{s^2,d^2\}$.
\end{proof}
