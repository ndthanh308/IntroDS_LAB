\section{MCMC-correction with the score parameterisation}
We propose to combine the properties of the energy parameterisation with the performance and greater availability of the score parameterization. Instead of using an energy parameterization and computing the score by differentiation, we take the reversed approach, use a score parameterization and compute the change in (pseudo-)energy by integrating the score. 

\subsection{Recovering pseudo-energy difference from the score}
This section describes how MCMC acceptance probabilities can be approximated given a score function. 
The MH acceptance probability in \cref{eq:mh:acc_prob} is based on the relative probability of the new candidate $\xCand$ and the current sample $\x^\tau$.
The transition probabilities given by the kernel $\mcKern{\cdot \mid \cdot}$ are assumed to be simple to compute and we focus on the quotient $\pEbm(\xCand) / \pEbm(\x^\tau)$.
To compute the MH acceptance probability $\alpha$, we only need to evaluate the unnormalised target distribution.
For an EBM, this requirement can be further relaxed since $\alpha$ can be expressed in terms of the difference in energy at $\xCand$ and $\x^\tau$, see \cref{eq:mh:rel_energy}.
That is, we do not need to compute the absolute value of the energy, only the difference.

To express the acceptance probability in terms of the score function, we write the difference in energy as a line integral on a curve $\curve$
\begin{align}
    \label{eq:energy_diff:def}
    \energy(\x^\tau, t) - \energy(\xCand, t)
    = - \int_{\curve} \gradR \energy(\rr, t) \cdot \dd \rr
    = - \int_0^1 \gradR \energy(\rr(s), t) \cdot \rr'(s) \, \dd s,
    % = \frac{1}{\sigma_t} \int_0^1 \epsP(\rr(s)) \cdot \rr'(s) \, \dd s,
\end{align}
where $\rr(s)$ is a parameterisation of $\curve$ such that $\rr(0) = \x^\tau$ and $\rr(1) = \xCand$.
The curve parameterisation is arbitrary (under mild conditions) since $\energy$ is a scalar field.

For a score-parametrised diffusion model, we propose to use the relation between the score function and $\epsP$ from \cref{eq:score_noise_connection} to calculate an MH-like ratio as
\begin{align}
    \label{eq:fake_mh}
    \alpha &= \min \left(1, \exp\left[f(\hat{x}, \x^\tau, t)\right] \frac{\, \mcKern{\x^\tau \mid \xCand}}{ \mcKern{\xCand \mid \x^\tau }} \right)
\end{align}
where
\begin{align}
    \label{eq:fake_energy}
    f(\hat{x}, x^\tau, t) &= - \int_0^1 \frac{\epsP(r(s), t)}{\sigma_t} \cdot r'(s) \,\dd s, 
\end{align}
%
representing our constructed pseudo-energy difference. Note that if the score $-\frac{\epsP(x, t)}{\sigma_t} = \gradX F(x, t)$ for some function $F$, \cref{eq:fake_energy} can be interpreted as recovering an (unknown) energy function, and in this case \cref{eq:fake_mh} agrees with \cref{eq:mh:acc_prob}. In general, however, no such function $F$ exists, and the expression \cref{eq:fake_energy} depends on the path $r$ that is integrated over. Nevertheless, we propose to use \cref{eq:fake_mh} to directly model an MH-like acceptance probability, to be used in an MCMC sampling scheme.
An overview of our proposed sampling method is given in \cref{alg:mcmc_reverse_sampling}. 
\input{alg/mcmc_reverse_sampling.tex}

Since \cref{eq:fake_energy} in general depends on the path $r$ between $\x^\tau$ and $\xCand$, we propose two variants for the curve $\curve$:
first is the obvious option of a straight line connecting the two points and the second is a curve running through points where we have already evaluated the score function.
The motivation for the latter option is to reduce the computational burden since evaluating the score is a bottleneck.
Some MCMC methods (notably HMC), require the score at some additional points apart from the current sample.
By choosing a curve which incorporates these points, we achieve greater numerical accuracy, essentially for free.
 
Specifically, we approximate the line integral with the trapezoidal rule, where the number of line segments used to approximate the curve $\curve$ is treated as a hyperparameter.
Note that we have to evaluate $\epsP$ at some internal points on $\curve$, incurring an additional computational burden (except for those we can re-use in the HMC case),
but we avoid differentiating the model by estimating the score function directly, using $\epsP$.
Conversely, the energy parameterisation only evaluates the energy at $\x^\tau$ and $\xCand$, but has to differentiate $\energy$ to obtain the score.

\subsection{MH-correction for composition models}
Our proposed method applies to product compositions and, consequently, enables guidance.
For a product distribution in \cref{eq:comp:prod:ebm}, we have a sum of energies in the exponent, which we can approximate from the score models $\epsPi^i(\x_t, t)$, using the line integral in \cref{eq:energy_diff:def}
\begin{align}
    \label{eq:energy_diff:prod}
    \eProd(\xCand, t) - \eProd(\x^\tau, t)
    &= \sum_i \energyi^i(\xCand, t) - \sum_i \energyi^i(\x^\tau, t)
    = \int_0^1 \sum_i \gradR \energyi^i(\rr(s), t) \cdot r'(s) \, \dd s \nonumber \\
    &=\frac{1}{\sigma_t} \int_0^1 \sum_i \epsPi^i(\rr(s), t) \cdot r'(s) \, \dd s.
\end{align}

For guidance, the score is composed of two terms according to \cref{eq:guidance:score},
where the first term is an unconditional diffusion model $\epsP$ and the second term is the score of a classifier $\pCfull(y \mid \x_t, t)$.
The energy difference for the composed guidance score can in principle, be estimated using \cref{eq:energy_diff:prod}, but since we can evaluate $\pCfull(y \mid \x_t, t)$ directly, only the energy difference for $\epsP$ needs to be estimated with the line integral. 

The score for a negation composition (as formulated in \cite{du2023reduce}) can be computed analogously.
Mixtures, however, are less suitable for this method as they cannot be described as a pseudo-energy difference. One could argue that a similar integration idea can be employed to recover an pseudo-energy at $x$ simply by integrating from an arbitrary fixed point $x^0$ to $x$.
However, this would involve integration along a potentially lengthy curve, which has several disadvantages.
Firstly, it requires a more refined mesh for the numerical integration.
Secondly, as the estimated score is generally not a proper conservative field, the choice of curve will have a greater effect over long distances, making the method less robust.