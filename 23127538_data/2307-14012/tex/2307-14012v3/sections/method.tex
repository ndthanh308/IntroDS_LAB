\section{MCMC Correction Step For Score Parameterization}

We propose combining the energy parameterization properties with the performance and practical accessibility of the score parameterization. Instead of using an energy parameterization and computing the score by differentiation, we take the complementary approach: using a score parameterization and computing the change in (pseudo-)energy by integrating the score.

\subsection{Pseudo-energy Difference and MH-like Correction}
This section describes how MCMC acceptance probabilities can be approximated given a score function. 
The MH acceptance probability in (\ref{eq:mh:acc_prob}) is based on the relative probability of the new candidate $\xCand$ and the current sample $\x^\tau$.
The transition probabilities given by the kernel $\mcKern{\cdot \mid \cdot}$ are assumed to be simple to compute, and we focus on the quotient $\pEbm(\xCand, t) / \pEbm(\x^\tau, t)$.
To compute the MH acceptance probability $\alpha$, we only need to evaluate the unnormalized target distribution.
For an EBM, this 
can be expressed in terms of the difference in energy at $\xCand$ and $\x^\tau$, see (\ref{eq:mh:rel_energy}). That is, we do not need to compute the absolute value of the energy, only the difference.

To express the acceptance probability in terms of the score function of an EBM, we write the difference in energy as a line integral over a curve $\curve$
\begin{equation}
    \label{eq:energy_diff:def}
    \begin{aligned}
    \energy(\x^\tau, t) - &\energy(\xCand, t)
    = - \int_{\curve} \gradR \energy(\rr, t) \cdot \dd \rr
    = - \int_0^1 \gradR \energy(\rr(s), t) \cdot \rr'(s) \, \dd s,
    \end{aligned}
\end{equation}
where $\rr(s)$ is a parameterization of $\curve$ such that $\rr(0) = \x^\tau$ and $\rr(1) = \xCand$.
The choice of curve is arbitrary (under mild conditions), since 
$\energy$ is a scalar field.

For a score-parametrized diffusion model, we propose using a similar approach and calculating an MH-like ratio as follows:
\begin{align}
    \label{eq:fake_mh}
    \alpha &= \min \left(1, \exp\left[\frac{1}{\sigma_t} f(\hat{x}, \x^\tau, t)\right] \frac{\, \mcKern{\x^\tau \mid \xCand}}{ \mcKern{\xCand \mid \x^\tau }} \right),
\end{align}
where
\begin{align}
    \label{eq:fake_energy}
    f(\hat{x}, x^\tau, t) &= -\int_0^1 \epsP(r(s), t) \cdot r'(s) \,\dd s, 
\end{align}
%
representing our constructed \textit{pseudo-energy difference}. This expression can be seen as integrating the vector field $\epsP$ along a path from $x^\tau$ to $\hat{x}$, thereby approximating the change in a scalar potentialâ€”if such a potential existed. Note that if $\epsP(x, t) = \gradX F(x, t)$ for some function $F$, (\ref{eq:fake_energy}) can be interpreted as recovering an (unknown) energy function, and in this case (\ref{eq:fake_mh}) agrees with (\ref{eq:mh:acc_prob}). In general, however, no such function $F$ exists, and the expression (\ref{eq:fake_energy}) depends on the path $r$ that is integrated over. Nevertheless, we propose using (\ref{eq:fake_mh}) to directly model an MH-like acceptance probability to be used in an MCMC sampling scheme.

Since (\ref{eq:fake_energy}) in general depends on the path $r$ between $\x^\tau$ and $\xCand$, we propose two variants for the curve $\curve$.
The first is a straight line connecting the two points.
The second is a curve that passes through intermediate points where the score function $\epsP(\x, t)$ is already evaluated as part of the MCMC proposal step---for instance, the leapfrog trajectory in HMC. The motivation behind the second option is computational: since methods like HMC already require score evaluations at multiple points to propose $\x^\tau$, we can reuse these same evaluations to compute the pseudo-energy difference.
By aligning the integration path with the proposal trajectory, we achieve higher numerical accuracy without incurring additional model evaluations.
 
Specifically, we approximate the line integral with the trapezoidal rule, where the number of line segments used to approximate the curve $\curve$ is treated as a hyperparameter.
Note that we have to evaluate $\epsP$ at some internal points on $\curve$, incurring an additional computational burden (except for those we can re-use in the HMC case),
but we avoid differentiating the model by estimating the score function directly, using $\epsP$.
Conversely, the energy parameterization only evaluates the energy at $\x^\tau$ and $\xCand$, but has to differentiate $\energy$ to obtain the score.

An overview of the full sampling procedure is provided in Algorithm~\ref{alg:annealed_mcmc_sampling}. At each diffusion step, an optional reverse update is followed by an MCMC refinement targeting the intermediate distribution. This formulation aligns with the annealed MCMC framework, where both the reverse step and the MCMC kernel act as design choices guiding the chain toward the final distribution. Including the reverse step typically improves sample quality~\citep{du2023reduce}.
\input{alg/mcmc_reverse_sampling.tex}

\subsection{MH-correction for Composition Models}
The pseudo-energy difference for compositions can be derived based on their specific definitions. Our proposed method applies directly to product compositions. We calculate a pseudo-energy difference, corresponding to $\eProd(\x^\tau, t) - \eProd(\xCand, t)$ for an EBM (defined in (\ref{eq:comp:prod:ebm})), as 
\begin{equation} 
\label{eq:energy_diff:prod} 
- \int_0^1 \sum_i \epsPi^i(\rr(s), t) \cdot r'(s) , \dd s. 
\end{equation} 
Guidance is a specific case of product composition, where the pseudo-score is composed of two terms according to (\ref{eq:guidance:score}): the unconditional diffusion model $\epsP(\x_t, t)$ and the score of a classifier $\pCfull(y \mid \x_t, t)$. Since $\pCfull(y \mid \x_t, t)$ can be evaluated directly, only the pseudo-energy difference for $\epsP(\x_t, t)$ requires computation using the line integral in (\ref{eq:energy_diff:prod}).

The pseudo-energy difference for a negation composition (as defined in~\citep{du2023reduce}) can be computed analogously to products, as negations follow a similar additive structure in their pseudo-scores.

Mixture compositions (as defined in~\citep{du2023reduce}), on the other hand, cannot be expressed as a pseudo-energy difference, since mixtures do not naturally conform to an additive structure analogous to products or negations. However, mixtures can be addressed by first sampling a component distribution according to the mixture definition and then generating a sample from that distribution. The MH-correction can subsequently be applied to this sampled distribution, providing a seamless way to handle mixture compositions within our framework.

This generalization allows our method to support advanced use cases such as classifier guidance, multi-modal fusion, and spatially structured prompts, without requiring retraining or access to energy-based models.
