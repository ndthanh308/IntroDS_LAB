\section{RQ1: what are the characteristics of on-device models in iOS apps}


\subsection{Motivation}
As with the study of on-device models in Android~\cite{huang2021robustness, huang2022smart, xu2019first}, this RQ focuses on on-device models' existing characteristics in iOS apps.
To comprehend the current trends, characteristics, and experiences of on-device models employed by iOS developers, we concentrate on DL framework selection, model quantity, model size, model type, model functionality and model developer for iOS app models.
The exploration of this RQ can support our future investigation into the causes of the current trends and the potential security vulnerabilities associated with the current trends.

This is the first study of the on-device model in iOS, to offer potential insights to future researchers, we begin by presenting our pipeline for data collection in the iOS platform, including how to acquire iOS app files from the Apple App Store~\cite{appleStore} and how to recognise on-device models in iOS apps.

\subsection{iOS App Collection}
\label{sec:appCollection}

\subsubsection{How to Select Apps with On-device Models}
First, we download all 2312 top-rated free apps across 25 categories which are all publicly available on the Apple App Store~\cite{topRatedApp}.

Second, we review the literature on common application scenarios of DL models in mobile apps~\cite{gcloud, xu2019first} and identify 16 prevalent applications based on our own expertise and observations. 
These applications include photo enhancement, object detection, image classification, face detection, image segmentation, optical character recognition (OCR) text recognition, augmented reality, barcode scanning, language identification, smart replies, translation, sound recognition, recommendations, movement tracking, video segmentation, and gesture recognition.
To identify relevant apps, we conduct a search on the iOS app store.
We utilize the identified application scenarios as search keywords and manually sift through the search results to isolate apps that exhibit these features. 
Our search yields 205 apps that align with the aforementioned application scenarios in this way.

Third, one app is usually available on both Android and iOS platforms~\cite{ali2017same}.
Due to their similar functionality, iOS apps may contain on-device models if on-device models are discovered in their Android counterparts.
We discover 423 Android apps that contain on-device models out of a total of 26,346 Android apps crawled from Google Play~\cite{googleplay}.
To match their iOS counterparts, we start by finding corresponding iOS apps with the same app names and developers.
However, the name of the same app may be slightly different on different platforms~\cite{ali2017same}.
For instance, the \emph{Tubi} app's official name on Android is \emph{Tubi-Movies \& TV Shows} whereas it is \emph{Tubi-Watch Movies \& TV Shows} on iOS.
Therefore, we manually locate iOS equivalents for Android apps that cannot be found with the same app name and developer.
In this way, we collects 390 iOS apps.

Until September 30, 2022, we collected a total of 2,907 iOS apps by using previous three approaches.

\subsubsection{How to Get Source Files of iOS Apps}
After logging in with an apple id, we use automated python scripts to imitate the user downloading all free apps from the apple store to the iPhone emulator. Then, we utilise the IPA~\cite{ipaTool} tool to extract all of the downloaded apps' source files.
We make all our collected iOS apps publicly available for more researchers to study\footnote{\href{https://github.com/huhanGitHub/iOS-App-database}{iOS-App-database}}.


\subsection{On-device Model Collection}

\input{tables/tab_framework}

Inspired by related on-device model detection approaches~\cite{xu2019first, huang2021robustness, huang2022smart}, we identify the on-device model by matching specific suffix patterns of the model files in reverse-engineered iOS app source files.

We first investigate popular DL frameworks today that enable the deployment of iOS on-device models.
Following the framework selection process in related works~\cite{xu2019first, huang2021robustness}, we commence our investigation by searching Google and GitHub to identify popular DL frameworks.
We collect relevant information on the features of these frameworks from their official documentation, such as the supported model formats, the suffix patterns of the on-device model supported, open-source status, etc.
We also adopt a similar set of evaluation criteria employed in prior studies~\cite{xu2019first, huang2021robustness} to determine the suitability of the identified frameworks. 
Specifically, frameworks that have not been actively maintained for more than two years and have garnered minimal attention, such as fewer than 100 open-source projects on GitHub, are excluded from consideration in this study.
Table~\ref{tab:overview_of_frameworks} shows the overview of this investigation.
We delete frameworks with fewer than 100 GitHub stars and no updates in the past two years~\cite{xu2019first}.
As illustrated in Table~\ref{tab:overview_of_frameworks}, the columns \emph{Framework}, \emph{Owner}, \emph{Mobile Platform}, \emph{Mobile API} and \emph{Supported Model Format} represent the names, owners, supported mobile platform, supported mobile API and supported model format of DL frameworks, respectively.  
We refer to the suffix patterns in the column \emph{Supported Model Format} to detect on-device models.
The columns \emph{Is Open-source} and \emph{Supported Training} indicate whether the framework is open source and whether the framework's on-device model supports training. 
There are 15 popular DL frameworks support deploying on-device models on iOS now.
9 out of 15 framework models support training, while the remaining models only support prediction using trained models.


To ensure the quality of the model and remove false positive cases, we evaluate the quality of each detected model by loading the model and performing predictions on randomly generated data.
Finally, we discover 1,883 valid on-device models among 2,907 iOS apps after eliminating all non-predictive models.
These 1,883 on-device models belong to 334 iOS apps, of which 190 apps are from top-rated free apps, 40 are from related application scenarios searches, and 104 are from matching Android-iOS app pairs.



\subsection{Characteristics of Apps with On-device Models}

% \chen{1. Are the absolute number comparable? Or use relative percentage? 2. We are analyzing IOS models in this RQ, why also put Android here? Maybe move it to RQ2?}

We study the characteristics of existing on-device models on the iOS platform from two aspects. 
The first aspect is to look at the features of apps containing on-device models, including the category of apps in Section~\ref{sec:appCate}, the number of models contained in each app in Section~\ref{sec:appNum}, the size of the model as a percentage of the app's size in Section~\ref{sec:modelSize} and the developers of DL apps in Section~\ref{sec:appDev}.
Apps dominant portion of smartphones and platforms~\cite{android, apple}.
The first perspective enables us to understand current app-level trends in the employment of on-device models on the iOS platform.
The second aspect is to look at the features of on-device model itself, including the type of current models in Section~\ref{sec:modelType}, the functionality of current models in Section~\ref{sec:modelFunction} and the adoption of DL frameworks in Section~\ref{sec:frameCompare}.
The second perspective allows us to gain insight into the model-level characteristics, laying the foundation for the subsequent research questions.

\subsubsection{How On-device Models are Distributed among App Categories?}
\label{sec:appCate}
We explore the categories of  334 DL model apps.
The top five categories of apps are Photo \& Video (44), Shopping (33), Social Networking (22), Health \& Fitness (20), and Travel (17).
Note that most on-device models are still used in computer vision-related scenarios, like OCR text detection, object recognition, and face detection, even though these apps fall outside of Photo \& Video category.
% We summarize the application scenarios of DL models in apps outside the Photo \& Video category and find that OCR text detection, object recognition, and face detection are the most prevalent.
The findings show that computer vision-related scenarios still predominate the industrial applications of deep learning.
% Deep learning on-device models are most commonly applied in the disciplines of face beauty, virtual reality, and face detection.


\subsubsection{How Many On-device Models are there in One App?}
\label{sec:appNum}
Figure~\ref{fig:modelNum} shows the boxplot of the number of on-device models in one app on iOS.
The mean is 5.54, and the median is 2, indicating that the average number of models in a single app is 5.54 and that half of DL model apps have less than 2 models.
The outliers in the box plot demonstrate that 14 apps own more than 20 DL models.
These outliers are all photo/video processing apps, like Gradient (95), Video Star (51), Facetune2 Editor (160), etc.
These apps provide a multitude of image-processing features, such as skin smoothing, eye enlargement, beauty, etc.
To fulfill these features, developers typically employ multiple pre-trained on-device models.
Hence, these apps contain more on-device models.
\begin{comment}
Among apps with fewer than two models, the majority of apps use object detection models like \emph{SSDOcr.mlmodelc} and \emph{rpn\_text\_detector.tflite} to detect OCR text or QR code.
These apps fall in the Tool, Social Networking, and Lifestyle categories rather than Photo \& Video.
\end{comment}

% Figure environment removed



\subsubsection{What is the Size of On-device Models?}
\label{sec:modelSize}
Given the limited computing and storage resources of mobile phones, the size of the model is a crucial indicator of its suitability for deployment on such devices. Models with large sizes may cause performance and storage issues, while smaller models may be more practical for use on mobile devices~\cite{onCloud, xu2019first}.
The average model size of detected 1,883 on-device models is 0.45MB.
Figure~\ref{fig:modelSize} demonstrates the boxplot of the percentages of the app's size that is occupied by the app's models (Total model sizes/App size).
Results show that the present app's model size is barely average of 1.7\% of the app size.
The apps with the highest proportion are \emph{SoundLab Audio Editor} 46.26\%, \emph{iScanner} 20.92\% and \emph{Carl: Plant Identification} 18.77\%.
The average proportion of on-device models is small, but outliers in Figure~\ref{fig:modelSize} illustrates that the proportion of model size exceeds 10\% in all apps where deep learning plays a crucial role, such as \emph{B612}'s 17.63\%, \emph{EPIK Photo Editor}'s 14.37\%, and \emph{VITA Video Editor}'s 15.72\%.
Even though the average proportion of model size is quite small, the proportions of models in machine learning-related apps are considerable.
Large models in apps will increase the cost of development and maintenance and may have a negative effect on the user experience if they slow down the app~\cite{ballard2007designing}.
Optimizing and downsizing the on-device models is an urgent and promising direction.

\subsubsection{Who Develops On-device Model Apps?}
\label{sec:appDev}
The iOS app store provides a details web page for each app, which includes relevant information about the app's developer. 
In this study, we crawl these web pages and collect the developer information for 334 apps.
334 iOS apps are developed by 297 different companies or developers. 
\emph{Google LLC} has the most apps that employ on-device models, with 10, followed by \emph{Microsoft Corporation} with 5 and \emph{Meta Platforms} with 4.
We notice that Google's apps, such as \emph{Google Street View}, \emph{Google Family Link}, and \emph{Google Home}, typically employ their own frameworks: TensorFlow and TF Lite.
Correspondingly, Microsoft, Meta, and the majority of small- and medium-sized companies, such as Zoom, Netflix, and SHEIN, commonly employ the third-party frameworks Core ML and TF Lite in their apps, such as \emph{Microsoft Office}, \emph{Microsoft OneDrive}, \emph{Meta Business Suite}, and \emph{Oculus}.
Owing to the accumulation of technology and vast data,
large tech companies are the most prolific developers of on-device models.


\subsubsection{What Types are Current On-device Models?}
\label{sec:modelType}
Among 1,883 on-device models, 1,561 (82.9\%) models are CNN models, which are primarily used for image and video classification and detection, 163 (8.7\%) models are RNN models, which are primarily used for text and sound classification, and remaining 159 (8.4\%) models fail to identify the model structures.
The results are consistent with the model functionality analysis in Section~\ref{sec:modelFunction}, as the majority of on-device models in current iOS apps are used in the computer vision domain, and hence the majority of models are of type CNN.


\subsubsection{What are On-device Models Used for in iOS Apps?}
\label{sec:modelFunction}
To figure out what on-device models are used for in iOS apps, we propose a strict pipeline to analyze the functionalities of current on-device models.

\input{tables/tab_figure}

We classify the functionality of a model in three steps.
According to a recent study~\cite{huang2021robustness}, over 60\% of existing DL models in industrial apps are structurally comparable to existing pre-trained models from TensorFlow Hub~\cite{tfhub}.
So, we first manually check whether the model is fine-tuned from typical model architectures, such as ResNet~\cite{he2016deep}, Mobilenet~\cite{howard2017mobilenets}, YOLO~\cite{redmon2016you}, etc.
Typical model architectures are used for specific tasks, such as YOLO for detection, ResNet for classification, and DeepLab~\cite{chen2017deeplab} for segmentation.
The model's functionality could be identified by its classical model structure.
Following the related work proposed by Huang et al.~\cite{huang2021robustness},  we assess whether a given model has been fine-tuned from one of the models in TensorFlow Hub by comparing the structure and parameter similarity between the two models. 
Specifically, we first extract the structure information of the model in terms of layer names, shapes, and data types, and represent it as a string sequence. 
Similarly, we convert a set of pre-trained models into string sequences. 
We then compute the similarity between the model sequence and the pre-trained model sequences. 
Based on this similarity, we can determine whether the model's structure is similar to that of any pre-trained models. 
We follow related works~\cite{huang2022smart, sim2019investigation} to set the threshold of similarity to 80\%.
If the model structure matches a pre-trained model, we compute the parameter similarity between the two models to verify whether the model has been fine-tuned.
Second, we infer the use of models by analyzing the output layer of the mode.
Models with a single activation function, such as \emph{Softmax} and \emph{Sigmoid}, are typically employed for classification tasks\cite{activationFunction}.
Due to the necessity of locating the object's bounding box, the detection task's output layer of models contains regression operations~\cite{szegedy2013deep}.
After the previous two steps, we can identify the model's functionality at a high level.
In the final third step, we follow the approach proposed by Xu et al.~\cite{xu2019first} to infer the model's precise usage scenario by analyzing the semantic data in the app, including the app description, app content, the model name, the layer name, detected labels, and other app-related information.
Finally, we run the app to validate our inferences.
For instance, if the model name is \emph{face\_detect.tflite}, we first confirm that it is a detection model by analyzing the last layer of the model. Next, we infer from the model name and the app's documentation that the model may have a face detection function. Since face detection requires the use of the camera and pictures, we then search for all places in the app that use the camera and pictures for content recognition to verify if face detection exists. If we find face detection in any of these places, we assume that the model's function is face detection. However, if the face detection function is not found, we assign the model's function to object detection at a high level.


Given the amount of effort, we randomly sample 68 (20\%) apps in the 334 iOS apps to study their model functionalities.
We discover 420 (22\%) on-device models among these 68 apps.
Table~\ref{tab:modelUsage} shows the results of our model functionality analysis among these 420 models.
% We refer to related works~\cite{huang2021robustness, xu2019first} and Google Cloud to classify model functionalities.
332 (79\%) on-device models are used in the computer vision field.
The most widely used scenario is Photo Beauty (68), followed by Object Detection (48) and Image Classification (46).
In the natural language processing field, we discover that Language identification (20) is the scenario that uses on-device models the most.
On-device models like \emph{tflite\_langid.tflite} are frequently used by apps like \emph{Camera Translator: Translate +}, \emph{Think Dirty - Shop Clean}, and \emph{Wizz - Make new friends} to distinguish the types of input languages.
Sound recognition (10) is the most widely-used task in the audio field.
In addition, on-device models are also frequently utilized for recommendations (17), particularly in planning apps like \emph{Structured-Daily Planner}, \emph{Motivation-Daily quotes}, and \emph{I am-Daily Affirmations}, where developers frequently make use of the trained On-device model to provide users with appropriate recommendations.

According to the results, computer vision-related domains continue to be the most popular application areas for on-device models. Despite the widespread usage of deep learning techniques in machine translation, developers currently prefer to employ on-cloud deep learning models or third-party APIs for translation and on-device models to identify the type of input language.


\begin{comment}

\subsubsection{App support languages}
\han{optional}
The language an app supports is an important factor reflecting the distribution of app users.
325 of the 340 apps are available in English, followed by 213 in Spanish, 211 in French, 205 in German, and 181 in Chinese.
Developers in almost any country will provide English support for their apps, and English users are by far the largest user base for these apps.

\end{comment}



\begin{comment}
\subsubsection{How the model's effect would influence app ratings and popularity?}

\han{optional}
To explore if and how the effect of the on-device models would influence app ratings and popularity, we conduct a pilot study to analyze app reviews and ratings qualitatively.

% We first select DL model apps and collect all on-device models in these apps.
We first follow the steps in Section~\ref{sec:modelFunction} to figure out the functionalities of detected on-device models in iOS apps.
Second, we collect the top 3 positive and 3 negative reviews of these apps on Apple App Store.
To figure out the impact of on-device models for app ratings and popularity, we manually assess whether these reviews are relevant to the model's functioning after reading them. 
If people praise certain app features as being closely related to the model's functionalities, we consider the model to have a positive influence on the app and vice versa. 

34 apps (10\%) and 201 (10.67\%) on-device models in these apps are randomly selected for this study.
We collect the top 3 positive and negative reviews of these apps from the app store and invite 3 volunteers to read them to see if the content is relevant to the models.
Note that a single review may mention multiple app features, such as the app's price and device compatibility issues, at the same time.
In 102 positive reviews, 51 (50\%) are considered to be relevant to the on-device model functionalities.
On-device model-related functionalities are the most commonly mentioned features in positive reviews, ranking above free (42), usability (23), etc.
For example, in reviews of the app \emph{YouCam Makeup: Selfie Editor}, the highest-ranked reviews by users state \emph{Can do animal makeup too!} and \emph{it helps me take so Many great photos and make u look more beautiful}.
These two reviews clearly show that it is the effect of the DL model that makes the app so well received by users.
In contrast, only 10 out of 102 negative reviews mention model-related features, far below non-free (81), frequent updates (35), device compatibility issues (26), etc.
The results demonstrate that the functionality of the on-device model has been one of the primary reasons why users appreciate an app.
A solid DL model could improve the user experience, entice and retain more users, and increase the app's popularity. 
Deep learning technology has been the major competitive advantage of these apps.

% We find that the fact that the majority of DL apps are photo editing and beauty apps that are well-liked by young users is one of the main reasons for the high amount of reviews on DL model apps.
% Young users are more active and sensitive to upgrades to app functionality, therefore they are more likely to provide app reviews.
% Additionally, we find that features linked to on-device models, such as face beauty effect, good photo capturing, and simple photo editing, are often cited by users in their comments.


\end{comment}


\subsubsection{What is the Adoption of DL Frameworks in iOS Apps? How does it Compare to Models in Android Apps?}
\label{sec:frameCompare}

We investigate the adoption of DL frameworks in 334 iOS apps with on-device models and compare it with their Android counterparts.
1,744 and 1,642 on-device models are validated successfully for the frameworks on 334 iOS and Android apps, respectively.


\begin{comment}
% Figure environment removed
\end{comment}



Figure~\ref{fig:dlDis} demonstrates the distribution of DL frameworks in 334 iOS apps and their comparisons on Android.
There is a significant difference between the distribution of DL frameworks in Android and iOS.
The most widely-used framework in iOS is Core ML, with 638 (36.58\%), followed by TF Lite, with 400 (22.94\%), and TensorFlow 335 (19.21\%).
The first three frameworks combined make up over 75\% of the market for industrial apps.
Android apps usually employ TensorFlow and TF Lite as DL frameworks, accounting for 789 (48.05\%) and 342 (20.83\%) out of 1,642 DL models.
Compared to iOS apps, Android apps have more customized DL models (276, 16.81\%). 
One possible explanation is that Core ML and TF Lite are optimized for their respective platforms and exhibit better compatibility, resulting in lower development costs. Additionally, both frameworks have a large community of users and developers who provide support and resources, making them more accessible and easier to use.
Moreover, the popularity of these frameworks may also be attributed to the companies behind them. Apple and Google are well-established and widely recognized tech giants, and their frameworks may be perceived as more reliable and trustworthy compared to other third-party alternatives.

Moreover, we find that TF Lite and TensorFlow remain the second and third most used frameworks in the iOS platform, with a share of 22.94\% and 19.21\%, respectively. This suggests that the continued popularity of TF Lite and TensorFlow in the iOS platform is not solely based on their ownership by Google but may also be due to other factors.
One possible reason for their popularity is that TensorFlow has been in the market longer than Core ML and has established itself in the deep learning community. Developers may have more experience and expertise in using TensorFlow, making it easier for them to integrate it into their iOS apps. Furthermore, TensorFlow has a larger user base, providing developers with a larger community for support and resources.
Another reason for the popularity of TensorFlow is its wide range of functionalities, including support for natural language processing and speech recognition, in addition to computer vision tasks. This versatility means that TensorFlow may be preferred by developers who require support for a wider range of tasks. Furthermore, TensorFlow may have cross-platform compatibility, allowing developers to use the same model across multiple platforms, including iOS and Android.
% We observe that models, the majority of which have the suffix "model", could not be assigned to a specific framework.
We discover that these customized models are primarily derived from three sources: customized DL SDK, like SenseTime~\cite{sstimeSDK}, traditional machine learning frameworks like XGBoost~\cite{xgboost} and compressed/obfuscated DL models.
% There are still some developers who employ their own deep learning technologies rather than well-known frameworks for the stability of their apps.
Given that Android is considered to be less safe than iOS, more Android developers choose to compress or encrypt the model's parameters and structure to improve the security of on-device models~\cite{huang2021robustness}.
% Other frameworks have much less coverage than TF Lite, TensorFlow, and Core ML.
Compared to Android apps, iOS apps are more likely to utilize Caffe.
However, possibly due to the development expense, many iOS apps, which employ the Caffe framework, such as \emph{NETGEAR Nighthawk - WiFi App} and \emph{Stash: Invest \& Build Wealth}, use the more popular frameworks TF Lite and TensorFlow in their corresponding Android apps, rather than Caffe.
A tiny number of Android and iOS apps use other frameworks like NCNN~\cite{ncnn}, Paddle Lite~\cite{pdlite}, etc.
% We discover that uncommon frameworks are used by less popular apps.
% Popular apps now all use Core ML, TF Lite, TensorFlow, and other mainstream frameworks.
Mainstream apps tend to employ popular and stable DL frameworks like Core ML, TF Lite, and TensorFlow.

On the developer side, reusing the same framework technology when migrating apps across platforms can reduce development costs and improve development efficiency.
On the model side, popular deep learning frameworks support both Android and IOS platforms, and on-device models are intentionally designed to be highly re-usable~\cite{coreML, TensorFlow, xgboost, caffe2, mxnet}.
Despite the framework's efforts for cross-platform reuse architecture, current developers have not adopted it to its fullest extent.




\begin{summary}{}{}
On-device models are utilized extensively across all categories of apps for various functions, especially photo beauty and object detection.
Framework vendors should consider optimizing the model size and quantity in apps.
Large tech companies prefer to on-device models in their apps.
Current on-device models are mostly used in the field of computer vision, hence the majority of models are of the CNN variety.
Developers are more likely to utilize DL frameworks provided by Android or iOS operating system owners like Core ML, TF Lite and TensorFlow.
% Core ML has become the most popular framework for using on-device models on iOS apps.
The consistency between the same app on the Android and iOS platforms utilising the DL Framework is glaringly lacking.
% \chen{Still do not see interesting findings for RQ1.}
\end{summary}







