\documentclass[10pt,twocolumn,letterpaper]{article}

\usepackage{iccv}
\usepackage{times}
\usepackage{epsfig}
\usepackage{graphicx}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{booktabs}
\usepackage{makecell}
\usepackage{arydshln}
\setlength\dashlinedash{0.5pt}
\setlength\dashlinegap{1.5pt}
\setlength\arrayrulewidth{0.3pt}
\usepackage{enumitem}
\usepackage[table]{xcolor}
\usepackage{pifont}
\newcommand{\cmark}{\ding{51}}%
\newcommand{\xmark}{\ding{55}}%
% Include other packages here, before hyperref.
\usepackage{multirow}
\usepackage{subcaption}
\newcommand{\blue}[1]{{\color{blue}{[#1]}}}  %comment
\newcommand{\red}[1]{{\color{red}{[#1]}}}  %comment
\newcommand{\cm}[1]{{\color{red}{[CM:#1]}}}  %comment
\newcommand{\fc}[1]{{\color{blue}{[FC:#1]}}}  %comment
\newcommand{\cmt}[1]{{\color{red}{#1}}} %coloured text

\newcommand{\myparagraph}[1]{\vspace{3pt}\noindent\textbf{#1}}
\newcommand\our{\text{Mask2Anomaly}}
\DeclareMathOperator*{\argmax}{arg\;max}
\DeclareMathOperator*{\argmin}{arg\;min}
\usepackage[pagebackref=true,breaklinks=true,letterpaper=true,colorlinks,bookmarks=false]{hyperref}
\usepackage[capitalize]{cleveref}
% Support for easy cross-referencing
\crefname{section}{Sec.}{Secs.}
\Crefname{section}{Section}{Sections}
\Crefname{table}{Table}{Tables}
\crefname{table}{Tab.}{Tabs.}
\iccvfinalcopy % *** Uncomment this line for the final submission

\def\httilde{\mbox{\tt\raisebox{-.5ex}{\symbol{126}}}}

% Pages are numbered in submission mode, and unnumbered in camera-ready
\ificcvfinal\pagestyle{empty}\fi

\begin{document}

\title{Unmasking Anomalies in Road-Scene Segmentation}


\author{Shyam Nandan Rai$^{1}$, Fabio Cermelli$^{1,2}$, Dario Fontanel$^{1}$, Carlo Masone$^{1}$, Barbara Caputo$^{1}$\\
$^{1}$Politecnico di Torino, $^{2}$Italian Institute of Technology\\
{\tt\small {first.last}@polito.it}
}
\maketitle
\ificcvfinal\thispagestyle{empty}\fi

%%%%%%%%% ABSTRACT
\begin{abstract}
Anomaly segmentation is a critical task for driving applications, and it is approached traditionally as a per-pixel classification problem. However, reasoning individually about each pixel without considering their contextual semantics results in high uncertainty around the objects' boundaries and numerous false positives. We propose a paradigm change by shifting from a per-pixel classification to a mask classification. Our mask-based method, {\our}, demonstrates the feasibility of integrating an anomaly detection method in a mask-classification architecture. {\our} includes several technical novelties that are designed to improve the detection of anomalies in masks: i) a global masked attention module to focus individually on the foreground and background regions; ii) a mask contrastive learning that maximizes the margin between an anomaly and known classes; and iii) a mask refinement solution to reduce false positives. Mask2Anomaly achieves new state-of-the-art results across a range of benchmarks, both in the per-pixel and component-level evaluations. In particular, {\our} reduces the average false positives rate by 60\% \wrt the previous state-of-the-art. Github page: \href{https://github.com/shyam671/Mask2Anomaly-Unmasking-Anomalies-in-Road-Scene-Segmentation}{https://tinyurl.com/54ydrxvj}
\end{abstract}



%=============================================================
%=============================================================
%=============================================================

\section{Introduction}
\label{sec:intro}
Semantic segmentation~\cite{Cordts2016Cityscapes,sun2019naae, Zhang2019fsda,yang2020fda,tavera2022pixda} plays a significant role in self-driving cars because it provides a detailed understanding of surroundings. 
Generally, semantic segmentation models are trained to recognize a pre-defined set of semantic classes (\eg car, pedestrian, road, etc.); however, in real-world applications, they may encounter objects not belonging to such categories (\eg animals or cargo dropped on the road). Therefore, it is essential for these models to identify objects in a scene that are not present during training \ie \textit{anomalies}, both to avoid potential dangers and to enable continual learning~\cite{michieli2021continual, cermelli2020modelingthebackground, douillard2020plop, cermelli2022incremental} and open-world solutions~\cite{cen2021deep}.


Anomaly segmentation (AS)~\cite{blum2019fishyscapes,xia2020synth,fontanel2021detecting,jung2021standardized} addresses this problem, \ie it aims to segment objects from classes that were absent during training. Existing AS methods are built upon the idea of individually classifying the pixels and assigning to each of them an anomaly score. This score may be given by a pixel-level discriminative method~\cite{angus2019oodsem, jung2021standardized, grcic2022densehybrid, tian2022pixel}, by estimating the uncertainty of the individual pixel predictions~\cite{mukhoti2018evaluating}, or by comparing the per-pixel discrepancy between the original image and a synthetic image generated from the semantic predictions~\cite{lis2019detecting, vojir2021road, xia2020synthesize}.
%
However, reasoning on the pixels individually produces noisy anomaly scores, thus leading to a high number of false positives and poorly localized anomalies (see \cref{fig:teaser}).


% Figure environment removed

In this paper, we propose to address this problem by casting AS  as a mask classification task rather than a pixel classification. This idea stems from the recent advances in mask-transformer architectures~\cite{cheng2022masked, cheng2021per}, which demonstrated that it is possible to achieve remarkable performance across various segmentation tasks by classifying masks, rather than pixels. We hypothesize that mask-transformer architectures are better suited to detect anomalies than per-pixel architectures~\cite{chen2018encoder,huang2017densely}, because masks encourage objectness and thus can capture anomalies as whole entities, leading to more congruent anomaly scores and reduced false positives. 
To enable the segmentation of anomalies at the mask level, we revisit the Maximum Softmax Probability (MSP)~\cite{hendrycks2016baseline}, a classic method used in per-pixel AS, and apply it to the masks produced by a mask-transformer model.
However, the effectiveness of such an approach hinges on the model's capability to output masks that capture well anomalies and we found that naively using MSP on top of the best mask-transformer architecture~\cite{cheng2022masked} does not yield good results (see \cref{fig:teaser}).
Hence, we propose several technical contributions to improve the capability of mask-transformer architectures to capture anomalies and reject false positives in driving scenes (see \cref{fig:teaser}): 
\begin{itemize}[noitemsep,topsep=0pt]
    \item At the \textbf{architectural} level, we propose a global masked-attention mechanism that allows the model to focus on both the foreground objects and on the background while retaining the efficiency of the original masked-attention~\cite{cheng2022masked}.
    \item At the \textbf{training} level, we have developed a mask contrastive learning framework that utilizes outlier masks from additional out-of-distribution data to maximize the separation between anomalies and known classes.
    \item At the \textbf{inference} level, we propose a mask-based refinement solution that reduces false positives by filtering masks based on the panoptic segmentation~\cite{kirillov2019panoptic} that distinguishes between ``things'' and ``stuff''.
\end{itemize}
We integrate these contributions on top of the mask architecture~\cite{cheng2022masked} and term this solution \textbf{\our}.
To the best of our knowledge, {\our} is the first demonstration of an AS method that detects anomalies at the mask level. We tested {\our} on standard anomaly segmentation benchmarks for road scenes (Road Anomaly~\cite{lis2019detecting}, Fishyscapes~\cite{blum2021fishyscapes},  Segment Me If You Can~\cite{chan2021segmentmeifyoucan}), achieving the best results among all AS methods by a significant margin. In particular, {\our} reduces on average the false positives rate by more than half \wrt the previous state-of-the-art. Code and pre-trained models will be made publicly available upon acceptance.

%=============================================================
%=============================================================
%=============================================================
\section{Related Work}
\label{sec:related}
\myparagraph{Mask-based semantic segmentation.}
Traditionally, semantic segmentation methods \cite{long2015fully, chen2018encoder, zhao2017pyramid, lin2017refinenet, zhang2018exfuse} have adopted fully-convolutional encoder-decoder architectures \cite{long2015fully, badrinarayanan2017segnet} and addressed the task as a dense classification problem. 
However, transformer architectures have recently caused us to question this paradigm due to their outstanding performance in closely related tasks such as object detection~\cite{carion2020end} and instance segmentation~\cite{he2017mask}. In particular, \cite{cheng2021per} proposed a mask-transformer architecture that addresses segmentation as a mask classification problem. It adopts a transformer and a per-pixel decoder on top of the feature extraction. The generated per-pixel and mask embeddings are combined to produce the segmentation output. Building upon~\cite{cheng2021per},~\cite{cheng2022masked} introduced a new transformer decoder adopting a novel masked-attention module and feeding the transformer decoder with one pixel-decoder high-resolution feature at a time. 

So far, all these mask-transformers have been considered exclusively in a closed set setting, i.e, there are no unknown categories at test time. 
To the best of our knowledge, Mask2Anomaly is the first method that performs AS directly with mask-transformers, thus empowering these approaches with the capability to recognize anomalies in real-world settings.


% Figure environment removed


\myparagraph{Anomaly segmentation} methods can be broadly divided into three categories: (a) Discriminative, (b) Generative, and (c) Uncertainty-based methods.~\textit{Discriminative Methods} are based on the classification of the model outputs. Hendrycks and Gimpel~\cite{hendrycks2016baseline} established the initial AS discriminative baseline by applying a threshold over the maximum softmax probability (MSP) that distinguishes between in-distribution and out-of-distribution data. Other approaches use auxiliary datasets to improve performance \cite{liang2017enhancing, jung2021standardized,tian2022pixel} by calibrating the model over-confident outputs.
Alternatively, \cite{lee2018simple} learns a confidence score by using the Mahalanobis distance, and \cite{chan2021entropy} introduces an entropy-based classifier to discover out-of-distribution classes.
Recently, discriminative methods tailored for semantic segmentation \cite{blum2021fishyscapes} directly segment anomalies in embedding space. In contrast, \cite{grcic2022densehybrid} proposes a hybrid approach that combines the known class posterior, dataset posterior, and an un-normalized data likelihood to estimate anomalies. 
\textit{Generative Methods } provides an alternative paradigm to segment anomalies based on generative models ~\cite{lis2019detecting, di2021pixel, xia2020synthesize, vojir2021road}. These approaches train generative networks to reconstruct anomaly-free training data and then use the generation discrepancy to detect an anomaly at test time. All the generative-based methods heavily rely on the generation quality and thus experience performance degradation due to image artifacts~\cite{fontanel2021detecting}.
Finally,~\textit{Uncertainty based} methods segment anomalies by leveraging uncertainty estimates via Bayesian neural networks~\cite{mukhoti2018evaluating}. 

All the methods discussed above are based on per-pixel classification architectures and score the pixels individually without considering local semantics, leading to noisy anomaly predictions and many false positives. {\our} overcomes this limitation by segmenting anomalies as semantically clustered masks, encouraging the objectness of the predictions. To the best of our knowledge, this is the first work to use masks to score anomalies.



%=============================================================
%=============================================================
%=============================================================
\section{Method}
\label{sec:methodology}
In this section, we begin by introducing problem-setting, followed by describing a generic mask-transformer architecture for anomaly segmentation. Next, we delve into our {\our} architecture and its novel elements.

\subsection{Preliminaries}
Let us denote with $\mathcal{X} \subset \mathbb{R}^{3 \times H \times W}$ the space of RGB images, where $H$ and $W$ are the height and width, respectively, and with $\mathcal{Y} \subset \mathbb{N}^{K \times H \times W}$ the space of semantic labels that associate each pixel in an image to a semantic category from a predefined set $\mathcal{K}$, with $|\mathcal{K}|=K$. At training time we assume to have a dataset $\mathcal{D} = \left\{ (x_i, y_i)\right\}_{i=1}^{D}$, where  $x_i \in \mathcal{X}$ is an image and $y_i\in \mathcal{Y}$ is its ground truth semantic mask. 
The goal for an anomaly segmentation model is to learn a function $f$ that maps the image space to an anomaly score space, \ie $f: \mathcal{X} \mapsto \mathbb{R}^{H \times W}$. For traditional semantic segmentation architectures based on per-pixel classification~\cite{chen2018encoder}, the function $f$ can be obtained in various ways, for example, applying the \textit{Maximum Softmax Probability} (MSP)~\cite{hendrycks2016baseline} on top of the per-pixel classifier. Formally, given the pixel-wise class scores $S(x) \in [0,1]^{K\times H \times W}$ obtained by segmenting the image $x$ with a per-pixel architecture, we compute the anomaly score as:
\begin{equation}
    \label{eq:perpixel_msp}
    f(x) = 1-\max_{k=1}^{K}(S(x)).
\end{equation}

In this paper, we propose to adapt this framework based on MSP to mask-transformer segmentation architectures. We recall that the mask classification problem is formulated as a direct set prediction task with the goal of producing a fixed-size set of $N$ predictions \cite{carion2020end}.
Based on this idea, the mask classification meta-architecture for semantic segmentation consists of three parts: a) a \textit{backbone} that acts as feature extractor, b) a \textit{pixel-decoder} that upsamples the low-resolution features extracted from the backbone to produce high-resolution \textit{per-pixel embeddings}, and c) a \textit{transformer decoder}, made of $L$ transformer layers, that takes the image features to output a fixed number of object queries consisting of \textit{mask embeddings} and their associated \textit{class scores} $C\in \mathbb{R}^{N \times K}$. The final \textit{class mask} $M\in \mathbb{R}^{N\times (H \times W)}$ are obtained by multiplying the mask embeddings with the per-pixel embeddings. 
The mask-transformer is trained using a combination of binary cross-entropy loss and dice loss~\cite{milletari2016v} for the class masks and cross-entropy loss for the class scores, unlike per-pixel architecture that is trained only on cross-entropy loss (more details on these losses are given in the supplementary material).

Given such a mask-transformer architecture, we propose to calculate the 
anomaly scores for an input $x$ as 
\begin{equation}
    \label{eq:mask_msp}
    f(x) = 1 - \max_{k=1}^{K} \left(\text{softmax}(C)^T \cdot \text{sigmoid}(M)\right).
\end{equation}
Here, $f(x)$ utilizes the same marginalization strategy of
class and mask pairs as~\cite{cheng2021per} to get anomaly scores. 
Without loss of generality, we implement the anomaly scoring (\cref{eq:mask_msp}) on top of the Mask2Former~\cite{cheng2022masked} architecture. However, this strategy hinges on the fact that the masks predicted by the segmentation architecture can capture anomalies well. We found that simply applying the MSP on top of Mask2Former as in \cref{eq:mask_msp} does not yield good results (see \cref{fig:teaser} and the results in \cref{sec:ablation}). To overcome this problem, we introduce improvements in the architecture, training procedure, and anomaly inference mechanism. We name our method as {\our},  and its overview is shown in \cref{fig:overview} (left). In the rest of the sections, we will discuss in detail the technical novelties of {\our}.


% Figure environment removed


\subsection{Global Masked Attention}
\label{sec:global_attention}
One of the key ingredients to Mask2Former~\cite{cheng2022masked} state-of-the-art segmentation results is the replacement of the \textit{cross-attention} (CA) layer in the transformer decoder with a \textit{masked-attention} (MA). The masked-attention attends only to pixels within the foreground region of the predicted mask for each query, under the hypothesis that local features are enough to update the query object features. 
%
The output of the $l$-th masked-attention layer can be formulated as
\begin{equation}
    \text{softmax}(\mathcal{M}^F_l + QK^{T})V + X_{in} % & {(\textbf{MA})}
\end{equation}
where $X_{in}\in$ $\mathbb{R}^{N \times C}$ are the $N$ $C$-dimensional query features from the previous decoder layer. The input queries $Q \in \mathbb{R}^{N \times C}$ are obtained by linearly transforming the query features with a learnable transformation whereas the keys and values $K, V$ are the image features under learnable linear transformations $f_k(.)$ and $f_v()$. 
Finally, $\mathcal{M}_l^F$ is the predicted foreground attention mask that at each pixel location $(i, j)$ is defined as
\begin{equation}
    \mathcal{M}_l^F(i, j) = \begin{cases}
        0 & \text{if } M_{l-1}(i, j)  \geq 0.5 \\
        -\infty & \text{otherwise},
    \end{cases}
\end{equation}
where $M_{l-1}$ is the output mask of the previous layer. 

By focusing only on the foreground objects, masked-attention grants faster convergence and better semantic segmentation performance than cross-attention. However, focusing only on the foreground region constitutes a problem for anomaly segmentation because anomalies may also appear in the background regions. Removing background information leads to failure cases in which the anomalies in the background are entirely missed, as shown in the example in \cref{fig:mask2former_attention}. To ameliorate the detection of anomalies in these corner cases, we extend the masked attention with an additional term focusing on the background region (see \cref{fig:overview}, right). We call this a \textit{global masked-attention} (GMA) formally expressed as 
\begin{equation}
    \label{eq:gma}
    \begin{aligned}
        X_{out} = &\text{softmax}(\mathcal{M}_l^{F} + QK^{T})V \\
        +& \text{softmax}(\mathcal{M}_l^{B} + QK^{T})V + X_{in}
    \end{aligned}
%      \quad (\textbf{GMA})
\end{equation}
where $ \mathcal{M}_l^B$ is the additional background attention mask that complements the foreground mask $\mathcal{M}_l^F$, and it is defined at the pixel coordinates $(i, j)$ as
\begin{equation}
    \mathcal{M}_l^B(i, j) = \begin{cases}
        0 & \text{if } M_{l-1}(i, j)  < 0.5 \\
        -\infty & \text{otherwise}.
    \end{cases}
\end{equation}

The global masked-attention in \cref{eq:gma} differs from the masked-attention by additionally attending to the background mask region, yet it retains the benefits of faster convergence w.r.t. the cross-attention. 



%================================================================================================
%================================================================================================
%================================================================================================

\subsection{Mask Contrastive Learning}
\label{subsec:CL}
The ideal characteristic of an anomaly segmentation model is to predict high anomaly scores for out-of-distribution (OOD) objects and low anomaly scores for in-distribution (ID) regions. Namely, we would like to have a significant margin between the likelihood of known classes being predicted at anomalous regions and vice-versa.
A common strategy used to improve this separation is to fine-tune the model with auxiliary out-of-distribution (anomalous) data as supervision~\cite{grcic2020dense,grcic2022densehybrid, blum2021fishyscapes}.  

Here we propose a contrastive learning approach to encourage the model to have a significant margin between the anomaly scores for in-distribution and out-of-distribution classes. 
Our mask-based framework allows us to straightforwardly implement this contrastive strategy by using as supervision 
outlier images generated by cutting anomalous objects from the auxiliary OOD data and pasting it on top of the training data. For each outlier image, we can then generate a binary outlier mask $M_{OOD}$ that is $1$ for out-of-distribution pixels and $0$ for in-distribution class pixels. With this setting, we first calculate the negative likelihood of in-distribution classes using the class scores $C$ and class masks $M$ as:
\begin{equation}
    \begin{aligned}
         l_{N} = - \max_{k=1}^{K} \left(\text{softmax}(C)^T \cdot \text{sigmoid}(M)\right)
    \end{aligned}
\end{equation}
Ideally,  for pixels corresponding to in-distribution classes $l_{N}$ should be $-1$ since the value of $\text{softmax}(C)^T$ and $\text{sigmoid}(M)$ would be close to $1$. On the other hand, for an anomalous pixel, $\text{sigmoid}(M)$ is ideally 0 as M contains only inlier classes mask that results in $l_{N}$ to be $0$. Using $l_{N}$, we define our contrastive loss as:
\begin{equation}
    \begin{aligned}
         L_{CL} &= \frac{1}{2}(l_{CL}^{2}),\\
          l_{CL} &= 
    \begin{cases}
        l_{N} & \text{if} M_{OOD} = 0 \\
        max(0, m - l_{N}) & \text{otherwise,}
    \end{cases}
    \end{aligned}
\end{equation}
where the margin $m$ is a hyperparameter that decides the minimum distance between the out-of-distribution and in-distribution classes.
% Figure environment removed
\subsection{Refinement Mask}
\label{subsec:RM}
False positives are one of the main problems in anomaly segmentation, particularly around object boundaries. Handcrafted methods such as iterative boundary suppression ~\cite{jung2021standardized} or dilated smoothing have been proposed to minimize the false positives at boundaries or globally, however, they require tuning for each specific dataset. 
Instead, we propose a general % (\ie non-dataset specific) 
refinement technique that leverages the capability of mask transformers~\cite{cheng2022masked} to perform all segmentation tasks.
Our method stems from the panoptic perspective~\cite{kirillov2019panoptic} that the elements in the scene can be categorized as \textit{things}, \ie countable objects, and \textit{stuff}, \ie amorphous regions. 
With this distinction in mind, we observe that in driving scenes, i) unknown objects are classified as things, and ii) they are often present on the road. Thus, we can proceed to remove most false positives by filtering out all the masks corresponding to “stuff", except the ``road" category. We implement this removal mechanism in the form of a binary refinement mask $R_{M} \in [0,1]^{H \times W}$, which contains zeros in the segments corresponding to the unwanted ``stuff" masks and one otherwise. Thus, by multiplying $R_{M}$ with the predicted anomaly scores $f$ we filter out all the unwanted ``stuff" masks and eliminate a large portion of the false positives (see \cref{fig:refinements}). Formally, for an image $x$ the refined anomaly scores $f^r$ is computed as:
\begin{equation}
    f^r(x) = R_{M} \odot f(x),
\end{equation}
where $\odot$ is the Hadamard product. 

$R_M$ is the dot product between the binarized output mask $\bar{M} \in \{0,1\}^{N \times (H \times W)}$ and the class filter $\bar{C} \in \{0,1\}^{1 \times N}$, \ie $R_M = \bar{C} \cdot \bar{M}$.
We define $\bar{M} = \text{sigmoid}(M) > 0.5$ and the class filter $\bar{C}$ is equal to $1$ only where the highest class score of $\text{softmax}(C)$ belongs to ``things" or ``road" classes and is greater than $0.95$. 

\section{Experiments}
\myparagraph{Dataset:} We train Mask2Anomaly on Cityscapes~\cite{Cordts2016Cityscapes} and for evaluation we use Road Anomaly~\cite{lis2019detecting},
Fishyscapes~\cite{blum2019fishyscapes} and Segment Me If You Can (SMIYC) benchmarks~\cite{chan2021segmentmeifyoucan}. 

\noindent\textit{Road Anomaly:} is a collection of 60 web images having anomalous objects located on or near the road. 

\noindent\textit{Fishyscapes (FS):} consists of two datasets, Fishyscape static (FS static) and Fishyscapes lost \&  found (FS lost \&  found). Fishyscape static is built by blending Pascal VOC~\cite{everingham2010pascal} objects on Cityscapes images containing 30 validation and 1000 test images. Fishyscapes lost \& found is based on a subset of the Lost and Found dataset~\cite{pinggera2016lost}, with 100 validation and 275 test images. 

\noindent\textit{SMIYC:} consists of two datasets, RoadAnomaly21 (SMIYC-RA21) and RoadObstacle21 (SMIYC-RO21). The SMIYC-RA21  contains 10 validation and 100 test images with diverse anomalies. The SMIYC-RO21 is collected with a focus on segmenting road anomalies and has 30 validation and 327 test images.

\input{tab-main.tex}
\input{sup-additional-metric.tex}

\myparagraph{Evaluation Metrics:} We evaluate all the anomaly segmentation methods at pixel and component levels. For pixel-wise evaluation, we use Area under the Precision-Recall Curve (AuPRC) and False Positive Rate at a true positive rate of 95\% (FPR$_{95}$). Since pixel-level evaluation metrics can neglect small anomalies and be biased towards anomalies with large sizes, we also include component-level evaluations using the averaged component-wise F1 $(F1^{*})$, the positive predictive value (PPV), and the component-wise intersection over union (sIoU). Further, details of all the metrics can be found in the supplementary material.

\myparagraph{Implementation Details:}  Our implementation is  derived from~\cite{cheng2021per,cheng2022masked}. We use a ResNet-50~\cite{he2016deep} encoder, and its weights are initialized from a model that is pre-trained with barlow-twins~\cite{zbontar2021barlow} self-supervision on ImageNet~\cite{deng2009imagenet}. We freeze the encoder weights during training, saving memory and training time. We use a multi-scale deformable attention Transformer (MSDeformAttn)~\cite{zhu2020deformable} as the pixel decoder. The MSDeformAttn gives features maps at $1/8, 1/16,$ and $1/32$ resolution, providing image features to the transformer decoder layers. Our transformer decoder is adopted from~\cite{cheng2022masked} and consists of 9 layers with 100 queries. We train~\our{} using a combination of binary cross-entropy loss and the dice loss~\cite{milletari2016v} for class masks and cross-entropy loss for class scores. The network is trained with an initial learning rate of 1e-4 and batch size of 16 for 90 thousand iterations on AdamW~\cite{loshchilov2017decoupled} with a weight decay of 0.05. We use an image crop of $380\times760$ with large-scale jittering~\cite{du2021simple} along with a random scale ranging from 0.1 to 2.0.

Next, we train the~\our{} in a contrastive setting. We generate the outlier image using AnomalyMix~\cite{tian2022pixel} where we cut an object from MS-COCO~\cite{lin2014microsoft} dataset image and paste them on the Cityscapes image. The corresponding binary mask for an outlier image is created by assigning $1$ to the MS-COCO image area and $0$ to the Cityscapes image area. We randomly sample 300 images from the MS-COCO dataset during training to generate outliers. We train the network for 4000 iterations with $m$ as 0.75, a learning rate of 1e-5, and batch size 8, keeping all the other hyper-parameters the same as above. The probability of choosing an outlier in a training batch is kept at 0.2. 
% Figure environment removed
% Figure environment removed

\subsection{Main Results}
\Cref{tab:main} shows the pixel-level anomaly segmentation results achieved by {\our} and recent SOTA methods on Fishyscapes, SMIYC, and Road Anomaly datasets. We can observe that~\our{} significantly improves the average AuPRC by 20\% and the FPR$_{95}$ by 60\% compared to the second-best method. 
We observe that anomaly segmentation methods based on per-pixel architecture, such as JSRNet, perform exceptionally well on the Road Anomaly dataset. However, JSRNet does not generalize well on other datasets. On the other hand,~\our{} yields excellent results on all the datasets.
Moreover, the property of our mask architecture to encourage objectness, rather than individual pixel anomalies, not only reduces the false positive but also improves the localization of whole anomalies. Indeed, \cref{tab:comp-eval} demonstrates that \our{}  outperforms all the baselined methods on component-level evaluation metrics. To conclude, {\our} yields state-of-the-art anomaly segmentation performance both in pixel and component metrics.

\myparagraph{Qualitative results:} To get a better understanding of the visual results, in \cref{fig:main} we visually compare the anomaly scores predicted by {\our} and its closest competitors: Dense Hybrid~\cite{grcic2022densehybrid} and Maximized Entropy~\cite{chan2021entropy}. 
The results from both: Dense Hybrid and Maximized Entropy exhibit a strong presence of false positives across the scene, particularly on the boundaries of objects (``things'') and regions (``stuff''). On the other hand, \our{} demonstrates the precise segmentation of anomalies while at the same time having minimal false positives. Additional qualitative results are in the supplementary material.

\myparagraph{Segmentation results}: Another critical characteristic of any anomaly segmentation method is that it should not disrupt the in-distribution classification performance, or else it would make the semantic segmentation model unusable. We find that adding only GMA to the base model leads to in-distribution accuracy of 80.45 on the validation set of Cityscapes. The final {\our} model maintains an in-distribution accuracy of 78.88 mIoU, which is still 1.46 points higher than the vanilla Mask2Former. Moreover, it is important to note that both~\our{} and Mask2Former are trained for 90k iterations, indicating that, although ~\our{} additionally attends to the background mask region, it shows convergence similar to Mask2Former. Extended quantitative and qualitative segmentation results with both~\our{} and Mask2Former are presented in the supplementary material.

\subsection{Ablations}
\label{sec:ablation}
All the results reported in this section are from the Fishyscapes lost and found validation dataset.

\myparagraph{Mask2Anomaly:} \Cref{tab:ab}(a) presents the results of a component-wise ablation of the technical novelties included in {\our}. We use Mask2Former as the baseline. As shown in the table, removing any individual component from {\our} drastically reduces the results, thus proving that their individual benefits are complimentary. In particular, we observe that the global masked attention has a big impact on the AuPRC and the contrastive learning is very important for the FPR$_{95}$. The mask refinement brings further improvements to both. \Cref{fig:ablation} visually demonstrates the positive effect of all the components.
\input{tab-ab_main.tex}

% Figure environment removed
\myparagraph{Global Mask Attention:} To better understand the effect of the global masked attention (GMA), in \cref{tab:ab}(c), we compare it to the masked-attention (MA)~\cite{cheng2022masked} and cross-attention (CA)~\cite{vaswani2017attention}. We can observe that although the MA increases the mIoU w.r.t. the CA, it degrades all the metrics for anomaly segmentation, thus confirming our preliminary experiment shown in \cref{fig:mask2former_attention}. On the other hand, the GMA provides improvements across all the metrics.
This is confirmed visually in \cref{fig:attention}, where we show the negative attention maps for the three methods at different resolutions.
The negative attention is calculated by averaging all the queries (since there is no reference known object) and then subtracting one. Note that the GMA has a high response on the anomaly (the giraffe) across all resolutions.


\myparagraph{Refinement Mask:} \Cref{tab:ab}(d) shows the performance gains due to the refinement mask. We observe that filtering out the $\{ \text{``stuff''} \setminus \text{``road''} \} $ regions of the prediction map improves the FPR$_{95}$ by $14.61$ along with marginal improvement in AuPRC. On the other hand, removing the $\{ \text{``things''} \setminus \text{``road''}\}$ regions degrades the results, confirming our hypothesis that anomalies are likely to belong to the ``things'' category. \Cref{fig:ablation} qualitatively shows the improvement achieved with the refinement mask. Also, refinement mask adds a small overhead of 1.12 GFlops compared to Mask2Anomaly 258 GFlops inference cost.


\myparagraph{Mask Contrastive Learning:} We tested the effect of the margin in the contrastive loss $L_{CL}$, and we report these results in \cref{tab:ab}(b). We find that the best results are achieved by setting $m$ to 0.75, but the performance is competitive for any value of $m$ in the table. Similarly, we tested the effect of the batch outlier probability, which is the likelihood of selecting an outlier image in a batch. The results shown in \cref{tab:ab}(e) indicate that the best performance is achieved at $0.2$, but the results remain stable for higher values of the batch outlier probability.
\input{tab-largebackbone.tex}

\myparagraph{Effect of bigger backbones:} We demonstrate the efficacy of {\our} by comparing it to the vanilla Mask2Former but using larger backbones. The results in~\cref{tab:largebackbone} show that despite the disadvantage, Mask2Anomaly with a ResNet-50 still performs better than Mask2Former using large transformer-based backbones. It is also important to note that the number of training parameters for Mask2Anomaly can be reduced to $23M$ by using a frozen self-supervised pre-trained encoder, which is significantly less than all the Mask2Former variations. 

\section{Conclusion}
In this work, we present Mask2Anomaly, a novel anomaly segmentation architecture established on masked architecture. Mask2Anomaly contains global mask attention specifically designed to improve the attention mechanism for anomaly segmentation tasks. Next, we develop a mask contrastive learning framework that utilizes outlier masks to maximize the separation between anomalies and known classes. Finally, 
we introduced mask refinement that reduces false positives and improves the overall performance. We show the efficacy of Mask2Anomaly and its components through extensive qualitative and quantitative results. We hope Mask2Anomaly will open doors for new anomaly segmentation methods based on mask architecture.

%%%%%%%%% REFERENCES
{\small
\bibliographystyle{ieee_fullname}
\bibliography{egbib}
}

\clearpage
\noindent{\large\textbf{Supplementary Material}}

%%%%%%%%% ABSTRACT
\paragraph{Summary:} This supplementary material contains additional method explanations, experiments, and results of~\our{} that include:
\begin{itemize}[noitemsep,topsep=0pt]
    % \item experiments with different self-supervised pre-trained encoders;
    \item explanation of anomaly segmentation evaluation metrics;
    \item\our{} results on validation sets;
    \item outlier loss comparison and analysis;
    \item training loss functions of~\our{} ;
    \item an analysis of various inference techniques applied to a {\our};
    \item performance stability of~\our{};
    \item additional results and supplementary video.
\end{itemize}

\myparagraph{A. Evaluation Metrics}\\
\textbf{Pixel-Level:}  For pixel-wise evaluation, consider $Y \in \{ Y_{a}, Y_{na}\}$ is the pixel level annotated ground truth labels for image $\chi$ containing anomaly. $Y_{a}$ and $Y_{na}$ represents the anomalous and non-anomalous labels in the ground-truth. Assume, $\hat{Y}(\gamma)$ is the model prediction obtained at thresholding $f(x)$ at $\gamma$. Then, we can write precision and recall equations as:
\begin{equation}
\text{precision}(\gamma) = \frac{|Y_{a} \cap \hat{Y}_{a}(\gamma)|} {|\hat{Y}_{a}(\gamma)|}
\end{equation}

\begin{equation}
\text{recall}(\gamma) = \frac{|Y_{a} \cap \hat{Y}_{a}(\gamma)|}{|Y_{a}|}
\end{equation}

\noindent and, AuPRC can be approximated as:

\begin{equation}
\text{AuPRC} = \int_{\gamma}^{}\text{precision}(\gamma)\text{recall}(\gamma)
\end{equation}
The AuPRC works well for unbalanced datasets making it particularly suitable for anomaly segmentation since all the datasets are significantly skewed. Next, we consider the False Positive Rate at a true positive rate of 95\% (FPR$_{95}$), an important criterion for safety-critical applications that is calculated as:
\begin{equation}
\text{FPR}_{95} = \frac{|\hat{Y}_{a}(\gamma^{*}) \cap Y_{na}|}{|Y_{na}|}
\end{equation}

where $\gamma^{*}$ is a threshold when the true positive rate is 95\%.


\noindent\textbf{Component-Level:} SMIYC~\cite{chan2021segmentmeifyoucan} introduced a few component-level evaluation metrics that solely focus on detecting anomalous objects regardless of their size. These metrics are important to be considered because pixel-level metrics may not penalize a model for missing a small anomaly, even though such a small anomaly may be important to be detected. In order to have a component-level assessment of the detected anomalies, the quantities to be considered are the component-wise true-positives ($TP$), false-negatives ($FN$), and false-positives ($FP$). These component-wise quantities can be measured by considering the anomalies as the positive class. From these quantities, we can use three metrics to evaluate the component-wise segmentation of anomalies: sIoU, PPV, and F1$^{*}$. Here we provide the details of how these metrics are computed, using the notation $\mathcal{K}$ to denote the set of ground truth components, and $\hat{\mathcal{K}}$ to denote the set of predicted components.
%\input{sup-table-ab-extra.tex}

The \textit{sIoU} metric used in SMIYC~\cite{chan2021segmentmeifyoucan} is a modified version of the component-wise intersection over union proposed in~\cite{rottmann2020prediction}, which considers the ground-truth components in the computation of the $TP$ and $FN$. Namely, it is computed as 
\begin{equation}
    \text{sIoU}(k) = \frac{|k\cap \hat{K}(k)|}{|k\cap \hat{K}(k) \backslash \mathcal{A}(k)|},
    \qquad \hat{K}(k) = \bigcup_{\hat{k} \in \hat{\mathcal{K}}, \, \hat{k} \cap k \neq \emptyset} \hat{k}
\end{equation}
where $\mathcal{A}(k)$ is an adjustment term that excludes from the union those pixels that correctly intersect with another ground-truth component different from $k$. We refer the reader to~\cite{chan2021segmentmeifyoucan} for more details on this term.
Given a threshold $\tau \in [0, 1]$, a target $k \in \mathcal{K}$ is considered a $TP$ if $sIoU(k) > \tau$, and a $FN$ otherwise.

The positive predictive value (\textit{PPV}) is a metric that measures the $FP$ for a predicted component $\hat{k} \in \hat{\mathcal{K}}$, and it is computed as 
\begin{equation}
    \text{PPV}(\hat{k}) = \frac{|\hat{k}\cap \hat{K}(k)|}{|\hat{k}|}
\end{equation}
A predicted component $\hat{k} \in \hat{\mathcal{K}}$ is considered a $FP$ if $PPV(\hat{k}) \leq \tau$.
\input{sup-tab-fs-val.tex}
Finally, the \textit{$F1^{*}$} summarizes all the component-wise $TP$, $FN$, and $FP$ quantities by the following formula:
\begin{equation}
    \label{f1*}
    F1^{*}(\tau) = \frac{2TP(\tau)}{2TP(\tau) + FN(\tau) + FP(\tau)}
\end{equation}
 
\myparagraph{B. Results on Fishyscapes and SMIYC validation sets}\\
To provide a comprehensive evaluation, we have benchmarked~\our{} results on the Fishyscapes and SMIYC validation sets as presented in~\cref{tab:fs-val} and~\cref{tab:smiyc-val}, respectively. We can observe that~\our{} outperforms all the prior methods by a large margin on both benchmarks. Interestingly, maximized entropy and dense hybrid show the best AuPRC for SMIYC-RO21 and FPR$_{95}$ for FS L\&F, respectively. However, overall~\our{} gives the best performance on all the benchmarks. This suggests that mask-based architecture offers better generalizability in comparison to per-pixel architecture due to its intrinsic property of encouraging objectness. \\

\myparagraph{C. Outlier Loss Comparision}\\
We now empirically demonstrate why mask contrastive loss, a margin-based loss, performs better at anomaly segmentation than binary cross-entropy loss. We train~\our{} with $M_{OOD}$ using binary-cross entropy. The new loss based on the binary cross entropy can be written as:
\begin{equation}
L_{BCE}=M_{OOD}\log(l_{N})+(1-M_{OOD})\log(1-l_{N})
\end{equation}
\begin{equation}
    \begin{aligned}
         \text{where, }l_{N} = - \max_{k=1}^{K} \left(\text{softmax}(C)^T \cdot \text{sigmoid}(M)\right)
    \end{aligned}
\end{equation}
$l_{N}$ is the negative likelihood of in-distribution classes calculated using the class scores $C$ and class masks $M$.~\Cref{fig:BCEvsCL} illustrates the anomaly segmentation performance comparison on FS L\&F validation dataset between the~\our{} when trained with the binary cross entropy loss and mask contrastive loss, respectively. We can observe that the mask contrastive loss achieves a wider margin between out-of-distribution(anomaly) and in-distribution prediction while maintaining significantly lower false positives.\\
\input{sup-tab-smiyc-val.tex}
% Figure environment removed
\input{sup-inference.tex}
\input{sup-diff-outlier-sets}
\input{rebuttal-tab-ss}
\myparagraph{D. Training Loss}\\
\our{} gives two sets of outputs: class scores ($C$) and class masks ($M$). To train $M$, we first pad the ground truth mask $M^{gt}$ with “no object” masks denoted by $\phi$. Since we assume $M\geq M^{gt}$, padding the ground truth masks allow us one-to-one matching. Now, we use bipartite matching to match the ground truth and the predicted masks, and the assignment cost is given by:
\begin{equation}
    L_{masks} = \lambda_{bce}L_{bce} + \lambda_{dice}L_{dice}
\end{equation}
where $L_{bce}$ and $L_{dice}$ are the binary cross entropy loss and the dice loss calculated between the matched masks. $\lambda_{bce}$ and $\lambda_{dice}$ are the loss weights that are both set to $5.0$. 
To train $C$, which indicates the semantic class of a mask, we used the cross-entropy loss $L_{ce}$. The total training loss is given by:
\begin{equation}
    L = L_{masks} + \lambda_{ce}L_{ce}
\end{equation}
with $\lambda_{ce}$ set to 2.0 for the prediction that matched with ground truth and 0.1 for $\phi$, \ie for no object. After training the~\our{} for 90K iterations, we fine-tune the network with the mask contrastive loss $L_{CL}$. The new training loss is written as:
\begin{equation}
    L_{M2A} = L + L_{CL}
\end{equation}
We perform all the training and inference on a single Nvidia Titan RTX with 24GB memory.\\

\myparagraph{E. Mask2Anomaly Inference}\\
The per-pixel classification networks have a straightforward inference as the network outputs a pixel-wise anomaly map. However, in the case of a mask architecture, we get a set of class scores $C$ and a set of binary mask $M$. So, we test various inference techniques on Mask2Anomaly for anomaly segmentation, as shown in~\Cref{tab:sup:inference}. We find that the marginalization over class scores obtained after the softmax and taking the sigmoid of the mask yields the best results. Also, we observe that applying a softmax after the marginalization to perform max-softmax~\cite{hendrycks2016baseline} does not give good results.
% Figure environment removed
\\

\myparagraph{F. Performance stability on different outlier sets}\\
Employing an outlier set to train an anomaly segmentation model presents a challenge because the model's performance can vary significantly across different sets of outliers. Here, we show that~\our{} performs similarly when trained on different outlier sets.

We randomly chose two subsets of 300 MS-COCO images (S1, S2) as our outlier dataset for training~\our{} and DenseHybrid.~\Cref{sup-tab:ood-sets} shows the performance of~\our{} and Dense Hybrid trained on S1 and S2 outlier sets, along with the standard deviation($\sigma$) in the performance. We can observe that the variation in performance for the dense hybrid is significantly higher than~\our{}. Specifically, in dense hybrid, the average deviation in AuPRC is greater than 300\%, and the average variation in FPR$_{95}$ is more than 200\% compared to~\our{}. 

\myparagraph{G. Additional Results}\\
\textbf{Segmentation results:} In~\cref{sstab:main} and~\cref{fig:ss}, we show the segmentation results for~\our{} and Mask2Former. We can qualitatively and qualitatively infer that~\our{} performs better than Mask2Former.\\
\textbf{Qualitative anomaly segmentation:} In~\cref{fig:sup:f1}, we show the qualitative comparison of~\our{} with best-existing anomaly segmentation methods: Maximized Entropy~\cite{chan2021entropy} and Dense Hybrid~\cite{grcic2022densehybrid}. We observe that these per-pixel classification architectures suffer from large false positives, whereas~\our{}, a mask-transformer, shows confident results across all datasets. \\
\textbf{Attention comparison:}~\Cref{fig:sup:f2} shows the anomaly segmentation results obtained using various attention mechanisms, and the global mask attention clearly exhibits the best performance.\\ 
\textbf{Qualitative ablation study:} We show a component-wise qualitative ablation of~\our{} in ~\cref{fig:sup:f3} by progressively adding each components. We can observe that each proposed component improves anomaly segmentation and complements the others.\\
\textbf{Supplementary video:} Shows the performance of~\our{} on the sequence of images of small obstacle dataset~\cite{singh2020lidar}.~\our{} displays an impressive performance in segmenting wildlife on the road and anomalies in low-light conditions.\\
\textbf{Failure cases:} ~\cref{fig:failureCases} shows that~\our{} struggles to segment tiny anomalies and falsely detects road potholes as anomalies.


% Figure environment removed
% Figure environment removed
% Figure environment removed
% Figure environment removed


\end{document}