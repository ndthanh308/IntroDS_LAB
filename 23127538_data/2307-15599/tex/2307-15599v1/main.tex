\documentclass[a4paper, 12pt, english]{article}
\usepackage[margin = 1.5cm]{geometry}
\usepackage{babel}
\usepackage{amsfonts}
\usepackage{amsmath}
\usepackage{amsthm}
\usepackage{amssymb}
\usepackage{mathtools}
\usepackage{accents}
\usepackage{xargs}
\usepackage{xifthen}
\usepackage{hyperref}
\usepackage{csquotes}
\usepackage[dvipsnames]{xcolor}
\usepackage{dsfont}
\usepackage[shortlabels]{enumitem}

\usepackage{apptools}
\AtAppendix{\counterwithin{lemma}{section}}
\AtAppendix{\counterwithin{proposition}{section}}
\AtAppendix{\counterwithin{corollary}{section}}
\AtAppendix{\counterwithin{theorem}{section}}
\AtAppendix{\counterwithin{equation}{section}}

\allowdisplaybreaks

\usepackage[backend = bibtex, citestyle = authoryear, style = authoryear, maxbibnames = 10, maxcitenames = 2, dashed = false, url = false, date = year, doi = false, isbn = false]{biblatex}
\addbibresource[]{bibliography.bib}
\AtEveryBibitem{\clearfield{note}}

\title{Understanding the least well-kept secret of\\ high-frequency trading\footnote{This research benefited from the financial support of the chairs ``Deep finance \& Statistics'' and ``Machine Learning \& systematic methods in finance'' of \'Ecole polytechnique.}}
\author{Sergio Pulido\thanks{Universit\'e Paris-Saclay, CNRS, ENSIIE, Univ Evry, Laboratoire de Math\'ematiques et Mod\'elisation d'Evry (LaMME). \textbf{Email:} sergio.pulidonino@ensiie.fr}  \and Mathieu Rosenbaum\thanks{Centre de Math\'ematiques Appliqu\'ees (CMAP), CNRS, \'Ecole polytechnique, Institut Polytechnique de
Paris. \textbf{Email:} mathieu.rosenbaum@polytechnique.edu} \and Emmanouil Sfendourakis\thanks{Centre de Math\'ematiques Appliqu\'ees (CMAP), CNRS, \'Ecole polytechnique, Institut Polytechnique de
Paris. \textbf{Email:} emmanouil.sfendourakis@polytechnique.edu}}

\newcommand{\qmin}{\underaccent{\bar}{q}}
\newcommand{\qmax}{\bar{q}}
\newcommand{\OC}{\Omega^{c}}
\newcommand{\OD}{\Omega^{d}}
\newcommand{\defeq}{\vcentcolon=}
\newcommand{\diff}{\mathrm{d}}
\newcommand{\integerInterval}[2][1]{\lbrace #1,\dots, #2 \rbrace}
\newcommandx{\PnL}[1][1={}]{\ifthenelse{\isempty{#1}}{\mathrm{PnL}^{t,Q,y,q}}{\mathrm{PnL}^{#1}}}
\newcommandx{\Proba}[2][1={}, 2={}]{\ifthenelse{\isempty{#1}}{\mathbb{P}}{\mathbb{P}^{#1}}\ifthenelse{\isempty{#2}}{}{\left(#2\right)}}
\newcommandx{\E}[2][1={}, 2={}]{\ifthenelse{\isempty{#1}}{\mathbb{E}}{\mathbb{E}^{#1}}\ifthenelse{\isempty{#2}}{}{\left[#2\right]}}
\newcommandx{\X}[1][1={}]{\ifthenelse{\isempty{#1}}{X^{t,Q,x,y,p,q}}{X^{#1}}}
\newcommandx{\Q}[1][1={}]{\ifthenelse{\isempty{#1}}{Q^{t,Q,q}}{Q^{#1}}}
\newcommandx{\Pm}[1][1={}]{\ifthenelse{\isempty{#1}}{P^{t,y,p}}{P^{#1}}}
\newcommandx{\Pe}[1][1={}]{\ifthenelse{\isempty{#1}}{S^{t,y,p}}{S^{#1}}}
\newcommandx{\Y}[1][1={}]{\ifthenelse{\isempty{#1}}{Y^{t,y}}{Y^{#1}}}

\newcommand{\Qa}{\mathcal{Q}^{+,a}_{n}}
\newcommand{\Qb}{\mathcal{Q}^{+,b}_{n}}
\newcommand{\Qi}{\mathcal{Q}^{+,i}_{n}}
\newcommand{\qa}{\bar{q}^a}
\newcommand{\qb}{\bar{q}^b}
\newcommand{\qi}{\bar{q}^i}
\newcommand{\Qmax}{\bar{Q}}

\newcommand{\ybar}{\bar{y}}
\newcommand{\yplus}{y_{+}}
\newcommand{\yminus}{y_{-}}

\newcommand{\D}{\mathcal{D}}

\DeclareMathOperator*{\argmax}{arg\,max}
\DeclareMathOperator*{\esssup}{ess\,sup}

\newenvironment*{dummyenv}{}{}

\newtheorem{lemma}{Lemma}
\newtheorem{proposition}{Proposition}
\newtheorem{corollary}{Corollary}
\newtheorem{theorem}{Theorem}
\newtheorem{hyp}{Hypothesis}
\theoremstyle{definition}
\newtheorem{definition}{Definition}
\theoremstyle{remark}
\newtheorem{rem}{Remark}

\begin{document}

\maketitle

\begin{abstract}
    Volume imbalance in a limit order book is often considered as a reliable indicator for predicting future price moves. In this work, we seek to analyse the nuances of the relationship between prices and volume imbalance. To this end, we study a market-making problem which allows us to view the imbalance as an optimal response to price moves. In our model, there is an underlying efficient price driving the mid-price, which follows the model with uncertainty zones. A single market maker knows the underlying efficient price and consequently the probability of a mid-price jump in the future. She controls the volumes she quotes at the best bid and ask prices. Solving her optimization problem allows us to understand endogenously the price-imbalance connection and to confirm in particular that it is optimal to quote a predictive imbalance. The value function of the market maker's control problem can be viewed as a family of functions, indexed by the level of the market maker's inventory, solving a coupled system of PDEs. We show existence and uniqueness of classical solutions to this coupled system of equations. In the case of a continuous inventory, we also prove uniqueness of the market maker's optimal control policy.
    \\[2ex] 
    \noindent{\textbf{Keywords:} market microstructure, volume imbalance, high-frequency market-making, stochastic optimal control, Hamilton–Jacobi–Bellman equation, classical solutions.}
\end{abstract}


\section{Introduction}

Volume imbalance's high predictive power of mid-price moves is the \textit{least well-kept secret of high-frequency trading}\footnote{Quoting Sasha Stoikov in a research seminar in 2014.}. In a limit order book, the volume imbalance is defined as
\begin{equation*}
    I = \frac{q^b - q^a}{q^b + q^a}
\end{equation*}
where $q^b$ is the quantity of an asset posted on the best bid price, and $q^a$ is the quantity posted on the best ask price. Recent empirical studies have confirmed the predictive nature of the imbalance: when it is close to 1, the mid-price is likely to jump upwards, and when it is close to -1, the mid-price is likely to jump downwards \parencite{huang_simulating_2015,lehalle_limit_2017,sfendourakis_lob_2023}.

Given the importance of the volume imbalance to explain price moves, practitioners commonly use volume imbalance to estimate an \enquote{efficient} price, representing the belief of all the market participants about the value of the asset. One simple way to estimate an efficient price is to consider the weighted mid-price $P^w \defeq \frac{I+1}{2}P^a + \frac{I-1}{2}P^b$, where $P^a$ and $P^b$ denote the ask and bid price, respectively. The weighted mid-price $P^w$ is closer to the ask price when the imbalance is higher, reproducing the empirical intuition. \textcite{stoikov_micro-price_2018} introduces the more sophisticated notion of \enquote{micro-price}, which is defined in terms of observable quantities among which the volume imbalance plays an important role. The micro-price provides a nice measure of the efficient price because it is a martingale and it is generally less noisy than the weighted mid-price. See also \parencite{delattre2013estimating} for the estimation of the efficient price from the order flow. 

In this work, we propose to take the opposite viewpoint, namely to understand the volume imbalance as a response to prices. We consider a market maker who is the only liquidity provider of the market and who knows an efficient price driving the mid-price. The limit orders of the market maker are executed by market takers. The aggregation of market takers is also well-informed about the efficient price: market orders arrive at a rate depending on the efficient price. The market maker quotes volumes at the best bid and ask prices. The posted volumes do not influence the price moves nor the arrival of market orders. We then investigate the character of the optimal posted volumes and, in particular, whether these volumes generate a predictive imbalance in the limit order book. Our model explains, in an endogenous fashion, the subtle price-imbalance connection.

The market-making literature in continuous time is rich. In the pioneering work of \textcite{avellaneda_high-frequency_2008}, which was studied in more mathematical detail by \textcite{gueant_dealing_2013}, the market maker quotes a fixed quantity of the asset on the bid and the ask side and, contrary to our approach, controls the price of these quotes. Their model, well-suited for over-the-counter markets, has been enriched in various ways: allowing to quote different volumes \parencite{bergault_size_2021,barzykin_algorithmic_2023}, or considering principal-agent problems related to the optimal make-take fees of trading platforms \parencite{el_euch_optimal_2021,baldacci2021optimal,baldacci_market_2023}. Models where the market maker controls the price of her quotes are less suited to large-tick assets where most of the trading activity occurs at a half-tick distance from the mid-price.

Models considering a fixed tick size are adapted to the limit order book framework. This is the point of view taken in \parencite{guilbaud_optimal_2013,guilbaud_optimal_2015,fodra_high_2015} who use a Markovian model for the limit order book. The best limits are observed, and the market maker can quote at them, or in the spread. More recently, \textcite{abergel_algorithmic_2020} propose a model where the whole (up to some depth) order book is modeled, and the market maker can have quotes pending anywhere. In these models, however, there is no efficient price driving the mid-price fluctuations.

In \parencite{baldacci_bid_2020}, two tick grids are considered -- one for the bid, and one for the ask. There is an underlying efficient price observed by the market maker. She can only quote at the considered \enquote{fair} bid and ask prices, lying on their respective tick grid, and evolving according to the model with uncertainty zones, introduced by \textcite{robert_new_2011}: when the efficient price hits a defined barrier, the fair bid or ask price jumps. In this work, however, the market maker has no control on the posted volumes.

We adopt a framework close to the one of \parencite{baldacci_bid_2020}: there is an underlying efficient price, following a Bachelier model, and a fair mid-price that jumps up if the efficient price hits the upper barrier and jumps down if it hits the lower barrier. A large-tick stock is considered, hence the market maker is only allowed to quote at half-tick distance from the mid-price. She controls the volume that she posts on each side. The market orders are represented by marked Poisson processes, where the mark is their volume, and they depend on the distance between the efficient price and the mid-price. Consequently, market orders are not controlled by the market maker, which rules out price manipulation in our model.

The market maker's goal is to maximize the exponential utility of her terminal gains. A Hamilton-Jacobi-Bellman system of PDEs with nonlocal boundary conditions is associated to this control problem. Contrary to the majority of the above mentioned studies on optimal market-making, where viscosity solutions are considered, we prove, using PDE techniques, the existence of a classical solution to this system. Using a verification argument, we show that this solution is equal to the value function, and we give a characterization of the optimal controls. In addition, and remarkably, we are able to derive the uniqueness of the optimal control policy. Numerical approximations of the HJB equation -- and consequently of the optimal posted volumes -- elucidate the connection between prices and volume imbalance. Our numerical experiments indicate that for reasonable choices of the model parameters, the optimal posted volume imbalance is predictive of price moves. More precisely, under reasonable scenarios, the optimal volume imbalance is a monotone function of the distance between the efficient and mid-prices, which in turn determine the price moves via the model with uncertainty zones. 

The paper is organized as follows. In Section \ref{sec:notation}, we introduce the mathematical notation used throughout the paper. In Section \ref{sec:control_problem}, we present the market dynamics and the market maker's control problem. In Section \ref{sec:results}, we state the main existence and uniqueness results of the control problem. Numerical illustrations are given in Section \ref{sec:numerics}. We prove the verification theorem in Section \ref{sec:verification}. In Section \ref{sec:hjb}, we prove the existence of a classical solution to the HJB equation. Section \ref{sec:uniqueness} contains the proof of the uniqueness of the control policy. Some additional proofs are relegated to the appendices.

\section{Spaces and notations}\label{sec:notation}

We use many notations from \parencite{friedman_partial_1983} for the domains and norms. All the functions mentioned in this section are real-valued.

For a subset $D$ of $\mathbb{R}^n$, we denote by $\partial D$ its boundary. Let $T> 0$ and $a,b \in \mathbb{R}$, with $a<b$. For $P, Q \in [0,T] \times [a,b]$, $P = (t,y)$, $Q=(t',y')$, we denote $d(P,Q) \defeq \sqrt{|y-y'|^2 + |t-t'|}$ the parabolic distance between $P$ and $Q$. Let $D \subset [0,T] \times [a,b]$. For $P=(t,y) \in D$, we define
\begin{equation*}
    d^D_P \defeq \min\left\{d(P,Q): Q=(t',y') \in \partial D, t' \geqslant t \right\}
\end{equation*}
the distance from the \enquote{parabolic boundary} (here we consider parabolic PDEs with terminal condition and not initial one, as it suits our problem better). For $P, Q \in [0,T] \times [a,b]$, we set $d^D_{PQ} \defeq \min(d_P, d_Q)$.
When $D$ is the whole space $[0,T] \times [a,b]$, we omit the superscript $D$.

For a function $u$ defined on a space $X$, we write $|u|_{\infty} \defeq \sup_X |u|$. We do not specify $X$ when it is clear from the context. Let $C([0,T]\times [a,b])$ be the space of continuous functions on $[0,T] \times [a,b]$ and $C^{1,2}([0,T) \times (a,b))$ the functions $u$ on $[0,T) \times (a,b)$ that are one time differentiable with respect to the first variable (we write $\partial_t u$ for this derivative) and two times differentiable with respect to the second variable (we denote by $\partial_y u$ and $\partial^2_{yy}u$ these derivatives) and such that $\partial_t u$, $\partial_y u$ and $\partial^2_{yy}u$ are continuous on $[0,T) \times (a,b)$.

Let $k \geqslant 0$ and let $u$ be a function defined on $[0,T) \times (a,b)$. We define
\begin{equation*}
    |d^k u|_{\infty} \defeq \sup_{P \in [0,T) \times (a,b)} \left|d_P^k u(P) \right|.
\end{equation*}
For $\delta \in (0,1)$, we write
\begin{equation*}
    |u|_{\delta} \defeq |u|_{\infty} + \sup_{\substack{P,Q \in [0,T) \times (a,b) \\ P \neq Q}}d^{\delta}_{PQ}\frac{|u(P) - u(Q)|}{d(P,Q)^{\delta}}.
\end{equation*}
We write $u \in C^{\delta}$ if and only if $|u|_{\delta} < \infty$. For $k \geqslant 0$, we define
\begin{equation*}
    |d^ku|_{\delta} \defeq |d^ku|_{\infty} + \sup_{\substack{P,Q \in [0,T) \times (a,b) \\ P \neq Q}}d^{k+\delta}_{PQ}\frac{|u(P) - u(Q)|}{d(P,Q)^{\delta}}.
\end{equation*}
Finally, for $u \in C^{1,2}([0,T) \times (a,b))$, we define
\begin{equation*}
    |u|_{2+\delta} \defeq |u|_{\delta} + |d^2 \partial_t u|_{\delta} + |d\partial_y u|_{\delta} + |d^2 \partial^2_{yy} u|_{\delta},
\end{equation*}
and we write $u \in C^{2+\delta}$ if and only if  $|u|_{2+\delta} < \infty$.
We remark that for all $k \geqslant 0$, there exists a constant $C_k$ depending only on the domain such that $|d^k u|_{\delta} \leqslant C_k|u|_{\delta}$.

For a subset $D$ of $[0,T) \times (a,b)$, we define the \enquote{classical} Hölder seminorm of $u$ on $D$ by
\begin{equation*}
    H^{\delta}_D (u) \defeq \sup_{\substack{P,Q \in D \\ P \neq Q}} \frac{|u(P) - u(Q)|}{d(P,Q)^{\delta}}.
\end{equation*}
Let $K$ be a compact included in $[0,T) \times (a,b)$. It is easy to see that there exists a constant $C > 0$ (depending on $K$) such that, for $u$ defined on $[0,T) \times (a,b)$,
\begin{equation*}
    H^{\delta}_K (u) \leqslant C |u|_{\delta}.
\end{equation*}
We also have a constant $C' > 0$ (depending on $K$) such that, for $u \in C^{1,2}([0,T) \times (a,b))$,
\begin{equation*}
    H^{\delta}_K (u) + \sup_K|\partial_t u| + H^{\delta}_K (\partial_t u)+ \sup_K|\partial_y u| + H^{\delta}_K (\partial_y u) + \sup_K|\partial^2_{yy} u| + H^{\delta}_K (\partial^2_{yy} u) \leqslant C' |u|_{2+ \delta}.
\end{equation*}

For a finite measure $\mu$ on an interval $I$ of $\mathbb{R}$ with finite support (i.e. $\mu = \sum_{i \in J}a_i\delta_{i}$ where $J$ is a finite subset of $I$ and $\delta_i$ is the Dirac measure at $i$) and a function $f$ defined on $I$, we write$\int_{I} f(z) \mu(\diff z) = \sum_{i \in J}a_i f(i)$ without supposing any measurability condition on $f$. In general, \enquote{measurability} on an interval on $\mathbb{R}$ shall always be understood in the Borel sense.

We denote by $\mathbb{N}$ the set of natural integers containing 0, and $\mathbb{N}^* \defeq \mathbb{N} \setminus \{0\}$.
We use the notations $x \wedge y \defeq \min\{x,y\}$ and $x \vee y \defeq \max\{x,y\}$. For a subset $A\subset \mathbb{R}$,  $\bar{A}$ is the closure of $A$.
Whenever we take an expectation with respect to a probability measure $\mathbb{Q}$, we write $\mathbb{E}^{\mathbb{Q}}$. If $\mathbb{Q}=\mathbb{P}$, we omit the superscript in the expectation.

\section{Formulation of the control problem}
\label{sec:control_problem}

We consider an optimal market-making problem on a large-tick stock whose mid-price is not controlled by the market maker. The mid-price lies on the inter-tick grid and  follows a variant of the model with uncertainty zones as in \parencite{robert_new_2011}. The (unique) market maker can only quote volumes at the best bid and ask prices which are located half-tick distance from the mid-price. The admissible quotes keep her inventory bounded over a finite interval. She has information about the probability of future mid-price moves due to the fact that she observes the efficient price governing the mid-price dynamics. The knowledge of the efficient price can be interpreted as a signal for the market maker. Market orders arrive on the bid and ask sides with an intensity that depends on the distance between the efficient price and the mid-price, and consequently they cannot be influenced or manipulated by the actions of the market maker. The objective of the market maker is to maximize the expected utility of the profits over a finite time horizon. We consider and exponential utility function for the market maker. We now describe in detail the notation and the specific mathematical setting of this market-making control problem. 

\subsection{The market}


Let $T \in (0,\infty)$ be the trading horizon. The market maker's inventory is bounded in absolute value by $\Qmax$. We consider two different frameworks depending on whether the market maker can quote volumes in a discrete or continuous fashion. In the first case, we fix $n\in\mathbb{N}^*$, and consider traded volumes which are multiples of $\frac{\Qmax}{n}$. For the continuous case, labeled with $n=\infty$, volumes can take values over a continuous interval. The bid and ask quoted volumes should be bounded by $\qa$ and $\qb$, respectively. Necessarily, $\qa,\qb\leqslant 2\Qmax$ and $(\qa, \qb) \in \left(\frac{\Qmax}{n}\mathbb{N}^*\right)^2$ (if $n < \infty$), $(\qa, \qb) \in (0,\infty)^2$ (if $n = \infty$).

%$n \in 2 \mathbb{N}^* \cup \{\infty\}$, $\Qmax \in (0,\infty)$ and $(\qa, \qb) \in \left(\frac{\Qmax}{n}\mathbb{N}^*\right)^2$ (if $n < \infty$), $(\qa, \qb) \in (0,\infty)^2$ (if $n = \infty$), with $\qa, \qb \leqslant 2 \Qmax$. We consider the limit order book of a large-tick stock on the time interval $[0,T]$.

If $n < \infty$, we introduce the sets of possible traded volumes $\Qa \defeq \left\{0,\frac{\Qmax}{n},\dots,\qa - \frac{\Qmax}{n},\qa\right\}$ and $\Qb \defeq \left\{0,\frac{\Qmax}{n},\dots,\qb - \frac{\Qmax}{n},\qb\right\}$. For $n=\infty$, let $\mathcal{Q}_{\infty}^{+,a} \defeq [0,\qa]$ and $\mathcal{Q}_{\infty}^{+,b} \defeq [0,\qb]$. Let $\mu^a$ (resp. $\mu^b$) be a probability measure on $\Qa$ (resp. $\Qb$) such that $\qa$ (resp. $\qb$) belongs to the support of $\mu^a$ (resp. $\mu^b$). The volumes of the arriving market orders will be independent, with distribution $\mu^a$ on the ask side and $\mu^b$ on the bid side.

\begin{rem}
    The assumption $\qa \in \mathrm{supp}(\mu^a)$ and the corresponding one on the bid side are made for identifiability purposes. Otherwise, one can always restrict $\Qa$ to its elements smaller than $\max \mathrm{supp}(\mu^a)$.
\end{rem}

To describe the dynamics of the mid-price and the market orders, we consider a filtered probability space $(\Omega, \mathcal{F}, (\mathcal{F}_t)_{t \in [0,T]}, \mathbb{P})$ satisfying the usual hypotheses which supports a Brownian motion $W$ and two marked Poisson processes $N^a$ (on $[0,T] \times \Qa$) and $N^b$ (on $[0,T] \times \Qb$), all independent. We assume that $N^a(\diff t ,\diff z)$ and $N^b(\diff t ,\diff z)$ have intensity kernels $\diff t\mu^a(\diff z)$ and  $\diff t\mu^b(\diff z)$, respectively. The processes $N^a,N^b$ model the dynamics of the market orders.

As in \parencite{avellaneda_high-frequency_2008}, we consider a stock whose efficient price $S$ follows a Bachelier model $\diff S_t = \sigma \diff W_t$ with volatility parameter $\sigma>0$. The tick size is $\delta>0$ and the mid-price $P$ is endogenous taking values on the inter-tick grid $\frac{\delta}{2} + \delta \mathbb{Z}$. The mid-price moves are modeled following a variant of the model with uncertainty zones defined by \textcite{robert_new_2011} with relative size of the uncertainty zone $\eta>0$: when $S$ hits the barrier $P_{t-} + \delta \left(\frac{1}{2} + \eta\right)$, then $P$ jumps upwards (i.e. $P_t = P_{t-} + \frac{\delta}{2}$), and when $S_t = P_{t-}-\delta\left(\frac{1}{2}+\eta\right)$, then $P$ jumps downwards (i.e. $P_t = P_{t-} - \frac{\delta}{2}$). The quantity $\delta \eta> 0$ is the size of the uncertainty zone. A similar model for price jumps was used by \textcite{baldacci_bid_2020}. A sample path is drawn in Figure \ref{fig:path_uncertainty_zones}

% Figure environment removed



Instead of considering $S$ and $P$ separately, it is convenient to use the signed distance between the efficient price and the mid-price $Y = S-P$. We denote by $\Y$ this signed distance with $\Y_s = y$ for $s \leqslant t$. More rigorously, $\Y_s = Y(t,s,y,\sigma W)$ where $Y$ is the process taking values in $\mathcal{Y} \defeq \left(-\delta\left(\eta + \frac{1}{2}\right), \delta\left(\eta + \frac{1}{2}\right)\right)$ built in Appendix \ref{sec:midprice_construction} with $a = - \delta\left(\eta + \frac{1}{2}\right)$, $b = \delta\left(\eta + \frac{1}{2}\right)$, $a_0=\delta\left(-\eta + \frac{1}{2}\right)$, and $b_0=\delta\left(\eta - \frac{1}{2}\right)$. Let $p \in \frac{\delta}{2} + \mathbb{Z}$. From $\Y$, we can define $\Pm$ the mid-price process starting at $p$ at time $t$ as 
\begin{equation*}
     \Pm_s \defeq p + \delta\sum_{u \in [0,s]} \left(\mathds{1}_{\left\{\Delta \Y_u < 0\right\}} - \mathds{1}_{\left\{\Delta \Y_u > 0\right\}}\right),\quad s \in [0,T]
\end{equation*}
where $\Delta \Y_s = \Y_s - \Y_{s-}$. In order to lighten the notation, we will often write $\bar{y} \defeq \delta\left(\eta + \frac{1}{2}\right)$, $y_+ \defeq \delta\left(\eta - \frac{1}{2}\right)$ and $y_- \defeq \delta\left(-\eta + \frac{1}{2}\right)$.

Let $\Lambda^a, \Lambda^b:[0,T) \times \mathcal{Y} \mapsto (0,\infty)$ be two functions belonging to $C^{\alpha}$ for some $\alpha > 0$. In particular, $\Lambda^a, \Lambda^b$ are bounded by a constant $\Lambda^* > 0$. %{\color{red}We suppose further that they are bounded away from $0$.}
Let $\mathbb{P}^{t,y}$ a probability on $(\Omega, \mathcal{F}, (\mathcal{F}_t)_{t \in [0,T]})$, equivalent to $\Proba$, under which $N^a(\diff t, \diff z)$ and $N^b(\diff t, \diff z)$ have the stochastic intensity kernels $\Lambda^a(t,\Y_t) \mu^a(\diff z) \diff t$ and $\Lambda^b(t,\Y_t) \mu^b(\diff z) \diff t$, respectively. More precisely, 
\begin{equation*}
    \frac{\diff \mathbb{P}^{t,y}}{\diff \mathbb{P}} \defeq L^{t,y}_T
\end{equation*}
where $L^{t,y}$ is the Doléans-Dade exponential martingale given by
\begin{equation*}
    L^{t,y}_s = \prod_{i \in \{a,b\}} \exp\left(
        \int_{(0,s] \times \Qi} \ln\left(\Lambda^i(u,\Y_u)\right) N^{i}(\diff u, \diff z)
        - \int_0^s (\Lambda^i(u,\Y_u) - 1) \diff u
     \right), \quad s\in[0,T].
\end{equation*}
$L^{t,y}$ indeed defines a martingale, since $\Lambda^i$ is bounded \parencite[Section VI, Theorem 4]{bremaud_point_1981}.
In this way, under $\mathbb{P}^{t,y}$, the intensity of arrival of market orders depends on the distance between the efficient price and the mid-price. Whenever we take an expectation with respect to $\mathbb{P}^{t,y}$ we will write $\E[t,y][]$.

\subsection{The market maker's problem}

The market maker can quote, at prices $P \pm \frac{\delta}{2}$, volumes in $\Qa$ and $\Qb$ on the ask and bid side, respectively. We denote by $\mathcal{A}^{big}$ the space of predictable $\Qa \times \Qb$-valued processes.

Her inventory at time $s \in [0,T]$, starting at $t$ with value $Q$, if she chooses a control $q \in \mathcal{A}^{big}$, is
\begin{equation*}
    \Q_s \defeq Q + \int_{(t,s \vee t] \times \Qb} \left(q^b_u \wedge z\right) N^b(\diff u, \diff z) - \int_{(t,s \vee t] \times \Qa} \left(q^a_u \wedge z\right) N^a(\diff u, \diff z).
\end{equation*}

\begin{rem}
    In the formula above we have supposed that if a market order of size $z$ occurred, but the market maker only quoted $q < z$, then the whole $q$ she posted is consumed.
\end{rem}

As in \parencite{gueant_dealing_2013}, \parencite{el_euch_optimal_2021}, \parencite{barzykin_algorithmic_2023}, the market maker wishes to have an inventory bound in order to limit her exposure to big price moves. She therefore uses admissible controls from the space
\begin{equation*}
    \mathcal{A}^{t,Q} \defeq \left\{ q \in \mathcal{A}^{big} : q^a_s \leqslant \Q_{s-} + \Qmax \text{ and } q^b_s \leqslant -\Q_{s-} + \Qmax \text{, for all $s \in [0,T]$}\right\} 
\end{equation*}
if her inventory at time $t$ is $Q \in \mathcal{Q}_n$, where $\mathcal{Q}_n \defeq \left\{ -\Qmax, - \Qmax + \frac{\Qmax}{n},\dots, \Qmax - \frac{\Qmax}{n}, \Qmax\right\}$ if $n < \infty$ and $\mathcal{Q}_{\infty} \defeq \left[-\Qmax, \Qmax\right]$ if $n = \infty$.

If at time $t$ the inventory of the market maker is $Q \in \mathcal{Q}_n$, the mid-price is $p$, and the efficient price is $p+y$, her profit at the end of trading period using the control policy $q \in \mathcal{A}^{t,Q}$ is
\begin{equation*}
    \begin{split}
        \Q_T S_T -& \int_{(t,s \vee t] \times \Qb} \left(q^b_u \wedge z\right)\left(\Pm_u - \frac{\delta}{2}\right) N^b(\diff u, \diff z)\\
         &+ \int_{(t,s \vee t] \times \Qa} \left(q^a_u \wedge z\right) \left(\Pm_u + \frac{\delta}{2}\right)N^a(\diff u, \diff z),
    \end{split}
\end{equation*}
assuming that she is able to liquidate her position at the efficient price in the end. By a simple application of Itô's formula, this quantity is equal to $\PnL_T$ where, for $s\in[0,T]$,
\begin{equation*}
    \begin{aligned}[t]
        \PnL_s = 
        &\int_{(t,s \vee t] \times \Qa} \left(q^a_u \wedge z\right) \left(\frac{\delta}{2} - \Y_u\right)N^a(\diff u, \diff z)\\
        &-
        \int_{(t,s \vee t] \times \Qb} \left(q^b_u \wedge z\right)\left(\frac{\delta}{2} + \Y_u\right) N^b(\diff u, \diff z)\\
        &+\sigma\int_t^{s \vee t} \Q_u \diff W_u.
    \end{aligned}
\end{equation*}

Let $\ell:\mathcal{Q}_n \mapsto \mathbb{R}$ be a \enquote{penalty} function for the inventory held after the trading period. If $n = \infty$, we assume that $\ell$ is continuous. The market maker optimizes an exponential utility function with risk aversion coefficient $\gamma > 0$. More precisely, at time $t$, if $Y = y$ and her inventory is $Q$, she aims to optimize
\begin{equation*}
    J(t,Q,y,q) \defeq \E[t,y][-e^{-\gamma\left(\PnL_T - \ell(\Q_T)\right)}]
\end{equation*}
over $q \in \mathcal{A}^{t,Q}$. We denote henceforth her optimal value function as
\begin{equation}
    \label{eq:value_function}
    U(t,Q,y) \defeq \sup_{q \in \mathcal{A}^{t,Q}} J(t,Q,y,q),\quad (t,Q,y) \in [0,T] \times \mathcal{Q}_n \times \mathcal{Y}.
\end{equation}

\section{Main results}
\label{sec:results}

Before stating the Hamilton-Jacobi-Bellman equation associated to the control problem \eqref{eq:value_function}, we define the corresponding Hamiltonians.
\begin{definition}\label{def:Hamiltonians}
    For $Q \in \mathcal{Q}_n$, $y \in \bar{\mathcal{Y}}$ and a bounded function $\phi:\mathcal{Q}_n \mapsto \mathbb{R}$, we define the Hamiltonians of our problem, provided that they are well-defined (i.e. either $\phi$ is measurable or the measures have finite support):
    \begin{align*}
        H_n^a(\phi,Q,y, \mu^a) & \defeq \sup_{q \in \Qa \cap [0, Q + \Qmax]}
        \int_{\Qa}e^{-\gamma (q \wedge z)\left(\frac{\delta}{2}-y\right)}\phi(Q - z \wedge q)\mu^a(\diff z)\\
        H_n^b(\phi,Q,y, \mu^b) & \defeq \sup_{q \in \Qb \cap [0, -Q + \Qmax]}
        \int_{\Qb}e^{-\gamma (q \wedge z)\left(\frac{\delta}{2}+y\right)}\phi(Q + z \wedge q)\mu^b(\diff z).
    \end{align*}
    We shall omit the arguments $n$, $\mu^a$ and $\mu^b$ whenever it is clear from the context.
\end{definition}

The Hamilton-Jacobi-Bellman (HJB) equation for our problem is, for $(t,y) \in [0,T) \times \mathcal{Y}$ and $Q \in \mathcal{Q}_n$,

\begin{equation}
    \label{eq:HJB_interior}
    \begin{aligned}
        0 = \partial_t u^Q(t,y) &+ \frac{\sigma^2}{2}\partial^2_{yy} u^Q(t,y)
        -\sigma^2 \gamma Q \partial_y u^Q(t,y) + \frac{\sigma^2 \gamma^2 Q^2}{2}u^Q(t,y) - \left(\Lambda^a + \Lambda^b\right)(t,y)u^Q(t,y)\\
        &+\Lambda^a(t,y) H^a\left(\left(u^R(t,y)\right)_{R \in \mathcal{Q}_n}, y, Q\right)
        +\Lambda^b(t,y) H^b\left(\left(u^R(t,y)\right)_{R \in \mathcal{Q}_n}, y, Q\right)
    \end{aligned}
\end{equation}
with boundary conditions, for $(t,y,Q) \in [0,T] \times \bar{\mathcal{Y}} \times \mathcal{Q}_n$,
\begin{equation}
    \label{eq:HJB_border}
    \left\{
        \begin{array}{ll}
            u^Q(T, y) &=-e^{\gamma\ell(Q)} \\
            u^Q\left(t, \ybar\right) &= u^Q\left(t, \yplus\right) \\
            u^Q\left(t, -\ybar\right) &= u^Q\left(t, \yminus\right).
        \end{array}
    \right.
\end{equation}

\begin{rem}
    In equation \eqref{eq:HJB_interior} we use the following convention: for each $(t,y)$, $\left(u^R(t,y)\right)_{R \in \mathcal{Q}_n}$ denotes the real-valued function $R \in \mathcal{Q}_n \mapsto u^R(t,y)$.
\end{rem}
Theorem \ref{thm:existence} below is our first main result. The first part, which is proven in Section \ref{sec:hjb}, states the existence of classical solutions of the HJB equation \eqref{eq:HJB_interior}-\eqref{eq:HJB_border}. The second part, proved in Appendix \ref{sec:convergence_discrete_continuous}, shows that the continuous inventory case can be uniformly approximated by the discrete inventory case. 

\begin{theorem}[Existence and convergence]
    \label{thm:existence}
    $ $
    \begin{itemize}
        \item[(i)] There exists a family of functions $(u^Q)_{Q \in \mathcal{Q}_n}$ and $\beta \in (0,1)$ such that: 
        \begin{itemize}
            \item $(t,y,Q)\mapsto u^Q(t,y)$ is continuous on $[0,T] \times \bar{\mathcal{Y}} \times \mathcal{Q}_{n}$,
            \item for all $Q \in \mathcal{Q}_n$, $u^Q \in  C^{1,2}([0,T)\times \mathcal{Y})$,
            \item $\sup\limits_{Q \in \mathcal{Q}_n}|u^Q|_{2+\beta}<\infty$,
            \item the HJB equation \eqref{eq:HJB_interior}-\eqref{eq:HJB_border} holds.
        \end{itemize}
        Furthermore, the constant $\beta$ can be chosen to depend only on $\alpha$, $T$, $\Qmax$, $\delta$, $\gamma$, $\sigma$, $\eta$, $\Lambda^*$ and not on $n$, $\mu^a$, $\mu^b$, $\qa$, $\qb$.
        \item[(ii)] Fix $\qa, \qb \in (0,2\Qmax]^2$. For $n \in \mathbb{N}^*$, let $\qa_{n} \defeq \frac{\Qmax}{n}\left\lfloor \frac{n}{\Qmax}\qa \right\rfloor$ and $\qb_{n} \defeq \frac{\Qmax}{n}\left\lfloor \frac{n}{\Qmax}\qb \right\rfloor$. Define, just for the scope of this theorem, $\mathcal{Q}_{n}^{+,a} \defeq \left\{0,\frac{\Qmax}{n},\dots,\qa_{n} - \frac{\Qmax}{n},\qa_{n}\right\}$ and $\mathcal{Q}_{n}^{+,b} \defeq \left\{0,\frac{\Qmax}{n},\dots,\qb_{n} - \frac{\Qmax}{n},\qb_{n}\right\}$.
    Let $(u^Q)_{Q \in \mathcal{Q}_{\infty}}$ be a solution given by point (i) with $n=\infty$, and $\mu^a$, $\mu^b$ be two probability measures on $\mathcal{Q}^{+,a}_{\infty}$ and $\mathcal{Q}^{+,b}_{\infty}$, respectively.\\
    Then, there exist two sequences of probability measures $(\mu^a_{n})_{n \in \mathbb{N}^*}$, $(\mu^b_{n})_{n \in \mathbb{N}^*}$ such that for $n \in \mathbb{N}^*$, $\mu^a_{n}$ (resp. $\mu^b_{n}$) is a measure on $\mathcal{Q}_{n}^{+,a}$ (resp. $\mathcal{Q}_{n}^{+,b}$) and $\qa_{n}$ (resp. $\qb_{n}$) is in its support, and if $(u_n^Q)_{Q \in \mathcal{Q}_{n}}$ verifies all the conditions of point (i), with associated measures $\mu^a_{n}$, $\mu^b_{n}$, we have
    \begin{equation*}
        \lim_{n \to \infty} \sup_{Q \in \mathcal{Q}_{n}}\left|u^{Q}_{n}-u^Q \right|_{\infty} = 0.
    \end{equation*}
    \end{itemize}
\end{theorem}

Our second main result is the following verification theorem, whose proof can be found in Section \ref{sec:verification}. It states that the value function is the solution of the HJB equation and the optimal controls maximize the corresponding Hamiltonians. Moreover, there exist Markovian optimal controls.

\begin{theorem}[Verification]
    \label{thm:verification}
    Let $(u^Q)_{Q \in \mathcal{Q}_n}$ be a family of functions verifying the conditions of (i) in Theorem \ref{thm:existence}.
    \begin{itemize}
        \item[(i)] There exist two measurable functions $\hat{q}^a$, $\hat{q}^b:[0,T] \times \mathcal{Q}_n \times \bar{\mathcal{Y}}\mapsto [0,\infty)$ such that, for all $(t,Q,y)\in [0,T] \times \mathcal{Q}_n \times \bar{\mathcal{Y}}$, $\hat{q}^a(t,Q,y) \leqslant Q + \Qmax $, $\hat{q}^b(t,Q,y) \leqslant -Q + \Qmax$ and
    \begin{align*}
        H^a\left(\left(u^R(t,y)\right)_{R \in \mathcal{Q}_n}, y, Q\right)
        & = \int_{\Qa} e^{-\gamma \left(\hat{q}^a(t,Q,y) \wedge z\right)\left(\frac{\delta}{2} - y\right)}u^{Q - \hat{q}^a(t,Q,y) \wedge z}(t,y)\mu^a(\diff z),\\
        H^b\left(\left(u^R(t,y)\right)_{R \in \mathcal{Q}_n}, y, Q\right) 
        & = \int_{\Qb}e^{-\gamma \left(\hat{q}^b(t,Q,y) \wedge z\right)\left(\frac{\delta}{2} + y\right)}u^{Q + \hat{q}^b(t,Q,y) \wedge z}(t,y) \mu^b(\diff z).
    \end{align*}
        \item[(ii)] For all $(t,Q,y) \in [0,T) \times \mathcal{Q}_n \times \mathcal{Y}$, there exists a unique (up to an evanescent set) control $q^*=(q^{*a}, q^{*b}) \in \mathcal{A}^{t,Q}$ such that, almost surely, for all $s\in [0,T)$
        \begin{equation}
        \label{eq:existence_control}
        q^{*a}_s = \hat{q}^a\left(s \vee t, Q^{t,Q,q^*}_{s-}, \Y_s\right),\quad q^{*b}_s = \hat{q}^b\left(s \vee t, Q^{t,Q,q^*}_{s-}, \Y_s\right).
        \end{equation} 
        \item[(iii)] For all $(t,Q,y) \in [0,T] \times \mathcal{Q}_n \times \mathcal{Y}$, $u^Q(t,y) = U(t,Q,y)$. Furthermore, $U(t,Q,y) = J(t,Q,y,q^*)$.
        \item[(iv)] Let $(t,Q,y) \in [0,T) \times \mathcal{Q}_n \times \mathcal{Y}$ and $q = (q^a, q^b)\in \mathcal{A}^{t,Q}$ such that $J(t,Q,y,q) = U(t,Q,y)$. Then, on $[t,T] \times \Omega$,
    \begin{align*}
        q^a_s &\in \argmax_{q \in \Qa \cap [0,\Q_s+\Qmax]}\int_{\Qa}e^{-\gamma (q \wedge z)\left(\frac{\delta}{2} - \Y_s\right)}u^{\Q_s - z \wedge q}\left(s,\Y_s\right)\mu^a(\diff z),\\
        q^b_s &\in \argmax_{q \in \Qb \cap [0,-\Q_s+\Qmax]}\int_{\Qb}e^{-\gamma (q \wedge z)\left(\frac{\delta}{2} + \Y_s\right)}u^{\Q_s + z \wedge q}\left(s,\Y_s\right)\mu^b(\diff z)
    \end{align*}
    $\diff s \otimes \Proba[][\diff \omega]$-almost everywhere.   
    \end{itemize}
\end{theorem}

\begin{rem}
    Theorem \ref{thm:verification}(iii) yields the uniqueness of families of functions $(u^Q)_{Q \in \mathcal{Q}_n}$ verifying the conditions of Theorem \ref{thm:existence}(i). It allows us to extend $U$ to $[0,T] \times \mathcal{Q}_n \times \bar{\mathcal{Y}}$ by continuity.
\end{rem}

Our last main result, Theorem \ref{thm:uniqueness}, proves the uniqueness of the optimal control policies in the case of continuous inventory. This follows from Proposition \ref{prop:log_concavity} which shows that the negative of the value function is log-convex. Section \ref{sec:uniqueness} contains the proofs of these results.

\begin{proposition}
    \label{prop:log_concavity}
    Suppose $n=\infty$.
    \begin{itemize}
        \item[(i)] For all $(t,Q,y) \in [0,T] \times \mathcal{Q}_{\infty} \times \bar{\mathcal{Y}}$, $U(t,Q,y) < 0$.
        \item[(ii)] Suppose $\ell$ is convex. Then, for all $(t,y) \in [0,T) \times \bar{\mathcal{Y}}$, the function $Q \in \mathcal{Q}_{\infty} \mapsto -\ln\left(-U(t,Q,y)\right)$ is strictly concave.
    \end{itemize}
\end{proposition}

\begin{theorem}
    \label{thm:uniqueness}
    Suppose $n = \infty$ and $\ell$ is convex. Let $(t,Q,y) \in [0,T) \times \mathcal{Q}_{\infty} \times \bar{\mathcal{Y}}$. Let $q^* \in \mathcal{A}^{t,Q}$ be a control policy given by Theorem \ref{thm:verification}(ii). Then, the following hold:
    \begin{itemize}
        \item[(i)]{\small
    \begin{align*}
        \argmax_{q \in \mathcal{Q}_{\infty}^{+,a} \cap [0,Q+\Qmax]}\int_{\mathcal{Q}_{\infty}^{+,a}}e^{-\gamma (q \wedge z)\left(\frac{\delta}{2} - y\right)}U\left(t,Q - q \wedge z,y\right)\mu^a(\diff z)
        &=
        \argmax_{q \in \mathcal{Q}_{\infty}^{+,a} \cap [0,Q+\Qmax]}e^{-\gamma q\left(\frac{\delta}{2} - y\right)}U\left(t,Q - q,y\right),\\
        \argmax_{q \in \mathcal{Q}_{\infty}^{+,b} \cap [0,-Q+\Qmax]}\int_{\mathcal{Q}_{\infty}^{+,b}}e^{-\gamma (q \wedge z)\left(\frac{\delta}{2} + y\right)}U\left(t,Q + q \wedge z,y\right)\mu^b(\diff z)
        &=
        \argmax_{q \in \mathcal{Q}_{\infty}^{+,b} \cap [0,-Q+\Qmax]}e^{-\gamma q\left(\frac{\delta}{2} + y\right)}U\left(t,Q + q,y\right),
    \end{align*}}
    and these sets contain only one element.
        \item[(ii)] For every control $q \in \mathcal{A}^{t,Q}$ such that $J(t,Q,y,q) = U(t,Q,y)$, $q_s(\omega) = q_s^*(\omega)$ $\diff s \otimes \Proba[][\diff \omega]$-almost everywhere on $[t,T] \times \Omega$.
        \item[(iii)] The functions $\hat{q}^a$ and $\hat{q}^b$ defined in Theorem \ref{thm:verification}(i) (which are uniquely determined on $[0,T) \times \mathcal{Q}_{\infty} \times \bar{\mathcal{Y}}$ thanks to (i) above) are continuous on $[0,T) \times \mathcal{Q}_{\infty} \times \bar{\mathcal{Y}}$.
    \end{itemize}
\end{theorem}

\section{Numerical results}
\label{sec:numerics}
We approximate the value function $U$ and the corresponding optimal controls $\hat{q}^a$, $\hat{q}^b$ using an implicit-explicit finite difference scheme for the Hamilton-Jacobi-Bellman equation. The scheme is implicit over the linear part of the equation and explicit over the non-linear part corresponding to the Hamiltonians. We discretize $[0,T]$ into $n_t = 7500$ subintervals and $\mathcal{Y}$ into $n_y = 350$ subintervals.

In our experiments, we use $n=100$, $T=3600$, $\delta = 0.01$, $\eta=0.2$, $\Qmax = 50$. We consider symmetric, time-independent, affine intensities at the bid and ask sides: $\Lambda^a:y \in \mathcal{Y}\mapsto Ay + B$, $\Lambda^b:y \in \mathcal{Y}\mapsto -Ay + B$ where $B > 0$ and $A \in \mathbb{R}$ such that $|A|\delta\left(\eta + \frac{1}{2}\right) < B$ (this guarantees that $\Lambda^a$ and $\Lambda^b$ remain positive). We choose $\qa = \qb = 100$ and the same power-law execution measure on the bid and ask sides: for $q \in \integerInterval[0]{100}$, $\mu^a\left(\left\{q\right\}\right) = \mu^b\left(\left\{q\right\}\right) = \frac{0.9^q}{\sum_{i=0}^{100}0.9^i}$. We consider a quadratic penalty function $\ell : Q \in \mathcal{Q}_n \mapsto 0.001 \cdot Q^2$.

\subsection{General observations}

In this subsection we consider positive values of $A$. The same observations can be made, even when $A$ is negative, which is the (unrealistic) case where more market orders occur when $S_t - P_t$ is disadvantageous for the market takers.

For the largest part of the trading period, and for fixed levels of $(Q,y)$, the market maker's optimal quotes $\hat{q}^a(t,Q,y)$ and $\hat{q}^b(t,Q,y)$ are constant with respect to $t$ (Figure \ref{fig:convergence_controls}). At the end of the trading interval, the market maker tends to choose a control policy that will bring him close to an inventory of $0$, since the profit made by a trade hardly compensates the penalty $\ell$.

% Figure environment removed

As expected, for fixed $(t,Q)$, $\hat{q}^a(t,Q,\cdot)$ is nonincreasing and $\hat{q}^b(t,Q,\cdot)$ is nondecreasing, see Figure \ref{fig:optimal_controls}. Indeed, the profit made by selling a unit of stock decreases with $y$. Similarly, the profit made by buying a unit of stock increases with $y$. We also observe that for some values of $y$, the market maker has no interest in buying or selling: if she sells when $y > \frac{\delta}{2}$, she \enquote{loses} money from the sell. Even when $y < \frac{\delta}{2}$, the gain might not be enough to compensate for the inventory risk. Of course, when her inventory is negative, she is willing to buy more and sell less in order to bring it back close to zero, making her immune to price changes. Similar behavior arises when her inventory is positive.

% Figure environment removed

When quantities $q^a$ and $q^b$ are quoted on the ask and bid side,  respectively, we define the volume imbalance to be $\frac{q^b-q^a}{q^b + q^a}$ (undefined here when $q^a=0$ and $q^b=0$). It is a known empirical fact \parencite{huang_simulating_2015,lehalle_limit_2017,stoikov_micro-price_2018,sfendourakis_lob_2023} that volume imbalance has high predictive power for the direction of the next mid-price move: the closer it is to one, the more likely it is for the mid-price to go up. In our model, this translates to: the higher the imbalance at time $t$, the higher $Y_t$. We confirm numerically this fact in Figure \ref{fig:imbalance}. There is, however, a dependence on the inventory $Q_t$ of the market maker -- which is, in principle unknown to the external observer. This figure elucidates in a precise fashion the subtle connection between prices and volume imbalance. In particular, we can observe that the form of the price-imbalance curve depends on the chosen parameters. In some cases, given a fixed level of the inventory and ignoring the quoting bounds, the relationship is essentially affine.

% Figure environment removed

\subsection{Dependence on the parameters}

In this subsection, we study the sensitivity of the optimal controls with respect to the parameters of the model.

When the risk sensitivity $\gamma$ increases, the market maker wants her inventory to stay closer to 0 (Figure \ref{fig:different_gamma}). Indeed, she becomes more sensitive to price moves. Formally, the efficient price being Gaussian, her \enquote{utility loss} while having nonzero inventory increases in a quadratic way with $\gamma$, while the gain from a trade only increases linearly.

% Figure environment removed

The same behavior is observed when the volatility of the efficient price $\sigma$ increases (Figure \ref{fig:different_sigma}). In this situation, the price tends to move further, and it puts the market maker at risk.

% Figure environment removed

The market maker tends to post bigger quotes when the market order intensities are bigger (Figure \ref{fig:different_intensities}). When the market orders are more frequent, the market maker can tolerate having a large inventory: she knows she can liquidate it rather quickly. In addition, for high intensities of the market orders (configuration 4 in Figure \ref{fig:different_intensities}), the market maker can quote even when she \enquote{loses} money from this very trade. For example, if we concentrate on the ask side, if her inventory is 0, $Y_t=y > \frac{\delta}{2}$ and she quotes some quantity $q > 0$ to sell, she expects to lose $q\left(y-\frac{\delta}{2}\right)$ from this trade (additionally, she exposes herself to price moves). However, she expects this quantity to be bought again quickly, earning $q\left(y+\frac{\delta}{2} -\varepsilon\right)$ ($\varepsilon$ being the small efficient price move in between), making a net profit of $q\delta - \varepsilon$. 

% Figure environment removed

\section{Proof of the verification theorem}
\label{sec:verification}
In this section we prove Theorem \ref{thm:verification}.
\subsection{Proof of point (i)}

Point (i) follows from a standard measurable selection argument. Define
\begin{align*}
D^a &\defeq \left\{(t,Q,y,q^a) \in [0,T] \times \mathcal{Q}_n \times \bar{\mathcal{Y}}\times \Qa : q^a \leqslant Q + \Qmax\right\},\\
D^b &\defeq \left\{(t,Q,y,q^b) \in [0,T] \times \mathcal{Q}_n \times \bar{\mathcal{Y}}\times \Qb : q^b \leqslant -Q + \Qmax\right\}.
\end{align*}
The sets $D^a$ and  $D^b$ are closed. In addition, the functions 
\begin{align*}
    (t,Q,y,q^a) \in D^a &\mapsto \int_{\Qa}e^{-\gamma (q^a \wedge z)\left(\frac{\delta}{2}-y\right)}u^{Q-q^a \wedge z}\left(t,y\right) \mu^a(\diff z),\\
    (t,Q,y,q^b) \in D^b &\mapsto \int_{\Qb}e^{-\gamma (q^b \wedge z)\left(\frac{\delta}{2}+y\right)}u^{Q+q^b \wedge z}\left(t,y\right) \mu^b(\diff z).
\end{align*}
are continuous.
Hence, by \parencite[Proposition 7.33]{bertsekas_stochastic_1996}, there exist two measurable nonnegative functions $\hat{q}^a$ and $\hat{q}^b$ on $[0,T] \times \mathcal{Q}_n \times \bar{\mathcal{Y}}$ such that for all $(t,Q,y) \in [0,T] \times \mathcal{Q}_n \times \bar{\mathcal{Y}}$, $\hat{q}^a(t,Q,y) \leqslant Q + \Qmax$, $\hat{q}^b(t,Q,y) \leqslant -Q + \Qmax$, and
\begin{align*}
    H^a\left(\left(u^R(t,y)\right)_{R \in \mathcal{Q}_n}, y, Q\right) & = \int_{\Qa}e^{-\gamma (\hat{q}^a(t,Q,y) \wedge z)\left(\frac{\delta}{2}-y\right)}u^{Q-\hat{q}^a(t,Q,y) \wedge z}\left(t,y\right) \mu^a(\diff z)\\
    H^b\left(\left(u^R(t,y)\right)_{R \in \mathcal{Q}_n}, y, Q\right) & = \int_{\Qb}e^{-\gamma (\hat{q}^b(t,Q,y) \wedge z)\left(\frac{\delta}{2}+y\right)}u^{Q+\hat{q}^b(t,Q,y) \wedge z}\left(t,y\right) \mu^b(\diff z).
\end{align*}

\subsection{Proof of point (ii)}

Let $(t_i)_{1 \leqslant i \leqslant N}$ be the ordered jump times of $N^a$ and $N^b$ on $[t,T]$ (which are almost surely distinct and different from $t$ and $T$), $(z_i)_{1 \leqslant i \leqslant N}$ the associated marks and $((e_i, s_i))_{1 \leqslant i \leqslant N}$ the random variable that takes the value $(-1,a)$ if the index is associated to a jump of $N^a$ and $(1,b)$ for a jump of $N^b$. For convenience, we set $t_0 = -1$, $t_{N+1} = T$, $z_0=z_{N+1} = 0$, $e_0=e_{N+1} = 0$. Define $Q_0 \defeq Q$ and, recursively, $Q_{i+1} \defeq Q_i + e_{i+1}z_{i+1}\wedge\hat{q}^{s_i}(t_{i+1}, Q_i, \Y_{t_{i+1}})$, which is $\mathcal{F}_{t_{i+1}}$-measurable (by definition of $\hat{q}^{s_i}$, it is valued in $\mathcal{Q}_n$). For $s \in [0,T]$, define
\begin{equation*}
    q^{*a}_s \defeq \sum_{i=0}^N \mathds{1}_{\{t_i < s \leqslant t_{i+1}\}} \hat{q}^a(s \vee t, Q_i, \Y_s) \text{ and } q^{*b}_s \defeq \sum_{i=0}^N \mathds{1}_{\{t_i < s \leqslant t_{i+1}\}} \hat{q}^b(s \vee t, Q_i, \Y_s).
\end{equation*}
The process $q^* = (q^{a*}, q^{*b})$ is in $\mathcal{A}^{t,Q}$. It is easy to check that for $s \in [t_i,t_{i+1})$, $Q^{t,Q,q^*}_s = Q_i$. This proves the existence part. 


We prove uniqueness by induction. We fix $\omega \in \Omega$ (omitting the dependence on $\omega$ for concision) such that the $(t_i)_{1 \leqslant i \leqslant N}$ are distinct and different from $t$ and $T$.
Let $q \in \mathcal{A}^{t,Q}$ be a control verifying \eqref{eq:existence_control} on $\omega$. Since $\Q$ is constant on $[0, t_1)$ and equal to $Q$, $q=q^{*}$ on $[0,t_1]$ by \eqref{eq:existence_control}. Suppose that $q = q^{*}$ on $[0,t_i]$ and $\Q = Q^{t,Q,q^*}$ on $[0, t_i)$, $i \leqslant N$. Since $q_{t_i} = q^*_{t_i}$, we have $\Q_{t_i} = Q^{t,Q,q^*}_{t_i}$. As before, this implies that $Q^{t,Q,q}= Q^{t,Q,q^*}$ on $[t_i, t_{i+1})$, which yields $q = q^{*}$ on $(t_i,t_{i+1}]$ thanks to \eqref{eq:existence_control}.

\subsection{A useful lemma}

To prove the verification theorem we need the following lemma. As a byproduct, we get the finiteness of the value function $U$.

\begin{lemma}
    \label{lem:uniform_maj_pnl}
    There exists a nonnegative random variable $M$ such that
    \begin{equation*} 
        e^{-\gamma \PnL_s} \leqslant M\quad\text{and}\quad \E[t,y][M^k] < \infty 
    \end{equation*}
    for all $(t,s,Q,y) \in [0,T] \times [0,T] \times \mathcal{Q}_n \times \mathcal{Y}$ and for all $k \geqslant 0$.
\end{lemma}

\begin{proof}
    Let $(t,s,Q,y) \in [0,T] \times [0,T] \times \mathcal{Q}_n \times \mathcal{Y}$. We have
    \begin{equation*}
        e^{-\gamma \PnL_s} \leqslant \exp\left(\gamma\delta\eta N_T + \gamma\sigma \left|\int_t^{t \vee s} \Q_r \diff W_r \right|\right)
    \end{equation*}
    where $N \defeq N^a(\cdot \times \Qa) + N^b(\cdot \times \Qb)$.

    Let $t_0< t_1 < \dots$ be the jump times of $N$ with $t_0 = 0$ and $t_i = T$ after the last jump. The process $\Q$ remains constant in each interval $[t_i, t_{i+1})$, hence we can write
    \begin{equation*}
        \int_{t}^{s \vee t} \Q_u \diff W_u = \sum_{i = 0}^{\infty}\Q_{t_{i}\vee t} \left( W_{\left(t_{i+1} \wedge s\right)\vee t} - W_{\left(t_i \wedge s \right) \vee t }\right).
    \end{equation*}
   This sum is well-defined (almost surely) because $N_T < \infty$ and therefore only a finite number of terms are non-zero. 
    
    Suppose that $s \geqslant t$ and fix $\omega \in \Omega$. There exist two integers $i_0$ and $i_1$ such that $t \in [t_{i_0}(\omega), t_{i_0+1}(\omega))$ and $s \in [t_{i_1}(\omega), t_{i_1 +1}(\omega))$. Hence,
    \begin{equation*}
        \left(\int_{t}^{s\vee t} \Q_u \diff W_u\right)(\omega) =
        Q \left( W_{t_{i_0+1}} - W_{t}\right)(\omega)
        + \Q_s \left( W_{s} - W_{t_{i_1}}\right)(\omega)
        +\sum_{i = i_0+1}^{i_1-1}\Q_{t_{i}} \left( W_{t_{i+1}} - W_{t_i}\right)(\omega).
    \end{equation*}

    Thus, 
    \begin{equation*}
        \left|\int_{t}^{s \vee t} \Q_u \diff W_u \right|
        \leqslant
        4 \Qmax \sup_{u \in [0,T]} \left|W_u \right|
        + \Qmax
        \sum_{i = 0}^{\infty} \left| W_{t_{i+1}} - W_{t_i}\right|
    \end{equation*}
    and the inequality is trivially verified if $s < t$. Define
    \begin{equation*}
        M \defeq \exp\left(\gamma\delta\eta N_T +  4 \gamma \sigma\Qmax \sup_{u \in [0,T]} \left|W_u \right|
        + \gamma\sigma\Qmax
        \sum_{i = 0}^{\infty} \left| W_{t_{i+1}} - W_{t_i}\right|\right).
    \end{equation*}
    The random variable $M$ does not depend on $(t,s,y,Q)$ and
    \begin{equation*} 
        e^{-\gamma \PnL_s} \leqslant M,\quad (t,s,Q,y) \in [0,T] \times [0,T] \times \mathcal{Q}_n \times \mathcal{Y}.
    \end{equation*}
    Let $k \geqslant 0$ and $(t,y) \in [0,T] \times \mathcal{Y}$. By the three factor Cauchy-Schwarz inequality,
    \begin{equation*}
        \begin{split}
            \E[t,y][M^k] \leqslant \mathbb{E}^{t,y}&\left[\exp\left(3k \gamma \delta\eta N_T\right)\right]^{\frac{1}{3}} \times
            \mathbb{E}^{t,y}\left[\exp\left(12k \gamma\sigma \Qmax \sup_{u \in [0,T]} \left|W_u \right|\right)\right]^{\frac{1}{3}} \\
            &\times \mathbb{E}^{t,y}\left[\exp\left(3k \gamma \sigma \Qmax \sum_{i = 0}^{\infty} \left| W_{t_{i+1}} - W_{t_i}\right|\right)\right]^{\frac{1}{3}}.
        \end{split}
    \end{equation*}
    It is easy to see that the first two factors are finite. For the first factor, it suffices to go back to the probability $\Proba$ and use the fact that $N_T$ is a Poisson random variable under $\Proba$. For the second factor, one can use the reflection principle for Brownian motion.

    We now show that the third factor is also finite. Define $A \defeq 6 k \gamma \sigma \Qmax$. A change of probability measure and the Cauchy-Schwarz inequality yield
    \begin{align*}
        \E[t,y][\exp\left(\frac{A}{2} \sum_{i=0}^{\infty}\left|W_{t_{i+1}} - W_{t_i}\right|\right)]
        & \leqslant e^{2T}\E[][e^{\ln(\Lambda^*)N_T}\exp\left(\frac{A}{2} \sum_{i=0}^{\infty}\left|W_{t_{i+1}} - W_{t_i}\right|\right)] \\
        & \leqslant e^{2T}\E[][e^{2\ln(\Lambda^*)N_T}]^{\frac{1}{2}}\E[][\exp\left(A \sum_{i=0}^{\infty}\left|W_{t_{i+1}} - W_{t_i}\right|\right)]^{\frac{1}{2}}. 
    \end{align*}
    The first two factors of the last expression are finite, hence we only have to prove that it is also the case for the third one. We have
    \begin{align*}
        \E[][\exp\left(A \sum_{i=0}^{\infty}\left|W_{t_{i+1}} - W_{t_i}\right|\right)]
        & \leqslant \sum_{n = 0}^{\infty} \E[][\mathds{1}_{\{N_T = n\}}
        \exp\left(A \sum_{i=0}^{n}\left|W_{t_{i+1}} - W_{t_i}\right|\right)]
        \\
        & \leqslant \sum_{n = 0}^{\infty} \E[][\mathds{1}_{\{N_T = n\}}
        \prod_{i=0}^n\exp\left(A \left|W_{t_{i+1}} - W_{t_i}\right|\right)].
    \end{align*}
Since the time $t_i$ is $\sigma(N^a, N^b)$-measurable, the factors are independent conditionally on $(N^a, N^b)$. Hence,
\begin{equation}\label{lem5:1}
    \E[][\exp\left(A \sum_{i=0}^{\infty}\left|W_{t_{i+1}} - W_{t_i}\right|\right)]
         \leqslant \sum_{n = 0}^{\infty} \mathbb{E}\left[\mathds{1}_{\{N_T = n\}}
        \prod_{i=0}^n \mathbb{E} \left[ \exp\left(A \left|W_{t_{i+1}} - W_{t_i}\right|\right)|N^a,N^b\right]\right].
\end{equation}
For fixed $0 \leqslant s \leqslant t \leqslant T$,
\begin{equation}\label{lem5:2}
    \E[][\exp(A |W_t-W_s|)] = 2 \exp\left(\frac{A^2}{2}(t-s)\right)
    \mathcal{N}\left(A\sqrt{t-s}\right)
    \leqslant 2 \exp\left(\frac{A^2}{2}(t-s)\right)
\end{equation}
where $\mathcal{N}$ is the cumulative distribution function of the standard normal law. Recalling that $W$ is independent of $(N^a,N^b)$, combining the inequalities \eqref{lem5:1} and \eqref{lem5:2} yields
\begin{align*}
    \E[][\exp\left(A \sum_{i=0}^{\infty}\left|W_{t_{i+1}} - W_{t_i}\right|\right)]
        & \leqslant \sum_{n = 0}^{\infty} \mathbb{E}\left[\mathds{1}_{\{N_T = n\}}
        2^n \exp\left(\frac{A^2}{2}T \right)\right] \\
        & \leqslant \sum_{n = 0}^{\infty} \exp\left(\frac{A^2}{2}T \right)
        e^{- 2T} \frac{\left(4 T\right)^n}{n!} \\
        & \leqslant \exp\left(\frac{A^2}{2}T + 2T\right) < \infty.
\end{align*}
\end{proof}

\subsection{Proof of points (iii) and (iv)}

Let $(t,y,Q) \in [0,T) \times \mathcal{Y} \times \mathcal{Q}_n$ and $q \in \mathcal{A}^{t,Q}$. We denote by $t_1< \dots < t_{N^{ab}_T}$ the jump times of $N^{ab} \defeq N^a(\cdot \times \Qa) + N^b(\cdot \times \Qb)$. We denote by $\tau_1 <\dots <\tau_{N-1}$ the jump times of $\Y$ ($N$ is a random variable), and define $\tau_0= t$, $\tau_N = T$. Since the $t_i$'s are totally inaccessible and the $\tau_i$'s are predictable (they are the limit of $(\tau_i^{(k)})_k$ defined in \eqref{eq:tauui_predictable} below), we have almost surely
\begin{equation}\label{eq:disjoint_jumps}
    \{t_i: i \in {1\dots,N^{ab}_T}\} \cap \{\tau_i: i \in \{1\dots,N\}\} = \emptyset.
\end{equation}

Let $k_0 \in \mathbb{N}^*$ be such that $\min\{2\delta \eta, y + \bar{y}, \bar{y} - y\} < \frac{1}{k_0}$. Fix $k \geqslant k_0$ and define for $i \leqslant N-1$,
\begin{equation}\label{eq:tauui_predictable}
    \tau_i^{(k)} \defeq \inf\left\{s \in (\tau_i, \tau_{i+1}) : \Y_s \in\left\{-\bar{y} + \frac{1}{k}, \bar{y} - \frac{1}{k}\right\}\right\}\wedge\left(T - \frac{1}{k}\right).
\end{equation}
By the intermediate value theorem, we have that for all $k \geqslant k_0$ and $i\leqslant N-1$, $\tau_i \leqslant \tau_i^{(k)} \leqslant \tau_{i+1}$. Also, for all $s \in [\tau_i, \tau_{i}^{(k)}]$, $(s,\Y_s) \in \left[0, T - \frac{1}{k}\right] \times \left[-\bar{y} + \frac{1}{k}, \bar{y} - \frac{1}{k}\right]$. Furthermore, for each $i$, $(\tau_i^{(k)})_{k \geqslant k_0}$ is nondecreasing. One can show that for all $i \leqslant N-1$,
\begin{equation*}
    \tau_i^{(k)} \xrightarrow[k \to \infty]{} \tau_{i+1}.
\end{equation*}

Fix $k \geqslant k_0$ and define $A  \defeq - e^{-\gamma \left(\PnL_T - \ell\left(\Q_T\right)\right)} - u^Q(t,y)$. Then,
\begin{equation*}
    \begin{split}
     A =
    \sum_{i=0}^{N-1}& \left(e^{-\gamma \PnL_{\tau^{(k)}_i}}u^{\Q_{\tau^{(k)}_i}}\left(\tau^{(k)}_{i}, \Y_{\tau^{(k)}_{i}}\right) -  e^{-\gamma\PnL_{\tau_i}}u^{\Q_{\tau_i}}(\tau_i, \Y_{\tau_i})\right) \\
    &+
    \sum_{i=0}^{N-1} \left( e^{-\gamma\PnL_{\tau_{i+1}}}u^{\Q_{\tau_{i+1}}}\left(\tau_{i+1}, \Y_{\tau_{i+1}}\right) - e^{-\gamma \PnL_{\tau^{(k)}_i}}u^{\Q_{\tau^{(k)}_i}}\left(\tau^{(k)}_{i}, \Y_{\tau^{(k)}_{i}}\right)\right).
    \end{split}
\end{equation*}
Using Itô's formula with jumps on each interval $[\tau_i, \tau_i^{(k)}]$ (on which $\Y_s- \Y_{\tau_i} = \sigma\left(W_s - W_{\tau_i}\right)$), we get
\begin{equation}\label{eq:proofverification1}
    \begin{split}
        A = 
        &\sum_{i=0}^{N-1} \left( e^{-\gamma\PnL_{\tau_{i+1}}}u^{\Q_{\tau_{i+1}}}\left(\tau_{i+1}, \Y_{\tau_{i+1}}\right) - e^{-\gamma \PnL_{\tau^{(k)}_i}}u^{\Q_{\tau^{(k)}_i}}\left(\tau^{(k)}_{i}, \Y_{\tau^{(k)}_{i}}\right)\right)\\
        &+\sum_{i=0}^{N-1}
        \int_{\tau_i}^{\tau_i^{(k)}} e^{-\gamma \PnL_r} \left(\partial_t u^{\Q_r}(r, \Y_r) + \frac{\sigma^2}{2} \partial^2_{yy} u^{\Q_r}(r, \Y_r) \right)\diff r\\
        &+\sum_{i=0}^{N-1}
        \sigma\int_{\tau_i}^{\tau_i^{(k)}} e^{-\gamma \PnL_r}\partial_y u^{\Q_r}(r, \Y_r) \diff W_r \\
        &+\sum_{i=0}^{N-1}
        \frac{1}{2}\int_{\tau_i}^{\tau_i^{(k)}} \gamma^2 \sigma^2 \left(\Q_r\right)^2 e^{-\gamma \PnL_r} u^{\Q_r}(r, \Y_r) \diff r \\
        &-\sum_{i=0}^{N-1}
        \int_{\tau_i}^{\tau_i^{(k)}} \gamma \sigma^2 \Q_r e^{-\gamma \PnL_r} \partial_y u^{\Q_r}(r, \Y_r) \diff r \\
        &-\sum_{i=0}^{N-1}\int_{\tau_i}^{\tau_i^{(k)}} \gamma \sigma \Q_r e^{-\gamma \PnL_r} u^{\Q_r}(r, \Y_r) \diff W_r\\
        &+ \sum_{i=0}^{N-1}
        \int_{(\tau_i,\tau_i^{(k)}] \times \Qa} e^{-\gamma \PnL_{r-}}\left[e^{\gamma (q^{a}_r \wedge z) \left(\frac{\delta}{2} - Y^{t,y}_r\right)}u^{\Q_{r-} - (q^{a}_r \wedge z)}(r, \Y_r) - u^{\Q_{r-}}(r, \Y_r)\right] N^a(\diff u, \diff z) \\
        &+ \sum_{i=0}^{N-1}
        \int_{(\tau_i,\tau_i^{(k)}] \times \Qb} e^{-\gamma \PnL_{r-}}\left[e^{\gamma (q^{b}_r \wedge z)\left(\frac{\delta}{2} + Y^{t,y}_r\right)}u^{\Q_{r-} + (q^{b}_r \wedge z)}(r, \Y_r) - u^{\Q_{r-}}(r, \Y_r)\right] N^b(\diff u, \diff z).
        \end{split}
\end{equation}

The integrals in $\diff W$ have zero expectation (under $\mathbb{P}^{t,y}$). Indeed, since $\sup_{R \in \mathcal{Q}_n}|u^R|_{2+\beta} < \infty$, $u^Q$ and $\partial_y u^Q$ are bounded in the compact set $\left[0,T-\frac{1}{k}\right] \times \left[-\bar{y} + \frac{1}{k}, \bar{y}-\frac{1}{k}\right]$, uniformly in $Q \in \mathcal{Q}_n$, by some constant $m > 0$. Then, letting $M$ be the random variable given by Lemma \ref{lem:uniform_maj_pnl},
\begin{align*}
    & \mathbb{E}^{t,y}\left[\int_0^T \left(\sum_{i=0}^{N-1}\mathds{1}_{\left[\tau_i,\tau_i^{(k)}\right]}(r) e^{-\gamma \PnL_r}\partial_y u^{\Q_r}(r, \Y_r)\right)^2 \diff r\right]
    \leqslant Tm^2\E[t,y][M^2] < \infty,\\
    & \mathbb{E}^{t,y}\left[\int_0^T \left(\sum_{i=0}^{N-1}\mathds{1}_{\left[\tau_i,\tau_i^{(k)}\right]}(r)\gamma\sigma\Q_r e^{-\gamma \PnL_r}u^{\Q_r}(r, \Y_r)\right)^2 \diff r\right]
    \leqslant \gamma^2\sigma^2\Qmax^2 Tm^2\E[t,y][M^2] < \infty.
\end{align*}

Taking expectation in \eqref{eq:proofverification1}, and using the fact that $(u^Q)_{Q \in \mathcal{Q}_n}$ solves \eqref{eq:HJB_interior}, yields
\begin{equation}\label{eq:proofverification2}
    \begin{split}
        J(t,Q,&y,q) - u^Q(t,y)\\
        & = \E[t,y][\sum_{i=0}^{N-1} \left( e^{-\gamma\PnL_{\tau_{i+1}}}u^{\Q_{\tau_{i+1}}}\left(\tau_{i+1}, \Y_{\tau_{i+1}}\right) - e^{-\gamma \PnL_{\tau^{(k)}_i}}u^{\Q_{\tau^{(k)}_i}}\left(\tau^{(k)}_{i}, \Y_{\tau^{(k)}_{i}}\right)\right)] \\
        & + \mathbb{E}^{t,y}\left[\sum_{i=0}^{N-1}
        \int_{\tau_i}^{\tau_i^{(k)}} \int_{\Qa} e^{-\gamma \PnL_{r-}}\left[e^{\gamma (q^{a}_r \wedge z) \left(\frac{\delta}{2} - Y^{t,y}_r\right)}u^{\Q_{r-} - (q^{a}_r \wedge z)}(r, \Y_r) \right] \Lambda^a(\Y_r) \mu^a(\diff z) \diff r\right] \\
        & + \mathbb{E}^{t,y}\left[\sum_{i=0}^{N-1}
        \int_{\tau_i}^{\tau_i^{(k)}} \int_{\Qb} e^{-\gamma \PnL_{r-}}\left[e^{\gamma (q^{b}_r \wedge z) \left(\frac{\delta}{2} + Y^{t,y}_r\right)}u^{\Q_{r-} + (q^{b}_r \wedge z)}(r, \Y_r) \right] \Lambda^b(\Y_r)\mu^b(\diff z)\diff r\right] \\
        & -\mathbb{E}^{t,y}\left[
            \sum_{i=0}^{N-1}
            \int_{\tau_i}^{\tau_i^{(k)}}
            e^{-\gamma \PnL_{r}} H^a\left(\left(u^R\right)_{R \in \mathcal{Q}_n}, \Q_r, \Y_r\right)\Lambda^a(\Y_r)\diff r
        \right] \\
        & - \mathbb{E}^{t,y}\left[
            \sum_{i=0}^{N-1}
            \int_{\tau_i}^{\tau_i^{(k)}}
            e^{-\gamma \PnL_{r}}H^b\left(\left(u^R\right)_{R \in \mathcal{Q}_n}, \Q_r, \Y_r\right)\Lambda^b(\Y_r)\diff r
        \right].
    \end{split}
\end{equation}

The term inside the expectation in the first term is bounded by $2\sup\limits_{R \in \mathcal{Q}_n}|u^{R}|_{\infty}N M$. The Cauchy-Schwarz inequality and Lemma \ref{lem:finite_activity_expectation} imply that
\begin{equation*}
    \E[t,y][2\sup\limits_{R \in \mathcal{Q}_n}|u^{R}|_{\infty}N M] \leqslant
    2\sup\limits_{R \in \mathcal{Q}_n}|u^{R}|_{\infty} \sqrt{\E[t,y][N^2]} \sqrt{\E[t,y][M^2]} < \infty.
\end{equation*} 
Thus, we can use the dominated converge theorem in the first expectation. By \eqref{eq:disjoint_jumps}, almost surely, for all $i$, $\PnL_{\tau_i^{(k)}} \xrightarrow[k \to \infty]{} \PnL_{\tau_{i+1}}$ and $\Q_{\tau_i^{(k)}} \xrightarrow[k \to \infty]{} \Q_{\tau_{i+1}}$. Combined with the continuity conditions \eqref{eq:HJB_border}, we conclude that the first term tends to 0 when $k \to \infty$.

The four other expectations in \eqref{eq:proofverification2} have integrands bounded by $\Lambda^* M e^{\gamma (\qa \vee \qb) \delta (1+\eta)} \sup_{R \in \mathcal{Q}_n}|u^{R}|_{\infty}$ which has finite expectation, therefore we can again use the dominated convergence theorem to obtain
\begin{equation}\label{eq:proofverification3}
    \begin{split}
        J(t,Q,y,q) &- u^Q(t,y)=\\
        &\mathbb{E}^{t,y}\left[
        \int_{t}^{T} \int_{\Qa} e^{-\gamma \PnL_{r}}\left[e^{\gamma (q^{a}_r \wedge z) \left(\frac{\delta}{2} - Y^{t,y}_r\right)}u^{\Q_{r} - (q^{a}_r \wedge z)}(r, \Y_r) \right] \Lambda^a(\Y_r) \mu^a(\diff z) \diff r\right] \\
        & + \mathbb{E}^{t,y}\left[
        \int_{t}^{T} \int_{\Qb} e^{-\gamma \PnL_{r}}\left[e^{\gamma (q^{b}_r \wedge z) \left(\frac{\delta}{2} + Y^{t,y}_r\right)}u^{\Q_{r} + (q^{b}_r \wedge z)}(r, \Y_r) \right] \Lambda^b(\Y_r)\mu^b(\diff z)\diff r\right] \\
        & -\mathbb{E}^{t,y}\left[
            \int_{t}^{T}
            e^{-\gamma \PnL_{r}} H^a\left(\left(u^R\right)_{R \in \mathcal{Q}_n}, \Q_r, \Y_r\right)\Lambda^a(\Y_r)\diff r
        \right] \\
        & - \mathbb{E}^{t,y}\left[
            \int_{t}^{T}
            e^{-\gamma \PnL_{r}}H^b\left(\left(u^R\right)_{R \in \mathcal{Q}_n}, \Q_r, \Y_r\right)\Lambda^b(\Y_r)\diff r
        \right].
    \end{split}
\end{equation}
Hence, by the definition of the Hamiltonians, $J(t,Q,y,q) \leqslant u^Q(t,y)$ and $U(t,Q,y) \leqslant u^{Q}(t,y)$. Furthermore, with $q = q^*$, $u^Q(t,y) = J(t,Q,y,q^*)$ and point (iii) follows. Point (iv) is also a direct consequence of equation \eqref{eq:proofverification3} since $\Lambda^a, \Lambda^b >0$.

\section{Existence of a solution to the Hamilton-Jacobi-Bellman equation}
\label{sec:hjb}
\begin{dummyenv}
\renewcommand{\Q}{\mathcal{Q}_n}
\renewcommand{\Y}{\mathcal{Y}}

This section is devoted to the proof of Theorem \ref{thm:existence}(i), namely the existence of a classical solution of the HJB equation \eqref{eq:HJB_interior} with boundary conditions \eqref{eq:HJB_border}. The proof of Theorem \ref{thm:existence}(ii) is postponed to Appendix \ref{sec:convergence_discrete_continuous}. For this section, we define $\D \defeq C([0,T] \times \bar{\Y}) \cap C^{1,2}((0,T] \times \mathcal{Y})$ and let $n \in \mathbb{N}^* \cup \{\infty\}$.

We now fix some constants for the whole section. Let $\qmax \defeq \max\{\qa, \qb\}$. For $\beta \leqslant \alpha$, define $\Lambda_{\beta}^* \defeq \max\left\{|\Lambda^a|_{\beta},  |\Lambda^b|_{\beta}\right\}$. Let $K_0 \defeq \max \left\{\frac{\sigma^2}{2}, \frac{2}{\sigma^2}, \sigma^2 \gamma \Qmax,\frac{\sigma^2 \gamma^2 \Qmax^2}{2} + 2 \Lambda^*\right\}$, and $C_0 > 0$ and $\beta_0 \in (0,1)$ be constants given by 
Corollary \ref{corol:krylovsafonov} (Krylov-Safonov) for coefficients bounded by $K_0$ and coefficient in front of $\partial^2_{yy}$ greater than $K_0^{-1}$. We fix $\beta \defeq \alpha \wedge \beta_0$, and let $K_1 \defeq \max\{1, T, \bar{y}, \bar{y}^2\} \cdot \max\left\{\frac{\sigma^2}{2}, \sigma^2 \gamma \Qmax,\frac{\sigma^2 \gamma^2 \Qmax}{2} + 2 \Lambda^* + 2 \Lambda^*_{\beta}\right\}$ and $C_1 > 0$ be a constant given by Corollary \ref{corol:linear_existence} with $a = -\bar{y}$, $b = \bar{y}$, $a_0 = y_-$, $b_0 = y_+$, $\delta = \beta$, $\rho_1=\rho_2 = 1$, $ \alpha \equiv \frac{\sigma^2}{2}$.

We denote by $\ell^*$ the maximum of $\ell$. If $n = \infty$, let $\varpi$ be a subadditive and finite modulus of continuity of $\ell$. We suppose that for $\Delta \in [0, \infty)$, $\varpi(\Delta) \geqslant \Delta$, otherwise we can replace $\varpi(\Delta)$ by $\max\{\Delta, \varpi(\Delta)\}$.

In Subsection \ref{subsec:discrete_case}, we show using a contraction argument the existence of a uniformly bounded family of functions $(u_Q)_{Q \in \Q}$ in $\D$ verifying \eqref{eq:HJB_interior}-\eqref{eq:HJB_border} if $n < \infty$ or $\mu^a$ and $\mu^b$ have finite support. This way, there is no measurability issue with the definition of the Hamiltonians. We also show that there exists a constant $C$, depending on $T, \Qmax, \bar{y}, \sigma, \gamma, \Lambda^*, \beta, \Lambda_{\beta}, \ell^*$ but not on $n$, $\mu^a$ or $\mu^b$ such that $\sup_{Q \in \Q} |u^Q|_{2+\beta} \leqslant C$.

In Subsection \ref{subsec:continuity}, we show that, for $n=\infty$ and $\mu^a$, $\mu^b$ having finite support, any family of functions $(u_Q)_{Q \in \mathcal{Q}_{\infty}}$ in $\D$ verifying \eqref{eq:HJB_interior}-\eqref{eq:HJB_border} with $\sup_{Q \in \mathcal{Q}_{\infty}}|u_n|_{\beta} < \infty$ is necessarily continuous on $[0,T] \times \mathcal{Q}_{\infty} \times \bar{\Y}$.

In Subsection \ref{subsec:existence_general_case}, we show, for $n=\infty$ and any $\mu^a$, $\mu^b$, the existence of a solution of \eqref{eq:HJB_interior}-\eqref{eq:HJB_border}, as a limit of solutions associated to finitely supported measures.


\subsection{Discrete case}
\label{subsec:discrete_case}

We suppose that $n < \infty$ or $\mu^a$ and $\mu^b$ have finite support. We build a sequence of solutions to an iterated linear problem. We then show that it converges uniformly towards some family of continuous functions $(u^Q)_{Q \in \Q}$. Finally, we derive the regularity of $(u^Q)_{Q \in \Q}$ and show that it is a solution of \eqref{eq:HJB_interior}-\eqref{eq:HJB_border}.

\subsubsection{Construction of a sequence of solutions to an iterated linear problem}

For all $(t,y,Q) \in [0,T] \times \bar{\Y} \times \Q$, we define $u^Q_0(t,y) \defeq -e^{\gamma \ell(Q)}$. Let $k \in \mathbb{N}$ and suppose we have built a family $(u_k^Q)_{Q \in \Q}$ in $\D$ such that $\sup_{Q \in \Q}|u^Q_k|_{2+\beta} < \infty$.

Let $Q \in \Q$. For $(t,y) \in [0,T) \times \Y$, define
\begin{equation}
    \label{eq:definition_fk}
    f^Q_k(t,y) \defeq \Lambda^a(t,y)H^a\left((u^Q_k(t,y))_{Q\in\Q}, Q, y, \mu^a\right) + \Lambda^b(t,y)H^b\left((u^Q_k(t,y))_{Q\in\Q}, Q, y, \mu^b\right).
\end{equation}
For $(P, P') \in ([0,T) \times \Y)^2$
\begin{equation*}
    \sup_{R \in \Q} \left|u^R_k(P) - u^R_k(P')\right| \leqslant \frac{d(P,P')}{d_{PP'}^{\beta}}\sup_{R \in \Q} |u^R_k|_{\beta} < \infty.
\end{equation*}
Hence, by Lemmas \ref{lem:H_ineq_ty} and \ref{lem:H_ineq_w}, $|f_k^Q|_{\beta} \leqslant C \sup_{R \in \Q}|u^R_k|_{\beta} < \infty$ for some constant $C$ depending only on $T$, $\gamma$, $\delta$, $\eta$, $\Qmax$, $\Lambda^*$, $\Lambda^*_{\beta}$. Hence, by Corollary \ref{corol:linear_existence}, there exists a unique function $u_{k+1}^Q \in \D$ solving, for $(t,y) \in [0,T) \times \Y$,
\begin{equation}
    \label{eq:hjb_iter}
    0 = \partial_t u^Q_{k+1}(t,y) + \frac{\sigma^2}{2}\partial^2_{yy} u^Q_{k+1}(t,y)
        -\sigma^2 \gamma Q \partial_y u^Q_{k+1}(t,y) + \left(\frac{\sigma^2 \gamma^2 Q^2}{2}- \left(\Lambda^a + \Lambda^b\right)(y)\right)u^Q_{k+1}(t,y)+
            f^Q_k(t,y)
\end{equation}
and for $(t,y) \in [0,T] \times \bar{\Y}$,
\begin{equation*}
    \left\{
        \begin{array}{ll}
            u_{k+1}^Q(T, y) &=-e^{\gamma\ell(Q)} \\
            u_{k+1}^Q\left(t, \bar{y}\right) &= u_{k+1}^Q\left(t, y_+\right) \\
            u_{k+1}^Q\left(t, -\bar{y}\right) &= u_{k+1}^Q\left(t, y_-\right).
        \end{array}
    \right.
\end{equation*}
Furthermore,
\begin{equation}
    \label{eq:maj_holder_norm_uk}
    |u^Q_{k+1}|_{2+\beta} \leqslant C_1(e^{\gamma \ell^*} + |f_k^Q|_{\beta}) \leqslant C_1 \left(e^{\gamma \ell^*} + C\sup_{R \in \Q}|u^R_{k}|_{\beta}\right) < \infty.
\end{equation}

The construction follows iteratively.

\subsubsection{Convergence of the sequence}

We have that, for $k\geqslant 1$ and $Q\in\Q$, $v \defeq u^Q_{k+1} - u^{Q}_k$ solves 
\begin{equation*}
    \begin{aligned}
        0 =& \left(\partial_t v + \frac{\sigma^2}{2}\partial^2_{yy} v
        -\sigma^2 \gamma Q \partial_y v + \left(\frac{\sigma^2 \gamma^2 Q^2}{2}- \left(\Lambda^a + \Lambda^b\right)(y)\right)v+
            f^Q_k - f^Q_{k-1}\right)(t,y)
    \end{aligned}
\end{equation*}
with boundary conditions
\begin{equation*}
    \left\{
        \begin{array}{ll}
            v(T, y) &=0 \\
            v\left(t, \bar{y}\right) &= v\left(t, y_+\right) \\
            v\left(t, -\bar{y}\right) &= v\left(t, y_-\right).
        \end{array}
    \right.
\end{equation*}

By Lemma \ref{lem:H_ineq_w}, there exists a constant $C$ depending only on $\gamma$, $\delta$, $\eta$, $\Qmax$, $\Lambda^*$ such that for all $(t,y) \in [0,T) \times \Y$, $\left|f^Q_{k}(t,y) - f^Q_{k-1}(t,y)\right| \leqslant C \sup_{R \in \Q} \left|u^R_{k}(t,y) - u^R_{k-1}(t,y)\right|$. Define
\begin{equation}
    \label{eq:g_k}
    g_k(t) \defeq e^{ct} \sup_{\substack{R \in \Q \\ y \in \bar{\Y}}}\left|u^R_{k+1}(t,y) - u^R_{k}(t,y)\right|,\quad k\geqslant 0,\, t \in [0,T]
\end{equation}
where $c \defeq \frac{\sigma^2\gamma^2\Qmax^2}{2} + 2\Lambda^*$. The function $g_k$ is measurable (see Lemma \ref{lem:meas_gk}), hence, by Corollary \ref{corol:bound_on_u},
\begin{equation*}
    g_k(t) \leqslant C\int_t^T g_{k-1}(s) \diff s, \quad t \in [0,T].
\end{equation*}
By induction, we get, for all $k \in \mathbb{N}^*$ and $t \in [0,T]$,
\begin{equation*}
    g_k(t) \leqslant C^{k-1}\frac{(T-t)^{k-1}}{(k-1)!}\sup_{t' \in [0,T]}g_1(t')
    \leqslant 3C_1e^{\gamma \ell^*} C^{k-1}\frac{(T-t)^{k-1}}{(k-1)!}.
\end{equation*}.
Thus, there exists a finite constant $C' > 0$, depending only on $T$, $\Qmax$, $\gamma$, $\sigma$, $\delta$, $\eta$, $\Lambda^*$, $\ell^*$ such that
\begin{equation}\label{eq:cauchy_sum}
    \sum_{k=0}^{\infty}\sup_{R\in \Q}|u^R_{k+1} - u^R_k|_{\infty} \leqslant \sum_{k=0}^{\infty}\sup_{t \in [0,T]} g_k(t) \leqslant C' < \infty.
\end{equation}

We conclude that for $Q \in \Q$, $(u^Q_k)_{k \in \mathbb{N}}$ is a Cauchy sequence in $C([0,T] \times \bar{\Y})$, and consequently it converges (with respect to the sup norm) towards a continuous function $u^Q$. The convergence is also uniform in $Q$, i.e.
\begin{equation*}
    \sup_{Q \in \Q}|u^Q - u_k^{Q}|_{\infty} \xrightarrow[k \to \infty]{} 0.
\end{equation*}

\subsubsection{Uniform estimates of the Hölder norms of the sequence}
\label{subsubsec:uniform_majoration}

Let $k \in \mathbb{N}^*$ and $Q \in \Q$. By the Krylov-Safonov estimate in Corollary \ref{corol:krylovsafonov}, we have
\begin{equation*}
    |u_k^Q|_{\beta} \leqslant C_0 (|u_k^Q|_{\infty} + |f_{k-1}^Q|_{\infty})
    \leqslant C_0 \left(|u_k^Q|_{\infty} + 2\Lambda^*e^{\gamma \delta(\eta+1)\qmax}\sup_{R\in \Q}|u^R_{k-1}|_{\infty}\right) \leqslant C'' \sup_{l \in \mathbb{N}} \sup_{R\in \Q} |u^R_l|_{\infty}
\end{equation*}
where $C'' > 0$ is a constant depending only on $T$, $\Qmax$, $\gamma$, $\sigma$, $\delta$, $\eta$, $\Lambda^*$. From \eqref{eq:cauchy_sum}, it is immediate that
\begin{equation*}
    |u_k^Q|_{\beta} \leqslant C''(e^{\gamma \ell^*} + C').
\end{equation*}
The inequality \eqref{eq:maj_holder_norm_uk} then yields
\begin{equation*}
    \sup_{k \in \mathbb{N}} \sup_{Q \in \Q}|u^Q_k|_{2+\beta} \leqslant C''' < \infty
\end{equation*}
for some finite constant $C''' > 0$ depending on $T$, $\Qmax$, $\gamma$, $\sigma$, $\delta$, $\eta$, $\Lambda^*$, $\beta$, $\Lambda^*_{\beta}$, $\ell^*$ but not on $\mu^a$ and $\mu^b$.

\subsubsection{Regularity of the limit and existence of a solution}

Let $Q \in \mathcal{Q}_n$. Passing to the limit, we have that $u^Q$ verifies the boundary conditions \eqref{eq:HJB_border}.

Let $K$ be a compact included in $[0,T) \times \mathcal{Y}$. The sequences $\left(\partial_t u_k^Q\right)_{k \in \mathbb{N}^*}$, $\left(\partial_y u_k^Q\right)_{k \in \mathbb{N}^*}$ and $\left(\partial^2_{yy} u_k^Q\right)_{k \in \mathbb{N}^*}$ are uniformly bounded and equicontinuous functions (because they are $\beta$-Hölder continuous with uniformly bounded Hölder constant) on $K$. Hence, by the Arzelà-Ascoli theorem, there exists an increasing sequence $(n_i)_i$ such that $\left(\partial_t u_{n_i}^Q\right)_{i}$, $\left(\partial_y u_{n_i}^Q\right)_{i}$ and $\left(\partial^2_{yy} u_{n_i}^Q\right)_{i}$ converge uniformly on $K$. Since $\left(u_{n_i}^Q\right)_{i}$ converges uniformly towards $u^Q$, then $u^Q$ is $C^{1,2}$ on $K$ and $\left(\partial_t u_{n_i}^Q\right)_{i}$, $\left(\partial_y u_{n_i}^Q\right)_{i}$ and $\left(\partial^2_{yy} u_{n_i}^Q\right)_{i}$ converge towards $\partial_t u^Q$, $\partial_y u^Q$ and $\partial^2_{yy} u^Q$, respectively. In addition, $\sup\limits_{Q \in \mathcal{Q}_n}|u^Q|_{2+\beta} \leqslant C'''<\infty$.

Let $(t,y) \in K$ and define
\begin{equation}
    \label{eq:definition_f}
    f^Q(t,y) \defeq \Lambda^a(t,y)H^a\left((u^Q(t,y))_{Q\in\Q}, Q, y, \mu^a\right) + \Lambda^b(t,y)H^b\left((u^Q(t,y))_{Q\in\Q}, Q, y, \mu^b\right)
\end{equation}
By Lemma \ref{lem:H_ineq_w}, there exists a constant $C$, independent of $k$, such that
\begin{equation*}
    \left|f^Q(t,y) - f^Q_k(t,y)\right| \leqslant C \sup_{R \in \Q} |u - u_k|_{\infty}.
\end{equation*}
Since the right-hand side tends to zero as $k$ tends to infinity, then $\lim\limits_{k\to \infty} f_k^Q(t,y) = f^Q(t,y)$. Passing to the limit over $(n_i)_i$ in equation \eqref{eq:hjb_iter} shows that $u^Q(t,y)$ verifies \eqref{eq:HJB_interior}. This concludes the proof of Theorem \ref{thm:existence}(i) with the exception of the continuity with respect to $Q$ and the case with general $\mu^a$ and $\mu^b$.

\subsection{Continuity with respect to the inventory}
\label{subsec:continuity}

\renewcommand{\Q}{\mathcal{Q}_{\infty}}

In this section, we suppose $n = \infty$, and $\mu^a$, $\mu^b$ have finite support. Let $(u^Q)_{Q \in \mathcal{Q}_{\infty}}$ be a solution of \eqref{eq:HJB_interior}-\eqref{eq:HJB_border} such that $\sup_{Q \in \mathcal{Q}_{\infty}}|u^Q|_{\beta} < \infty$. Define $M \defeq \sup_{Q \in \mathcal{Q}_{\infty}}|u^Q|_{\infty}$.

The goal of this section is to prove that $(t,Q,y)\mapsto u^Q(t,y)$ is continuous. For $\Delta \geqslant 0$, $t \in [0,T]$, we define
\begin{equation}
    \label{eq:modulus_cty_Q}
    m^{\Delta}(t) \defeq \sup \left\{u^Q(t,y) - u^{Q'}(t,y): y \in \bar{\mathcal{Y}}, Q,Q' \in \mathcal{Q}_{\infty}, |Q'-Q| \leqslant \Delta\right\}.
\end{equation}
We want to show that $\sup_t m^{\Delta}(t) \xrightarrow[\Delta \to 0]{} 0$. This implies the desired result, since for a fixed $Q$, $u^Q$ is continuous. To this end, we will use Grönwall's inequality on $m^D$, which is measurable by Lemma \ref{lem:meas_md}.

For $Q \in \Q$, we define $f^Q$ as in \eqref{eq:definition_f}. Let $(\Omega, \mathcal{F}, (\mathcal{F}_t)_t, \mathbb{P})$ be a probability space supporting a Brownian motion $W$. Let $Q \in \Q$ and $(t,y)\in [0,T] \times \mathcal{Y}$. We define
\begin{equation*}
    Z \defeq \exp \left(-\sigma \gamma Q W_T - \frac{1}{2}\sigma^2 \gamma^2 Q^2 T\right) \text{ and } \tilde{W}_r \defeq W_r + \sigma \gamma Q r,\quad r \in [0,T].
\end{equation*}
By Novikov's criterion, $\frac{\diff \mathbb{Q}}{\diff \mathbb{P}} =Z$ defines a probability measure on $(\Omega, \mathcal{F}, (\mathcal{F}_t)_t)$ and, by Girsanov's theorem, $\tilde{W}$ is a Brownian motion under $\mathbb{Q}$. Hence, by Proposition \ref{prop:feynmankac},
\begin{align*}
    u^Q(t,y) &= \mathbb{E}^{\mathbb{Q}}\left[
        - e^{\gamma \ell(Q)} \beta_t^Q + \int_t^T f^Q\left(s,Y\left(t,y,s,(\sigma\tilde{W}_r - \sigma^2 \gamma Q r)_r\right)\right) \beta_s^Q \diff s \right] \\
    &= \mathbb{E}^{\mathbb{Q}}\left[
        - e^{\gamma \ell(Q)} \beta_t^Q + \int_t^T f^Q\left(s,Y\left(t,y,s,\sigma W\right)\right) \beta_s^Q \diff s \right]
\end{align*}
where
\begin{align*}
    \beta_t^Q &\defeq
    \exp\left(\int_t^T \left(\frac{\sigma^2 \gamma^2 Q^2}{2} - \left(\Lambda^a + \Lambda^b\right)\left(s,Y(t,y,s,(\sigma\tilde{W}_r - \sigma^2 \gamma Q r)_r)\right)\right)\diff s\right)\\
     & =
    \exp\left(\int_t^T \left(\frac{\sigma^2 \gamma^2 Q^2}{2} - \left(\Lambda^a + \Lambda^b\right)\left(s, Y(t,y,s,\sigma W)\right)\right)\diff s\right).
\end{align*}

We have
\begin{equation*}
    u^Q(t,y) = \E[][-e^{\gamma \ell(Q)}\beta_t^Q Z + Z \int_t^T f^Q\left(s,Y\left(t,y,s,\sigma W\right)\right) \beta_s^Q \diff s].
\end{equation*}

Let $Q' \in \mathcal{Q}_{\infty}$ and define $Z' \defeq \exp \left(-\sigma\gamma Q' W_T - \frac{1}{2}\sigma^2 \gamma^2 (Q')^2 T\right)$. By a similar argument, we have
\begin{equation*}
    u^{Q'}(t,y) = \E[][-e^{\gamma \ell(Q')}\beta_t^{Q'} Z' + Z' \int_t^T f^{Q'}\left(s,Y\left(t,y,s,\sigma W\right)\right) \beta_s^{Q'} \diff s].
\end{equation*}
Using triangular inequalities, we get
\begin{equation}\label{eq:contQ1}
    \left|u^Q(t,y) - u^{Q'}(t,y) \right|
    \leqslant A + B + C + D + E + F
\end{equation}
where
\begin{align*}
    A & = \left|e^{\gamma \ell(Q)} - e^{\gamma \ell(Q')}\right|\mathbb{E}\left[\beta^Q_t Z\right] \\
    B & = e^{\gamma \ell(Q')}\mathbb{E}\left[\left|\beta_t^Q - \beta_t^{Q'}\right|Z\right] \\
    C & = e^{\gamma \ell(Q')}\mathbb{E}\left[\beta_t^{Q'}|Z - Z'|\right] \\
    D & = \mathbb{E}\left[Z \int_t^T f^Q\left(s,Y\left(t,y,s,\sigma W\right)\right) \left|\beta^Q_s - \beta^{Q'}_s \right| \diff s \right] \\
    E & = \mathbb{E}\left[\left|Z - Z'\right| \int_t^T f^Q\left(s,Y\left(t,y,s,\sigma W\right)\right) \beta^{Q'}_s \diff s \right] \\
    F & = \mathbb{E}\left[Z' \int_t^T \left| f^Q\left(s,Y\left(t,y,s,\sigma W\right)\right) -  f^{Q'}\left(s,Y\left(t,y,s,\sigma W\right)\right) \right| \beta^{Q'}_s \diff s \right].
\end{align*}

We want to bound $A,B,C,D,E,F$ by some function of $|Q'-Q|$ and then use Grönwall's inequality. We first state some inequalities involving the $\beta$'s and $Z$'s. Let $s \in [0,T]$. Then,
\begin{align*}
    \beta^Q_s  &\leqslant e^{\frac{1}{2}\sigma^2 \gamma^2 \Qmax^2 T + 2\Lambda^* T} \leqslant K, \\
    \left|\beta^Q_s - \beta^{Q'}_s \right| & \leqslant
    \sigma^2 \gamma^2 \Qmax^3 T e^{\frac{1}{2}\sigma^2 \gamma^2 \Qmax^2 T + 2\Lambda^* T}
     \left|Q' - Q \right| \leqslant K |Q'-Q|,\\
     \mathbb{E}\left[\left|Z-Z'\right|\right]
     & \leqslant
     \mathbb{E}\left[e^{\sigma \gamma \Qmax |W_T|}|Q-Q'|\left(\sigma \gamma  |W_T| + \sigma^2 \gamma^2 T \Qmax\right)\right]
     \leqslant K |Q'-Q|
\end{align*}
where $K > 0$ is a constant only depending on the constants of the problem ($\gamma$, $\delta$, $\sigma$, $T$, $\Qmax$, $\Lambda^*$). This yields
\begin{equation}\label{eq:contQ2}
\begin{split}
    A & \leqslant K' \varpi(|Q'-Q|)\\
    B, C, D, E & \leqslant K' |Q'-Q| \leqslant K' \varpi(|Q'-Q|)
\end{split}
\end{equation}
where $K'> 0$ is a constant depending only on $\gamma$, $\delta$, $\sigma$, $\qmax$, $T$, $\ell^*$, $\Lambda^*$ and $M$.

By Lemma \ref{lem:H_ineq_Q}, there exists a constant $K'' > 0$, depending only on $\gamma$, $\delta$, $\sigma$, $T$, $\Qmax$, $\ell^*$, $\Lambda^*$ and $M$, such that
\begin{equation}\label{eq:contQ3}
    |f^{Q}(s,y') - f^{Q'}(s,y')| \leqslant K''(|Q'-Q| + m^{|Q'-Q|}(s)),\quad (s,y') \in [0,T) \times \Y.
\end{equation}
Setting $L \defeq K'' + 5 K'$, \eqref{eq:contQ1}, \eqref{eq:contQ2} and \eqref{eq:contQ3} imply
\begin{equation*}
    \left|u^Q(t,y) - u^{Q'}(t,y) \right| \leqslant L \varpi(|Q'-Q|) + L\int_t^T m^{|Q'-Q|}(s) \diff s,
\end{equation*}
and consequently
\begin{equation*}
    \ m^{\Delta}(t) \leqslant  L \varpi(\Delta) + L \int_t^T m^{\Delta}(s) \diff s,\quad t \in [0,T],\,\Delta\geqslant 0.
\end{equation*}
By Grönwall's inequality, we conclude that
\begin{equation*}
    \sup_{t\in [0,T]}m^{\Delta}(t) \leqslant L \varpi(\Delta) e^{LT} \xrightarrow[\Delta \to 0]{} 0.
\end{equation*}

\subsection{Existence in the general case}
\label{subsec:existence_general_case}

In this section, we consider the case $n = \infty$, but we no longer make any assumption on the measures $\mu^a$ and $\mu^b$. For $k \in \mathbb{N}^*$, define
\begin{align}
    \label{eq:discrete_measures}
    \begin{split}
        \mu^a_k & = \sum_{j = 0}^{2^k - 1}\delta_{\qa\frac{j}{2^k}}\mu^a\left(\left[\qa\frac{j}{2^k}, \qa\frac{j+1}{2^k}\right)\right) + \delta_{\qa}\mu^a\left(\left\{\qa\right\}\right) \\
    \mu^b_k & = \sum_{j = 0}^{2^k - 1}\delta_{\qb\frac{j}{2^k}}\mu^b\left(\left[\qb\frac{j}{2^k}, \qb\frac{j+1}{2^k}\right)\right) + \delta_{\qa}\mu^b\left(\left\{\qb\right\}\right),
    \end{split}
\end{align}
which are probability measures converging in distribution to $\mu^a$ and $\mu^b$, respectively (it is straightforward to show that their respective cumulative distribution functions converge pointwise to the one of the limit distribution).

Let $(u^Q_k)_{Q \in \Q}$ be the solution of \eqref{eq:HJB_interior}-\eqref{eq:HJB_border} constructed in Section \ref{subsec:discrete_case} with measures $\mu^a_k$ and $\mu^b_k$. In particular,
\begin{equation*}
    \sup_{k \in \mathbb{N}^*} \sup_{Q \in \Q} |u^Q_k|_{2+\beta} \leqslant C < \infty
\end{equation*}
for some $C$ depending only on $T$, $\Qmax$, $\gamma$, $\sigma$, $\delta$, $\eta$, $\Lambda^*$, $\beta$, $\Lambda^*_{\beta}$, $\ell^*$ and each function $(t,Q,y)\mapsto u_k^Q(t,y)$ is continuous, as shown in Section \ref{subsec:continuity}. For $k \in \mathbb{N}^*$ and $Q \in \Q$, define $f_k$ as in \eqref{eq:definition_fk}, using the $u_k$'s of this section and replacing $\mu^a$ by $\mu^a_k$ and $\mu^b$ by $\mu^b_k$. Then, $u_k^Q$ solves, for $(t,y) \in [0,T) \times \Y$,
\begin{equation*}
    0 = \partial_t u^Q_{k}(t,y) + \frac{\sigma^2}{2}\partial^2_{yy} u^Q_{k}(t,y)
        -\sigma^2 \gamma Q \partial_y u^Q_{k}(t,y) + \left(\frac{\sigma^2 \gamma^2 Q^2}{2}- \left(\Lambda^a + \Lambda^b\right)(y)\right)u^Q_{k}(t,y)+
            f^Q_k(t,y)
\end{equation*}
and for $(t,y) \in [0,T] \times \bar{\Y}$,
\begin{equation*}
    \left\{
        \begin{array}{ll}
            u_{k}^Q(T, y) &=-e^{\gamma\ell(Q)} \\
            u_{k}^Q\left(t, \bar{y}\right) &= u_{k}^Q\left(t, y_+\right) \\
            u_{k}^Q\left(t, -\bar{y}\right) &= u_{k}^Q\left(t, y_-\right).
        \end{array}
    \right.
\end{equation*}

From the results of Section \ref{subsec:continuity}, there exists a constant $L' > 0$ depending only on $\gamma$, $\delta$, $\sigma$, $T$, $\Qmax$, $\ell^*$, $\Lambda^*$ and $C$ such that for all $k \in \mathbb{N}^*$, $(t,y) \in [0,T] \times \Y$, $L'\varpi$ is a modulus of continuity of the function $Q \in \Q\mapsto u_{k}^Q(t,y)$. Thus, by Lemma \ref{lem:ineq_H_discrete_meas}, there exists a constant $L > 0$, depending only on $\gamma$, $\delta$, $\sigma$, $T$, $\Qmax$, $\ell^*$, $\Lambda^*$ and $C$, such that
\begin{equation*}
    \left|f_{k+1}^Q(t,y) - f_k^Q(t,y) \right|
    \leqslant L\left|u_{k+1}^Q(t,y) - u_k^Q(t,y) \right| + L\varpi\left(\frac{\qmax}{2^k}\right),\quad (t,Q,y) \in [0,T) \times \Q \times \Y,\,k \in \mathbb{N}^*.
\end{equation*}

For $k \in \mathbb{N}^*$ and $t \in [0,T]$, define $g_k(t) \defeq e^{ct}\sup_{(Q,y) \in \Q \times \Y}\left|u^Q_{k+1}(t,y) - u^Q_{k}(t,y) \right|_{\infty}$ where $c \defeq \frac{\sigma^2 \gamma^2 \Qmax^2}{2} + 2 \Lambda^*$ -- there is no measurability issue since the $u_k$'s are continuous with respect to $(t,Q,y)$ and we can take the supremum over a countable set.

Let $k \in \mathbb{N}^*$ and $Q \in \Q$. The function $v \defeq u^Q_{k+1} - u^{Q}_k$ solves 
\begin{equation*}
    \begin{aligned}
        0 =& \left(\partial_t v + \frac{\sigma^2}{2}\partial^2_{yy} v
        -\sigma^2 \gamma Q \partial_y v + \left(\frac{\sigma^2 \gamma^2 Q^2}{2}- \left(\Lambda^a + \Lambda^b\right)(y)\right)v+
            f^Q_{k+1} - f^Q_{k}\right)(t,y)
    \end{aligned}
\end{equation*}
with boundary conditions
\begin{equation*}
    \left\{
        \begin{array}{ll}
            v(T, y) &=0 \\
            v\left(t, \bar{y}\right) &= v\left(t, y_+\right) \\
            v\left(t, -\bar{y}\right) &= v\left(t, y_-\right).
        \end{array}
    \right.
\end{equation*}
Combined with Corollary \ref{corol:bound_on_u}, this yields
\begin{equation*}
     g_k(t) \leqslant LT e^{cT} \varpi\left(\frac{\qmax}{2^k}\right) + \int_t^T L g_k(s)\diff s,\quad t \in [0,T],\, k \in \mathbb{N}^* .
\end{equation*}
By Grönwall's inequality,
\begin{equation*}
    \sup_{(t,Q,y) \in [0,T] \times \Q \times \Y}\left|u^Q_{k+1}(t,y) - u^Q_{k}(t,y) \right|
    \leqslant LTe^{(L+c)T} \varpi\left(\frac{\qmax}{2^k}\right),\quad k \in \mathbb{N}^*.
\end{equation*}
By the subadditivity of $\varpi$, $\sum_{k = 1}^{\infty} \varpi\left(\frac{\qmax}{2^k}\right) \leqslant \varpi(T) < \infty$. Thus, $\sum_{k=1}^{\infty} \sup_{Q \in \Q}|u_{k+1}^Q - u_k^Q|_{\infty} < \infty$. Hence, for all $Q \in \Q$, $(u^Q_k)_k$ is a Cauchy sequence for the sup norm and it converges uniformly to a continuous function $u^Q$. Moreover, since $\sup_{Q \in \Q}|u^Q - u_k^Q|_{\infty} \to 0$, $(t,Q,y)\mapsto u^Q(t,y)$ is continuous on $[0,T] \times \Q \times \bar{\Y}$.

It is clear that $(u^Q)_{Q \in \Q}$ verifies the boundary conditions \eqref{eq:HJB_border}.

Fix $Q \in \Q$. On a fixed compact $K$ included in $[0,T) \times \Y$, $\left(\partial_t u_k^Q\right)_{k \in \mathbb{N}^*}$, $\left(\partial_y u_k^Q\right)_{k \in \mathbb{N}^*}$ and $\left(\partial^2_{yy} u_k^Q\right)_{k \in \mathbb{N}^*}$ are sequences of uniformly bounded and equicontinuous functions. Hence, by the Arzelà-Ascoli theorem, they converge uniformly on $K$ up to a subsequence. Thus, $u^Q \in \D$ and, up to a subsequence, $\partial_t u_k^Q \to \partial_t u^Q$, $\partial_y u_k^Q \to \partial_y u^Q$ and $\partial^2_{yy}u_k^Q \to \partial^2_{yy} u^Q$ uniformly on $K$.

Define $f^Q$ by \eqref{eq:definition_f}. In order to show that $(u^Q)_{Q \in \Q}$ verifies \eqref{eq:HJB_interior}, it suffices to prove that for all $Q \in \Q$ and $(t,y) \in [0,T) \times \Y$, $\lim\limits_{k\to \infty}f^Q_k(t,y) = f^Q(t,y)$. 

Defining, for $(t,Q,y) \in [0,T) \times \Q \times \Y$
\begin{equation*}
    \tilde{f}_k^Q(t,y) \defeq \Lambda^a(t,y)H^a\left((u^Q(t,y))_{Q\in\Q}, Q, y, \mu^a_k\right) + \Lambda^b(t,y)H^b\left((u^Q(t,y))_{Q\in\Q}, Q, y, \mu^b_k\right),
\end{equation*}
Lemma \ref{lem:H_ineq_w} implies that $\lim\limits_{k\to \infty}(f^Q_k(t,y) - \tilde{f}_k^Q(t,y))= 0$. Lemma \ref{lem:H_convergence_measures} shows that $\lim\limits_{k\to \infty}\tilde{f}^Q_k(t,y) = f^Q(t,y)$, which concludes the proof of Theorem \ref{thm:existence}.

\end{dummyenv}

\section{Uniqueness of the control policy}
\label{sec:uniqueness}
\begin{dummyenv}
\renewcommand{\Q}{\mathcal{Q}_{\infty}}
\renewcommand{\Y}{\mathcal{Y}}
\renewcommand{\Qa}{\mathcal{Q}^{+,a}_{\infty}}
\renewcommand{\Qb}{\mathcal{Q}^{+,b}_{\infty}}
\renewcommand{\Qi}{\mathcal{Q}^{+,i}_{\infty}}

In this section, we prove Proposition \ref{prop:log_concavity} and Theorem \ref{thm:uniqueness}.

Recall that $\mu^a$ and $\mu^b$ are two probability measures on $\Qa$ and $\Qb$, respectively, such that $\qa$ belongs to the support of $\mu^a$ and $\qb$ belongs to the support of $\mu^b$ (the purpose of this assumption is to ensure the uniqueness of the optimal control).

For a real-valued continuous function $g$ defined on a compact interval $I\subset \mathbb{R}$, we denote by $\hat{g}$ its continuous concave envelope. More precisely,
\begin{equation*}
    \hat{g}(x) = \inf\left\{h(x): h \geqslant g \text{, and } h \text{ is continuous and concave}\right\},\quad x\in I.
\end{equation*}

\begin{rem}
    The continuous concave envelope $\hat{g}$ is concave, hence lower semi-continuous. In addtion, $\hat{g}$ is upper semi-continuous being the infimum of a family of continuous functions. Thus, $\hat{g}$ is continuous.
\end{rem}

For a real-valued continuous function $g$ defined on an interval $I$, we denote, for $x < \max I$, by $g'_+(x)$ its right derivative at $x$ (which may be equal to $+\infty$ at $x = \min I$) and, for $x>\min I$, by $g'_-(x)$ its left derivative at $x$ (which may be equal to $-\infty$ at $x = \max I$).

Let $g:\Q \mapsto \mathbb{R}$ be a continuous function. We define
\begin{equation}\label{eq:defCg}
    \begin{array}{rccl}
        C_g : & \Q \times \Q \times [0,1] & \to & \mathbb{R} \\
        & (Q,Q',\lambda) & \mapsto & g\left((1-\lambda)Q + \lambda Q'\right) - (1-\lambda) g(Q) - \lambda g(Q').
    \end{array}
\end{equation}

\begin{rem}\label{rem:concave}
    The function $g$ is concave if and only if $\min C_g  = 0$. Moreover, $g$ is strictly concave if and only if for all $(Q,Q') \in \Q \times \Q$ such that $Q < Q'$, $C_g\left(Q,Q',\frac{1}{2}\right)>0$.
\end{rem}

For $k \in \mathbb{R}$, $Q \in \Q$ and a continuous function $g:\Q \mapsto \mathbb{R}$, we define the \enquote{log-Hamiltonians}
\begin{equation}\label{eq:deflogHamiltonian}
\begin{split}
    h^a(g, k, Q) &\defeq \sup_{q \in \Qa \cap [0, Q + \Qmax]}
    \int_{\Qa} -e^{-k(q \wedge z) - g(Q - q \wedge z) + g(Q)}\mu^a(\diff u), \\
    h^b(g, k, Q) &\defeq \sup_{q \in \Qb \cap [0, -Q + \Qmax]}
    \int_{\Qb} -e^{-k(q \wedge z) - g(Q + q \wedge z) + g(Q)}\mu^b(\diff u). 
\end{split}
\end{equation}


For $(t,Q,y) \in [0,T] \times \Q \times \Y$, by Theorem \ref{thm:verification}, there exists some $q^* \in \mathcal{A}^{t,Q}$ such that $U(t,Q,y) = J(t,Q,y,q^*)$, which is negative being the expectation of a negative random variable. This also holds for $y \in \bar{\Y}$ since $U(t,Q,\bar{y}) = U(t,Q,y_+)$ and $U(t,Q,-\bar{y}) = U(t,Q,y_-)$. Proposition \ref{prop:log_concavity}(i) is proven. Thus, we can define, for $(t,Q,y) \in [0,T] \times \Q \times \bar{\Y}$,
\begin{equation*}
    v^Q(t,y) \defeq - \ln \left(-U(t,Q,y)\right).
\end{equation*}

We suppose that the penalty function $\ell$ is convex.

In Subsection \ref{subsec:log_concavity}, we prove, by contradiction, the strict concavity of $v$ with respect to $Q$ on $[0,T) \times \Q \times \bar{\Y}$, i.e. Proposition \ref{prop:log_concavity}(ii).

In Subsection \ref{subsec:proof_thm_uniqueness}, we show that the strict concavity of $Q \mapsto v^Q(t,y)$ implies the uniqueness of the control policy, i.e. Theorem \ref{thm:uniqueness}.

\subsection{Log-convexity of the negative of the value function}
\label{subsec:log_concavity}

For $Q \in \Q$, $v^Q \in C([0,T] \times \bar{\Y}) \cap C^{1,2}([0,T) \times \Y)$ and $(t,Q,y) \mapsto v^Q(t,y)$ is continuous on $[0,T] \times \Q \times \Y$. It is straightforward to check that for all $(t,y,Q) \in [0,T) \times \mathcal{Y} \times \Q$,
\begin{equation}
    \label{eq:log_HJB_interior}
    \begin{aligned}
        0 =&\partial_t v^Q(t,y) + \frac{\sigma^2}{2}\partial^2_{yy} v^Q(t,y) - \frac{\sigma^2}{2}\left(\partial_y v^Q(t,y) + \gamma Q\right)^2 + \left(\Lambda^a + \Lambda^b\right)(t,y)\\
        &+\Lambda^a(t,y)
            h^a\left((v^R(t,y))_{R \in \Q}, \gamma\left(\frac{\delta}{2} - y\right), Q\right)
        + \Lambda^b(t,y)
        h^b\left((v^R(t,y))_{R \in \Q}, \gamma\left(\frac{\delta}{2} + y\right), Q'\right),
    \end{aligned}
\end{equation}
and for all $(t,y,Q) \in [0,T] \times \bar{\mathcal{Y}} \times \Q$, the following boundary conditions hold:
\begin{equation}
    \label{eq:log_HJB_border}
    \left\{
        \begin{array}{ll}
            v^Q(T, y) &= - \ell(Q) \\
            v^Q\left(t, \ybar\right) &= v^Q\left(t,\yplus\right) \\
            v^Q\left(t, -\ybar\right) &= v^Q\left(t, \yminus\right).
        \end{array}
    \right.
\end{equation}

We introduce the continuous function
\begin{equation*}
    \begin{array}{rccl}
        \mathcal{C} : & [0,T] \times \bar{\mathcal{Y}} \times \Q \times \Q \times [0,1] & \to & \mathbb{R} \\
        & (t, y, Q,Q',\lambda) & \mapsto & v^{(1-\lambda)Q + \lambda Q'}(t,y) - (1-\lambda) v^Q(t,y) - \lambda v^{Q'}(t,y).
    \end{array}
\end{equation*}
For fixed $(Q,Q', \lambda)$, $\mathcal{C}(\cdot, \cdot, Q, Q', \lambda) \in C^{1,2}([0,T)\times \mathcal{Y})$, and for fixed $(t,y)$, $\mathcal{C}(t,y, \cdot, \cdot, \cdot) = C_g$ with $g: R \in \Q \mapsto v^R(t,y)$.

We show the concavity of $Q \mapsto v^Q(t,y)$ with respect to the $Q$ variable. The proof is divided in two parts: first we prove the concavity of $Q \mapsto v^Q(t,y)$, then its strict concavity on $[0,T) \times \mathcal{Y}$. We use Remark \ref{rem:concave} and a maximum principle argument, following similar arguments as in \parencite{korevaar_convex_1983}.

\subsubsection{Concavity with respect to the inventory}

Suppose there exists $(t,y) \in [0,T] \times \mathcal{Y}$ such that $Q \mapsto v^Q(t,y)$ is not concave. Then, by Remark \ref{rem:concave}, $\min \mathcal{C} < 0$. Since for all $(y,Q)$, $v^Q(T,y) = -\ell(Q)$ and $-\ell$ is concave, necessarily $\mathcal{C}(T,\cdot, \cdot, \cdot, \cdot) \geqslant 0.$ Suppose then that $(t,y,Q,Q',\lambda) \in [0,T) \times \mathcal{Y} \times \Q \times \Q \times (0,1)$ minimizes $e^{t}\mathcal{C}(t,y,Q,Q',\lambda)$, with $Q < Q'$. We can choose $y \in \mathcal{Y}$ because if $\mathcal{C}$ is minimized on the boundary of $\mathcal{Y}$, then it is also minimized on its interior, thanks to \eqref{eq:log_HJB_border}; see \parencite{baldacci_bid_2020} for a similar argument.

Define $\tilde{Q} \defeq (1-\lambda)Q + \lambda Q'$. The optimality of $(t,y)$ implies
\begin{equation*}
    \partial_t \mathcal{C}(t,y,Q,Q',\lambda) + \mathcal{C}(t,y,Q,Q',\lambda) \geqslant 0
    ,\ \partial_y \mathcal{C}(t,y,Q,Q',\lambda) = 0
    \text{ and } \partial^2_{yy} \mathcal{C}(t,y,Q,Q',\lambda) \geqslant 0,
\end{equation*}
and therefore
\begin{align*}
        \partial_t v^{\tilde{Q}}(t,y) + v^{\tilde{Q}}(t,y) & \geqslant (1-\lambda)\partial_t v^Q(t,y) + \lambda\partial_t v^{Q'}(t,y) + (1-\lambda)v^Q(t,y) + \lambda v^{Q'}(t,y)\\
        \partial_y v^{\tilde{Q}}(t,y) & = (1-\lambda)\partial_y v^Q(t,y) + \lambda\partial_y v^{Q'}(t,y)\\
        \partial^2_{yy} v^{\tilde{Q}}(t,y) & \geqslant (1-\lambda)\partial^2_{yy} v^Q(t,y) + \lambda\partial^2_{yy} v^{Q'}(t,y).
    \end{align*}
    Hence,
    \begin{equation*}
        \begin{split}
            \partial_t &v^{\tilde{Q}}(t,y) + \frac{\sigma^2}{2}\partial^2_{yy} v^{\tilde{Q}}(t,y) + v^{\tilde{Q}}(t,y)
        \\ &\geqslant
        (1-\lambda)\left(\partial_t v^{Q}(t,y) + \frac{\sigma^2}{2}\partial^2_{yy} v^{Q}(t,y) + v^{Q}(t,y)\right)
        +\lambda \left(\partial_t v^{Q'}(t,y) + \frac{\sigma^2}{2}\partial^2_{yy} v^{Q'}(t,y) + v^{Q'}(t,y)\right).
        \end{split}
    \end{equation*}
    Using equation \eqref{eq:log_HJB_interior} and denoting $g \defeq (v^R(t,y))_{R \in \Q}$, we obtain 
    \begin{equation*}
        \begin{split}
            \Lambda^a&(t,y)\left((1-\lambda)h^a\left(g, \gamma\left(\frac{\delta}{2} - y\right),Q\right)
            + \lambda h^a\left(g, \gamma\left(\frac{\delta}{2} - y\right), Q'\right) - h^a\left(g, \gamma\left(\frac{\delta}{2} - y\right),\tilde{Q} \right)\right)\\
            &+\Lambda^b(t,y)\left((1-\lambda)h^b\left(g, \gamma\left(\frac{\delta}{2} + y\right),Q\right)
            + \lambda h^b\left(g, \gamma\left(\frac{\delta}{2} + y\right), Q'\right) - h^b\left(g, \gamma\left(\frac{\delta}{2} + y\right),\tilde{Q} \right)\right)\\
            & \geqslant
            (1-\lambda) \left(\partial_y v^{Q}(t,y) + \gamma Q\right)^2 + \lambda \left(\partial_y v^{Q'}(t,y) + \gamma Q'\right)^2 - \left(\partial_y v^{\tilde{Q}}(t,y) + \gamma \tilde{Q}\right)^2\\
            &+(1-\lambda)v^Q(t,y) + \lambda v^{Q'}(t,y) - v^{\tilde{Q}}(t,y).
        \end{split}
    \end{equation*}
    Since the square function is convex and
    \begin{equation*}
        \partial_y v^{\tilde{Q}}(t,y) + \gamma \tilde{Q} = (1-\lambda)\left(\partial_y v^Q(t,y) + \gamma Q\right) + \lambda\left(\partial_y v^{Q'}(t,y) + \gamma Q'\right),
    \end{equation*}
    $(1-\lambda) \left(\partial_y v^{Q}(t,y) + \gamma Q\right)^2 + \lambda \left(\partial_y v^{Q'}(t,y) + \gamma Q'\right)^2 - \left(\partial_y v^{\tilde{Q}}(t,y) + \gamma \tilde{Q}\right)^2 \geqslant 0$. Moreover, by assumption, $(1-\lambda)v^Q(t,y) + \lambda v^{Q'}(t,y) - v^{\tilde{Q}}(t,y) > 0$. Using Lemma \ref{lem:envelope_inequality}, we get
    \begin{equation}
        \label{eq:concavity_final_ineq}
        \begin{split}
                &\Lambda^a(t,y)\left((1-\lambda)h^a\left(\hat{g}, \gamma\left(\frac{\delta}{2} - y\right),Q\right)
                + \lambda h^a\left(\hat{g}, \gamma\left(\frac{\delta}{2} - y\right), Q'\right) - h^a\left(\hat{g}, \gamma\left(\frac{\delta}{2} - y\right),\tilde{Q} \right)\right)\\
                &+\Lambda^b(t,y)\left((1-\lambda)h^b\left(\hat{g}, \gamma\left(\frac{\delta}{2} + y\right),Q\right)
                + \lambda h^b\left(\hat{g}, \gamma\left(\frac{\delta}{2} + y\right), Q'\right) - h^b\left(\hat{g}, \gamma\left(\frac{\delta}{2} + y\right),\tilde{Q} \right)\right) > 0.
        \end{split}
    \end{equation}
    By Corollary \ref{corol:envelope_shape}, $\hat{g}(\tilde{Q}) = (1-\lambda)\hat{g}(Q) + \lambda \hat{g}(Q')$. Thus, by Lemma \ref{lem:bid_ask_max}(i), the left-hand side of \eqref{eq:concavity_final_ineq} is nonpositive, leading to a contradiction.

\subsubsection{Strict concavity with respect to the inventory}

We have shown that for all $(t,y) \in [0,T] \times \bar{\Y}$, $Q \mapsto v^Q(t,y)$ is concave. Suppose there exists $(t,y) \in [0,T) \times \bar{\Y}$ such that $Q \mapsto v^Q(t,y)$ is not strictly concave. We can take $y \in \Y$, thanks to \eqref{eq:log_HJB_border}. Then, by Remark \ref{rem:concave}, there exists $(Q_0, Q_0') \in \Q \times \Q$ such that $Q_0 < Q_0'$ and $\mathcal{C}\left(t,y,Q_0,Q_0',\frac{1}{2}\right) = 0$. Define $g:Q \in \Q \mapsto v^Q(t,y)$ and $p \defeq \frac{g(Q_0') - g(Q_0)}{Q_0' - Q_0}$. Set
\begin{align*}
    Q &\defeq \inf\left\{R \in \Q :\frac{g(Q_0') - g(R)}{Q_0' - R} = p \right\} \leqslant Q_0 \\
    Q' &\defeq \sup\left\{R \in \Q :\frac{g(R) - g(Q_0)}{R - Q_0} = p \right\} \geqslant Q_0'.
\end{align*}
We have $\frac{g(Q')-g(Q)}{Q'-Q} = p$, for all $ R \in \Q \cap (-\infty,Q)$, $g'_+(R) > p$, and for all $ R \in \Q \cap (Q', \infty)$, $g'_-(R) < p$.

Since $\mathcal{C}\left(t,y,Q,Q',\frac{1}{2}\right) = 0$, $(t,y)$ minimizes $\mathcal{C}\left(\cdot,\cdot,Q,Q',\frac{1}{2}\right)$. Defining $\tilde{Q} \defeq \frac{1}{2}Q + \frac{1}{2}Q'$, and proceeding in the exact same way as in the previous section, we obtain
\begin{equation*}
    \begin{split}
            &\Lambda^a(t,y)\left((1-\lambda)h^a\left(g, \gamma\left(\frac{\delta}{2} - y\right),Q\right)
            + \lambda h^a\left(g, \gamma\left(\frac{\delta}{2} - y\right), Q'\right) - h^a\left(g, \gamma\left(\frac{\delta}{2} - y\right),\tilde{Q} \right)\right)\\
            &+\Lambda^b(t,y)\left((1-\lambda)h^b\left(g, \gamma\left(\frac{\delta}{2} + y\right),Q\right)
            + \lambda h^b\left(g, \gamma\left(\frac{\delta}{2} + y\right), Q'\right) - h^b\left(g, \gamma\left(\frac{\delta}{2} + y\right),\tilde{Q} \right)\right) \geqslant 0.
    \end{split}
\end{equation*}
By Lemma \ref{lem:bid_ask_max}(i), both terms in the left-hand side are nonpositive and therefore equal to $0$. By Lemma \ref{lem:bid_ask_max}(ii), we must have $p \geqslant \gamma\left(\frac{\delta}{2} - y\right)$ and $p \leqslant -\gamma \left(\frac{\delta}{2}+y\right)$ (otherwise, one of the terms would be strictly negative, since $\Lambda^a, \Lambda^b > 0$). This implies $\gamma \delta \leqslant 0$, which is a contradiction.

\subsection{Proof of Theorem \ref{thm:uniqueness}}
\label{subsec:proof_thm_uniqueness}

Fix $(t,Q,y) \in [0,T) \times \Q \times \Y$. For $q \in \Qa \cap [0,Q + \Qmax]$, $e^{-\gamma q \left(\frac{\delta}{2}- y\right)}U(t,Q-q,y) = -e^{-\gamma q \left(\frac{\delta}{2}- y\right) - v^{Q-q}(t,y)}$. The function $q \mapsto \gamma q \left(\frac{\delta}{2}- y\right) + v^{Q-q}(t,y)$ is concave. Then, Corollary \ref{corol:max_integral} implies the first equality of Theorem \ref{thm:uniqueness}(i). Moreover, because $q \mapsto \gamma q \left(\frac{\delta}{2}- y\right) + v^{Q-q}(t,y)$ is strictly concave, it has a unique maximizer on $\Qa \cap [0,Q + \Qmax]$. A similar argument can be used on the bid side, to conclude the proof of Theorem \ref{thm:uniqueness}(i).

Consequently, the functions $\hat{q}^a$ and $\hat{q}^b$ given by Theorem \ref{thm:verification} are uniquely determined on $[0,T) \times \Q \times \bar{\Y}$. We show that they are continuous on this set. As usual, we only do it only for the ask side because the argument is analogous on the bid side. Let $(t_k)_k$, $(Q_k)_k$ and $(y_k)_k$ be three sequences of elements of $[0,T)$, $\Q$ and $\bar{\Y}$, converging to $t$, $Q$ and $y$,  respectively. Let $(k_i)_{i}$ be a (strictly) increasing sequence on nonnegative integers such that $\left(\hat{q}^a(t_{k_i}, Q_{k_i}, y_{k_i})\right)_i$ converges to some $q \in \Qa$. It is sufficient to show that $q = \hat{q}^a(t,Q,y)$. Since for all $i$, $\hat{q}^a(t_{k_i}, Q_{k_i}, y_{k_i}) \leqslant Q_{k_i} + \Qmax$, we have $q \leqslant Q + \Qmax$. By definition, for all $i$,
\begin{equation*}
    \begin{split}
        e^{-\gamma \hat{q}^a(t_{k_i}, Q_{k_i}, y_{k_i})\left(\frac{\delta}{2}-y_{k_i}\right)}U(t_{k_i}, &Q_{k_i} - \hat{q}^a(t_{k_i}, Q_{k_i}, y_{k_i}), y_{k_i})\\
    &\geqslant e^{-\gamma \left(\hat{q}^a(t, Q, y)\wedge\left(Q_{k_i} + \Qmax\right)\right)\left(\frac{\delta}{2}-y_{k_i}\right)}U(t_{k_i}, Q_{k_i} - \hat{q}^a(t, Q, y) \wedge \left(Q_{k_i} + \Qmax\right), y_{k_i}).
    \end{split}
\end{equation*}
Passing to the limit, we get
\begin{equation*}
    e^{-\gamma q\left(\frac{\delta}{2}-y\right)}U(t, Q - q, y)\\
    \geqslant e^{-\gamma \hat{q}^a(t, Q, y)\left(\frac{\delta}{2}-y\right)}U(t, Q - \hat{q}^a(t, Q, y), y).
\end{equation*}
In addition, by the definition on $\hat{q}^a$, the right-hand side is greater or equal than the left-hand side, and we have equality. Since the maximizer is unique, $q = \hat{q}^a(t,Q,y)$, which yields Theorem \ref{thm:uniqueness}(iii).
\end{dummyenv}

Let $q =(q^a, q^b) \in \mathcal{A}^{t,Q}$ be a control policy such that $J(t,Q,y,q) = U(t,Q,y)$. By Theorem \ref{thm:uniqueness}(i) and Theorem \ref{thm:verification}(iv), we have, $\diff s \otimes \Proba[][\diff \omega]$-almost everywhere on $[t,T] \times \Omega$,
\begin{align*}
    q^a_s(\omega) = \hat{q}^a(s, \Q_{s-}, \Y_s) \text{ and }
    q^b_s(\omega) = \hat{q}^b(s, \Q_{s-}, \Y_s).
\end{align*}
In order to show that $q_s(\omega) = q_s^*(\omega)$  $\diff s \otimes \Proba[][\diff \omega]$-almost everywhere on $[t,T] \times \Omega$, it is sufficient to show that, with probability one for all $s \in [t,T)$, $\Q_s = Q^{t,Q,q^*}_s$. We denote by $t_1 < t_2 < \dots$ the jump times of $N \defeq N^a(\cdot \times \mathcal{Q}_{\infty}^{+,a}) + N^b(\cdot \times \mathcal{Q}_{\infty}^{+,b})$ on $(t,T)$, with $t_i = T$ if $i \geqslant N_T$. We show by induction that $\Q \mathds{1}_{[t,t_i)} = Q^{t,Q,q^*} \mathds{1}_{[t,t_i)}$ with probability one for all $i$. It holds for $i = 1$ since $\Q$ and $Q^{t,Q,q^*}$ are constant and equal to $Q$ on the (random) interval $[t,t_1)$. Suppose that the property holds for $i \in \mathbb{N}^*$. We will show that once we make this assumption, $q$ and $q^*$ coincide at the next jump of $N$ with probability one, which in turn implies the induction step. We have
\begin{align*}
    \Proba[][\left\{t_{i} < T\right\} \cap \left\{q_{t_{i}} \neq  q^*_{t_{i}}\right\}] & = \E[][\int_{(t,T)}\mathds{1}_{\{N_{s-} - N_t = i-1\}}\mathds{1}_{\{q_s \neq q_s^*\}} N(\diff s)]\\
    & = 2\E[][\int_{(t,T)}\mathds{1}_{(t_{i-1},t_{i})}(s)\mathds{1}_{\{q_s \neq q_s^*\}}\diff s].
\end{align*}
This probability is equal to zero. Indeed, almost surely for all $s \in (t,T)$,
\[\mathds{1}_{[t,t_i)}(s)\mathds{1}_{\{q_s \neq q_s^*\}} = \mathds{1}_{[t,t_i)}(s)\mathds{1}_{\{q^a_s \neq \hat{q}^a(s,\Q_{s-},\Y_s)\}}\mathds{1}_{\{q^b_s \neq \hat{q}^b(s,\Q_{s-},\Y_s)\}},
\]
and therefore $\mathds{1}_{[t,t_i(\omega))}(s)\mathds{1}_{\{q_s(\omega) \neq q_s^*(\omega)\}} = 0$, $\diff s \otimes \Proba[][\diff \omega]$-almost everywhere on $[t,T] \times \Omega$. Theorem \ref{thm:uniqueness}(ii) follows by induction.

\appendix

\input{midprice_construction}

\section{Linear parabolic PDEs with nonlocal boundary conditions}
\label{sec:linear_nonlocal_pde}

\input{linear_nonlocal_pde}

\section{Convergence from the discrete inventory to the continuous inventory case}
\label{sec:convergence_discrete_continuous}
\begin{dummyenv}
\renewcommand{\Q}{\mathcal{Q}_n}
\renewcommand{\Y}{\mathcal{Y}}
\input{convergence_discrete_continuous}
\end{dummyenv}

\section{Properties of the Hamiltonians}
\begin{dummyenv}
\renewcommand{\Q}{\mathcal{Q}_n}
\renewcommand{\Y}{\mathcal{Y}}
\input{inequalities_hamiltonian}
\end{dummyenv}

\section{Some measurability proofs for Theorem \ref{thm:existence}}
\begin{dummyenv}
\renewcommand{\Q}{\mathcal{Q}_n}
\renewcommand{\Y}{\mathcal{Y}}
\input{measurability_proofs}
\end{dummyenv}

\section{About concavity}
\begin{dummyenv}
\renewcommand{\Q}{\mathcal{Q}_{\infty}}
\renewcommand{\Qa}{\mathcal{Q}^{+,a}_{\infty}}
\renewcommand{\Qb}{\mathcal{Q}^{+,b}_{\infty}}
\renewcommand{\Qi}{\mathcal{Q}^{+,i}_{\infty}}
\input{concavity_lemmas}
\end{dummyenv}

\printbibliography

\end{document} 