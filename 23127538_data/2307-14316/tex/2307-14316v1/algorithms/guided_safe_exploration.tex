\begin{algorithm}[t]
\caption{Guided Safe Exploration}
\label{alg:safetransfer}
\textbf{Input}: $\mathcal{M}^\targ$, $\pi^\src$, $\minH$, $d$\\
\textbf{Initialize}: $\mathcal{D} \leftarrow \emptyset$, $\theta^\targ_\chi \text{ for } \chi \in \{\pi,R,C,\alpha,\beta\}$ \\
\textbf{Output}: Optimized parameters $\theta^\targ_\pi$ for $\pi^\targ$

\begin{algorithmic}[1] %
\FOR{each iteration}
        \FOR{each environment step} \label{lst:safe_env_step_begin}
        \IF{\emph{linear-decay}} 
            \STATE $b \leftarrow f_{\text{ld}}(\src,\targ)$ \COMMENT{linearly eliminate the effect of $\pi^\src$}
        \ELSIF{\emph{control-switch}} 
            \STATE $b \leftarrow f_{\text{cs}}(\src,\targ)$ \COMMENT{$\pi^\src$ takes control if unsafe}
            \ENDIF
            \STATE $a_t \sim \pib(\cdot \mid s_t)$
            \COMMENT{Composite sampling \eqref{eq:behaviour_policy}}
            \STATE $\mathcal{I}_t \leftarrow \mathcal{I}(s_t, a_t)$   \COMMENT{IS ratio \eqref{eq:ISratio}}
            \STATE $r^\targ_t \leftarrow r^\targ(s_t,a_t)$
            \STATE $r^\src_t \leftarrow \log \pi^\src(a_t \mid \Xi(s_t))$
            \STATE $c^\targ_t \leftarrow c^\targ(s_t,a_t)$
            \STATE $s_{t+1} \sim \mathcal{P}^\targ(\cdot \mid s_t,a_t)$
            \STATE $\mathcal{D} \leftarrow  \mathcal{D} \cup \{(s_t,a_t,r^\targ_t,r^\src_t,c^\targ_t,\mathcal{I}_t,s_{t+1}) \}$ \label{lst:safe_env_step_end}
        \ENDFOR 
        \FOR{each gradient step}
        \label{lst:safe_update_begin}
        \STATE Sample experience from $\mathcal{D}$ \label{lst:sample_experiences}
        \FOR{$\chi \in \{\pi,R,C,\alpha,\beta\}$}
        \STATE $\theta^\targ_\chi \leftarrow \theta^\targ_\chi - \eta_\chi \hat{\nabla}_{\theta^\targ_\chi} \mathcal{I} J_{\chi}(\theta^\targ_\chi)$ \COMMENT{Updating $\theta^\targ_\chi$} \label{lst:updateparameters} 
        \label{lst:safe_update_end}
        \ENDFOR
        \ENDFOR 
        \ENDFOR %
\end{algorithmic}
\end{algorithm}