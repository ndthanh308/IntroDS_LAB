\subsection{Upper-Bounds on Thresholds}
\label{sec:hard1}

We show that if $\RBF(\Ical, T)$'s output is $T$-MMS
for every fair division instance $\Ical$ with $n$ agents,
where $T \defeq (\tau_1, \ldots, \tau_n)$ is a list of thresholds and $\tau_n > 0$,
then $\tau_i$ must be at most $3n/(3n+i-2)$ for all $i \in \{3, \ldots, n\}$.
We also show how this limits the best ex-ante fairness achievable by $\RBF(\Ical, T)$.

In particular, by setting $i = n$, we get that $\tau_n \le 3n/(4n-2)$,
i.e., $\RBF$'s output cannot be better than $3n/(4n-2)$-MMS,
which was also proved in Section 5 of \cite{akrami2023simplification}.
Hence, we generalize their tight example to the setting with agent priority ranks.

Let $n \ge 3$. For $i \in \{3, \ldots, n\}$, let
$\delta_i \defeq 1/(3n+i-2)$, $\alpha_i \defeq 3n\delta_i$,
and $u_i: \mathbb{Z}_{>0} \to \mathbb{R}_{\ge 0}$, where
\[ u_i(j) \defeq \begin{cases}
(2n-\ceil{j/2})\delta_i & \textrm{ if } j \le 2n
\\ n\delta_i & \textrm{ if } 2n < j < 2n+i
\\ 0 & \textrm{ if } j \ge 2n+i
\end{cases}. \]

\begin{observation}
$3/4 < \alpha_n < \ldots < \alpha_3 < 1$.
\end{observation}

\begin{lemma}
\label{thm:hard1-props}
For $i \in \{3, \ldots, n\}$, $u_i$ satisfies all of these properties:
\begin{enumerate}
\item \label{item:hard1-props:ord-norm}$u_i$ is ordered and normalized.
\item \label{item:hard1-props:irred}$\max(u_i(\{1\}), u_i(\{n, n+1\}), u_i(\{2n-1, 2n, 2n+1\}), u_i(\{1, 2n+1\})) \le \alpha_i$.
\item \label{item:hard1-props:bag-fill}For each $j \in [n]$, we have
    $u_i(\{j, 2n+1-j\}) \le \alpha_i$ and $u_i(\{j, 2n+1-j, 2n+i-1\}) \ge 1$.
\end{enumerate}
\end{lemma}
\begin{proof}
$u_i(2n) = n\delta_i = u_i(2n+1) > 0$, so $u_i$ is ordered.

Let $k \defeq n-i+1$. Let $M \defeq (M_1, \ldots, M_n)$ where
\[ M_j \defeq \begin{cases}
\{j, 2k+1-j\} & \textrm{ if } 1 \le j \le k
\\ \{k+j, 2n+3k+1-j, 2n+j-k\} & \textrm{ if } k+1 \le j \le n
\end{cases}. \]
Then we can verify that $u_i(M_j) = 1$ for all $j \in [n]$.

$u_i(\{1, 2n+1\}) = u_i(\{n, n+1\}) = (3n-1)\delta_i \le \alpha_i$.
$u_i(\{2n-1, 2n, 2n+1\}) = 3n\delta_i = \alpha_i$.

$u_i(\{j, 2n+1-j\}) = (3n-1)\delta_i \le \alpha_i$.
$u_i(\{j, 2n+1-j, 2n+i-1\}) = (4n-1)\delta_i \ge 1$.
\end{proof}

For any $\eps \in (0, 1)$ such that $1/\eps \in \mathbb{Z}_{>0}$,
define valuation function $w_{\eps}: [n/\eps] \to \mathbb{R}_{\ge 0}$ as $w_{\eps}(j) = \eps$ for all $j$.
Note that $w_{\eps}$ is ordered and normalized.

\begin{theorem}
\label{thm:hard1}
Let $T \defeq (\tau_1, \ldots, \tau_n)$, where $\tau_n > 0$.
If $\RBF(\Ical, T)$ outputs a $T$-MMS allocation for every fair division instance $\Ical$
with $n$ agents, then $\tau_i \le \alpha_i$ for all $i \in \{3, \ldots, n\}$,
where $\alpha_i \defeq 3n/(3n+i-2)$.
\end{theorem}
\begin{proof}
Assume \wLoG{} that each agent $i$ has priority rank $i$.
Suppose $\RBF(\Ical, T)$ outputs a $T$-MMS allocation
for every fair division instance $\Ical$ with $n$ agents,
but $\tau_i > \alpha_i$ for some $i \in \{3, \ldots, n\}$.

Pick $\eps \in (0, \tau_n/3)$ such that $1/\eps \in \mathbb{Z}_{>0}$.
Consider a fair division instance $([n], [n/\eps], v)$, where $v_1 = \ldots = v_i = u_i$
and $v_{i+1} = \ldots = v_n = w_{\eps}$.
By \cref{thm:hard1-props}.\ref{item:hard1-props:irred}, no reduction events take place during $\RBF$.
Hence, $\RBF$ simply delegates everything to $\bagFill$.

By \cref{thm:hard1-props}.\ref{item:hard1-props:bag-fill}, all bags initially have value
at most $\alpha_i$ for the first $i$ agents, and value $2\eps$ for the remaining agents.
Since $\alpha_i < \tau_i$ and $2\eps < \tau_n$, no agent wants any bag initially.

For the first $i$ agents, only goods in $[2n+i-1]$ have positive value.
Since $\RBF$ outputs a $T$-MMS allocation, each agent in $[i]$
receives a bag with at least one good from $[2n+i-1] \setminus [2n]$.
But this is impossible since there are only $i-1$ goods in $[2n+i-1] \setminus [2n]$.
This is a contradiction. Hence, $\tau_i \le \alpha_i$.
\end{proof}

Our approach in \cref{sec:algo1:bobw} to get best-of-both-worlds fairness is via \cref{thm:cyclic-perm},
i.e., we first find a list $T \defeq (\tau_1, \ldots, \tau_n)$ of thresholds such that
$\RBF(\Ical, T)$ outputs a $T$-MMS allocation for every fair division instance $\Ical$ with $n$ agents,
and then we run $\RBF$ with random priority ranks.
Then we get ex-post $\tau_n$-MMS and ex-ante $\frac{1}{n}(\sum_{i=1}^n \tau_i)$-MMS.
We now show the limitations of this approach.

By \cref{thm:hard1}, if we want any ex-post MMS guarantee for the output of \cref{algo:rbf},
the best ex-ante MMS guarantee we can get is
\[ \frac{1}{n}\left(2 + \sum_{i=3}^n \frac{3n}{3n+i-2}\right). \]
We now show an upper-bound on this quantity.

\begin{restatable}{lemma}{rthmHardIExa}
\label{thm:hard1-avg}
For all $n \ge 2$,
\[ \frac{1}{n}\left(2 + \sum_{i=3}^n \frac{3n}{3n+i-2}\right)
    \le 3\ln\left(\frac{4}{3}\right) + \frac{1}{2n} \approx 0.86305 + \frac{1}{2n}. \]
\end{restatable}
\begin{proof}
(Proof deferred to \cref{sec:prio-extra:calculations}).
\end{proof}

\begin{theorem}
\label{thm:hard1-exa}
If we fix the number of agents to $n$, the ex-ante MMS guarantee obtainable from $\RBF$
by picking priority ranks randomly (as in \cref{thm:cyclic-perm})
is not better than $\beta$-MMS, where
$\beta \defeq 3\ln(\frac{4}{3}) + \frac{1}{2n} \approx 0.86305 + \frac{1}{2n}$,
and the ex-post MMS guarantee is not better than $\gamma$-MMS,
where $\gamma \defeq 3n/(4n-2) = \frac{3}{4} + \frac{3}{8n-4}$.
\end{theorem}
\begin{proof}
Follows from \cref{thm:hard1,thm:cyclic-perm,thm:hard1-avg}.
\end{proof}
