\documentclass[12pt]{amsart}%{elsarticle}
%\usepackage{e-jc}

%--------------------------------------------------------------------
%\hoffset -25truemm \oddsidemargin=25truemm
%\evensidemargin=25truemm \textwidth=155truemm
\voffset -10truemm
%\topmargin=25truemm %\headheight=7truemm \headsep=0truemm
%\textheight=225truemm \baselineskip=16pt
%--------------------------------------------------------------------

\pdfoutput=1

%\usepackage{amssymb,amsfonts,amsmath,eepic,colordvi,latexsym}
\usepackage{latexsym}
\usepackage[centertags]{amsmath}
\usepackage{amsfonts}
\usepackage{amssymb}
\usepackage{amsthm}
\usepackage{newlfont}
\usepackage{graphics}
\usepackage{color}

\usepackage[font=small,labelfont=bf,margin=5mm]{caption}

\RequirePackage{xparse, graphicx, caption, picins}
\DeclareDocumentCommand \addpic{O{0.4\textwidth} m g}{\parpic[r]{%
\begin{minipage}{#1}
    % Figure removed%
    \IfNoValueTF{#3}{}{\captionof{figure}{\footnotesize #3}}
\end{minipage}
}}


%%%%%
\usepackage[usenames,dvipsnames]{xcolor}
\usepackage{graphicx}
%\usepackage[colorlinks=true,citecolor=cyan,urlcolor=blue]{hyperref}
\def\dessin#1#2{% Figure removed}
\usepackage{wrapfig}

\parskip 5pt
\parindent 2em
\newtheorem{theo}{Theorem}
\newtheorem{defn}[theo]{Definition}
\newtheorem{exam}[theo]{Example}
\newtheorem{lem} [theo]{Lemma}
\newtheorem{cor}[theo]{Corollary}
\newtheorem{prop}[theo]{Proposition}
\newtheorem{rem}[theo]{Remark}
\newtheorem{perty}[theo]{Property}
\newtheorem{conj}[theo]{Conjecture}

\makeatletter \@addtoreset{equation}{section}
\@addtoreset{theo}{}\makeatother

\setlength{\topmargin}{-5mm} \setlength{\oddsidemargin}{0.2cm}
\setlength{\evensidemargin}{0.2cm} \setlength{\textwidth}{15.8cm}
\setlength{\textheight}{22.42cm}
\renewcommand{\thetheo}{\arabic{theo}}


\renewcommand{\arraystretch}{1.3}

\def\qed{\hfill \rule{4pt}{7pt}}
\def\pf{\noindent {\it Proof.} }
\def\o{\overline{o}}
\def\e{\overline{e}}
\def\CT{\mathop{\mathop{CT}}}
\textheight=24cm %\topmargin=-1cm

\def\res{\mathop{\mathrm{res}}}
\def\CT{\mathop{\mathrm{CT}}}


\newcommand\qbinom[2]{\left[#1 \atop #2  \right]_q}
\def\n{\mathfrak{n}}
\def\N{\mathbb{N}}
\def\Z{\mathbb{Z}}
\def\bD{\overline{D}}

\def \k {{\mathbf{k}}}

\def\oD{\overline{D}}


\newcommand{\stat}{\operatorname{stat}}
\newcommand{\area}{\operatorname{area}}
\newcommand{\coarea}{\operatorname{coarea}}
\newcommand{\dinv}{\operatorname{dinv}}
\newcommand{\codinv}{\operatorname{codinv}}
\newcommand{\arm}{\operatorname{arm}}
\newcommand{\leg}{\operatorname{leg}}
\newcommand{\pdinv}{\operatorname{pdinv}}
\newcommand{\tdinv}{\operatorname{tdinv}}
\newcommand{\mdinv}{\operatorname{maxtdinv}}
\newcommand{\rank}{\operatorname{rank}}
\newcommand{\ides}{\operatorname{ides}}
\newcommand{\des}{\operatorname{des}}
\newcommand{\pides}{\operatorname{pides}}
\newcommand{\Cat}{\texttt{Cat}}

\def\VIB{\texttt{VIB}}
\def\HIB{\texttt{HIB}}
\def\HPath{\texttt{HPath}}
\def\VPath{\texttt{VPath}}


\title{Inverting the General Order Sweep Map}

\author{Ying Wang$^{1}$, Guoce Xin$^2$ and Yingrui Zhang$^{3,*}$}

\address{ $^1$ School of Mathematics and Statistics, North China University of Water Resources and Electric Power, Zhengzhou 450046, PR China }
\address{ $^{2}$School of Mathematical Sciences, Capital Normal University,
 Beijing 100048, PR China }
\address{$^3$KLMM, Academy of Mathematics and Systems Science Chinese Academy of Sciences, Beijing 100190, PR China}



\email{$^1$\texttt{wangying2019@ncwu.edu.cn}\ \  \&\small $^2$\texttt{guoce\_xin@163.com} \& $^3$\texttt{zyrzuhe@126.com} }
%\author{Guoce Xin}
%\address{School of Mathematical Sciences, Capital Normal University, Beijing 100048, PR China}
%\email{guoce.xin@gmail.com}

\date{    \today }
\thanks{This work was partially supported by NSFC(12071311).}
\thanks{*Corresponding author.}
%\date{February 6, 2016} %\today}

\begin{document}

\begin{abstract}
 Inspired by Thomas-Williams work on the modular sweep map, Garsia and Xin gave a simple algorithm for inverting the sweep map on rational $(m,n)$-Dyck paths for a coprime pairs $(m,n)$ of positive integers. We find their idea naturally extends for general Dyck paths. Indeed, we define
a class of Order sweep maps on general Dyck paths, using different sweep orders on level $0$. We prove that each such Order sweep map is a bijection.
This includes sweep map for general Dyck paths and incomplete general Dyck paths as special cases.
\end{abstract}

\maketitle

\noindent
\begin{small}
 \emph{Mathematic subject classification}: Primary 05A19; Secondary 05A99 05E05.
\end{small}
%\subjclass[2010]{Primary 15A15; Secondary 05A15, 11B83}

\noindent
\begin{small}
\emph{Keywords}: general Dyck paths; Order sweep map; path diagrams.
\end{small}

%\vspace{-5mm}

\section{Introduction}


The sweep map is an active subject in recent decades. Variations and extensions have been found, and some classical bijections turn out to be
the disguised version of the sweep map. %See \cite{sweepmap} for detailed information and references.
One major problem in this subject
is the invertibility of the sweep map. The bijectivity has been shown in a variety of special cases including
the Fuss case when $m=kn\pm1$ which is proved in \cite{Loehr-higher-qtCatalan},\cite{Gorsky-Mazin2}and\cite{Fuss-case} .
Xin and Zhang gave a linear algorithm  for inverting the sweep map for $\k^{\pm}$-Dyck paths, and also for $\k$-Dyck paths in \cite{Xin-Zhang}.
The invertibility of the sweep map, even for rational Dyck paths, remained open for over ten years.
Surprisingly, a general result proving the invertibility of a class of sweep maps that were listed in \cite{sweepmap}, was recently given  by
Thomas-Williams in \cite{Thomas-Williams} (called modular sweep map). Inspired by the idea of Thomas and Williams, Garsia and Xin \cite{Rational-Invert} gave a geometric construction for inverting the sweep map on $(m,n)$-rational Dyck paths for a co-prime pair $(m,n)$ of positive integers. They introduced an intermediate object called balanced path diagram with strictly increasing rank sequence. It plays a
crucial role in reverting the sweep map. We find their idea naturally extends for general Dyck paths. The rank sequence of the balanced path
diagram becomes weakly increasing.

In this paper
%we show a strong result that the \emph{Order sweep} which will be defined below is a bijection for general Dyck paths.
we define
a class of Order sweep maps on general Dyck paths, using different sweep orders on level $0$. We prove that each such Order sweep map (\emph{Order sweep}) is a bijection.
This includes sweep map for general Dyck paths and incomplete general Dyck paths as special cases.

%Moreover, it is also a bijection for general Free paths. This can be proved by using the former result.

%: paths with arbitrary type of steps from level $0$ to level $0$ that never go below level $0$.

%Nathan's algorithm is for inverting the general modular sweep map.

%Our algorithm is different from ,
%even after specialization.
%The fundamental fact that made it so difficult to invert the sweep map in this case is that we concentrated on the ranks rather than on the paths. Moreover the geometry of the paths was not consistent with the ranks associated with them.


\def\type{\textrm{type}}
\def\A{\mathcal A}
%\section{Notations}
\addpic[.31\textwidth]{X-TableauExa.png}{ A path diagram of size $7$. \label{fig:TableauExa}}
We extend the notations in \cite{Rational-Invert}. %Sweep-Rational}.
A path diagram $T$ of size $N$ is a pair of integer sequences $T=T(P,R)$, where $P=(b_1,b_2,\dots, b_N)$ is called the \emph{path sequence}
and $R=(r_1,r_2,\dots, r_N)$ is called the \emph{rank sequence}.
In picture, $T$
consists of a sequence $(A_1,\dots, A_N)$  of $N$ arrows placed on the $\mathbb{Z}\times \mathbb{Z}$ lattice.
Each arrow $A_i$ is a $\mathbb{Z}$-vector $(1,b_i)$ that starts at $(i,r_i)$. It is called an \emph{up vector} and colored {red} if $b_i>0$, called a \emph{down vector} and colored blue if $b_i<0$, and called a \emph{level vector} and colored purple if $b_i=0$. See Figure \ref{fig:TableauExa}, where $P=(2, 2, 2, 0, -1, 3, 0, -4, -4),\ R=(1, 4, 0, 3, 2, 4, 6, 4, 5)$.

%\vspace{-3mm}

On the left of each horizontal lattice line, or \emph{line} for short, we have placed its $y$ coordinate which we will simply refer to as its \emph{level}.
The row of lattice cells delimited by the lines at levels $i$ and $i+1$ will be called  \emph{row $i$} or the $i$-th row. The level of the starting point of an arrow is called its \emph{starting rank}, and similarly its \emph{end rank} is the level of its end point.

Notice that each lattice cell may contain a segment of a red arrow or a segment of a blue arrow or no segment at all. Purple arrows contain no segments. The red segment count of row $j$ will be denoted $c^r(j)$ and the blue segment count
is denoted $c^b(j)$. We will set $c(j)=c^r(j)-c^b(j)$ and refer  to it as the \emph{count of row $j$}. In Figure \ref{fig:TableauExa} on the right of each row we have attached its row count.

The following observation will be crucial in our development. Its proof is similar to \cite[Lemma $2$]{Rational-Invert}. However when we investigate the contribution to the difference $c(j) - c(j-1)$ for a
single arrow $A$, there is one more case to be considered.
\begin{lem}\label{l-DifferenceLevelCount}
Let $T(P,R)$ be any path diagram. It holds for every integer $j$
that
\begin{align}
  c(j)-c(j-1)= \# \{\text{arrows starting at level } j\} -\#\{\text{arrows end at level } j\}.
\end{align}
\end{lem}

\vspace{-4mm}
\addpic[.48\textwidth]{FourCase.pdf}{The difference $c(j)-c(j-1)$ is $1$ in the left two cases,  is $-1$
in the right two cases. \label{fig:FourCases}}

\begin{proof}
For a single arrow $A$, the contribution to the difference $c(j)-c(j-1)$ is $0$ if i) $A$ has no segments in rows $j$ and $j-1$,
ii) $A$ has both segments in row $j$ and $j-1$,
iii) $A$ is a level vector starting at level $j$. In the first two cases,
it is clear that $A$ can not start nor end at level $j$,  and in the third case both the starting point and the ending point of A are at level $j$. The remaining cases are listed in Figure
\ref{fig:FourCases}.
\end{proof}

It will be convenient to say that a path diagram $T(P,R)$ is \emph{balanced}  if all
its  row counts are equal to $0$.


\def \ovvR {\overline R}
\def \ovvr {\overline r}
\emph{Paths} are connected path diagrams. In what follows, paths will always end at level $0$ unless specified otherwise.
A path $P$ is usually encoded by $P=(b_1,b_2,\dots, b_N)$.
Pictorially, $P$ is a sequence of arrows $(A_1,\dots, A_N)$ where $A_i$ is the vector $(1,b_i)$, and
by connectivity, it has to starts at the point $(i, b_0+b_1+\cdots+b_{i-1})$, where $b_0$ is set to be $-b_1-\cdots-b_n$. We also write $P=A_1A_2\cdots A_N$ as concatenation of the $A_i$'s (treated as vectors).
 The \emph{type} of $P$ is the multiset $\type(P)=\{b_1,\dots, b_N\}^*$, where we use $^*$ to mean multiset. We also use the notation $s^k$ in multisets to denote $k$ copies of $s$, so
$\{1^3,2,4^2\}^*=\{1,1,1,2,4,4\}^*$.

We can think a path diagram $T=T(P,R)$ is obtained from a path $P$ by vertically shifting the arrows to start at the rank sequence $R$. Conversely, by vertical shifting of the arrows of $T$, we can uniquely obtain the path $P$, also called the V-path $P=P(T)=\VPath(T)$ of $T$. The type of $T$ is $\type(T)=\type (P(T))$. We say $T$ is \emph{increasing} if $R(T)$ is weakly increasing.

\begin{prop}\label{p-zero-row-count}
If a path $P$ starts and ends at level $0$, then it is row balanced.
\end{prop}
\begin{proof}
For a path $P$ starting at level $0$ and end at level $0$, we ignore the purple arrows. Then it is clear that
every row above level $0$ starts with a red segment and ends with a blue segment, and every row below level $0$ starts with a blue segment and ends with a red segment.
The proposition then follows since in any path, the red and blue segments alternate in each row.
\end{proof}


\begin{defn}[Sweep map]
The sweep map of a path $P$ is obtained by sorting the arrows of $P$ according
to the following two conditions:
\begin{enumerate}
  \item We first successively list arrows of starting rank $0,1,\dots,\infty $ and then list arrows of starting rank $-\infty,\dots, -2,-1.$
  \item For arrows starting at the same level, we list them from right to left.
\end{enumerate}
%to their starting ranks by the order $0,1,\dots,\infty, -\infty,\dots, -2,-1 $,
%i.e., we first successively list arrows of starting rank $0,1,\dots,\infty $ and then list arrows of starting rank $-\infty,\dots, -2,-1.$
%Additionally, for arrows starting at the same level, we list them from right to left.
\end{defn}

A path $P=(b_1,b_2,\dots, b_N)$ is called a general Free path if $b_1+b_2+\cdots+b_{N}  = 0$, and
$P$ is called a general Dyck path if in addition, $b_1+\cdots+b_{i-1}\ge 0$ for all $i$.
Classical Dyck paths of length $2N$ are of type $\{1^N,(-1)^N\}^*$. For a coprime pair of positive integers $(m,n)$, classical rational $(m,n)$-Dyck paths have length $m+n$, and are of type $\{m^n,(-n)^m\}^*$. For a multiset $M=\{b_1,\dots, b_N\}^*$ with $|M|=b_1+\cdots +b_N=0,$ we denote by $\cal D_M$ the set of Dyck paths of type $M$.

\def\sweep{\texttt{sweep}}
\def\osweep{\texttt{Osweep}}
The sweep map $\sweep(D)$ of a Dyck path $D$ is defined concisely as follows: sort the arrows according to their starting ranks, if two arrows have the same starting rank, then
the right arrow comes first. Concatenation of the vectors gives the path $\sweep(D)$. For instance,
the picture of $D=(2, 0, 2, -3, 1,-2)$ is given by the left picture, from which we easily see
that $\sweep(D)=(2, 1, -2, 2, 0, -3)$ is given by the right picture. Note that for the three arrows with starting rank $2$, the right arrow comes first.
%% Figure environment removed

% Figure environment removed

H. Thomas and N. Williams repurposed the main theorem of \cite{Thomas-Williams2014} to prove that modular sweep map
is bijective and then concluded that the sweep map is bijective for general (Free) paths.
In particular, the sweep map is also a bijection for general Dyck paths.
%The amazing result is that this sorting procedure is invertible. In fact the modular sweep map is invertible.

Now let us see the second condition in definition of the sweep map. If it becomes from left to right, then a small example will show that the sweep map is not bijective.
We aim to give a general sweep map called \emph{Order sweep}(\osweep \ for short) and show it is a bijection for general Dyck paths.

%that when we list arrows of starting rank $0$ using the fixed order $\phi$, others from right to left.

In order to define the Order sweep map, we use the following notations.
Let $\phi = (\phi_1, \phi_2, \dots)$ be a sequence of permutations such that $\phi_i \in \mathfrak{S}_i$. We denote by $\phi^{-1} = (\phi_1^{-1}, \phi_2^{-1}, \dots)$ the sequence of inverse permutations of $\phi$.
For a path $P = (b_1, b_2, \dots, b_N)$, let $k$ be the number of arrows starting at rank $0$.

\begin{defn}[\osweep]
The Order sweep map of a path $P$ is obtained by sorting the arrows of $P$ according
to the following two conditions:
\begin{enumerate}
  \item We first successively list arrows of starting rank $0,1,\dots,\infty $ and then list arrows of starting rank $-\infty,\dots, -2,-1.$
  \item For arrows starting at the same level, if they are starting at level $0$, we list them by the order $\phi_k$ $($from left to right$)$; otherwise, we list them from right to left.
\end{enumerate}
\end{defn}

When $\phi_k = k \ k-1 \cdots 2 \ 1$ for all $k$, it reduces to the sweep map.

\begin{theo}\label{t-mainresult}
For any multiset $M$ of integers with $|M|=0$ and any sequence of permutations $\phi = (\phi_1, \phi_2, \dots)$. The order sweep map $\osweep$ is a bijection from general Dyck paths of type $M$ to itself.
\end{theo}


\begin{rem}
 %The order sweep map $\osweep$ is also a bijection from general Free paths of type $M$ to itself and
 It holds true that the length of level vectors can take any non-negative integer values.
\end{rem}

The paper is organized as follows. In this introduction, we have introduced the basic concepts.
In section \ref{s-Balanced tableaux}, we give a better description of the Order sweep map and reduce the inverting Order sweep map to finding an increasing balanced path diagram.
In section \ref{s-IBT}, we describe an algorithm $\VIB$ which can output an increasing balanced path diagram.
The tightness of Algorithm $\VIB$ is given in section \ref{s-VIB} and we construct the algorithm for inverting the Order sweep map.
Finally in section \ref{s-apply}, we give an application that the sweep map is also a bijection for incomplete general Dyck paths.


\section{Balanced increasing path diagram}\label{s-Balanced tableaux}
Like for $(m,n)$-rational Dyck paths, increasing balanced path diagrams play an important role in reverting the Order sweep map.
Let us decompose the Order sweep map for a general Dyck path $D$ with $k$ arrows starting at rank $0$ as follows. See Figure \ref{fig:GenSweep} for an example.
\begin{enumerate}
  \item Use the sweep map order to label the arrows of $D$. That is, if we label the starting points of the arrows whose starting ranks are $0$, then we use the order $\phi_k$; otherwise,
  we label the starting points of the arrows, from bottom to top, and if two points are in the same level, from right to left.
  \item Horizontally shift the arrows so that small labels comes first. Denote this set of arrows by $T=\HIB^{\phi_k}(D)$.
  \item Set $\osweep(D)=P(T)=\VPath(T)$, the V-path of $T$.
\end{enumerate}

% Figure environment removed

The path diagram $T=\HIB^{\phi_k}(D)$ is clearly increasing. It is balanced since $D$ is balanced and horizontal shifts preserve row counts.
\begin{prop}\label{p-VPath2Dyckpath}
  The V-path of an increasing balanced path diagram is a Dyck path.
\end{prop}
\begin{proof}
Let $T$ be an increasing balanced path diagram. Pick any $i$, the picture of $T$ looks like  Figure \ref{fig:VPathDyck},
where the two green lines split the plane into four regions as displayed. We need to show that the total segment count in $A$ and $C$ is nonnegative.
% Figure environment removed

By the increasing hypothesis of the starting ranks of $T$, region $C$ may only have red segments and region $B$ may only have blue segments.
Additionally the balance property of $T$ shows that the total segment count of region $A$ and $B$ is $0$. This forces the segment count of $A$ to be nonnegative. So the total segment count in $A$ and $C$ is nonnegative.
\end{proof}

%Then, we can easy get the following Corollary.
\begin{cor}\label{c-Orderimage}
The Order sweep image of a general Dyck path is a general Dyck path.
\end{cor}

\begin{proof}
This follows by the $\HIB^{\phi_k}$ and Proposition \ref{p-VPath2Dyckpath}.

\end{proof}


Now, we give an algorithm $\HPath^{\phi_k^{-1}}$ for constructing Order sweep map pre-image from an increasing balanced path diagram $T=(D,R)$ of length $N$.

\noindent
Algorithm $\HPath^{\phi_k^{-1}}$:  %\  for constructing Order sweep  pre-image.

\textbf{Input:} An increasing balanced path diagram $T=(D,R)$ of length $N$.

\textbf{Output:} A Dyck path $\bD=\HPath^{\phi_k^{-1}}(T)$.
\begin{enumerate}
\item Set $r_1 = 0$ as the current level and $\n = 0$. Set or update $k$ to be the number of arrows starting at level $0$.

\item For $i$ from $1$ to $N$ do the following.

          If $r_i = 0$ then set $\n = \n+1$. Find the $\phi_k^{-1}(\n)$-th arrow from left to right at level $0$ , say $A_j$;

          Otherwise, find the rightmost unlabeled arrow, say $A_j$, that starts at the current level.

         If no such $j$ exists then go to step 3;

         Otherwise label $A_j$ by $i$, set $\pi(i)=j$, and update the current level as the end rank of $A_{\pi(i)}$.

\item When step 2 stops early with no unlabelled arrow found, then update $T$ by shifting all unlabelled arrows one level down. Erase all labels and go to step 1.

\item If $D=(b_1,\dots, b_N)$, then we call such $T$ \emph{stable} and output $\bD=(b_{\pi(1)},b_{\pi(2)},\dots, b_{\pi(N)})$.
\end{enumerate}

\begin{rem}
In \cite{Rational-Invert}, Garsia and Xin defined the \HPath \ algorithm for constructing  sweep map pre-image which need not use step 3.
This is because the coprime condition $(m,n)=1$ forces every increasing balanced path diagram of type $\{m^n,(-n)^m\}^*$ has to be stable.
Moreover, there is only one arrow with starting rank $0$.
\end{rem}

Here we give an example to show an increasing balanced path diagram and its stable balanced path diagram.

% Figure environment removed
In fact it is independent of $\phi_k^{-1}$ that we determine whether an increasing balanced path diagram is a stable balanced path diagram or not.

The following Proposition implies that increasing balanced path diagrams play a crucial role in
reverting the Order sweep map.

\begin{prop}\label{p-Bcrucialrole}
If $T$ is an increasing balanced path diagram, then Algorithm $\HPath^{\phi_k^{-1}}$ outputs a Dyck path $\bD=\HPath^{\phi_k^{-1}}(T)$ satisfying $\osweep(\bD)=\VPath(T)$.
\end{prop}
\begin{proof}
First we show that step 3 updates $T$ to a new increasing balanced path diagram with $r_1=0$. Suppose step 2 stops at $A_{\pi(i)}$ with end rank $j$ for $i<N$.
Then there is no new arrows starting at rank $j$. We claim that $j=0$ and all arrows starting at rank $0$ are labeled, for otherwise we have (repeatedly) entered $j>0$ as end rank followed by leaving $j$ as a starting rank,
and stopped at $j$ as the end rank of $A_{\pi(i)}$. It follows that the number of arrows end at level $j$ is greater than the number of arrows starting at level $j$.
But these two numbers are equal according to Lemma \ref{l-DifferenceLevelCount} and the hypothesis that $T$ is balanced, or more precisely $c(j)-c(j-1)=0$ for all $j$.

Now the labeled arrows is a Dyck path $A_{\pi(1)}\cdots A_{\pi(i)}$ up to horizontal shifting of the arrows. This implies that the unlabled arrows is also balanced.
Therefore, by shifting all unlabelled arrows one level down, we still have an \emph{increasing} balanced path diagram with $r_1=0$. The increasing property is preserved since
the inequality $r_a\le r_b$ for $a<b$ can only be destroyed when $0< r_a=r_b$ but $A_a$ is labeled and $A_b$ is unlabeled, which contradicts our choice
in Step 2. (Note that the above argument only works when the sweep order for each positive level is from right to left.)

Since step 3 always shifts some arrows downwards, it can not be performed infinitely many times. Therefore, we finally reached the position when performing step 2 on the current increasing balanced path diagram $T$, all the $N$ arrows have been labelled. In other words, it becomes a stable balanced path diagram. This assertion implies that each increasing balanced $T$ will be updated to a unique stable one.
Then setting $\oD=T_{\pi(1)}\cdots T_{\pi(N)}$ clearly gives a Dyck path.  On the other hand, the
increasing balanced path diagram $\HIB^{\phi_k}(\oD)$ obtained from $\oD$ through horizontal shifts is exactly equal to $T$. The increasing property forces the relative order for arrows of different ranks. For two arrows of the same rank $> 0$, $T_{\pi(a)}$ appears to the right of $T_{\pi(b)}$ if $a<b$, and their order is reversed in $\oD$. But in $\HIB^{\phi_k}(\oD)$ their order is also reversed according to their position in $D$.

There is a difference for arrows with starting rank $0$. Assume there are $k$ such arrows in a stable $T$, say $B_1,\dots,B_k$ from left to right. Then
their relative order in $\oD$ is $B_{\phi_k^{-1}(1)},\dots, B_{\phi_k^{-1}(k)}$ from left to right. Now in
$\osweep(\oD)$, the relative order of these arrows becomes $B_{\phi_k(\phi_k^{-1}(1))},\dots, B_{\phi_k(\phi_k^{-1}(k))}$, which is just
 $B_1,B_2,\dots, B_k$. Thus $T$ and $\HIB^{\phi_k}(\oD)$ have to be identical and we have $\osweep(\oD)=\VPath(T)$ as desired.
\end{proof}




\section{The Increasing Balanced path diagram obtained by Vertical Shifting}\label{s-IBT}
Given a general Dyck path $D$, we have reduced to finding an increasing balanced path diagram $T$ such that $\VPath(T)=D$.
This can be achieved by the following algorithm.


\noindent
Algorithm \VIB\ :

\noindent
\textbf{Input:} A path diagram $T(D,R^{(0)})$ weakly above level $0$, where $D$ is a Dyck path in  $\cal D_{M}$,
and $R^{(0)} =(r_1^{(0)},r_2^{(0)},\ldots ,r_{N}^{(0)})$ is any weakly increasing (rank) sequence.

\noindent
\textbf{Output:} An increasing balanced path diagram $T(D,\overline{R})$.

\begin{enumerate}
\item[Step 1]  Starting with $T(D,R^{(0)})$ repeat the following step
until the resulting path diagram is balanced.
\vskip .1in

\item[Step 2]
{ In $T(D,R^{(s)})$,  with  $R^{(s)} =(r_1^{(s)},r_2^{(s)},\ldots ,r_{N}^{(s)}),$  find the lowest row $j$ with $c(j)>0$ and
find the rightmost  arrow that starts at level $j$. Suppose that arrow
starts at $(i,j)$. Move up the arrow one level to construct the tableau  $T(D,R^{(s+1)})$ with $ r_{i}^{(s+1)}= r_{i}^{(s)}+1$
and  $ r_{i'}^{(s+1)}= r_{i'}^{(s)}$ for all $i'\neq i$. If all the row counts are $\le 0$ then stop the algorithm, since all row counts
must  necessarily vanish.}
\end{enumerate}

\addpic[.45\textwidth]{ShiftArrow.pdf}{Shifting up one unit an arrow from  level $a$ to level $b$ will decrease $c(a)$ by 1 and increase $c(b)$ by 1. \label{fig:ShiftArrow}}

Figure \ref{fig:ShiftArrow} shows that we are weakly reducing the number of rows with positive row counts in Step 2.
For a path diagram $T(D,R^{(0)})$ as in Algorithm $\VIB$, let $U$ be the maximal value in set $S = \{r_i^{(0)}+b_i | b_i > 0\} \bigcup \{r_j^{(0)}| b_j < 0\}$. In other words, $U$ is the number of the highest level of the path diagram $T(D,R^{(0)})$ achieving.
It also makes the following key observation evident.
\begin{lem}\label{l-keep-nonnegative}
If  at some point  $c(k)$ becomes $\ge 0$ then for ever after it will never become negative. In particular, since $c(k)= 0$ with $k>U$ for the initial path diagram $T(D,R^{(0)})$ we will have $c(k)\ge 0$ when $k>U$ for all successive path diagrams produced by the algorithm.
\end{lem}
\begin{proof}
%The lemma holds true
This Lemma follows that we only decrease a row count when it is positive.
\end{proof}

We need  to justify the algorithm by using some basic properties which were proved in \cite[Lemma $5$]{Rational-Invert}.
\begin{lem}\label{l-basic-property}
We have the following basic properties.
\begin{enumerate}
\setlength\itemsep{2mm}
\item[$(i)$] { If row $j$ is the lowest with $c(j)>0$ then there is an arrow   that starts at level  $j$. In this situation, we say that we are \emph{working} with row $j$.}

\item[$(ii)$] { The successive rank sequences are  always weakly  increasing.}

\item[$(iii)$]  { If $T(D,R^{(s)})$ has no positive row counts, then it is balanced. Consequently, if the algorithm terminates, the last path diagram is balanced.}
\end{enumerate}
\end{lem}

%%\begin{proof}\
%%
%%\begin{enumerate}\setlength\itemsep{2mm}
%%
%%\item[$(i)$]    By the choice of $j$, we have $c(j)>0$ and $c(j-1)\le 0$. Thus $c(j)-c(j-1)>0$, which by Lemma \ref{l-DifferenceLevelCount}, shows that there is at least one arrow starting at rank $j$.
%%
%%\item[$(ii)$]   Our choice of $i$ in step (2) assures that the next rank
%%sequence remains weakly increasing.
%%
%%\item[$(iii)$]  Since each of our tableaux  $T(D,R^{(i)})$ has the same number of red segments and blue segments, the total sum of row counts of any $T(D,R^{(i)})$ has to be $0$. Thus if $T(D,R^{(i)})$ has no positive row counts, then it must have no negative row counts either, and is hence balanced.
%% \end{enumerate}
%%\vspace{-8mm}% This completes the proof of the lemma.
%% \end{proof}




\begin{proof}[Justification of Algorithm \VIB]
By Lemma \ref{l-basic-property}, we only need to show that the algorithm terminates.
To prove this we need the following auxiliary result.



\begin{lem}\label{l-redcount}
Suppose we are working with row $k$, that is  $c(k)>0$ and $c(i)\le 0$ for all $i<k$. If row $\ell $ has no segments for some $\ell <k$, then in the current path diagram $T(D,R')$, it holds that
\begin{align}\label{e-eq-terminate}
  \sum_{0\le j <\ell } c(j) =0.
\end{align}
\end{lem}

\begin{proof}\hspace{-2cm}\vspace{-1cm}\addpic[.38\textwidth]{EmptyRow.pdf}{When row $\ell$ has no segments, there will be no segments in regions $B$ and  $C$.\label{fig:emptyrow}}
\vspace{.1cm} \hspace{5mm}

The conclusion of this Lemma is different from that in \cite[Lemma 6]{Rational-Invert}, but the proof is very similar.

If there are no segments below row $\ell$ in the current path diagram $T(D,R')$, then the Lemma holds true.
Now, we suppose that $T(D,R')$ has  a segment below row $\ell$, then
let $A$ be the rightmost arrow containing such a segment, starting at column $i$.
Since row $\ell$ has no segments, the starting rank of $A$ must be $\le \ell$. This implies that $i+1<N$ since the arrow starting at level $k$ must be to the right of $A$ (by the increasing property of $R'$).  This given,  the current path diagram could look like in
Figure \ref{fig:emptyrow}, where the two green lines divide the plane into 4 regions, as labelled in the display.


The weakly increasing property of $R'$  implies no starting ranks in  $C$, therefore there are no segments there. Due to the choice of $A$, there can be no segments in $B$ either.
Thus the  (gray) empty row $\ell$  forces no segments within both $B$ and $C$.

Now observe that since $D\in \mathcal D_{M}$, the difference between the number of red segments to the left of column $i+1$ and the number of blue segments to the left of that column must be a non-negative number $s\ge 0$.
However, since $c(j)\le 0$ for all $j\le \ell$ it follows that $c(0)+\cdots +c(\ell-1)\le 0$. Additionally, as regions $B$ and $C$ contain no segments, it follows that $s=c(0)+\cdots +c(\ell-1)\le 0$. This implies $s=0$, i.e., \eqref{e-eq-terminate} holds true.
\end{proof}




 \vskip -.1in
Next observe that since each step of the algorithm increases one of the ranks by one unit, after $K$ steps we will have  $|R^{(K)}-R^{(0)}|=\sum_{i=1}^{N}r_i^{(K)}-\sum_{i=1}^{N}r_i^{(0)} =K$. With this in mind, if the algorithm iterates Step 2 forever, then the maximum rank  will eventually exceed any given integer. In particular, we will reach a point where we are working with row $k$, and $k$ is so large that $k-U$ exceeds the total number $\sum_{i=1, b_i>0}^N b_i$ of red segments.
At this stage, we will have $c(k)>0$ and  $c(j)=0$ for all the $k-U$ values $j=U,U+1,\dots, k-1$.
The reason for this is that we must have $c(j)\le 0$ for all $0\le j < k$ and by Lemma \ref{l-keep-nonnegative} we must also have
$c(j)\ge 0$ for $j\ge U$. Now, by the  pigeon hole principle, there must also be
some $U\le \ell <k$ for which $c^r(\ell )=0$. But then it follows that $c^b(\ell)=c^r(\ell)-c(\ell)=0$, too. That implies that row  $\ell$ contains no segments. Utilizing Lemma \ref{l-redcount}, we obtain equation \eqref{e-eq-terminate}. Therefore, the total row count is given by $\sum_{j\ge 0} c(j) = \sum_{j\ge \ell} c(j) \ge c(k)>0$, a contradiction.

\end{proof}

\def\TR{\widetilde{R}}
\def\tr{\tilde{r}}
\section{The tightness of Algorithm \VIB}\label{s-VIB}
For  two rank sequences $R=(r_1,r_2,\ldots ,r_{N})$ and
$R'=(r_1',r_2',\ldots ,r_{N}')$ let us write $R\preceq R'$ if and only if
we have $r_i\le r_i'$ for all $1\le i\le N$; if $r_i< r_i'$ for at least one $i$
we will write $R\prec R'$. The \emph{distance} of $R$ from $R'$,
will be expressed by the integer
 $$
| R'-R| \, =\, \sum_{i=1}^{N} (r_i'-r_i)=\, \sum_{i=1}^{N} r_i'- \sum_{i=1}^{N} r_i.
$$


Given a general Dyck path $D$, we will
call  the initial starting sequence $R^{(0)}$  \emph{canonical for $D$} if it is minimally weakly increasing such that the corresponding path diagram stays above level $0$. Let $T(D,\TR)$ be the increasing balanced path diagram obtained by Algorithm \VIB \ from $T(D,R^{(0)})$. Then, we have the following theorem.

\begin{theo}\label{t-tight}
If $R$ is any  increasing sequence which satisfies the inequalities
$$
R^{(0)} \preceq R\preceq \TR
$$
then the \VIB \ algorithm with starting path diagram $T(D,R)$
will have as output the rank sequence $\TR$.
\end{theo}

\begin{proof}
If $|\TR-R|=0$, there is nothing to prove. Therefore, we will proceed
by induction on the distance of $R$ from $\TR$.
Now assume the theorem holds for $|\TR-R|=K$.
We need to show that it also holds for $|\TR-R|=K+1$.
Suppose one application of step (2) on $R$ gives $R'$.
We aim to show that $R'\preceq \TR $. This done since $R$ and $R'$ only differ from one unit  we will have $|\TR-R'|=K$ and then the inductive hypothesis would complete the proof.

Thus assume if possible that this step (2) cannot be carried out because it requires increasing by one unit an $r_i=\tr_i$ .
Suppose further that under this  step (2) the level $k$ was the lowest with $c(k)>0$ and thus the arrow $A_i$ was the right most that started at level $k$. In particular this means that $r_i=\tr_i=k$. Since $|  \TR-R|\ge 1$, there is at least one $i'$ such that $r_{i'}<\tr_{i'}$. If $r_{i'}=k'$ let $i'$ be the right most
with $r_{i'}=k'$. Define $R''$ to be the rank sequence obtained by replacing  $r_{i'}$ by
$r_{i'}+1$ in $R$. The row count $c(k')$ is decreased by $1$ and another row count is increased by $1$, so that $c(k)$ in $R''$ is still positive.
Since $|\TR-R''|=K$ the induction hypothesis assures that
the  \VIB \ algorithm will return $\TR$. But then in carrying this out, we have to work on row $k$, sooner or later, to decrease the positive row count $c(k)$. But there is no way the arrow $A_i$ can stop being the right most starting at level $k$, since arrows to the right of $A_i$ start at a higher level than $A_i$  and  are only moving upwards.   Thus the fact that   the  \VIB \  algorithm outputs  $\TR$ contradicts the step (2) applied to $R$ cannot be carried out.
Thus we will be able to lift $A_i$ one level up as needed and obtain the sequence $R'$ obtained by replacing $r_i$ by $r_i+1$ in $R$.
But now  we will have $|\TR-R'|$ =K$ $ with  $R'\prec \TR$. By the inductive hypothesis, the \VIB\ algorithm starting from $R$ will return $\TR$ as desired, completing the proof.
\end{proof}

Now we can describe the algorithm for inverting the Order sweep map with a sequence of permutations $\phi = (\phi_1,\phi_2,\dots)$.

\noindent
Algorithm {\bf InvOSweep} :

\noindent
Input: Dyck path $D$.

\noindent
Output: Dyck path $\oD$ with $\osweep(\oD)=D$.
\begin{enumerate}
\item Find the minimal increasing sequence $R$ such that $T(D,R)$ is increasing and does not go below level $0$.

\item Compute the increasing balanced path diagram $\VIB(T)$, say equal to $(D,\bar R)$.

\item Compute $\HPath^{\phi_k^{-1}}(D,\bar R)$. This is the desired Dyck path $\oD$.
\end{enumerate}

\begin{rem}
 Step 2 indeed gives a stable balanced path diagram so that step 3 in Algorithm $\HPath^{\phi_k^{-1}}$ is not used. However, it might be better to guess a starting $R$ and
do the computation.
\end{rem}

\begin{proof}[Proof of Theorem \ref{t-mainresult}]
It follows by Corollary \ref{c-Orderimage} and Algorithm {\bf InvOSweep}.
\end{proof}


%This theorem justifies our algorithm for inverting rational sweep map. Since we know in advance that the final rank sequence $\bar R$ is increasing and $\bar R_1=0$.
%We can start with the minimal one. At any stage, we known the intermediate $R$ is less than $\bar R$ and so is its strict version, using which also output $\bar R$.

\section{An application}\label{s-apply}

A path encoded by $P^o=(b_1,b_2,\cdots,b_N)$ is called an incomplete Dyck path written by $D^o$ if it has to start at the point $(0,a)$, where
$a$ is equal to $- \sum_{i=1}^N b_i$ and greater than zero, and for all $i$, $a + b_1+ \cdots +b_i \geq 0$ and $a + b_1+ \cdots +b_N = 0$. It is clear to know that its \emph{rank sequence} $R^o=(r_1,r_2,\dots, r_N)$ satisfies the conditions $r_1= a > 0$ and $r_i \geq 0$ for $2 \leq i \leq N$.
Note that if we add a red arrow $A^o$ at the point $(-1, 0)$ where $A^0$ is the vector $(1,a)$, then it becomes a Dyck path
of length $N+1$ starting at $(-1,0)$ and ending at $(N,0)$. So, when we ignore the x-coordinate, an incomplete Dyck path can be
obtained by removing the first step for a general Dyck path of length $N+1$.

In what follows, for a multiset $B=\{b_1,\dots, b_N\}^*$ with $|B|=b_1+\cdots +b_N<0,$  we denote by $\cal D^o_B$ the set of incomplete Dyck paths of type $B$. For an incomplete Dyck path $D^o \in \cal D^o_B$ and its rank sequence $R^o=(r_1,r_2,\dots, r_N)$, if we add a red dashed arrow $(1, r_1)$ before the first step of it, then it will becomes a general Dyck path denoted by $D = \mathcal{A}(D^o)$. We write $D^o = \mathcal{A}^{-1}(D)$.



%that the sweep map is a bijection for general Dyck paths.
We give the following theorem.
\begin{theo}
For any multiset $B$ of integers with $|B|<0$. The sweep map $\sweep$ is a bijection from incomplete Dyck paths of type $B$ to itself.
%the sweep map is also a bijection from  the set $\cal D^o_B$ to itself.
\end{theo}

\begin{proof}
It is a consequence of Theorem \ref{t-mainresult} when permutations $\phi_k = 1\ k \ k-1\ \cdots 2$ for all $k$.
It follows by the following Figure.

% Figure environment removed

\end{proof}

\begin{thebibliography}{99}

\bibitem{sweepmap}
D. Armstrong, N. A. Loehr, and G. S. Warrington, \newblock Sweep maps: A continuous family of sorting algorithms,
\newblock {\em Adv. Math.}, 284(2015), 159--185.

%\bibitem{dinv-def}
%D. Armstrong, N. A. Loehr, and G. S. Warrington, \newblock Rational parking functions and Catalan numbers,
%\newblock {\em Annals Combin.}, 20(2016), no. 1, 21--58.

%\bibitem{qt-Catalan}
%A. M. Garsia and M. Haiman, \newblock A remarkable $q, t$-Catalan sequence and $q$-Lagrange inversion,
%\newblock {\em J. Algebraic Combin.}, 5(1996), no. 3, 191--244.

%\bibitem{dinv-area}
%A. M. Garsia and G. Xin, \newblock Dinv and Area,
%\newblock {\em Electron. J. Combin.}, 24(2017), no. 1, P1.64.

\bibitem{Rational-Invert}
A. M. Garsia and G. Xin, \newblock  Inverting the rational sweep map,
\newblock {\em J. Combin.}, 9(2018), no. 4, 659--679.

\bibitem{Fuss-case}
A. M. Garsia and G. Xin, \newblock On the sweep map for fuss rational Dyck paths,
\newblock {\em Adv. in Appl. Math.}, 116(2020), 101998, 29 pp.

%\bibitem{Gorsky-Mazin}
%E. Gorsky and M. Mazin, \newblock Compactified Jacobians and $q,t$-Catalan Numbers I,
%\newblock {\em J. Combin. Theory Ser. A}, 120(2013), no. 1, 49--63.

\bibitem{Gorsky-Mazin2}
E. Gorsky and  M. Mazin, \newblock Compactified Jacobians and $q,t$-Catalan Numbers II,
\newblock {\em J. Algebraic Combin.}, 39(2014), no. 1, 153--186.

%\bibitem{Hag-book08}
%J. Haglund, \newblock The $q, t$-Catalan numbers and the space of diagonal harmonics, with an appendix on the
%combinatorics of Macdonald polynomials, AMS University Lecture Series, 2008.

\bibitem{Loehr-higher-qtCatalan}
N. A. Loehr, \newblock Conjectured statistics for the higher $q,t$-Catalan sequences,
\newblock {\em Electron. J. Combin.}, 12(2005), Research paper 9, 54 pp.

\bibitem{Thomas-Williams2014}
H. Thomas and N. Williams, \newblock Cyclic symmetry of the scaled simplex,
\newblock {\em J. Algebraic Combin.}, 39(2014), no. 2, 225--246.

\bibitem{Thomas-Williams}
H. Thomas and N. Williams, \newblock Sweepping up zeta,
\newblock {\em Sel. Math. New Ser.}, 24(2018), no. 3, 2003--2034.

\bibitem{Xin-Zhang}
G. Xin and Y. Zhang, \newblock On the Sweep Map for $\vec{k}$-Dyck Paths,
\newblock {\em Electron. J. Combin.}, 26(2019), no. 3, P3.63.
\end{thebibliography}








\end{document}
