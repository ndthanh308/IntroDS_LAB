\section{Hashing with Reals}
\label{sec:R}
% maybe say This is similar to ``Lonely Runner Conjecture" \cite{Tao_2018}

In this section we consider $\LH$ set in $\R$. Formally:
\begin{defin}
  Fix universe size $u\in \N$. As always, we require
  $\Omega(n^{6})\le u \le \poly(n)$ (\cref{rmk:assumesize}). In
  \defn{Blocked real hashing} ($\blockRu$) we randomly select real $a\in
  (0,1)$ and map $x\in [u]$ by 
  $$x\mapsto \floor{\frac{\posmod_1(ax)}{ 1  / n }}.$$ 
  % Strided real hashing $\stride{\R_u}$ is parameterized by a real
  % number $a\in [0,1]$ with hash function 
  % $$x\mapsto \posmod_n(\floor{\posmod_1(ax)}).$$
\end{defin}

One interesting similarity between $\blockRu$ and  $\blockFp$ is
that all $a\in (0,1)$ are invertible modulo $1$ over $\R$ just
as all $a\in \pnozero$ are invertible in $\F_p$. 
In this section we show that $\blockRu$, surprisingly, achieves
intuitively equivalent maxload to the following variant of
$\SLH_m$ with a randomized modulus:
\begin{defin}
  Fix $m\in \N$. In \defn{Random Linear Hashing} ($\RLH_m$) we
  randomly select $k\in [m/2,m]\cap \Z$ and hash with $\SLH_k$'s
  hash function (\cref{defn:slh}).
\end{defin}
\begin{prop}
  % Let $M_{\LH}(m,k)$ denote the worst-case expected maxload of
  % $\block{\Z_k}$.
  $\RLH_m$ has expected maxload at most $$\max_{k\in [m/2,m]\cap
  \Z}  2M_{\SLH}(m,k).$$ 
  % In particular, $\RLH_m$ has expected maxload
  % $n^{1/3+o(1)}$.
\end{prop}
\begin{proof}
  Fix $X$, condition on some $k$. Partition $X$ into 
  $$X_1 = X\cap [k],\;\; X_2=X \cap [k,2k].$$
  The maxload on $X_1,\posmod_k(X_2)\subset [k]$ individually is at most $M_{\SLH}(m,k)$.
  Adding the maxload on $X_1$ and $X_2$ gives an upper bound on the
  total maxload.
 %  The first statement is immediate. The second statement
 % follows from \cref{cor:translate} applied to the first statement.
 % \todo{check}
\end{proof}

Now we connect $\blockRu$ and $\blockZm, \RLH$.
\begin{theorem}
  \label{thm:itisreal}
  % Fix $p,n\in \N$ with $\Omega(n^{4})\le p\leq \poly(n)$, and fix
  % $X\subset [p]$ with $|X|=n$.
  Let $M_{\RLH}$ denote the expected maxload of
  $\RLH_{\floor{\sqrt{nu}}}$ on a worst-case $X\subset
  [\floor{\sqrt{nu}}]$, let $M_{\max}$ denote the maximum over
  $t\in (\sqrt{u}, nu]\cap \Z$ of the expected maxload
  of $\SLH_t$ for worst-case $X\subset [t]$. Let $M_\R$ denote
  the expected maxload of $\blockRu$ for worst-case $X\subset
  [u].$ Then, 
  $$ \Omega\paren{\frac{M_{\RLH}}{\log\log n}} \le M_\R \le \bigO(M_{\max}).$$
\end{theorem}
The link between integer hashing and real hashing begins to
emerge in the following lemma:
\begin{lemma}\label{lem:restrictQ}
  Fix $k\in \N$. Assume $a=c/k$ for random $c\in \Z_k^{\times}$ and take
  $X\subset [u]$. $\blockRu$ conditional on such $a$ achieves
  the same maxload on $X$ as hashing $X$ with $\SLH_k$'s hash
  function using multiplier $c$.
\end{lemma}
\begin{proof}
  % The function $\tilde{h}(x)= \posmod_1(x\cdot a)$ has period $k$ because
  % $\posmod_1(k\cdot c /k) = 0$. Furthermore, for $i\in [k]$ we
  % have $\posmod_1(ic/k) = \posmod_k(ic)/k$.
  For any $x\in [u]$ the value $\posmod_1(xc/k)$ is an integer multiple of
  $1/k$. In particular, $\blockRu$ places $x$ in bin
  \begin{equation}\label{eq:thatbin}
  \floor{\frac{\posmod_1(x c/k)}{1/n}} = \floor{\frac{\posmod_k(x c)}{k/n}}.
  \end{equation}
  $\SLH_k$'s hash function places $x$ in the same bin
  as \cref{eq:thatbin}.
\end{proof}

In isolation \cref{lem:restrictQ} is not particularly useful
because $a\in \Q$ occurs with
probability $0$. However, in \cref{clm:approxepx} we show that if
$a$ is very close to a rational number then we get approximately
the same behavior as in \cref{lem:restrictQ}.

  \begin{lemma}\label{clm:approxepx}
    Fix $k\in [nu]_{\setminus{0}}$.
    Let $a = c/k+\eps$ for coprime $c,k\in \N$ and $\eps <
    \frac{1}{nu}$. Let $a'=c/k$.
    The maxload achieved by $\blockRu$ using $a$ and
    $a'$ differ by at most a factor-of-$2$.
  \end{lemma}
  \begin{proof}
    For any $i\in [u]$, $\eps\cdot i< 1/n$, where $1/n$ is the ``bin
    width", i.e., the size of a sub-interval of $(0,1)$ which
    corresponds to a single bin after multiplication by $n$ and
    flooring.
    Thus, $ai$ and $ai'$ either land in the same bin or $a'i$
    lands in the bin directly after the bin of $ai$.
    Say that bin $j$, a fullest bin for $a$, has $M$ elements. 
    Then, either bin $j$ or bin $\posmod_n(j+1)$ has at least
    $M/2$ elements for $a'$.
    If bin $j'$, a fullest bin for $a'$, has $M'$
    elements then either bin $j'$ or bin $\posmod_n(j-1)$ has at
    least $M'/2$ elements for $a$.
  \end{proof}
  All ${a\in (0,1)}$ will be within $\frac{1}{nu}$ of some $a'\in
  \Q$, and in particular some fraction with denominator at most $nu$.
  This motivates the following definition:

  \begin{defin}\label{defn:fclaims}
    For $k\in [nu+1]$ we define ${I(k) \subset (0,1)}$ to be the
  set of ${a\in (0,1)}$ which are at most $\frac{1}{nu}$ larger
  than some reduced fraction with denominator $k$. That is,
  $$I(k) = \bigcup_{c\in \Z_k^{\times}} \paren{c/k +
  \left[0,\frac{1}{nu}\right]} \cap (0,1).$$ We say that $k$
  \defn{claims} the elements of $I(k)$. 
  For $a\in (0,1)$ let $f(a)$ denote the fraction $c/k$ of
  smallest denominator for which $k$ claims $a$, i.e., $a\in
  I(k)$. 
  For $a\in I(k)$ we say that  $k$ \defn{obtains} $a$ if $f(a)=k$
  and we say that  $a$ is \defn{stolen} from $k$ if $f(a)<k$.
  % Clearly 
  % $$\setof{a\in (0,1)}{f(a)=k} \subseteq I(k).$$
\end{defin}

Intuitively $f(a)=k$ means that $a$ behaves like integer hashing
with modulus $k$. Thus, to obtain bounds on $M_\R$ we seek to
understand $f$.
  \begin{lemma}\label{clm:prdistrunderstand}
    For $k\le \floor{\sqrt{nu}}$, 
    $$\Pr[f(a)=k] = \frac{\phi(k)}{nu}.$$
    % Furthermore, 
    % $\Pr[f(a) < \sqrt{nu}] \ge 0.3$ \\
    % and $\Pr[f(a)>nu] = 0$. 
  \end{lemma}
  \begin{proof}
    Immediately from \cref{defn:fclaims}
    \begin{equation}\label{eq:fakprub}
  \Pr[f(a)=k]\le |I(k)| = \frac{\phi(k)}{nu}.
    \end{equation}
  % because there are $\phi(k)$ fractions
  % $c/k$ with $c\perp k$, each of which has an interval of size
  % $\frac{1}{nu}$ in which 
  % which correspond to
  % disjoint intervals of length $\frac{1}{nu}$ in $[0,1]$
  % containing the numbers close to fractions of denominator $k_0$. 
For distinct $k_1,k_2\le \floor{\sqrt{nu}}$ and appropriate numerators
$c_1,c_2$ 
we have
\begin{equation}
  \label{eq:disjointdudes}
\abs{\frac{c_1}{k_2}-\frac{c_2}{k_1}}>\frac{1}{nu}
\end{equation}
because $k_1k_2 < nu$ while $c_1k_2-c_2k_1
\in \Z\setminus\set{0}$.
\cref{eq:disjointdudes} means that for any $k\le
\floor{\sqrt{nu}}, a\in I(k)$, $a$ will not be stolen from $k$,
because all different fractions of denominator $k'<k$ are
sufficiently far away from all reduced fractions of denominator
$k$. In other words,
\begin{equation}\label{k1k2disjoint}
  I(k_1) \cap I(k_2) = \varnothing.
\end{equation}
\cref{k1k2disjoint} implies that \cref{eq:fakprub} is tight for $k\le
\floor{\sqrt{nu}}$, which gives the desired bound on $\Pr[f(a)=k]$.
% Furthermore, using the well-known value for the sum of $\phi(k)$
% (\cite{hardy1979introduction}) we have
% $$\lim_{m\to \infty} \sum_{k<\sqrt{m}} \frac{\phi(k)}{m}
% = \frac{3}{\pi^2}>0.3,$$
% so $\Pr[f(a)< \sqrt{nu}] \ge 0.3$ (by
% \cref{rmk:assumesize} where we assume $n$ to be at least a
% sufficiently large constant).

% We also note that $f(a)>nu$ is impossible, because any $a\in
% [0,1]$ is within $\frac{1}{nu}$ of a fraction with denominator
% $nu$. 
  \end{proof}

  Using \cref{clm:prdistrunderstand} and the sum
  (\cite{hardy1979introduction}) 
  $$\lim_{m\to \infty} \sum_{k<\sqrt{m}} \frac{\phi(k)}{m} = \frac{3}{\pi^2},$$ 
  we find that $f(a) \in \Theta(\sqrt{nu})$ with probability
  $\Omega(1)$. Intuitively this already ensures $\blockRu$
  behaves similarly to $\RLH$. We formalize this in the following
  bound:
% so $\Pr[f(a)< \sqrt{nu}] \ge 0.3$ (by
% \cref{rmk:assumesize} where we assume $n$ to be at least a
% sufficiently large constant).
\begin{cor}
  \label{cor:lb}
  % Let $M_\R, M_{\RLH}$ denote the expected maxloads
  % from the theorem statement. We have
  $$M_\R \ge \frac{M_{\RLH}}{20\log\log n}.$$
\end{cor}
\begin{proof}
  Using \cref{fact:toitent} on \cref{clm:prdistrunderstand} for
  integer ${k\in [\floor{\sqrt{nu}}/2, \floor{\sqrt{nu}}]}$ gives
  \begin{align}
    \Pr[f(a)=k] &\ge \frac{1}{nu}\frac{\floor{\sqrt{nu}}/2}{2
    \log\log (\floor{\sqrt{nu}}/2)} \\
                &\ge \frac{1}{\floor{\sqrt{nu}}} \cdot \frac{1}{5\log\log
                n}\label{eq9999},
  \end{align}
  where the simplification in \cref{eq9999} is due to the
  asymptotic nature of our analysis (\cref{rmk:assumesize}).
  Fix ${X\subset [\floor{\sqrt{nu}}]\subset [u]}$. We make two observations:
  \begin{itemize}
    \item Each modulus $k \in [\floor{\sqrt{nu}}/2,
      \floor{\sqrt{nu}}]\cap \Z$ is selected by
      $\RLH_{\floor{\sqrt{nu}}}$ with probability
      $2/\floor{\sqrt{nu}}$ which is at most $10 \log\log n$
      times larger than $\Pr[f(a)=k]$. \item Conditional on
      $f(a)=k$ $\blockRu$ achieves expected maxload at least
      $1/2$ of the expected maxload of $\RLH_{\floor{\sqrt{nu}}}$
      conditional on $\RLH$ having modulus $k$; this follows by
      combining \cref{clm:approxepx} and \cref{lem:restrictQ}. 
  \end{itemize}
  Combining these observations gives the desired bound on
  $M_\R/M_\RLH$.
\end{proof}

Now we aim to show an upper bound on $M_\R$.
\cref{clm:approxepx} combined with \cref{lem:restrictQ} show
that $\blockRu$ is equivalent to using the $\SLH$ hash function
but with a modulus chosen according to some probability
distribution $f$; we call $f(a)$ the \defn{effective integer
modulus}.
However, the distribution $f$ of the effective integer modulus is
very different from the distribution of moduli for $\RLH$. One
major difference is that in $\RLH_m$ the randomly selected modulus is always
within a factor-of-$2$ of the universe size $m$. However, in
$\blockRu$ the effective integer modulus is likely of size
$\Theta(\sqrt{nu})$ which is much smaller than the universe
size $u$. A priori this might be concerning: could some choice
of $X$ result in many items hashing to the same bin by
virtue of being the same modulo the effective integer modulus?
Fortunately, \cref{lem:nothingcollides} asserts that this is quite unlikely. 
Before proving \cref{lem:nothingcollides} we need to obtain more
bounds on $f$. To obtain more bounds of $f$ we make use of \defn{Farey
Sequences} (see \cite{hardy1979introduction}).

\begin{defin}
  For $k\in \N$, a \defn{$k$-fraction} is some rational $c/k \in
  [0,1]$ with $c\in \Z, c\perp k$.
  For $m\in \N$, the \defn{$m$-Farey sequence} $\mathfrak{F}_m$
  is the set of all $k$-fractions for
  all $k\le m$ listed in ascending order.
  For example $\mathfrak{F}_5$ is the sequence
  $$\frac{0}{1}, \frac{1}{5}, \frac{1}{4}, \frac{1}{3}, \frac{2}{5}, \frac{1}{2}, \frac{3}{5}, \frac{2}{3}, \frac{3}{4}, \frac{4}{5},
  \frac{1}{1}.$$
\end{defin}

A fundamental property of the Farey sequence concerns the
difference between successive terms of the sequence (proved in
chapter 3 of \cite{hardy1979introduction}).
\begin{fact}\label{fact:fareydist}
  Fix $m\in \N$. Let $c/k, c'/k'$ be adjacent fractions in
  $\mathfrak{F}_m$.
  Then 
  $$\abs{\frac{c}{k} - \frac{c'}{k'}} = \frac{1}{kk'}.$$
\end{fact}

We further classify the neighbors of Farey fractions in the
following lemma:
\begin{lemma}\label{lem:fareyneighbors}
  Fix $m\in \N$. Let $S$ be the set of successors of
  $m$-fractions in $\mathfrak{F}_m$. 
  For each $\ell\perp m$, there is precisely one $\ell$-fraction in
  $S$. For $\ell\not\perp m$ there are no $\ell$-fractions in $S$.
\end{lemma}
\begin{proof}
  Fix $\ell\in [m], \ell\perp m$.
  Then, the equation $\ell i\equiv 1\mod m$ has a solution $i\in
  \Z_m^{\times }$. Let $\lambda \in \N$ so that $i\ell = \lambda m
  + 1$. Then,
  $$\frac{i}{m} = \frac{\lambda}{\ell}+\frac{1}{m \ell}.$$
  By \cref{fact:fareydist} the successor of $\frac{\lambda}{\ell}$ is at
  least  $\frac{1}{m \ell}$ larger than $\frac{\lambda}{\ell}$. Hence,
  there are no fractions in $\mathfrak{F}_m$ between
  $\lambda/\ell$
  and  $i/m$. That is,  $i/m$ is the successor of $\lambda/\ell$.
  However, there are only $\phi(m)$  $m$-fractions in
  $\mathfrak{F}_m$ and we have already identified  $\phi(m)$
  distinct fractions as successors of $m$-fractions. So for $\ell\not\perp k$
  there are no $\ell$-fractions in $S$.
\end{proof}

Now analyze $\Pr[f(a) = k]$ using Farey sequences.
\begin{lemma}\label{lem:fareyopfak}
  $$\Pr[f(a)=k]\leq \bigO\paren{\frac{1}{\sqrt{nu}}}.$$
\end{lemma}
\begin{proof}
  For $k\le \floor{\sqrt{nu}}$ the conclusion is immediate by
  \cref{clm:prdistrunderstand}. Fix integer $k\ge \sqrt{nu}$.
  To bound the measure of $\setof{a\in (0,1)}{f(a)=k}$ we can
  take the measure claimed by $k$ and subtract the measure
  stolen by any $k'<k$.

  % Recall from \cref{defn:fclaims} that $f(a)=k$ exactly when a
  % $k$-fraction claims $a$ but not $i$-fraction for $i<k$ claims
  % $a$. Thus, to bound $\Pr[f(a)=k]$ we consider the
  % area claimed by $k$ minus the area claimed by both $k$ and some
  % other fraction in $\mathfrak{F}_{k}$. We refer to area claimed
  % by both a $k$-fraction and some $i$-fraction for $i<k$ as
  % \defn{stolen} area, and the area claimed by some $k$-fraction
  % but no $i$-fraction for $i<k$ as \defn{obtained}. 

  Fix a $k$-fraction $c/k$. The interval touching $c/k$ claimed
  by $k$ is $c/k+[0,1/(nu)]$.
  The amount of this interval which is stolen is determined by
  the distance from $c/k$ to $c/k$'s successor in $\mathfrak{F}_k$.
  Let $i<k$ denote the denominator of $c/k$'s successor.
  As depicted in \cref{fig:fareypf} there are two cases:
  \begin{itemize}
\item If the successor is close to $c/k$ then all but
  $\frac{1}{ik}$ of the area is stolen, where $\frac{1}{ik}$ is
  the distance to the successor by \cref{fact:fareydist}.
  \item If the successor of $c/k$ occurs after distance more than
  $\frac{1}{nu}$ then it will not steal any area. 
  \end{itemize}

  % Figure environment removed

  Now, we bound the measure obtained by $k$ by summing over the two
  cases represented in \cref{fig:fareypf}.
  \begin{align}
    \Pr[f(a)=k] &\le\frac{nu}{k} \cdot \frac{1}{nu} + \sum_{i=
    \floor{nu/k}}^k \frac{1}{ik} \\
                &\le \paren{1+\ln \paren{\frac{k^2}{nu}}}
                \frac{1}{k}.\label{eq:lnudk2}
  \end{align}
  Let $k=\alpha\sqrt{nu}$ for some $\alpha\ge 1$. 
  Using $\alpha$ in \cref{eq:lnudk2} gives:
  $$\frac{1+2\ln\alpha}{\alpha} \cdot \frac{1}{\sqrt{nu}} \le
  \bigO\paren{\frac{1}{\sqrt{nu}}},$$
  the desired bound on $\Pr[f(a)=k]$.
  
\end{proof}

Now we are prepared for the following lemma:
\begin{lemma}\label{lem:nothingcollides}
  With probability at least $1-1/n$ all
  pairs $x,y\in X$ with $x\neq y$ satisfy 
  $$x\not\equiv y \mod f(a).$$
\end{lemma}
\begin{proof}
  Take distinct $x,y\in X$. We say $x,y$ \defn{collide} if
  $x\equiv y \bmod f(a)$. If $x,y$ collide we must 
  have ${f(a) \mid (x-y)}$. By \cref{fact:numdivs}, $x-y$ has at most
  $u^{o(1)}$ divisors. By \cref{lem:fareyopfak} $f(a)$ will be one
  of these divisors with probability at most
  $u^{o(1)}/\sqrt{nu}$. That is, $x,y$ collide with probability
  at most $u^{o(1)}/\sqrt{nu}$.

  By linearity of expectation the expected
  number of pairs $x,y$ which collide $\bmod \;f(a)$ is at most
  $$\frac{\binom{n}{2}u^{o(1)}}{\sqrt{nu}} \le
  \frac{n^{2}n^{o(1)}}{n^{7/2}} \le \frac{1}{n^{3/2-o(1)}} \le
  \frac{1}{n},$$ 
  which we have simplified using \cref{rmk:assumesize}.
  The number of colliding pairs is a non-negative
  integer random variable. Thus, by Markov's inequality the
  probability of having at least $1$ collision is at most $1/n$.
  Equivalently, with probability at least $1-1/n$ there are $0$
  colliding pairs.
\end{proof}

\begin{cor}\label{cor:ub}
  % For $M_\R,M_{\max}$ from the theorem statement we have
$$M_\R \le \bigO(M_{\max}).$$
\end{cor}
\begin{proof} If the effective integer modulus of $\RLH$ is very
  small then $\RLH$ may perform quite poorly. Luckily, $f(a)$ is
  likely not too small. By \cref{clm:prdistrunderstand} we have
  $$\Pr[f(a) \le \sqrt{u}] \le \sum_{k\le \sqrt{u}}\frac{k}{nu}
  \le 1/n,$$
  so the contribution to $M_\R$ of $a$ with $f(a)\le \sqrt{u}$ is
  $\bigO(1)$. Thus, it suffices to consider $f(a) \in (\sqrt{u},
  nu]$. 
  Fix $X\subset [u]$, and condition on $f(a)=k$ for some $k$.
  By \cref{clm:approxepx} and \cref{lem:restrictQ} the expected
  maxload of $\blockRu$ on  $X$ is at most twice the expected
  maxload if we hash $X$ with $\SLH_k$'s hash function. 
  Furthermore, by \cref{lem:nothingcollides} the expected maxload
  of hashing $X$ with $\SLH_k$'s hash function is the same as the
  expected maxload of using $\SLH_k$ on $\mod_k(X)\subset [k]$.
  This yields the desired bound on $M_\R$.
\end{proof}

Together \cref{cor:lb} and \cref{cor:ub} prove \cref{thm:itisreal}.
% \begin{rmk}
%   Morally speaking, \cref{thm:itisreal} says that $\blockRu$ is
%   equivalent to $\RLH_{\sqrt{un}}$, up to low-order factors.
% \end{rmk}
% \begin{cor}
%   Hashing $x_1,\ldots, x_n$ which are chosen independently and
%   uniformly randomly from $[p]$ using $\block{\R_p}$ gives
%   maxload  $\Theta(\log n / \log\log n)$.
% \end{cor}
As a bonus, applying \cref{thm:Zm1_3} to \cref{thm:itisreal} gives:
\begin{cor}
The expected maxload of $\blockRu$ is $$\widetilde{\bigO}(n^{1/3}).$$
\end{cor}

