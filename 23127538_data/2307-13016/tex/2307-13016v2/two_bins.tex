\section{Two Bins}
\label{sec:twobins} 
In this section we consider the simplest possible setting for
$\LH$: hashing $n$ items to $2$ bins. 
One motivation for studying $\LH$ in the $2$-bin case is hope
that analysis of $\LH$ for $2$-bins is helpful in analyzing
$\LH$ for $n$ bins. We propose one possible such reduction:
\begin{question}[Reduction to Two Bins]
  \label{question:reductiontwobins} Is it possible to obtain a
  bound of $n^{o(1)}$ on $\LH$'s maxload in the $n$-bin setting
  by first establishing a strong concentration bound on $\LH$'s
  maxload in the $2$-bin setting and then recursively applying
  this bound to subsets of bins?
\end{question}

In order for the technique in \cref{question:reductiontwobins} to
succeed, it would be helpful to establish a Chernoff-like
concentration bound on maxload, such as:
\begin{conj}\label{conj:reductiontwobins}
  For $k\in \Theta(1)$, $\ULH$ incurs
  maxload larger than $n/2+k\sqrt{n}$ with probability at most
  $$2^{-\Theta(k^2)}+1/p.$$
\end{conj}

As partial progress towards \cref{conj:reductiontwobins} we
analyze the expected maxload of $2$-bin $\LH$. By Markov's
inequality a bound on expectation also implies a polynomial
strength concentration bounds (rather than exponential as in
\cref{conj:reductiontwobins}) on $\LH$'s maxload.
Formally, our hash function is defined as follows:
\begin{defin}
  Let $p\in \PRM$. In \defn{Multiplicative Two Bin} $\LH$
  ($\MLH$) we choose random $a\in \pnozero$ and place $x\in
  [p]$ in bin 
  $$\floor{\frac{\modp(ax)}{p/2}} \in \set{0,1}.$$
\end{defin}
% \begin{rmk}\label{rmk:shiftmatterstwobins}
%   Regardless of the number of bins, the difference between the
%   maxload achieved by $\LH$ with and without the shift term
%   ``$+b$" will not be more than a factor-of-$2$. Thus, when the
%   number of bins is $n$, the difference between these two methods
%   is fairly insignificant. 
%   However, in the $2$-bin case the maxload
%   is always between $n/2$ and $n$, so a factor-of-$2$ difference
%   would be quite substantial. Thus, analyzing $\ULH$ will not
%   give any non-trivial bound on the maxload of $\MLH$.
%   However, $\MLH$ is simpler in the sense that it has a single
%   parameter, and in some ways more natural. Thus, it is
%   interesting to understand its behavior.
% \end{rmk}


% \todo{potentially add a prop: Omega sqrt n log n}
% \begin{prop}\label{prop:lowerboundtwobins}
%   Two bins $\Omega(\sqrt{n})\log n$
% \end{prop}
% \begin{proof}
%   Let $X = \set{1,3,5,\ldots,2n-1}$
% no this is tricky?
% \end{proof}

% We now establish \cref{thm:dontneedb}, the analogue of
% \cref{prop:pairwise_concentrate} for $\MLH$. It is
% interesting that we can obtain a similar bound with the simpler
% hash function and without pairwise independence. 
% In fact, this prompts the following question:
% \begin{question}[Triple Collisions]
%   Although $\MLH,\ULH$ do not exhibit $3$-wise independence,
%   it may be possible to bound the degree to which they fail to be
%   $3$-wise independent, in a manner similar to how we bound the
%   overlap in the proof of \cref{thm:dontneedb}.
%   Analysis of colliding trios, or higher numbers of elements,
%   could potentially help give stronger bounds on maxload. However
%   this seems quite challenging.
% \end{question}

We will prove
\begin{theorem}\label{thm:dontneedb}
  $\MLH$ has expected maxload at most
  $$n/2+\bigO(n^{7/8}).$$
\end{theorem}
As noted in the introduction it is easy to see that a pairwise
independent hash family, such as $\LH$ with the shift term,
achieves expected maxload $n/2+\bigO(\sqrt{n})$.
However, pairwise independence alone is certainly not sufficient to
achieve an $n^{o(1)}$ bound on $\LH$'s maxload in the $n$-bin
case. Thus, beyond being intrinsically motivated as an
interesting question, \cref{thm:dontneedb} is motivated as progress towards
\cref{question:reductiontwobins}.

The proof of \cref{thm:dontneedb} uses the standard technique of analyzing the expected
number of \defn{collisions}, i.e., pairs of elements that hash to
the same bin. However, without pairwise independence computing
the expected number of collisions is challenging. 
In fact, some elements collide with probability much
larger than $1/2$. For instance, $1$ and $3$ collide with probability
$2/3$ as depicted in \cref{fig:13overlap-png}.
  % Figure environment removed
  More generally for any small integer $k$, $1$ and $2k+1$ will
  collide with probability approximately $(k+1)/(2k+1) > 1/2$.
  If small odd numbers were the only numbers with probability
  much larger than $1/2$ of colliding with $1$ then the analysis
  would be fairly easy. However, there can be other numbers which
  are very likely to collide with $1$. For instance, imagine
  $x\in[p]$ satisfies  $3x\equiv 1 \mod p$. Then $1$ and $x$ also
  have an approximately $2/3$ chance of colliding.

  Our bound on the expected number of collisions intuitively
  works as follows: for any particular element $x\in [p]$ there
  are very few $y\in [p]$ where $x,y$ collide with probability
  much larger than $1/2$. By symmetry (or more precisely the
  existence of multiplicative inverses in $\F_p$), it does not
  matter which $x$ we choose to compare with. So it will suffice
  to analyze the probability of elements $y$ colliding with
  $x=1$. 

  For sake of combinatorics we work with the following
  transformed version of collision probabilities:
  \begin{defin}
    The \defn{overlap} of $x\in [p]$ is the number of $a\in
    \halfp$
    such that  $1,x$ collide.
    Equivalently, the overlap of $x$ is the number of $a\in \halfp$ where
    $$\modp(ax) < p/2.$$
    The \defn{excess overlap} of $x$, denoted $\lap(x)$, is the
    overlap of $x$ minus $p/4$.
    The \defn{contribution} of a set ${A\subset \halfp}$ to $\lap(x)$ 
    is the difference between the number of $a\in A$
    with $\modp(ax) <p/2$ and the number of  $a\in A$ with
    $\modp(ax) > p/2$.

    We will bound $\lap(x)$ by partitioning $\halfp$ into
    disjoint subsets $A_1,A_2,\ldots$ and summing the
    contributions of each $A_i$ to $\lap(x)$.
  \end{defin}


  % We proceed to derive bounds on $\lap(x)$ as a function of $x$,
  % and eventually use these to obtain bounds on $\sum_{x\in X}\lap(x)$.
%   First, we give a simple bound that highlights the general
%   technique required.
%   \begin{claim}
%     \label{clm:smallx}
%     $$\lap(x)\le \bigO(x+p/x).$$
%   \end{claim}
%   \begin{proof}
%     We group elements into \defn{stacks} consisting of $p/x$
%     contiguous elements each. A stack is a set of contiguous
%     elements that don't experience overlap.
%     We get $\pm 1$ error per stack, yielding a
%     total of $x$ error, plus $p/x$ error for the final ascent.
%   \end{proof}
%   \cref{clm:smallx} is fairly tight for small $x$; as hinted by
%   \cref{fig:13overlap-png} small (odd) $x$ achieve maxload
%   $\Theta(p/x)$. 
%   The $x$ in \cref{clm:smallx} is generally quite weak, but
%   there are some $x>p/n$ with very large maxload.
%   This generally happens if $x$ wraps around to a small number
%   quickly. This suggests that we need a better way of grouping
%   the elements. The following lemma, which is a beautiful
%   elementary fact of number theory, gives such a method.
%   \begin{lemma}\label{clm:beautifulparameterization}
%     For each $x\in [p]$, there exists $m\in [n]$ and $k\in
%     [\ceil{p/n}]$ such that 
%     $$xm\equiv k \mod p.$$
%     Furthermore, this $m,k$ uniquely characterize $x$.
%   \end{lemma}
%   \begin{proof}
%     One way is you could take $x=p/c$ and look at the
%     wrap-around points. Balance stuff. After $w$ wraparounds
%     you get size like $x/w$.
%     \todo{formalize this}

%     Note that $m^{-1}k$ (where $m^{-1}$ denotes the
%     multiplicative inverse of $m$ modulo $p$) can take on at
%     most $n\cdot \ceil{p/n}$ values, because  $m\in [n],k\in
%     [\ceil{p/n}]$. However, we associated an $m,k$ pair with
%     all elements of $[p]$ thus they are unique. \todo{actually
%     this doesn't quite make sense, for divisibility reasons. I
%   only really care about injective, not surjective.}
%   \end{proof}

%   Now that we have shown all $x$ are of the form described in
%   \cref{clm:beautifulparameterization},  we use this form to
%   give a more accurate bound on $\lap(x)$. 
%   \begin{lemma}\label{lem:therightlens}
%     \todo{put a floor/ceiling on all the fractions everywhere!}
%     Let $m\le n$ be the smallest $m$ such that $\modp(xm)\le
%     p/n$, and let  $k=\modp(xm) \le p/n.$
%     Then, $$\lap(x)\le \bigO\left(\frac{p}{km} + k + m\right).$$
%   \end{lemma}
%   \begin{proof}
%     It may be helpful to refer to \cref{fig:epic_lemma} for
%     understanding of the terminology used in this lemma.
%     % Figure environment removed

%     Define the $(i,j)$-th \defn{full line} as
%     $$L_{i,j} = i + \frac{mp}{k} \cdot j + m[p/k]$$ for $i\le m,
%     j\le \frac{k}{2m}.$
%     \begin{claim}\label{clm:fullline}
%       Each full line contributes $\bigO(1)$ to $\lap(x)$.
%     \end{claim}
%     \begin{proof}
%       Fix a full line $\delta + m[p/k]$. The image of
%       $\delta+m[p/k]$ under multiplication by $x$ modulo $p$ is:
%       $$\modp(\delta x), \modp((\delta+m)x),
%       \modp((\delta+2m)x),\ldots.$$
%       Let $\delta' = \modp(\delta x)$. Because  $\modp(mx) = k$
%       we can re-express the image as:
%       $$\delta',\delta'+k,\delta'+2k,\ldots, \delta'+k\floor{p/k}.$$
%       \todo{I am just making up the floors / ceilings at the
%       moment, plz fix sometime}

%       In other words, the image of the full line consists of
%       $\floor{p/k}$ points, which are evenly spaced out, with
%       space $k$ between the points. Thus, we will have
%       $\floor{p/k}/2 \pm \bigO(1)$ above and below the line. In
%       other words, the full line contributes at most $\bigO(1)$
%       to  $\lap(x)$.
%     \end{proof}

%     The full lines take of all but up a suffix of $[p/2]$ of size
%     at most $m\floor{p/k}$. Let $s$ be the start of this suffix.
%     We partition this suffix into
%     $m$ \defn{partial lines}, with the $i$-th partial line
%     defined as:
%     $$P_i = \paren{s+i+m[p/k]} \cap [p/2].$$
%     Unlike full lines, the partial lines need not lie half above
%     and half below $p/2$ (because they may be cut off part-way
%     through).
%     We now further partition the partial lines.

%     The $i$-th \defn{stack} is 
%     $$S_i = \paren{s+im+[m]}\cap [p/2].$$
%     We say stack $S_i$ is \defn{full} if  $|S_i| = m$, and
%     \defn{partially-full} if $0<|S_i|<m$.
%     The $i$-th \defn{chunk} is
%     $$C_i = \bigcup_{j \in i\frac{p}{km}+[\frac{p}{km}]} S_{j}.$$
%     Chunk $C_i$ is a \defn{full chunk} if $|C_i| = p/k$.
%     The \defn{final chunk} is the final non-empty $C_i$; this
%     chunk is the only non-empty but not-necessarily-full chunk.
%     A \defn{line-chunk} is the restriction of a partial line to a
%     particular chunk.

%     \begin{claim}\label{clm:fullchunk}
%       Each full chunk contributes $\bigO(1)$ to $\lap(x)$.
%     \end{claim}
%     \begin{proof}
%       Each stack in a full chunk consists of $m$ contiguous
%       indices. By virtue of the minimality condition on $k$ in the lemma
%       statement, distinct $x,y$ in the same stack are separated
%       by distance at least $p/n$. In particular, \todo{ohh this
%       is tricky}
%       \todo{hmm,I'm not really sure this is true. it certainly
%       seems difficult to prove\ldots}
%       \begin{case}
%         $m$ is odd. \\
%         \todo{justify all of this}
%         By construction the line-chunks within a chunk all reside
%         in disjoint contiguous sub-intervals of $[p]$. Thus,
%         there is exactly one line-chunk which crosses $p/2$. 
%         There are $(m-1)/2$ line-chunks above and below $p/2$, so
%         these contribute $0$ to $\lap(x)$.
%         The line-chunk which crosses $p/2$ is above and below
%         $p/2$ for half of the time, with $\pm 1$ error, so it
%         contributes $\pm 1$ to $\lap(x)$.
%       \end{case}
%       \begin{case}
%        $m$ is even. \\
%        \todo{justify this:}
%        There are $m/2$ line-chunks above and below $p/2$, except
%        for one line-chunk barely touches $p/2$, but overall this
%        only causes a $\pm 1$ contribution to $\lap(x)$.
%       \end{case}
%     \end{proof}
%     \begin{claim}\label{clm:finalchunk}
%       The contribution of the final chunk to $\lap(x)$ is at most 
%       $$\bigO\left(\frac{p}{km}+m\right).$$
%     \end{claim}
%     \begin{proof}
%       The final chunk consists of at most $\frac{p}{km}$ points
%       per partial line, so in particular each line travels
%       distance at most $p/m$. 
%       This means that only $\bigO(1)$ partial lines cross $p/2$.
%       We can pair up all the non-crossing partial lines, with one
%       left over if there are an odd number. All of these lines
%       will consist of the same number of full stacks $\pm 1$,
%       along with a partial stack. We pay $\bigO(m)$ for the
%       partial stack, and  $\frac{p}{km}$ for the segment of the
%       final un-paired partial line lying in the final chunk.
%       Finally, we pay an additional $\frac{p}{km}$ for the
%       partial line which crosses $p/2$.
%       \todo{so this, like the thing above, relies on an unproven,
%       and frankly unlikely to be true, assertion that each full stack
% has a contribution of $\pm \bigO(1)$ to the excess overlap. while
% this seems somewhat reasonable, by virtue of a heuristic that the
% points in a stack are nearly evenly distributed, it seems very
% difficult to prove (and again, somewhat likely to be false).
% small matter! another partition ought to do the trick. I still
% think that the parameterization is clever, and unearths the bx
% well.}
%     \end{proof}

%     There are at most $k$ full lines and at most $m$ full chunks.
%     The full lines, full chunks and final chunk taken together
%     consitute a partition of $[\floor{p/2}]$.
%     Summing the contributions to $\lap(x)$ from full lines, full
%     chunks, and the final chunk as bounded in
%   \cref{clm:fullline},\cref{clm:fullchunk},\cref{clm:finalchunk} gives a
%     bound on the excess overlap.
%    In particular we have:
%     $$\lap(x) \le \bigO\left(\frac{p}{km} + k+m\right).$$
%   \end{proof}

%   \begin{cor}
%     \label{lem:overlap}
%     $$\sum_{x\in X}\lap(x) \le \bigO(p\log^2 n).$$
%   \end{cor}
%   \begin{proof}
%     From \cref{lem:therightlens} we obtain the bound
%     $$\sum_{x\in X}\lap(x)\le \bigO\paren{\sum_{m,k \le \sqrt{n}}\frac{p}{m k} +
%     \frac{p}{n}+n} \le \bigO(p\log^2 n).$$
%   \end{proof}

% \begin{proof}
%   The argument would be as follows: 
%   for each $x$, we can write $xm \equiv k$ for $m<n, k<p/n$. 
%   Then we partition $[p/2]$ into full
%   lines then chunks and the final chunk. 

%   Difficulty: segments of $m$ contiguous things are really not so
%   uniform, even though intuitively they behave like uniform
%   things. And this is kind of hard to think about. 
%   But intuitively this should give you like $p/(km)$ behavior
%   bound. This is supported by extensive simulations. If you add
%   it up it gives you like $\log^2 n$. 
% \end{proof}

  % First, we demonstrate the power of our partitioning technique
  % for bounding excess overlap and eliminate a portion of $[p/2]$
  % which our later methods are less effective against.
  % \begin{claim}\label{clm:ezlilguys}
  %   Let $x<p/n$. Then
  %   $$\lap(x)\le \bigO(x+p/x).$$
  % \end{claim}
  % \begin{proof}
  %   We partition $[p/2]$ into \defn{stacks} which are contiguous
  %   groups of $m\in \ceil{p/x} \pm\bigO(1)$ elements
  %   $a+[m]$ which do not
  %   experience overlap, i.e., 
  %   $$\modp(ax)<\modp((a+1)x)<\ldots<\modp((a+m-1)x).$$
  %   Clearly there are $\Theta(x)$ stacks, and each stack, except
  %   for the final one, contributes $\pm\Theta(1)$ to  $\lap(x)$. 
  %   The final stack might not have $\Omega(p/x)$ elements. 
  %   However, it certainly contributes at most $\bigO(p/x)$ to the
  %   $\lap(x)$.
  % Summing the contributions of all stacks gives the desired bound on
  % $\lap(x)$.
  % \end{proof}
  % \begin{cor}\label{cor:lilguyspart2}
  %   $$\sum_{x\in X\cap [\ceil{p/n}]} \lap(x) \le \bigO(p\log n).$$
  % \end{cor}
  % \begin{proof}
  % This follows immediately from \cref{clm:ezlilguys}.
  % \end{proof}
  % Because of \cref{cor:lilguyspart2} it now suffices to analyze
  % the case where $x>p/n$.
  % We remark that small odd numbers $x$ result in precisely
  % $\Theta(p/x)$ excess overlap, so our understanding of the
  % excess overlap incurred by small $x$ is relatively tight.
  % However, small odd $x$ are not the only $x$ which incur large
  % excess overlap.
  % If $x$ wraps around to a small value quickly, then $x$ can also
  % have large excess overlap. In what follows we give some
  % (very lose) methods for bounding these messier, more subtly bad $x$.


Now we give a bound on $\sum_{x\in X}\lap(x)$. Our key insight is
that the behavior of $x$ is best understood by finding a small
number $m$ so that $k=\circabs_p(xm)$ is small and considering
$\setof{ax}{a\in \halfp}$ to consist of $m$ sets of points spaced
out by $k$. Formally:
\begin{defin}\label{def:pleasant} Let $x\in \pnozero$. 
  We say $x$ is \defn{pleasant} if there exist integers
  $m,k,\sigma$ satisfying
  $$m\in \left[1,\ceil{n^{1/4}}\right), k\in \left(n^{1/2},
    p/n^{1/4}\right], \sigma \in \set{\pm
  1}$$ so that $x$ is of the form 
  $$x = \modp(\sigma m^{-1}k).$$
  Otherwise, $x$ is \defn{nasty}.
\end{defin}
\begin{lemma}\label{lem:nasty}
  At most $\bigO(n^{3/4})$ of $x\in \pnozero$ are nasty.
  \end{lemma}
  \begin{proof}
    Let $\ell=\ceil{n^{1/4}}.$
    $\modp([\ell]x)$ is a set of $\ell$ elements in $[p]$. 
    By the pigeon-hole principle there must be
    distinct $i,j\in [\ell]$ such that 
    $$|\modp(xi) - \modp(xj)| \le p/\ell.$$
    Let $k=|i-j|$; clearly $k \in [\ell]$.
    Thus, for one of $\sigma\in \set{\pm 1}$  we must have
    $$\modp(xk\sigma) \le p/\ell.$$
    Thus, the only nasty $x$ are $x$ of the form
    $\modp(\sigma m^{-1}k)$ for $k\le n^{1/2}, m \le \ell, \sigma \in
    \set{\pm 1}$. There are at most $\bigO(n^{3/4})$ such $x.$
  \end{proof}

\begin{lemma}\label{lem:pleasant}
    Let $x$ be pleasant with $x= \modp(\sigma m^{-1}k)$ for
    $\sigma,m,k$ as specified in \cref{def:pleasant}.
    Then, $$\lap(x) \le \bigO(mp/k + k).$$
\end{lemma}
\begin{proof}
Let $\ell = \floor{p / (m\floor{p/k})}$.
We partition $\halfp$ into $m$ \defn{circles},
where circle $i\in [m]$ consists of elements $(m\Z+i) \cap \halfp$.
We further partition circles into $\ell$ \defn{cycles}, which are
contiguous blocks of $\floor{p/k}$ elements in a circle, i.e.,
$m[\floor{p/k}] + \Delta$ for some $\Delta$.
There are up to $p/k$ \defn{extra} elements at the end
of the elements within the circle which do not fall into a cycle.
Aggregating the extra elements from all circles gives at most
$mp/k$ elements, which trivially contribute at most $mp/k$ to
$\lap(x)$. \footnote{This bound is likely quite weak; we believe
  it can be improved to $2(k+p/(mk))$. Doing so would give a
stronger bound on $\sum_{x\in X} \lap(x)$ such as
\cref{conj:log2nwouldbenicetoohard}.}
Each cycle contributes at most $\bigO(1)$ to $\lap(x)$ because a
cycle is $\floor{p/k}$ elements evenly spaced out by $k$, except
the distance between the final element and the first element may
be as large as $2k$; see
\cref{fig:pleasantcircles-svg}.
Thus, adding up the $\ell$ cycles for each of the $m$ circles
results in 
$$\ell m\cdot \bigO(1) \le \bigO(k)$$ 
contribution to $\lap(x)$.
\end{proof}
% Figure environment removed

\begin{theorem}\label{cor:kindaepicevenifweak}
  $$\sum_{x\in X} \lap(x) \le \bigO(p \cdot n^{3/4}).$$
\end{theorem}
\begin{proof}
  Applying \cref{lem:pleasant}, for any pleasant $x$ we have
  $$\lap(x) \le p/n^{1/4} + \ceil{n^{1/4}} p\large/\floor{n^{1/2}} \le
  \bigO(p/n^{1/4}).$$ 
  Trivially there are at most $n$
  pleasant $x \in X$.
  By \cref{lem:nasty} there are at most $\bigO(n^{3/4})$ nasty $x$;
  Trivially nasty $x$ have $\lap(x) \le p$. 
  Summing $\lap(x)$ for the nasty $x\in X$ and pleasant $x\in X$
  gives the desired bound.
\end{proof}

Let random variables $C, M$ denote the number of collisions and
maxload respectively. Let  $\mu = \E[M]$. Let $C_{i,j}$ be $1$ if
$i,j$ collide and $0$ otherwise.
Using \cref{cor:kindaepicevenifweak} we obtain a bound on $\E[C]$.
\begin{cor}\label{lhs:complicated7}
  $$\E[C] \le n^2/4 + \bigO(n^{7/4}).$$
\end{cor}
\begin{proof}
  Interpreting \cref{cor:kindaepicevenifweak} probabilistically,
  for any $n$-element set $X\subset [p]$ we have
  \begin{equation}\label{eq:justabovefor1}
  \sum_{y \in X} \E[C_{1,y}] \le n/2 + \bigO(n^{3/4}).
  \end{equation}
  \eqref{eq:justabovefor1} is easily generalized to bound the number of collisions
  between $y\in X$ and any $x\neq 0$.
  In particular, the collisions between $x,X$ are the same as the collisions
  between $1,x^{-1}X$ where $x^{-1}$ is the inverse of $x \bmod
  p$. Because \eqref{eq:justabovefor1} holds for arbitrary
  $n$-element sets $X$, we have for any $x\neq 0$
  $$\sum_{y \in X} \E[C_{x,y}] \le n/2 + \bigO(n^{3/4}).$$

  Now, we are equipped to bound $\E[C]$. Index $X$ as $X=\set{x_1,x_2,\ldots,
  x_n}$. Then
  \begin{align*}
    \E[C] &\le \sum_{i=1}^{n}\sum_{j=1}^{i} \E[C_{x_i,x_j}]\\
          &\le \sum_{i=1}^{n} \paren{i/2 + \bigO(i^{3/4})}\\
          &\le n^2/4  + \bigO(n^{7/4}).
  \end{align*}
\end{proof}

Finally, we complete the proof of \cref{thm:dontneedb} by comparing the expected number
of collisions to the number of collisions induced by the maxload.
\begin{proof}[Proof of \cref{thm:dontneedb}]
  The number of collisions $C$ is determined by the maxload. In
  particular, 
\begin{equation}\label{eq:rhs7ezv1}
  C = \binom{M}{2}+\binom{n-M}{2}.
\end{equation}
Note that \cref{eq:rhs7ezv1} is a convex function of $M$.
Thus, applying Jensen's inequality to a comparison of
\cref{lhs:complicated7} and \eqref{eq:rhs7ezv1} gives:
$$ \binom{\mu}{2}+\binom{n-\mu}{2} \le n^2/4 + \bigO(n^{7/4}) .$$ 
Solving the quadratic in $\mu$ we find:
\begin{align*}
  \mu &\le n/2+\bigO(n^{7/8}).
\end{align*}
\end{proof}

%   \todo{make an alias for $\floor{p/2}$}
%   \begin{defin}
%     Fix $L\in \N$ and $x\in [p/2]\setminus\set{0}$. We define values
%     $$\delta_i=\delta_i(x,L), c_i=c_i(x,L), \ell_i=\ell_i(x,L)$$ as 
%     $\delta_0 = x$, $c_0=1$, and for $i\in \set{1,2,\ldots, L-1}$
%     \begin{align*}
%       &\ell_{i-1} = \paren{\argmin{\ell\in \set{\ceil{p/\delta_{i-1}},
%     \floor{p/\delta_{i-1}}}} \abs{\ell_{i-1} \cdot
% \delta_{i-1}}_p} -1,\\
%       &\delta_i = |\ell_{i-1}\cdot \delta_{i-1}|_p,\\
%       &c_i = c_{i-1}\cdot \ell_{i-1} = \prod_{j\in [i-1]} \ell_j.
%     \end{align*}
%     While $\delta_i,c_i,\ell_i$ are functions of $x,L$ we will
%     leave this dependence implicit so long as $x,L$ are defined
%     in context.
%   Intuitively, $\delta_i$ is obtained by traveling once around
%   a circle of $[p/2]$ points with stride $\delta_{i-1}$ and
%   then taking the remainder obtained at the end.

%   We partition $[p/2]$ into $L$ \defn{levels} and then further 
%   partition the levels into \defn{circles}.
%   For each $i\in [L]$, level  $i$ is composed of $c_i$ circles. 
%   Intuitively, a circle on level $i$ is composed of
%   $\ell_i$ elements of $[p/2]$. 
%   However, if $i$ is too large then all $[p/2]$ elements will
%   have already been used up. We say that a circle on level $i$ is
%   \defn{full} if it actually has $\ell_i$ elements, and that a
%   level is \defn{full} if all circles on that level are full.
%   We say that a $L$ is a \defn{valid} number of levels if all but
%   the final level is full (and the final level is non-empty).
%   Note that in the final level circles could either have more or
%   less than $\ell_L$ elements.

%   Formally, circle $j$ on level $i$ consists of the elements:
%   $$[p/2] \bigcap \left(c_i\cdot [\ell_i] +j+
%     \sum_{k=0}^{i-1}c_k \ell_k \right).$$
%     \begin{claim}
%       The image of a level $i$ circle under $y\mapsto \modp(xy)$
%       consists of elements spaced out by $\delta_i$.
%     \end{claim}
%     \begin{proof}
%       This is an immediate consequence of our definition. This
%       property is illustrated in \cref{fig:illustrate}.
% \end{proof}
%   \end{defin}
% % Figure environment removed

%   The utility of the level/circle method of viewing $x$ is explained in
%   \cref{lem:lookandsee}. 

%   \begin{lemma}\label{lem:lookandsee}
%     Fix $x>p/n$, and let $L\in \N$ be a valid number of levels
%     for $x$ such that $x$ has $m$ elements on level $L$.
%     Then 
%     $$\lap(x) \le \bigO(c_L + p/c_L)+??.$$
%   \todo{where ?? is the noise for number of circles before the final
%   level}
%   \end{lemma}
%   \begin{proof}
%     We partition the elements on level $L$ into contiguous sets
%     of $c_L$ elements, which we term \defn{full cycles}. 
%     There are $\bigO(c_L)$ elements at the end which are not
%     included in any full cycle, but constitute a \defn{partial cycle}

%     \begin{claim} \label{clm:ultrainduction}
%       Each full cycle contributes $\bigO(1)$ to $\lap(x)$.
%     \end{claim}
%     \begin{proof}
%       We prove  \cref{clm:ultrainduction} by induction on $L$.

%       If $L=1$ it is clear: this is simply saying that evenly
%       spaced points spanning the circle results in $\pm\Theta(1)$
%       contribution to $\lap(x)$.

%       ok. a bound of $c_{L-1}$ is obvious; just cancel circles
%       with themselves.  (but iirc this is not good enough bound)
%       The induction is somehow supposed to show that the ``extra"
%       points in each circles can cancel with each other?.

% maybe worth taking a look at lemma 7 to see exactly what we have
% to work with\ldots

%     Let $k\equiv mx$.
%     For simplicity let $k$ be positive (I mean less than $p/2$);
%     everything is symmetric if $k$ is negative.

%     Our partition is as follows: contiguous blocks of $m$
%     elements. Ok now we need to show that this works.

%     First a simple case, which is our base case for an induction.
%     We say that $x$ has a single level if $m=\ceil{p/x}$.
%     Then, it's clear that $m$ contiguous elements has $\pm 1$ 
%     excess overlap contribution.

%     Now let's ramp it up a level, and do $x$ which is like two
%     levels or whatever. So now we have a circle, and basically
%     think of $m$ circles sprouting out of this original circle. 
%     Think of  $k$ being supa supa small. So now each of these
%     'lil circles has one weird ``stitch" thing. Ok but basically
%     we can pair most of the circle-y dudes up with themselves.
%     But maybe they each have some extra points. But then we also
%     pair up these extra points so its fine.

%     And then we can induct that for any number of levels.
%     With the only inductive thing that we need being like each
%     circle that the final circles sprout from has exactly one
%     stitch and beyond that has just uniform distance things.

%     Anyways once we have the whole $\bigO(1)$ err per $m$ steps
%     thing we are super chilling for our $m+p/m$ bound.
      
%     \end{proof}

%     There are $\Theta(p/c_L)$ full cycles, and each contributes
%     at most $\bigO(1)$ to  $\lap(x)$ by
%     \cref{clm:ultrainduction}. There are at most
%     $c_L$ elements in the partial cycle;
%     these elements contribute at most $c_L$ to $\lap(x)$.
%     The circles before the final level contribute at most ?? to
%     $\lap(x)$.
%     Combined, this gives the desired bound on $\lap(x)$.
%   \end{proof}

%   For $m< \sqrt{n}$ we say that $x$ is
%   \defn{unavoidably}-$m$-circle if there exists a level $\ell$
%   such that  $c_\ell = m$, while $c_{\ell+1} > p/\sqrt{n}$.
%   Intuitively, this means that the granularity on level $\ell$ is
%   very small.
%   \begin{lemma}
%     Fix $m<\sqrt{n}$. There are at most $\bigO(m\sqrt{n})$
%     unavoidably-$m$-circle $x$.
%   \end{lemma}
%   \begin{proof}
%     Assume that for some $\ell$, we have $c_\ell(x)=m$.
%     To be unavoidably-$m$-circle, $x$ must satisfy
%     $$\paren{\sum_{k=0}^{\ell-1}c_k\ell_k}\cdot x \equiv \delta
%     \mod p$$
% \todo{I think this is the right number}
% for some very small $\delta$. In particular, $c_{\ell+1}$ must
% satisfy:
% $$c_{\ell+1} \approx m p/\delta > p/\sqrt{n}.$$
% \todo{there is some fudging about the fact that $m\neq \sum
% c\ell$; but intuitively $m\approx \sum c\ell$ so I won't press
% the issue right now}
% This results in the requirement $\delta < m\sqrt{n}$.
% However, for each such value of $\delta$ there is a unique
% solution to $mx\equiv \delta \mod p$, and this solution might not
% even have $c_\ell(x)=m$.
% Thus, there are at most  to at most $m\sqrt{n}$ values of $x$ which
% are unavoidably-$m$-circle.

% % What I said before:
% %     The rational is that $xm\equiv k$ with  $k<m$ has at most
% %     $m$ solutions. However, this is kind of false logic. Because
% %     not all the points are in the final level. But it should be
% %     good enough for small $m$. Maybe if we say there are at most $\bigO(m)$
% %     such elements?
%   \end{proof}


% \begin{claim}
%   Adding up stuff we get average excess overlap $p/n^{1/4}$.
% \end{claim}
% \begin{proof}
%   We combine our two lemmas and add stuff up.
%   Adding stuff up, in the worst case, we obtain:
%   $$\sqrt{n} p + 2\sqrt{n} p/2 + \cdots +
%   n^{1/4}\sqrt{n}p/n^{1/4} = n^{3/4}p.$$
% \end{proof}
% \end{proof}

% \section{Try 3 of the insane proof}

% \begin{theorem}
%   $$\sum_{x\in X} \lap(x) \le p\cdot n^{11/12}.$$
% \end{theorem}
% \begin{proof}
%   \begin{claim}
%     $\lap(x) \le x + p/x$
%   \end{claim}
%   \begin{proof}
%     Partition to stacks. 
%   \end{proof}

%   \begin{corollary}
%     $$\sum_{x\in X \cap [\ceil{p/n^{1/12}}]} \lap(x) \le
%     \bigO(pn^{11/12}).$$
%   \end{corollary}
%   \begin{proof}
%     Immediate from above claim.
%   \end{proof}

%   \begin{lemma}
%     Fix $x$, and let $L$ be a valid number of levels for $x$. 
%     Then, 
%     $$\lap(x) \le p/\ell_L + c_L \ell_L.$$
%     \todo{isn't there some noise for non ultimate levels}
%   \end{lemma}
%   \begin{proof}
%     Partition $[p/2]$ into groups of $c_{L+1}$ elements. By
%     [claim proving that circles consist of evenly spaced
%     elements] we incur error at most $\bigO(1)$ per all $\ell_L$
%     points in each circle. Thus each group contributes at most
%     $c_L$ to $\lap(x)$, so the total contribution from all groups
%     together is at most $p c_L / (\ell_L c_L) = p/\ell_L$.
%     Finally, there are at most $c_{L+1}$ elements left over which
%     do not fit into a group. These contribute at most $c_{L+1}$
%     to  $\lap(x)$, which together with the bound on the
%     contribution to $\lap(x)$ from groups gives the desired bound
%     on $\lap(x)$. Note that our estimate of the elements which do
%     not fit in a group is quite weak if $L>1$;
%     However, it is simple and sufficient for our purposes.
%   \end{proof}

%   \begin{claim}
%     $$c_{L} < \ell_L.$$
%     \todo{is this actually true? I think probably not. do I
%     really need it?}
%   \end{claim}
%   \begin{proof}
%     \textbf{Intuition}: $\ell$ at least doubles each time. The hardest
%      $c_L/\ell_L$ ratio you can get is probably if we just barely
%      double each time. But in that case it does hold.
%   \end{proof}

%   \begin{claim} \label{clm:112isfine}
%     For any $x>p/n^{1/12}$, there exists an $L\in \N$ such that
%     $C_{L+1} < p/n^{1/12}.$
%   \end{claim}
%   \begin{proof}
%     $p/x \approx n^{1/12} \ll p/n^{1/12}$.
%   \end{proof}

%   \begin{defin}
%     We say that $x$ is $z$-bad if there is a valid level $L\in N$
%     such that $\ell_L(x) = z$, $c_{L+1} < p/n^{1/12}$ but
%     $c_{L+2} > p/n^{1/12}.$

%     By \cref{clm:112isfine} any $x>p/n^{1/12}$ is $z$-bad for
%     some $z\in [p]$.
%   \end{defin}

%   \begin{lemma}
%     The number of $z$-bad integers $x\in [p/n^{1/12}, p]$ is at
%     most $z^{3}n^{1/6}$.
%   \end{lemma}
%   \begin{proof}
%     For $x$ to be $z$-bad we must have 
%     $\ell_{L+1}\ell_L c_L > p/n^{1/12}.$
%     Of course $\ell_{L+1} \approx p/\delta_{L+1}$, 
%     so this translates into 
%     $$\delta_{L+1} < z^2n^{1/12}.$$
%     On the other hand, 
%     $\delta_L = c_L \cdot x$, and so 
%     $$\delta_{L+1} = \floor{p/\delta_{L}} \delta_L= \paren{p/(c_L x)
%     c_L }x.$$
%     Of course $p/(c_L x) c_L < n^{1/12}z$, 
%     so we obtain the equation
%     $$\eta x \equiv \delta$$
%     where $\eta < n^{1/12}z$, $\delta< z^{2}n^{1/12}$. 
%     Clearly, there are at most $n^{1/6}z^{3}$ solutions to this
%     equation.

%     Intuitively, this is expressing the fact that a quick drastic
%     decrease in granularity is fairly rare. 
%   \end{proof}

%   \begin{corollary}
%     $$\sum_{x\in X\cap [p/n^{1/12}, p]} \lap(x) \le pn^{11/12}.$$
%   \end{corollary}
%   \begin{proof}
%     The worst case is 
%     $$\sum_{k=1}^{n^{1/4}} pn^{1/6}z^{3}/z = pn^{11/12}.$$
%   \end{proof}

%   Combining Corollary[A] and Corollary[B] gives the desired bound
%   on $\sum_{x\in X}\lap(x)$.

% \end{proof}

% \section{Another remark about circles}
% Imagine that you have some set of $m_i,k_i$ such that 
% $xm_i\equiv k_i$  for each $i$. 
% Imagine further that you could form a partition 
% $$p/2 = \sum_i \zeta_i \floor{p/k_i} m_i.$$
% Then you can view $p/2$ as being the union over $i$ of $\zeta_i m_i$  circles of
% granularity $k_i$.

In fact, we believe the true answer is closer to
$n/2+\bigO(\sqrt{n})$. In particular, we believe
\cref{cor:kindaepicevenifweak} can be strengthened to:
\begin{conj}
  \label{conj:log2nwouldbenicetoohard}
  $$\sum_{x\in X} \lap(x) \le\bigO( p \cdot \log^2 n).$$
\end{conj}

