@Test
public void loginRetryTest() {
    // Arrange: Prepares the dependencies and input data
    //          for the class under test.
    var dao = mock(UserDao.class); // mock object|\label{code:stubbing-example:arrange-begin}|
    var user = mock(User.class);   // mock object|\label{code:stubbing-example:extra-mock}|
    var sha1 = DigestUtils.sha1Hex("bar"); |\label{code:stubbing-example:stubbing-begin}|         |STUB CODE|
    when(user.getPasswordHash()).thenReturn(sha1); // Stub Call 1|\label{code:stubbing-example:stubbing-dao}| 
    when(dao.findUser(eq("foo"))                   // Stub Call 2
        .thenThrow(new TimeoutException())         // First reaction |\label{code:stubbing-example:first-reaction}|
        .thenReturn(user);                         // Second reaction |\label{code:stubbing-example:arrange-end}|

    // Act: Exercises the feature
    var underTest = new LoginService(dao);|\label{code:stubbing-example:act-begin}|
    var loginResult = underTest.login("foo", "bar");|\label{code:stubbing-example:act-end}|

    // Assert: Verifies the result.
    verify(dao, times(2)).findUser(any());// mocking call|\label{code:stubbing-example:assert-begin}|
    assertTrue(loginResult.isSuccessful());|\label{code:stubbing-example:assert-end}|
}

// CUT
public LoginResult login(String userName, String password) {|\label{code:stubbing-example:cut-begin}|
    User user = null;
    while(user == null) {|\label{code:stubbing-example:loop}|
        try {
            user = dao.findUser(userName);
        } catch (TimeoutException e) { ... }|\label{code:stubbing-example:catch}|
    }
    var hash = DigestUtil.sha1Hex(password);
    if (hash.equals(user.getPasswordHash()))|\label{code:stubbing-example:hash-check}|
        // success
    else
        // failure
}|\label{code:stubbing-example:cut-end}|