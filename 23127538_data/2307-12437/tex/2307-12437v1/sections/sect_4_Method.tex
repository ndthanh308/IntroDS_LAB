\section{Robust Constrained Explicit MPC for Hybrid Linear Systems with Parameter Uncertainties}

\subsection{Robustness to parametric uncertainty}

Given an uncertain dynamical system \eqref{eq:LTV} and zonotopes $\mathbb{X}_{k}$ and $\mathbb{U}_{k}$, 
let $\mathbb{X}_{k+1}$ be a zonotope that contains all $x_{k+1}$ that can be obtained by applying \eqref{eq:LTV} to $x_k \in \mathbb{X}_{k}$ and $u_k \in \mathbb{U}_{k}$:
%
\begin{equation}
\label{eq:LTV_zonotopes_robust}
    \mathbb{X}_{k+1} \supset 
    \bigcup\limits_{[A,B,d] \in \Omega_k} 
    \left( (A(k) \mathbb{X}_k + B(k) \mathbb{U}_k + d(k)) \oplus \mathbb{W}_k \right)
\end{equation}

Expression \eqref{eq:LTV_zonotopes_robust} cannot be directly included in a convex optimization procedure. In order to make the problem numerically tractable, we introduce the following relaxation:
%
\begin{equation}
\label{eq:LTV_zonotopes_robust_vert}
    \mathbb{X}_{k+1} \supset 
    \bigcup\limits_{\mathcal{V}_k} 
    \left( (A_i(k) \mathbb{X}_k + B_i(k) \mathbb{U}_k + d_i(k)) \oplus \mathbb{W}_k \right)
\end{equation}

Proposed relaxation can be interpreted as follows: instead of searching for a zonotope that contains all possible transformations $A(k) \mathbb{X}_k + B(k) \mathbb{U}_k + d(k)$ for $[A(k),B(k),d(k)] \in \Omega_k$ we limit it to transformations $[A_i(k),B_i(k),d_i(k)] \in \mathcal{V}_k$, i.e. the vertices of $\Omega_k$.

Let us denote $\mathbb{Z}_{k, i} = A_i(k) \mathbb{X}_k + B_i(k) \mathbb{U}_k + d_i(k)$. Let us observe that the fact that \eqref{eq_convhull} is an over-approximation implies $\mathbb{Z}_{k, i} \subset \underset{\mathcal{V}_k}{\text{Co}}(\mathbb{Z}_{k, i})$, which in turn implies:
%
\begin{equation}
\label{eq_minkowski_of_hull}
    \forall \mathbb{Z}_{k, i} \oplus \mathbb{W}_k \subset \underset{\mathcal{V}_k}{\text{Co}}(\mathbb{Z}_{k, i}) \oplus \mathbb{W}_k,
\end{equation}
%
where $\underset{\mathcal{V}_k}{\text{Co}}(\cdot)$ means that convex hull is taken over all $\mathbb{Z}_{k, i}$ that can be formed with $[A_i(k), B_i(k), d_i(k)] \in \mathcal{V}_k$. With that we can find an over-approximation of the union in \eqref{eq:LTV_zonotopes_robust_vert}:

\begin{equation}
\label{eq:LTV_zonotopes_robust_hull}
    \bigcup\limits_{\mathcal{V}_k} 
    \left( \mathbb{Z}_{k, i} \oplus \mathbb{W}_k \right) 
    \subset
    \underset{\mathcal{V}_k}{\text{Co}}
    (\mathbb{Z}_{k, i}) \oplus \mathbb{W}_k
\end{equation}

With that we can propose the following zonotope propagation law:
%
\begin{equation}
\label{eq:LTV_zonotopes_robust_propagation}
    \mathbb{X}_{k+1} = 
    \text{Co}(
    A_i(k) \mathbb{X}_k + B_i(k) \mathbb{U}_k + d_i(k) )
    \oplus \mathbb{W}_k,
\end{equation}

Now we observe the reason for separating $d(k)$ and $\mathbb{W}_k$; if they were combined in $\Zo{d(k)}{W(k)}$, then a different Minkowski sum would be applied to each vertex model, leading to a significant increase in the order of the resulting zonotopes.

\subsection{Matrix zonotope-based propagation}

Assuming that $d(k)$ is known exactly and set $\Omega_k$ can be represented as matrix zonotopes $\mathbb{A}(k)$ and $\mathbb{B}(k)$, such that 
%
\begin{equation}
    [A(k), B(k)] \in \Omega_k \iff A(k) \in \mathbb{A}(k), B(k) \in \mathbb{B}(k)
\end{equation}

Both the assumption on $d(k)$ and on $\Omega$ are restrictive. However, they allow an alternative formulation of zonotope propagation. First, we relax \eqref{eq:LTV_zonotopes_robust} as:
%
\begin{equation}
\label{eq:LTV_zonotopes_robust_matrix_1}
    \mathbb{X}_{k+1} \supset 
    \mathbb{W}_k \oplus 
    \bigcup\limits_{\Omega_k} 
    \left( A(k) \mathbb{X}_k + B(k) \mathbb{U}_k + d(k) \right)
\end{equation}

Obtained expression \eqref{eq:LTV_zonotopes_robust_matrix_1} can be over-approximated using matrix zonotope multiplication \eqref{eq_matrix_zonotope_mult}:
%
\begin{equation}
\label{eq:LTV_zonotopes_robust_propagation_matrix}
    \mathbb{X}_{k+1} = 
    \left( \mathbb{A}(k) \otimes \mathbb{X}_k + \mathbb{B}(k) \otimes \mathbb{U}_k + d(k) \right) \oplus \mathbb{W}_k 
\end{equation}

Same as the formulation \eqref{eq:LTV_zonotopes_robust_propagation}, this propagation law leads to rapid growth in the zonotope order, requiring order reduction to be applied.

\subsection{Zonotope Order Reduction}

Methods proposed in this work lead to a steady increase in the zonotope order at consecutive time steps, due to the use of Minkowski sum and approximate convex hull operations. Not only is it preferable to maintain zonotope order uniform, but its increase leads to a higher number of decision variables in the resulting optimal control problem (OCP). This issue has been well-recognized in the literature \cite{kopetzki2017methods, raghuraman2020set, yang2018comparison}. It is usually mitigated with order reduction methods.

A number of order reduction methods have been previously proposed, including ones based on SVD, exhaustive search, sorting, and various non-convex procedures. Since our goal is to solve the control design problem as a single convex program, we seek to embed the order reduction method in it. Moreover, since this convex program includes an iterative application of the previously mentioned Minkowski sum and approximate convex hull operations, the desirable order reduction method should be suitable for iterative application in the same manner.

We propose \emph{ReaZOR} (\textbf{Rea}rranging \textbf{Z}onotope \textbf{O}rder \textbf{R}eduction) method, that operates by shuffling zonotope generator vectors and replacing a subset of those vectors with a smaller set, such that the resulting zonotope includes the original one but has a smaller order. ReaZOR takes as an input a generator $G = (g^{(1)}, ..., g^{(z)}) \in \mathbb{R}^{n \times z}$, and outputs an order-reduced generator $G_{red} \in \mathbb{R}^{n \times p}$:

\begin{equation}
\label{eq:ReaZOR}
    \begin{aligned}
    G_{\text{red}} & = & \underset{G^*, a_i}{\text{argmin}} &  \ 
    \sum\limits_{i=1}^n  |a_i| \\[0.5em]
            &   & \text{s. t.} &  
            \ \sum\limits_{j=p-n+1}^z  |G_{ij}| \leq a_i, \ i = 1, ..., n \\
            &   &   &  \ G^* = 
            \Bigl(
            \text{diag}(a_1, ..., a_n), g^{(1)},...,g^{(p-n)}
            \Bigr)
    \end{aligned}
\end{equation}
%
where $a_i \in \mathbb{R}$, $n \leq p \leq z$. 

the key idea of this algorithm is that row-wise approximation is applied to the last columns of the generator but the diagonal matrix resulting from this approximation is placed as the first $n$ columns of the reduced generator; the first $p-n$ columns of the old generator are pushed to the back of the new one. This operation achieves greater uniformity in column lengths and makes the algorithm numerically stabler. The only hyperparameter in the algorithm is the number of columns $p$ in the reduced zonotope In our experiments we found that the resulting optimization program is reasonably sensitive to the choice of this parameter, as is to be expected. 

ReaZOR is designed to be applied iteratively and as a part of a convex optimization problem. As such it does not compete with order reduction methods based on non-linear operations. We can illustrate its behavior with the following example:

\begin{example}
\label{example_ReaZOR}
Apply ReaZOR to zonotope $\Zo{0}{G}$: 
%
\[G = 
\begin{bmatrix}
    4 & 2 & 2 & 1 & 1 \\
    4 & 1 & 0 & 2 & 1 \\
\end{bmatrix}, 
\]
%
with number of columns $p = 4$ after reduction. We obtain $a_1 = 4$ and $a_2 = 3$, and the resulting zonotope $\Zo{0}{G_{\text{red}}}$ has the following generator:
%
\[
G_{\text{red}} = 
\begin{bmatrix}
    4 & 0 & 4 & 2 \\
    0 & 3 & 4 & 1 \\
\end{bmatrix}.
\]
%
To illustrate behavior of the algorithm under iterative application, we find Minkowski sum $\Zo{0}{G_{\text{red}}} \oplus \Zo{0}{\begin{bmatrix}
    1 \\ 1
\end{bmatrix}}$ and apply ReaZOR to the result:
%
\begin{align*}
\text{ReaZOR}\left( 
\begin{bmatrix}
    4 & 0 & 4 & 2 & 1 \\
    0 & 3 & 4 & 1 & 1 \\
\end{bmatrix} 
\right) =
\begin{bmatrix}
    7 & 0 & 4 & 0  \\
    0 & 6 & 0 & 3  \\
\end{bmatrix}.
\end{align*}
\end{example}

As illustrated by the example \ref{example_ReaZOR}, ReaZOR creates and shuffles diagonal blocks in the zonotope generator. If $W(k)$ is diagonal, ReaZOR allows us to use the property \eqref{diagMinkowski} to perform Minkowski addition without the increase of the zonotope order.

\subsection{Cost design}

Cost design is an important problem for optimization-based methods. Here we propose a three-component cost:
%
\begin{equation}
    J = J_c + J_g + J_r
\end{equation}
%
where $J_c$ is the cost on deviation from the nominal trajectory  applied to the zonotope centers $\Bar{x}_k$ and $\Bar{u}_k$; $J_g$ is the cost on zonotope size applied to the generators $G_k$ and $\theta_k$, and $J_r$ is the cost associated with the order reduction algorithm \eqref{eq:ReaZOR}:
%
\begin{equation}
\begin{aligned}
    J_c = \sum_k^N \left(
                 (\Bar{x}_k - x^*_k)^\top Q_c (\Bar{x}_k - x^*_k) \right) + \\
          \sum_k^{N-1} \left(
                 (\Bar{u}_k - u^*_k)^\top R_c (\Bar{u}_k - u^*_k) \right), \\
    J_g = \sum_k^N \text{Tr} 
                 \left(G_k Q_g G_k^\top \right) 
                 + 
                 \sum_k^{N-1} \text{Tr} 
                 \left(\theta_k R_g \theta_k^\top
                 \right).             
\end{aligned}
\end{equation}
%
where $Q_c$, $R_c$, $Q_g$ and $R_g$ are positive-definite weight matrices and $\text{Tr}(\cdot)$ is a trace operation.

\subsection{Control design as a convex program}

Combining robust propagation with order reduction, we can formulate the following OCP:
%
\begin{equation} \label{ConvexOptimization}
\begin{aligned}
& \{\mathbb{X}_{k}, \mathbb{U}_k\} \ = \ {\text{argmin}} \ J, \\
& \text{s. t.} \ 
\begin{cases}
\mathbb{X}^*_k = 
\underset{\mathcal{V}_k}{\text{Co}}
( A_i(k) \mathbb{X}_k + B_i(k) \mathbb{U}_k + d_i(k)), \\ 
\mathbb{X}_{k+1} = \text{ReaZOR}(\mathbb{X}^*_k) \oplus \mathbb{W}_k, \\
\mathbb{X}_{N} \subseteq \mathbb{H}_g^x, \mathbb{X}_{k} \subseteq \mathbb{H}_k^x, \mathbb{U}_k \subseteq \mathbb{H}_k^u, \\
[A_i, B_i, d_i] \in \mathcal{V}_k, \\
k \in \{1,...,N-1\}
\end{cases}
\end{aligned}
\end{equation}
%
where zonotope inclusion constraints are implemented using linear constraints \eqref{eq:containment}, and $\text{ReaZOR}()$ refers to the inclusion of the constraints and cost from \eqref{eq:ReaZOR}; $\mathbb{H}_g^x$ is a zonotope that represents bounds on the final state in the trajectory. Since the cost is a positive-definite quadratic function, all equality constraints are linear, and inequality constraints are either linear or conic (for order reduction), the problem is convex. Decision variables in this problem are $\mathbb{X}_{k}$, $\mathbb{U}_k$, and $\mathbb{X}^*_k$.

\subsection{Hybrid dynamics}

Assume we have a hybrid dynamical system, described as follows:

\begin{equation}
\label{eq:hybridLTV}
    \begin{matrix}
    x_{k+1}  =  A(k) x_k + B(k) u_k + d(k) + w_k,
    \\[0.5em]
    [A(k) \ B(k) \ d(k)] \in \Omega_k^j, \ \ \ x_k \in \mathbb{H}_j
    \\[0.5em]
    \end{matrix}
\end{equation}
%
where state-space is divided into non-intersecting regions $\mathbb{H}_j$ (where $j \in [1, p]$), and each region has associated uncertain time-varying linear dynamical model $[A(k) \ B(k) \ d(k)] \in \Omega_k^j$; when the true state of the system changes from one region to another, the dynamics switches. Assuming that regions $\mathbb{H}_j$ 
 are described as zonotopes $\mathbb{H}_j = \langle h^x_j, H^x_j \rangle$ and introducing binary variables $c_{k, j}$ we can write the hybrid version of the OCP proposed in the previous subsection:
%
\begin{equation} \label{ConvexOptimization_hybrid}
\begin{aligned}
& \{\mathbb{X}_{k}, \mathbb{U}_k\} \ = \ {\text{argmin}} \ J, \\
& \text{s. t.} \ 
\begin{cases}
\mathbb{X}^*_{k, j} = 
\underset{\mathcal{V}_{k, j}}{\text{Co}}
( A_i(k) \mathbb{X}_k + B_i(k) \mathbb{U}_k + d_i(k)), \\ 
||\mathbb{X}^*_k - \mathbb{X}^*_{k, j}||_F \leq M (1 - c_{k, j}), \\ 
\mathbb{X}_{k+1} = \text{ReaZOR}(\mathbb{X}^*_k) \oplus \mathbb{W}_k, 
\\
G_{k} = H^x_j \Gamma_{k, j}, \ \ 
h^x_j - \bar{x}_{k} = H^x_j \beta_{k, j}, \\ 
||(\Gamma_{k, j},\beta_{k, j})||_\infty \leq 1 + M (1 - c_{k, j}), 
\\
\mathbb{X}_{N} \subseteq \mathbb{H}_g^x, \ \mathbb{U}_k \subseteq \mathbb{H}_k^u, \\
\sum\limits_{j=1}^p c_{k, j} = 1, \\
c_{k, j} \in \{0, \ 1 \}, \ k \in \{1,...,N-1\}, \ j \in \{1,...,p\}
\end{cases}
\end{aligned}
\end{equation}
%
where $\Gamma_{k, j}$ and $\beta_{k, j}$ are containment coefficients (see eq. \eqref{eq:containment}), $M$ is a sufficiently large constant, $c_{k, j}$ are binary variables, implementing choice between hybrid dynamic modes, and zonotope norm $||\cdot||_F$ is Frobenius norm of zonotope generator concatenated with zonotope center $|| \langle c, G \rangle ||_F = || (c, G) ||_F$. In this formulation the same set of binary variables $c_{k, j}$ links the region $\mathbb{H}_j$ with the associated dynamics $\mathcal{V}_{k, j}$. Let us note that the computational time for mixed integer problems grows with the number of integer variables, which in this case depends on the number of propagation steps and on the number of hybrid modes \cite{sadraddini2019sampling}.

\subsection{Finding current zonotope and policy}
%
% Figure environment removed

It is often meaningful to draw a distinction between control policies that depend purely on the state of the system, and the ones that depend on time as well. In the field of orbital stabilization, it is common to use transverse dynamics formulations to write the control in a time-free form \cite{manchester2011transverse, shiriaev2008can}. In the explicit MPC \cite{bemporad2000piecewise, alessio2009survey} and in the tree-based algorithms \cite{sadraddini2019sampling, tedrake2010lqr}, control policies can be selected based on the region of the state space the system is currently in. This method becomes challenging in implementation when a tessellation of the state-space is not available, and instead, the state-space is only partly covered by overlapping regions, which is the expected situation when zonotopes or ellipsoids are used for set representation. Additionally, discrete switching between control policies may lead to chattering. Finally, we observe that zonotope propagation in eq. \eqref{eq:LTV_zonotopes} naturally leads to a one-to-one correspondence between the sets $\mathbb{X}_k$ and $\mathbb{U}_k$. However, it does not yield a linear control law, which means that control law \eqref{eq:lin_feedback} does lead to the exact execution of the designed propagation. With that in mind, if the current state of the system $x$ belongs to several zonotopes, it is preferable to avoid the ones whose boundary is close to the state $x$. Thus, we propose a quasi-time-free control policy choice algorithm.

We distinguish two basic scenarios with regard to the current state of the system and policy choice: 1) the current state $x$ lies in one or more zonotopes $\mathbb{X}_k$ and 2) $x$ does not lie in any zonotope $\mathbb{X}_k$. In the first case, the problem is to choose which zonotope $\mathbb{X}_k \ni x$ to use for policy generation; in the second case, the problem is to find the nearest zonotope to $x$ and apply its control policy. This problem has previously been studied in \cite{sadraddini2019sampling, wu2020nearest}. 

We propose the following quasi-time-free solution to the first case: we register the \emph{sequence number} $k$ of last zonotope $\mathbb{X}_k$, whose control policy \eqref{eq:lin_feedback} was applied. Then if $x \in \mathbb{X}_{k+1}$, we apply the control policy associated with the $\mathbb{X}_{k+1}$ zonotope; if not, we find among $\mathbb{X}_k \ni x$ zonotope whose center is the nearest to $x$ in the Euclidean sense and apply the control policy associated with it. The priority given to $\mathbb{X}_{k+1}$ zonotope avoids the effect of chattering; the use of the zonotope with the nearest center partially avoids the problems resulting from the linear approximation of the control policy map discussed above.

In order to propose a solution to the second case, we need to provide a distance-to-zonotope function. This function will be running in real-time and therefore is required to be computationally light. With that in mind, we propose an additional offline step of computing parallelotope bounds $\mathbb{P}_{k}$ for each zonotope $\mathbb{X}_{k}$, using PCA-based algorithm reported in \cite{kopetzki2017methods}. Then we can use the following vector-to-zonotope distance function:
%
\begin{align}
    & d(x, x_c, P) = \nu \cdot \text{max}\{0, \ \norm{P^+ (x - x_c)}_\infty - 1\}  \\
    & \nu(x, x_c, P) = \frac{\norm{x - x_c}}{\norm{P^+ (x - x_c)}}
\end{align}
%
where $P$ is the generator of the parallelotope $\mathbb{P}$, $x_c$ is the center of $\mathbb{P}$ and $\mathbb{X}$, and $\nu(x, x_c, P)$ is a scaling factor.
%

\input{sections/Algorithm}

The resulting control policy choice is made with the algorithm~\ref{alg:ContolLaw}. To speed it up, we use a k-d tree algorithm to choose $n$ closest zonotopes and run algorithm~\ref{alg:ContolLaw} on them.

% Figure environment removed

The next sections demonstrate experimental validation of the proposed algorithm on two experimental set-ups: \emph{inverted pendulum with a wall} and \emph{pendubot}. 

